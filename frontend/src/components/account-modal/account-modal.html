<div class="modal-backdrop" (click)="onClose()">
    <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <button class="back-arrow" [class.back-arrow--profile]="view === 'profile'" type="button"
                (click)="onBackOrClose()" [attr.aria-label]="view === 'profile' ? 'Close' : 'Back'">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <div class="title-wrap">
                <h2 [class.yellow-title]="view !== 'profile'">{{ getViewTitle() }}</h2>
            </div>
            <button class="close-btn close tablet-desktop-only" (click)="onClose()" aria-label="Close">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <div class="account-content" *ngIf="view === 'profile'">
            <div class="content-row">
                <div class="content-col left-col">
                    <div class="profile-section">
                        <div class="avatar-container">
                            <img [src]="user?.profileImage || 'assets/img/default-avatar.png'" alt="Profile"
                                class="profile-image">
                            <button class="edit-photo-btn" (click)="onChangePhoto()">
                                <mat-icon>edit</mat-icon>
                            </button>
                        </div>
                        <h3 class="user-name">{{ user?.name }}</h3>
                        <p class="user-email">
                            <mat-icon>mail_outline</mat-icon>
                            {{ getDiscreteEmail(user?.email) }}
                        </p>
                        <p class="user-description">{{ user?.description || 'Find The Glow' }}</p>

                        <div class="stats-container">
                            <div class="stat-item clickable" (click)="showFollowers()">
                                <span class="stat-value">{{ user?.followersCount || 0 }}</span>
                                <span class="stat-label">Followers</span>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item clickable" (click)="showFollowing()">
                                <span class="stat-value">{{ user?.followingCount || 0 }}</span>
                                <span class="stat-label">Following</span>
                            </div>
                        </div>
                    </div>

                    <div class="actions-section">
                        <button class="action-btn" (click)="showEditProfile()">
                            <mat-icon>settings</mat-icon>
                            Edit Profile
                        </button>
                    </div>
                </div>

                <div class="vertical-divider"></div>

                <div class="content-col right-col">
                    <div class="share-section-embedded">
                        <span class="share-header">Share Profile</span>
                        <div class="qr-code-wrapper">
                            <img [src]="getQrCodeUrl()" alt="Profile QR Code">
                        </div>
                        <div class="share-details">
                            <div class="mini-link-group">
                                <button class="mini-copy-btn" (click)="copyShareLink()">
                                    <mat-icon>content_copy</mat-icon>
                                    Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="edit-profile-view" *ngIf="view === 'edit-profile'">


            <div class="edit-content-layout">
                <div class="edit-section left-section">
                    <h4>Personal Information</h4>
                    <div class="form-group">
                        <label>Name</label>
                        <input [(ngModel)]="editData.name" placeholder="Name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input [value]="editData.email" readonly disabled class="readonly-input">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea [(ngModel)]="editData.description" placeholder="Description (e.g. Find The Glow)"
                            rows="3"></textarea>
                    </div>
                    <button class="button" (click)="onSaveProfile()">Update Details</button>
                </div>

                <div class="vertical-divider"></div>

                <div class="edit-section right-section">
                    <h4>Change Password</h4>
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" [(ngModel)]="passwordData.old" placeholder="Current Password">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" [(ngModel)]="passwordData.new" placeholder="New Password">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" [(ngModel)]="passwordData.confirm" placeholder="Confirm Password">
                    </div>
                    <button class="button" (click)="onChangePassword()">Change Password</button>
                </div>
            </div>
        </div>

        <div class="user-list-view" *ngIf="view !== 'profile' && view !== 'edit-profile'">

            <div class="user-list" *ngIf="!loadingList; else loadingTemplate">
                <div class="user-item" *ngFor="let u of userList">
                    <div class="user-info" (click)="openProfileFromList(u)">
                        <img [src]="u.profileImage || 'assets/img/default-avatar.png'" class="list-avatar">
                        <span class="list-username">{{ u.name }}</span>
                    </div>

                    <button *ngIf="view === 'following' || (view === 'followers' && followingIds.has(u.id.toString()))"
                        class="unfollow-btn" (click)="onUnfollow(u)">
                        Unfollow
                    </button>

                    <button *ngIf="view === 'followers' && !followingIds.has(u.id.toString())" class="follow-btn"
                        (click)="onFollow(u)">
                        Follow
                    </button>
                </div>
                <div *ngIf="userList.length === 0" class="empty-list">
                    No users found.
                </div>
            </div>

            <ng-template #loadingTemplate>
                <div class="loading-spinner">Loading...</div>
            </ng-template>
        </div>
    </div>
</div>