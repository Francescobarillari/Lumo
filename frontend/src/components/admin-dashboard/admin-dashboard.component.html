<div class="admin-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2>LUMO <span>Admin</span></h2>
        </div>
        <nav>
            <a href="javascript:void(0)" class="nav-item" [class.active]="currentView === 'dashboard'"
                (click)="setView('dashboard')">
                <mat-icon>dashboard</mat-icon> Dashboard
            </a>
            <a href="javascript:void(0)" class="nav-item" [class.active]="currentView === 'events'"
                (click)="setView('events')">
                <mat-icon>event</mat-icon> Events
            </a>
            <a href="javascript:void(0)" class="nav-item" [class.active]="currentView === 'users'"
                (click)="setView('users')">
                <mat-icon>people</mat-icon> Users
            </a>
            <a href="javascript:void(0)" class="nav-item" [class.active]="currentView === 'reports'"
                (click)="setView('reports')">
                <mat-icon>flag</mat-icon> Reports
            </a>
        </nav>
        <button class="btn-logout" (click)="signOut()">
            <mat-icon>logout</mat-icon> Logout
        </button>
    </div>

    <!-- Main Content -->
    <div class="main-content" [class.reports-view]="currentView === 'reports'">
        <div class="header">
            @if (currentView === 'dashboard') {
            <h1>Dashboard Overview</h1>
            } @else if (currentView === 'events') {
            <h1>Event Management</h1>
            } @else if (currentView === 'users') {
            <h1>User Management</h1>
            } @else if (currentView === 'reports') {
            <h1>Reports</h1>
            }
        </div>

        @if (currentView === 'dashboard') {
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card" (click)="setView('users')">
                <div class="stat-icon users-icon"><mat-icon>people</mat-icon></div>
                <div class="stat-info">
                    <span class="stat-value">{{ totalUsers }}</span>
                    <span class="stat-label">Registered Users</span>
                </div>
            </div>
            <div class="stat-card" (click)="setView('events')">
                <div class="stat-icon events-icon"><mat-icon>event</mat-icon></div>
                <div class="stat-info">
                    <span class="stat-value">{{ totalEvents }}</span>
                    <span class="stat-label">Total Events</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pending-icon"><mat-icon>assignment</mat-icon></div>
                <div class="stat-info">
                    <span class="stat-value">{{ pendingEventsCount }}</span>
                    <span class="stat-label">Pending Approval</span>
                </div>
            </div>
        </div>

        <!-- Dashboard Content Grid -->
        <div class="dashboard-grid">

            <!-- Recent Requests Table -->
            <div class="requests-section">
                <div class="section-header">
                    <h3>Recent Requests</h3>
                    <button class="btn-link" (click)="setView('events')">See all</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>EVENT</th>
                                <th>EVENTER</th>
                                <th>DATE</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (ev of recentRequests.slice(0, 5); track ev.id) {
                            <tr>
                                <td>
                                    <div class="ev-cell-title">
                                        <strong>{{ ev.title }}</strong>
                                        <span class="ev-sub">{{ ev.city }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="ev-organizer">
                                        <img [src]="ev.organizerImg || 'assets/img/default-avatar.png'"
                                            class="table-avatar">
                                        <span>{{ ev.organizer }}</span>
                                    </div>
                                </td>
                                <td>{{ ev.date }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon info" (click)="toggleDetails(ev.id)" title="View details">
                                            <mat-icon>{{ expandedEventId === ev.id ? 'expand_less' : 'info' }}</mat-icon>
                                        </button>
                                        @if (!eventsCurrentlyRejecting.includes(ev.id)) {
                                        <button class="btn-icon approve" (click)="approveEvent(ev)" title="Approve">
                                            <mat-icon>check</mat-icon>
                                        </button>
                                        <button class="btn-icon reject" (click)="rejectEvent(ev)" title="Reject">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                        } @else {
                                        <div class="inline-reject">
                                            <input #reasonInput type="text" placeholder="Reason..." class="input-reason"
                                                autoFocus (keyup.enter)="confirmReject(ev, reasonInput.value)">
                                            <button class="btn-icon approve"
                                                (click)="confirmReject(ev, reasonInput.value)">
                                                <mat-icon>check</mat-icon>
                                            </button>
                                            <button class="btn-icon reject" (click)="cancelReject(ev.id)">
                                                <mat-icon>close</mat-icon>
                                            </button>
                                        </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                            @if (expandedEventId === ev.id) {
                            <tr class="event-details-row">
                                <td colspan="4">
                                    <div class="event-details">
                                        <div class="detail-item full">
                                            <span class="detail-label">Description</span>
                                            <span class="detail-value description">{{ ev.description || 'No description provided.' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Date</span>
                                            <span class="detail-value">{{ ev.date || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Time</span>
                                            <span class="detail-value">{{ ev.startTime || '-' }} - {{ ev.endTime || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">City</span>
                                            <span class="detail-value">{{ ev.city || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Capacity</span>
                                            <span class="detail-value">{{ ev.nPartecipants || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Cost</span>
                                            <span class="detail-value">{{ ev.costPerPerson != null ? (ev.costPerPerson + ' EUR') : 'Free' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Coordinates</span>
                                            <span class="detail-value">{{ ev.latitude != null && ev.longitude != null ? (ev.latitude + ', ' + ev.longitude) : '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Created</span>
                                            <span class="detail-value">{{ ev.createdAt || '-' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Organizer</span>
                                            <span class="detail-value">{{ ev.organizerName || ev.organizer || 'Unknown' }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Event ID</span>
                                            <span class="detail-value">#{{ ev.id }}</span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            }
                            }
                            @if (recentRequests.length === 0) {
                            <tr>
                                <td colspan="4" class="no-data">No pending requests.</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="actions-section">
                <h3>Quick Actions</h3>
                <div class="quick-actions">
                    <button class="action-card" (click)="setView('events')">
                        <mat-icon class="action-icon">verified_user</mat-icon>
                        <span>Manage Events</span>
                    </button>
                    <button class="action-card outline" (click)="setView('users')">
                        <mat-icon class="action-icon">search</mat-icon>
                        <span>Search Users</span>
                    </button>
                </div>
            </div>

        </div>
        }

        @if (currentView === 'events') {
        <div class="full-table-section">
            <!-- Search for Events -->
            <div class="search-container">
                <mat-icon class="search-icon">search</mat-icon>
                <input type="text" [(ngModel)]="searchTermEvents"
                    placeholder="Search events by title, city or eventer..." class="search-input">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>EVENT</th>
                            <th>EVENTER</th>
                            <th>STATUS</th>
                            <th>DATE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (ev of filteredEvents; track ev.id) {
                        <tr>
                            <td>#{{ ev.id }}</td>
                            <td>
                                <div class="ev-cell-title">
                                    <strong>{{ ev.title }}</strong>
                                    <span class="ev-sub">{{ ev.city }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="ev-organizer">
                                    <img [src]="ev.organizerImage || 'assets/img/default-avatar.png'"
                                        class="table-avatar">
                                    <span>{{ ev.organizerName || 'Unknown' }}</span>
                                </div>
                            </td>
                            <td>
                                @if(ev.isApproved) {
                                <span class="status-badge approved">Approved</span>
                                } @else {
                                <span class="status-badge pending">Pending</span>
                                }
                            </td>
                            <td>{{ ev.date }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon info" (click)="toggleDetails(ev.id)" title="View details">
                                        <mat-icon>{{ expandedEventId === ev.id ? 'expand_less' : 'info' }}</mat-icon>
                                    </button>
                                    @if(!ev.isApproved) {
                                    @if (!eventsCurrentlyRejecting.includes(ev.id)) {
                                    <button class="btn-icon approve" (click)="approveEvent(ev)" title="Approve">
                                        <mat-icon>check</mat-icon>
                                    </button>
                                    <button class="btn-icon reject" (click)="rejectEvent(ev)" title="Reject">
                                        <mat-icon>close</mat-icon>
                                    </button>
                                    } @else {
                                    <div class="inline-reject">
                                        <input #reasonInput type="text" placeholder="Reason..." class="input-reason"
                                            autoFocus (keyup.enter)="confirmReject(ev, reasonInput.value)">
                                        <button class="btn-icon approve" (click)="confirmReject(ev, reasonInput.value)">
                                            <mat-icon>check</mat-icon>
                                        </button>
                                        <button class="btn-icon reject" (click)="cancelReject(ev.id)">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                    }
                                    }

                                    <button *ngIf="ev.isApproved" class="btn-icon delete" (click)="deleteEvent(ev)"
                                        title="Delete Permanently">
                                        <mat-icon>delete_outline</mat-icon>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        @if (expandedEventId === ev.id) {
                        <tr class="event-details-row">
                            <td colspan="6">
                                <div class="event-details">
                                    <div class="detail-item full">
                                        <span class="detail-label">Description</span>
                                        <span class="detail-value description">{{ ev.description || 'No description provided.' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Date</span>
                                        <span class="detail-value">{{ ev.date || '-' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Time</span>
                                        <span class="detail-value">{{ ev.startTime || '-' }} - {{ ev.endTime || '-' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">City</span>
                                        <span class="detail-value">{{ ev.city || '-' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Capacity</span>
                                        <span class="detail-value">{{ ev.nPartecipants || '-' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Cost</span>
                                        <span class="detail-value">{{ ev.costPerPerson != null ? (ev.costPerPerson + ' EUR') : 'Free' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Coordinates</span>
                                        <span class="detail-value">{{ ev.latitude != null && ev.longitude != null ? (ev.latitude + ', ' + ev.longitude) : '-' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Created</span>
                                        <span class="detail-value">{{ ev.createdAt || '-' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Organizer</span>
                                        <span class="detail-value">{{ ev.organizerName || ev.organizer || 'Unknown' }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Event ID</span>
                                        <span class="detail-value">#{{ ev.id }}</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        }

        @if (currentView === 'users') {
        <div class="full-table-section">
            <!-- Search for Users -->
            <div class="search-container">
                <mat-icon class="search-icon">search</mat-icon>
                <input type="text" [(ngModel)]="searchTermUsers" placeholder="Search users by name or email..."
                    class="search-input">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>USER</th>
                            <th>EMAIL</th>
                            <th>ROLE</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (u of filteredUsers; track u.id) {
                        <tr>
                            <td>#{{ u.id }}</td>
                            <td>
                                <div class="ev-organizer">
                                    <img [src]="u.profileImage || 'assets/img/default-avatar.png'" class="table-avatar">
                                    <span>{{ u.name }}</span>
                                </div>
                            </td>
                            <td>{{ u.email }}</td>
                            <td>
                                @if(u.isAdmin) {
                                <span class="status-badge admin">Admin</span>
                                } @else {
                                <span class="status-badge user">User</span>
                                }
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        }

        @if (currentView === 'reports') {
        <div class="reports-grid">
            <div class="reports-list">
                <div class="reports-header">
                    <div class="reports-title">
                        <h3>Reports queue</h3>
                    </div>
                    <div class="reports-chips">
                        <span class="reports-chip">Total {{ reports.length }}</span>
                        <span class="reports-chip">Users {{ reportTypeCounts.USER }}</span>
                        <span class="reports-chip">Events {{ reportTypeCounts.EVENT }}</span>
                    </div>
                </div>

                @if (reports.length === 0) {
                <div class="no-data">No reports yet.</div>
                } @else {
                <div class="reports-items">
                    @for (report of visibleReports; track report.id) {
                    <div class="report-item" [class.active]="selectedReport?.id === report.id"
                        (click)="selectReport(report)">
                        <div class="report-item-top">
                            <div class="report-title">{{ report.reason }}</div>
                            <span class="report-type" [class.user]="report.targetType === 'USER'"
                                [class.event]="report.targetType === 'EVENT'">
                                {{ report.targetType === 'USER' ? 'User' : 'Event' }}
                            </span>
                        </div>
                        <div class="report-meta">
                            <span class="report-target">{{ report.targetName }}</span>
                            @if (report.createdAt) {
                            <span class="report-dot"></span>
                            <span class="report-date">{{ report.createdAt | date:'short' }}</span>
                            }
                        </div>
                    </div>
                    }
                </div>

                @if (hasMoreReports) {
                <button class="reports-toggle" (click)="toggleReportsExpanded()">
                    <mat-icon>{{ showAllReports ? 'expand_less' : 'expand_more' }}</mat-icon>
                    {{ showAllReports ? 'Show fewer' : 'Show more reports' }}
                </button>
                }
                }
            </div>

            <div class="report-detail">
                @if (selectedReport) {
                <div class="detail-card">
                    <div class="detail-header">
                        <div>
                            <span class="detail-kicker">Report details</span>
                            <h3>{{ selectedReport.reason }}</h3>
                        </div>
                        <span class="report-type" [class.user]="selectedReport.targetType === 'USER'"
                            [class.event]="selectedReport.targetType === 'EVENT'">
                            {{ selectedReport.targetType === 'USER' ? 'User' : 'Event' }}
                        </span>
                    </div>

                    <div class="detail-grid">
                        <div class="detail-row">
                            <span class="report-detail-label">Reported:</span>
                            <span class="report-detail-value">{{ selectedReport.targetName }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="report-detail-label">Type:</span>
                            <span class="report-detail-value">{{ selectedReport.targetType }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="report-detail-label">Reporter:</span>
                            <span class="report-detail-value">{{ selectedReport.reporterName }}</span>
                        </div>
                        @if (selectedReport.createdAt) {
                        <div class="detail-row">
                            <span class="report-detail-label">Created:</span>
                            <span class="report-detail-value">{{ selectedReport.createdAt | date:'medium' }}</span>
                        </div>
                        }
                        <div class="detail-row full">
                            <span class="report-detail-label">Details:</span>
                            <span class="report-detail-value">{{ selectedReport.details || 'No details provided.' }}</span>
                        </div>
                    </div>

                    <div class="detail-actions">
                        @if (selectedReport.hasImage && selectedReport.imageUrl) {
                        <a class="button download-btn" [href]="selectedReport.imageUrl" download>
                            <mat-icon>download</mat-icon>
                            Download image
                        </a>
                        } @else {
                        <div class="no-data">No image attached.</div>
                        }
                    </div>
                </div>
                } @else {
                <div class="no-data">Select a report to see details.</div>
                }
            </div>
        </div>
        }
    </div>
</div>
