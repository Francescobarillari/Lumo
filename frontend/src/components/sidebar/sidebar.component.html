<div class="sidebar-container" [class.collapsed]="collapsed">
    <div class="header">
        <h1 class="logo">LUMO</h1>
        <button class="collapse-toggle" (click)="toggle()">
            <mat-icon>{{ collapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
        </button>
    </div>

    <div class="search-container" *ngIf="!collapsed">
        <input type="text" placeholder="Search city, events or user" class="search-input" [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()" (ngModelChange)="onSearchChange($event)">

        <div class="search-actions">
            @if (isSearching) {
            <mat-icon class="search-icon clickable" (click)="clearSearch()">close</mat-icon>
            } @else {
            <mat-icon class="search-icon clickable" (click)="onSearch()">search</mat-icon>
            }
            <mat-icon class="options-icon clickable"
                (click)="showFilterOptions = !showFilterOptions; filterMenuOpen = false; sortMenuOpen = false;">tune</mat-icon>
        </div>
    </div>

    <div class="filter-sort" *ngIf="!collapsed && showFilterOptions">
        <div class="filter-row">
            <div class="pill dropdown" (click)="filterMenuOpen = !filterMenuOpen; sortMenuOpen = false;">
                <div class="pill-inner">
                    <mat-icon>filter_list</mat-icon>
                    <span>{{ filterLabels[filterOption] }}</span>
                    <mat-icon class="chevron">{{ filterMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
                </div>
                @if (filterMenuOpen) {
                <div class="dropdown-menu">
                    @for (opt of filterOrder; track $index) {
                    <button class="menu-item" (click)="selectFilter(opt); $event.stopPropagation()">
                        <span>{{ filterLabels[opt] }}</span>
                        @if (filterOption === opt) { <mat-icon>check</mat-icon> }
                    </button>
                    }
                </div>
                }
            </div>

            <div class="pill dropdown" (click)="sortMenuOpen = !sortMenuOpen; filterMenuOpen = false;">
                <div class="pill-inner">
                    <mat-icon>swap_vert</mat-icon>
                    <span>{{ sortLabels[sortOption] }}</span>
                    <mat-icon class="chevron">{{ sortMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
                </div>
                @if (sortMenuOpen) {
                <div class="dropdown-menu">
                    @for (opt of sortOrder; track $index) {
                    <button class="menu-item" (click)="selectSort(opt); $event.stopPropagation()">
                        <span>{{ sortLabels[opt] }}</span>
                        @if (sortOption === opt) { <mat-icon>check</mat-icon> }
                    </button>
                    }
                </div>
                }
            </div>
        </div>

        <div class="range-filter">
            <div class="range-header">
                <span>Price</span>
                <span class="range-value">€{{ priceMin.toFixed(0) }} - €{{ priceMax.toFixed(0) }}</span>
            </div>
            <div class="range-inputs dual" [style.--min-percent]="priceMinPercent"
                [style.--max-percent]="priceMaxPercent">
                <input class="min-range" type="range" [min]="0" [max]="priceMaxLimit" [step]="priceStep"
                    [value]="priceMin" (input)="onPriceMinChange($any($event.target).value)">
                <input class="max-range" type="range" [min]="priceMin" [max]="priceMaxLimit" [step]="priceStep"
                    [value]="priceMax" (input)="onPriceMaxChange($any($event.target).value)">
            </div>
        </div>

        <div class="range-filter">
            <div class="range-header">
                <span>Distance</span>
                <span class="range-value">{{ distanceMin.toFixed(1) }} - {{ distanceMax.toFixed(1) }} km</span>
            </div>
            <div class="range-inputs dual" [style.--min-percent]="distanceMinPercent"
                [style.--max-percent]="distanceMaxPercent">
                <input class="min-range" type="range" [min]="0" [max]="distanceMaxLimit" [step]="distanceStep"
                    [value]="distanceMin" (input)="onDistanceMinChange($any($event.target).value)">
                <input class="max-range" type="range" [min]="distanceMin" [max]="distanceMaxLimit" [step]="distanceStep"
                    [value]="distanceMax" (input)="onDistanceMaxChange($any($event.target).value)">
            </div>
        </div>
    </div>

    <div class="sections-container" [class.search-mode]="isSearching" *ngIf="!collapsed">

        @if (isSearching) {

        <div class="tabs-header">
            <button class="tab-btn" [class.active]="activeTab === 'events'" (click)="setActiveTab('events')">
                EVENTS
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'places'" (click)="setActiveTab('places')">
                PLACES
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'creators'" (click)="setActiveTab('creators')">
                CREATORS
            </button>
        </div>

        @if (activeTab === 'events') {
        <div class="events-section">
            <div class="events-list">
                <!-- SEARCH RESULTS PAGINATION -->
                @for (event of filteredSearchResults | slice:0:shownSearch; track event.id) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [savedCount]="event.savedCount" [showSavedCount]="false" [isParticipating]="!!event.isParticipating"
                    [organizerName]="event.organizerName" [organizerImage]="event.organizerImage"
                    [creatorId]="event.creatorId" [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                    (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                    [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }

                @if (shownSearch < filteredSearchResults.length) { <button class="show-more-btn"
                    (click)="showMoreSearch()">Show more</button>
                    }

                    @if (filteredSearchResults.length === 0) {
                    <div class="empty-state">No events found.</div>
                    }
            </div>
        </div>
        }

        @if (activeTab === 'places') {
        <div class="events-section">
            <div class="events-list">
                @for (city of cityResults; track $index) {
                <div class="location-item clickable" (click)="selectCity(city)">
                    <div class="icon-circle small">
                        <mat-icon>location_on</mat-icon>
                    </div>
                    <div class="loc-info">
                        <span class="loc-name">{{ city.name }}</span>
                    </div>
                </div>
                }
            </div>
            @if (cityResults.length === 0) {
            <div class="empty-state">No places found.</div>
            }
        </div>
        }

        @if (activeTab === 'creators') {
        <div class="events-section">
            <div class="events-list">
                @for (user of userResults; track $index) {
                <div class="location-item clickable" (click)="openUserProfile.emit(user.id.toString())">
                    <div class="icon-circle small"
                        [style.background-image]="'url(' + (user.profileImage || 'assets/img/default-avatar.png') + ')'"
                        [style.background-size]="'cover'">
                    </div>
                    <div class="loc-info">
                        <span class="loc-name">{{ user.name }}</span>
                    </div>
                    @if (userId && userId.toString() !== user.id.toString()) {
                    <div class="icon-circle follow-icon" [class.following]="followingMap[user.id]"
                        (click)="followingMap[user.id] ? unfollowUser(user, $event) : followUser(user, $event); $event.stopPropagation()">
                        <mat-icon>{{ followingMap[user.id] ? 'person' : 'person_add' }}</mat-icon>
                    </div>
                    }
                </div>
                }
            </div>
            @if (userResults.length === 0) {
            <div class="empty-state">No creators found.</div>
            }
        </div>
        }

        } @else {

        @if (!userId) {
        <!-- GUEST MODE: FOUND EVENTS -->
        <div class="events-section">
            <h2 class="section-title">FOUND EVENTS</h2>
            <div class="events-list">
                @for (event of filteredFoundEvents | slice:0:shownFound; track event.id) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [savedCount]="event.savedCount" [showSavedCount]="false" [isParticipating]="!!event.isParticipating"
                    [organizerName]="event.organizerName" [organizerImage]="event.organizerImage"
                    [creatorId]="event.creatorId" [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                    (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                    [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }

                @if (shownFound < filteredFoundEvents.length) { <button class="show-more-btn" (click)="showMoreFound()">
                    Show more</button>
                    }

                    @if (filteredFoundEvents.length === 0) {
                    <div class="empty-state">No events found in your area.</div>
                    }
            </div>
        </div>
        } @else {
        <!-- LOGGED IN MODE -->

        <!-- FOLLOW UP EVENTS -->
        <div class="events-section">
            <h2 class="section-title">FOLLOW UP EVENTS</h2>
            <div class="events-list">
                @for (event of filteredFollowUpEvents | slice:0:shownFollowUp; track event.id) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [savedCount]="event.savedCount" [showSavedCount]="false" [isParticipating]="true"
                    [organizerName]="event.organizerName" [organizerImage]="event.organizerImage"
                    [creatorId]="event.creatorId" [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                    (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                    [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }

                @if (shownFollowUp < filteredFollowUpEvents.length) { <button class="show-more-btn"
                    (click)="showMoreFollowUp()">Show more</button>
                    }

                    @if (filteredFollowUpEvents.length === 0) {
                    <div class="empty-state">No upcoming events you are participating in.</div>
                    }
            </div>
        </div>

        <!-- SAVED EVENTS -->
        <div class="events-section">
            <h2 class="section-title">SAVED EVENTS</h2>
            <div class="events-list">
                @for (event of filteredSavedEvents | slice:0:shownSaved; track event.id) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [savedCount]="event.savedCount" [showSavedCount]="false"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                    [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                    (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                    (shareEvent)="shareEvent.emit(event)" [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }

                @if (shownSaved < filteredSavedEvents.length) { <button class="show-more-btn" (click)="showMoreSaved()">
                    Show more</button>
                    }

                    @if (filteredSavedEvents.length === 0) {
                    <div class="empty-state">You haven't saved any events yet.</div>
                    }
            </div>
        </div>

        <!-- DISCOVER EVENTS -->
        <div class="events-section">
            <h2 class="section-title">DISCOVER EVENTS</h2>
            <div class="events-list">
                @for (event of filteredDiscoverEvents | slice:0:shownDiscover; track event.id) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [savedCount]="event.savedCount" [showSavedCount]="false" [organizerName]="event.organizerName"
                    [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                    (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                    (shareEvent)="shareEvent.emit(event)" [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }

                @if (shownDiscover < filteredDiscoverEvents.length) { <button class="show-more-btn"
                    (click)="showMoreDiscover()">Show more</button>
                    }

                    @if (filteredDiscoverEvents.length === 0) {
                    <div class="empty-state">No new events to discover at the moment.</div>
                    }
            </div>
        </div>
        }

        } <!-- End of !isSearching block -->
    </div>
</div>