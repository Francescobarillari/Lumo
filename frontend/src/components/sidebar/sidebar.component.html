<div class="sidebar-container" [class.collapsed]="collapsed">
    <div class="header">
        <h1 class="logo">LUMO</h1>
        <button class="collapse-toggle" (click)="toggle()">
            <mat-icon>{{ collapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
        </button>
    </div>

    <div class="search-container" *ngIf="!collapsed">
        <input type="text" placeholder="Search city, events or user" class="search-input" [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()" (ngModelChange)="onSearchChange($event)">

        @if (isSearching) {
        <mat-icon class="search-icon clickable" (click)="clearSearch()">close</mat-icon>
        } @else {
        <mat-icon class="search-icon clickable" (click)="onSearch()">search</mat-icon>
        }
    </div>

    <div class="filter-sort" *ngIf="!collapsed">
        <div class="pill dropdown" (click)="filterMenuOpen = !filterMenuOpen; sortMenuOpen = false;">
            <div class="pill-inner">
                <mat-icon>filter_list</mat-icon>
                <span>{{ filterLabels[filterOption] }}</span>
                <mat-icon class="chevron">{{ filterMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>
            @if (filterMenuOpen) {
            <div class="dropdown-menu">
                @for (opt of filterOrder; track $index) {
                <button class="menu-item" (click)="selectFilter(opt); $event.stopPropagation()">
                    <span>{{ filterLabels[opt] }}</span>
                    @if (filterOption === opt) { <mat-icon>check</mat-icon> }
                </button>
                }
            </div>
            }
        </div>

        <div class="pill dropdown" (click)="sortMenuOpen = !sortMenuOpen; filterMenuOpen = false;">
            <div class="pill-inner">
                <mat-icon>swap_vert</mat-icon>
                <span>{{ sortLabels[sortOption] }}</span>
                <mat-icon class="chevron">{{ sortMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
            </div>
            @if (sortMenuOpen) {
            <div class="dropdown-menu">
                @for (opt of sortOrder; track $index) {
                <button class="menu-item" (click)="selectSort(opt); $event.stopPropagation()">
                    <span>{{ sortLabels[opt] }}</span>
                    @if (sortOption === opt) { <mat-icon>check</mat-icon> }
                </button>
                }
            </div>
            }
        </div>
    </div>

    <div class="sections-container" *ngIf="!collapsed">

        @if (isSearching) {

        <div class="tabs-header">
            <button class="tab-btn" [class.active]="activeTab === 'events'" (click)="setActiveTab('events')">
                EVENTI
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'places'" (click)="setActiveTab('places')">
                LOCALITÀ
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'creators'" (click)="setActiveTab('creators')">
                EVENTER
            </button>
        </div>

        @if (activeTab === 'events') {
        <div class="events-section">
            <div class="events-list">
                @for (event of getFiltered(searchResults); track $index) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                    [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                    (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }
            </div>
            @if (searchResults.length === 0) {
            <div class="empty-state">Nessun evento trovato.</div>
            }
        </div>
        }

        @if (activeTab === 'places') {
        <div class="events-section">
            <div class="events-list">
                @for (city of cityResults; track $index) {
                <div class="location-item clickable" (click)="selectCity(city)">
                    <div class="icon-circle small">
                        <mat-icon>location_on</mat-icon>
                    </div>
                    <div class="loc-info">
                        <span class="loc-name">{{ city.name }}</span>
                    </div>
                </div>
                }
            </div>
            @if (cityResults.length === 0) {
            <div class="empty-state">Nessuna località trovata.</div>
            }
        </div>
        }

        @if (activeTab === 'creators') {
        <div class="events-section">
            <div class="events-list">
                @for (user of userResults; track $index) {
                <div class="location-item clickable" (click)="openUserProfile.emit(user.id.toString())">
                    <div class="icon-circle small"
                        [style.background-image]="user.profileImage ? 'url(' + user.profileImage + ')' : ''"
                        [style.background-size]="'cover'">
                        @if (!user.profileImage) {
                        <mat-icon>person</mat-icon>
                        }
                    </div>
                    <div class="loc-info">
                        <span class="loc-name">{{ user.name }}</span>
                        <span class="loc-details" style="font-size: 12px; opacity: 0.7;">{{ user.email }}</span>
                    </div>
                    @if (userId && userId.toString() !== user.id.toString()) {
                    <div class="icon-circle follow-icon" [class.following]="followingMap[user.id]"
                        (click)="followingMap[user.id] ? unfollowUser(user, $event) : followUser(user, $event); $event.stopPropagation()">
                        <mat-icon>{{ followingMap[user.id] ? 'person' : 'person_add' }}</mat-icon>
                    </div>
                    }
                </div>
                }
            </div>
            @if (userResults.length === 0) {
            <div class="empty-state">Nessun eventer trovato.</div>
            }
        </div>
        }

        } @else {

        @if (!userId) {
        <!-- GUEST MODE: FOUND EVENTS -->
        <div class="events-section">
            <h2 class="section-title">FOUND EVENTS</h2>
            <div class="events-list">
                @for (event of getFiltered(foundEvents); track $index) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                    [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                    (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                    [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }
                @if (foundEvents.length === 0) {
                <div class="empty-state">Nessun evento trovato nella tua zona.</div>
                }
            </div>
        </div>
        } @else {
        <!-- LOGGED IN MODE -->

        <!-- FOLLOW UP EVENTS -->
        <div class="events-section">
            <h2 class="section-title">FOLLOW UP EVENTS</h2>
            <div class="events-list">
                @for (event of getFiltered(followUpEvents); track $index) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                    [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                    (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                    [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }
                @if (followUpEvents.length === 0) {
                <div class="empty-state">Nessun evento imminente a cui partecipi.</div>
                }
            </div>
        </div>

        <!-- SAVED EVENTS -->
        <div class="events-section">
            <h2 class="section-title">SAVED EVENTS</h2>
            <div class="events-list">
                @for (event of getFiltered(savedEvents); track $index) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                    [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                    (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                    [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }
                @if (savedEvents.length === 0) {
                <div class="empty-state">Non hai ancora salvato nessun evento.</div>
                }
            </div>
        </div>

        <!-- DISCOVER EVENTS -->
        <div class="events-section">
            <h2 class="section-title">DISCOVER EVENTS</h2>
            <div class="events-list">
                @for (event of getFiltered(discoverEvents); track $index) {
                <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                    [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                    [organizerName]="event.organizerName" [organizerImage]="event.organizerImage"
                    [creatorId]="event.creatorId" [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                    (toggleFavorite)="toggleFavorite.emit(event)" [showOrganizerInfo]="false"
                    (openOrganizerProfile)="event.creatorId ? openUserProfile.emit(event.creatorId.toString()) : null" />
                }
                @if (discoverEvents.length === 0) {
                <div class="empty-state">Nessun nuovo evento da scoprire al momento.</div>
                }
            </div>
        </div>
        }

        } <!-- End of !isSearching block -->
    </div>
</div>
