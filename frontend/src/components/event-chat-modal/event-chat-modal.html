<div class="chat-backdrop" (click)="onClose()">
  <div class="chat-container" (click)="$event.stopPropagation()">
    <div class="chat-header">
      <div class="header-left">
        <button class="icon-btn back-btn mobile-only" (click)="onClose()" aria-label="Back">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-text">
          <span class="title">Event Chat</span>
          <span class="subtitle">{{ event.title }}</span>
        </div>
      </div>
      <button class="close-btn" (click)="onClose()" aria-label="Close chat">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="chat-body">
      <div class="chat-left">
        <!-- Single Pinned Item Bar -->
        @if (pinnedItem) {
        <div class="pinned-bar" (click)="scrollToItem(pinnedId!, pinnedType!)">
          <mat-icon class="pin-icon">push_pin</mat-icon>
          <div class="pinned-content">
            <span class="pinned-sender">{{ getPinnedSenderName() }}</span>
            <span class="pinned-text">{{ getPinnedDisplayText() }}</span>
          </div>
          <button class="unpin-btn" *ngIf="isOrganizer"
            (click)="togglePin(pinnedItem, pinnedType!); $event.stopPropagation()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        }
        <div class="messages" #messagesContainer (click)="closePinMenu()">
          <div class="info-message" *ngFor="let info of infoMessages" [attr.id]="info.anchorId">
            <div class="info-label">{{ info.label }}</div>
            <div class="info-content">{{ info.content }}</div>
            <a *ngIf="info.link" class="info-link" [href]="info.link" target="_blank" rel="noopener">Open link</a>
          </div>
          <div class="timeline-item" *ngFor="let item of timelineItems">
            @if (item.type === 'message' && item.message) {
            <div class="message" [attr.id]="getItemAnchorId(item.message.id, 'message')"
              [class.mine]="currentUserId && item.message.senderId.toString() === currentUserId"
              [class.pin-enabled]="isOrganizer" (click)="openPinMenu(item.message, 'message', $event)">
              <div class="avatar">
                <img *ngIf="item.message.senderImage" [src]="item.message.senderImage" alt="Avatar">
                <div *ngIf="!item.message.senderImage" class="placeholder">
                  {{ item.message.senderName.slice(0, 1) || '?' }}
                </div>
              </div>
              <div class="content">
                <div class="meta">
                  <span class="name">{{ item.message.senderName }}</span>
                  <span class="time">{{ formatTimestamp(item.message.createdAt) }}</span>
                  @if (isOrganizer && activePinId === item.message.id && activePinType === 'message') {
                  <div class="pin-menu" (click)="$event.stopPropagation()">
                    <button class="pin-menu-btn" type="button"
                      (click)="togglePinFromMenu(item.message, 'message', $event)"
                      [class.active]="isPinned(item.message.id, 'message')"
                      [class.unpin]="isPinned(item.message.id, 'message')"
                      [attr.aria-label]="isPinned(item.message.id, 'message') ? 'Unpin' : 'Pin message'">
                      <mat-icon>push_pin</mat-icon>
                    </button>
                  </div>
                  }
                </div>
                <div class="text">{{ item.message.content }}</div>
              </div>
            </div>
            }
            @if (item.type === 'poll' && item.poll) {
            <div class="poll-message-card" [attr.id]="getItemAnchorId(item.poll.id, 'poll')"
              [class.pin-enabled]="isOrganizer" (click)="openPinMenu(item.poll, 'poll', $event)">
              <div class="poll-message-header">
                <div class="header-main">
                  <span class="poll-tag">Sondaggio</span>
                  <span class="time">{{ formatTimestamp(item.poll.createdAt) }}</span>
                </div>
                @if (isOrganizer && activePinId === item.poll.id && activePinType === 'poll') {
                <div class="pin-menu" (click)="$event.stopPropagation()">
                  <button class="pin-menu-btn" type="button" (click)="togglePinFromMenu(item.poll, 'poll', $event)"
                    [class.active]="isPinned(item.poll.id, 'poll')" [class.unpin]="isPinned(item.poll.id, 'poll')"
                    [attr.aria-label]="isPinned(item.poll.id, 'poll') ? 'Unpin' : 'Pin poll'">
                    <mat-icon>push_pin</mat-icon>
                  </button>
                </div>
                }
              </div>
              <div class="poll-message-question">{{ item.poll.question }}</div>
              <div class="poll-bars">
                <div class="poll-bar-row" *ngFor="let option of item.poll.options"
                  [class.selected]="pollSelections[item.poll.id]?.has(option.id)" [class.closed]="item.poll.closed"
                  (click)="toggleVote(item.poll, option.id)">
                  <div class="poll-bar-label">
                    <span>{{ option.text }}</span>
                    <span class="poll-bar-count">{{ getPollOptionCount(option) }}</span>
                  </div>
                  <div class="poll-bar-track">
                    <div class="poll-bar-fill" [style.width]="getPollBarWidth(item.poll, option)"></div>
                  </div>
                </div>
              </div>
              <div class="poll-actions">
                <button *ngIf="isOrganizer" class="pill ghost" (click)="closePoll(item.poll)"
                  [disabled]="item.poll.closed">
                  Chiudi sondaggio
                </button>
              </div>
              <div class="poll-total">Totale voti: {{ getPollTotalVotes(item.poll) }}</div>
            </div>
            }
          </div>
          <div *ngIf="timelineItems.length === 0" class="empty-state">
            Nessun messaggio ancora.
          </div>
        </div>

        <div class="mute-banner" *ngIf="isMuted">
          Sei stato mutato: puoi leggere ma non inviare messaggi.
        </div>

        <div class="message-input">
          <input [(ngModel)]="messageText" placeholder="Scrivi un messaggio..." (input)="messageError = ''"
            [disabled]="isMuted" (keydown.enter)="sendMessage()">
          <button *ngIf="currentUserId" class="add-btn" (click)="openPollPopup()" [disabled]="isMuted">
            <mat-icon>add</mat-icon>
          </button>
          <button class="send-btn" (click)="sendMessage()" [disabled]="isMuted || !messageText.trim()">
            <mat-icon>send</mat-icon>
          </button>
        </div>
        <div class="message-error" *ngIf="messageError">{{ messageError }}</div>
      </div>
    </div>

    @if (showPollPopup) {
    <div class="poll-popup-backdrop" (click)="closePollPopup()">
      <div class="poll-popup" (click)="$event.stopPropagation()">
        <div class="poll-popup-header">
          <span>Crea sondaggio</span>
          <button class="icon-btn" (click)="closePollPopup()">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div class="poll-create">
          <input [(ngModel)]="pollQuestion" placeholder="Domanda del sondaggio" class="poll-question-input">

          <div class="poll-options-list">
            <div class="poll-option-row" *ngFor="let option of pollOptions; let i = index; trackBy: trackByIndex">
              <input [(ngModel)]="pollOptions[i]" [placeholder]="'Opzione ' + (i + 1)">
              <button class="remove-option-btn" (click)="removePollOption(i)" *ngIf="pollOptions.length > 2">
                <mat-icon>remove_circle_outline</mat-icon>
              </button>
            </div>
          </div>

          <button class="add-option-pill" (click)="addPollOption()">
            <mat-icon>add</mat-icon>
            Aggiungi opzione
          </button>

          <div class="poll-error" *ngIf="pollError">{{ pollError }}</div>
          <button class="pill create-poll-btn" (click)="createPoll()">Crea sondaggio</button>
        </div>
      </div>
    </div>
    }
  </div>
</div>
