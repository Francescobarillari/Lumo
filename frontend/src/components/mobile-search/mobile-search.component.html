<div class="mobile-search-wrapper" [class.expanded]="isExpanded">
    <!-- The Pill Search Bar at the bottom -->
    <div class="floating-search-bar" (click)="!isExpanded && toggleExpand()">
        <mat-icon class="search-icon">search</mat-icon>
        <input type="text" placeholder="Search events, cities or people" class="pill-input" [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()" (focus)="!isExpanded && toggleExpand()" [readonly]="!isExpanded">
        <mat-icon *ngIf="isExpanded && activeTab === 'events'" class="options-icon"
            (click)="showFilterOptions = !showFilterOptions; filterMenuOpen = false; sortMenuOpen = false; $event.stopPropagation()">tune</mat-icon>
        <mat-icon *ngIf="isExpanded" class="close-icon"
            (click)="toggleExpand(); $event.stopPropagation()">close</mat-icon>
    </div>

    <!-- Full-screen Search View -->
    <div class="search-overlay" *ngIf="isExpanded">
        <div class="search-results-container">

            <div class="tabs-header">
                <button class="tab-btn" [class.active]="activeTab === 'events'"
                    (click)="setActiveTab('events')">EVENTS</button>
                <button class="tab-btn" [class.active]="activeTab === 'places'"
                    (click)="setActiveTab('places')">PLACES</button>
                <button class="tab-btn" [class.active]="activeTab === 'creators'"
                    (click)="setActiveTab('creators')">EVENTER</button>
            </div>

            @if (activeTab === 'events' && showFilterOptions) {
            <div class="filter-sort-container">
                <div class="filter-row">
                    <div class="pill dropdown" (click)="filterMenuOpen = !filterMenuOpen; sortMenuOpen = false;">
                        <div class="pill-inner">
                            <mat-icon>filter_list</mat-icon>
                            <span>{{ filterLabels[filterOption] }}</span>
                            <mat-icon class="chevron">{{ filterMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
                        </div>
                        @if (filterMenuOpen) {
                        <div class="dropdown-menu">
                            @for (opt of filterOrder; track $index) {
                            <button class="menu-item" (click)="selectFilter(opt); $event.stopPropagation()">
                                <span>{{ filterLabels[opt] }}</span>
                                @if (filterOption === opt) { <mat-icon>check</mat-icon> }
                            </button>
                            }
                        </div>
                        }
                    </div>

                    <div class="pill dropdown" (click)="sortMenuOpen = !sortMenuOpen; filterMenuOpen = false;">
                        <div class="pill-inner">
                            <mat-icon>swap_vert</mat-icon>
                            <span>{{ sortLabels[sortOption] }}</span>
                            <mat-icon class="chevron">{{ sortMenuOpen ? 'expand_less' : 'expand_more' }}</mat-icon>
                        </div>
                        @if (sortMenuOpen) {
                        <div class="dropdown-menu">
                            @for (opt of sortOrder; track $index) {
                            <button class="menu-item" (click)="selectSort(opt); $event.stopPropagation()">
                                <span>{{ sortLabels[opt] }}</span>
                                @if (sortOption === opt) { <mat-icon>check</mat-icon> }
                            </button>
                            }
                        </div>
                        }
                    </div>
                </div>

                <div class="range-filter">
                    <div class="range-header">
                        <span>Price</span>
                        <span class="range-value">€{{ priceMin.toFixed(0) }} - €{{ priceMax.toFixed(0) }}</span>
                    </div>
                    <div class="range-inputs dual" [style.--min-percent]="priceMinPercent"
                        [style.--max-percent]="priceMaxPercent">
                        <input class="min-range" type="range" [min]="0" [max]="priceMaxLimit" [step]="priceStep"
                            [value]="priceMin" (input)="onPriceMinChange($any($event.target).value)">
                        <input class="max-range" type="range" [min]="priceMin" [max]="priceMaxLimit" [step]="priceStep"
                            [value]="priceMax" (input)="onPriceMaxChange($any($event.target).value)">
                    </div>
                </div>

                <div class="range-filter">
                    <div class="range-header">
                        <span>Distance</span>
                        <span class="range-value">{{ distanceMin.toFixed(1) }} - {{ distanceMax.toFixed(1) }} km</span>
                    </div>
                    <div class="range-inputs dual" [style.--min-percent]="distanceMinPercent"
                        [style.--max-percent]="distanceMaxPercent">
                        <input class="min-range" type="range" [min]="0" [max]="distanceMaxLimit" [step]="distanceStep"
                            [value]="distanceMin" (input)="onDistanceMinChange($any($event.target).value)">
                        <input class="max-range" type="range" [min]="distanceMin" [max]="distanceMaxLimit"
                            [step]="distanceStep" [value]="distanceMax"
                            (input)="onDistanceMaxChange($any($event.target).value)">
                    </div>
                </div>
            </div>
            }

            <div class="results-scroll-area">
                @if (activeTab === 'events') {
                @if (isSearching && hasSearchQuery) {
                <div class="list-view">
                    @for (event of filteredSearchResults | slice:0:shownSearch; track event.id) {
                    <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                        [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                        [savedCount]="event.savedCount" [showSavedCount]="false"
                        [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                        [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                        (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)"
                        (shareEvent)="shareEvent.emit(event)" />
                    }
                    @if (filteredSearchResults.length > shownSearch) {
                    <button class="show-more-btn" (click)="showMoreSearch()">Show more</button>
                    }
                    @if (searchResults.length === 0) {
                    <div class="empty-state">No events found.</div>
                    }
                </div>
                } @else {
                @if (!userId) {
                <div class="mobile-section">
                    <div class="section-title">FOUND EVENTS</div>
                    <div class="list-view">
                        @for (event of filteredFoundEvents | slice:0:shownFound; track $index) {
                        <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                            [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                            [savedCount]="event.savedCount" [showSavedCount]="false"
                            [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                            [organizerImage]="event.organizerImage" [creatorId]="event.creatorId"
                            [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                            (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                            [showOrganizerInfo]="false" />
                        }
                        @if (filteredFoundEvents.length > shownFound) {
                        <button class="show-more-btn" (click)="showMoreFound()">Show more</button>
                        }
                        @if (foundEvents.length === 0) {
                        <div class="empty-state">No events found in your area.</div>
                        }
                    </div>
                </div>
                } @else {
                <div class="mobile-section">
                    <div class="section-title">FOLLOW UP EVENTS</div>
                    <div class="list-view">
                        @for (event of filteredFollowUpEvents | slice:0:shownFollowUp; track $index) {
                        <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                            [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                            [savedCount]="event.savedCount" [showSavedCount]="false" [isParticipating]="true"
                            [organizerName]="event.organizerName" [organizerImage]="event.organizerImage"
                            [creatorId]="event.creatorId" [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                            (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                            [showOrganizerInfo]="false" />
                        }
                        @if (filteredFollowUpEvents.length > shownFollowUp) {
                        <button class="show-more-btn" (click)="showMoreFollowUp()">Show more</button>
                        }
                        @if (followUpEvents.length === 0) {
                        <div class="empty-state">No upcoming events you are participating in.</div>
                        }
                    </div>
                </div>

                <div class="mobile-section">
                    <div class="section-title">SAVED EVENTS</div>
                    <div class="list-view">
                        @for (event of filteredSavedEvents | slice:0:shownSaved; track $index) {
                        <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                            [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                            [savedCount]="event.savedCount" [showSavedCount]="false"
                            [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                            [organizerImage]="event.organizerImage" [creatorId]="event.creatorId"
                            [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                            (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                            [showOrganizerInfo]="false" />
                        }
                        @if (filteredSavedEvents.length > shownSaved) {
                        <button class="show-more-btn" (click)="showMoreSaved()">Show more</button>
                        }
                        @if (savedEvents.length === 0) {
                        <div class="empty-state">You haven't saved any events yet.</div>
                        }
                    </div>
                </div>

                <div class="mobile-section">
                    <div class="section-title">DISCOVER EVENTS</div>
                    <div class="list-view">
                        @for (event of filteredDiscoverEvents | slice:0:shownDiscover; track $index) {
                        <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                            [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                            [savedCount]="event.savedCount" [showSavedCount]="false"
                            [organizerName]="event.organizerName" [organizerImage]="event.organizerImage"
                            [creatorId]="event.creatorId" [currentUserId]="userId" (focusLocation)="goToEvent(event)"
                            (toggleFavorite)="toggleFavorite.emit(event)" (shareEvent)="shareEvent.emit(event)"
                            [showOrganizerInfo]="false" />
                        }
                        @if (filteredDiscoverEvents.length > shownDiscover) {
                        <button class="show-more-btn" (click)="showMoreDiscover()">Show more</button>
                        }
                        @if (discoverEvents.length === 0) {
                        <div class="empty-state">No new events to discover at the moment.</div>
                        }
                    </div>
                </div>
                }
                }
                }

                @if (activeTab === 'places') {
                <div class="list-view">
                    @for (city of cityResults; track $index) {
                    <div class="location-item clickable" (click)="selectCity(city)">
                        <div class="icon-circle">
                            <mat-icon>location_on</mat-icon>
                        </div>
                        <div class="loc-info">
                            <span class="loc-name">{{ city.name }}</span>
                        </div>
                    </div>
                    }
                    @if (isSearching && cityResults.length === 0) {
                    <div class="empty-state">No places found.</div>
                    }
                </div>
                }

                @if (activeTab === 'creators') {
                <div class="list-view">
                    @for (user of userResults; track user.id) {
                    <div class="location-item clickable" (click)="openProfile(user)">
                        <div class="icon-circle"
                            [style.background-image]="'url(' + (user.profileImage || 'assets/img/default-avatar.png') + ')'"
                            [style.background-size]="'cover'">
                        </div>
                        <div class="loc-info">
                            <span class="loc-name">{{ user.name }}</span>
                        </div>
                    </div>
                    }
                    @if (isSearching && userResults.length === 0) {
                    <div class="empty-state">No eventers found.</div>
                    }
                </div>
                }
            </div>
        </div>
    </div>
</div>