<div class="mobile-search-wrapper" [class.expanded]="isExpanded">
    <!-- The Pill Search Bar at the bottom -->
    <div class="floating-search-bar" (click)="!isExpanded && toggleExpand()">
        <mat-icon class="search-icon">search</mat-icon>
        <input type="text" placeholder="Cerca eventi, città o persone" class="pill-input" [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()" (focus)="!isExpanded && toggleExpand()" [readonly]="!isExpanded">
        <mat-icon *ngIf="isExpanded" class="close-icon"
            (click)="toggleExpand(); $event.stopPropagation()">close</mat-icon>
    </div>

    <!-- Full-screen Search View -->
    <div class="search-overlay" *ngIf="isExpanded">
        <div class="search-results-container">

            <div class="tabs-header">
                <button class="tab-btn" [class.active]="activeTab === 'events'"
                    (click)="setActiveTab('events')">EVENTI</button>
                <button class="tab-btn" [class.active]="activeTab === 'places'"
                    (click)="setActiveTab('places')">LOCALITÀ</button>
                <button class="tab-btn" [class.active]="activeTab === 'creators'"
                    (click)="setActiveTab('creators')">EVENTER</button>
            </div>

            <div class="results-scroll-area">
                @if (activeTab === 'events') {
                <div class="list-view">
                    @for (event of searchResults; track event.id) {
                    <app-event-card [title]="event.title" [location]="event.city" [dateTime]="formatDateTime(event)"
                        [distance]="formatDistance(event.distanceKm)" [id]="event.id!" [isSaved]="!!event.isSaved"
                        [isParticipating]="!!event.isParticipating" [organizerName]="event.organizerName"
                        [organizerImage]="event.organizerImage" [creatorId]="event.creatorId" [currentUserId]="userId"
                        (focusLocation)="goToEvent(event)" (toggleFavorite)="toggleFavorite.emit(event)" />
                    }
                    @if (isSearching && searchResults.length === 0) {
                    <div class="empty-state">Nessun evento trovato.</div>
                    }
                </div>
                }

                @if (activeTab === 'places') {
                <div class="list-view">
                    @for (city of cityResults; track $index) {
                    <div class="location-item clickable" (click)="selectCity(city)">
                        <div class="icon-circle">
                            <mat-icon>location_on</mat-icon>
                        </div>
                        <div class="loc-info">
                            <span class="loc-name">{{ city.name }}</span>
                        </div>
                    </div>
                    }
                    @if (isSearching && cityResults.length === 0) {
                    <div class="empty-state">Nessuna località trovata.</div>
                    }
                </div>
                }

                @if (activeTab === 'creators') {
                <div class="list-view">
                    @for (user of userResults; track user.id) {
                    <div class="location-item clickable" (click)="openProfile(user)">
                        <div class="icon-circle"
                            [style.background-image]="user.profileImage ? 'url(' + user.profileImage + ')' : ''"
                            [style.background-size]="'cover'">
                            <mat-icon *ngIf="!user.profileImage">person</mat-icon>
                        </div>
                        <div class="loc-info">
                            <span class="loc-name">{{ user.name }}</span>
                        </div>
                        @if (userId && userId.toString() !== user.id.toString()) {
                        <div class="icon-circle follow-icon" [class.following]="followingMap[user.id]"
                            (click)="followingMap[user.id] ? unfollowUser(user, $event) : followUser(user, $event)">
                            <mat-icon>{{ followingMap[user.id] ? 'person' : 'person_add' }}</mat-icon>
                        </div>
                        }
                    </div>
                    }
                    @if (isSearching && userResults.length === 0) {
                    <div class="empty-state">Nessun eventer trovato.</div>
                    }
                </div>
                }
            </div>
        </div>
    </div>
</div>
