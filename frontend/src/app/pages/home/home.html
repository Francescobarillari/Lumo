<div class="home-container">
  @if (!loggedUser) {
  <div class="top-bar">
    <a class="button" (click)="openSignUp()">Sign Up</a>
    <a class="button" (click)="openSignIn()">Sign In</a>
  </div>
  } @else {
  <app-action-bar [loggedUser]="loggedUser" (action)="onMenuAction($event)"
    (openProfile)="openUserProfile($event)" (openChatFromNotification)="onChatNotification($event)"></app-action-bar>

  <!-- Hidden input for file selection triggered by menu -->
  <input id="hiddenFileInput" type="file" (change)="onFileSelected($event)" style="display: none" accept="image/*">
  }

  @if (showSignUp) {
  <SignUpPopup (switchToSignIn)="switchToSignIn()" (close)="closeAll()"
    (signUpSuccess)="openVerifyPopup($event.email, $event.token)" (signInSuccess)="onSignInSuccess($event)" />
  }

  @if (showVerifyPopup) {
  <VerifyEmailPopup [email]="recentEmail" [token]="recentToken" [verified]="emailVerified" (close)="closeAll()"
    (resendVerification)="resendEmail()" />
  }

  @if (showSignIn) {
  <SignInPopup (switchToSignUp)="switchToSignUp()" (close)="closeAll()" (signInSuccess)="onSignInSuccess($event)" />
  }

  @if (showUserProfile) {
  <app-user-profile-modal [userId]="selectedUserProfileId"
    [currentUserId]="loggedUser ? (loggedUser.id.toString()) : null" (close)="closeAll()"
    (openProfile)="openUserProfile($event)"></app-user-profile-modal>
  }

  <map-view [userId]="loggedUser ? loggedUser.id || '' : null" (eventSelected)="openEventPopup($event)"
    (mapInteract)="closeEventPopup()" (requestLogin)="openSignIn()" (eventsUpdated)="onEventsUpdated($event)"
    (openUserProfile)="openUserProfile($event)">
  </map-view>

  @if (showCropPopup && selectedImageFile) {
  <CropImagePopup [imageFile]="selectedImageFile" (close)="showCropPopup = false"
    (imageCropped)="onImageCropped($event)">
  </CropImagePopup>
  }

  @if (showCreateEventPopup) {
  <create-event-popup #createEventPopup [style.display]="showLocationSelector ? 'none' : 'block'"
    (close)="showCreateEventPopup = false" (eventCreated)="closeAll()"
    (openLocationSelector)="createEventPopupRef = createEventPopup; openLocationSelector()">
  </create-event-popup>
  }

  @if (showLocationSelector) {
  <map-location-selector (locationSelected)="onLocationSelected($event)" (close)="showLocationSelector = false">
  </map-location-selector>
  }

  @if (selectedEvent) {
  <event-popup-card [event]="selectedEvent" [eventPosition]="eventScreenPosition || undefined"
    (close)="closeEventPopup()" (participate)="onParticipate($event)" (toggleFavorite)="onToggleFavorite()"
    [organizerName]="selectedEvent.organizerName || ''" [organizerImage]="selectedEvent.organizerImage"
    [currentUserId]="loggedUser ? (loggedUser.id ? loggedUser.id.toString() : null) : null"
    [creatorId]="selectedEvent.creatorId" (openOrganizerProfile)="openUserProfile($event)"
    (leave)="onLeaveEvent($event)" (deleteEvent)="onDeleteEvent($event)" (openChat)="openChat($event)" />
  }

  @if (showChatModal && chatEvent) {
  <event-chat-modal [event]="chatEvent" [currentUserId]="loggedUser?.id?.toString() || null"
    (close)="closeChat()">
  </event-chat-modal>
  }
</div>
