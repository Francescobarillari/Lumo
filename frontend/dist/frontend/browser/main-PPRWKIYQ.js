var rj=Object.create;var CT=Object.defineProperty,oj=Object.defineProperties,sj=Object.getOwnPropertyDescriptor,aj=Object.getOwnPropertyDescriptors,lj=Object.getOwnPropertyNames,gx=Object.getOwnPropertySymbols,cj=Object.getPrototypeOf,AT=Object.prototype.hasOwnProperty,QP=Object.prototype.propertyIsEnumerable;var JP=(s,c,l)=>c in s?CT(s,c,{enumerable:!0,configurable:!0,writable:!0,value:l}):s[c]=l,Bt=(s,c)=>{for(var l in c||={})AT.call(c,l)&&JP(s,l,c[l]);if(gx)for(var l of gx(c))QP.call(c,l)&&JP(s,l,c[l]);return s},di=(s,c)=>oj(s,aj(c));var _x=(s,c)=>{var l={};for(var f in s)AT.call(s,f)&&c.indexOf(f)<0&&(l[f]=s[f]);if(s!=null&&gx)for(var f of gx(s))c.indexOf(f)<0&&QP.call(s,f)&&(l[f]=s[f]);return l};var uj=(s,c)=>()=>(c||s((c={exports:{}}).exports,c),c.exports);var dj=(s,c,l,f)=>{if(c&&typeof c=="object"||typeof c=="function")for(let v of lj(c))!AT.call(s,v)&&v!==l&&CT(s,v,{get:()=>c[v],enumerable:!(f=sj(c,v))||f.enumerable});return s};var hj=(s,c,l)=>(l=s!=null?rj(cj(s)):{},dj(c||!s||!s.__esModule?CT(l,"default",{value:s,enumerable:!0}):l,s));var Xs=(s,c,l)=>new Promise((f,v)=>{var i=B=>{try{k(l.next(B))}catch(ee){v(ee)}},C=B=>{try{k(l.throw(B))}catch(ee){v(ee)}},k=B=>B.done?f(B.value):Promise.resolve(B.value).then(i,C);k((l=l.apply(s,c)).next())});var PN=uj((OC,LC)=>{"use strict";(function(s,c){typeof OC=="object"&&typeof LC<"u"?LC.exports=c():typeof define=="function"&&define.amd?define(c):(s=typeof globalThis<"u"?globalThis:s||self,s.mapboxgl=c())})(OC,function(){"use strict";var s,c,l;function f(i,C){if(!s)s=C;else if(!c)c=C;else{var k="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+s+")(sharedChunk); ("+c+")(sharedChunk); self.onerror = null;",B={};s(B),l=C(B),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(l.workerUrl=window.URL.createObjectURL(new Blob([k],{type:"text/javascript"})))}}f(["exports"],function(i){var C=1e-6,k=typeof Float32Array<"u"?Float32Array:Array;function B(r,e){var n=e[0],a=e[1],u=e[2],p=e[3],m=n*p-u*a;return m?(r[0]=p*(m=1/m),r[1]=-a*m,r[2]=-u*m,r[3]=n*m,r):null}function ee(){var r=new k(9);return k!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function _e(r,e){var n=e[0],a=e[1],u=e[2],p=e[3],m=e[4],_=e[5],b=e[6],w=e[7],I=e[8];return r[0]=m*I-_*w,r[1]=u*w-a*I,r[2]=a*_-u*m,r[3]=_*b-p*I,r[4]=n*I-u*b,r[5]=u*p-n*_,r[6]=p*w-m*b,r[7]=a*b-n*w,r[8]=n*m-a*p,r}function Oe(r,e,n){var a=e[0],u=e[1],p=e[2],m=e[3],_=e[4],b=e[5],w=e[6],I=e[7],S=e[8],D=n[0],P=n[1],O=n[2],N=n[3],V=n[4],U=n[5],W=n[6],X=n[7],K=n[8];return r[0]=D*a+P*m+O*w,r[1]=D*u+P*_+O*I,r[2]=D*p+P*b+O*S,r[3]=N*a+V*m+U*w,r[4]=N*u+V*_+U*I,r[5]=N*p+V*b+U*S,r[6]=W*a+X*m+K*w,r[7]=W*u+X*_+K*I,r[8]=W*p+X*b+K*S,r}function ct(){var r=new k(16);return k!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function Fe(r){var e=new k(16);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function yt(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Xt(r,e){var n=e[0],a=e[1],u=e[2],p=e[3],m=e[4],_=e[5],b=e[6],w=e[7],I=e[8],S=e[9],D=e[10],P=e[11],O=e[12],N=e[13],V=e[14],U=e[15],W=n*_-a*m,X=n*b-u*m,K=n*w-p*m,le=a*b-u*_,re=a*w-p*_,de=u*w-p*b,pe=I*N-S*O,ge=I*V-D*O,Le=I*U-P*O,Te=S*V-D*N,ke=S*U-P*N,je=D*U-P*V,$e=W*je-X*ke+K*Te+le*Le-re*ge+de*pe;return $e?(r[0]=(_*je-b*ke+w*Te)*($e=1/$e),r[1]=(u*ke-a*je-p*Te)*$e,r[2]=(N*de-V*re+U*le)*$e,r[3]=(D*re-S*de-P*le)*$e,r[4]=(b*Le-m*je-w*ge)*$e,r[5]=(n*je-u*Le+p*ge)*$e,r[6]=(V*K-O*de-U*X)*$e,r[7]=(I*de-D*K+P*X)*$e,r[8]=(m*ke-_*Le+w*pe)*$e,r[9]=(a*Le-n*ke-p*pe)*$e,r[10]=(O*re-N*K+U*W)*$e,r[11]=(S*K-I*re-P*W)*$e,r[12]=(_*ge-m*Te-b*pe)*$e,r[13]=(n*Te-a*ge+u*pe)*$e,r[14]=(N*X-O*le-V*W)*$e,r[15]=(I*le-S*X+D*W)*$e,r):null}function At(r,e,n){var a=e[0],u=e[1],p=e[2],m=e[3],_=e[4],b=e[5],w=e[6],I=e[7],S=e[8],D=e[9],P=e[10],O=e[11],N=e[12],V=e[13],U=e[14],W=e[15],X=n[0],K=n[1],le=n[2],re=n[3];return r[0]=X*a+K*_+le*S+re*N,r[1]=X*u+K*b+le*D+re*V,r[2]=X*p+K*w+le*P+re*U,r[3]=X*m+K*I+le*O+re*W,r[4]=(X=n[4])*a+(K=n[5])*_+(le=n[6])*S+(re=n[7])*N,r[5]=X*u+K*b+le*D+re*V,r[6]=X*p+K*w+le*P+re*U,r[7]=X*m+K*I+le*O+re*W,r[8]=(X=n[8])*a+(K=n[9])*_+(le=n[10])*S+(re=n[11])*N,r[9]=X*u+K*b+le*D+re*V,r[10]=X*p+K*w+le*P+re*U,r[11]=X*m+K*I+le*O+re*W,r[12]=(X=n[12])*a+(K=n[13])*_+(le=n[14])*S+(re=n[15])*N,r[13]=X*u+K*b+le*D+re*V,r[14]=X*p+K*w+le*P+re*U,r[15]=X*m+K*I+le*O+re*W,r}function Lt(r,e,n){var a,u,p,m,_,b,w,I,S,D,P,O,N=n[0],V=n[1],U=n[2];return e===r?(r[12]=e[0]*N+e[4]*V+e[8]*U+e[12],r[13]=e[1]*N+e[5]*V+e[9]*U+e[13],r[14]=e[2]*N+e[6]*V+e[10]*U+e[14],r[15]=e[3]*N+e[7]*V+e[11]*U+e[15]):(u=e[1],p=e[2],m=e[3],_=e[4],b=e[5],w=e[6],I=e[7],S=e[8],D=e[9],P=e[10],O=e[11],r[0]=a=e[0],r[1]=u,r[2]=p,r[3]=m,r[4]=_,r[5]=b,r[6]=w,r[7]=I,r[8]=S,r[9]=D,r[10]=P,r[11]=O,r[12]=a*N+_*V+S*U+e[12],r[13]=u*N+b*V+D*U+e[13],r[14]=p*N+w*V+P*U+e[14],r[15]=m*N+I*V+O*U+e[15]),r}function qn(r,e,n){var a=n[0],u=n[1],p=n[2];return r[0]=e[0]*a,r[1]=e[1]*a,r[2]=e[2]*a,r[3]=e[3]*a,r[4]=e[4]*u,r[5]=e[5]*u,r[6]=e[6]*u,r[7]=e[7]*u,r[8]=e[8]*p,r[9]=e[9]*p,r[10]=e[10]*p,r[11]=e[11]*p,r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function Sr(r,e,n){var a=Math.sin(n),u=Math.cos(n),p=e[4],m=e[5],_=e[6],b=e[7],w=e[8],I=e[9],S=e[10],D=e[11];return e!==r&&(r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[4]=p*u+w*a,r[5]=m*u+I*a,r[6]=_*u+S*a,r[7]=b*u+D*a,r[8]=w*u-p*a,r[9]=I*u-m*a,r[10]=S*u-_*a,r[11]=D*u-b*a,r}function Vi(r,e,n){var a=Math.sin(n),u=Math.cos(n),p=e[0],m=e[1],_=e[2],b=e[3],w=e[8],I=e[9],S=e[10],D=e[11];return e!==r&&(r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=p*u-w*a,r[1]=m*u-I*a,r[2]=_*u-S*a,r[3]=b*u-D*a,r[8]=p*a+w*u,r[9]=m*a+I*u,r[10]=_*a+S*u,r[11]=b*a+D*u,r}function jr(r,e,n){var a=Math.sin(n),u=Math.cos(n),p=e[0],m=e[1],_=e[2],b=e[3],w=e[4],I=e[5],S=e[6],D=e[7];return e!==r&&(r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15]),r[0]=p*u+w*a,r[1]=m*u+I*a,r[2]=_*u+S*a,r[3]=b*u+D*a,r[4]=w*u-p*a,r[5]=I*u-m*a,r[6]=S*u-_*a,r[7]=D*u-b*a,r}function lo(r,e){return r[0]=e[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Sa(r,e,n){var a,u,p,m=n[0],_=n[1],b=n[2],w=Math.sqrt(m*m+_*_+b*b);return w<C?null:(m*=w=1/w,_*=w,b*=w,a=Math.sin(e),u=Math.cos(e),r[0]=m*m*(p=1-u)+u,r[1]=_*m*p+b*a,r[2]=b*m*p-_*a,r[3]=0,r[4]=m*_*p-b*a,r[5]=_*_*p+u,r[6]=b*_*p+m*a,r[7]=0,r[8]=m*b*p+_*a,r[9]=_*b*p-m*a,r[10]=b*b*p+u,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function ud(r,e){var n=e[0],a=e[1],u=e[2],p=e[4],m=e[5],_=e[6],b=e[8],w=e[9],I=e[10];return r[0]=Math.sqrt(n*n+a*a+u*u),r[1]=Math.sqrt(p*p+m*m+_*_),r[2]=Math.sqrt(b*b+w*w+I*I),r}function dd(r,e){var n=e[0],a=e[1],u=e[2],p=e[3],m=n+n,_=a+a,b=u+u,w=n*m,I=a*m,S=a*_,D=u*m,P=u*_,O=u*b,N=p*m,V=p*_,U=p*b;return r[0]=1-S-O,r[1]=I+U,r[2]=D-V,r[3]=0,r[4]=I-U,r[5]=1-w-O,r[6]=P+N,r[7]=0,r[8]=D+V,r[9]=P-N,r[10]=1-w-S,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}var hd=At;function Un(){var r=new k(3);return k!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function sf(r){var e=new k(3);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e}function Qr(r){var e=r[0],n=r[1],a=r[2];return Math.sqrt(e*e+n*n+a*a)}function ji(r,e,n){var a=new k(3);return a[0]=r,a[1]=e,a[2]=n,a}function bi(r,e,n,a){return r[0]=e,r[1]=n,r[2]=a,r}function or(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r[2]=e[2]+n[2],r}function ra(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],r}function zs(r,e,n){return r[0]=e[0]*n[0],r[1]=e[1]*n[1],r[2]=e[2]*n[2],r}function oa(r,e,n){return r[0]=Math.min(e[0],n[0]),r[1]=Math.min(e[1],n[1]),r[2]=Math.min(e[2],n[2]),r}function ms(r,e,n){return r[0]=Math.max(e[0],n[0]),r[1]=Math.max(e[1],n[1]),r[2]=Math.max(e[2],n[2]),r}function Mi(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r}function Bs(r,e,n,a){return r[0]=e[0]+n[0]*a,r[1]=e[1]+n[1]*a,r[2]=e[2]+n[2]*a,r}function fd(r,e){var n=e[0]-r[0],a=e[1]-r[1],u=e[2]-r[2];return Math.sqrt(n*n+a*a+u*u)}function af(r,e){var n=e[0]-r[0],a=e[1]-r[1],u=e[2]-r[2];return n*n+a*a+u*u}function pd(r){var e=r[0],n=r[1],a=r[2];return e*e+n*n+a*a}function sa(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r}function li(r,e){var n=e[0],a=e[1],u=e[2],p=n*n+a*a+u*u;return p>0&&(p=1/Math.sqrt(p)),r[0]=e[0]*p,r[1]=e[1]*p,r[2]=e[2]*p,r}function sr(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]}function Or(r,e,n){var a=e[0],u=e[1],p=e[2],m=n[0],_=n[1],b=n[2];return r[0]=u*b-p*_,r[1]=p*m-a*b,r[2]=a*_-u*m,r}function Hc(r,e,n,a){var u=e[0],p=e[1],m=e[2];return r[0]=u+a*(n[0]-u),r[1]=p+a*(n[1]-p),r[2]=m+a*(n[2]-m),r}function ki(r,e,n){var a=e[0],u=e[1],p=e[2],m=n[3]*a+n[7]*u+n[11]*p+n[15];return r[0]=(n[0]*a+n[4]*u+n[8]*p+n[12])/(m=m||1),r[1]=(n[1]*a+n[5]*u+n[9]*p+n[13])/m,r[2]=(n[2]*a+n[6]*u+n[10]*p+n[14])/m,r}function al(r,e,n){var a=e[0],u=e[1],p=e[2];return r[0]=a*n[0]+u*n[3]+p*n[6],r[1]=a*n[1]+u*n[4]+p*n[7],r[2]=a*n[2]+u*n[5]+p*n[8],r}function Go(r,e,n){var a=n[0],u=n[1],p=n[2],m=n[3],_=e[0],b=e[1],w=e[2],I=u*w-p*b,S=p*_-a*w,D=a*b-u*_;return r[0]=_+m*(I+=I)+u*(D+=D)-p*(S+=S),r[1]=b+m*S+p*I-a*D,r[2]=w+m*D+a*S-u*I,r}function Vs(r){return r[0]=0,r[1]=0,r[2]=0,r}function aa(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]}var tr=ra,md=zs,Gl=Qr;function Po(){var r=new k(4);return k!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function ll(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r[2]=e[2]*n,r[3]=e[3]*n,r}function gd(r,e){var n=e[0],a=e[1],u=e[2],p=e[3],m=n*n+a*a+u*u+p*p;return m>0&&(m=1/Math.sqrt(m)),r[0]=n*m,r[1]=a*m,r[2]=u*m,r[3]=p*m,r}function co(r,e,n){var a=e[0],u=e[1],p=e[2],m=e[3];return r[0]=n[0]*a+n[4]*u+n[8]*p+n[12]*m,r[1]=n[1]*a+n[5]*u+n[9]*p+n[13]*m,r[2]=n[2]*a+n[6]*u+n[10]*p+n[14]*m,r[3]=n[3]*a+n[7]*u+n[11]*p+n[15]*m,r}function cl(){var r=new k(4);return k!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function la(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function Da(r,e,n){n*=.5;var a=e[0],u=e[1],p=e[2],m=e[3],_=Math.sin(n),b=Math.cos(n);return r[0]=a*b+m*_,r[1]=u*b+p*_,r[2]=p*b-u*_,r[3]=m*b-a*_,r}function ql(r,e,n){n*=.5;var a=e[0],u=e[1],p=e[2],m=e[3],_=Math.sin(n),b=Math.cos(n);return r[0]=a*b-p*_,r[1]=u*b+m*_,r[2]=p*b+a*_,r[3]=m*b-u*_,r}Un(),Po();var bo,Wl,ca,$c=gd,Gc=(bo=Un(),Wl=ji(1,0,0),ca=ji(0,1,0),function(r,e,n){var a=sr(e,n);return a<-.999999?(Or(bo,Wl,e),Gl(bo)<1e-6&&Or(bo,ca,e),li(bo,bo),(function(u,p,m){m*=.5;var _=Math.sin(m);u[0]=_*p[0],u[1]=_*p[1],u[2]=_*p[2],u[3]=Math.cos(m)})(r,bo,Math.PI),r):a>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Or(bo,e,n),r[0]=bo[0],r[1]=bo[1],r[2]=bo[2],r[3]=1+a,$c(r,r))});function dr(){var r=new k(2);return k!=Float32Array&&(r[0]=0,r[1]=0),r}function Zl(r,e){var n=new k(2);return n[0]=r,n[1]=e,n}function qc(r,e,n){return r[0]=e,r[1]=n,r}function Ca(r,e,n){return r[0]=e[0]+n[0],r[1]=e[1]+n[1],r}function js(r,e,n){return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r}function gs(r,e,n){return r[0]=e[0]*n,r[1]=e[1]*n,r}function Ri(r){var e=r[0],n=r[1];return Math.sqrt(e*e+n*n)}function Wr(r,e){var n=e[0],a=e[1],u=n*n+a*a;return u>0&&(u=1/Math.sqrt(u)),r[0]=e[0]*u,r[1]=e[1]*u,r}function Xl(r,e){return r[0]*e[0]+r[1]*e[1]}cl(),cl(),ee();var ul,qo,lf=js;function _d(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}dr();var $m=(function(){if(qo)return ul;function r(e,n,a,u){this.cx=3*e,this.bx=3*(a-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(u-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=n,this.p2x=a,this.p2y=u}return qo=1,ul=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,n){if(n===void 0&&(n=1e-6),e<0)return 0;if(e>1)return 1;for(var a=e,u=0;u<8;u++){var p=this.sampleCurveX(a)-e;if(Math.abs(p)<n)return a;var m=this.sampleCurveDerivativeX(a);if(Math.abs(m)<1e-6)break;a-=p/m}var _=0,b=1;for(a=e,u=0;u<20&&(p=this.sampleCurveX(a),!(Math.abs(p-e)<n));u++)e>p?_=a:b=a,a=.5*(b-_)+_;return a},solve:function(e,n){return this.sampleCurveY(this.solveCurveX(e,n))}},ul})(),Wc=_d($m);function Ze(r,e){this.x=r,this.y=e}function Aa(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!Aa(r[n],e[n]))return!1;return!0}if(typeof r=="object"&&r!==null&&e!==null){if(typeof e!="object"||Object.keys(r).length!==Object.keys(e).length)return!1;for(let n in r)if(!Aa(r[n],e[n]))return!1;return!0}return r===e}Ze.prototype={clone(){return new Ze(this.x,this.y)},add(r){return this.clone()._add(r)},sub(r){return this.clone()._sub(r)},multByPoint(r){return this.clone()._multByPoint(r)},divByPoint(r){return this.clone()._divByPoint(r)},mult(r){return this.clone()._mult(r)},div(r){return this.clone()._div(r)},rotate(r){return this.clone()._rotate(r)},rotateAround(r,e){return this.clone()._rotateAround(r,e)},matMult(r){return this.clone()._matMult(r)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(r){return this.x===r.x&&this.y===r.y},dist(r){return Math.sqrt(this.distSqr(r))},distSqr(r){let e=r.x-this.x,n=r.y-this.y;return e*e+n*n},angle(){return Math.atan2(this.y,this.x)},angleTo(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith(r){return this.angleWithSep(r.x,r.y)},angleWithSep(r,e){return Math.atan2(this.x*e-this.y*r,this.x*r+this.y*e)},_matMult(r){let e=r[2]*this.x+r[3]*this.y;return this.x=r[0]*this.x+r[1]*this.y,this.y=e,this},_add(r){return this.x+=r.x,this.y+=r.y,this},_sub(r){return this.x-=r.x,this.y-=r.y,this},_mult(r){return this.x*=r,this.y*=r,this},_div(r){return this.x/=r,this.y/=r,this},_multByPoint(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint(r){return this.x/=r.x,this.y/=r.y,this},_unit(){return this._div(this.mag()),this},_perp(){let r=this.y;return this.y=this.x,this.x=-r,this},_rotate(r){let e=Math.cos(r),n=Math.sin(r),a=n*this.x+e*this.y;return this.x=e*this.x-n*this.y,this.y=a,this},_rotateAround(r,e){let n=Math.cos(r),a=Math.sin(r),u=e.y+a*(this.x-e.x)+n*(this.y-e.y);return this.x=e.x+n*(this.x-e.x)-a*(this.y-e.y),this.y=u,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Ze},Ze.convert=function(r){if(r instanceof Ze)return r;if(Array.isArray(r))return new Ze(+r[0],+r[1]);if(r.x!==void 0&&r.y!==void 0)return new Ze(+r.x,+r.y);throw new Error("Expected [x, y] or {x, y} point format")};let yd=Math.PI/180,vd=180/Math.PI;function gn(r){return r*yd}function eo(r){return r*vd}let Gm=[[0,0],[1,0],[1,1],[0,1]];function xd(r){if(r<=0)return 0;if(r>=1)return 1;let e=r*r,n=e*r;return 4*(r<.5?n:3*(r-e)+n-.75)}function we(r,e,n,a){let u=new Wc(r,e,n,a);return function(p){return u.solve(p)}}let H=we(.25,.1,.25,1);function G(r,e,n){return Math.min(n,Math.max(e,r))}function ne(r,e,n){return(n=G((n-r)/(e-r),0,1))*n*(3-2*n)}function fe(r,e,n){let a=n-e,u=((r-e)%a+a)%a+e;return u===e?n:u}function he(r,e,n){if(!r.length)return n(null,[]);let a=r.length,u=new Array(r.length),p=null;r.forEach((m,_)=>{e(m,(b,w)=>{b&&(p=b),u[_]=w,--a==0&&n(p,u)})})}let ve=1;function Me(){return ve++}function xe(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log2(r)))}function Ce(r,e){r.forEach(n=>{e[n]&&(e[n]=e[n].bind(e))})}function et(r,e,n){let a={};for(let u in r)a[u]=e.call(this,r[u],u,r);return a}function We(r,e,n){let a={};for(let u in r)e.call(this,r[u],u,r)&&(a[u]=r[u]);return a}function St(r){return Array.isArray(r)?r.map(St):typeof r=="object"&&r?et(r,St):r}function Ht(r,e){for(let n=0;n<r.length;n++)if(e.indexOf(r[n])>=0)return!0;return!1}let Vt={};function Rt(r){Vt[r]||(typeof console<"u"&&console.warn(r),Vt[r]=!0)}function sn(r,e,n){return(n.y-r.y)*(e.x-r.x)>(e.y-r.y)*(n.x-r.x)}function dn(r){let e=0;for(let n,a,u=0,p=r.length,m=p-1;u<p;m=u++)n=r[u],a=r[m],e+=(a.x-n.x)*(n.y+a.y);return e}function Wn([r,e,n]){let a=gn(e+90),u=gn(n);return{x:r*Math.cos(a)*Math.sin(u),y:r*Math.sin(a)*Math.sin(u),z:r*Math.cos(u),azimuthal:e,polar:n}}function Ni(r){return(typeof self<"u"||r!==void 0)&&typeof WorkerGlobalScope<"u"&&(r!==void 0?r:self)instanceof WorkerGlobalScope}function ar(r){let e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(n,a,u,p)=>{let m=u||p;return e[a]=!m||m.toLowerCase(),""}),e["max-age"]){let n=parseInt(e["max-age"],10);isNaN(n)?delete e["max-age"]:e["max-age"]=n}return e}let Zi=null;function Hi(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function Hn(r,e,n,a){for(;e<n;){let u=e+n>>1;r[u]<a?e=u+1:n=u}return e}function _n(r,e,n,a){for(;e<n;){let u=e+n>>1;r[u]<=a?e=u+1:n=u}return e}function fi(r){return r>0?1/(1.001-r):1+r}function Pi(r){return r>0?1-1/(1.001-r):-r}function Yn(r,e,n){return(r-e.min)*(n.max-n.min)/(e.max-e.min)+n.min}let pi={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!pi.API_URL)return null;try{let r=new URL(pi.API_URL);return r.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":r.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.3.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function mr(r){return pi.API_URL_REGEX.test(r)}function to(r){return pi.API_SPRITE_REGEX.test(r)}let _s,Yl,vr,ys,uo,Us;function Oo(){return _s==null&&(_s=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),_s}let Lo={now:()=>ys!==void 0?ys:performance.now(),setNow(r){ys=r},restoreNow(){ys=void 0},frame(r){let e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){let{width:n,height:a}=r;uo||(uo=document.createElement("canvas"));let u=uo.getContext("2d",{willReadFrequently:!0});if(!u)throw new Error("failed to create canvas 2d context");return(n>uo.width||a>uo.height)&&(uo.width=n,uo.height=a),u.clearRect(-e,-e,n+2*e,a+2*e),u.drawImage(r,0,0,n,a),u.getImageData(-e,-e,n+2*e,a+2*e)},resolveURL:r=>(Yl||(Yl=document.createElement("a")),Yl.href=r,Yl.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(vr==null&&(vr=window.matchMedia("(prefers-reduced-motion: reduce)")),vr.matches)},hasCanvasFingerprintNoise(){if(Us!==void 0)return Us;if(!Oo())return Us=!1,!1;let r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0}),n=0;for(let u=0;u<r.width;++u)e.fillStyle=`rgba(${n++},${n++},${n++}, 255)`,e.fillRect(u,0,1,1);let a=e.getImageData(0,0,r.width,r.height);n=0;for(let u=0;u<a.data.length;++u)if(u%4!=3&&n++!==a.data[u])return Us=!0,!0;return Us=!1,!1}};function cf(r,e){let n=r.indexOf("?");if(n<0)return`${r}?${new URLSearchParams(e).toString()}`;let a=new URLSearchParams(r.slice(n));for(let u in e)a.set(u,e[u]);return`${r.slice(0,n)}?${a.toString()}`}function bd(r,e={persistentParams:[]}){let n=r.indexOf("?");if(n<0)return r;let a=new URLSearchParams,u=new URLSearchParams(r.slice(n));for(let m of e.persistentParams){let _=u.get(m);_&&a.set(m,_)}let p=a.toString();return`${r.slice(0,n)}${p.length>0?`?${p}`:""}`}let wd="mapbox-tiles",Ed=500,wo=50,Hs=["language","worldview","jobid"],ho,Wo;function Ma(){try{return caches}catch{}}function Kl(){let r=Ma();r&&ho==null&&(ho=r.open(wd))}let uf=1/0,df={supported:!1,testSupport:function(r){!qm&&dl&&(Ev?Wm(r):ua=r)}},ua,dl,qm=!1,Ev=!1,vs=typeof self<"u"?self:{};function Wm(r){let e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,dl),r.isContextLost())return;df.supported=!0}catch{}r.deleteTexture(e),qm=!0}vs.document&&(dl=vs.document.createElement("img"),dl.onload=function(){ua&&Wm(ua),ua=null,Ev=!0},dl.onerror=function(){qm=!0,ua=null},dl.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let Jl={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(Jl);class Ql extends Error{constructor(e,n,a){n===401&&mr(a)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=n,this.url=a}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}let Zm=Ni()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Td=function(r,e){if(!(/^file:/.test(n=r.url)||/^file:/.test(Zm())&&!/^\w+:/.test(n))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return(function(a,u){let p=new AbortController,m=new Request(a.url,{method:a.method||"GET",body:a.body,credentials:a.credentials,headers:a.headers,referrer:Zm(),referrerPolicy:a.referrerPolicy,signal:p.signal}),_=!1,b=!1,w=(I=m.url).indexOf("sku=")>0&&mr(I);var I;a.type==="json"&&m.headers.set("Accept","application/json");let S=(P,O,N)=>{if(b)return;if(P&&P.message!=="SecurityError"&&Rt(P.toString()),O&&N)return D(O);let V=Date.now();fetch(m).then(U=>{if(U.ok){let W=w?U.clone():null;return D(U,W,V)}return u(new Ql(U.statusText,U.status,a.url))}).catch(U=>{U.name!=="AbortError"&&u(new Error(`${U.message} ${a.url}`))})},D=(P,O,N)=>{(a.type==="arrayBuffer"?P.arrayBuffer():a.type==="json"?P.json():P.text()).then(V=>{b||(O&&N&&(function(U,W,X){if(Kl(),ho==null)return;let K=ar(W.headers.get("Cache-Control")||"");if(K["no-store"])return;let le={status:W.status,statusText:W.statusText,headers:new Headers};W.headers.forEach((pe,ge)=>le.headers.set(ge,pe)),K["max-age"]&&le.headers.set("Expires",new Date(X+1e3*K["max-age"]).toUTCString());let re=le.headers.get("Expires");if(!re||new Date(re).getTime()-X<42e4)return;let de=bd(U.url,{persistentParams:Hs});if(W.status===206){let pe=U.headers.get("Range");if(!pe)return;le.status=200,de=cf(de,{range:pe})}(function(pe,ge){if(Wo===void 0)try{new Response(new ReadableStream),Wo=!0}catch{Wo=!1}Wo?ge(pe.body):pe.blob().then(ge).catch(Le=>Rt(Le.message))})(W,pe=>{let ge=new Response((Le=W.status)!==200&&Le!==404&&[101,103,204,205,304].includes(Le)?null:pe,le);var Le;Kl(),ho?.then(Te=>Te.put(de,ge)).catch(Te=>Rt(Te.message))})})(m,O,N),_=!0,u(null,V,P.headers))}).catch(V=>{b||u(new Error(V.message))})};return w?(function(P,O){if(Kl(),ho==null)return O(null);ho.then(N=>{let V=bd(P.url,{persistentParams:Hs}),U=P.headers.get("Range");U&&(V=cf(V,{range:U})),N.match(V).then(W=>{let X=(function(K){if(!K)return!1;let le=new Date(K.headers.get("Expires")||0),re=ar(K.headers.get("Cache-Control")||"");return Number(le)>Date.now()&&!re["no-cache"]})(W);N.delete(V).catch(O),X&&N.put(V,W.clone()).catch(O),O(null,W,X)}).catch(O)}).catch(O)})(m,S):S(null,null),{cancel:()=>{b=!0,_||p.abort()}}})(r,e);if(Ni(self)&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var n;return(function(a,u){let p=new XMLHttpRequest;p.open(a.method||"GET",a.url,!0),a.type==="arrayBuffer"&&(p.responseType="arraybuffer");for(let m in a.headers)p.setRequestHeader(m,a.headers[m]);return a.type==="json"&&(p.responseType="text",p.setRequestHeader("Accept","application/json")),p.withCredentials=a.credentials==="include",p.onerror=()=>{u(new Error(p.statusText))},p.onload=()=>{if((p.status>=200&&p.status<300||p.status===0)&&p.response!==null){let m=p.response;if(a.type==="json")try{m=JSON.parse(p.response)}catch(b){return u(b)}let _=new Headers;p.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(b=>{let w=b.split(": "),I=w.shift(),S=w.join(": ");_.append(I,S)}),u(null,m,_)}else u(new Ql(p.statusText,p.status,a.url))},p.send(a.body),{cancel:()=>p.abort()}})(r,e)},Zc=function(r,e){return Td(Object.assign(r,{type:"arrayBuffer"}),e)};function Pn(r){let e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}let Xm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=",Id,Sd;Id=[],Sd=0;let Ym=function(r,e){if(df.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),Sd>=pi.MAX_PARALLEL_IMAGE_REQUESTS){let p={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Id.push(p),p}Sd++;let n=!1,a=()=>{if(!n)for(n=!0,Sd--;Id.length&&Sd<pi.MAX_PARALLEL_IMAGE_REQUESTS;){let p=Id.shift(),{requestParameters:m,callback:_,cancelled:b}=p;b||(p.cancel=Ym(m,_).cancel)}},u=Zc(r,(p,m,_)=>{a(),p?e(p):m&&(self.createImageBitmap?(function(b,w){let I=new Blob([new Uint8Array(b)],{type:"image/png"});createImageBitmap(I).then(S=>{w(null,S)}).catch(S=>{w(new Error(`Could not load image because of ${S.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})})(m,(b,w)=>e(b,w,_)):(function(b,w){let I=new Image;I.onload=()=>{w(null,I),URL.revokeObjectURL(I.src),I.onload=null,requestAnimationFrame(()=>{I.src=Xm})},I.onerror=()=>w(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let S=new Blob([new Uint8Array(b)],{type:"image/png"});I.src=b.byteLength?URL.createObjectURL(S):Xm})(m,(b,w)=>e(b,w,_)))});return{cancel:()=>{u.cancel(),a()}}};var Dd,Cd,Ad,ec={exports:{}},Tv={exports:{}},hf={exports:{}},I1=(function(){if(Ad)return ec.exports;Ad=1;var r=(Dd||(Dd=1,Tv.exports=function(n,a){var u,p,m,_,b,w,I,S;for(p=n.length-(u=3&n.length),m=a,b=3432918353,w=461845907,S=0;S<p;)I=255&n.charCodeAt(S)|(255&n.charCodeAt(++S))<<8|(255&n.charCodeAt(++S))<<16|(255&n.charCodeAt(++S))<<24,++S,m=27492+(65535&(_=5*(65535&(m=(m^=I=(65535&(I=(I=(65535&I)*b+(((I>>>16)*b&65535)<<16)&4294967295)<<15|I>>>17))*w+(((I>>>16)*w&65535)<<16)&4294967295)<<13|m>>>19))+((5*(m>>>16)&65535)<<16)&4294967295))+((58964+(_>>>16)&65535)<<16);switch(I=0,u){case 3:I^=(255&n.charCodeAt(S+2))<<16;case 2:I^=(255&n.charCodeAt(S+1))<<8;case 1:m^=I=(65535&(I=(I=(65535&(I^=255&n.charCodeAt(S)))*b+(((I>>>16)*b&65535)<<16)&4294967295)<<15|I>>>17))*w+(((I>>>16)*w&65535)<<16)&4294967295}return m^=n.length,m=2246822507*(65535&(m^=m>>>16))+((2246822507*(m>>>16)&65535)<<16)&4294967295,m=3266489909*(65535&(m^=m>>>13))+((3266489909*(m>>>16)&65535)<<16)&4294967295,(m^=m>>>16)>>>0}),Tv.exports),e=(Cd||(Cd=1,hf.exports=function(n,a){for(var u,p=n.length,m=a^p,_=0;p>=4;)u=1540483477*(65535&(u=255&n.charCodeAt(_)|(255&n.charCodeAt(++_))<<8|(255&n.charCodeAt(++_))<<16|(255&n.charCodeAt(++_))<<24))+((1540483477*(u>>>16)&65535)<<16),m=1540483477*(65535&m)+((1540483477*(m>>>16)&65535)<<16)^(u=1540483477*(65535&(u^=u>>>24))+((1540483477*(u>>>16)&65535)<<16)),p-=4,++_;switch(p){case 3:m^=(255&n.charCodeAt(_+2))<<16;case 2:m^=(255&n.charCodeAt(_+1))<<8;case 1:m=1540483477*(65535&(m^=255&n.charCodeAt(_)))+((1540483477*(m>>>16)&65535)<<16)}return m=1540483477*(65535&(m^=m>>>13))+((1540483477*(m>>>16)&65535)<<16),(m^=m>>>15)>>>0}),hf.exports);return ec.exports=r,ec.exports.murmur3=r,ec.exports.murmur2=e,ec.exports})(),Md=_d(I1);class Zo{constructor(e,...n){Object.assign(this,n[0]||{}),this.type=e}}class Rd extends Zo{constructor(e,n={}){super("error",Object.assign({error:e},n))}}function Xc(r,e,n){n[r]&&n[r].indexOf(e)!==-1||(n[r]=n[r]||[],n[r].push(e))}function Pd(r,e,n){if(n&&n[r]){let a=n[r].indexOf(e);a!==-1&&n[r].splice(a,1)}}class Ra{on(e,n){return this._listeners=this._listeners||{},Xc(e,n,this._listeners),this}off(e,n){return Pd(e,n,this._listeners),Pd(e,n,this._oneTimeListeners),this}once(e,n){return n?(this._oneTimeListeners=this._oneTimeListeners||{},Xc(e,n,this._oneTimeListeners),this):new Promise(a=>{this.once(e,a)})}fire(e,n){let a=typeof e=="string"?new Zo(e,n):e,u=a.type;if(this.listens(u)){a.target=this;let p=this._listeners&&this._listeners[u]?this._listeners[u].slice():[];for(let b of p)b.call(this,a);let m=this._oneTimeListeners&&this._oneTimeListeners[u]?this._oneTimeListeners[u].slice():[];for(let b of m)Pd(u,b,this._oneTimeListeners),b.call(this,a);let _=this._eventedParent;if(_){let b=typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData;Object.assign(a,b),_.fire(a)}}else a instanceof Rd&&console.error(a.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,n){return this._eventedParent=e,this._eventedParentData=n,this}}class gr{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new gr(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){let[n,a]=e.split("");return new gr({name:n,iconsetId:a})}static isEqual(e,n){return e.name===n.name&&e.iconsetId===n.iconsetId}toString(){return gr.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Km,Jm={},Qm=(function(){if(Km)return Jm;Km=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(p){return(p=Math.round(p))<0?0:p>255?255:p}function n(p){return e(p[p.length-1]==="%"?parseFloat(p)/100*255:parseInt(p))}function a(p){return(m=p[p.length-1]==="%"?parseFloat(p)/100:parseFloat(p))<0?0:m>1?1:m;var m}function u(p,m,_){return _<0?_+=1:_>1&&(_-=1),6*_<1?p+(m-p)*_*6:2*_<1?m:3*_<2?p+(m-p)*(2/3-_)*6:p}try{Jm.parseCSSColor=function(p){var m,_=p.replace(/ /g,"").toLowerCase();if(_ in r)return r[_].slice();if(_[0]==="#")return _.length===4?(m=parseInt(_.substr(1),16))>=0&&m<=4095?[(3840&m)>>4|(3840&m)>>8,240&m|(240&m)>>4,15&m|(15&m)<<4,1]:null:_.length===7&&(m=parseInt(_.substr(1),16))>=0&&m<=16777215?[(16711680&m)>>16,(65280&m)>>8,255&m,1]:null;var b=_.indexOf("("),w=_.indexOf(")");if(b!==-1&&w+1===_.length){var I=_.substr(0,b),S=_.substr(b+1,w-(b+1)).split(","),D=1;switch(I){case"rgba":if(S.length!==4)return null;D=a(S.pop());case"rgb":return S.length!==3?null:[n(S[0]),n(S[1]),n(S[2]),D];case"hsla":if(S.length!==4)return null;D=a(S.pop());case"hsl":if(S.length!==3)return null;var P=(parseFloat(S[0])%360+360)%360/360,O=a(S[1]),N=a(S[2]),V=N<=.5?N*(O+1):N+O-N*O,U=2*N-V;return[e(255*u(U,V,P+1/3)),e(255*u(U,V,P)),e(255*u(U,V,P-1/3)),D];default:return null}}return null}}catch{}return Jm})();class Nn{constructor(e,n,a,u=1){this.r=e,this.g=n,this.b=a,this.a=u}static parse(e){if(!e)return;if(e instanceof Nn)return e;if(typeof e!="string")return;let n=Qm.parseCSSColor(e);return n?new Nn(n[0]/255,n[1]/255,n[2]/255,n[3]):void 0}toString(){let[e,n,a,u]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*n)},${Math.round(255*a)},${u})`}toNonPremultipliedRenderColor(e){let{r:n,g:a,b:u,a:p}=this;return new Iv(e,n,a,u,p)}toPremultipliedRenderColor(e){let{r:n,g:a,b:u,a:p}=this;return new Sv(e,n*p,a*p,u*p,p)}clone(){return new Nn(this.r,this.g,this.b,this.a)}}class eg{constructor(e,n,a,u,p,m=!1){if(this.premultiplied=!1,this.premultiplied=m,e){let _=e.image.height,b=_*_;this.premultiplied?(n=p===0?0:n/p*(_-1),a=p===0?0:a/p*(_-1),u=p===0?0:u/p*(_-1)):(n*=_-1,a*=_-1,u*=_-1);let w=Math.floor(n),I=Math.floor(a),S=Math.floor(u),D=Math.ceil(n),P=Math.ceil(a),O=Math.ceil(u),N=n-w,V=a-I,U=u-S,W=e.image.data,X=4*(w+I*b+S*_),K=4*(w+I*b+O*_),le=4*(w+P*b+S*_),re=4*(w+P*b+O*_),de=4*(D+I*b+S*_),pe=4*(D+I*b+O*_),ge=4*(D+P*b+S*_),Le=4*(D+P*b+O*_);if(X<0||Le>=W.length)throw new Error("out of range");this.r=zt(zt(zt(W[X],W[K],U),zt(W[le],W[re],U),V),zt(zt(W[de],W[pe],U),zt(W[ge],W[Le],U),V),N)/255*(this.premultiplied?p:1),this.g=zt(zt(zt(W[X+1],W[K+1],U),zt(W[le+1],W[re+1],U),V),zt(zt(W[de+1],W[pe+1],U),zt(W[ge+1],W[Le+1],U),V),N)/255*(this.premultiplied?p:1),this.b=zt(zt(zt(W[X+2],W[K+2],U),zt(W[le+2],W[re+2],U),V),zt(zt(W[de+2],W[pe+2],U),zt(W[ge+2],W[Le+2],U),V),N)/255*(this.premultiplied?p:1),this.a=p}else this.r=n,this.g=a,this.b=u,this.a=p}toArray(){let{r:e,g:n,b:a,a:u}=this;return[255*e,255*n,255*a,u]}toHslaArray(){let{r:e,g:n,b:a,a:u}=this;if(this.premultiplied){if(u===0)return[0,0,0,0];let O=1/u;e*=O,n*=O,a*=O}let p=Math.min(Math.max(e,0),1),m=Math.min(Math.max(n,0),1),_=Math.min(Math.max(a,0),1),b=Math.min(p,m,_),w=Math.max(p,m,_),I=w-b,S=.5*(b+w);if(I===0)return[0,0,100*S,u];let D=S>.5?I/(2-w-b):I/(w+b),P;switch(w){case p:P=60*((m-_)/I+(m<_?6:0));break;case m:P=60*((_-p)/I+2);break;default:P=60*((p-m)/I+4)}return[P,100*D,100*S,u]}toArray01(){let{r:e,g:n,b:a,a:u}=this;return[e,n,a,u]}toArray01Scaled(e){let{r:n,g:a,b:u}=this;return[n*e,a*e,u*e]}toArray01Linear(){let{r:e,g:n,b:a,a:u}=this;return[Math.pow(e,2.2),Math.pow(n,2.2),Math.pow(a,2.2),u]}}class Iv extends eg{constructor(e,n,a,u,p){super(e,n,a,u,p,!1)}}class Sv extends eg{constructor(e,n,a,u,p){super(e,n,a,u,p,!0)}}function zt(r,e,n){return r*(1-n)+e*n}function Od(r,e,n){return r.map((a,u)=>zt(a,e[u],n))}Nn.black=new Nn(0,0,0,1),Nn.white=new Nn(1,1,1,1),Nn.transparent=new Nn(0,0,0,0),Nn.red=new Nn(1,0,0,1),Nn.blue=new Nn(0,0,1,1);var Pa=Object.freeze({__proto__:null,array:Od,color:function(r,e,n){return new Nn(zt(r.r,e.r,n),zt(r.g,e.g,n),zt(r.b,e.b,n),zt(r.a,e.a,n))},number:zt});class xs extends Error{constructor(e,n){super(n),this.message=n,this.key=e}}class bs{constructor(e,n=[]){this.parent=e,this.bindings={};for(let[a,u]of n)this.bindings[a]=u}concat(e){return new bs(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}let Yc={kind:"null"},Ct={kind:"number"},In={kind:"string"},Fn={kind:"boolean"},Fo={kind:"color"},Kc={kind:"object"},Vn={kind:"value"},Ld={kind:"collator"},tc={kind:"formatted"},Fd={kind:"resolvedImage"};function Lr(r,e){return{kind:"array",itemType:r,N:e}}function hr(r){if(r.kind==="array"){let e=hr(r.itemType);return typeof r.N=="number"?`array<${e}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${e}>`}return r.kind}let S1=[Yc,Ct,In,Fn,Fo,tc,Kc,Lr(Vn),Fd];function kd(r,e){if(e.kind==="error")return null;if(r.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!kd(r.itemType,e.itemType))&&(typeof r.N!="number"||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if(r.kind==="value"){for(let n of S1)if(!kd(n,e))return null}}return`Expected ${hr(r)} but found ${hr(e)} instead.`}function tg(r,e){return e.some(n=>n.kind===r.kind)}function Nd(r,e){return e.some(n=>n==="null"?r===null:n==="array"?Array.isArray(r):n==="object"?r&&!Array.isArray(r)&&typeof r=="object":n===typeof r)}function ff(r,e){return r.kind==="array"&&e.kind==="array"?r.N===e.N&&ff(r.itemType,e.itemType):r.kind===e.kind}class ng{constructor(e,n,a){this.sensitivity=e?n?"variant":"case":n?"accent":"base",this.locale=a,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,n){return this.collator.compare(e,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class zd{constructor(e,n,a,u,p){this.text=e.normalize?e.normalize():e,this.image=n,this.scale=a,this.fontStack=u,this.textColor=p}}class Dr{constructor(e){this.sections=e}static fromString(e){return new Dr([new zd(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||!!e.image&&e.image.hasPrimary())}static factory(e){return e instanceof Dr?e:Dr.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){let e=["format"];for(let n of this.sections){if(n.image){let u=n.image.getPrimary().id.toString();e.push(["image",u]);continue}e.push(n.text);let a={};n.fontStack&&(a["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(a["font-scale"]=n.scale),n.textColor&&(a["text-color"]=["rgba"].concat(n.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(a)}return e}}class Oa{constructor(e,n={}){if(this.id=gr.from(e),this.options=Object.assign({},n),n.transform){let{a,b:u,c:p,d:m,e:_,f:b}=n.transform;this.options.transform=new DOMMatrix([a,u,p,m,_,b])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:e,b:n,c:a,d:u,e:p,f:m}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:n,c:a,d:u,e:p,f:m}})}static parse(e){let n,a,u,p;try{({name:n,iconsetId:a,params:u,transform:p}=JSON.parse(e)||{})}catch{return null}if(!n)return null;let{a:m,b:_,c:b,d:w,e:I,f:S}=p||{};return new Oa({name:n,iconsetId:a},{params:u,transform:new DOMMatrix([m,_,b,w,I,S])})}scaleSelf(e,n){return this.options.transform.scaleSelf(e,n),this}}class Eo{constructor(e,n,a,u,p=!1){this.primaryId=gr.from(e),this.primaryOptions=n,a&&(this.secondaryId=gr.from(a)),this.secondaryOptions=u,this.available=p}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new Oa(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new Oa(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Eo.build({name:e}):e}static build(e,n,a,u){return!e||typeof e=="object"&&!("name"in e)?null:new Eo(e,a,n,u)}}function pf(r,e,n,a){return typeof r=="number"&&r>=0&&r<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof n=="number"&&n>=0&&n<=255?a===void 0||typeof a=="number"&&a>=0&&a<=1?null:`Invalid rgba value [${[r,e,n,a].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof a=="number"?[r,e,n,a]:[r,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Jc(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Nn||r instanceof ng||r instanceof Dr||r instanceof Eo)return!0;if(Array.isArray(r)){for(let e of r)if(!Jc(e))return!1;return!0}if(typeof r=="object"){for(let e in r)if(!Jc(r[e]))return!1;return!0}return!1}function xr(r){if(r===null)return Yc;if(typeof r=="string")return In;if(typeof r=="boolean")return Fn;if(typeof r=="number")return Ct;if(r instanceof Nn)return Fo;if(r instanceof ng)return Ld;if(r instanceof Dr)return tc;if(r instanceof Eo)return Fd;if(Array.isArray(r)){let e=r.length,n;for(let a of r){let u=xr(a);if(n){if(n===u)continue;n=Vn;break}n=u}return Lr(n||Vn,e)}return Kc}function da(r){let e=typeof r;return r===null?"":e==="string"||e==="number"||e==="boolean"?String(r):r instanceof Dr||r instanceof Eo||r instanceof Nn?r.toString():JSON.stringify(r)}class La{constructor(e,n){this.type=e,this.value=n}static parse(e,n){if(e.length!==2)return n.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Jc(e[1]))return n.error("invalid value");let a=e[1],u=xr(a),p=n.expectedType;return u.kind!=="array"||u.N!==0||!p||p.kind!=="array"||typeof p.N=="number"&&p.N!==0||(u=p),new La(u,a)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Nn?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Dr?this.value.serialize():this.value}}class Xi{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}let rn={string:In,number:Ct,boolean:Fn,object:Kc};class Tt{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let a,u=1,p=e[0];if(p==="array"){let _,b;if(e.length>2){let w=e[1];if(typeof w!="string"||!(w in rn)||w==="object")return n.error('The item type argument of "array" must be one of string, number, boolean',1);_=rn[w],u++}else _=Vn;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return n.error('The length argument to "array" must be a positive integer literal',2);b=e[2],u++}a=Lr(_,b)}else a=rn[p];let m=[];for(;u<e.length;u++){let _=n.parse(e[u],u,Vn);if(!_)return null;m.push(_)}return new Tt(a,m)}evaluate(e){for(let n=0;n<this.args.length;n++){let a=this.args[n].evaluate(e);if(!kd(this.type,xr(a)))return a;if(n===this.args.length-1)throw new Xi(`The expression ${JSON.stringify(this.args[n].serialize())} evaluated to ${hr(xr(a))} but was expected to be of type ${hr(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=this.type,n=[e.kind];if(e.kind==="array"){let a=e.itemType;if(a.kind==="string"||a.kind==="number"||a.kind==="boolean"){n.push(a.kind);let u=e.N;(typeof u=="number"||this.args.length>1)&&n.push(u)}}return n.concat(this.args.map(a=>a.serialize()))}}class nc{constructor(e){this.type=tc,this.sections=e}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let a=e[1];if(!Array.isArray(a)&&typeof a=="object")return n.error("First argument must be an image or text section.");let u=[],p=!1;for(let m=1;m<=e.length-1;++m){let _=e[m];if(p&&typeof _=="object"&&!Array.isArray(_)){p=!1;let b=null;if(_["font-scale"]&&(b=n.parseObjectValue(_["font-scale"],m,"font-scale",Ct),!b))return null;let w=null;if(_["text-font"]&&(w=n.parseObjectValue(_["text-font"],m,"text-font",Lr(In)),!w))return null;let I=null;if(_["text-color"]&&(I=n.parseObjectValue(_["text-color"],m,"text-color",Fo),!I))return null;let S=u[u.length-1];S.scale=b,S.font=w,S.textColor=I}else{let b=n.parse(e[m],m,Vn);if(!b)return null;let w=b.type.kind;if(w!=="string"&&w!=="value"&&w!=="null"&&w!=="resolvedImage")return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");p=!0,u.push({content:b,scale:null,font:null,textColor:null})}}return new nc(u)}evaluate(e){return new Dr(this.sections.map(n=>{let a=n.content.evaluate(e);return ff(xr(a),Fd)?new zd("",a,null,null,null):new zd(da(a),null,n.scale?n.scale.evaluate(e):null,n.font?n.font.evaluate(e).join(","):null,n.textColor?n.textColor.evaluate(e):null)}))}eachChild(e){for(let n of this.sections)e(n.content),n.scale&&e(n.scale),n.font&&e(n.font),n.textColor&&e(n.textColor)}outputDefined(){return!1}serialize(){let e=["format"];for(let n of this.sections){e.push(n.content.serialize());let a={};n.scale&&(a["font-scale"]=n.scale.serialize()),n.font&&(a["text-font"]=n.font.serialize()),n.textColor&&(a["text-color"]=n.textColor.serialize()),e.push(a)}return e}}class qt{constructor(e,n,a,u){this._imageWarnHistory={},this.type=Fd,this.namePrimary=e,this.nameSecondary=n,a&&(this.paramsPrimary=a.params,this.iconsetIdPrimary=a.iconset?a.iconset.id:void 0),u&&(this.paramsSecondary=u.params,this.iconsetIdSecondary=u.iconset?u.iconset.id:void 0)}static parse(e,n){if(e.length<2)return n.error("Expected two or more arguments.");let a=1,u=[];function p(){if(a<e.length){let _=n.parse(e[a],a++,In);return _?(u.push({image:_,options:{}}),!0):(n.error(u.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function m(){if(a<e.length){let b=e[a];if((_=b)===null||typeof _!="object"||Array.isArray(_))return!0;let w=b.params,I=b.iconset,S=n.concat(a);if(!w&&!I)return a++,!0;if(w){if(typeof w!="object"||w.constructor!==Object)return S.error('Image options "params" should be an object'),!1;let D={},P=S.concat(void 0,"params");for(let O in w){if(!O)return P.error("Image parameter name should be non-empty"),!1;let N=P.concat(void 0,O).parse(w[O],void 0,Fo,void 0,{typeAnnotation:"coerce"});if(!N)return!1;D[O]=N}u[u.length-1].options.params=D}if(I){if(typeof I!="object"||I.constructor!==Object)return S.error('Image options "iconset" should be an object'),!1;if(!I.id)return S.error('Image options "iconset" should have an "id" property'),!1;u[u.length-1].options.iconset=I}return a++,!0}var _;return!0}for(let _=0;_<2;_++)if(!p()||!m())return;return new qt(u[0].image,u[1]?u[1].image:void 0,u[0].options,u[1]?u[1].options:void 0)}evaluateParams(e,n){let a={};if(n){for(let u in n)if(n[u])try{a[u]=n[u].evaluate(e)}catch{continue}if(Object.keys(a).length!==0)return{params:a}}}evaluate(e){let n={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},a=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,u=Eo.build(n,a,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(u&&e.availableImages){let p=u.getPrimary().id;if(u.available=e.availableImages.some(m=>gr.isEqual(m,p)),u.available){let m=u.getSecondary()?u.getSecondary().id:null;m&&(u.available=e.availableImages.some(_=>gr.isEqual(_,m)))}}return u}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(let n in this.paramsPrimary)this.paramsPrimary[n]&&e(this.paramsPrimary[n]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(let n in this.paramsSecondary)this.paramsSecondary[n]&&e(this.paramsSecondary[n])}outputDefined(){return!1}serializeOptions(e,n){let a={};if(n&&(a.iconset={id:n}),e){a.params={};for(let u in e)e[u]&&(a.params[u]=e[u].serialize())}return Object.keys(a).length>0?a:void 0}serialize(){let e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let n=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);n&&e.push(n)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let n=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);n&&e.push(n)}return e}}function Qc(r){return jt(r)?"string":Bd(r)?"number":gf(r)?"boolean":Array.isArray(r)?"array":r===null?"null":mf(r)?"object":typeof r}function mf(r){return r!=null&&!Array.isArray(r)&&typeof r!="function"&&!(r instanceof String||r instanceof Number||r instanceof Boolean)&&typeof r=="object"}function jt(r){return typeof r=="string"||r instanceof String}function Bd(r){return typeof r=="number"||r instanceof Number}function gf(r){return typeof r=="boolean"||r instanceof Boolean}let Dv={"to-boolean":Fn,"to-color":Fo,"to-number":Ct,"to-string":In};class ha{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expected at least one argument.");let a=e[0],u=[],p=Yc;if(a==="to-array"){if(!Array.isArray(e[1]))return null;let m=e[1].length;if(n.expectedType){if(n.expectedType.kind!=="array")return n.error(`Expected ${n.expectedType.kind} but found array.`);p=Lr(n.expectedType.itemType,m)}else{if(!(m>0&&Jc(e[1][0])))return null;p=Lr(xr(e[1][0]),m)}for(let _=0;_<m;_++){let b=e[1][_],w;if(Array.isArray(b))w=n.parse(b,void 0,p.itemType);else{let I=Qc(b);if(I!==p.itemType.kind)return n.error(`Expected ${p.itemType.kind} but found ${I}.`);w=n.registry.literal.parse(["literal",b===void 0?null:b],n)}if(!w)return null;u.push(w)}}else{if((a==="to-boolean"||a==="to-string")&&e.length!==2)return n.error("Expected one argument.");p=Dv[a];for(let m=1;m<e.length;m++){let _=n.parse(e[m],m,Vn);if(!_)return null;u.push(_)}}return new ha(p,u)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let n,a;for(let u of this.args){if(n=u.evaluate(e),a=null,n instanceof Nn)return n;if(typeof n=="string"){let p=e.parseColor(n);if(p)return p}else if(Array.isArray(n)&&(a=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:pf(n[0],n[1],n[2],n[3]),!a))return new Nn(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Xi(a||`Could not parse color from value '${typeof n=="string"?n:String(JSON.stringify(n))}'`)}if(this.type.kind==="number"){let n=null;for(let a of this.args){if(n=a.evaluate(e),n===null)return 0;let u=Number(n);if(!isNaN(u))return u}throw new Xi(`Could not convert ${JSON.stringify(n)} to number.`)}return this.type.kind==="formatted"?Dr.fromString(da(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Eo.build(da(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(n=>n.evaluate(e)):da(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new nc([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new qt(this.args[0]).serialize();let e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(n=>{e.push(n.serialize())}),e}}let _f=["Unknown","Point","LineString","Polygon"];class Fr{constructor(e,n,a){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=n,this.iconImageUseTheme=a}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?_f[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let e=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:a,y:u}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(a*n-e[0])+this.featureDistanceData.bearing[1]*(u*n-e[1])}return 0}parseColor(e){let n=this._parseColorCache[e];return n||(n=this._parseColorCache[e]=Nn.parse(e)),n}getConfig(e){return this.options?this.options.get(e):null}}class no{constructor(e,n,a,u,p){this.name=e,this.type=n,this._evaluate=a,this.args=u,this._overloadIndex=p}evaluate(e){if(!this._evaluate){let n=no.definitions[this.name];this._evaluate=Array.isArray(n)?n[2]:n.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,n){let a=e[0],u=no.definitions[a];if(!u)return n.error(`Unknown expression "${a}". If you wanted a literal array, use ["literal", [...]].`,0);let p=Array.isArray(u)?u[0]:u.type,m=Array.isArray(u)?[[u[1],u[2]]]:u.overloads,_=[],b=null,w=-1;for(let[I,S]of m){if(Array.isArray(I)&&I.length!==e.length-1)continue;_.push(I),w++,b=new Df(n.registry,n.path,null,n.scope,void 0,n._scope,n.options,n.iconImageUseTheme);let D=[],P=!1;for(let O=1;O<e.length;O++){let N=e[O],V=Array.isArray(I)?I[O-1]:I.type,U=b.parse(N,1+D.length,V);if(!U){P=!0;break}D.push(U)}if(!P)if(Array.isArray(I)&&I.length!==D.length)b.error(`Expected ${I.length} arguments, but found ${D.length} instead.`);else{for(let O=0;O<D.length;O++){let N=Array.isArray(I)?I[O]:I.type,V=D[O];b.concat(O+1).checkSubtype(N,V.type)}if(b.errors.length===0)return new no(a,p,S,D,w)}}if(_.length===1)n.errors.push(...b.errors);else{let I=(_.length?_:m.map(([D])=>D)).map(ic).join(" | "),S=[];for(let D=1;D<e.length;D++){let P=n.parse(e[D],1+S.length);if(!P)return null;S.push(hr(P.type))}n.error(`Expected arguments of type ${I}, but found (${S.join(", ")}) instead.`)}return null}static register(e,n){no.definitions=n;for(let a in n)e[a]=no}}function ic(r){return Array.isArray(r)?`(${r.map(hr).join(", ")})`:`(${hr(r.type)}...)`}class eu{constructor(e,n,a){this.type=Ld,this.locale=a,this.caseSensitive=e,this.diacriticSensitive=n}static parse(e,n){if(e.length!==2)return n.error("Expected one argument.");let a=e[1];if(typeof a!="object"||Array.isArray(a))return n.error("Collator options argument must be an object.");let u=a["case-sensitive"]===void 0?n.parse(!1,1,Fn):n.parseObjectValue(a["case-sensitive"],1,"case-sensitive",Fn);if(!u)return null;let p=a["diacritic-sensitive"]===void 0?n.parse(!1,1,Fn):n.parseObjectValue(a["diacritic-sensitive"],1,"diacritic-sensitive",Fn);if(!p)return null;let m=null;return a.locale&&(m=n.parseObjectValue(a.locale,1,"locale",In),!m)?null:new eu(u,p,m)}evaluate(e){return new ng(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){let e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Fa(r,e,n=0,a=r.length-1,u=D1){for(;a>n;){if(a-n>600){let b=a-n+1,w=e-n+1,I=Math.log(b),S=.5*Math.exp(2*I/3),D=.5*Math.sqrt(I*S*(b-S)/b)*(w-b/2<0?-1:1);Fa(r,e,Math.max(n,Math.floor(e-w*S/b+D)),Math.min(a,Math.floor(e+(b-w)*S/b+D)),u)}let p=r[e],m=n,_=a;for(kr(r,n,e),u(r[a],p)>0&&kr(r,n,a);m<_;){for(kr(r,m,_),m++,_--;u(r[m],p)<0;)m++;for(;u(r[_],p)>0;)_--}u(r[n],p)===0?kr(r,n,_):(_++,kr(r,_,a)),_<=e&&(n=_+1),e<=_&&(a=_-1)}}function kr(r,e,n){let a=r[e];r[e]=r[n],r[n]=a}function D1(r,e){return r<e?-1:r>e?1:0}function C1(r){let e=0;for(let n,a,u=0,p=r.length,m=p-1;u<p;m=u++)n=r[u],a=r[m],e+=(a.x-n.x)*(n.y+a.y);return e}function Vd(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function hl(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Cv(r,e,n){let a=r[0]-e[0],u=r[1]-e[1],p=r[0]-n[0],m=r[1]-n[1];return a*m-p*u==0&&a*p<=0&&u*m<=0}function ws(r,e,n=!1){let a=!1;for(let _=0,b=e.length;_<b;_++){let w=e[_];for(let I=0,S=w.length,D=S-1;I<S;D=I++){let P=w[D],O=w[I];if(Cv(r,P,O))return n;(p=P)[1]>(u=r)[1]!=(m=O)[1]>u[1]&&u[0]<(m[0]-p[0])*(u[1]-p[1])/(m[1]-p[1])+p[0]&&(a=!a)}}var u,p,m;return a}function Av(r,e,n,a){let u=a[0]-n[0],p=a[1]-n[1],m=(r[0]-n[0])*p-u*(r[1]-n[1]),_=(e[0]-n[0])*p-u*(e[1]-n[1]);return m>0&&_<0||m<0&&_>0}function yf(r,e,n,a){return(u=[a[0]-n[0],a[1]-n[1]])[0]*(p=[e[0]-r[0],e[1]-r[1]])[1]-u[1]*p[0]!=0&&!(!Av(r,e,n,a)||!Av(n,a,r,e));var u,p}function jd(r){let e=new Ze(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),n=new Ze(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let a of r[0])e.x>a.x&&(e.x=a.x),e.y>a.y&&(e.y=a.y),n.x<a.x&&(n.x=a.x),n.y<a.y&&(n.y=a.y);return{min:e,max:n}}let fl=8192;function A1(r,e){let n=(180+r[0])/360,a=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,u=Math.pow(2,e.z);return[Math.round(n*u*fl),Math.round(a*u*fl)]}function Mv(r,e){for(let n=0;n<e.length;n++)if(ws(r,e[n]))return!0;return!1}function M1(r,e,n){for(let a of n)for(let u=0,p=a.length,m=p-1;u<p;m=u++)if(yf(r,e,a[m],a[u]))return!0;return!1}function pl(r,e){for(let n=0;n<r.length;++n)if(!ws(r[n],e))return!1;for(let n=0;n<r.length-1;++n)if(M1(r[n],r[n+1],e))return!1;return!0}function R1(r,e){for(let n=0;n<e.length;n++)if(pl(r,e[n]))return!0;return!1}function ig(r,e,n){let a=[];for(let u=0;u<r.length;u++){let p=[];for(let m=0;m<r[u].length;m++){let _=A1(r[u][m],n);Vd(e,_),p.push(_)}a.push(p)}return a}function vf(r,e,n){let a=[];for(let u=0;u<r.length;u++){let p=ig(r[u],e,n);a.push(p)}return a}function rg(r,e,n,a){if(r[0]<n[0]||r[0]>n[2]){let u=.5*a,p=r[0]-n[0]>u?-a:n[0]-r[0]>u?a:0;p===0&&(p=r[0]-n[2]>u?-a:n[2]-r[0]>u?a:0),r[0]+=p}Vd(e,r)}function og(r,e,n,a){let u=Math.pow(2,a.z)*fl,p=[a.x*fl,a.y*fl],m=[];if(!r)return m;for(let _ of r)for(let b of _){let w=[b.x+p[0],b.y+p[1]];rg(w,e,n,u),m.push(w)}return m}function Es(r,e,n,a){let u=Math.pow(2,a.z)*fl,p=[a.x*fl,a.y*fl],m=[];if(!r)return m;for(let b of r){let w=[];for(let I of b){let S=[I.x+p[0],I.y+p[1]];Vd(e,S),w.push(S)}m.push(w)}if(e[2]-e[0]<=u/2){(_=e)[0]=_[1]=1/0,_[2]=_[3]=-1/0;for(let b of m)for(let w of b)rg(w,e,n,u)}var _;return m}class rc{constructor(e,n){this.type=Fn,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Jc(e[1])){let a=e[1];if(a.type==="FeatureCollection")for(let u=0;u<a.features.length;++u){let p=a.features[u].geometry.type;if(p==="Polygon"||p==="MultiPolygon")return new rc(a,a.features[u].geometry)}else if(a.type==="Feature"){let u=a.geometry.type;if(u==="Polygon"||u==="MultiPolygon")return new rc(a,a.geometry)}else if(a.type==="Polygon"||a.type==="MultiPolygon")return new rc(a,a)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(n,a){let u=[1/0,1/0,-1/0,-1/0],p=[1/0,1/0,-1/0,-1/0],m=n.canonicalID();if(!m)return!1;if(a.type==="Polygon"){let _=ig(a.coordinates,p,m),b=og(n.geometry(),u,p,m);if(!hl(u,p))return!1;for(let w of b)if(!ws(w,_))return!1}if(a.type==="MultiPolygon"){let _=vf(a.coordinates,p,m),b=og(n.geometry(),u,p,m);if(!hl(u,p))return!1;for(let w of b)if(!Mv(w,_))return!1}return!0})(e,this.geometries);if(e.geometryType()==="LineString")return(function(n,a){let u=[1/0,1/0,-1/0,-1/0],p=[1/0,1/0,-1/0,-1/0],m=n.canonicalID();if(!m)return!1;if(a.type==="Polygon"){let _=ig(a.coordinates,p,m),b=Es(n.geometry(),u,p,m);if(!hl(u,p))return!1;for(let w of b)if(!pl(w,_))return!1}if(a.type==="MultiPolygon"){let _=vf(a.coordinates,p,m),b=Es(n.geometry(),u,p,m);if(!hl(u,p))return!1;for(let w of b)if(!R1(w,_))return!1}return!0})(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}let Ud={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},sg=1/298.257223563,ag=sg*(2-sg),tu=Math.PI/180;class nu{static fromTile(e,n,a){let u=Math.PI*(1-2*(e+.5)/Math.pow(2,n)),p=Math.atan(.5*(Math.exp(u)-Math.exp(-u)))/tu;return new nu(p,a)}static get units(){return Ud}constructor(e,n){if(e===void 0)throw new Error("No latitude given.");if(n&&!Ud[n])throw new Error(`Unknown unit ${n}. Use one of: ${Object.keys(Ud).join(", ")}`);let a=6378.137*tu*(n?Ud[n]:1),u=Math.cos(e*tu),p=1/(1-ag*(1-u*u)),m=Math.sqrt(p);this.kx=a*m*u,this.ky=a*m*p*(1-ag)}distance(e,n){let a=Xo(e[0]-n[0])*this.kx,u=(e[1]-n[1])*this.ky;return Math.sqrt(a*a+u*u)}bearing(e,n){let a=Xo(n[0]-e[0])*this.kx;return Math.atan2(a,(n[1]-e[1])*this.ky)/tu}destination(e,n,a){let u=a*tu;return this.offset(e,Math.sin(u)*n,Math.cos(u)*n)}offset(e,n,a){return[e[0]+n/this.kx,e[1]+a/this.ky]}lineDistance(e){let n=0;for(let a=0;a<e.length-1;a++)n+=this.distance(e[a],e[a+1]);return n}area(e){let n=0;for(let a=0;a<e.length;a++){let u=e[a];for(let p=0,m=u.length,_=m-1;p<m;_=p++)n+=Xo(u[p][0]-u[_][0])*(u[p][1]+u[_][1])*(a?-1:1)}return Math.abs(n)/2*this.kx*this.ky}along(e,n){let a=0;if(n<=0)return e[0];for(let u=0;u<e.length-1;u++){let p=e[u],m=e[u+1],_=this.distance(p,m);if(a+=_,a>n)return xf(p,m,(n-(a-_))/_)}return e[e.length-1]}pointToSegmentDistance(e,n,a){let[u,p]=n,m=Xo(a[0]-u)*this.kx,_=(a[1]-p)*this.ky;if(m!==0||_!==0){let b=(Xo(e[0]-u)*this.kx*m+(e[1]-p)*this.ky*_)/(m*m+_*_);b>1?(u=a[0],p=a[1]):b>0&&(u+=m/this.kx*b,p+=_/this.ky*b)}return m=Xo(e[0]-u)*this.kx,_=(e[1]-p)*this.ky,Math.sqrt(m*m+_*_)}pointOnLine(e,n){let a=1/0,u=e[0][0],p=e[0][1],m=0,_=0;for(let b=0;b<e.length-1;b++){let w=e[b][0],I=e[b][1],S=Xo(e[b+1][0]-w)*this.kx,D=(e[b+1][1]-I)*this.ky,P=0;S===0&&D===0||(P=(Xo(n[0]-w)*this.kx*S+(n[1]-I)*this.ky*D)/(S*S+D*D),P>1?(w=e[b+1][0],I=e[b+1][1]):P>0&&(w+=S/this.kx*P,I+=D/this.ky*P)),S=Xo(n[0]-w)*this.kx,D=(n[1]-I)*this.ky;let O=S*S+D*D;O<a&&(a=O,u=w,p=I,m=b,_=P)}return{point:[u,p],index:m,t:Math.max(0,Math.min(1,_))}}lineSlice(e,n,a){let u=this.pointOnLine(a,e),p=this.pointOnLine(a,n);if(u.index>p.index||u.index===p.index&&u.t>p.t){let w=u;u=p,p=w}let m=[u.point],_=u.index+1,b=p.index;!lg(a[_],m[0])&&_<=b&&m.push(a[_]);for(let w=_+1;w<=b;w++)m.push(a[w]);return lg(a[b],p.point)||m.push(p.point),m}lineSliceAlong(e,n,a){let u=0,p=[];for(let m=0;m<a.length-1;m++){let _=a[m],b=a[m+1],w=this.distance(_,b);if(u+=w,u>e&&p.length===0&&p.push(xf(_,b,(e-(u-w))/w)),u>=n)return p.push(xf(_,b,(n-(u-w))/w)),p;u>e&&p.push(b)}return p}bufferPoint(e,n){let a=n/this.ky,u=n/this.kx;return[e[0]-u,e[1]-a,e[0]+u,e[1]+a]}bufferBBox(e,n){let a=n/this.ky,u=n/this.kx;return[e[0]-u,e[1]-a,e[2]+u,e[3]+a]}insideBBox(e,n){return Xo(e[0]-n[0])>=0&&Xo(e[0]-n[2])<=0&&e[1]>=n[1]&&e[1]<=n[3]}}function lg(r,e){return r[0]===e[0]&&r[1]===e[1]}function xf(r,e,n){let a=Xo(e[0]-r[0]);return[r[0]+a*n,r[1]+(e[1]-r[1])*n]}function Xo(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class bf{constructor(e=[],n=(a,u)=>a<u?-1:a>u?1:0){if(this.data=e,this.length=this.data.length,this.compare=n,this.length>0)for(let a=(this.length>>1)-1;a>=0;a--)this._down(a)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;let e=this.data[0],n=this.data.pop();return--this.length>0&&(this.data[0]=n,this._down(0)),e}peek(){return this.data[0]}_up(e){let{data:n,compare:a}=this,u=n[e];for(;e>0;){let p=e-1>>1,m=n[p];if(a(u,m)>=0)break;n[e]=m,e=p}n[e]=u}_down(e){let{data:n,compare:a}=this,u=this.length>>1,p=n[e];for(;e<u;){let m=1+(e<<1),_=m+1;if(_<this.length&&a(n[_],n[m])<0&&(m=_),a(n[m],p)>=0)break;n[e]=n[m],e=m}n[e]=p}}var rt=8192;function cg(r,e){return e.dist-r.dist}let iu=100,ru=50;function Hd(r){let e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==r[n])return!1;return!0}function $d(r){return r[1]-r[0]+1}function fa(r,e){let n=r[1]>=r[0]&&r[1]<e;return n||console.warn("Distance Expression: Index is out of range"),n}function wf(r,e){if(r[0]>r[1])return[null,null];let n=$d(r);if(e){if(n===2)return[r,null];let a=Math.floor(n/2);return[[r[0],r[0]+a],[r[0]+a,r[1]]]}{if(n===1)return[r,null];let a=Math.floor(n/2)-1;return[[r[0],r[0]+a],[r[0]+a+1,r[1]]]}}function Ts(r,e){let n=[1/0,1/0,-1/0,-1/0];if(!fa(e,r.length))return n;for(let a=e[0];a<=e[1];++a)Vd(n,r[a]);return n}function pn(r){let e=[1/0,1/0,-1/0,-1/0];for(let n=0;n<r.length;++n)for(let a=0;a<r[n].length;++a)Vd(e,r[n][a]);return e}function ou(r,e,n){if(Hd(r)||Hd(e))return NaN;let a=0,u=0;return r[2]<e[0]&&(a=e[0]-r[2]),r[0]>e[2]&&(a=r[0]-e[2]),r[1]>e[3]&&(u=r[1]-e[3]),r[3]<e[1]&&(u=e[1]-r[3]),n.distance([0,0],[a,u])}function P1(r){return 360*r-180}function O1(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function Ef(r,e){let n=Math.pow(2,e.z),a=(r.y/rt+e.y)/n;return[P1((r.x/rt+e.x)/n),O1(a)]}function L1(r,e){let n=[];for(let a=0;a<r.length;++a)n.push(Ef(r[a],e));return n}function Di(r,e,n){let a=n.pointOnLine(e,r).point;return n.distance(r,a)}function Rv(r,e,n,a,u){let p=n.slice(a[0],a[1]+1),m=1/0;for(let _=e[0];_<=e[1];++_)if((m=Math.min(m,Di(r[_],p,u)))===0)return 0;return m}function ug(r,e,n,a,u){let p=Math.min(u.pointToSegmentDistance(r,n,a),u.pointToSegmentDistance(e,n,a)),m=Math.min(u.pointToSegmentDistance(n,r,e),u.pointToSegmentDistance(a,r,e));return Math.min(p,m)}function F1(r,e,n,a,u){if(!fa(e,r.length)||!fa(a,n.length))return NaN;let p=1/0;for(let m=e[0];m<e[1];++m)for(let _=a[0];_<a[1];++_){if(yf(r[m],r[m+1],n[_],n[_+1]))return 0;p=Math.min(p,ug(r[m],r[m+1],n[_],n[_+1],u))}return p}function k1(r,e,n,a,u){if(!fa(e,r.length)||!fa(a,n.length))return NaN;let p=1/0;for(let m=e[0];m<=e[1];++m)for(let _=a[0];_<=a[1];++_)if((p=Math.min(p,u.distance(r[m],n[_])))===0)return p;return p}function N1(r,e,n){if(ws(r,e,!0))return 0;let a=1/0;for(let u of e){let p=u.length;if(p<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(u[0]!==u[p-1]&&(a=Math.min(a,n.pointToSegmentDistance(r,u[p-1],u[0])))===0||(a=Math.min(a,Di(r,u,n)))===0)return a}return a}function z1(r,e,n,a){if(!fa(e,r.length))return NaN;for(let p=e[0];p<=e[1];++p)if(ws(r[p],n,!0))return 0;let u=1/0;for(let p=e[0];p<e[1];++p)for(let m of n)for(let _=0,b=m.length,w=b-1;_<b;w=_++){if(yf(r[p],r[p+1],m[w],m[_]))return 0;u=Math.min(u,ug(r[p],r[p+1],m[w],m[_],a))}return u}function Pv(r,e){for(let n of r)for(let a=0;a<=n.length-1;++a)if(ws(n[a],e,!0))return!0;return!1}function B1(r,e,n,a=1/0){let u=pn(r),p=pn(e);if(a!==1/0&&ou(u,p,n)>=a)return a;if(hl(u,p)){if(Pv(r,e))return 0}else if(Pv(e,r))return 0;let m=a;for(let _ of r)for(let b=0,w=_.length,I=w-1;b<w;I=b++)for(let S of e)for(let D=0,P=S.length,O=P-1;D<P;O=D++){if(yf(_[I],_[b],S[O],S[D]))return 0;m=Math.min(m,ug(_[I],_[b],S[O],S[D],n))}return m}function Tf(r,e,n,a,u,p,m){if(p===null||m===null)return;let _=ou(Ts(a,p),Ts(u,m),n);_<e&&r.push({dist:_,range1:p,range2:m})}function V1(r,e,n,a,u=1/0){let p=Math.min(a.distance(r[0],n[0][0]),u);if(p===0)return p;let m=new bf([{dist:0,range1:[0,r.length-1],range2:[0,0]}],cg),_=e?ru:iu,b=pn(n);for(;m.length;){let w=m.pop();if(w.dist>=p)continue;let I=w.range1;if($d(I)<=_){if(!fa(I,r.length))return NaN;if(e){let S=z1(r,I,n,a);if((p=Math.min(p,S))===0)return p}else for(let S=I[0];S<=I[1];++S){let D=N1(r[S],n,a);if((p=Math.min(p,D))===0)return p}}else{let S=wf(I,e);if(S[0]!==null){let D=ou(Ts(r,S[0]),b,a);D<p&&m.push({dist:D,range1:S[0],range2:[0,0]})}if(S[1]!==null){let D=ou(Ts(r,S[1]),b,a);D<p&&m.push({dist:D,range1:S[1],range2:[0,0]})}}}return p}function Ov(r,e,n,a,u,p=1/0){let m=Math.min(p,u.distance(r[0],n[0]));if(m===0)return m;let _=new bf([{dist:0,range1:[0,r.length-1],range2:[0,n.length-1]}],cg),b=e?ru:iu,w=a?ru:iu;for(;_.length;){let I=_.pop();if(I.dist>=m)continue;let S=I.range1,D=I.range2;if($d(S)<=b&&$d(D)<=w){if(!fa(S,r.length)||!fa(D,n.length))return NaN;if(e&&a?m=Math.min(m,F1(r,S,n,D,u)):e||a?e&&!a?m=Math.min(m,Rv(n,D,r,S,u)):!e&&a&&(m=Math.min(m,Rv(r,S,n,D,u))):m=Math.min(m,k1(r,S,n,D,u)),m===0)return m}else{let P=wf(S,e),O=wf(D,a);Tf(_,m,u,r,n,P[0],O[0]),Tf(_,m,u,r,n,P[0],O[1]),Tf(_,m,u,r,n,P[1],O[0]),Tf(_,m,u,r,n,P[1],O[1])}}return m}function dg(r,e,n,a,u=1/0){let p=u,m=Ts(r,[0,r.length-1]);for(let _ of n)if(!(p!==1/0&&ou(m,Ts(_,[0,_.length-1]),a)>=p)&&(p=Math.min(p,Ov(r,e,_,!0,a,p)),p===0))return p;return p}function If(r,e,n,a,u=1/0){let p=u,m=Ts(r,[0,r.length-1]);for(let _ of n){if(p!==1/0&&ou(m,pn(_),a)>=p)continue;let b=V1(r,e,_,a,p);if(isNaN(b))return b;if((p=Math.min(p,b))===0)return p}return p}function hg(r){return r==="Point"||r==="MultiPoint"||r==="LineString"||r==="MultiLineString"||r==="Polygon"||r==="MultiPolygon"}class oc{constructor(e,n){this.type=Ct,this.geojson=e,this.geometries=n}static parse(e,n){if(e.length!==2)return n.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(Jc(e[1])){let a=e[1];if(a.type==="FeatureCollection"){for(let u=0;u<a.features.length;++u)if(hg(a.features[u].geometry.type))return new oc(a,a.features[u].geometry)}else if(a.type==="Feature"){if(hg(a.geometry.type))return new oc(a,a.geometry)}else if(hg(a.type))return new oc(a,a)}return n.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){let n=e.geometry(),a=e.canonicalID();if(n!=null&&a!=null){if(e.geometryType()==="Point")return(function(u,p,m){let _=[];for(let w of u)for(let I of w)_.push(Ef(I,p));let b=new nu(_[0][1],"meters");return m.type==="Point"||m.type==="MultiPoint"||m.type==="LineString"?Ov(_,!1,m.type==="Point"?[m.coordinates]:m.coordinates,m.type==="LineString",b):m.type==="MultiLineString"?dg(_,!1,m.coordinates,b):m.type==="Polygon"||m.type==="MultiPolygon"?If(_,!1,m.type==="Polygon"?[m.coordinates]:m.coordinates,b):null})(n,a,this.geometries);if(e.geometryType()==="LineString")return(function(u,p,m){let _=[];for(let w of u){let I=[];for(let S of w)I.push(Ef(S,p));_.push(I)}let b=new nu(_[0][0][1],"meters");if(m.type==="Point"||m.type==="MultiPoint"||m.type==="LineString")return dg(m.type==="Point"?[m.coordinates]:m.coordinates,m.type==="LineString",_,b);if(m.type==="MultiLineString"){let w=1/0;for(let I=0;I<m.coordinates.length;I++){let S=dg(m.coordinates[I],!0,_,b,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}if(m.type==="Polygon"||m.type==="MultiPolygon"){let w=1/0;for(let I=0;I<_.length;I++){let S=If(_[I],!0,m.type==="Polygon"?[m.coordinates]:m.coordinates,b,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}return null})(n,a,this.geometries);if(e.geometryType()==="Polygon")return(function(u,p,m){let _=[];for(let w of(function(I,S){let D=I.length;if(D<=1)return[I];let P=[],O,N;for(let V=0;V<D;V++){let U=C1(I[V]);U!==0&&(I[V].area=Math.abs(U),N===void 0&&(N=U<0),N===U<0?(O&&P.push(O),O=[I[V]]):O.push(I[V]))}return O&&P.push(O),P})(u)){let I=[];for(let S=0;S<w.length;++S)I.push(L1(w[S],p));_.push(I)}let b=new nu(_[0][0][0][1],"meters");if(m.type==="Point"||m.type==="MultiPoint"||m.type==="LineString")return If(m.type==="Point"?[m.coordinates]:m.coordinates,m.type==="LineString",_,b);if(m.type==="MultiLineString"){let w=1/0;for(let I=0;I<m.coordinates.length;I++){let S=If(m.coordinates[I],!0,_,b,w);if(isNaN(S))return S;if((w=Math.min(w,S))===0)return w}return w}return m.type==="Polygon"||m.type==="MultiPolygon"?(function(w,I,S){let D=1/0;for(let P of w)for(let O of I){let N=B1(P,O,S,D);if(isNaN(N))return N;if((D=Math.min(D,N))===0)return D}return D})(m.type==="Polygon"?[m.coordinates]:m.coordinates,_,b):null})(n,a,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function su(r){if(r instanceof no&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof rc||r instanceof oc)return!1;if(r instanceof lu)return r.featureConstant;let e=!0;return r.eachChild(n=>{e&&!su(n)&&(e=!1)}),e}function Gd(r){if(r instanceof no&&r.name==="feature-state")return!1;let e=!0;return r.eachChild(n=>{e&&!Gd(n)&&(e=!1)}),e}function au(r,e){if(r instanceof no&&e.indexOf(r.name)>=0)return!1;let n=!0;return r.eachChild(a=>{n&&!au(a,e)&&(n=!1)}),n}function Lv(r,e,n){return[r,e,n].filter(Boolean).join("")}function fg(r,e){switch(r){case"string":return da(e);case"number":return+e;case"boolean":return!!e;case"color":return Nn.parse(e);case"formatted":return Dr.fromString(da(e));case"resolvedImage":return Eo.build(da(e))}return e}function Fv(r,e,n,a){return a!==void 0&&(r=a*Math.round(r/a)),e!==void 0&&r<e&&(r=e),n!==void 0&&r>n&&(r=n),r}class lu{constructor(e,n,a,u=!1){this.type=e,this.key=n,this.scope=a,this.featureConstant=u}static parse(e,n){let a=n.expectedType;if(a==null&&(a=Vn),e.length<2||e.length>3)return n.error("Invalid number of arguments for 'config' expression.");let u=n.parse(e[1],1);if(!(u instanceof La))return n.error("Key name of 'config' expression must be a string literal.");let p,m=!0,_=da(u.value);if(e.length>=3){let b=n.parse(e[2],2);if(!(b instanceof La))return n.error("Scope of 'config' expression must be a string literal.");p=da(b.value)}if(n.options){let b=Lv(_,p,n._scope),w=n.options.get(b);w&&(m=su(w.value||w.default))}return new lu(a,_,p,m)}evaluate(e){let n=Lv(this.key,this.scope,e.scope),a=e.getConfig(n);if(!a)return null;let{type:u,value:p,values:m,minValue:_,maxValue:b,stepValue:w}=a,I=a.default.evaluate(e),S=I;if(p){let D=e.scope;e.scope=(D||"").split("").slice(1).join(""),S=p.evaluate(e),e.scope=D}return u&&(S=fg(u,S)),S===void 0||_===void 0&&b===void 0&&w===void 0||(typeof S=="number"?S=Fv(S,_,b,w):Array.isArray(S)&&(S=S.map(D=>typeof D=="number"?Fv(D,_,b,w):D))),p!==void 0&&S!==void 0&&m&&!m.includes(S)&&(S=I,u&&(S=fg(u,S))),(u&&u!==this.type||S!==void 0&&!ff(xr(S),this.type))&&(S=fg(this.type.kind,S)),S}eachChild(){}outputDefined(){return!1}serialize(){let e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Sf{constructor(e,n){this.type=n.type,this.name=e,this.boundExpression=n}static parse(e,n){if(e.length!==2||typeof e[1]!="string")return n.error("'var' expression requires exactly one string literal argument.");let a=e[1];return n.scope.has(a)?new Sf(a,n.scope.get(a)):n.error(`Unknown variable "${a}". Make sure "${a}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Df{constructor(e,n=[],a,u=new bs,p=[],m,_,b){this.registry=e,this.path=n,this.key=n.map(w=>typeof w=="string"?`['${w}']`:`[${w}]`).join(""),this.scope=u,this.errors=p,this.expectedType=a,this._scope=m,this.options=_,this.iconImageUseTheme=b}parse(e,n,a,u,p={}){return n||a?this.concat(n,null,a,u)._parse(e,p):this._parse(e,p)}parseObjectValue(e,n,a,u,p,m={}){return this.concat(n,a,u,p)._parse(e,m)}_parse(e,n){function a(u,p,m){return m==="assert"?new Tt(p,[u]):m==="coerce"?new ha(p,[u]):u}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let u=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(u){let p=u.parse(e,this);if(!p)return null;if(this.expectedType){let m=this.expectedType,_=p.type;if(m.kind!=="string"&&m.kind!=="number"&&m.kind!=="boolean"&&m.kind!=="object"&&m.kind!=="array"||_.kind!=="value")if(m.kind!=="color"&&m.kind!=="formatted"&&m.kind!=="resolvedImage"||_.kind!=="value"&&_.kind!=="string"){if(this.checkSubtype(m,_))return null}else p=a(p,m,n.typeAnnotation||"coerce");else p=a(p,m,n.typeAnnotation||"assert")}if(!(p instanceof La)&&p.type.kind!=="resolvedImage"&&pg(p)){let m=new Fr(this._scope,this.options,this.iconImageUseTheme);try{p=new La(p.type,p.evaluate(m))}catch(_){return this.error(_.message),null}}return p}return ha.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,n,a,u){let p=typeof e=="number"?this.path.concat(e):this.path;p=typeof n=="string"?p.concat(n):p;let m=u?this.scope.concat(u):this.scope;return new Df(this.registry,p,a||null,m,this.errors,this._scope,this.options,this.iconImageUseTheme)}error(e,...n){let a=`${this.key}${n.map(u=>`[${u}]`).join("")}`;this.errors.push(new xs(a,e))}checkSubtype(e,n){let a=kd(e,n);return a&&this.error(a),a}}function pg(r){if(r instanceof Sf)return pg(r.boundExpression);if(r instanceof no&&r.name==="error"||r instanceof eu||r instanceof rc||r instanceof oc||r instanceof lu)return!1;let e=r instanceof ha||r instanceof Tt,n=!0;return r.eachChild(a=>{n=e?n&&pg(a):n&&a instanceof La}),!!n&&su(r)&&au(r,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Cf(r,e){let n=r.length-1,a,u,p=0,m=n,_=0;for(;p<=m;)if(_=Math.floor((p+m)/2),a=r[_],u=r[_+1],a<=e){if(_===n||e<u)return _;p=_+1}else{if(!(a>e))throw new Xi("Input is not a number.");m=_-1}return 0}class qd{constructor(e,n,a){this.type=e,this.input=n,this.labels=[],this.outputs=[];for(let[u,p]of a)this.labels.push(u),this.outputs.push(p)}static parse(e,n){if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return n.error("Expected an even number of arguments.");let a=n.parse(e[1],1,Ct);if(!a)return null;let u=[],p=null;n.expectedType&&n.expectedType.kind!=="value"&&(p=n.expectedType);for(let m=1;m<e.length;m+=2){let _=m===1?-1/0:e[m],b=e[m+1],w=m,I=m+1;if(typeof _!="number")return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',w);if(u.length&&u[u.length-1][0]>=_)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',w);let S=n.parse(b,I,p);if(!S)return null;p=p||S.type,u.push([_,S])}return new qd(p,a,u)}evaluate(e){let n=this.labels,a=this.outputs;if(n.length===1)return a[0].evaluate(e);let u=this.input.evaluate(e);if(u<=n[0])return a[0].evaluate(e);let p=n.length;return u>=n[p-1]?a[p-1].evaluate(e):a[Cf(n,u)].evaluate(e)}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&e.push(this.labels[n]),e.push(this.outputs[n].serialize());return e}}let kv=.95047,Nv=1.08883,zv=4/29,cu=6/29,Af=3*cu*cu,j1=cu*cu*cu,Bv=Math.PI/180,U1=180/Math.PI;function mg(r){return r>j1?Math.pow(r,1/3):r/Af+zv}function gg(r){return r>cu?r*r*r:Af*(r-zv)}function Mf(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Rf(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function sc(r){let e=Rf(r.r),n=Rf(r.g),a=Rf(r.b),u=mg((.4124564*e+.3575761*n+.1804375*a)/kv),p=mg((.2126729*e+.7151522*n+.072175*a)/1);return{l:116*p-16,a:500*(u-p),b:200*(p-mg((.0193339*e+.119192*n+.9503041*a)/Nv)),alpha:r.a}}function _g(r){let e=(r.l+16)/116,n=isNaN(r.a)?e:e+r.a/500,a=isNaN(r.b)?e:e-r.b/200;return e=1*gg(e),n=kv*gg(n),a=Nv*gg(a),new Nn(Mf(3.2404542*n-1.5371385*e-.4985314*a),Mf(-.969266*n+1.8760108*e+.041556*a),Mf(.0556434*n-.2040259*e+1.0572252*a),r.alpha)}function Vv(r,e,n){let a=e-r;return r+n*(a>180||a<-180?a-360*Math.round(a/360):a)}let Wd={forward:sc,reverse:_g,interpolate:function(r,e,n){return{l:zt(r.l,e.l,n),a:zt(r.a,e.a,n),b:zt(r.b,e.b,n),alpha:zt(r.alpha,e.alpha,n)}}},ac={forward:function(r){let{l:e,a:n,b:a}=sc(r),u=Math.atan2(a,n)*U1;return{h:u<0?u+360:u,c:Math.sqrt(n*n+a*a),l:e,alpha:r.a}},reverse:function(r){let e=r.h*Bv,n=r.c;return _g({l:r.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:r.alpha})},interpolate:function(r,e,n){return{h:Vv(r.h,e.h,n),c:zt(r.c,e.c,n),l:zt(r.l,e.l,n),alpha:zt(r.alpha,e.alpha,n)}}};var Pf=Object.freeze({__proto__:null,hcl:ac,lab:Wd});class Yo{constructor(e,n,a,u,p){this.type=e,this.operator=n,this.interpolation=a,this.input=u,this.labels=[],this.outputs=[];for(let[m,_]of p)this.labels.push(m),this.outputs.push(_)}static interpolationFactor(e,n,a,u){let p=0;if(e.name==="exponential")p=yg(n,e.base,a,u);else if(e.name==="linear")p=yg(n,1,a,u);else if(e.name==="cubic-bezier"){let m=e.controlPoints;p=new Wc(m[0],m[1],m[2],m[3]).solve(yg(n,1,a,u))}return p}static parse(e,n){let[a,u,p,...m]=e;if(!Array.isArray(u)||u.length===0)return n.error("Expected an interpolation type expression.",1);if(u[0]==="linear")u={name:"linear"};else if(u[0]==="exponential"){let w=u[1];if(typeof w!="number")return n.error("Exponential interpolation requires a numeric base.",1,1);u={name:"exponential",base:w}}else{if(u[0]!=="cubic-bezier")return n.error(`Unknown interpolation type ${String(u[0])}`,1,0);{let w=u.slice(1);if(w.length!==4||w.some(I=>typeof I!="number"||I<0||I>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);u={name:"cubic-bezier",controlPoints:w}}}if(e.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(p=n.parse(p,2,Ct),!p)return null;let _=[],b=null;a==="interpolate-hcl"||a==="interpolate-lab"?b=Fo:n.expectedType&&n.expectedType.kind!=="value"&&(b=n.expectedType);for(let w=0;w<m.length;w+=2){let I=m[w],S=m[w+1],D=w+3,P=w+4;if(typeof I!="number")return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',D);if(_.length&&_[_.length-1][0]>=I)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',D);let O=n.parse(S,P,b);if(!O)return null;b=b||O.type,_.push([I,O])}return b.kind==="number"||b.kind==="color"||b.kind==="array"&&b.itemType.kind==="number"&&typeof b.N=="number"?new Yo(b,a,u,p,_):n.error(`Type ${hr(b)} is not interpolatable.`)}evaluate(e){let n=this.labels,a=this.outputs;if(n.length===1)return a[0].evaluate(e);let u=this.input.evaluate(e);if(u<=n[0])return a[0].evaluate(e);let p=n.length;if(u>=n[p-1])return a[p-1].evaluate(e);let m=Cf(n,u),_=Yo.interpolationFactor(this.interpolation,u,n[m],n[m+1]),b=a[m].evaluate(e),w=a[m+1].evaluate(e);return this.operator==="interpolate"?Pa[this.type.kind.toLowerCase()](b,w,_):this.operator==="interpolate-hcl"?ac.reverse(ac.interpolate(ac.forward(b),ac.forward(w),_)):Wd.reverse(Wd.interpolate(Wd.forward(b),Wd.forward(w),_))}eachChild(e){e(this.input);for(let n of this.outputs)e(n)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let n=[this.operator,e,this.input.serialize()];for(let a=0;a<this.labels.length;a++)n.push(this.labels[a],this.outputs[a].serialize());return n}}function yg(r,e,n,a){let u=a-n,p=r-n;return u===0?0:e===1?p/u:(Math.pow(e,p)-1)/(Math.pow(e,u)-1)}class Zd{constructor(e,n){this.type=e,this.args=n}static parse(e,n){if(e.length<2)return n.error("Expectected at least one argument.");let a=null,u=n.expectedType;u&&u.kind!=="value"&&(a=u);let p=[];for(let _ of e.slice(1)){let b=n.parse(_,1+p.length,a,void 0,{typeAnnotation:"omit"});if(!b)return null;a=a||b.type,p.push(b)}let m=u&&p.some(_=>kd(u,_.type));return new Zd(m?Vn:a,p)}evaluate(e){let n,a=null,u=0;for(let p of this.args){if(u++,a=p.evaluate(e),a&&a instanceof Eo&&!a.available&&(n||(n=a),a=null,u===this.args.length))return n;if(a!==null)break}return a}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){let e=["coalesce"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Xd{constructor(e,n){this.type=n.type,this.bindings=[].concat(e),this.result=n}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(let n of this.bindings)e(n[1]);e(this.result)}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);let a=[];for(let p=1;p<e.length-1;p+=2){let m=e[p];if(typeof m!="string")return n.error(`Expected string, but found ${typeof m} instead.`,p);if(/[^a-zA-Z0-9_]/.test(m))return n.error("Variable names must contain only alphanumeric characters or '_'.",p);let _=n.parse(e[p+1],p+1);if(!_)return null;a.push([m,_])}let u=n.parse(e[e.length-1],e.length-1,n.expectedType,a);return u?new Xd(a,u):null}outputDefined(){return this.result.outputDefined()}serialize(){let e=["let"];for(let[n,a]of this.bindings)e.push(n,a.serialize());return e.push(this.result.serialize()),e}}class vg{constructor(e,n,a){this.type=e,this.index=n,this.input=a}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let a=n.parse(e[1],1,Ct),u=n.parse(e[2],2,Lr(n.expectedType||Vn));return a&&u?new vg(u.type.itemType,a,u):null}evaluate(e){let n=this.index.evaluate(e),a=this.input.evaluate(e);if(n<0)throw new Xi("Array index out of bounds: negative index");if(n>=a.length)throw new Xi("Array index out of bounds: index exceeds array size");if(n!==Math.floor(n))throw new Xi("Array index must be an integer. Use at-interpolated for fractional indices");return a[n]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class xg{constructor(e,n,a){this.type=e,this.index=n,this.input=a}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let a=n.parse(e[1],1,Ct),u=n.parse(e[2],2,Lr(n.expectedType||Vn));return a&&u?new xg(u.type.itemType,a,u):null}evaluate(e){let n=this.index.evaluate(e),a=this.input.evaluate(e);if(n<0)throw new Xi(`Array index out of bounds: ${n} < 0.`);if(n>a.length-1)throw new Xi(`Array index out of bounds: ${n} > ${a.length-1}.`);if(n===Math.floor(n))return a[n];let u=Math.floor(n),p=Math.ceil(n),m=a[u],_=a[p];if(typeof m!="number"||typeof _!="number")throw new Xi(`Cannot interpolate between non-number values at index ${n}.`);let b=n-u;return m*(1-b)+_*b}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class bg{constructor(e,n){this.type=Fn,this.needle=e,this.haystack=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let a=n.parse(e[1],1,Vn),u=n.parse(e[2],2,Vn);return a&&u?tg(a.type,[Fn,In,Ct,Yc,Vn])?new bg(a,u):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${hr(a.type)} instead`):null}evaluate(e){let n=this.needle.evaluate(e),a=this.haystack.evaluate(e);if(a==null)return!1;if(!Nd(n,["boolean","string","number","null"]))throw new Xi(`Expected first argument to be of type boolean, string, number or null, but found ${hr(xr(n))} instead.`);if(!Nd(a,["string","array"]))throw new Xi(`Expected second argument to be of type array or string, but found ${hr(xr(a))} instead.`);return a.indexOf(n)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Yd{constructor(e,n,a){this.type=Ct,this.needle=e,this.haystack=n,this.fromIndex=a}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let a=n.parse(e[1],1,Vn),u=n.parse(e[2],2,Vn);if(!a||!u)return null;if(!tg(a.type,[Fn,In,Ct,Yc,Vn]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${hr(a.type)} instead`);if(e.length===4){let p=n.parse(e[3],3,Ct);return p?new Yd(a,u,p):null}return new Yd(a,u)}evaluate(e){let n=this.needle.evaluate(e),a=this.haystack.evaluate(e);if(!Nd(n,["boolean","string","number","null"]))throw new Xi(`Expected first argument to be of type boolean, string, number or null, but found ${hr(xr(n))} instead.`);if(!Nd(a,["string","array"]))throw new Xi(`Expected second argument to be of type array or string, but found ${hr(xr(a))} instead.`);if(this.fromIndex){let u=this.fromIndex.evaluate(e);return a.indexOf(n,u)}return a.indexOf(n)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){let e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Of{constructor(e,n,a,u,p,m){this.inputType=e,this.type=n,this.input=a,this.cases=u,this.outputs=p,this.otherwise=m}static parse(e,n){if(e.length<5)return n.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return n.error("Expected an even number of arguments.");let a,u;n.expectedType&&n.expectedType.kind!=="value"&&(u=n.expectedType);let p={},m=[];for(let w=2;w<e.length-1;w+=2){let I=e[w],S=e[w+1];Array.isArray(I)||(I=[I]);let D=n.concat(w);if(I.length===0)return D.error("Expected at least one branch label.");for(let O of I){if(typeof O!="number"&&typeof O!="string")return D.error("Branch labels must be numbers or strings.");if(typeof O=="number"&&Math.abs(O)>Number.MAX_SAFE_INTEGER)return D.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof O=="number"&&Math.floor(O)!==O)return D.error("Numeric branch labels must be integer values.");if(a){if(D.checkSubtype(a,xr(O)))return null}else a=xr(O);if(p[String(O)]!==void 0)return D.error("Branch labels must be unique.");p[String(O)]=m.length}let P=n.parse(S,w,u);if(!P)return null;u=u||P.type,m.push(P)}let _=n.parse(e[1],1,Vn);if(!_)return null;let b=n.parse(e[e.length-1],e.length-1,u);return b?_.type.kind!=="value"&&n.concat(1).checkSubtype(a,_.type)?null:new Of(a,u,_,p,m,b):null}evaluate(e){let n=this.input.evaluate(e);return(ff(xr(n),this.inputType)&&this.outputs[this.cases[n]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),a=[],u={};for(let m of n){let _=u[this.cases[m]];_===void 0?(u[this.cases[m]]=a.length,a.push([this.cases[m],[m]])):a[_][1].push(m)}let p=m=>this.inputType.kind==="number"?Number(m):m;for(let[m,_]of a)e.push(_.length===1?p(_[0]):_.map(p)),e.push(this.outputs[m].serialize());return e.push(this.otherwise.serialize()),e}}class uu{constructor(e,n,a){this.type=e,this.branches=n,this.otherwise=a}static parse(e,n){if(e.length<4)return n.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return n.error("Expected an odd number of arguments.");let a;n.expectedType&&n.expectedType.kind!=="value"&&(a=n.expectedType);let u=[];for(let m=1;m<e.length-1;m+=2){let _=n.parse(e[m],m,Fn);if(!_)return null;let b=n.parse(e[m+1],m+1,a);if(!b)return null;u.push([_,b]),a=a||b.type}let p=n.parse(e[e.length-1],e.length-1,a);return p?new uu(a,u,p):null}evaluate(e){for(let[n,a]of this.branches)if(n.evaluate(e))return a.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(let[n,a]of this.branches)e(n),e(a);e(this.otherwise)}outputDefined(){return this.branches.every(([e,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){let e=["case"];return this.eachChild(n=>{e.push(n.serialize())}),e}}class Lf{constructor(e,n,a,u){this.type=e,this.input=n,this.beginIndex=a,this.endIndex=u}static parse(e,n){if(e.length<=2||e.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);let a=n.parse(e[1],1,Vn),u=n.parse(e[2],2,Ct);if(!a||!u)return null;if(!tg(a.type,[Lr(Vn),In,Vn]))return n.error(`Expected first argument to be of type array or string, but found ${hr(a.type)} instead`);if(e.length===4){let p=n.parse(e[3],3,Ct);return p?new Lf(a.type,a,u,p):null}return new Lf(a.type,a,u)}evaluate(e){let n=this.input.evaluate(e),a=this.beginIndex.evaluate(e);if(!Nd(n,["string","array"]))throw new Xi(`Expected first argument to be of type array or string, but found ${hr(xr(n))} instead.`);if(this.endIndex){let u=this.endIndex.evaluate(e);return n.slice(a,u)}return n.slice(a)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){let e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class Ff{constructor(e,n){this.type=Lr(In),this.str=e,this.delimiter=n}static parse(e,n){if(e.length!==3)return n.error(`Expected 2 arguments, but found ${e.length-1} instead.`);let a=n.parse(e[1],1,In),u=n.parse(e[2],2,In);return a&&u?new Ff(a,u):void 0}evaluate(e){let n=this.str.evaluate(e),a=this.delimiter.evaluate(e);return n.split(a)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function jv(r,e){return r==="=="||r==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function Uv(r,e,n,a){return a.compare(e,n)===0}function du(r,e,n){let a=r!=="=="&&r!=="!=";return class RN{constructor(p,m,_){this.type=Fn,this.lhs=p,this.rhs=m,this.collator=_,this.hasUntypedArgument=p.type.kind==="value"||m.type.kind==="value"}static parse(p,m){if(p.length!==3&&p.length!==4)return m.error("Expected two or three arguments.");let _=p[0],b=m.parse(p[1],1,Vn);if(!b)return null;if(!jv(_,b.type))return m.concat(1).error(`"${_}" comparisons are not supported for type '${hr(b.type)}'.`);let w=m.parse(p[2],2,Vn);if(!w)return null;if(!jv(_,w.type))return m.concat(2).error(`"${_}" comparisons are not supported for type '${hr(w.type)}'.`);if(b.type.kind!==w.type.kind&&b.type.kind!=="value"&&w.type.kind!=="value")return m.error(`Cannot compare types '${hr(b.type)}' and '${hr(w.type)}'.`);a&&(b.type.kind==="value"&&w.type.kind!=="value"?b=new Tt(w.type,[b]):b.type.kind!=="value"&&w.type.kind==="value"&&(w=new Tt(b.type,[w])));let I=null;if(p.length===4){if(b.type.kind!=="string"&&w.type.kind!=="string"&&b.type.kind!=="value"&&w.type.kind!=="value")return m.error("Cannot use collator to compare non-string types.");if(I=m.parse(p[3],3,Ld),!I)return null}return new RN(b,w,I)}evaluate(p){let m=this.lhs.evaluate(p),_=this.rhs.evaluate(p);if(a&&this.hasUntypedArgument){let b=xr(m),w=xr(_);if(b.kind!==w.kind||b.kind!=="string"&&b.kind!=="number")throw new Xi(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${b.kind}, ${w.kind}) instead.`)}if(this.collator&&!a&&this.hasUntypedArgument){let b=xr(m),w=xr(_);if(b.kind!=="string"||w.kind!=="string")return e(p,m,_)}return this.collator?n(p,m,_,this.collator.evaluate(p)):e(p,m,_)}eachChild(p){p(this.lhs),p(this.rhs),this.collator&&p(this.collator)}outputDefined(){return!0}serialize(){let p=[r];return this.eachChild(m=>{p.push(m.serialize())}),p}}}let Hv=du("==",function(r,e,n){return e===n},Uv),$v=du("!=",function(r,e,n){return e!==n},function(r,e,n,a){return!Uv(0,e,n,a)}),H1=du("<",function(r,e,n){return e<n},function(r,e,n,a){return a.compare(e,n)<0}),$1=du(">",function(r,e,n){return e>n},function(r,e,n,a){return a.compare(e,n)>0}),G1=du("<=",function(r,e,n){return e<=n},function(r,e,n,a){return a.compare(e,n)<=0}),kf=du(">=",function(r,e,n){return e>=n},function(r,e,n,a){return a.compare(e,n)>=0});class wg{constructor(e,n,a,u,p,m){this.type=In,this.number=e,this.locale=n,this.currency=a,this.unit=u,this.minFractionDigits=p,this.maxFractionDigits=m}static parse(e,n){if(e.length!==3)return n.error("Expected two arguments.");let a=n.parse(e[1],1,Ct);if(!a)return null;let u=e[2];if(typeof u!="object"||Array.isArray(u))return n.error("NumberFormat options argument must be an object.");let p=null;if(u.locale&&(p=n.parseObjectValue(u.locale,2,"locale",In),!p))return null;let m=null;if(u.currency&&(m=n.parseObjectValue(u.currency,2,"currency",In),!m))return null;let _=null;if(u.unit&&(_=n.parseObjectValue(u.unit,2,"unit",In),!_))return null;let b=null;if(u["min-fraction-digits"]&&(b=n.parseObjectValue(u["min-fraction-digits"],2,"min-fraction-digits",Ct),!b))return null;let w=null;return u["max-fraction-digits"]&&(w=n.parseObjectValue(u["max-fraction-digits"],2,"max-fraction-digits",Ct),!w)?null:new wg(a,p,m,_,b,w)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Eg{constructor(e){this.type=Ct,this.input=e}static parse(e,n){if(e.length!==2)return n.error(`Expected 1 argument, but found ${e.length-1} instead.`);let a=n.parse(e[1],1);return a?a.type.kind!=="array"&&a.type.kind!=="string"&&a.type.kind!=="value"?n.error(`Expected argument of type string or array, but found ${hr(a.type)} instead.`):new Eg(a):null}evaluate(e){let n=this.input.evaluate(e);if(typeof n=="string"||Array.isArray(n))return n.length;throw new Xi(`Expected value to be of type string or array, but found ${hr(xr(n))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){let e=["length"];return this.eachChild(n=>{e.push(n.serialize())}),e}}function Gv(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let hu={"==":Hv,"!=":$v,">":$1,"<":H1,">=":kf,"<=":G1,array:Tt,at:vg,"at-interpolated":xg,boolean:Tt,case:uu,coalesce:Zd,collator:eu,format:nc,image:qt,in:bg,"index-of":Yd,interpolate:Yo,"interpolate-hcl":Yo,"interpolate-lab":Yo,length:Eg,let:Xd,literal:La,match:Of,number:Tt,"number-format":wg,object:Tt,slice:Lf,step:qd,string:Tt,"to-boolean":ha,"to-color":ha,"to-number":ha,"to-string":ha,var:Sf,within:rc,distance:oc,config:lu,split:Ff};function Tg(r,[e,n,a,u]){e=e.evaluate(r),n=n.evaluate(r),a=a.evaluate(r);let p=u?u.evaluate(r):1,m=pf(e,n,a,p);if(m)throw new Xi(m);return new Nn(e/255,n/255,a/255,p)}function qv(r,[e,n,a,u]){e=e.evaluate(r),n=n.evaluate(r),a=a.evaluate(r);let p=u?u.evaluate(r):1,m=(function(w,I,S,D){return typeof w=="number"&&w>=0&&w<=360?typeof I=="number"&&I>=0&&I<=100&&typeof S=="number"&&S>=0&&S<=100?D===void 0||typeof D=="number"&&D>=0&&D<=1?null:`Invalid hsla value [${[w,I,S,D].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof D=="number"?[w,I,S,D]:[w,I,S]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof D=="number"?[w,I,S,D]:[w,I,S]).join(", ")}]: 'h' must be between 0 and 360.`})(e,n,a,p);if(m)throw new Xi(m);let _=`hsla(${e}, ${n}%, ${a}%, ${p})`,b=Nn.parse(_);if(!b)throw new Xi(`Failed to parse HSLA color: ${_}`);return b}function Wv(r,e){return r in e}function Nf(r,e){let n=e[r];return n===void 0?null:n}function ka(r){return{type:r}}function Kd(r){if(r instanceof lu)return new Set([r.key]);let e=new Set;return r.eachChild(n=>{e=new Set([...e,...Kd(n)])}),e}function zf(r){if(r instanceof no&&r.name==="is-active-floor")return!0;let e=!1;return r.eachChild(n=>{!e&&zf(n)&&(e=!0)}),e}function lc(r){return{result:"success",value:r}}function ml(r){return{result:"error",value:r}}function Ig(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function Bf(r){return r["property-type"]==="data-driven"}function Sg(r){return Ig(r.expression,"measure-light")}function Dg(r){return Ig(r.expression,"zoom")}function Vf(r){return!!r.expression&&r.expression.interpolated}function jf(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function Cg(r){return r}function Uf(r,e){let n=e.type==="color",a=r.stops&&typeof r.stops[0][0]=="object",u=a||!(a||r.property!==void 0),p=r.type||(Vf(e)?"exponential":"interval");if(n&&((r=Object.assign({},r)).stops&&(r.stops=r.stops.map(w=>[w[0],Nn.parse(w[1])])),r.default=Nn.parse(r.default?r.default:e.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!Pf[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let m,_,b;if(p==="exponential")m=Xv;else if(p==="interval")m=Zv;else if(p==="categorical"){m=q1,_=Object.create(null);for(let w of r.stops)_[w[0]]=w[1];b=typeof r.stops[0][0]}else{if(p!=="identity")throw new Error(`Unknown function type "${p}"`);m=W1}if(a){let w={},I=[];for(let P=0;P<r.stops.length;P++){let O=r.stops[P],N=O[0].zoom;w[N]===void 0&&(w[N]={zoom:N,type:r.type,property:r.property,default:r.default,stops:[]},I.push(N)),w[N].stops.push([O[0].value,O[1]])}let S=[];for(let P of I)S.push([w[P].zoom,Uf(w[P],e)]);let D={name:"linear"};return{kind:"composite",interpolationType:D,interpolationFactor:Yo.interpolationFactor.bind(void 0,D),zoomStops:S.map(P=>P[0]),evaluate:({zoom:P},O)=>Xv({stops:S,base:r.base},e,P).evaluate(P,O)}}if(u){let w=p==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:w,interpolationFactor:Yo.interpolationFactor.bind(void 0,w),zoomStops:r.stops.map(I=>I[0]),evaluate:({zoom:I})=>m(r,e,I,_,b)}}return{kind:"source",evaluate(w,I){let S=I&&I.properties?I.properties[r.property]:void 0;return S===void 0?fu(r.default,e.default):m(r,e,S,_,b)}}}function fu(r,e,n){return r!==void 0?r:e!==void 0?e:n!==void 0?n:void 0}function q1(r,e,n,a,u){return fu(typeof n===u?a[n]:void 0,r.default,e.default)}function Zv(r,e,n){if(!Bd(n))return fu(r.default,e.default);let a=r.stops.length;if(a===1||n<=r.stops[0][0])return r.stops[0][1];if(n>=r.stops[a-1][0])return r.stops[a-1][1];let u=Cf(r.stops.map(p=>p[0]),n);return r.stops[u][1]}function Xv(r,e,n){let a=r.base!==void 0?r.base:1;if(!Bd(n))return fu(r.default,e.default);let u=r.stops.length;if(u===1||n<=r.stops[0][0])return r.stops[0][1];if(n>=r.stops[u-1][0])return r.stops[u-1][1];let p=Cf(r.stops.map(I=>I[0]),n),m=(function(I,S,D,P){let O=P-D,N=I-D;return O===0?0:S===1?N/O:(Math.pow(S,N)-1)/(Math.pow(S,O)-1)})(n,a,r.stops[p][0],r.stops[p+1][0]),_=r.stops[p][1],b=r.stops[p+1][1],w=Pa[e.type]||Cg;if(r.colorSpace&&r.colorSpace!=="rgb"){let I=Pf[r.colorSpace];w=(S,D)=>I.reverse(I.interpolate(I.forward(S),I.forward(D),m))}return typeof _.evaluate=="function"?{evaluate(...I){let S=_.evaluate.apply(void 0,I),D=b.evaluate.apply(void 0,I);if(S!==void 0&&D!==void 0)return w(S,D,m)}}:w(_,b,m)}function W1(r,e,n){return e.type==="color"?n=Nn.parse(n):e.type==="formatted"?n=Dr.fromString(n.toString()):e.type==="resolvedImage"?n=Eo.build(n.toString()):Qc(n)===e.type||e.type==="enum"&&e.values[n]||(n=void 0),fu(n,r.default,e.default)}no.register(hu,{error:[{kind:"error"},[In],(r,[e])=>{throw new Xi(e.evaluate(r))}],typeof:[In,[Vn],(r,[e])=>hr(xr(e.evaluate(r)))],"to-rgba":[Lr(Ct,4),[Fo],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Lr(Ct,4),[Fo],(r,[e])=>e.evaluate(r).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Fo,[Ct,Ct,Ct],Tg],rgba:[Fo,[Ct,Ct,Ct,Ct],Tg],hsl:[Fo,[Ct,Ct,Ct],qv],hsla:[Fo,[Ct,Ct,Ct,Ct],qv],has:{type:Fn,overloads:[[[In],(r,[e])=>Wv(e.evaluate(r),r.properties())],[[In,Kc],(r,[e,n])=>Wv(e.evaluate(r),n.evaluate(r))]]},get:{type:Vn,overloads:[[[In],(r,[e])=>Nf(e.evaluate(r),r.properties())],[[In,Kc],(r,[e,n])=>Nf(e.evaluate(r),n.evaluate(r))]]},"feature-state":[Vn,[In],(r,[e])=>Nf(e.evaluate(r),r.featureState||{})],properties:[Kc,[],r=>r.properties()],"geometry-type":[In,[],r=>r.geometryType()],worldview:[In,[],r=>r.globals.worldview||""],"is-active-floor":[Fn,ka(In),(r,e)=>{if(!(r.globals.activeFloors&&r.globals.activeFloors.size>0))return!1;let n=r.globals.activeFloors;return e.some(a=>{let u=a.evaluate(r);return n.has(u)})}],id:[Vn,[],r=>r.id()],zoom:[Ct,[],r=>r.globals.zoom],pitch:[Ct,[],r=>r.globals.pitch||0],"distance-from-center":[Ct,[],r=>r.distanceFromCenter()],"measure-light":[Ct,[In],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Ct,[],r=>r.globals.heatmapDensity||0],"line-progress":[Ct,[],r=>r.globals.lineProgress||0],"raster-value":[Ct,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Ct,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Ct,[],r=>r.globals.skyRadialProgress||0],accumulated:[Vn,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Ct,ka(Ct),(r,e)=>{let n=0;for(let a of e)n+=a.evaluate(r);return n}],"*":[Ct,ka(Ct),(r,e)=>{let n=1;for(let a of e)n*=a.evaluate(r);return n}],"-":{type:Ct,overloads:[[[Ct,Ct],(r,[e,n])=>e.evaluate(r)-n.evaluate(r)],[[Ct],(r,[e])=>-e.evaluate(r)]]},"/":[Ct,[Ct,Ct],(r,[e,n])=>e.evaluate(r)/n.evaluate(r)],"%":[Ct,[Ct,Ct],(r,[e,n])=>e.evaluate(r)%n.evaluate(r)],ln2:[Ct,[],()=>Math.LN2],pi:[Ct,[],()=>Math.PI],e:[Ct,[],()=>Math.E],"^":[Ct,[Ct,Ct],(r,[e,n])=>Math.pow(e.evaluate(r),n.evaluate(r))],sqrt:[Ct,[Ct],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Ct,[Ct],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Ct,[Ct],(r,[e])=>Math.log(e.evaluate(r))],log2:[Ct,[Ct],(r,[e])=>Math.log2(e.evaluate(r))],sin:[Ct,[Ct],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Ct,[Ct],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Ct,[Ct],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Ct,[Ct],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Ct,[Ct],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Ct,[Ct],(r,[e])=>Math.atan(e.evaluate(r))],min:[Ct,ka(Ct),(r,e)=>Math.min(...e.map(n=>n.evaluate(r)))],max:[Ct,ka(Ct),(r,e)=>Math.max(...e.map(n=>n.evaluate(r)))],abs:[Ct,[Ct],(r,[e])=>Math.abs(e.evaluate(r))],round:[Ct,[Ct],(r,[e])=>{let n=e.evaluate(r);return n<0?-Math.round(-n):Math.round(n)}],floor:[Ct,[Ct],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Ct,[Ct],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[Fn,[In,Vn],(r,[e,n])=>r.properties()[e.value]===n.value],"filter-id-==":[Fn,[Vn],(r,[e])=>r.id()===e.value],"filter-type-==":[Fn,[In],(r,[e])=>r.geometryType()===e.value],"filter-<":[Fn,[In,Vn],(r,[e,n])=>{let a=r.properties()[e.value],u=n.value;return typeof a==typeof u&&a<u}],"filter-id-<":[Fn,[Vn],(r,[e])=>{let n=r.id(),a=e.value;return typeof n==typeof a&&n<a}],"filter->":[Fn,[In,Vn],(r,[e,n])=>{let a=r.properties()[e.value],u=n.value;return typeof a==typeof u&&a>u}],"filter-id->":[Fn,[Vn],(r,[e])=>{let n=r.id(),a=e.value;return typeof n==typeof a&&n>a}],"filter-<=":[Fn,[In,Vn],(r,[e,n])=>{let a=r.properties()[e.value],u=n.value;return typeof a==typeof u&&a<=u}],"filter-id-<=":[Fn,[Vn],(r,[e])=>{let n=r.id(),a=e.value;return typeof n==typeof a&&n<=a}],"filter->=":[Fn,[In,Vn],(r,[e,n])=>{let a=r.properties()[e.value],u=n.value;return typeof a==typeof u&&a>=u}],"filter-id->=":[Fn,[Vn],(r,[e])=>{let n=r.id(),a=e.value;return typeof n==typeof a&&n>=a}],"filter-has":[Fn,[Vn],(r,[e])=>e.value in r.properties()],"filter-has-id":[Fn,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Fn,[Lr(In)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[Fn,[Lr(Vn)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[Fn,[In,Lr(Vn)],(r,[e,n])=>n.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[Fn,[In,Lr(Vn)],(r,[e,n])=>(function(a,u,p,m){for(;p<=m;){let _=p+m>>1;if(u[_]===a)return!0;u[_]>a?m=_-1:p=_+1}return!1})(r.properties()[e.value],n.value,0,n.value.length-1)],all:{type:Fn,overloads:[[[Fn,Fn],(r,[e,n])=>e.evaluate(r)&&n.evaluate(r)],[ka(Fn),(r,e)=>{for(let n of e)if(!n.evaluate(r))return!1;return!0}]]},any:{type:Fn,overloads:[[[Fn,Fn],(r,[e,n])=>e.evaluate(r)||n.evaluate(r)],[ka(Fn),(r,e)=>{for(let n of e)if(n.evaluate(r))return!0;return!1}]]},"!":[Fn,[Fn],(r,[e])=>!e.evaluate(r)],"is-supported-script":[Fn,[In],(r,[e])=>{let n=r.globals&&r.globals.isSupportedScript;return!n||n(e.evaluate(r))}],upcase:[In,[In],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[In,[In],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[In,ka(Vn),(r,e)=>e.map(n=>da(n.evaluate(r))).join("")],"resolved-locale":[In,[Ld],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Ct,[Ct,Ct,Vn],(r,e)=>{let[n,a,u]=e.map(m=>m.evaluate(r));if(n>a||n===a)return n;let p;if(typeof u=="string")p=(function(m){let _=0;if(m.length===0)return _;for(let b=0;b<m.length;b++)_=(_<<5)-_+m.charCodeAt(b),_|=0;return _})(u);else{if(typeof u!="number")throw new Xi(`Invalid seed input: ${u}`);p=u}return n+Gv(p)()*(a-n)}]});class Hf{constructor(e,n,a,u,p){this.expression=e,this._warningHistory={},this._scope=a,this._options=u,this._iconImageUseTheme=p,this._evaluator=new Fr(a,u,p),this._defaultValue=n?(function(m){return m.type==="color"&&(jf(m.default)||Array.isArray(m.default))?new Nn(0,0,0,0):m.type==="color"?Nn.parse(m.default)||null:m.default===void 0?null:m.default})(n):null,this._enumValues=n&&n.type==="enum"?n.values:null,this.configDependencies=Kd(e),this.isIndoorDependent=zf(e)}evaluateWithoutErrorHandling(e,n,a,u,p,m,_,b){return this._evaluator.globals=e,this._evaluator.feature=n,this._evaluator.featureState=a,this._evaluator.canonical=u||null,this._evaluator.availableImages=p||null,this._evaluator.formattedSection=m,this._evaluator.featureTileCoord=_||null,this._evaluator.featureDistanceData=b||null,this.expression.evaluate(this._evaluator)}evaluate(e,n,a,u,p,m,_,b,w){this._evaluator||(this._evaluator=new Fr(this._scope,this._options,this._iconImageUseTheme)),this._evaluator.globals=e,this._evaluator.feature=n||null,this._evaluator.featureState=a||null,this._evaluator.canonical=u||null,this._evaluator.availableImages=p||null,this._evaluator.formattedSection=m||null,this._evaluator.featureTileCoord=_||null,this._evaluator.featureDistanceData=b||null,this._evaluator.iconImageUseTheme=w||null;try{let I=this.expression.evaluate(this._evaluator);if(I==null||typeof I=="number"&&I!=I)return this._defaultValue;if(this._enumValues&&!(I in this._enumValues))throw new Xi(`Expected value to be one of ${Object.keys(this._enumValues).map(S=>JSON.stringify(S)).join(", ")}, but found ${JSON.stringify(I)} instead.`);return I}catch(I){return this._warningHistory[I.message]||(this._warningHistory[I.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${I.message}`)),this._defaultValue}}}function $f(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in hu}function pa(r,e,n,a,u){let p=new Df(hu,[],e?(function(_){let b={color:Fo,string:In,number:Ct,enum:In,boolean:Fn,formatted:tc,resolvedImage:Fd};return _.type==="array"?Lr(b[_.value]||Vn,_.length):b[_.type]})(e):void 0,void 0,void 0,n,a,u),m=p.parse(r,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return m?lc(new Hf(m,e,n,a,u)):ml(p.errors)}class Jd{constructor(e,n,a,u){this.kind=e,this._styleExpression=n,this.isLightConstant=a,this.isLineProgressConstant=u,this.isStateDependent=e!=="constant"&&!Gd(n.expression),this.configDependencies=Kd(n.expression),this.isIndoorDependent=zf(n.expression)}evaluateWithoutErrorHandling(e,n,a,u,p,m){return this._styleExpression.evaluateWithoutErrorHandling(e,n,a,u,p,m)}evaluate(e,n,a,u,p,m,_){return this._styleExpression.evaluate(e,n,a,u,p,m,void 0,void 0,_)}}class gl{constructor(e,n,a,u,p,m){this.kind=e,this.zoomStops=a,this._styleExpression=n,this.isStateDependent=e!=="camera"&&!Gd(n.expression),this.isIndoorDependent=zf(n.expression),this.isLightConstant=p,this.isLineProgressConstant=m,this.configDependencies=Kd(n.expression),this.interpolationType=u}evaluateWithoutErrorHandling(e,n,a,u,p,m){return this._styleExpression.evaluateWithoutErrorHandling(e,n,a,u,p,m)}evaluate(e,n,a,u,p,m){return this._styleExpression.evaluate(e,n,a,u,p,m)}interpolationFactor(e,n,a){return this.interpolationType?Yo.interpolationFactor(this.interpolationType,e,n,a):0}}function Ag(r,e,n,a,u){if((r=pa(r,e,n,a,u)).result==="error")return r;let p=r.value.expression,m=su(p);if(!m&&!Bf(e))return ml([new xs("","data expressions not supported")]);let _=au(p,["zoom","pitch","distance-from-center"]);if(!_&&!Dg(e))return ml([new xs("","zoom expressions not supported")]);let b=au(p,["measure-light"]);if(!b&&!Sg(e))return ml([new xs("","measure-light expression not supported")]);let w=au(p,["line-progress"]);if(!w&&!(function(D){return Ig(D.expression,"line-progress")})(e))return ml([new xs("","line-progress expression not supported")]);let I=e.expression&&e.expression.relaxZoomRestriction,S=qf(p);return S||_||I?S instanceof xs?ml([S]):S instanceof Yo&&!Vf(e)?ml([new xs("",'"interpolate" expressions cannot be used with this property')]):lc(S?new gl(m&&w?"camera":"composite",r.value,S.labels,S instanceof Yo?S.interpolation:void 0,b,w):new Jd(m&&w?"constant":"source",r.value,b,w)):ml([new xs("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Gf{constructor(e,n){this._parameters=e,this._specification=n,Object.assign(this,Uf(this._parameters,this._specification))}static deserialize(e){return new Gf(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function qf(r){let e=null;if(r instanceof Xd)e=qf(r.result);else if(r instanceof Zd){for(let n of r.args)if(e=qf(n),e)break}else(r instanceof qd||r instanceof Yo)&&r.input instanceof no&&r.input.name==="zoom"&&(e=r);return e instanceof xs||r.eachChild(n=>{let a=qf(n);a instanceof xs?e=a:e&&a&&e!==a&&(e=new xs("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Qd,Wf,Yv=(function(){if(Wf)return Qd;Wf=1,Qd=e;var r=3;function e(n,a,u){var p=this.cells=[];if(n instanceof ArrayBuffer){this.arrayBuffer=n;var m=new Int32Array(this.arrayBuffer);n=m[0],this.d=(a=m[1])+2*(u=m[2]);for(var _=0;_<this.d*this.d;_++){var b=m[r+_],w=m[r+_+1];p.push(b===w?null:m.subarray(b,w))}var I=m[r+p.length+1];this.keys=m.subarray(m[r+p.length],I),this.bboxes=m.subarray(I),this.insert=this._insertReadonly}else{this.d=a+2*u;for(var S=0;S<this.d*this.d;S++)p.push([]);this.keys=[],this.bboxes=[]}this.n=a,this.extent=n,this.padding=u,this.scale=a/n,this.uid=0;var D=u/a*n;this.min=-D,this.max=n+D}return e.prototype.insert=function(n,a,u,p,m){this._forEachCell(a,u,p,m,this._insertCell,this.uid++),this.keys.push(n),this.bboxes.push(a),this.bboxes.push(u),this.bboxes.push(p),this.bboxes.push(m)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(n,a,u,p,m,_){this.cells[m].push(_)},e.prototype.query=function(n,a,u,p,m){var _=this.min,b=this.max;if(n<=_&&a<=_&&b<=u&&b<=p&&!m)return Array.prototype.slice.call(this.keys);var w=[];return this._forEachCell(n,a,u,p,this._queryCell,w,{},m),w},e.prototype._queryCell=function(n,a,u,p,m,_,b,w){var I=this.cells[m];if(I!==null)for(var S=this.keys,D=this.bboxes,P=0;P<I.length;P++){var O=I[P];if(b[O]===void 0){var N=4*O;(w?w(D[N+0],D[N+1],D[N+2],D[N+3]):n<=D[N+2]&&a<=D[N+3]&&u>=D[N+0]&&p>=D[N+1])?(b[O]=!0,_.push(S[O])):b[O]=!1}}},e.prototype._forEachCell=function(n,a,u,p,m,_,b,w){for(var I=this._convertToCellCoord(n),S=this._convertToCellCoord(a),D=this._convertToCellCoord(u),P=this._convertToCellCoord(p),O=I;O<=D;O++)for(var N=S;N<=P;N++){var V=this.d*N+O;if((!w||w(this._convertFromCellCoord(O),this._convertFromCellCoord(N),this._convertFromCellCoord(O+1),this._convertFromCellCoord(N+1)))&&m.call(this,n,a,u,p,V,_,b,w))return}},e.prototype._convertFromCellCoord=function(n){return(n-this.padding)/this.scale},e.prototype._convertToCellCoord=function(n){return Math.max(0,Math.min(this.d-1,Math.floor(n*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var n=this.cells,a=r+this.cells.length+1+1,u=0,p=0;p<this.cells.length;p++)u+=this.cells[p].length;var m=new Int32Array(a+u+this.keys.length+this.bboxes.length);m[0]=this.extent,m[1]=this.n,m[2]=this.padding;for(var _=a,b=0;b<n.length;b++){var w=n[b];m[r+b]=_,m.set(w,_),_+=w.length}return m[r+n.length]=_,m.set(this.keys,_),m[r+n.length+1]=_+=this.keys.length,m.set(this.bboxes,_),_+=this.bboxes.length,m.buffer},Qd})(),cc=_d(Yv);let pu={};function vt(r,e,n={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),pu[e]={klass:r,omit:n.omit||[]}}vt(Object,"Object"),cc.serialize=function(r,e){let n=r.toArrayBuffer();return e&&e.add(n),{buffer:n}},cc.deserialize=function(r){return new cc(r.buffer)},Object.defineProperty(cc,"name",{value:"Grid"}),vt(cc,"Grid"),delete Ze.prototype.constructor,typeof DOMMatrix<"u"&&vt(DOMMatrix,"DOMMatrix"),vt(Nn,"Color"),vt(Error,"Error"),vt(Dr,"Formatted"),vt(zd,"FormattedSection"),vt(Ql,"AJAXError"),vt(Eo,"ResolvedImage"),vt(Gf,"StylePropertyFunction"),vt(Hf,"StyleExpression",{omit:["_evaluator"]}),vt(gr,"ImageId"),vt(Oa,"ImageVariant"),vt(gl,"ZoomDependentExpression"),vt(Jd,"ZoomConstantExpression"),vt(no,"CompoundExpression",{omit:["_evaluate"]});for(let r in hu)pu[hu[r]._classRegistryKey]||vt(hu[r],`Expression${r}`);function Mg(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&r.constructor.name==="ArrayBuffer")}function Na(r){return self.ImageBitmap&&r instanceof ImageBitmap}function _l(r,e){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(Mg(r)||Na(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){let n=[];for(let a of r)n.push(_l(a,e));return n}if(r instanceof Map){let n={$name:"Map",entries:[]};for(let[a,u]of r.entries())n.entries.push(_l(a),_l(u,e));return n}if(r instanceof Set){let n={$name:"Set"},a=0;for(let u of r.values())n[++a]=_l(u);return n}if(r instanceof DOMMatrix){let n={$name:"DOMMatrix"},a=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(let u of a)n[u]=r[u];return n}if(typeof r=="bigint")return{$name:"BigInt",value:r.toString()};if(typeof r=="object"){let n=r.constructor,a=n._classRegistryKey;if(!a)throw new Error(`Can't serialize object of unregistered class "${n.name}".`);let u=n.serialize?n.serialize(r,e):{};if(!n.serialize){for(let p in r)r.hasOwnProperty(p)&&(pu[a].omit.indexOf(p)>=0||(u[p]=_l(r[p],e)));r instanceof Error&&(u.message=r.message)}if(u.$name)throw new Error("$name property is reserved for worker serialization logic.");return a!=="Object"&&(u.$name=a),u}throw new Error("can't serialize object of type "+typeof r)}function yl(r){if(r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||Mg(r)||Na(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(yl);if(typeof r=="object"){let e=r.$name||"Object";if(e==="Map"){let u=r.entries||[],p=new Map;for(let m=0;m<u.length;m+=2)p.set(yl(u[m]),yl(u[m+1]));return p}if(e==="Set"){let u=new Set;for(let p of Object.keys(r))p!=="$name"&&u.add(yl(r[p]));return u}if(e==="DOMMatrix"){let u;return u=r.is2D?[r.a,r.b,r.c,r.d,r.e,r.f]:[r.m11,r.m12,r.m13,r.m14,r.m21,r.m22,r.m23,r.m24,r.m31,r.m32,r.m33,r.m34,r.m41,r.m42,r.m43,r.m44],new DOMMatrix(u)}if(e==="BigInt")return BigInt(r.value);let{klass:n}=pu[e];if(!n)throw new Error(`Can't deserialize unregistered class "${e}".`);if(n.deserialize)return n.deserialize(r);let a=Object.create(n.prototype);for(let u of Object.keys(r))u!=="$name"&&(a[u]=yl(r[u]));return a}throw new Error("can't deserialize object of type "+typeof r)}let Pt={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519,Osage:r=>r>=66736&&r<=66815,"CJK Unified Ideographs Extension B":r=>r>=131072&&r<=173791};function Rg(r){for(let e of r)if(Xf(e.charCodeAt(0)))return!0;return!1}function Kv(r){for(let e of r)if(!Zf(e.charCodeAt(0)))return!1;return!0}function Zf(r){return!(Pt.Arabic(r)||Pt["Arabic Supplement"](r)||Pt["Arabic Extended-A"](r)||Pt["Arabic Presentation Forms-A"](r)||Pt["Arabic Presentation Forms-B"](r))}function Xf(r){return!(r!==746&&r!==747&&(r<4352||!(Pt["Bopomofo Extended"](r)||Pt.Bopomofo(r)||Pt["CJK Compatibility Forms"](r)&&!(r>=65097&&r<=65103)||Pt["CJK Compatibility Ideographs"](r)||Pt["CJK Compatibility"](r)||Pt["CJK Radicals Supplement"](r)||Pt["CJK Strokes"](r)||!(!Pt["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||Pt["CJK Unified Ideographs Extension A"](r)||Pt["CJK Unified Ideographs"](r)||Pt["Enclosed CJK Letters and Months"](r)||Pt["Hangul Compatibility Jamo"](r)||Pt["Hangul Jamo Extended-A"](r)||Pt["Hangul Jamo Extended-B"](r)||Pt["Hangul Jamo"](r)||Pt["Hangul Syllables"](r)||Pt.Hiragana(r)||Pt["Ideographic Description Characters"](r)||Pt.Kanbun(r)||Pt["Kangxi Radicals"](r)||Pt["Katakana Phonetic Extensions"](r)||Pt.Katakana(r)&&r!==12540||!(!Pt["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!Pt["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Pt["Unified Canadian Aboriginal Syllabics"](r)||Pt["Unified Canadian Aboriginal Syllabics Extended"](r)||Pt["Vertical Forms"](r)||Pt["Yijing Hexagram Symbols"](r)||Pt["Yi Syllables"](r)||Pt["Yi Radicals"](r))))}function Pg(r){return!(Xf(r)||(function(e){return!!(Pt["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||Pt["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||Pt["Letterlike Symbols"](e)||Pt["Number Forms"](e)||Pt["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||Pt["Control Pictures"](e)&&e!==9251||Pt["Optical Character Recognition"](e)||Pt["Enclosed Alphanumerics"](e)||Pt["Geometric Shapes"](e)||Pt["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||Pt["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Pt["CJK Symbols and Punctuation"](e)||Pt.Katakana(e)||Pt["Private Use Area"](e)||Pt["CJK Compatibility Forms"](e)||Pt["Small Form Variants"](e)||Pt["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)})(r))}function Og(r){return Pt.Arabic(r)||Pt["Arabic Supplement"](r)||Pt["Arabic Extended-A"](r)||Pt["Arabic Presentation Forms-A"](r)||Pt["Arabic Presentation Forms-B"](r)}function Jv(r){return r>=1424&&r<=2303||Pt["Arabic Presentation Forms-A"](r)||Pt["Arabic Presentation Forms-B"](r)}function Z1(r,e){return!(!e&&Jv(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Pt.Khmer(r))}function X1(r){for(let e of r)if(Jv(e.charCodeAt(0)))return!0;return!1}let ko={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"},Lg=null,fo=ko.unavailable,vl=null,Qv=function(r){r&&typeof r=="string"&&r.indexOf("NetworkError")>-1&&(fo=ko.error),Lg&&Lg(r)};function Fg(){kg.fire(new Zo("pluginStateChange",{pluginStatus:fo,pluginURL:vl}))}let kg=new Ra,Ng=function(){return fo},zg=function(){if(fo!==ko.deferred||!vl)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");fo=ko.loading,Fg(),vl&&Zc({url:vl},r=>{r?Qv(r):(fo=ko.loaded,Fg())})},No={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>fo===ko.loaded||No.applyArabicShaping!=null,isLoading:()=>fo===ko.loading,setState(r){fo=r.pluginStatus,vl=r.pluginURL},isParsing:()=>fo===ko.parsing,isParsed:()=>fo===ko.parsed,getPluginURL:()=>vl};class ci{constructor(e,n){this.zoom=e,n?(this.now=n.now,this.fadeDuration=n.fadeDuration,this.transition=n.transition,this.pitch=n.pitch,this.brightness=n.brightness,this.worldview=n.worldview,this.activeFloors=n.activeFloors):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return(function(n,a){for(let u of n)if(!Z1(u.charCodeAt(0),a))return!1;return!0})(e,No.isLoaded())}}class eh{constructor(e,n,a,u,p){this.property=e,this.value=n,this.expression=(function(m,_,b,w,I){if(jf(m))return new Gf(m,_);if($f(m)||Array.isArray(m)&&m.length>0){let S=Ag(m,_,b,w,I);if(S.result==="error")throw new Error(S.value.map(D=>`${D.key}: ${D.message}`).join(", "));return S.value}{let S=m;return typeof m=="string"&&_.type==="color"&&(S=Nn.parse(m)),{kind:"constant",configDependencies:new Set,isIndoorDependent:!1,evaluate:()=>S}}})(n===void 0?e.specification.default:n,e.specification,a,u,p)}isIndoorDependent(){return this.expression.isIndoorDependent}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,n,a,u){return this.property.possiblyEvaluate(this,e,n,a,u)}}class mu{constructor(e,n,a,u){this.property=e,this.value=new eh(e,void 0,n,a,u)}transitioned(e,n){return new t0(this.property,this.value,n,Object.assign({},e.transition,this.transition),e.now)}untransitioned(){return new t0(this.property,this.value,null,{},0)}}class e0{constructor(e,n,a,u){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=n,this._options=a,this._iconImageUseTheme=u,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return St(this._values[e].value.value)}setValue(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new mu(this._values[e].property,this._scope,this._options,this._iconImageUseTheme)),this._values[e].value=new eh(this._values[e].property,n===null?void 0:St(n),this._scope,this._options,this._iconImageUseTheme),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].value.isIndoorDependent())}setTransitionOrValue(e,n){n&&(this._options=n);let a=this._properties.properties;if(e)for(let u in e){let p=e[u];if(u.endsWith("-transition")){let m=u.slice(0,-11);a[m]&&this.setTransition(m,p)}else a.hasOwnProperty(u)&&this.setValue(u,p)}}getTransition(e){return St(this._values[e].transition)}setTransition(e,n){this._values.hasOwnProperty(e)||(this._values[e]=new mu(this._values[e].property)),this._values[e].transition=St(n)||void 0}serialize(){let e={};for(let n of Object.keys(this._values)){let a=this.getValue(n);a!==void 0&&(e[n]=a);let u=this.getTransition(n);u!==void 0&&(e[`${n}-transition`]=u)}return e}transitioned(e,n){let a=new za(this._properties);for(let u of Object.keys(this._values))a._values[u]=this._values[u].transitioned(e,n._values[u]);return a}untransitioned(){let e=new za(this._properties);for(let n of Object.keys(this._values))e._values[n]=this._values[n].untransitioned();return e}isIndoorDependent(){return this._isIndoorDependent}}class t0{constructor(e,n,a,u,p){let m=u.delay||0,_=u.duration||0;p=p||0,this.property=e,this.value=n,this.begin=p+m,this.end=this.begin+_,e.specification.transition&&(u.delay||u.duration)&&(this.prior=a)}possiblyEvaluate(e,n,a){let u=e.now||0,p=this.value.possiblyEvaluate(e,n,a),m=this.prior;if(m){if(u>this.end)return this.prior=null,p;if(this.value.isDataDriven())return this.prior=null,p;if(u<this.begin)return m.possiblyEvaluate(e,n,a);{let _=(u-this.begin)/(this.end-this.begin);return this.property.interpolate(m.possiblyEvaluate(e,n,a),p,xd(_))}}return p}}class za{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,n,a){let u=new uc(this._properties);for(let p of Object.keys(this._values))u._values[p]=this._values[p].possiblyEvaluate(e,n,a);return u}hasTransition(){for(let e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Bg{constructor(e,n,a,u){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=n,this._options=a,this._iconImageUseTheme=u,this._isIndoorDependent=!1,this.configDependencies=new Set}getValue(e){return St(this._values[e].value)}setValue(e,n){this._values[e]=new eh(this._values[e].property,n===null?void 0:St(n),this._scope,this._options,this._iconImageUseTheme),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]),this._isIndoorDependent=this._isIndoorDependent||this._values[e].isIndoorDependent())}serialize(){let e={};for(let n of Object.keys(this._values)){let a=this.getValue(n);a!==void 0&&(e[n]=a)}return e}possiblyEvaluate(e,n,a,u){let p=new uc(this._properties);for(let m of Object.keys(this._values))p._values[m]=this._values[m].possiblyEvaluate(e,n,a,u);return p}isIndoorDependent(){return this._isIndoorDependent}}class Is{constructor(e,n,a,u){this.property=e,this.value=n,this.parameters=a,this.iconImageUseTheme=u}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,n,a,u){return this.property.evaluate(this.value,this.parameters,e,n,a,u,this.iconImageUseTheme)}}class uc{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class Ke{constructor(e){this.specification=e}possiblyEvaluate(e,n){return e.expression.evaluate(n)}interpolate(e,n,a){let u=Pa[this.specification.type];return u?u(e,n,a):e}}class dt{constructor(e,n){this.specification=e,this.overrides=n}possiblyEvaluate(e,n,a,u,p){return e.expression.kind==="constant"||e.expression.kind==="camera"?new Is(this,{kind:"constant",value:e.expression.evaluate(n,null,{},a,u,void 0,p)},n):new Is(this,e.expression,n,p)}interpolate(e,n,a){if(e.value.kind!=="constant"||n.value.kind!=="constant")return e;if(e.value.value===void 0||n.value.value===void 0)return new Is(this,{kind:"constant",value:void 0},e.parameters);let u=Pa[this.specification.type];return u?new Is(this,{kind:"constant",value:u(e.value.value,n.value.value,a)},e.parameters):e}evaluate(e,n,a,u,p,m,_){return e.kind==="constant"?e.value:e.evaluate(n,a,u,p,m,void 0,_)}}class gu{constructor(e){this.specification=e}possiblyEvaluate(e,n,a,u){return!!e.expression.evaluate(n,null,{},a,u)}interpolate(){return!1}}class zi{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let n=new ci(0,{});for(let a in e){let u=e[a];u.specification.overridable&&this.overridableProperties.push(a);let p=this.defaultPropertyValues[a]=new eh(u,void 0),m=this.defaultTransitionablePropertyValues[a]=new mu(u);this.defaultTransitioningPropertyValues[a]=m.untransitioned(),this.defaultPossiblyEvaluatedValues[a]=p.possiblyEvaluate(n)}}}vt(dt,"DataDrivenProperty"),vt(Ke,"DataConstantProperty"),vt(gu,"ColorRampProperty");var Ee=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"modelNodeOverride":{"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360}},"modelNodeOverrides":{"*":{"type":"modelNodeOverride"}},"modelMaterialOverride":{"model-color":{"type":"color"},"model-color-mix-intensity":{"type":"number"},"model-opacity":{"type":"number"},"model-emissive-strength":{"type":"number"}},"modelMaterialOverrides":{"*":{"type":"modelMaterialOverride"}},"modelSourceModel":{"uri":{"type":"string"},"position":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[-180,-90],"maximum":[180,90]},"orientation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360},"nodeOverrides":{"type":"modelNodeOverrides"},"materialOverrides":{"type":"modelMaterialOverrides"},"nodeOverrideNames":{"type":"array","value":"string"},"materialOverrideNames":{"type":"array","value":"string"},"featureProperties":{"type":"*"}},"modelSourceModels":{"*":{"type":"modelSourceModel"}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"},"models":{"type":"modelSourceModels"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"boolean","expression":{"parameters":["zoom","pitch","feature","feature-state","measure-light","distance-from-center"]},"property-type":"data-driven"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-unit-width":{"type":"number","minimum":1,"maximum":20,"default":3.1,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"building-flip-roof-orientation":{"property-type":"data-driven","type":"boolean","default":false,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"use-theme":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":[0.1,0.1],"maximum":[10,10],"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor_source":{"sourceId":{"type":"string"},"sourceLayers":{"type":"array","value":"string"}},"indoor":{"*":{"type":"indoor_source"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"building-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"building-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]},"model-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{}}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Vg(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function _u(r){if(Array.isArray(r))return r.map(_u);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){let e={};for(let n in r)e[n]=_u(r[n]);return e}return Vg(r)}function yu(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":return r.length>=2&&r[1]!=="$id"&&r[1]!=="$type";case"in":return r.length>=3&&(typeof r[1]!="string"||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return r.length!==3||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(let e of r.slice(1))if(!yu(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Yf(r,e="",n=null,a="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};yu(r)||(r=Ko(r));let u=r,p=!0;try{p=(function(I){if(!xu(I))return I;let S=_u(I);return vu(S),S=Kf(S),S})(u)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(u,null,2)}
        `)}let m=null,_=null;if(a!=="background"&&a!=="sky"&&a!=="slot"){_=Ee[`filter_${a}`];let I=pa(p,_,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));m=(S,D,P)=>I.value.evaluate(S,D,{},P)}let b=null,w=null;if(p!==u){let I=pa(u,_,e,n);if(I.result==="error")throw new Error(I.value.map(S=>`${S.key}: ${S.message}`).join(", "));b=(S,D,P,O,N)=>I.value.evaluate(S,D,{},P,void 0,void 0,O,N),w=!su(I.value.expression)}return{filter:m,dynamicFilter:b||void 0,needGeometry:i0(p),needFeature:!!w}}function Kf(r){if(!Array.isArray(r))return r;let e=(function(n){if(Y1.has(n[0])){for(let a=1;a<n.length;a++)if(xu(n[a]))return!0}return n})(r);return e===!0?e:e.map(n=>Kf(n))}function vu(r){let e=!1,n=[];if(r[0]==="case"){for(let a=1;a<r.length-1;a+=2)e=e||xu(r[a]),n.push(r[a+1]);n.push(r[r.length-1])}else if(r[0]==="match"){e=e||xu(r[1]);for(let a=2;a<r.length-1;a+=2)n.push(r[a+1]);n.push(r[r.length-1])}else if(r[0]==="step"){e=e||xu(r[1]);for(let a=1;a<r.length-1;a+=2)n.push(r[a+1])}e&&(r.length=0,r.push("any",...n));for(let a=1;a<r.length;a++)vu(r[a])}function xu(r){if(!Array.isArray(r))return!1;if((e=r[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let n=1;n<r.length;n++)if(xu(r[n]))return!0;return!1}let Y1=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function n0(r,e){return r<e?-1:r>e?1:0}function i0(r){if(!Array.isArray(r))return!1;if(r[0]==="within"||r[0]==="distance")return!0;for(let e=1;e<r.length;e++)if(i0(r[e]))return!0;return!1}function Ko(r){if(!r)return!0;let e=r[0];return r.length<=1?e!=="any":e==="=="?jg(r[1],r[2],"=="):e==="!="?Jf(jg(r[1],r[2],"==")):e==="<"||e===">"||e==="<="||e===">="?jg(r[1],r[2],e):e==="any"?(n=r.slice(1),["any"].concat(n.map(Ko))):e==="all"?["all"].concat(r.slice(1).map(Ko)):e==="none"?["all"].concat(r.slice(1).map(Ko).map(Jf)):e==="in"?Ug(r[1],r.slice(2)):e==="!in"?Jf(Ug(r[1],r.slice(2))):e==="has"?r0(r[1]):e!=="!has"||Jf(r0(r[1]));var n}function jg(r,e,n){switch(r){case"$type":return[`filter-type-${n}`,e];case"$id":return[`filter-id-${n}`,e];default:return[`filter-${n}`,r,e]}}function Ug(r,e){if(e.length===0)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(n=>typeof n!=typeof e[0])?["filter-in-large",r,["literal",e.sort(n0)]]:["filter-in-small",r,["literal",e]]}}function r0(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function Jf(r){return["!",r]}let th="";function dc(r,e){return e?`${r}${th}${e}`:r}let o0,s0=()=>o0||(o0=new zi({"icon-size":new dt(Ee.layout_symbol["icon-size"]),"icon-image":new dt(Ee.layout_symbol["icon-image"]),"icon-rotate":new dt(Ee.layout_symbol["icon-rotate"]),"icon-offset":new dt(Ee.layout_symbol["icon-offset"])}));class K1{constructor(e,n,a,u,p,m){this.cachedIconPrimary=null;let _=pa(e,Ee.appearance.condition);if(_.result==="success"&&(this.condition=_.value),this.name=n,a){this.properties=new uc(s0()),this.unevaluatedLayout=new Bg(s0(),u,p,m);for(let b in a)this.unevaluatedLayout.setValue(b,a[b])}}hasCachedIconPrimary(){return this.cachedIconPrimary!==null}setCachedIconPrimary(e){this.cachedIconPrimary=e}getCachedIconPrimary(){return this.cachedIconPrimary}isActive(e){return!(this.condition||!e.isHidden||this.name!=="hidden")||this.condition.evaluate(e.globals,e.feature,e.featureState,e.canonical)}getCondition(){return this.condition}getName(){return this.name}getProperty(e){return this.properties.get(e)}getUnevaluatedProperties(){return this.unevaluatedLayout}recalculate(e,n,a){this.unevaluatedLayout&&(this.properties=this.unevaluatedLayout.possiblyEvaluate(e,void 0,n,a))}serialize(){let e={};return e.condition=this.condition.expression.serialize(),this.name&&(e.name=this.name),this.unevaluatedLayout&&(e.properties=this.unevaluatedLayout.serialize()),e}}let a0="-transition",J1=new Set(["fill","line","background","hillshade","raster"]);class io extends Ra{constructor(e,n,a,u,p,m){if(super(),this.id=e.id,this.fqid=dc(this.id,a),this.type=e.type,this.scope=a,this.lut=u,this.options=p,this.iconImageUseTheme=m,this.appearances=new Array,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.expressionDependencies={isIndoorDependent:!1,configDependencies:new Set},e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;let _=pa(this.filter,Ee[`filter_${e.type}`]);_.result!=="error"&&(this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,..._.value.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||_.value.isIndoorDependent)}if(e.slot&&(this.slot=e.slot),e.appearances&&this.setAppearances(e.appearances),n.layout&&(this._unevaluatedLayout=new Bg(n.layout,this.scope,p,this.iconImageUseTheme),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._unevaluatedLayout.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._unevaluatedLayout.isIndoorDependent()),n.paint){this._transitionablePaint=new e0(n.paint,this.scope,p);for(let _ in e.paint)this.setPaintProperty(_,e.paint[_]);for(let _ in e.layout)this.setLayoutProperty(_,e.layout[_]);this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...this._transitionablePaint.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||this._transitionablePaint.isIndoorDependent(),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new uc(n.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&J1.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,n){if(this.type==="custom"&&e==="visibility")return void(this.visibility=n);let a=this._unevaluatedLayout;a._properties.properties[e]&&(a.setValue(e,n),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...a.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||a.isIndoorDependent(),e==="visibility"&&this.possiblyEvaluateVisibility())}setAppearances(e){this.appearances=[],e.forEach(n=>{this.appearances.push(new K1(n.condition,n.name,n.properties,this.scope,this.options,this.iconImageUseTheme))})}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(a0)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}isPaintProperty(e){return!!this._transitionablePaint._properties.properties[e]}setPaintProperty(e,n){let a=this._transitionablePaint,u=a._properties.properties;if(e.endsWith(a0)){let S=e.slice(0,-11);return u[S]&&a.setTransition(S,n||void 0),!1}if(!u[e])return!1;let p=a._values[e],m=p.value.isDataDriven(),_=p.value;a.setValue(e,n),this.expressionDependencies.configDependencies=new Set([...this.expressionDependencies.configDependencies,...a.configDependencies]),this.expressionDependencies.isIndoorDependent=this.expressionDependencies.isIndoorDependent||a.isIndoorDependent(),this._handleSpecialPaintPropertyUpdate(e);let b=a._values[e].value,w=b.isDataDriven(),I=e.endsWith("pattern")||e==="line-dasharray";return w||m||I||this._handleOverridablePaintPropertyUpdate(e,_,b)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,n,a){return null}_handleOverridablePaintPropertyUpdate(e,n,a){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,n){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,n,this.iconImageUseTheme)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,n)}serialize(){let e={id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.appearances.length!==0&&(e.appearances=this.appearances.map(n=>n.serialize())),We(e,(n,a)=>!(n===void 0||a==="layout"&&!Object.keys(n).length||a==="paint"&&!Object.keys(n).length))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(let e in this.paint._values){let n=this.paint.get(e);if(n instanceof Is&&Bf(n.property.specification)&&(n.value.kind==="source"||n.value.kind==="composite")&&n.value.isStateDependent)return!0}for(let e of this.appearances)if(!Gd(e.condition.expression))return!0;return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Yf(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}getAppearances(){return this.appearances}queryRenderedFeatures(e,n,a){return{}}queryRadius(e){}queryIntersectsFeature(e,n,a,u,p,m,_,b,w){}}let Q1={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class nh{constructor(e,n){this._structArray=e,this._pos1=n*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class mi{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,n){return e._trim(),n&&n.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){let n=Object.create(this.prototype);return n.arrayBuffer=e.arrayBuffer,n.length=e.length,n.capacity=e.arrayBuffer.byteLength/n.bytesPerElement,n._refreshViews(),n}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let n=this.uint8;this._refreshViews(),n&&this.uint8.set(n)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function hn(r,e=1){let n=0,a=0;return{members:r.map(u=>{let p=Q1[u.type].BYTES_PER_ELEMENT,m=n=Hg(n,Math.max(e,p)),_=u.components||1;return a=Math.max(a,p),n+=p*_,{name:u.name,type:u.type,components:_,offset:m}}),size:Hg(n,Math.max(a,e)),alignment:e}}function Hg(r,e){return Math.ceil(r/e)*e}class To extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n){let a=this.length;return this.resize(a+1),this.emplace(a,e,n)}emplace(e,n,a){let u=2*e;return this.int16[u+0]=n,this.int16[u+1]=a,e}}To.prototype.bytesPerElement=4,vt(To,"StructArrayLayout2i4");class hc extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a){let u=this.length;return this.resize(u+1),this.emplace(u,e,n,a)}emplace(e,n,a,u){let p=3*e;return this.int16[p+0]=n,this.int16[p+1]=a,this.int16[p+2]=u,e}}hc.prototype.bytesPerElement=6,vt(hc,"StructArrayLayout3i6");class bu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,u){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,a,u)}emplace(e,n,a,u,p){let m=4*e;return this.int16[m+0]=n,this.int16[m+1]=a,this.int16[m+2]=u,this.int16[m+3]=p,e}}bu.prototype.bytesPerElement=8,vt(bu,"StructArrayLayout4i8");class Ba extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.float32[1*e+0]=n,e}}Ba.prototype.bytesPerElement=4,vt(Ba,"StructArrayLayout1f4");class $g extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a){let u=this.length;return this.resize(u+1),this.emplace(u,e,n,a)}emplace(e,n,a,u){let p=4*e,m=2*e;return this.int16[p+0]=n,this.int16[p+1]=a,this.float32[m+1]=u,e}}$g.prototype.bytesPerElement=8,vt($g,"StructArrayLayout2i1f8");class Gg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a){let u=this.length;return this.resize(u+1),this.emplace(u,e,n,a)}emplace(e,n,a,u){let p=4*e;return this.int16[p+0]=n,this.int16[p+1]=a,this.int16[p+2]=u,e}}Gg.prototype.bytesPerElement=8,vt(Gg,"StructArrayLayout3i8");class Qf extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,a,u,p)}emplace(e,n,a,u,p,m){let _=5*e;return this.int16[_+0]=n,this.int16[_+1]=a,this.int16[_+2]=u,this.int16[_+3]=p,this.int16[_+4]=m,e}}Qf.prototype.bytesPerElement=10,vt(Qf,"StructArrayLayout5i10");class ep extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,a,u,p,m,_)}emplace(e,n,a,u,p,m,_,b){let w=6*e,I=12*e,S=3*e;return this.int16[w+0]=n,this.int16[w+1]=a,this.uint8[I+4]=u,this.uint8[I+5]=p,this.uint8[I+6]=m,this.uint8[I+7]=_,this.float32[S+2]=b,e}}ep.prototype.bytesPerElement=12,vt(ep,"StructArrayLayout2i4ub1f12");class Jo extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a){let u=this.length;return this.resize(u+1),this.emplace(u,e,n,a)}emplace(e,n,a,u){let p=3*e;return this.float32[p+0]=n,this.float32[p+1]=a,this.float32[p+2]=u,e}}Jo.prototype.bytesPerElement=12,vt(Jo,"StructArrayLayout3f12");class xl extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,a,u,p)}emplace(e,n,a,u,p,m){let _=6*e,b=3*e;return this.uint16[_+0]=n,this.uint16[_+1]=a,this.uint16[_+2]=u,this.uint16[_+3]=p,this.float32[b+2]=m,e}}xl.prototype.bytesPerElement=12,vt(xl,"StructArrayLayout4ui1f12");class fc extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,u){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,a,u)}emplace(e,n,a,u,p){let m=4*e;return this.uint16[m+0]=n,this.uint16[m+1]=a,this.uint16[m+2]=u,this.uint16[m+3]=p,e}}fc.prototype.bytesPerElement=8,vt(fc,"StructArrayLayout4ui8");class tp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,a,u,p,m)}emplace(e,n,a,u,p,m,_){let b=6*e;return this.int16[b+0]=n,this.int16[b+1]=a,this.int16[b+2]=u,this.int16[b+3]=p,this.int16[b+4]=m,this.int16[b+5]=_,e}}tp.prototype.bytesPerElement=12,vt(tp,"StructArrayLayout6i12");class np extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w,I,S,D){let P=this.length;return this.resize(P+1),this.emplace(P,e,n,a,u,p,m,_,b,w,I,S,D)}emplace(e,n,a,u,p,m,_,b,w,I,S,D,P){let O=12*e;return this.int16[O+0]=n,this.int16[O+1]=a,this.int16[O+2]=u,this.int16[O+3]=p,this.uint16[O+4]=m,this.uint16[O+5]=_,this.uint16[O+6]=b,this.uint16[O+7]=w,this.int16[O+8]=I,this.int16[O+9]=S,this.int16[O+10]=D,this.int16[O+11]=P,e}}np.prototype.bytesPerElement=24,vt(np,"StructArrayLayout4i4ui4i24");class wu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,a,u,p,m)}emplace(e,n,a,u,p,m,_){let b=10*e,w=5*e;return this.int16[b+0]=n,this.int16[b+1]=a,this.int16[b+2]=u,this.float32[w+2]=p,this.float32[w+3]=m,this.float32[w+4]=_,e}}wu.prototype.bytesPerElement=20,vt(wu,"StructArrayLayout3i3f20");class bl extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,a,u)}emplace(e,n,a,u,p){let m=4*e;return this.float32[m+0]=n,this.float32[m+1]=a,this.float32[m+2]=u,this.float32[m+3]=p,e}}bl.prototype.bytesPerElement=16,vt(bl,"StructArrayLayout4f16");class qg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint32[1*e+0]=n,e}}qg.prototype.bytesPerElement=4,vt(qg,"StructArrayLayout1ul4");class Ss extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n){let a=this.length;return this.resize(a+1),this.emplace(a,e,n)}emplace(e,n,a){let u=2*e;return this.uint16[u+0]=n,this.uint16[u+1]=a,e}}Ss.prototype.bytesPerElement=4,vt(Ss,"StructArrayLayout2ui4");class Wg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w,I,S,D,P){let O=this.length;return this.resize(O+1),this.emplace(O,e,n,a,u,p,m,_,b,w,I,S,D,P)}emplace(e,n,a,u,p,m,_,b,w,I,S,D,P,O){let N=20*e,V=10*e;return this.int16[N+0]=n,this.int16[N+1]=a,this.int16[N+2]=u,this.int16[N+3]=p,this.int16[N+4]=m,this.float32[V+3]=_,this.float32[V+4]=b,this.float32[V+5]=w,this.float32[V+6]=I,this.int16[N+14]=S,this.uint32[V+8]=D,this.uint16[N+18]=P,this.uint16[N+19]=O,e}}Wg.prototype.bytesPerElement=40,vt(Wg,"StructArrayLayout5i4f1i1ul2ui40");class ip extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,a,u,p,m,_)}emplace(e,n,a,u,p,m,_,b){let w=8*e;return this.int16[w+0]=n,this.int16[w+1]=a,this.int16[w+2]=u,this.int16[w+4]=p,this.int16[w+5]=m,this.int16[w+6]=_,this.int16[w+7]=b,e}}ip.prototype.bytesPerElement=16,vt(ip,"StructArrayLayout3i2i2i16");class Eu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,a,u,p)}emplace(e,n,a,u,p,m){let _=4*e,b=8*e;return this.float32[_+0]=n,this.float32[_+1]=a,this.float32[_+2]=u,this.int16[b+6]=p,this.int16[b+7]=m,e}}Eu.prototype.bytesPerElement=16,vt(Eu,"StructArrayLayout2f1f2i16");class Tu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,a,u,p,m)}emplace(e,n,a,u,p,m,_){let b=20*e,w=5*e;return this.uint8[b+0]=n,this.uint8[b+1]=a,this.float32[w+1]=u,this.float32[w+2]=p,this.float32[w+3]=m,this.float32[w+4]=_,e}}Tu.prototype.bytesPerElement=20,vt(Tu,"StructArrayLayout2ub4f20");class wi extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a){let u=this.length;return this.resize(u+1),this.emplace(u,e,n,a)}emplace(e,n,a,u){let p=3*e;return this.uint16[p+0]=n,this.uint16[p+1]=a,this.uint16[p+2]=u,e}}wi.prototype.bytesPerElement=6,vt(wi,"StructArrayLayout3ui6");class Iu extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le){let re=this.length;return this.resize(re+1),this.emplace(re,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le)}emplace(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le,re){let de=30*e,pe=15*e,ge=60*e;return this.int16[de+0]=n,this.int16[de+1]=a,this.int16[de+2]=u,this.float32[pe+2]=p,this.float32[pe+3]=m,this.uint16[de+8]=_,this.uint16[de+9]=b,this.uint32[pe+5]=w,this.uint32[pe+6]=I,this.uint32[pe+7]=S,this.uint16[de+16]=D,this.uint16[de+17]=P,this.uint16[de+18]=O,this.float32[pe+10]=N,this.float32[pe+11]=V,this.uint8[ge+48]=U,this.uint8[ge+49]=W,this.uint8[ge+50]=X,this.uint32[pe+13]=K,this.int16[de+28]=le,this.uint8[ge+58]=re,e}}Iu.prototype.bytesPerElement=60,vt(Iu,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Zg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le,re,de,pe,ge,Le,Te,ke,je,$e,nt,Ye,Ue){let Xe=this.length;return this.resize(Xe+1),this.emplace(Xe,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le,re,de,pe,ge,Le,Te,ke,je,$e,nt,Ye,Ue)}emplace(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le,re,de,pe,ge,Le,Te,ke,je,$e,nt,Ye,Ue,Xe){let Re=20*e,Ae=40*e,qe=80*e;return this.float32[Re+0]=n,this.float32[Re+1]=a,this.int16[Ae+4]=u,this.int16[Ae+5]=p,this.int16[Ae+6]=m,this.int16[Ae+7]=_,this.int16[Ae+8]=b,this.int16[Ae+9]=w,this.int16[Ae+10]=I,this.int16[Ae+11]=S,this.int16[Ae+12]=D,this.uint16[Ae+13]=P,this.uint16[Ae+14]=O,this.uint16[Ae+15]=N,this.uint16[Ae+16]=V,this.uint16[Ae+17]=U,this.uint16[Ae+18]=W,this.uint16[Ae+19]=X,this.uint16[Ae+20]=K,this.uint16[Ae+21]=le,this.uint16[Ae+22]=re,this.uint16[Ae+23]=de,this.uint16[Ae+24]=pe,this.uint16[Ae+25]=ge,this.uint16[Ae+26]=Le,this.uint16[Ae+27]=Te,this.uint32[Re+14]=ke,this.float32[Re+15]=je,this.float32[Re+16]=$e,this.float32[Re+17]=nt,this.float32[Re+18]=Ye,this.uint8[qe+76]=Ue,this.uint16[Ae+39]=Xe,e}}Zg.prototype.bytesPerElement=80,vt(Zg,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Xg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m){let _=this.length;return this.resize(_+1),this.emplace(_,e,n,a,u,p,m)}emplace(e,n,a,u,p,m,_){let b=6*e;return this.float32[b+0]=n,this.float32[b+1]=a,this.float32[b+2]=u,this.float32[b+3]=p,this.float32[b+4]=m,this.float32[b+5]=_,e}}Xg.prototype.bytesPerElement=24,vt(Xg,"StructArrayLayout6f24");class pc extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p){let m=this.length;return this.resize(m+1),this.emplace(m,e,n,a,u,p)}emplace(e,n,a,u,p,m){let _=5*e;return this.float32[_+0]=n,this.float32[_+1]=a,this.float32[_+2]=u,this.float32[_+3]=p,this.float32[_+4]=m,e}}pc.prototype.bytesPerElement=20,vt(pc,"StructArrayLayout5f20");class Yg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,a,u,p,m,_)}emplace(e,n,a,u,p,m,_,b){let w=7*e;return this.float32[w+0]=n,this.float32[w+1]=a,this.float32[w+2]=u,this.float32[w+3]=p,this.float32[w+4]=m,this.float32[w+5]=_,this.float32[w+6]=b,e}}Yg.prototype.bytesPerElement=28,vt(Yg,"StructArrayLayout7f28");class ih extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w,I,S){let D=this.length;return this.resize(D+1),this.emplace(D,e,n,a,u,p,m,_,b,w,I,S)}emplace(e,n,a,u,p,m,_,b,w,I,S,D){let P=11*e;return this.float32[P+0]=n,this.float32[P+1]=a,this.float32[P+2]=u,this.float32[P+3]=p,this.float32[P+4]=m,this.float32[P+5]=_,this.float32[P+6]=b,this.float32[P+7]=w,this.float32[P+8]=I,this.float32[P+9]=S,this.float32[P+10]=D,e}}ih.prototype.bytesPerElement=44,vt(ih,"StructArrayLayout11f44");class Kg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w){let I=this.length;return this.resize(I+1),this.emplace(I,e,n,a,u,p,m,_,b,w)}emplace(e,n,a,u,p,m,_,b,w,I){let S=9*e;return this.float32[S+0]=n,this.float32[S+1]=a,this.float32[S+2]=u,this.float32[S+3]=p,this.float32[S+4]=m,this.float32[S+5]=_,this.float32[S+6]=b,this.float32[S+7]=w,this.float32[S+8]=I,e}}Kg.prototype.bytesPerElement=36,vt(Kg,"StructArrayLayout9f36");class wl extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n){let a=this.length;return this.resize(a+1),this.emplace(a,e,n)}emplace(e,n,a){let u=2*e;return this.float32[u+0]=n,this.float32[u+1]=a,e}}wl.prototype.bytesPerElement=8,vt(wl,"StructArrayLayout2f8");class Jg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,n,a,u){let p=this.length;return this.resize(p+1),this.emplace(p,e,n,a,u)}emplace(e,n,a,u,p){let m=6*e;return this.uint32[3*e+0]=n,this.uint16[m+2]=a,this.uint16[m+3]=u,this.uint16[m+4]=p,e}}Jg.prototype.bytesPerElement=12,vt(Jg,"StructArrayLayout1ul3ui12");class rp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint16[1*e+0]=n,e}}rp.prototype.bytesPerElement=2,vt(rp,"StructArrayLayout1ui2");class op extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V){let U=this.length;return this.resize(U+1),this.emplace(U,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V)}emplace(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U){let W=16*e;return this.float32[W+0]=n,this.float32[W+1]=a,this.float32[W+2]=u,this.float32[W+3]=p,this.float32[W+4]=m,this.float32[W+5]=_,this.float32[W+6]=b,this.float32[W+7]=w,this.float32[W+8]=I,this.float32[W+9]=S,this.float32[W+10]=D,this.float32[W+11]=P,this.float32[W+12]=O,this.float32[W+13]=N,this.float32[W+14]=V,this.float32[W+15]=U,e}}op.prototype.bytesPerElement=64,vt(op,"StructArrayLayout16f64");class Su extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,n,a,u,p,m,_){let b=this.length;return this.resize(b+1),this.emplace(b,e,n,a,u,p,m,_)}emplace(e,n,a,u,p,m,_,b){let w=10*e,I=5*e;return this.uint16[w+0]=n,this.uint16[w+1]=a,this.uint16[w+2]=u,this.uint16[w+3]=p,this.float32[I+2]=m,this.float32[I+3]=_,this.float32[I+4]=b,e}}Su.prototype.bytesPerElement=20,vt(Su,"StructArrayLayout4ui3f20");class Qg extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.int16[1*e+0]=n,e}}Qg.prototype.bytesPerElement=2,vt(Qg,"StructArrayLayout1i2");class sp extends mi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){let n=this.length;return this.resize(n+1),this.emplace(n,e)}emplace(e,n){return this.uint8[1*e+0]=n,e}}sp.prototype.bytesPerElement=1,vt(sp,"StructArrayLayout1ub1");class e_ extends nh{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}e_.prototype.size=40;class l0 extends Wg{get(e){return new e_(this,e)}}vt(l0,"CollisionBoxArray");class ap extends nh{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}ap.prototype.size=60;class rh extends Iu{get(e){return new ap(this,e)}}vt(rh,"PlacedSymbolArray");class t_ extends nh{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}t_.prototype.size=80;class c0 extends Zg{get(e){return new t_(this,e)}}vt(c0,"SymbolInstanceArray");class n_ extends Ba{getoffsetX(e){return this.float32[1*e+0]}}vt(n_,"GlyphOffsetArray");class u0 extends To{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}vt(u0,"SymbolLineVertexArray");class lp extends nh{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}lp.prototype.size=12;class d0 extends Jg{get(e){return new lp(this,e)}}vt(d0,"FeatureIndexArray");class h0 extends Ss{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}vt(h0,"FillExtrusionCentroidArray");class f0 extends nh{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}f0.prototype.size=6;class p0 extends hc{get(e){return new f0(this,e)}}vt(p0,"FillExtrusionWallArray");let m0=hn([{name:"a_pos",components:2,type:"Int16"}],4),eE=hn([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),tE=hn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Ci{constructor(e=[]){this.segments=e}_prepareSegment(e,n,a,u){let p=this.segments[this.segments.length-1];return e>Ci.MAX_VERTEX_ARRAY_LENGTH&&Rt(`Max vertices per segment is ${Ci.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!p||p.vertexLength+e>Ci.MAX_VERTEX_ARRAY_LENGTH||p.sortKey!==u)&&(p={vertexOffset:n,primitiveOffset:a,vertexLength:0,primitiveLength:0},u!==void 0&&(p.sortKey=u),this.segments.push(p)),p}prepareSegment(e,n,a,u){return this._prepareSegment(e,n.length,a.length,u)}get(){return this.segments}destroy(){for(let e of this.segments)for(let n in e.vaos)e.vaos[n].destroy()}static simpleSegment(e,n,a,u){return new Ci([{vertexOffset:e,primitiveOffset:n,vertexLength:a,primitiveLength:u,vaos:{},sortKey:0}])}}function g0(r,e){return 256*(r=G(Math.floor(r),0,255))+G(Math.floor(e),0,255)}Ci.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,vt(Ci,"SegmentVector");let nE=hn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),iE=hn([{name:"a_pattern_b",components:4,type:"Uint16"}]),rE=hn([{name:"a_dash",components:4,type:"Uint16"}]);class oh{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,n,a,u){this.ids.push(sh(e)),this.positions.push(n,a,u)}eachPosition(e,n){let a=sh(e),u=0,p=this.ids.length-1;for(;u<p;){let m=u+p>>1;this.ids[m]>=a?p=m:u=m+1}for(;this.ids[u]===a;)n(this.positions[3*u],this.positions[3*u+1],this.positions[3*u+2]),u++}static serialize(e,n){let a=new Float64Array(e.ids),u=new Uint32Array(e.positions);return i_(a,u,0,a.length-1),n&&(n.add(a.buffer),n.add(u.buffer)),{ids:a,positions:u}}static deserialize(e){let n=new oh,a;n.ids=e.ids,n.positions=e.positions;for(let u of n.ids)u!==a&&n.uniqueIds.push(u),a=u;return n.indexed=!0,n}}function sh(r){let e=+r;return Number.isSafeInteger(e)?e:Md(String(r))}function i_(r,e,n,a){for(;n<a;){let u=r[n+a>>1],p=n-1,m=a+1;for(;;){do p++;while(r[p]<u);do m--;while(r[m]>u);if(p>=m)break;cp(r,p,m),cp(e,3*p,3*m),cp(e,3*p+1,3*m+1),cp(e,3*p+2,3*m+2)}m-n<a-m?(i_(r,e,n,m),n=m+1):(i_(r,e,m+1,a),a=m)}}function cp(r,e,n){let a=r[e];r[e]=r[n],r[n]=a}vt(oh,"FeaturePositionMap");class Ds{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,n){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,n),this.initialized=!0),!!this.location}set(e,n,a){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class up extends Ds{constructor(e){super(e),this.current=0}set(e,n,a){this.fetchUniformLocation(e,n)&&this.current!==a&&(this.current=a,this.gl.uniform1i(this.location,a))}}class nr extends Ds{constructor(e){super(e),this.current=0}set(e,n,a){this.fetchUniformLocation(e,n)&&this.current!==a&&(this.current=a,this.gl.uniform1f(this.location,a))}}class ma extends Ds{constructor(e){super(e),this.current=[0,0]}set(e,n,a){this.fetchUniformLocation(e,n)&&(a[0]===this.current[0]&&a[1]===this.current[1]||(this.current=a,this.gl.uniform2f(this.location,a[0],a[1])))}}class Du extends Ds{constructor(e){super(e),this.current=[0,0,0]}set(e,n,a){this.fetchUniformLocation(e,n)&&(a[0]===this.current[0]&&a[1]===this.current[1]&&a[2]===this.current[2]||(this.current=a,this.gl.uniform3f(this.location,a[0],a[1],a[2])))}}class ah extends Ds{constructor(e){super(e),this.current=[0,0,0,0]}set(e,n,a){this.fetchUniformLocation(e,n)&&(a[0]===this.current[0]&&a[1]===this.current[1]&&a[2]===this.current[2]&&a[3]===this.current[3]||(this.current=a,this.gl.uniform4f(this.location,a[0],a[1],a[2],a[3])))}}class r_ extends Ds{constructor(e){super(e),this.current=Nn.transparent.toPremultipliedRenderColor(null)}set(e,n,a){this.fetchUniformLocation(e,n)&&(a.r===this.current.r&&a.g===this.current.g&&a.b===this.current.b&&a.a===this.current.a||(this.current=a,this.gl.uniform4f(this.location,a.r,a.g,a.b,a.a)))}}let _0=new Float32Array(16);class lh extends Ds{constructor(e){super(e),this.current=_0}set(e,n,a){if(this.fetchUniformLocation(e,n)){if(a[12]!==this.current[12]||a[0]!==this.current[0])return this.current=a,void this.gl.uniformMatrix4fv(this.location,!1,a);for(let u=1;u<16;u++)if(a[u]!==this.current[u]){this.current=a,this.gl.uniformMatrix4fv(this.location,!1,a);break}}}}let oE=new Float32Array(9),y0=new Float32Array(4);class o_ extends Ds{constructor(e){super(e),this.current=y0}set(e,n,a){if(this.fetchUniformLocation(e,n)){for(let u=0;u<4;u++)if(a[u]!==this.current[u]){this.current=a,this.gl.uniformMatrix2fv(this.location,!1,a);break}}}}function s_(r){return[g0(255*r.r,255*r.g),g0(255*r.b,255*r.a)]}function dp(r,e,n,a,u,p,m,_){return!!r&&(r.kind==="composite"||r.kind==="source"?r.evaluate(new ci(0,{brightness:p,worldview:_}),e,n,u,a,m)==="none":r.value==="none")}class hp{constructor(e,n,a,u){this.value=e,this.uniformNames=n.map(p=>`u_${p}`),this.type=a,this.context=u}setUniform(e,n,a,u,p){let m=u.constantOr(this.value);n.set(e,p,m instanceof Nn?m.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.kind==="constant"&&this.lutExpression.value==="none"?null:this.context.lut):m)}getBinding(e,n){return this.type==="color"?new r_(e):new nr(e)}}class ch{constructor(e,n){this.uniformNames=n.map(a=>`u_${a}`),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,n){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=n?n.tl.concat(n.br):this.pattern}setUniform(e,n,a,u,p){let m=null;p!=="u_pattern"&&p!=="u_dash"||(m=this.pattern),p==="u_pattern_b"&&(m=this.patternTransition),p==="u_pixel_ratio"&&(m=this.pixelRatio),m&&n.set(e,p,m)}getBinding(e,n){return n==="u_pattern"||n==="u_pattern_b"||n==="u_dash"?new ah(e):new nr(e)}}class Va{constructor(e,n,a,u){this.expression=e,this.type=a,this.maxValue=0,this.paintVertexAttributes=n.map(p=>({name:`a_${p}`,type:"Float32",components:a==="color"?2:1,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,n,a,u,p,m,_,b){let w=this.paintVertexArray.length,I=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new ci(0,{brightness:m,worldview:b}),n,{},p,u,_):this.expression.kind==="constant"&&this.expression.value,S=dp(this.lutExpression,n,{},u,p,m,_,b);this.paintVertexArray.resize(e),this._setPaintValue(w,e,I,S?null:this.context.lut)}updatePaintArray(e,n,a,u,p,m,_,b){let w=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:_,worldview:b},a,u,void 0,p):this.expression.kind==="constant"&&this.expression.value,I=dp(this.lutExpression,a,u,p,void 0,_,void 0,b);this._setPaintValue(e,n,w,I?null:this.context.lut)}_setPaintValue(e,n,a,u){if(this.type==="color"){let p=s_(a.toPremultipliedRenderColor(u));for(let m=e;m<n;m++)this.paintVertexArray.emplace(m,p[0],p[1])}else{for(let p=e;p<n;p++)this.paintVertexArray.emplace(p,a);this.maxValue=Math.max(this.maxValue,Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class $s{constructor(e,n,a,u,p,m){this.expression=e,this.uniformNames=n.map(_=>`u_${_}_t`),this.type=a,this.useIntegerZoom=u,this.context=p,this.maxValue=0,this.paintVertexAttributes=n.map(_=>({name:`a_${_}`,type:"Float32",components:a==="color"?4:2,offset:0})),this.paintVertexArray=new m}populatePaintArray(e,n,a,u,p,m,_,b){let w=this.expression.evaluate(new ci(this.context.zoom,{brightness:m,worldview:b}),n,{},p,u,_),I=this.expression.evaluate(new ci(this.context.zoom+1,{brightness:m,worldview:b}),n,{},p,u,_),S=dp(this.lutExpression,n,{},u,p,m,_,b),D=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(D,e,w,I,S?null:this.context.lut)}updatePaintArray(e,n,a,u,p,m,_,b){let w=this.expression.evaluate({zoom:this.context.zoom,brightness:_,worldview:b},a,u,void 0,p),I=this.expression.evaluate({zoom:this.context.zoom+1,brightness:_,worldview:b},a,u,void 0,p),S=dp(this.lutExpression,a,u,p,void 0,_,void 0,b);this._setPaintValue(e,n,w,I,S?null:this.context.lut)}_setPaintValue(e,n,a,u,p){if(this.type==="color"){let m=s_(a.toPremultipliedRenderColor(p)),_=s_(a.toPremultipliedRenderColor(p));for(let b=e;b<n;b++)this.paintVertexArray.emplace(b,m[0],m[1],_[0],_[1])}else{for(let m=e;m<n;m++)this.paintVertexArray.emplace(m,a,u);this.maxValue=Math.max(this.maxValue,Math.abs(a),Math.abs(u))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,n,a,u,p){let m=this.useIntegerZoom?Math.floor(a.zoom):a.zoom,_=G(this.expression.interpolationFactor(m,this.context.zoom,this.context.zoom+1),0,1);n.set(e,p,_)}getBinding(e,n){return new nr(e)}}class Zr{constructor(e,n,a,u,p){this.expression=e,this.layerId=p,this.paintVertexAttributes=(a==="array"?rE:nE).members;for(let m=0;m<n.length;++m);this.paintVertexArray=new u,this.paintTransitionVertexArray=new fc}populatePaintArray(e,n,a,u){let p=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(p,e,n.patterns&&n.patterns[this.layerId],a)}updatePaintArray(e,n,a,u,p,m,_){this._setPaintValues(e,n,a.patterns&&a.patterns[this.layerId],m)}_setPaintValues(e,n,a,u){if(!u||!a)return;let p=u[a[0]],m=u[a[1]];if(p){if(p){let{tl:_,br:b,pixelRatio:w}=p;for(let I=e;I<n;I++)this.paintVertexArray.emplace(I,_[0],_[1],b[0],b[1],w)}if(m){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);let{tl:_,br:b}=m;for(let w=e;w<n;w++)this.paintTransitionVertexArray.emplace(w,_[0],_[1],b[0],b[1])}}}upload(e){let n=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,n)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,iE.members,n))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class ja{constructor(e,n,a=()=>!0){this.binders={},this._buffers=[],this.context=n;let u=[];for(let p in e.paint._values){let m=e.paint.get(p);if(p.endsWith("-use-theme")||!a(p)||!(m instanceof Is&&Bf(m.property.specification)))continue;let _=aE(p,e.type),b=m.value,w=m.property.specification.type,I=!!m.property.useIntegerZoom,S=p==="line-dasharray"||p.endsWith("pattern"),D=e.paint.get(`${p}-use-theme`),P=p==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||D&&D.value.kind!=="constant";if(b.kind!=="constant"||P)if(b.kind==="source"||P||S){let O=a_(p,w,"source");this.binders[p]=S?new Zr(b,_,w,O,e.id):new Va(b,_,w,O),u.push(`/a_${p}`)}else{let O=a_(p,w,"composite");this.binders[p]=new $s(b,_,w,I,n,O),u.push(`/z_${p}`)}else this.binders[p]=S?new ch(b.value,_):new hp(b.value,_,w,n),u.push(`/u_${p}`);D&&(this.binders[p].lutExpression=D.value)}this.cacheKey=u.sort().join("")}getMaxValue(e){let n=this.binders[e];return n instanceof Va||n instanceof $s?n.maxValue:0}populatePaintArrays(e,n,a,u,p,m,_,b){for(let w in this.binders){let I=this.binders[w];I.context=this.context,(I instanceof Va||I instanceof $s||I instanceof Zr)&&I.populatePaintArray(e,n,a,u,p,m,_,b)}}setConstantPatternPositions(e,n){for(let a in this.binders){let u=this.binders[a];u instanceof ch&&u.setConstantPatternPositions(e,n)}}getPatternTransitionVertexBuffer(e){let n=this.binders[e];return n instanceof Zr?n.paintTransitionVertexBuffer:null}updatePaintArrays(e,n,a,u,p,m,_,b,w,I){let S=!1,D=Object.keys(e),P=D.length!==0&&!b,O=P?D:n.uniqueIds;this.context.lut=p.lut;for(let N in this.binders){let V=this.binders[N];if(V.context=this.context,(V instanceof Va||V instanceof $s||V instanceof Zr)&&V.expression&&V.expression.kind&&V.expression.kind!=="constant"&&(V.expression.isStateDependent===!0||V.expression.isLightConstant===!1)){let U=p.paint.get(N);V.expression=U.value;for(let W of O){let X=e[W.toString()];n.eachPosition(W,(K,le,re)=>{let de=u.feature(K);V.updatePaintArray(le,re,de,X,m,_,w,I)})}if(!P)for(let W of a.uniqueIds){let X=e[W.toString()];a.eachPosition(W,(K,le,re)=>{let de=u.feature(K);V.updatePaintArray(le,re,de,X,m,_,w,I)})}S=!0}}return S}defines(){let e=[];for(let n in this.binders){let a=this.binders[n];(a instanceof hp||a instanceof ch)&&e.push(...a.uniformNames.map(u=>`#define HAS_UNIFORM_${u}`))}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){let n=[];for(let a in this.binders){let u=this.binders[a];if(u instanceof hp||u instanceof ch||u instanceof $s)for(let p of u.uniformNames)n.push({name:p,property:a,binding:u.getBinding(e,p)})}return n}setUniforms(e,n,a,u,p){for(let{name:m,property:_,binding:b}of a)this.binders[_].setUniform(e,b,p,u.get(_),m)}updatePaintBuffers(){this._buffers=[];for(let e in this.binders){let n=this.binders[e];(n instanceof Va||n instanceof $s||n instanceof Zr)&&n.paintVertexBuffer&&this._buffers.push(n.paintVertexBuffer),n instanceof Zr&&n.paintTransitionVertexBuffer&&this._buffers.push(n.paintTransitionVertexBuffer)}}upload(e){for(let n in this.binders){let a=this.binders[n];(a instanceof Va||a instanceof $s||a instanceof Zr)&&a.upload(e)}this.updatePaintBuffers()}destroy(){for(let e in this.binders){let n=this.binders[e];(n instanceof Va||n instanceof $s||n instanceof Zr)&&n.destroy()}}}class Gs{constructor(e,n,a=()=>!0){this.programConfigurations={};for(let u of e)this.programConfigurations[u.id]=new ja(u,n,a);this.needsUpload=!1,this._featureMap=new oh,this._featureMapWithoutIds=new oh,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,n,a,u,p,m,_,b,w){for(let I in this.programConfigurations)this.programConfigurations[I].populatePaintArrays(e,n,u,p,m,_,b,w);n.id!==void 0?this._featureMap.add(n.id,a,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,a,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,n,a,u,p,m,_,b){for(let w of a)this.needsUpload=this.programConfigurations[w.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,n,w,u,p,m,_||0,b)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(let n in this.programConfigurations)this.programConfigurations[n].upload(e);this.needsUpload=!1}}destroy(){for(let e in this.programConfigurations)this.programConfigurations[e].destroy()}}let sE={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function aE(r,e){return sE[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}let lE={"line-pattern":{source:xl,composite:xl},"fill-pattern":{source:xl,composite:xl},"fill-extrusion-pattern":{source:xl,composite:xl},"line-dasharray":{source:fc,composite:fc}},cE={color:{source:wl,composite:bl},number:{source:Ba,composite:wl}};function a_(r,e,n){let a=lE[r];return a&&a[n]||cE[e][n]}vt(hp,"ConstantBinder"),vt(ch,"PatternConstantBinder"),vt(Va,"SourceExpressionBinder"),vt(Zr,"PatternCompositeBinder"),vt($s,"CompositeExpressionBinder"),vt(ja,"ProgramConfiguration",{omit:["_buffers"]}),vt(Gs,"ProgramConfigurationSet");let Io=rt/Math.PI/2,d=5,t=6,o=16383,h=64,g=[h,32,16],y=-Io,x=Io;function E(r,e,n,a=Io){return n=gn(n),[r*Math.sin(n)*a,-e*a,r*Math.cos(n)*a]}function T(r,e,n){return E(Math.cos(gn(r)),Math.sin(gn(r)),e,n)}let A=63710088e-1,M=2*Math.PI*A;class L{constructor(e,n){if(isNaN(e)||isNaN(n))throw new Error(`Invalid LngLat object: (${e}, ${n})`);if(this.lng=+e,this.lat=+n,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new L(fe(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){let n=Math.PI/180,a=this.lat*n,u=e.lat*n,p=Math.sin(a)*Math.sin(u)+Math.cos(a)*Math.cos(u)*Math.cos((e.lng-this.lng)*n);return A*Math.acos(Math.min(p,1))}toBounds(e=0){let n=360*e/40075017,a=n/Math.cos(Math.PI/180*this.lat);return new R({lng:this.lng-a,lat:this.lat-n},{lng:this.lng+a,lat:this.lat+n})}toEcef(e){return T(this.lat,this.lng,Io+e*Io/A)}static convert(e){if(e instanceof L)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new L(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new L(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class R{constructor(e,n){e&&(n?this.setSouthWest(e).setNorthEast(n):Array.isArray(e)&&e.length===4?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]))}setNorthEast(e){return this._ne=e instanceof L?new L(e.lng,e.lat):L.convert(e),this}setSouthWest(e){return this._sw=e instanceof L?new L(e.lng,e.lat):L.convert(e),this}extend(e){let n=this._sw,a=this._ne,u,p;if(e instanceof L)u=e,p=e;else{if(!(e instanceof R))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(R.convert(e)):this.extend(L.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(L.convert(e)):this;if(u=e._sw,p=e._ne,!u||!p)return this}return n||a?(n.lng=Math.min(u.lng,n.lng),n.lat=Math.min(u.lat,n.lat),a.lng=Math.max(p.lng,a.lng),a.lat=Math.max(p.lat,a.lat)):(this._sw=new L(u.lng,u.lat),this._ne=new L(p.lng,p.lat)),this}getCenter(){return new L((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new L(this.getWest(),this.getNorth())}getSouthEast(){return new L(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){let{lng:n,lat:a}=L.convert(e),u=this._sw.lng<=n&&n<=this._ne.lng;return this._sw.lng>this._ne.lng&&(u=this._sw.lng>=n&&n>=this._ne.lng),this._sw.lat<=a&&a<=this._ne.lat&&u}static convert(e){if(e)return e instanceof R?e:new R(e)}}let F=0,z=25.5;function j(r){return M*Math.cos(r*Math.PI/180)}function q(r){return(180+r)/360}function $(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function Z(r,e){return r/j(e)}function J(r){return 360*r-180}function Y(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function ae(r,e){return r*j(Y(e))}let Q=85.051129;function ce(r){return Math.cos(gn(G(r,-Q,Q)))}function se(r,e){let n=G(e,F,z),a=Math.pow(2,n);return ce(r)*M/(512*a)}function ie(r){return 1/Math.cos(r*Math.PI/180)}function ue(r,e=0){let n=Math.exp(Math.PI*(1-(r.y+e/rt)/(1<<r.z)*2));return 80150034*n/(n*n+1)/rt/(1<<r.z)}class be{constructor(e,n,a=0){this.x=+e,this.y=+n,this.z=+a}static fromLngLat(e,n=0){let a=L.convert(e);return new be(q(a.lng),$(a.lat),Z(n,a.lat))}toLngLat(){return new L(J(this.x),Y(this.y))}toAltitude(){return ae(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/M*ie(Y(this.y))}}function ye(r,e,n,a,u,p,m,_,b){let w=(e+a)/2,I=(n+u)/2,S=new Ze(w,I);_(S),(function(D,P,O,N,V,U){let W=O-V,X=N-U;return Math.abs((N-P)*W-(O-D)*X)/Math.hypot(W,X)})(S.x,S.y,p.x,p.y,m.x,m.y)>=b?(ye(r,e,n,w,I,p,S,_,b),ye(r,w,I,a,u,S,m,_,b)):r.push(m)}function Pe(r,e,n){let a=r[0],u=a.x,p=a.y;e(a);let m=[a];for(let _=1;_<r.length;_++){let b=r[_],{x:w,y:I}=b;e(b),ye(m,u,p,w,I,a,b,e,n),u=w,p=I,a=b}return m}function Se(r,e,n,a){if(a(e,n)){let u=e.add(n)._mult(.5);Se(r,e,u,a),Se(r,u,n,a)}else r.push(n)}function Be(r,e){let n=r[0],a=[n];for(let u=1;u<r.length;u++){let p=r[u];Se(a,n,p,e),n=p}return a}let tt=Math.pow(2,14)-1,Ie=-tt-1;function me(r,e){let n=Math.round(r.x*e),a=Math.round(r.y*e);return r.x=G(n,Ie,tt),r.y=G(a,Ie,tt),(n<r.x||n>r.x+1||a<r.y||a>r.y+1)&&Rt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function Ve(r,e,n){let a=r.loadGeometry(),u=r.extent,p=rt/u;if(e&&n&&n.projection.isReprojectedInTileSpace){let m=1<<e.z,{scale:_,x:b,y:w,projection:I}=n,S=D=>{let P=J((e.x+D.x/u)/m),O=Y((e.y+D.y/u)/m),N=I.project(P,O);D.x=(N.x*_-b)*u,D.y=(N.y*_-w)*u};for(let D=0;D<a.length;D++)if(r.type!==1)a[D]=Pe(a[D],S,1);else{let P=[];for(let O of a[D])O.x<0||O.x>=u||O.y<0||O.y>=u||(S(O),P.push(O));a[D]=P}}for(let m of a)for(let _ of m)me(_,p);return a}function De(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?Ve(r):[]}}class Ge{constructor(e,n,a,u,p){this.properties={},this.extent=a,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=u,this._values=p,e.readFields(ot,this,n)}loadGeometry(){let e=this._pbf;e.pos=this._geometry;let n=e.readVarint()+e.pos,a=[],u,p=1,m=0,_=0,b=0;for(;e.pos<n;){if(m<=0){let w=e.readVarint();p=7&w,m=w>>3}if(m--,p===1||p===2)_+=e.readSVarint(),b+=e.readSVarint(),p===1&&(u&&a.push(u),u=[]),u&&u.push(new Ze(_,b));else{if(p!==7)throw new Error(`unknown command ${p}`);u&&u.push(u[0].clone())}}return u&&a.push(u),a}bbox(){let e=this._pbf;e.pos=this._geometry;let n=e.readVarint()+e.pos,a=1,u=0,p=0,m=0,_=1/0,b=-1/0,w=1/0,I=-1/0;for(;e.pos<n;){if(u<=0){let S=e.readVarint();a=7&S,u=S>>3}if(u--,a===1||a===2)p+=e.readSVarint(),m+=e.readSVarint(),p<_&&(_=p),p>b&&(b=p),m<w&&(w=m),m>I&&(I=m);else if(a!==7)throw new Error(`unknown command ${a}`)}return[_,w,b,I]}toGeoJSON(e,n,a){let u=this.extent*Math.pow(2,a),p=this.extent*e,m=this.extent*n,_=this.loadGeometry();function b(D){return[360*(D.x+p)/u-180,360/Math.PI*Math.atan(Math.exp((1-2*(D.y+m)/u)*Math.PI))-90]}function w(D){return D.map(b)}let I;if(this.type===1){let D=[];for(let O of _)D.push(O[0]);let P=w(D);I=D.length===1?{type:"Point",coordinates:P[0]}:{type:"MultiPoint",coordinates:P}}else if(this.type===2){let D=_.map(w);I=D.length===1?{type:"LineString",coordinates:D[0]}:{type:"MultiLineString",coordinates:D}}else{if(this.type!==3)throw new Error("unknown feature type");{let D=(function(O){let N=O.length;if(N<=1)return[O];let V=[],U,W;for(let X=0;X<N;X++){let K=xt(O[X]);K!==0&&(W===void 0&&(W=K<0),W===K<0?(U&&V.push(U),U=[O[X]]):U&&U.push(O[X]))}return U&&V.push(U),V})(_),P=[];for(let O of D)P.push(O.map(w));I=P.length===1?{type:"Polygon",coordinates:P[0]}:{type:"MultiPolygon",coordinates:P}}}let S={type:"Feature",geometry:I,properties:this.properties};return this.id!=null&&(S.id=this.id),S}}function ot(r,e,n){r===1?e.id=n.readVarint():r===2?(function(a,u){let p=a.readVarint()+a.pos;for(;a.pos<p;){let m=u._keys[a.readVarint()],_=u._values[a.readVarint()];u.properties[m]=_}})(n,e):r===3?e.type=n.readVarint():r===4&&(e._geometry=n.pos)}function xt(r){let e=0;for(let n,a,u=0,p=r.length,m=p-1;u<p;m=u++)n=r[u],a=r[m],e+=(a.x-n.x)*(n.y+a.y);return e}Ge.types=["Unknown","Point","LineString","Polygon"];class Je{constructor(e,n){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(it,this,n),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];let n=this._pbf.readVarint()+this._pbf.pos;return new Ge(this._pbf,n,this.extent,this._keys,this._values)}}function it(r,e,n){r===15?e.version=n.readVarint():r===1?e.name=n.readString():r===5?e.extent=n.readVarint():r===2?e._features.push(n.pos):r===3?e._keys.push(n.readString()):r===4&&e._values.push((function(a){let u=null,p=a.readVarint()+a.pos;for(;a.pos<p;){let m=a.readVarint()>>3;u=m===1?a.readString():m===2?a.readFloat():m===3?a.readDouble():m===4?a.readVarint64():m===5?a.readVarint():m===6?a.readSVarint():m===7?a.readBoolean():null}if(u==null)throw new Error("unknown feature value");return u})(n))}class wt{constructor(e,n){this.layers=e.readFields(mt,{},n)}}function mt(r,e,n){if(r===3){let a=new Je(n,n.readVarint()+n.pos);a.length&&(e[a.name]=a)}}let ht="3d_elevation_id",gt="level";class Ot{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,n){return this._valid&&e(n(this._geometry)),this}require(e,n,a){return this.get(e,!0,n,a)}optional(e,n,a){return this.get(e,!1,n,a)}success(){return this._valid}get(e,n,a,u){let p=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&p!==void 0&&!Number.isNaN(p)?a(u?u(p):p):n&&(this._valid=!1),this}}class fn{constructor(e,n){this.featureFunc=e,this.vertexFunc=n}parseFeature(e,n,a){return this.featureFunc(e,n,a)}parseVertex(e,n,a){return this.vertexFunc(e,n,a)}}let vn=new fn((r,e,n)=>r.reset(e).require(ht,a=>{n.id=a}).optional("fixed_height_relative",a=>{n.constantHeight=a},Ut.decodeRelativeHeight).geometry(a=>{n.bounds=a},jd).success(),(r,e,n)=>r.reset(e).require(ht,a=>{n.id=a}).require("elevation_idx",a=>{n.idx=a}).require("extent",a=>{n.extent=a}).require("height_relative",a=>{n.height=a},Ut.decodeRelativeHeight).geometry(a=>{n.position=a},Ut.getPoint).success()),Zn=new fn((r,e,n)=>r.reset(e).require(ht,a=>{n.id=a}).optional("fixed_height",a=>{n.constantHeight=a},Ut.decodeMetricHeight).geometry(a=>{n.bounds=a},jd).success(),(r,e,n)=>r.reset(e).require(ht,a=>{n.id=a}).require("elevation_idx",a=>{n.idx=a}).require("extent",a=>{n.extent=a}).require("height",a=>{n.height=a},Ut.decodeMetricHeight).geometry(a=>{n.position=a},Ut.getPoint).success());class Ut{static getPoint(e){return Zl(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static getVersionSchema(e){return e?e==="1.0.1"?Zn:void 0:vn}static parse(e){let n=[],a=[],u=e.length,p=new Ot;for(let m=0;m<u;m++){let _=e.feature(m),b=_.properties.version,w=Ut.getVersionSchema(b);if(w===void 0){Rt(`Unknown elevation feature version number ${b||"(unknown)"}`);continue}let I=_.properties.type;if(!I)continue;let S=Ge.types[_.type];if(S==="Point"&&I==="curve_point"){let D={};w.parseVertex(p,_,D)&&n.push(D)}else if(S==="Polygon"&&I==="curve_meta"){let D={};w.parseFeature(p,_,D)&&a.push(D)}}return{vertices:n,features:a}}}class yn{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,a){let u=Xl(n,this.dir);if(Math.abs(u)<1e-6)return!1;let p=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1])/u;return a[0]=this.pos[0]+this.dir[0]*p,a[1]=this.pos[1]+this.dir[1]*p,!0}}class en{constructor(e,n){this.pos=e,this.dir=n}intersectsPlane(e,n,a){let u=sr(n,this.dir);if(Math.abs(u)<1e-6)return!1;let p=((e[0]-this.pos[0])*n[0]+(e[1]-this.pos[1])*n[1]+(e[2]-this.pos[2])*n[2])/u;return a[0]=this.pos[0]+this.dir[0]*p,a[1]=this.pos[1]+this.dir[1]*p,a[2]=this.pos[2]+this.dir[2]*p,!0}closestPointOnSphere(e,n,a){if((function(P,O){var N=P[0],V=P[1],U=P[2],W=O[0],X=O[1],K=O[2];return Math.abs(N-W)<=C*Math.max(1,Math.abs(N),Math.abs(W))&&Math.abs(V-X)<=C*Math.max(1,Math.abs(V),Math.abs(X))&&Math.abs(U-K)<=C*Math.max(1,Math.abs(U),Math.abs(K))})(this.pos,e)||n===0)return a[0]=a[1]=a[2]=0,!1;let[u,p,m]=this.dir,_=this.pos[0]-e[0],b=this.pos[1]-e[1],w=this.pos[2]-e[2],I=u*u+p*p+m*m,S=2*(_*u+b*p+w*m),D=S*S-4*I*(_*_+b*b+w*w-n*n);if(D<0){let P=Math.max(-S/2,0),O=_+u*P,N=b+p*P,V=w+m*P,U=Math.hypot(O,N,V);return a[0]=O*n/U,a[1]=N*n/U,a[2]=V*n/U,!1}{let P=(-S-Math.sqrt(D))/(2*I);if(P<0){let O=Math.hypot(_,b,w);return a[0]=_*n/O,a[1]=b*n/O,a[2]=w*n/O,!1}return a[0]=_+u*P,a[1]=b+p*P,a[2]=w+m*P,!0}}}class jn{constructor(e,n,a,u,p){this.TL=e,this.TR=n,this.BR=a,this.BL=u,this.horizon=p}static fromInvProjectionMatrix(e,n,a){let u=[-1,1,1],p=[1,1,1],m=[1,-1,1],_=[-1,-1,1],b=ki(u,u,e),w=ki(p,p,e),I=ki(m,m,e),S=ki(_,_,e);return new jn(b,w,I,S,n/a)}}function xn(r,e,n){let a=1/0,u=-1/0,p=[];for(let m of r){tr(p,m,e);let _=sr(p,n);a=Math.min(a,_),u=Math.max(u,_)}return[a,u]}function oi(r,e){let n=!0;for(let a=0;a<r.planes.length;a++){let u=r.planes[a],p=0;for(let m=0;m<e.length;m++)p+=+(sr(u,e[m])+u[3]>=0);if(p===0)return 0;p!==e.length&&(n=!1)}return n?2:1}function Sn(r,e){for(let n of r.projections){let a=xn(e,r.points[0],n.axis);if(n.projection[1]<a[0]||n.projection[0]>a[1])return 0}return 1}function nn(r,e){let n=0,a=[0,0,0,0];for(let m=0;m<r.length;m++)a[0]=r[m][0],a[1]=r[m][1],a[2]=r[m][2],a[3]=1,(u=a)[0]*(p=e)[0]+u[1]*p[1]+u[2]*p[2]+u[3]*p[3]>=0&&n++;var u,p;return n}class On{constructor(e,n){this.points=e||new Array(8).fill([0,0,0]),this.planes=n||new Array(6).fill([0,0,0,0]),this.bounds=on.fromPoints(this.points),this.projections=[],this.frustumEdges=[tr([],this.points[2],this.points[3]),tr([],this.points[0],this.points[3]),tr([],this.points[4],this.points[0]),tr([],this.points[5],this.points[1]),tr([],this.points[6],this.points[2]),tr([],this.points[7],this.points[3])];for(let a of this.frustumEdges){let u=[0,-a[2],a[1]],p=[a[2],0,-a[0]];this.projections.push({axis:u,projection:xn(this.points,this.points[0],u)}),this.projections.push({axis:p,projection:xn(this.points,this.points[0],p)})}}static fromInvProjectionMatrix(e,n,a,u){let p=Math.pow(2,a),m=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(w=>{let I=co([],w,e),S=1/I[3]/n*p;return(D=I)[0]=(P=I)[0]*(O=[S,S,u?1/I[3]:S,S])[0],D[1]=P[1]*O[1],D[2]=P[2]*O[2],D[3]=P[3]*O[3],D;var D,P,O}),_=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(w=>{let I=li([],Or([],tr([],m[w[0]],m[w[1]]),tr([],m[w[2]],m[w[1]]))),S=-sr(I,m[w[1]]);return I.concat(S)}),b=[];for(let w=0;w<m.length;w++)b.push([m[w][0],m[w][1],m[w][2]]);return new On(b,_)}intersectsPrecise(e,n,a){for(let u=0;u<n.length;u++)if(!nn(e,n[u]))return 0;for(let u=0;u<this.planes.length;u++)if(!nn(e,this.planes[u]))return 0;for(let u of a)for(let p of this.frustumEdges){let m=Or([],u,p),_=Qr(m);if(_===0)continue;Mi(m,m,1/_);let b=xn(this.points,this.points[0],m),w=xn(e,this.points[0],m);if(b[0]>w[1]||w[0]>b[1])return 0}return 1}containsPoint(e){for(let n of this.planes){let a=n[3];if(sr([n[0],n[1],n[2]],e)+a<0)return!1}return!0}}class on{static fromPoints(e){let n=[1/0,1/0,1/0],a=[-1/0,-1/0,-1/0];for(let u of e)oa(n,n,u),ms(a,a,u);return new on(n,a)}static fromTileIdAndHeight(e,n,a){let u=1<<e.canonical.z,p=e.canonical.x,m=e.canonical.y;return new on([p/u,m/u,n],[(p+1)/u,(m+1)/u,a])}static applyTransform(e,n){let a=e.getCorners();for(let u=0;u<a.length;++u)ki(a[u],a[u],n);return on.fromPoints(a)}static applyTransformFast(e,n){let a=[n[12],n[13],n[14]],u=[...a];for(let p=0;p<3;p++)for(let m=0;m<3;m++){let _=n[4*m+p],b=_*e.min[m],w=_*e.max[m];a[p]+=Math.min(b,w),u[p]+=Math.max(b,w)}return new on(a,u)}static projectAabbCorners(e,n){let a=e.getCorners();for(let u=0;u<a.length;++u)ki(a[u],a[u],n);return a}constructor(e,n){this.min=e,this.max=n,this.center=Mi([],or([],this.min,this.max),.5)}quadrant(e){let n=[e%2==0,e<2],a=sf(this.min),u=sf(this.max);for(let p=0;p<n.length;p++)a[p]=n[p]?this.min[p]:this.center[p],u[p]=n[p]?this.center[p]:this.max[p];return u[2]=this.max[2],new on(a,u)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){let e=this.min,n=this.max;return[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]],[e[0],e[1],n[2]],[n[0],e[1],n[2]],[n[0],n[1],n[2]],[e[0],n[1],n[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?oi(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?oi(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,n){return n||this.intersects(e)?Sn(e,this.getCorners()):0}intersectsPreciseFlat(e,n){return n||this.intersectsFlat(e)?Sn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let n=0;n<3;++n)if(this.min[n]>e.max[n]||e.min[n]>this.max[n])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e.min[n]),this.max[n]=Math.max(this.max[n],e.max[n])}encapsulatePoint(e){for(let n=0;n<3;n++)this.min[n]=Math.min(this.min[n],e[n]),this.max[n]=Math.max(this.max[n],e[n])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}vt(on,"Aabb");class ui{constructor(e,n){this.feature=e,this.metersToTile=n,this.index=0}get(){let e=this.feature.vertices[this.index],n=this.feature.vertexProps[this.index].dir,a=n[1],u=-n[0],p=(e.extent+1)*this.metersToTile;return[new Ze(Math.trunc(e.position[0]+a*p),Math.trunc(e.position[1]+u*p)),new Ze(Math.trunc(e.position[0]-a*p),Math.trunc(e.position[1]-u*p))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class kn{constructor(e,n,a,u,p,m){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this._tmpVec2=[dr(),dr(),dr(),dr(),dr(),dr(),dr()],this.id=e,this.heightRange={min:a,max:a},this.safeArea=n,this.constantHeight=a,this.constantHeight==null&&(this.constantHeight!=null||u.length!==0)){this.vertices=u,this.edges=p,this.edges=this.edges.filter(_=>{return _.a<this.vertices.length&&_.b<this.vertices.length&&!((b=this.vertices[_.a].position)[0]===(w=this.vertices[_.b].position)[0]&&b[1]===w[1]);var b,w}),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let _ of this.vertices)this.vertexProps.push({dir:Zl(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,_.height),this.heightRange.max=Math.max(this.heightRange.max,_.height);for(let _ of this.edges){let b=this.vertices[_.a].position,w=this.vertices[_.b].position,I=js(dr(),w,b),S=Ri(I),D=gs(dr(),I,1/S);this.edgeProps.push({vec:I,dir:D,len:S});let P=this.vertexProps[_.a].dir,O=this.vertexProps[_.b].dir;Ca(P,P,D),Ca(O,O,D)}for(let _ of this.vertexProps)_.dir[0]===0&&_.dir[1]===0||Wr(_.dir,_.dir);this.tessellate(m)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;let n=this.getClosestEdge(e);if(n==null)return 0;let[a,u]=n;return zt(this.vertices[this.edges[a].a].height,this.vertices[this.edges[a].b].height,u)}computeSlopeNormal(e,n){let a=this.getClosestEdge(e);if(!a)return ji(0,0,1);let u=a[0],p=this.edges[u],m=this.edgeProps[u].vec,_=ji(m[0],m[1],(this.vertices[p.b].height-this.vertices[p.a].height)*n),b=ji(_[1],-_[0],0);Or(b,b,_);let w=Qr(b);return w>0?Mi(b,b,1/w):bi(b,0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let n=0,a=Number.POSITIVE_INFINITY,u=0,[p,m,_,b,w,I,S]=this._tmpVec2;qc(S,e.x,e.y);let D=new yn(S,null);for(let P=0;P<this.edges.length;P++){let O=this.edges[P],N=this.edgeProps[P].dir;D.dir=N;let V=this.vertices[O.a].position,U=this.vertices[O.b].position,W=D.intersectsPlane(V,this.vertexProps[O.a].dir,p),X=D.intersectsPlane(U,this.vertexProps[O.b].dir,m);if(!W||!X)continue;js(_,m,p),js(b,S,p);let K=Xl(_,_),le=K>0?Xl(b,_)/K:0,re=G(le,0,1),de=Math.abs((le-re)*this.edgeProps[P].len);js(w,S,V),qc(I,N[1],-N[0]);let pe=de+Math.abs(Xl(w,I));pe<a&&(n=P,a=pe,u=re)}return[n,u]}tessellate(e){let n=Un(),a=Un(),u=Un(),p=Un();for(let m=this.edges.length-1;m>=0;--m){let _=this.edges[m].a,b=this.edges[m].b,{position:w,height:I,extent:S}=this.vertices[_],{position:D,height:P,extent:O}=this.vertices[b],N=this.vertexProps[_].dir,V=this.vertexProps[b].dir;if(bi(n,w[0]/e,w[1]/e,I),bi(a,D[0]/e,D[1]/e,P),bi(u,N[1],-N[0],0),Mi(u,u,S),bi(p,V[1],-V[0],0),Mi(p,p,O),this.distSqLines(ji(n[0]+.5*u[0],n[1]+.5*u[1],n[2]+.5*u[2]),ji(a[0]-.5*p[0],a[1]-.5*p[1],a[2]-.5*p[2]),ji(n[0]-.5*u[0],n[1]-.5*u[1],n[2]-.5*u[2]),ji(a[0]+.5*p[0],a[1]+.5*p[1],a[2]+.5*p[2]))<=.0025000000000000005)continue;let U=this.vertices.length,W=Ca(dr(),w,D);this.vertices.push({position:gs(W,W,.5),height:.5*(I+P),extent:.5*(S+O)});let X=Ca(dr(),N,V);this.vertexProps.push({dir:Wr(X,X)}),this.edges.splice(m,1),this.edgeProps.splice(m,1),this.edges.push({a:_,b:U}),this.edges.push({a:U,b});let K=js(dr(),this.vertices[U].position,w),le=Ri(K),re={vec:K,dir:gs(dr(),K,1/le),len:le};this.edgeProps.push(re),this.edgeProps.push(re)}}distSqLines(e,n,a,u){let p=ra(Un(),n,e),m=ra(Un(),u,a),_=ra(Un(),e,a),b=sr(p,p),w=sr(p,m),I=sr(p,_),S=sr(m,m),D=sr(m,_),P=b*S-w*w;if(P===0)return af(Hc(p,a,u,sr(_,m)/sr(m,m)),e);let O=(b*D-w*I)/P;return af(Hc(p,e,n,(w*D-I*S)/P),Hc(m,a,u,O))}}class $t{static parseFrom(e,n){let a=Ut.parse(e);if(!a)return[];let{vertices:u,features:p}=a,m=1/ue(n);p.sort((I,S)=>I.id-S.id),u.sort((I,S)=>I.id-S.id||I.idx-S.idx),u=u.filter((I,S,D)=>S===D.findIndex(P=>P.id===I.id&&P.idx===I.idx));let _=new Array,b=0,w=u.length;for(let I of p){if(I.constantHeight){_.push(new kn(I.id,I.bounds,I.constantHeight));continue}for(;b!==w&&u[b].id<I.id;)b++;if(b===w||u[b].id!==I.id)continue;let S=new Array,D=new Array,P=b;for(;b!==w&&u[b].id===I.id;){let O=u[b];if(S.push({position:O.position,height:O.height,extent:O.extent}),b!==P&&u[b-1].idx===O.idx-1){let N=b-P;D.push({a:N-1,b:N})}b++}_.push(new kn(I.id,I.bounds,void 0,S,D,m))}return _}static getElevationFeature(e,n){if(!n)return;let a=+e.properties[ht];return Number.isNaN(a)?void 0:n.find(u=>u.id===a)}}class wn{constructor(e,n){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(n)||(this.zScale=Math.pow(2,n.z-e.z),this.xOffset=(e.x*this.zScale-n.x)*rt,this.yOffset=(e.y*this.zScale-n.y)*rt)}constantElevation(e,n){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,n)}pointElevation(e,n,a){let u=this.constantElevation(n,a);return u??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(n.pointElevation(e),a))}computeBiasedHeight(e,n){return n<=0?e:e+n*ne(0,n,e>=0?e:Math.abs(.5*e))}}vt(kn,"ElevationFeature");class Ti{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new To,this.indexArray=new wi,this.segments=new Ci,this.programConfigurations=new Gs(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Ba),this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,n){}updateAppearances(e,n,a,u){}populate(e,n,a,u){let p=this.layers[0],m=[],_=null;p.type==="circle"&&(_=p.layout.get("circle-sort-key"));for(let{feature:w,id:I,index:S,sourceLayerIndex:D}of e){let P=this.layers[0]._featureFilter.needGeometry,O=De(w,P);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),O,a))continue;let N=_?_.evaluate(O,{},a):void 0,V={id:I,properties:w.properties,type:w.type,sourceLayerIndex:D,index:S,geometry:P?O.geometry:Ve(w,a,u),patterns:{},sortKey:N};m.push(V)}_&&m.sort((w,I)=>w.sortKey-I.sortKey);let b=null;u.projection.name==="globe"&&(this.globeExtVertexArray=new tp,b=u.projection);for(let w of m){let{geometry:I,index:S,sourceLayerIndex:D}=w,P=e[S].feature;this.addFeature(w,I,S,n.availableImages,a,b,n.brightness,n.elevationFeatures),n.featureIndex.insert(P,I,S,D,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,n,a,u,p,m,_){this.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,m0.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,tE.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,eE.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,n,a,u,p,m,_,b){let w;this.elevationMode!=="none"&&(w=$t.getElevationFeature(e,b));for(let I of n)for(let S of I){let D=S.x,P=S.y;if(D<0||D>=rt||P<0||P>=rt)continue;if(m){let V=m.projectTilePoint(D,P,p),U=m.upVector(p,D,P);this.addGlobeExtVertex(V,U),this.addGlobeExtVertex(V,U),this.addGlobeExtVertex(V,U),this.addGlobeExtVertex(V,U)}let O=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),N=O.vertexLength;if(this.addCircleVertex(D,P,-1,-1),this.addCircleVertex(D,P,1,-1),this.addCircleVertex(D,P,1,1),this.addCircleVertex(D,P,-1,1),this.elevationMode!=="none"){let V=w?w.pointElevation(new Ze(D,P)):0;this.hasElevation=this.hasElevation||V!==0;for(let U=0;U<4;U++)this.elevatedLayoutVertexArray.emplaceBack(V)}this.indexArray.emplaceBack(N,N+1,N+2),this.indexArray.emplaceBack(N,N+2,N+3),O.vertexLength+=4,O.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,{},u,p,_,void 0,this.worldview)}addCircleVertex(e,n,a,u){this.layoutVertexArray.emplaceBack(2*e+(a+1)/2,2*n+(u+1)/2)}addGlobeExtVertex(e,n){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}}function $i(r,e){for(let n=0;n<r.length;n++)if(Cr(e,r[n]))return!0;for(let n=0;n<e.length;n++)if(Cr(r,e[n]))return!0;return!!po(r,e)}function Ai(r,e,n){return!!Cr(r,e)||!!Hr(e,r,n)}function Bi(r,e){if(r.length===1)return Cs(e,r[0]);for(let n=0;n<e.length;n++){let a=e[n];for(let u=0;u<a.length;u++)if(Cr(r,a[u]))return!0}for(let n=0;n<r.length;n++)if(Cs(e,r[n]))return!0;for(let n=0;n<e.length;n++)if(po(r,e[n]))return!0;return!1}function So(r,e,n){if(r.length>1){if(po(r,e))return!0;for(let a=0;a<e.length;a++)if(Hr(e[a],r,n))return!0}for(let a=0;a<r.length;a++)if(Hr(r[a],e,n))return!0;return!1}function po(r,e){if(r.length===0||e.length===0)return!1;for(let n=0;n<r.length-1;n++){let a=r[n],u=r[n+1];for(let p=0;p<e.length-1;p++)if(Ur(a,u,e[p],e[p+1]))return!0}return!1}function Ur(r,e,n,a){return sn(r,n,a)!==sn(e,n,a)&&sn(r,e,n)!==sn(r,e,a)}function Xr(r,e,n){return(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x)}function Qo(r,e,n,a){let u=Xr(r,e,a),p=Xr(r,e,n);if(Math.sign(u)===Math.sign(p))return;let m=Xr(n,a,r),_=m+p-u;return Math.sign(m)!==Math.sign(_)?[m/(m-_),p/(p-u)]:void 0}function Hr(r,e,n){let a=n*n;if(e.length===1)return r.distSqr(e[0])<a;for(let u=1;u<e.length;u++)if(es(r,e[u-1],e[u])<a)return!0;return!1}function es(r,e,n){let a=e.distSqr(n);if(a===0)return r.distSqr(e);let u=((r.x-e.x)*(n.x-e.x)+(r.y-e.y)*(n.y-e.y))/a;return r.distSqr(u<0?e:u>1?n:n.sub(e)._mult(u)._add(e))}function Cs(r,e){let n,a,u,p=!1;for(let m=0;m<r.length;m++){n=r[m];for(let _=0,b=n.length-1;_<n.length;b=_++)a=n[_],u=n[b],a.y>e.y!=u.y>e.y&&e.x<(u.x-a.x)*(e.y-a.y)/(u.y-a.y)+a.x&&(p=!p)}return p}function Cr(r,e){let n=!1;for(let a=0,u=r.length-1;a<r.length;u=a++){let p=r[a],m=r[u];p.y>e.y!=m.y>e.y&&e.x<(m.x-p.x)*(e.y-p.y)/(m.y-p.y)+p.x&&(n=!n)}return n}function Oi(r,e,n,a,u){for(let m of r)if(e<=m.x&&n<=m.y&&a>=m.x&&u>=m.y)return!0;let p=[new Ze(e,n),new Ze(e,u),new Ze(a,u),new Ze(a,n)];if(r.length>2){for(let m of p)if(Cr(r,m))return!0}for(let m=0;m<r.length-1;m++)if(Gi(r[m],r[m+1],p))return!0;return!1}function Gi(r,e,n){let a=n[0],u=n[2];if(r.x<a.x&&e.x<a.x||r.x>u.x&&e.x>u.x||r.y<a.y&&e.y<a.y||r.y>u.y&&e.y>u.y)return!1;let p=sn(r,e,n[0]);return p!==sn(r,e,n[1])||p!==sn(r,e,n[2])||p!==sn(r,e,n[3])}function ni(r,e,n,a,u,p){let m=e.y-r.y,_=r.x-e.x;if(p=p||0){let b=m*m+_*_;if(b===0)return!0;let w=Math.sqrt(b);m/=w,_/=w}return!((n.x-r.x)*m+(n.y-r.y)*_-p<0||(a.x-r.x)*m+(a.y-r.y)*_-p<0||(u.x-r.x)*m+(u.y-r.y)*_-p<0)}function Yi(r,e,n,a,u,p,m){return!(ni(r,e,a,u,p,m)||ni(e,n,a,u,p,m)||ni(n,r,a,u,p,m)||ni(a,u,r,e,n,m)||ni(u,p,r,e,n,m)||ni(p,a,r,e,n,m))}function Ar(r,e,n){let a=e.paint.get(r).value;return a.kind==="constant"?a.value:n.programConfigurations.get(e.id).getMaxValue(r)}function Li(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function ts(r,e,n,a,u){if(!e[0]&&!e[1])return r;let p=Ze.convert(e)._mult(u);n==="viewport"&&p._rotate(-a);let m=[];for(let _=0;_<r.length;_++)m.push(r[_].sub(p));return m}function Cu(r,e,n,a){let u=Ze.convert(r)._mult(a);return e==="viewport"&&u._rotate(-n),u}let Ua,Au;function Mu(r,e,n){var a=2*Math.PI*6378137/256/Math.pow(2,n);return[r*a-2*Math.PI*6378137/2,e*a-2*Math.PI*6378137/2]}vt(Ti,"CircleBucket",{omit:["layers"]});class ns{constructor(e,n,a){this.z=e,this.x=n,this.y=a,this.key=is(0,e,e,n,a)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){let n=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>n&&e.y===this.y>>n}url(e,n){let a=(function(p,m,_){var b=Mu(256*p,256*(m=Math.pow(2,_)-m-1),_),w=Mu(256*(p+1),256*(m+1),_);return b[0]+","+b[1]+","+w[0]+","+w[1]})(this.x,this.y,this.z),u=(function(p,m,_){let b,w="";for(let I=p;I>0;I--)b=1<<I-1,w+=(m&b?1:0)+(_&b?2:0);return w})(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(n==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",u).replace("{bbox-epsg-3857}",a)}toString(){return`${this.z}/${this.x}/${this.y}`}}class ga{constructor(e,n){this.wrap=e,this.canonical=n,this.key=is(e,n.z,n.z,n.x,n.y)}}class br{constructor(e,n,a,u,p){this.overscaledZ=e,this.wrap=n,this.canonical=new ns(a,+u,+p),this.key=n===0&&e===a?this.canonical.key:is(n,e,a,u,p)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){let n=this.canonical.z-e;return e>this.canonical.z?new br(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new br(e,this.wrap,e,this.canonical.x>>n,this.canonical.y>>n)}calculateScaledKey(e,n=!0){if(this.overscaledZ===e&&n)return this.key;if(e>this.canonical.z)return is(this.wrap*+n,e,this.canonical.z,this.canonical.x,this.canonical.y);{let a=this.canonical.z-e;return is(this.wrap*+n,e,e,this.canonical.x>>a,this.canonical.y>>a)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;let n=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>n&&e.canonical.y===this.canonical.y>>n}children(e){if(this.overscaledZ>=e)return[new br(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let n=this.canonical.z+1,a=2*this.canonical.x,u=2*this.canonical.y;return[new br(n,this.wrap,n,a,u),new br(n,this.wrap,n,a+1,u),new br(n,this.wrap,n,a,u+1),new br(n,this.wrap,n,a+1,u+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new br(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new br(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new ga(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function is(r,e,n,a,u){let p=1<<Math.min(n,22),m=p*(u%p)+a%p;return r&&n<22&&(m+=p*p*((r<0?-2*r-1:2*r)%(1<<2*(22-n)))),16*(32*m+n)+(e-n)}let mc=[r=>{let e=r.canonical.x-1,n=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,n--),new br(r.overscaledZ,n,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,n=r.wrap;return e===1<<r.canonical.z&&(e=0,n++),new br(r.overscaledZ,n,r.canonical.z,e,r.canonical.y)},r=>new br(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(r.canonical.y===0?1<<r.canonical.z:r.canonical.y)-1),r=>new br(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];vt(ns,"CanonicalTileID"),vt(br,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let v0=hn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:fp}=v0,xz=hn([{name:"a_pos_3",components:3,type:"Int16"}]);var eA=hn([{name:"a_pos",type:"Int16",components:2}]);function x0(r){return r*Io/A}let bz=[new on([y,y,y],[x,x,x]),new on([y,y,y],[0,0,x]),new on([0,y,y],[x,0,x]),new on([y,0,y],[0,x,x]),new on([0,0,y],[x,x,x])];function tA(r,e,n,a=!0){let u=Mi([],r._camera.position,r.worldSize),p=[e,n,1,1];co(p,p,r.pixelMatrixInverse),ll(p,p,1/p[3]);let m=li([],tr([],p,u)),_=r.globeMatrix,b=[_[12],_[13],_[14]],w=tr([],b,u),I=Qr(w),S=li([],w),D=r.worldSize/(2*Math.PI),P=sr(S,m),O=Math.asin(D/I);if(O<Math.acos(P)){if(!a)return null;let Le=[],Te=[];Mi(Le,m,I/P),li(Te,tr(Te,Le,w)),li(m,or(m,w,Mi(m,Te,Math.tan(O)*I)))}let N=[];new en(u,m).closestPointOnSphere(b,D,N);let V=li([],Hi(_,0)),U=li([],Hi(_,1)),W=li([],Hi(_,2)),X=sr(V,N),K=sr(U,N),le=sr(W,N),re=eo(Math.asin(-K/D)),de=eo(Math.atan2(X,le));de=r.center.lng+(function(Le,Te){let ke=(Te-Le+180)%360-180;return ke<-180?ke+360:ke})(r.center.lng,de);let pe=q(de),ge=G($(re),0,1);return new be(pe,ge)}class wz{constructor(e,n,a){this.a=tr([],e,a),this.b=tr([],n,a),this.center=a;let u=li([],this.a),p=li([],this.b);this.angle=Math.acos(sr(u,p))}}function uE(r,e){if(r.angle===0)return null;let n;return n=r.a[e]===0?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),n<0||n>1?null:(function(a,u,p,m){let _=Math.sin(p);return a*(Math.sin((1-m)*p)/_)+u*(Math.sin(m*p)/_)})(r.a[e],r.b[e],r.angle,G(n,0,1))+r.center[e]}function El(r){if(r.z<=1)return bz[r.z+2*r.y+r.x];let e=dE(b0(r));return on.fromPoints(e)}function gc(r,e,n){return Mi(r,r,1-n),Bs(r,r,e,n)}function nA(r,e,n){for(let a of r)ki(a,a,e),Mi(a,a,n)}function iA(r,e,n,a){let u=e/r.worldSize,p=r.globeMatrix;if(n.z<=1){let ge=El(n).getCorners();return nA(ge,p,u),on.fromPoints(ge)}let m=b0(n,a),_=dE(m,Io+x0(r._tileCoverLift));nA(_,p,u);let b=Number.MAX_VALUE,w=[-b,-b,-b],I=[b,b,b];if(m.contains(r.center)){for(let Te of _)oa(I,I,Te),ms(w,w,Te);w[2]=0;let ge=r.point,Le=[ge.x*u,ge.y*u,0];return oa(I,I,Le),ms(w,w,Le),new on(I,w)}if(r._tileCoverLift>0){for(let ge of _)oa(I,I,ge),ms(w,w,ge);return new on(I,w)}let S=[p[12]*u,p[13]*u,p[14]*u],D=m.getCenter(),P=G(r.center.lat,-Q,Q),O=G(D.lat,-Q,Q),N=q(r.center.lng),V=$(P),U=N-q(D.lng),W=V-$(O);U>.5?U-=1:U<-.5&&(U+=1);let X=0;Math.abs(U)>Math.abs(W)?X=U>=0?1:3:(X=W>=0?0:2,Bs(S,S,[p[4]*u,p[5]*u,p[6]*u],-Math.sin(gn(W>=0?m.getSouth():m.getNorth()))*Io));let K=_[X],le=_[(X+1)%4],re=new wz(K,le,S),de=[uE(re,0)||K[0],uE(re,1)||K[1],uE(re,2)||K[2]],pe=Ru(r.zoom);if(pe>0){let ge=(function({x:Te,y:ke,z:je},$e,nt,Ye,Ue){let Xe=1/(1<<je),Re=Te*Xe,Ae=Re+Xe,qe=ke*Xe,Qe=qe+Xe,He=0,_t=(Re+Ae)/2-Ye;return _t>.5?He=-1:_t<-.5&&(He=1),Re=((Re+He)*$e-(Ye*=$e))*nt+Ye,Ae=((Ae+He)*$e-Ye)*nt+Ye,qe=(qe*$e-(Ue*=$e))*nt+Ue,Qe=(Qe*$e-Ue)*nt+Ue,[[Re,Qe,0],[Ae,Qe,0],[Ae,qe,0],[Re,qe,0]]})(n,e,r._pixelsPerMercatorPixel,N,V);for(let Te=0;Te<_.length;Te++)gc(_[Te],ge[Te],pe);let Le=or([],ge[X],ge[(X+1)%4]);Mi(Le,Le,.5),gc(de,Le,pe)}for(let ge of _)oa(I,I,ge),ms(w,w,ge);return I[2]=Math.min(K[2],le[2]),oa(I,I,de),ms(w,w,de),new on(I,w)}function b0({x:r,y:e,z:n},a=!1){let u=1/(1<<n),p=new L(J(r*u),e===(1<<n)-1&&a?-90:Y((e+1)*u)),m=new L(J((r+1)*u),e===0&&a?90:Y(e*u));return new R(p,m)}function dE(r,e=Io){let n=gn(r.getNorth()),a=gn(r.getSouth()),u=Math.cos(n),p=Math.cos(a),m=Math.sin(n),_=Math.sin(a),b=r.getWest(),w=r.getEast();return[E(p,_,b,e),E(p,_,w,e),E(u,m,w,e),E(u,m,b,e)]}function l_(r,e,n,a){let u=1<<n.z,p=(r/rt+n.x)/u;return T(Y((e/rt+n.y)/u),J(p),a)}function w0({min:r,max:e}){return o/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}let rA=new Float64Array(16);function E0(r){let e=w0(r),n=lo(rA,[e,e,e]);return Lt(n,n,sa([],r.min))}function hE(r){let e=(a=r.min,(n=rA)[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=a[0],n[13]=a[1],n[14]=a[2],n[15]=1,n);var n,a;let u=1/w0(r);return qn(e,e,[u,u,u])}function fE(r){let e=rt/(2*Math.PI);return r/(2*Math.PI)/e}function oA(r,e){return rt/(512*Math.pow(2,r))*w0(El(e))}function sA(r,e,n,a,u){let p=fE(n),m=[r,e,-n/(2*Math.PI)],_=yt(new Float64Array(16));return Lt(_,_,m),qn(_,_,[p,p,p]),Sr(_,_,gn(-u)),Vi(_,_,gn(-a)),_}function Ru(r){return ne(d,t,r)}function aA(r,e){let n=T(e.lat,e.lng),a=(function(O){let N=T(O._center.lat,O._center.lng),V=Or([],ji(0,1,0),N),U=Sa([],-O.angle,N);V=ki(V,V,U),Sa(U,-O._pitch,V);let W=li([],N);return Mi(W,W,x0(O.cameraToCenterDistance/O.pixelsPerMeter)),ki(W,W,U),or([],N,W)})(r);return m=(u=ra([],a,n))[0],_=u[1],b=u[2],w=(p=n)[0],I=p[1],S=p[2],P=(D=Math.sqrt((m*m+_*_+b*b)*(w*w+I*I+S*S)))&&sr(u,p)/D,Math.acos(Math.min(Math.max(P,-1),1));var u,p,m,_,b,w,I,S,D,P}function pE(r,e){return aA(r,e)>Math.PI/2*1.01}let lA=gn(85),Ez=Math.cos(lA),Tz=Math.sin(lA),Iz=ct(),cA=r=>{let e=[];return r.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),r.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function uA(r,e,n,a,u,p,m,_,b){if(p&&r.queryGeometry.isAboveHorizon)return!1;p&&(b*=r.pixelToTileUnitsFactor);let w=r.tileID.canonical,I=n.projection.upVectorScale(w,n.center.lat,n.worldSize).metersToTile;for(let S of e)for(let D of S){let P=D.add(_),O=u&&n.elevation?n.elevation.exaggeration()*u.getElevationAt(P.x,P.y,!0):0,N=n.projection.projectTilePoint(P.x,P.y,w);if(O>0){let X=n.projection.upVector(w,P.x,P.y);N.x+=X[0]*I*O,N.y+=X[1]*I*O,N.z+=X[2]*I*O}let V=p?P:Sz(N.x,N.y,N.z,a),U=p?r.tilespaceRays.map(X=>Cz(X,O)):r.queryGeometry.screenGeometry,W=co([],[N.x,N.y,N.z,1],a);if(!m&&p?b*=W[3]/n.cameraToCenterDistance:m&&!p&&(b*=n.cameraToCenterDistance/W[3]),p){let X=Y((D.y/rt+w.y)/(1<<w.z));b/=n.projection.pixelsPerMeter(X,1)/Z(1,X)}if(Ai(U,V,b))return!0}return!1}function Sz(r,e,n,a){let u=co([],[r,e,n,1],a);return new Ze(u[0]/u[3],u[1]/u[3])}let dA=ji(0,0,0),Dz=ji(0,0,1);function Cz(r,e){let n=Un();return dA[2]=e,r.intersectsPlane(dA,Dz,n),new Ze(n[0],n[1])}class hA extends Ti{}let fA,pA,mA,gA;function _A(r,{width:e,height:n},a,u){if(u){if(u instanceof Uint8ClampedArray)u=new Uint8Array(u.buffer);else if(u.length!==e*n*a)throw new RangeError("mismatched image size")}else u=new Uint8Array(e*n*a);return r.width=e,r.height=n,r.data=u,r}function yA(r,e,n){let{width:a,height:u}=e;a===r.width&&u===r.height||(mE(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,a),height:Math.min(r.height,u)},n,null),r.width=a,r.height=u,r.data=e.data)}function mE(r,e,n,a,u,p,m,_){if(u.width===0||u.height===0)return e;if(u.width>r.width||u.height>r.height||n.x>r.width-u.width||n.y>r.height-u.height)throw new RangeError("out of range source coordinates for image copy");if(u.width>e.width||u.height>e.height||a.x>e.width-u.width||a.y>e.height-u.height)throw new RangeError("out of range destination coordinates for image copy");let b=r.data,w=e.data,I=p===4&&_;for(let S=0;S<u.height;S++){let D=((n.y+S)*r.width+n.x)*p,P=((a.y+S)*e.width+a.x)*p;if(I)for(let O=0;O<u.width;O++){let N=D+O*p+3,V=P+O*p;w[V+0]=255,w[V+1]=255,w[V+2]=255,w[V+3]=b[N]}else if(m)for(let O=0;O<u.width;O++){let N=D+O*p,V=P+O*p,U=new Nn(b[N+0]/255,b[N+1]/255,b[N+2]/255,b[N+3]).toNonPremultipliedRenderColor(m).toArray();w[V+0]=U[0],w[V+1]=U[1],w[V+2]=U[2],w[V+3]=U[3]}else for(let O=0;O<u.width*p;O++)w[P+O]=b[D+O]}return e}vt(hA,"HeatmapBucket",{omit:["layers"]});class Pu{constructor(e,n){_A(this,e,1,n)}resize(e){yA(this,new Pu(e),1)}clone(){return new Pu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,a,u,p){mE(e,n,a,u,p,1,null)}}class Yr{constructor(e,n){_A(this,e,4,n)}resize(e){yA(this,new Yr(e),4)}replace(e,n){n?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Yr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,n,a,u,p,m,_){mE(e,n,a,u,p,4,m,_)}}class vA{constructor(e,n){this.width=e.width,this.height=e.height,this.data=n instanceof Uint8Array?new Float32Array(n.buffer):n}}function c_(r){let e={},n=r.resolution||256,a=r.clips?r.clips.length:1,u=r.image||new Yr({width:n,height:a}),p=(m,_,b)=>{e[r.evaluationKey]=b;let w=r.expression.evaluate(e),I=w?w.toNonPremultipliedRenderColor(null):null;I&&(u.data[m+_+0]=Math.floor(255*I.r),u.data[m+_+1]=Math.floor(255*I.g),u.data[m+_+2]=Math.floor(255*I.b),u.data[m+_+3]=Math.floor(255*I.a))};if(r.clips)for(let m=0,_=0;m<a;++m,_+=4*n)for(let b=0,w=0;b<n;b++,w+=4){let I=b/(n-1),{start:S,end:D}=r.clips[m];p(_,w,S*(1-I)+D*I)}else for(let m=0,_=0;m<n;m++,_+=4)p(0,_,m/(n-1));return u}vt(Pu,"AlphaImage"),vt(Yr,"RGBAImage");let Az=hn([{name:"a_pos",components:2,type:"Int16"}],4),Mz=hn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),Rz=hn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),Pz=hn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function pp(r,e,n=2){let a=e&&e.length,u=a?e[0]*n:r.length,p=xA(r,0,u,n,!0),m=[];if(!p||p.next===p.prev)return m;let _,b,w;if(a&&(p=(function(I,S,D,P){let O=[];for(let N=0,V=S.length;N<V;N++){let U=xA(I,S[N]*P,N<V-1?S[N+1]*P:I.length,P,!1);U===U.next&&(U.steiner=!0),O.push(Vz(U))}O.sort(Nz);for(let N=0;N<O.length;N++)D=zz(O[N],D);return D})(r,e,p,n)),r.length>80*n){_=r[0],b=r[1];let I=_,S=b;for(let D=n;D<u;D+=n){let P=r[D],O=r[D+1];P<_&&(_=P),O<b&&(b=O),P>I&&(I=P),O>S&&(S=O)}w=Math.max(I-_,S-b),w=w!==0?32767/w:0}return u_(p,m,n,_,b,w,0),m}function xA(r,e,n,a,u){let p;if(u===(function(m,_,b,w){let I=0;for(let S=_,D=b-w;S<b;S+=w)I+=(m[D]-m[S])*(m[S+1]+m[D+1]),D=S;return I})(r,e,n,a)>0)for(let m=e;m<n;m+=a)p=TA(m/a|0,r[m],r[m+1],p);else for(let m=n-a;m>=e;m-=a)p=TA(m/a|0,r[m],r[m+1],p);return p&&mp(p,p.next)&&(f_(p),p=p.next),p}function uh(r,e){if(!r)return r;e||(e=r);let n,a=r;do if(n=!1,a.steiner||!mp(a,a.next)&&Mr(a.prev,a,a.next)!==0)a=a.next;else{if(f_(a),a=e=a.prev,a===a.next)break;n=!0}while(n||a!==e);return e}function u_(r,e,n,a,u,p,m){if(!r)return;!m&&p&&(function(b,w,I,S){let D=b;do D.z===0&&(D.z=gE(D.x,D.y,w,I,S)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==b);D.prevZ.nextZ=null,D.prevZ=null,(function(P){let O,N=1;do{let V,U=P;P=null;let W=null;for(O=0;U;){O++;let X=U,K=0;for(let re=0;re<N&&(K++,X=X.nextZ,X);re++);let le=N;for(;K>0||le>0&&X;)K!==0&&(le===0||!X||U.z<=X.z)?(V=U,U=U.nextZ,K--):(V=X,X=X.nextZ,le--),W?W.nextZ=V:P=V,V.prevZ=W,W=V;U=X}W.nextZ=null,N*=2}while(O>1)})(D)})(r,a,u,p);let _=r;for(;r.prev!==r.next;){let b=r.prev,w=r.next;if(p?Lz(r,a,u,p):Oz(r))e.push(b.i,r.i,w.i),f_(r),r=w.next,_=w.next;else if((r=w)===_){m?m===1?u_(r=Fz(uh(r),e),e,n,a,u,p,2):m===2&&kz(r,e,n,a,u,p):u_(uh(r),e,n,a,u,p,1);break}}}function Oz(r){let e=r.prev,n=r,a=r.next;if(Mr(e,n,a)>=0)return!1;let u=e.x,p=n.x,m=a.x,_=e.y,b=n.y,w=a.y,I=Math.min(u,p,m),S=Math.min(_,b,w),D=Math.max(u,p,m),P=Math.max(_,b,w),O=a.next;for(;O!==e;){if(O.x>=I&&O.x<=D&&O.y>=S&&O.y<=P&&d_(u,_,p,b,m,w,O.x,O.y)&&Mr(O.prev,O,O.next)>=0)return!1;O=O.next}return!0}function Lz(r,e,n,a){let u=r.prev,p=r,m=r.next;if(Mr(u,p,m)>=0)return!1;let _=u.x,b=p.x,w=m.x,I=u.y,S=p.y,D=m.y,P=Math.min(_,b,w),O=Math.min(I,S,D),N=Math.max(_,b,w),V=Math.max(I,S,D),U=gE(P,O,e,n,a),W=gE(N,V,e,n,a),X=r.prevZ,K=r.nextZ;for(;X&&X.z>=U&&K&&K.z<=W;){if(X.x>=P&&X.x<=N&&X.y>=O&&X.y<=V&&X!==u&&X!==m&&d_(_,I,b,S,w,D,X.x,X.y)&&Mr(X.prev,X,X.next)>=0||(X=X.prevZ,K.x>=P&&K.x<=N&&K.y>=O&&K.y<=V&&K!==u&&K!==m&&d_(_,I,b,S,w,D,K.x,K.y)&&Mr(K.prev,K,K.next)>=0))return!1;K=K.nextZ}for(;X&&X.z>=U;){if(X.x>=P&&X.x<=N&&X.y>=O&&X.y<=V&&X!==u&&X!==m&&d_(_,I,b,S,w,D,X.x,X.y)&&Mr(X.prev,X,X.next)>=0)return!1;X=X.prevZ}for(;K&&K.z<=W;){if(K.x>=P&&K.x<=N&&K.y>=O&&K.y<=V&&K!==u&&K!==m&&d_(_,I,b,S,w,D,K.x,K.y)&&Mr(K.prev,K,K.next)>=0)return!1;K=K.nextZ}return!0}function Fz(r,e){let n=r;do{let a=n.prev,u=n.next.next;!mp(a,u)&&wA(a,n,n.next,u)&&h_(a,u)&&h_(u,a)&&(e.push(a.i,n.i,u.i),f_(n),f_(n.next),n=r=u),n=n.next}while(n!==r);return uh(n)}function kz(r,e,n,a,u,p){let m=r;do{let _=m.next.next;for(;_!==m.prev;){if(m.i!==_.i&&jz(m,_)){let b=EA(m,_);return m=uh(m,m.next),b=uh(b,b.next),u_(m,e,n,a,u,p,0),void u_(b,e,n,a,u,p,0)}_=_.next}m=m.next}while(m!==r)}function Nz(r,e){let n=r.x-e.x;return n===0&&(n=r.y-e.y,n===0)&&(n=(r.next.y-r.y)/(r.next.x-r.x)-(e.next.y-e.y)/(e.next.x-e.x)),n}function zz(r,e){let n=(function(u,p){let m=p,_=u.x,b=u.y,w,I=-1/0;if(mp(u,m))return m;do{if(mp(u,m.next))return m.next;if(b<=m.y&&b>=m.next.y&&m.next.y!==m.y){let N=m.x+(b-m.y)*(m.next.x-m.x)/(m.next.y-m.y);if(N<=_&&N>I&&(I=N,w=m.x<m.next.x?m:m.next,N===_))return w}m=m.next}while(m!==p);if(!w)return null;let S=w,D=w.x,P=w.y,O=1/0;m=w;do{if(_>=m.x&&m.x>=D&&_!==m.x&&bA(b<P?_:I,b,D,P,b<P?I:_,b,m.x,m.y)){let N=Math.abs(b-m.y)/(_-m.x);h_(m,u)&&(N<O||N===O&&(m.x>w.x||m.x===w.x&&Bz(w,m)))&&(w=m,O=N)}m=m.next}while(m!==S);return w})(r,e);if(!n)return e;let a=EA(n,r);return uh(a,a.next),uh(n,n.next)}function Bz(r,e){return Mr(r.prev,r,e.prev)<0&&Mr(e.next,r,r.next)<0}function gE(r,e,n,a,u){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-n)*u|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-a)*u|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Vz(r){let e=r,n=r;do(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next;while(e!==r);return n}function bA(r,e,n,a,u,p,m,_){return(u-m)*(e-_)>=(r-m)*(p-_)&&(r-m)*(a-_)>=(n-m)*(e-_)&&(n-m)*(p-_)>=(u-m)*(a-_)}function d_(r,e,n,a,u,p,m,_){return!(r===m&&e===_)&&bA(r,e,n,a,u,p,m,_)}function jz(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!(function(n,a){let u=n;do{if(u.i!==n.i&&u.next.i!==n.i&&u.i!==a.i&&u.next.i!==a.i&&wA(u,u.next,n,a))return!0;u=u.next}while(u!==n);return!1})(r,e)&&(h_(r,e)&&h_(e,r)&&(function(n,a){let u=n,p=!1,m=(n.x+a.x)/2,_=(n.y+a.y)/2;do u.y>_!=u.next.y>_&&u.next.y!==u.y&&m<(u.next.x-u.x)*(_-u.y)/(u.next.y-u.y)+u.x&&(p=!p),u=u.next;while(u!==n);return p})(r,e)&&(Mr(r.prev,r,e.prev)||Mr(r,e.prev,e))||mp(r,e)&&Mr(r.prev,r,r.next)>0&&Mr(e.prev,e,e.next)>0)}function Mr(r,e,n){return(e.y-r.y)*(n.x-e.x)-(e.x-r.x)*(n.y-e.y)}function mp(r,e){return r.x===e.x&&r.y===e.y}function wA(r,e,n,a){let u=I0(Mr(r,e,n)),p=I0(Mr(r,e,a)),m=I0(Mr(n,a,r)),_=I0(Mr(n,a,e));return u!==p&&m!==_||!(u!==0||!T0(r,n,e))||!(p!==0||!T0(r,a,e))||!(m!==0||!T0(n,r,a))||!(_!==0||!T0(n,e,a))}function T0(r,e,n){return e.x<=Math.max(r.x,n.x)&&e.x>=Math.min(r.x,n.x)&&e.y<=Math.max(r.y,n.y)&&e.y>=Math.min(r.y,n.y)}function I0(r){return r>0?1:r<0?-1:0}function h_(r,e){return Mr(r.prev,r,r.next)<0?Mr(r,e,r.next)>=0&&Mr(r,r.prev,e)>=0:Mr(r,e,r.prev)<0||Mr(r,r.next,e)<0}function EA(r,e){let n=_E(r.i,r.x,r.y),a=_E(e.i,e.x,e.y),u=r.next,p=e.prev;return r.next=e,e.prev=r,n.next=u,u.prev=n,a.next=n,n.prev=a,p.next=a,a.prev=p,a}function TA(r,e,n,a){let u=_E(r,e,n);return a?(u.next=a.next,u.prev=a,a.next.prev=u,a.next=u):(u.prev=u,u.next=u),u}function f_(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function _E(r,e,n){return{i:r,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function p_(r,e){let n=r.length;if(n<=1)return[r];let a=[],u,p;for(let m=0;m<n;m++){let _=dn(r[m]);_!==0&&(r[m].area=Math.abs(_),p===void 0&&(p=_<0),p===_<0?(u&&a.push(u),u=[r[m]]):u.push(r[m]))}if(u&&a.push(u),e>1)for(let m=0;m<a.length;m++)a[m].length<=e||(Fa(a[m],e,1,a[m].length-1,Uz),a[m]=a[m].slice(0,e));return a}function Uz(r,e){return e.area-r.area}function IA(r,e,n=1){if(!r)return null;let a=typeof r=="string"?Eo.from(r).getPrimary():r.getPrimary(),u=typeof r=="string"?null:r.getSecondary();for(let p of[a,u]){if(!p)continue;let m=p.id.toString();e.has(m)||e.set(m,[]),p.scaleSelf(n),e.get(m).push(p)}return{primary:a.toString(),secondary:u?u.toString():null}}function yE(r,e,n,a){let u=a.patternDependencies,p=!1;for(let m of e){let _=m.paint.get(`${r}-pattern`);_.isConstant()||(p=!0),IA(_.constantOr(null),u,n)&&(p=!0)}return p}function vE(r,e,n,a,u,p){let m=p.patternDependencies;for(let _ of e){let b=_.paint.get(`${r}-pattern`).value;if(b.kind!=="constant"){let w=b.evaluate({zoom:a},n,{},p.availableImages);w=w&&w.name?w.name:w;let I=IA(w,m,u);if(!I)continue;let{primary:S,secondary:D}=I;S&&(n.patterns[_.id]=[S,D].filter(Boolean))}}return n}class SA{constructor(){this.polygons=new Map}add(e,...n){let a=this.polygons.get(e);a?a.push(...n):this.polygons.set(e,n)}merge(e){for(let[n,a]of e.polygons)this.add(n,...a)}}class _c{constructor(){this.portals=[]}static isOnBorder(e,n){return e<=0&&n<=0||e>=rt&&n>=rt}static evaluate(e){if(e.length===0)return new _c;let n=[];for(let b of e)n.push(...b.portals);if(n.length===0)return new _c;for(let b of n){let w=b.va,I=b.vb;(_c.isOnBorder(w.x,I.x)||_c.isOnBorder(w.y,I.y))&&(b.type="border")}let a=n.filter(b=>b.type!=="unevaluated"),u=n.filter(b=>b.type==="unevaluated");if(u.length===0)return new _c;u.sort((b,w)=>b.hash===w.hash?b.isTunnel===w.isTunnel?0:b.isTunnel?-1:1:b.hash<w.hash?1:-1),n=a.concat(u);let p=a.length,m=p,_=p;do if(m++,m===n.length||n[p].hash!==n[m].hash){if(m-p==2){_<p&&(n[_]=n[p],n[p]=null);let b=n[_],w=n[m-1];b.type=b.isTunnel!==w.isTunnel?"tunnel":"polygon",b.connection={a:b.connection.a,b:w.connection.a},_++}p=m}while(p!==n.length);return n.splice(_),n.sort((b,w)=>b.hash<w.hash?1:-1),{portals:n}}}vt(_c,"ElevationPortalGraph"),vt(SA,"ElevationPolygons");class Hz{constructor(e,n,a){this.outPositions=e,this.outNormals=n,this.outIndices=a,this.vertexLookup=new Map}addVertex(e,n,a){let u=e[2];a!=null&&(u*=a);let p=`${e[0]},${e[1]},${e[2]},${n[0]},${n[1]},${n[2]}`,m=this.vertexLookup.get(p);if(m!=null)return m;let _=this.outPositions.length;this.vertexLookup.set(p,_);let b=Math.trunc(16384*n[0]),w=Math.trunc(16384*n[1]),I=Math.trunc(16384*n[2]);return this.outPositions.emplaceBack(e[0],e[1],u),this.outNormals.emplaceBack(b,w,I),_}addTriangle(e,n,a){this.outIndices.emplaceBack(e,n,a)}addTriangles(e,n,a){if(e.length===0)return;let u=a.length===1,p=Un(),m=Un();for(let _=0;_<e.length;_+=3){let b=n[e[_+0]],w=n[e[_+1]],I=n[e[_+2]],S=u?a[0]:a[e[_+1]],D=u?a[0]:a[e[_+2]];bi(p,b.x,b.y,u?a[0]:a[e[_+0]]);let P=this.addVertex(p,m);bi(p,w.x,w.y,S);let O=this.addVertex(p,m);bi(p,I.x,I.y,D);let N=this.addVertex(p,m);this.outIndices.emplaceBack(P,O,N)}}addQuad(e,n,a,u,p,m){let _=this.addVertex(e,p,m),b=this.addVertex(n,p,m),w=this.addVertex(a,p,m),I=this.addVertex(u,p,m);this.addTriangle(_,b,w),this.addTriangle(w,I,_)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}}class rs{constructor(e,n,a,u){this.unevaluatedPortals=new _c,this.portalPolygons=new SA,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new $g,this.vertexNormals=new Gg,this.indexArray=new wi,this.tileToMeters=ue(e),this.bridgeProgramConfigurations=new Gs(n,{zoom:a,lut:u},p=>p!=="fill-tunnel-structure-color"),this.tunnelProgramConfigurations=new Gs(n,{zoom:a,lut:u},p=>p!=="fill-bridge-guard-rail-color")}addVertices(e,n){let a=this.unevalVertices.length;for(let u=0;u<e.length;u++)this.unevalVertices.push(e[u]),this.unevalHeights.push(n[u]);return a}addTriangles(e,n,a){let u=a?this.unevalTunnelTriangles:this.unevalTriangles;for(let p of e)u.push(p+n)}addRenderableRing(e,n,a,u,p,m){let _=[new Ze(p.min.x,p.min.y),new Ze(p.max.x,p.min.y),new Ze(p.max.x,p.max.y),new Ze(p.min.x,p.max.y)];for(let b=0;b<a-1;b++){let w=n+b,I=w+1,S=this.unevalVertices[w],D=this.unevalVertices[I];if(!(S.x>=p.min.x&&S.x<=p.max.x&&S.y>=p.min.y&&S.y<=p.max.y||D.x>=p.min.x&&D.x<=p.max.x&&D.y>=p.min.y&&D.y<=p.max.y||Gi(S,D,_))||this.isOnBorder(S.x,D.x)||this.isOnBorder(S.y,D.y))continue;let P=rs.computeEdgeHash(this.unevalVertices[w],this.unevalVertices[I]),O,N=this.vertexHashLookup.get(rs.computePosHash(S));N!=null?O=N.next:(N=this.vertexHashLookup.get(rs.computePosHash(D)),O=N!=null?N.prev:P),this.unevalEdges.push({polygonIdx:e,a:w,b:I,hash:P,portalHash:O,isTunnel:u,type:"unevaluated",featureInfo:m})}}addPortalCandidates(e,n,a,u,p){if(n.length===0)return;this.portalPolygons.add(e,{geometry:n,zLevel:p});let m=n[0];this.vertexHashLookup.clear();let _=rs.computeEdgeHash(m[m.length-2],m[m.length-1]);for(let b=0;b<m.length-1;b++){let w=m[b+0],I=m[b+1],S=Zl(I.x-w.x,I.y-w.y),D=Ri(S);if(D===0)continue;let P="unevaluated",O=u.pointElevation(w),N=u.pointElevation(I);Math.abs(O)<.01&&Math.abs(N)<.01?P="entrance":(this.isOnBorder(w.x,I.x)||this.isOnBorder(w.y,I.y))&&(P="border");let V=rs.computeEdgeHash(w,I);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:w,vb:I,vab:S,length:D,hash:V,isTunnel:a,type:P});let U=rs.computePosHash(w);this.vertexHashLookup.set(U,{prev:_,next:V}),_=V}}construct(e){if(this.unevalVertices.length===0)return;let n=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),a=D=>{D.primitiveLength=this.indexArray.length-D.primitiveOffset},u=new Hz(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);let p=n(),m=n(),_=n(),b=(D,P)=>{D.sort((N,V)=>N.type===P&&V.type!==P?-1:N.type!==P&&V.type===P?1:0);let O=D.findIndex(N=>N.type!==P);return O>=0?O:D.length},w=0;this.unevalEdges.length>0&&(w=b(this.unevalEdges,"none"),this.constructBridgeStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},this.tileToMeters)),a(_);let I=n(),S=n();if(this.unevalEdges.length>0){let D=this.unevalEdges.splice(w),P=b(D,"tunnel")+w;this.unevalEdges.push(...D),this.constructTunnelStructures(u,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:w},{min:w,max:P})}a(I),u.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),a(S),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),a(m),u.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),a(p),this.maskSegments=Ci.simpleSegment(0,S.primitiveOffset,0,S.primitiveLength),this.depthSegments=Ci.simpleSegment(0,m.primitiveOffset,0,m.primitiveLength),this.renderableBridgeSegments=Ci.simpleSegment(0,_.primitiveOffset,0,_.primitiveLength),this.renderableTunnelSegments=Ci.simpleSegment(0,I.primitiveOffset,0,I.primitiveLength),this.shadowCasterSegments=Ci.simpleSegment(0,p.primitiveOffset,0,p.primitiveLength)}update(e,n,a,u,p,m,_,b){this.bridgeProgramConfigurations.updatePaintArrays(e,n,p,a,u,m,_,b),this.tunnelProgramConfigurations.updatePaintArrays(e,n,p,a,u,m,_,b)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,Rz.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,Pz.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,n,a,u,p){let m=(_,b)=>{for(let w=0;w<b.length-1;w++){let I=b[w].featureIndex,S=b[w+1].vertexStart,D=e.feature(I);_.populatePaintArrays(S,D,I,{},a,n,u,void 0,p)}};m(this.bridgeProgramConfigurations,this.bridgeFeatureSections),m(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,n,a,u,p){let m=new Map;for(let _=u;_<p;_++){let b=a[_],w=b.a,I=b.b,S=rs.computePosHash(e[w]),D=rs.computePosHash(e[I]),P=m.get(S);P||(P={},m.set(S,P));let O=m.get(D);O||(O={},m.set(D,O)),n[w]<=0&&n[I]<=0||(P.to=I,O.from=w)}return m}isTerminalVertex(e,n){let a=rs.computePosHash(this.unevalVertices[e]),u=n.get(a);return!u||!u.from||!u.to}constructBridgeStructures(e,n,a,u,p,m){e.clearVertexLookup();let _=this.computeVertexConnections(n,a,u,p.min,p.max),b=1/m,w=.5*b,I=(nt,Ye)=>bi(nt,n[Ye].x,n[Ye].y,a[Ye]*b),S=Un(),D=Un(),P=Un(),O=Un(),N=Un(),V=(nt,Ye)=>{let Ue=_.get(rs.computePosHash(n[Ye])),Xe=Ue.from,Re=Ue.to;if(!Xe||!Re)return;I(S,Xe),I(D,Ye),I(P,Re),Vs(O),aa(S,D)||(tr(N,D,S),li(O,N)),aa(P,D)||(tr(N,P,D),or(O,O,li(N,N)));let Ae=Gl(O);return Ae>0?Mi(nt,O,1/Ae):void 0},U=Number.POSITIVE_INFINITY;this.sortSubarray(u,p.min,p.max,(nt,Ye)=>nt.featureInfo.featureIndex-Ye.featureInfo.featureIndex);let W=Un(),X=Un(),K=Un(),le=Un(),re=Un(),de=Un(),pe=Un(),ge=Un(),Le=Un(),Te=[Un(),Un(),Un(),Un()],ke=[Un(),Un(),Un(),Un()],je=[{coord:new Ze(0,0),height:0},{coord:new Ze(0,0),height:0}],$e=(nt,Ye)=>nt>Ye;for(let nt=p.min;nt<p.max;nt++){let Ye=u[nt];if(!Ye.featureInfo.guardRailEnabled||!this.prepareEdgePoints(je,n,a,Ye,$e))continue;let[Ue,Xe]=je;if(bi(W,Ue.coord.x,Ue.coord.y,b*Ue.height),bi(X,Xe.coord.x,Xe.coord.y,b*Xe.height),aa(W,X))continue;tr(K,X,W),li(K,K);let Re=V(ge,Ye.a)||K,Ae=V(Le,Ye.b)||K;bi(le,Re[1],-Re[0],0),li(le,le),bi(re,Ae[1],-Ae[0],0),li(re,re),Or(ge,le,Re),li(de,ge),Or(ge,re,Ae),li(pe,ge),or(Te[0],W,Mi(ge,tr(ge,le,de),w)),or(Te[1],W,Mi(ge,or(ge,le,de),w)),or(Te[2],W,Mi(ge,de,w)),Te[3]=W,or(ke[0],X,Mi(ge,tr(ge,re,pe),w)),or(ke[1],X,Mi(ge,or(ge,re,pe),w)),or(ke[2],X,Mi(ge,pe,w)),ke[3]=X,U=this.addFeatureSection(Ye.featureInfo.featureIndex,U,this.bridgeFeatureSections,e);let qe=e.addVertex(Te[0],le,m),Qe=e.addVertex(Te[1],le,m),He=e.addVertex(ke[0],re,m),_t=e.addVertex(ke[1],re,m);e.addTriangle(qe,Qe,He),e.addTriangle(Qe,_t,He);let bt=e.addVertex(Te[1],de,m),ft=e.addVertex(Te[2],de,m),at=e.addVertex(ke[1],pe,m),Gt=e.addVertex(ke[2],pe,m);e.addTriangle(bt,ft,at),e.addTriangle(ft,Gt,at),sa(le,le),sa(re,re);let ut=e.addVertex(Te[2],le,m),Mt=e.addVertex(Te[3],le,m),Zt=e.addVertex(ke[2],re,m),an=e.addVertex(ke[3],re,m);e.addTriangle(ut,Mt,Zt),e.addTriangle(Mt,an,Zt);let En=this.isTerminalVertex(Ye.a,_),Yt=this.isTerminalVertex(Ye.b,_);Ue.height<.01&&En&&e.addQuad(Te[3],Te[2],Te[1],Te[0],sa(Re,Re),m),Xe.height<.01&&Yt&&e.addQuad(ke[0],ke[1],ke[2],ke[3],Ae,m)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,n,a,u,p,m){e.clearVertexLookup();let _=Number.POSITIVE_INFINITY,b=(U,W)=>U.featureInfo.featureIndex-W.featureInfo.featureIndex;this.sortSubarray(u,p.min,p.max,b),this.sortSubarray(u,m.min,m.max,b);let w=U=>li(U,U),I=[{coord:new Ze(0,0),height:0},{coord:new Ze(0,0),height:0}],S=(U,W)=>U<W,D=Un(),P=Un(),O=Un(),N=Un(),V=Un();for(let U=p.min;U<p.max;U++){if(!this.prepareEdgePoints(I,n,a,u[U],S))continue;let[W,X]=I,K=w(bi(V,-(X.coord.y-W.coord.y),X.coord.x-W.coord.x,0));_=this.addFeatureSection(u[U].featureInfo.featureIndex,_,this.tunnelFeatureSections,e),e.addQuad(bi(D,W.coord.x,W.coord.y,W.height),bi(P,X.coord.x,X.coord.y,X.height),bi(O,X.coord.x,X.coord.y,u[U].isTunnel?-.1:0),bi(N,W.coord.x,W.coord.y,u[U].isTunnel?-.1:0),K)}for(let U=m.min;U<m.max;U++){let W=u[U];W.isTunnel&&([W.a,W.b]=[W.b,W.a]);let X=n[W.a],K=n[W.b],le=w(bi(V,-(K.y-X.y),K.x-X.x,0));_=this.addFeatureSection(W.featureInfo.featureIndex,_,this.tunnelFeatureSections,e),e.addQuad(bi(D,K.x,K.y,0),bi(P,X.x,X.y,0),bi(O,X.x,X.y,a[W.a]+4),bi(N,K.x,K.y,a[W.b]+4),le),e.addQuad(bi(D,X.x,X.y,0),bi(P,K.x,K.y,0),bi(O,K.x,K.y,a[W.b]+4),bi(N,X.x,X.y,a[W.a]+4),le)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,n,a,u){e.coord.x=n,e.coord.y=a,e.height=u}prepareEdgePoints(e,n,a,u,p){let m=n[u.a].x,_=n[u.a].y,b=n[u.b].x,w=n[u.b].y,I=a[u.a],S=a[u.b],D=p(I,0),P=p(S,0);if(D&&P)return this.setElevatedPoint(e[0],m,_,I),this.setElevatedPoint(e[1],b,w,S),!0;if(!D&&!P)return!1;if(D){if(!P){let O=S/(S-I);b=zt(b,m,O),w=zt(w,_,O),S=zt(S,I,O)}}else{let O=I/(I-S);m=zt(m,b,O),_=zt(_,w,O),I=zt(I,S,O)}return this.setElevatedPoint(e[0],m,_,I),this.setElevatedPoint(e[1],b,w,S),!0}prepareEdges(e,n){if(n.length===0)return;n.sort((_,b)=>_.hash===b.hash?b.polygonIdx-_.polygonIdx:b.hash>_.hash?1:-1);let a=0,u=0,p=0,m=n[a].polygonIdx;do u++,(u===n.length||n[a].hash!==n[u].hash)&&((u-a==1||n[u-1].polygonIdx!==m)&&(p<a&&(n[p]=n[a],n[a]=null),n[p].type="none",p++),a=u,a!==n.length&&(m=n[a].polygonIdx));while(a!==n.length);if(n.splice(p),n.length!==0&&e.length!==0){n.sort((w,I)=>w.portalHash<I.portalHash?1:-1);let _=0,b=0;for(;_!==n.length&&b!==e.length;){let w=n[_],I=e[b];w.portalHash>I.hash?_++:I.hash>w.portalHash?b++:(w.type=I.type,_++)}}}isOnBorder(e,n){return e<=0&&n<=0||e>=rt&&n>=rt}addFeatureSection(e,n,a,u){return e!==n&&(n=e,a.push({featureIndex:e,vertexStart:u.getVertexCount()}),u.clearVertexLookup()),n}sortSubarray(e,n,a,u){let p=e.slice(n,a);p.sort(u),e.splice(n,p.length,...p)}static computeEdgeHash(e,n){return(e.y===n.y&&e.x>n.x||e.y>n.y)&&([e,n]=[n,e]),BigInt(rs.computePosHash(e))<<32n|BigInt(rs.computePosHash(n))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var DA,CA={exports:{}},AA=(DA||(DA=1,(function(r,e){(function(n){function a(oe,te){return oe>te?1:oe<te?-1:0}var u=function(oe,te){oe===void 0&&(oe=a),te===void 0&&(te=!1),this._compare=oe,this._root=null,this._size=0,this._noDuplicates=!!te},p={size:{configurable:!0}};function m(oe,te,Ne,st,ze){var lt=ze-st;if(lt>0){var Dt=st+Math.floor(lt/2),It={key:te[Dt],data:Ne[Dt],parent:oe};return It.left=m(It,te,Ne,st,Dt),It.right=m(It,te,Ne,Dt+1,ze),It}return null}function _(oe,te,Ne,st,ze){if(!(Ne>=st)){for(var lt=oe[Ne+st>>1],Dt=Ne-1,It=st+1;;){do Dt++;while(ze(oe[Dt],lt)<0);do It--;while(ze(oe[It],lt)>0);if(Dt>=It)break;var Jt=oe[Dt];oe[Dt]=oe[It],oe[It]=Jt,Jt=te[Dt],te[Dt]=te[It],te[It]=Jt}_(oe,te,Ne,It,ze),_(oe,te,It+1,st,ze)}}u.prototype.rotateLeft=function(oe){var te=oe.right;te&&(oe.right=te.left,te.left&&(te.left.parent=oe),te.parent=oe.parent),oe.parent?oe===oe.parent.left?oe.parent.left=te:oe.parent.right=te:this._root=te,te&&(te.left=oe),oe.parent=te},u.prototype.rotateRight=function(oe){var te=oe.left;te&&(oe.left=te.right,te.right&&(te.right.parent=oe),te.parent=oe.parent),oe.parent?oe===oe.parent.left?oe.parent.left=te:oe.parent.right=te:this._root=te,te&&(te.right=oe),oe.parent=te},u.prototype._splay=function(oe){for(;oe.parent;){var te=oe.parent;te.parent?te.left===oe&&te.parent.left===te?(this.rotateRight(te.parent),this.rotateRight(te)):te.right===oe&&te.parent.right===te?(this.rotateLeft(te.parent),this.rotateLeft(te)):te.left===oe&&te.parent.right===te?(this.rotateRight(te),this.rotateLeft(te)):(this.rotateLeft(te),this.rotateRight(te)):te.left===oe?this.rotateRight(te):this.rotateLeft(te)}},u.prototype.splay=function(oe){for(var te,Ne,st,ze,lt;oe.parent;)(Ne=(te=oe.parent).parent)&&Ne.parent?((st=Ne.parent).left===Ne?st.left=oe:st.right=oe,oe.parent=st):(oe.parent=null,this._root=oe),ze=oe.left,lt=oe.right,oe===te.left?(Ne&&(Ne.left===te?(te.right?(Ne.left=te.right,Ne.left.parent=Ne):Ne.left=null,te.right=Ne,Ne.parent=te):(ze?(Ne.right=ze,ze.parent=Ne):Ne.right=null,oe.left=Ne,Ne.parent=oe)),lt?(te.left=lt,lt.parent=te):te.left=null,oe.right=te,te.parent=oe):(Ne&&(Ne.right===te?(te.left?(Ne.right=te.left,Ne.right.parent=Ne):Ne.right=null,te.left=Ne,Ne.parent=te):(lt?(Ne.left=lt,lt.parent=Ne):Ne.left=null,oe.right=Ne,Ne.parent=oe)),ze?(te.right=ze,ze.parent=te):te.right=null,oe.left=te,te.parent=oe)},u.prototype.replace=function(oe,te){oe.parent?oe===oe.parent.left?oe.parent.left=te:oe.parent.right=te:this._root=te,te&&(te.parent=oe.parent)},u.prototype.minNode=function(oe){if(oe===void 0&&(oe=this._root),oe)for(;oe.left;)oe=oe.left;return oe},u.prototype.maxNode=function(oe){if(oe===void 0&&(oe=this._root),oe)for(;oe.right;)oe=oe.right;return oe},u.prototype.insert=function(oe,te){var Ne=this._root,st=null,ze=this._compare;if(this._noDuplicates)for(;Ne;){if(st=Ne,ze(Ne.key,oe)===0)return;Ne=ze(Ne.key,oe)<0?Ne.right:Ne.left}else for(;Ne;)st=Ne,Ne=ze(Ne.key,oe)<0?Ne.right:Ne.left;return Ne={key:oe,data:te,left:null,right:null,parent:st},st?ze(st.key,Ne.key)<0?st.right=Ne:st.left=Ne:this._root=Ne,this.splay(Ne),this._size++,Ne},u.prototype.find=function(oe){for(var te=this._root,Ne=this._compare;te;){var st=Ne(te.key,oe);if(st<0)te=te.right;else{if(!(st>0))return te;te=te.left}}return null},u.prototype.contains=function(oe){for(var te=this._root,Ne=this._compare;te;){var st=Ne(oe,te.key);if(st===0)return!0;te=st<0?te.left:te.right}return!1},u.prototype.remove=function(oe){var te=this.find(oe);if(!te)return!1;if(this.splay(te),te.left)if(te.right){var Ne=this.minNode(te.right);Ne.parent!==te&&(this.replace(Ne,Ne.right),Ne.right=te.right,Ne.right.parent=Ne),this.replace(te,Ne),Ne.left=te.left,Ne.left.parent=Ne}else this.replace(te,te.left);else this.replace(te,te.right);return this._size--,!0},u.prototype.removeNode=function(oe){if(!oe)return!1;if(this.splay(oe),oe.left)if(oe.right){var te=this.minNode(oe.right);te.parent!==oe&&(this.replace(te,te.right),te.right=oe.right,te.right.parent=te),this.replace(oe,te),te.left=oe.left,te.left.parent=te}else this.replace(oe,oe.left);else this.replace(oe,oe.right);return this._size--,!0},u.prototype.erase=function(oe){var te=this.find(oe);if(te){this.splay(te);var Ne=te.left,st=te.right,ze=null;Ne&&(Ne.parent=null,ze=this.maxNode(Ne),this.splay(ze),this._root=ze),st&&(Ne?ze.right=st:this._root=st,st.parent=ze),this._size--}},u.prototype.pop=function(){var oe=this._root,te=null;if(oe){for(;oe.left;)oe=oe.left;te={key:oe.key,data:oe.data},this.remove(oe.key)}return te},u.prototype.next=function(oe){var te=oe;if(te)if(te.right)for(te=te.right;te&&te.left;)te=te.left;else for(te=oe.parent;te&&te.right===oe;)oe=te,te=te.parent;return te},u.prototype.prev=function(oe){var te=oe;if(te)if(te.left)for(te=te.left;te&&te.right;)te=te.right;else for(te=oe.parent;te&&te.left===oe;)oe=te,te=te.parent;return te},u.prototype.forEach=function(oe){for(var te=this._root,Ne=[],st=!1,ze=0;!st;)te?(Ne.push(te),te=te.left):Ne.length>0?(oe(te=Ne.pop(),ze++),te=te.right):st=!0;return this},u.prototype.range=function(oe,te,Ne,st){for(var ze=[],lt=this._compare,Dt=this._root;ze.length!==0||Dt;)if(Dt)ze.push(Dt),Dt=Dt.left;else{if(lt((Dt=ze.pop()).key,te)>0)break;if(lt(Dt.key,oe)>=0&&Ne.call(st,Dt))return this;Dt=Dt.right}return this},u.prototype.keys=function(){for(var oe=this._root,te=[],Ne=[],st=!1;!st;)oe?(te.push(oe),oe=oe.left):te.length>0?(oe=te.pop(),Ne.push(oe.key),oe=oe.right):st=!0;return Ne},u.prototype.values=function(){for(var oe=this._root,te=[],Ne=[],st=!1;!st;)oe?(te.push(oe),oe=oe.left):te.length>0?(oe=te.pop(),Ne.push(oe.data),oe=oe.right):st=!0;return Ne},u.prototype.at=function(oe){for(var te=this._root,Ne=[],st=!1,ze=0;!st;)if(te)Ne.push(te),te=te.left;else if(Ne.length>0){if(te=Ne.pop(),ze===oe)return te;ze++,te=te.right}else st=!0;return null},u.prototype.load=function(oe,te,Ne){if(oe===void 0&&(oe=[]),te===void 0&&(te=[]),Ne===void 0&&(Ne=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var st=oe.length;return Ne&&_(oe,te,0,st-1,this._compare),this._root=m(null,oe,te,0,st),this._size=st,this},u.prototype.min=function(){var oe=this.minNode(this._root);return oe?oe.key:null},u.prototype.max=function(){var oe=this.maxNode(this._root);return oe?oe.key:null},u.prototype.isEmpty=function(){return this._root===null},p.size.get=function(){return this._size},u.createTree=function(oe,te,Ne,st,ze){return new u(Ne,ze).load(oe,te,st)},Object.defineProperties(u.prototype,p);var b=0,w=1,I=2,S=3,D=0,P=1,O=2,N=3;function V(oe,te,Ne){te===null?(oe.inOut=!1,oe.otherInOut=!0):(oe.isSubject===te.isSubject?(oe.inOut=!te.inOut,oe.otherInOut=te.otherInOut):(oe.inOut=!te.otherInOut,oe.otherInOut=te.isVertical()?!te.inOut:te.inOut),te&&(oe.prevInResult=!U(te,Ne)||te.isVertical()?te.prevInResult:te));var st=U(oe,Ne);oe.resultTransition=st?(function(ze,lt){var Dt,It=!ze.inOut,Jt=!ze.otherInOut;switch(lt){case D:Dt=It&&Jt;break;case P:Dt=It||Jt;break;case N:Dt=It^Jt;break;case O:Dt=ze.isSubject?It&&!Jt:Jt&&!It}return Dt?1:-1})(oe,Ne):0}function U(oe,te){switch(oe.type){case b:switch(te){case D:return!oe.otherInOut;case P:return oe.otherInOut;case O:return oe.isSubject&&oe.otherInOut||!oe.isSubject&&!oe.otherInOut;case N:return!0}break;case I:return te===D||te===P;case S:return te===O;case w:return!1}return!1}var W=function(oe,te,Ne,st,ze){this.left=te,this.point=oe,this.otherEvent=Ne,this.isSubject=st,this.type=ze||b,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},X={inResult:{configurable:!0}};function K(oe,te){return oe[0]===te[0]&&oe[1]===te[1]}W.prototype.isBelow=function(oe){var te=this.point,Ne=this.otherEvent.point;return this.left?(te[0]-oe[0])*(Ne[1]-oe[1])-(Ne[0]-oe[0])*(te[1]-oe[1])>0:(Ne[0]-oe[0])*(te[1]-oe[1])-(te[0]-oe[0])*(Ne[1]-oe[1])>0},W.prototype.isAbove=function(oe){return!this.isBelow(oe)},W.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},X.inResult.get=function(){return this.resultTransition!==0},W.prototype.clone=function(){var oe=new W(this.point,this.left,this.otherEvent,this.isSubject,this.type);return oe.contourId=this.contourId,oe.resultTransition=this.resultTransition,oe.prevInResult=this.prevInResult,oe.isExteriorRing=this.isExteriorRing,oe.inOut=this.inOut,oe.otherInOut=this.otherInOut,oe},Object.defineProperties(W.prototype,X);var le=11102230246251565e-32,re=134217729,de=(3+8*le)*le;function pe(oe,te,Ne,st,ze){var lt,Dt,It,Jt,Ft=te[0],Et=st[0],Dn=0,Kn=0;Et>Ft==Et>-Ft?(lt=Ft,Ft=te[++Dn]):(lt=Et,Et=st[++Kn]);var Nt=0;if(Dn<oe&&Kn<Ne)for(Et>Ft==Et>-Ft?(It=lt-((Dt=Ft+lt)-Ft),Ft=te[++Dn]):(It=lt-((Dt=Et+lt)-Et),Et=st[++Kn]),lt=Dt,It!==0&&(ze[Nt++]=It);Dn<oe&&Kn<Ne;)Et>Ft==Et>-Ft?(It=lt-((Dt=lt+Ft)-(Jt=Dt-lt))+(Ft-Jt),Ft=te[++Dn]):(It=lt-((Dt=lt+Et)-(Jt=Dt-lt))+(Et-Jt),Et=st[++Kn]),lt=Dt,It!==0&&(ze[Nt++]=It);for(;Dn<oe;)It=lt-((Dt=lt+Ft)-(Jt=Dt-lt))+(Ft-Jt),Ft=te[++Dn],lt=Dt,It!==0&&(ze[Nt++]=It);for(;Kn<Ne;)It=lt-((Dt=lt+Et)-(Jt=Dt-lt))+(Et-Jt),Et=st[++Kn],lt=Dt,It!==0&&(ze[Nt++]=It);return lt===0&&Nt!==0||(ze[Nt++]=lt),Nt}function ge(oe){return new Float64Array(oe)}var Le=33306690738754716e-32,Te=22204460492503146e-32,ke=11093356479670487e-47,je=ge(4),$e=ge(8),nt=ge(12),Ye=ge(16),Ue=ge(4);function Xe(oe,te,Ne){var st=(function(ze,lt,Dt,It,Jt,Ft){var Et=(lt-Ft)*(Dt-Jt),Dn=(ze-Jt)*(It-Ft),Kn=Et-Dn;if(Et===0||Dn===0||Et>0!=Dn>0)return Kn;var Nt=Math.abs(Et+Dn);return Math.abs(Kn)>=Le*Nt?Kn:-(function(bn,Jn,zn,Fi,gi,si,$n){var Mn,Qt,Rn,ai,kt,Tn,_i,Ui,Ki,fr,yi,lr,zo,cr,ss,Kr,Ws,Bo,as=bn-gi,Jr=zn-gi,ls=Jn-si,Zs=Fi-si;je[0]=(ss=(Ui=as-(_i=(Tn=re*as)-(Tn-as)))*(fr=Zs-(Ki=(Tn=re*Zs)-(Tn-Zs)))-((cr=as*Zs)-_i*Ki-Ui*Ki-_i*fr))-((yi=ss-(Ws=(Ui=ls-(_i=(Tn=re*ls)-(Tn-ls)))*(fr=Jr-(Ki=(Tn=re*Jr)-(Tn-Jr)))-((Kr=ls*Jr)-_i*Ki-Ui*Ki-_i*fr)))+(kt=ss-yi))+(kt-Ws),je[1]=(zo=cr-((lr=cr+yi)-(kt=lr-cr))+(yi-kt))-((yi=zo-Kr)+(kt=zo-yi))+(kt-Kr),je[2]=lr-((Bo=lr+yi)-(kt=Bo-lr))+(yi-kt),je[3]=Bo;var zr=(function(zu,Dl){for(var mx=Dl[0],Lp=1;Lp<4;Lp++)mx+=Dl[Lp];return mx})(0,je),mo=Te*$n;if(zr>=mo||-zr>=mo||(Mn=bn-(as+(kt=bn-as))+(kt-gi),Rn=zn-(Jr+(kt=zn-Jr))+(kt-gi),Qt=Jn-(ls+(kt=Jn-ls))+(kt-si),ai=Fi-(Zs+(kt=Fi-Zs))+(kt-si),Mn===0&&Qt===0&&Rn===0&&ai===0)||(mo=ke*$n+de*Math.abs(zr),(zr+=as*ai+Zs*Mn-(ls*Rn+Jr*Qt))>=mo||-zr>=mo))return zr;Ue[0]=(ss=(Ui=Mn-(_i=(Tn=re*Mn)-(Tn-Mn)))*(fr=Zs-(Ki=(Tn=re*Zs)-(Tn-Zs)))-((cr=Mn*Zs)-_i*Ki-Ui*Ki-_i*fr))-((yi=ss-(Ws=(Ui=Qt-(_i=(Tn=re*Qt)-(Tn-Qt)))*(fr=Jr-(Ki=(Tn=re*Jr)-(Tn-Jr)))-((Kr=Qt*Jr)-_i*Ki-Ui*Ki-_i*fr)))+(kt=ss-yi))+(kt-Ws),Ue[1]=(zo=cr-((lr=cr+yi)-(kt=lr-cr))+(yi-kt))-((yi=zo-Kr)+(kt=zo-yi))+(kt-Kr),Ue[2]=lr-((Bo=lr+yi)-(kt=Bo-lr))+(yi-kt),Ue[3]=Bo;var Sl=pe(4,je,4,Ue,$e);Ue[0]=(ss=(Ui=as-(_i=(Tn=re*as)-(Tn-as)))*(fr=ai-(Ki=(Tn=re*ai)-(Tn-ai)))-((cr=as*ai)-_i*Ki-Ui*Ki-_i*fr))-((yi=ss-(Ws=(Ui=ls-(_i=(Tn=re*ls)-(Tn-ls)))*(fr=Rn-(Ki=(Tn=re*Rn)-(Tn-Rn)))-((Kr=ls*Rn)-_i*Ki-Ui*Ki-_i*fr)))+(kt=ss-yi))+(kt-Ws),Ue[1]=(zo=cr-((lr=cr+yi)-(kt=lr-cr))+(yi-kt))-((yi=zo-Kr)+(kt=zo-yi))+(kt-Kr),Ue[2]=lr-((Bo=lr+yi)-(kt=Bo-lr))+(yi-kt),Ue[3]=Bo;var Nu=pe(Sl,$e,4,Ue,nt);Ue[0]=(ss=(Ui=Mn-(_i=(Tn=re*Mn)-(Tn-Mn)))*(fr=ai-(Ki=(Tn=re*ai)-(Tn-ai)))-((cr=Mn*ai)-_i*Ki-Ui*Ki-_i*fr))-((yi=ss-(Ws=(Ui=Qt-(_i=(Tn=re*Qt)-(Tn-Qt)))*(fr=Rn-(Ki=(Tn=re*Rn)-(Tn-Rn)))-((Kr=Qt*Rn)-_i*Ki-Ui*Ki-_i*fr)))+(kt=ss-yi))+(kt-Ws),Ue[1]=(zo=cr-((lr=cr+yi)-(kt=lr-cr))+(yi-kt))-((yi=zo-Kr)+(kt=zo-yi))+(kt-Kr),Ue[2]=lr-((Bo=lr+yi)-(kt=Bo-lr))+(yi-kt),Ue[3]=Bo;var Op=pe(Nu,nt,4,Ue,Ye);return Ye[Op-1]})(ze,lt,Dt,It,Jt,Ft,Nt)})(oe[0],oe[1],te[0],te[1],Ne[0],Ne[1]);return st>0?-1:st<0?1:0}function Re(oe,te){var Ne=oe.point,st=te.point;return Ne[0]>st[0]?1:Ne[0]<st[0]?-1:Ne[1]!==st[1]?Ne[1]>st[1]?1:-1:(function(ze,lt,Dt,It){return ze.left!==lt.left?ze.left?1:-1:Xe(Dt,ze.otherEvent.point,lt.otherEvent.point)!==0?ze.isBelow(lt.otherEvent.point)?-1:1:!ze.isSubject&&lt.isSubject?1:-1})(oe,te,Ne)}function Ae(oe,te,Ne){var st=new W(te,!1,oe,oe.isSubject),ze=new W(te,!0,oe.otherEvent,oe.isSubject);return K(oe.point,oe.otherEvent.point)&&console.warn("what is that, a collapsed segment?",oe),st.contourId=ze.contourId=oe.contourId,Re(ze,oe.otherEvent)>0&&(oe.otherEvent.left=!0,ze.left=!1),oe.otherEvent.otherEvent=ze,oe.otherEvent=st,Ne.push(ze),Ne.push(st),Ne}function qe(oe,te){return oe[0]*te[1]-oe[1]*te[0]}function Qe(oe,te){return oe[0]*te[0]+oe[1]*te[1]}function He(oe,te,Ne){var st=(function(Jt,Ft,Et,Dn,Kn){var Nt=[Ft[0]-Jt[0],Ft[1]-Jt[1]],bn=[Dn[0]-Et[0],Dn[1]-Et[1]];function Jn(Tn,_i,Ui){return[Tn[0]+_i*Ui[0],Tn[1]+_i*Ui[1]]}var zn=[Et[0]-Jt[0],Et[1]-Jt[1]],Fi=qe(Nt,bn),gi=Fi*Fi,si=Qe(Nt,Nt);if(gi>0){var $n=qe(zn,bn)/Fi;if($n<0||$n>1)return null;var Mn=qe(zn,Nt)/Fi;return Mn<0||Mn>1?null:$n===0||$n===1?[Jn(Jt,$n,Nt)]:Mn===0||Mn===1?[Jn(Et,Mn,bn)]:[Jn(Jt,$n,Nt)]}if((gi=(Fi=qe(zn,Nt))*Fi)>0)return null;var Qt=Qe(Nt,zn)/si,Rn=Qt+Qe(Nt,bn)/si,ai=Math.min(Qt,Rn),kt=Math.max(Qt,Rn);return ai<=1&&kt>=0?ai===1?[Jn(Jt,ai>0?ai:0,Nt)]:kt===0?[Jn(Jt,kt<1?kt:1,Nt)]:[Jn(Jt,ai>0?ai:0,Nt),Jn(Jt,kt<1?kt:1,Nt)]:null})(oe.point,oe.otherEvent.point,te.point,te.otherEvent.point),ze=st?st.length:0;if(ze===0||ze===1&&(K(oe.point,te.point)||K(oe.otherEvent.point,te.otherEvent.point))||ze===2&&oe.isSubject===te.isSubject)return 0;if(ze===1)return K(oe.point,st[0])||K(oe.otherEvent.point,st[0])||Ae(oe,st[0],Ne),K(te.point,st[0])||K(te.otherEvent.point,st[0])||Ae(te,st[0],Ne),1;var lt=[],Dt=!1,It=!1;return K(oe.point,te.point)?Dt=!0:Re(oe,te)===1?lt.push(te,oe):lt.push(oe,te),K(oe.otherEvent.point,te.otherEvent.point)?It=!0:Re(oe.otherEvent,te.otherEvent)===1?lt.push(te.otherEvent,oe.otherEvent):lt.push(oe.otherEvent,te.otherEvent),Dt&&It||Dt?(te.type=w,oe.type=te.inOut===oe.inOut?I:S,Dt&&!It&&Ae(lt[1].otherEvent,lt[0].point,Ne),2):It?(Ae(lt[0],lt[1].point,Ne),3):lt[0]!==lt[3].otherEvent?(Ae(lt[0],lt[1].point,Ne),Ae(lt[1],lt[2].point,Ne),3):(Ae(lt[0],lt[1].point,Ne),Ae(lt[3].otherEvent,lt[2].point,Ne),3)}function _t(oe,te){if(oe===te)return 0;if(Xe(oe.point,oe.otherEvent.point,te.point)!==0||Xe(oe.point,oe.otherEvent.point,te.otherEvent.point)!==0)return K(oe.point,te.point)?oe.isBelow(te.otherEvent.point)?-1:1:oe.point[0]===te.point[0]?oe.point[1]<te.point[1]?-1:1:Re(oe,te)===1?te.isAbove(oe.point)?-1:1:oe.isBelow(te.point)?-1:1;if(oe.isSubject!==te.isSubject)return oe.isSubject?-1:1;var Ne=oe.point,st=te.point;return Ne[0]===st[0]&&Ne[1]===st[1]?(Ne=oe.otherEvent.point)[0]===(st=te.otherEvent.point)[0]&&Ne[1]===st[1]?0:oe.contourId>te.contourId?1:-1:Re(oe,te)===1?1:-1}var bt=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function ft(oe,te,Ne,st){var ze,lt=oe+1,Dt=te[oe].point,It=te.length;for(lt<It&&(ze=te[lt].point);lt<It&&ze[0]===Dt[0]&&ze[1]===Dt[1];){if(!Ne[lt])return lt;++lt<It&&(ze=te[lt].point)}for(lt=oe-1;Ne[lt]&&lt>st;)lt--;return lt}bt.prototype.isExterior=function(){return this.holeOf==null};var at=ut,Gt=ut;function ut(oe,te){if(!(this instanceof ut))return new ut(oe,te);if(this.data=oe||[],this.length=this.data.length,this.compare=te||Mt,this.length>0)for(var Ne=(this.length>>1)-1;Ne>=0;Ne--)this._down(Ne)}function Mt(oe,te){return oe<te?-1:oe>te?1:0}ut.prototype={push:function(oe){this.data.push(oe),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var oe=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),oe}},peek:function(){return this.data[0]},_up:function(oe){for(var te=this.data,Ne=this.compare,st=te[oe];oe>0;){var ze=oe-1>>1,lt=te[ze];if(Ne(st,lt)>=0)break;te[oe]=lt,oe=ze}te[oe]=st},_down:function(oe){for(var te=this.data,Ne=this.compare,st=this.length>>1,ze=te[oe];oe<st;){var lt=1+(oe<<1),Dt=lt+1,It=te[lt];if(Dt<this.length&&Ne(te[Dt],It)<0&&(lt=Dt,It=te[Dt]),Ne(It,ze)>=0)break;te[oe]=It,oe=lt}te[oe]=ze}},at.default=Gt;var Zt=Math.max,an=Math.min,En=0;function Yt(oe,te,Ne,st,ze,lt){var Dt,It,Jt,Ft,Et,Dn;for(Dt=0,It=oe.length-1;Dt<It;Dt++)if(Ft=oe[Dt+1],Et=new W(Jt=oe[Dt],!1,void 0,te),Dn=new W(Ft,!1,Et,te),Et.otherEvent=Dn,Jt[0]!==Ft[0]||Jt[1]!==Ft[1]){Et.contourId=Dn.contourId=Ne,lt||(Et.isExteriorRing=!1,Dn.isExteriorRing=!1),Re(Et,Dn)>0?Dn.left=!0:Et.left=!0;var Kn=Jt[0],Nt=Jt[1];ze[0]=an(ze[0],Kn),ze[1]=an(ze[1],Nt),ze[2]=Zt(ze[2],Kn),ze[3]=Zt(ze[3],Nt),st.push(Et),st.push(Dn)}}var Cn=[];function An(oe,te,Ne){typeof oe[0][0][0]=="number"&&(oe=[oe]),typeof te[0][0][0]=="number"&&(te=[te]);var st=(function(Nt,bn,Jn){var zn=null;return Nt.length*bn.length==0&&(Jn===D?zn=Cn:Jn===O?zn=Nt:Jn!==P&&Jn!==N||(zn=Nt.length===0?bn:Nt)),zn})(oe,te,Ne);if(st)return st===Cn?null:st;var ze=[1/0,1/0,-1/0,-1/0],lt=[1/0,1/0,-1/0,-1/0],Dt=(function(Nt,bn,Jn,zn,Fi){var gi,si,$n,Mn,Qt,Rn,ai=new at(null,Re);for($n=0,Mn=Nt.length;$n<Mn;$n++)for(Qt=0,Rn=(gi=Nt[$n]).length;Qt<Rn;Qt++)(si=Qt===0)&&En++,Yt(gi[Qt],!0,En,ai,Jn,si);for($n=0,Mn=bn.length;$n<Mn;$n++)for(Qt=0,Rn=(gi=bn[$n]).length;Qt<Rn;Qt++)si=Qt===0,Fi===O&&(si=!1),si&&En++,Yt(gi[Qt],!1,En,ai,zn,si);return ai})(oe,te,ze,lt,Ne);if(st=(function(Nt,bn,Jn,zn,Fi){var gi=null;return(Jn[0]>zn[2]||zn[0]>Jn[2]||Jn[1]>zn[3]||zn[1]>Jn[3])&&(Fi===D?gi=Cn:Fi===O?gi=Nt:Fi!==P&&Fi!==N||(gi=Nt.concat(bn))),gi})(oe,te,ze,lt,Ne))return st===Cn?null:st;for(var It=(function(Nt){var bn,Jn,zn=(function($n){var Mn,Qt,Rn,ai,kt=[];for(Qt=0,Rn=$n.length;Qt<Rn;Qt++)((Mn=$n[Qt]).left&&Mn.inResult||!Mn.left&&Mn.otherEvent.inResult)&&kt.push(Mn);for(var Tn=!1;!Tn;)for(Tn=!0,Qt=0,Rn=kt.length;Qt<Rn;Qt++)Qt+1<Rn&&Re(kt[Qt],kt[Qt+1])===1&&(ai=kt[Qt],kt[Qt]=kt[Qt+1],kt[Qt+1]=ai,Tn=!1);for(Qt=0,Rn=kt.length;Qt<Rn;Qt++)(Mn=kt[Qt]).otherPos=Qt;for(Qt=0,Rn=kt.length;Qt<Rn;Qt++)(Mn=kt[Qt]).left||(ai=Mn.otherPos,Mn.otherPos=Mn.otherEvent.otherPos,Mn.otherEvent.otherPos=ai);return kt})(Nt),Fi={},gi=[],si=function(){if(!Fi[bn]){var $n=gi.length,Mn=(function(kt,Tn,_i){var Ui=new bt;if(kt.prevInResult!=null){var Ki=kt.prevInResult,fr=Ki.outputContourId;if(Ki.resultTransition>0){var yi=Tn[fr];if(yi.holeOf!=null){var lr=yi.holeOf;Tn[lr].holeIds.push(_i),Ui.holeOf=lr,Ui.depth=Tn[fr].depth}else Tn[fr].holeIds.push(_i),Ui.holeOf=fr,Ui.depth=Tn[fr].depth+1}else Ui.holeOf=null,Ui.depth=Tn[fr].depth}else Ui.holeOf=null,Ui.depth=0;return Ui})(zn[bn],gi,$n),Qt=function(kt){Fi[kt]=!0,kt<zn.length&&zn[kt]&&(zn[kt].outputContourId=$n)},Rn=bn,ai=bn;for(Mn.points.push(zn[bn].point);Qt(Rn),Qt(Rn=zn[Rn].otherPos),Mn.points.push(zn[Rn].point),!((Rn=ft(Rn,zn,Fi,ai))==ai||Rn>=zn.length)&&zn[Rn];);gi.push(Mn)}};for(bn=0,Jn=zn.length;bn<Jn;bn++)si();return gi})((function(Nt,bn,Jn,zn,Fi,gi){for(var si,$n,Mn,Qt=new u(_t),Rn=[],ai=Math.min(zn[2],Fi[2]);Nt.length!==0;){var kt=Nt.pop();if(Rn.push(kt),gi===D&&kt.point[0]>ai||gi===O&&kt.point[0]>zn[2])break;if(kt.left){$n=si=Qt.insert(kt),si=si!==(Mn=Qt.minNode())?Qt.prev(si):null,$n=Qt.next($n);var Tn=si?si.key:null;if(V(kt,Tn,gi),$n&&He(kt,$n.key,Nt)===2&&(V(kt,Tn,gi),V($n.key,kt,gi)),si&&He(si.key,kt,Nt)===2){var _i=si;V(Tn,(_i=_i!==Mn?Qt.prev(_i):null)?_i.key:null,gi),V(kt,Tn,gi)}}else $n=si=Qt.find(kt=kt.otherEvent),si&&$n&&(si=si!==Mn?Qt.prev(si):null,$n=Qt.next($n),Qt.remove(kt),$n&&si&&He(si.key,$n.key,Nt))}return Rn})(Dt,0,0,ze,lt,Ne)),Jt=[],Ft=0;Ft<It.length;Ft++){var Et=It[Ft];if(Et.isExterior()){for(var Dn=[Et.points],Kn=0;Kn<Et.holeIds.length;Kn++)Dn.push(It[Et.holeIds[Kn]].points);Jt.push(Dn)}}return Jt}var Ii={UNION:P,DIFFERENCE:O,INTERSECTION:D,XOR:N};n.diff=function(oe,te){return An(oe,te,O)},n.intersection=function(oe,te){return An(oe,te,D)},n.operations=Ii,n.union=function(oe,te){return An(oe,te,P)},n.xor=function(oe,te){return An(oe,te,N)},Object.defineProperty(n,"__esModule",{value:!0})})(e)})(0,CA.exports)),CA.exports);function S0(r,e,n,a){let u=[],p=a===0?(m,_,b,w,I,S)=>{m.push(new Ze(S,b+(S-_)/(w-_)*(I-b)))}:(m,_,b,w,I,S)=>{m.push(new Ze(_+(S-b)/(I-b)*(w-_),S))};for(let m of r){let _=[];for(let b of m){if(b.length<=2)continue;let w=[];for(let D=0;D<b.length-1;D++){let P=b[D].x,O=b[D].y,N=b[D+1].x,V=b[D+1].y,U=a===0?P:O,W=a===0?N:V;U<e?W>e&&p(w,P,O,N,V,e):U>n?W<n&&p(w,P,O,N,V,n):w.push(b[D]),W<e&&U>=e&&p(w,P,O,N,V,e),W>n&&U<=n&&p(w,P,O,N,V,n)}let I=b[b.length-1],S=a===0?I.x:I.y;S>=e&&S<=n&&w.push(I),w.length&&(I=w[w.length-1],w[0].x===I.x&&w[0].y===I.y||w.push(w[0]),_.push(w))}_.length&&u.push(_)}return u}function $z(r,e){let n=xE(r),a=xE([e]),u=AA.intersection(n,a);return u==null?[]:MA(u)}function Gz(r,e){let a=xE(r,65536),u=[];for(;e.valid();e.next()){let[p,m]=e.get(),_=p.x*65536,b=p.y*65536,w=m.x*65536,I=m.y*65536,S=w-_,D=I-b,P=Math.hypot(S,D);if(P===0)continue;let O=Math.trunc(D/P*3),N=-Math.trunc(S/P*3);u.push([[[_,b],[w,I],[w+O,I+N],[_+O,b+N],[_,b]]])}return u.length>0&&(a=AA.diff(a,u)),MA(a,1/65536)}function xE(r,e=1){return[r.map(n=>n.map(a=>[a.x*e,a.y*e]))]}function MA(r,e=1){return r.map(n=>n.map((a,u)=>{let p=a.map(m=>new Ze(m[0]*e,m[1]*e).round());return u>0&&p.reverse(),p}))}class bE{constructor(e,n){this.layoutVertexArray=new To,this.indexArray=new wi,this.lineIndexArray=new Ss,this.triangleSegments=new Ci,this.lineSegments=new Ci,this.programConfigurations=new Gs(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,n&&(this.elevatedLayoutVertexArray=new Ba)}update(e,n,a,u,p,m,_,b){this.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_,b)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Az.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Mz.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,n,a,u,p,m,_){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,n,a,u,p,m,void 0,_)}}class wE{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new bE(e,!1),this.elevationBufferData=new bE(e,!0),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,n){}updateAppearances(e,n,a,u){}populate(e,n,a,u){this.hasPattern=yE("fill",this.layers,this.pixelRatio,n);let p=this.layers[0].layout.get("fill-sort-key"),m=[];for(let{feature:_,id:b,index:w,sourceLayerIndex:I}of e){let S=this.layers[0]._featureFilter.needGeometry,D=De(_,S);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),D,a))continue;let P=p?p.evaluate(D,{},a,n.availableImages):void 0,O={id:b,properties:_.properties,type:_.type,sourceLayerIndex:I,index:w,geometry:S?D.geometry:Ve(_,a,u),patterns:{},sortKey:P};m.push(O)}p&&m.sort((_,b)=>_.sortKey-b.sortKey);for(let _ of m){let{geometry:b,index:w,sourceLayerIndex:I}=_;if(this.hasPattern){let S=vE("fill",this.layers,_,this.zoom,this.pixelRatio,n);this.patternFeatures.push(S)}else this.addFeature(_,b,w,a,{},n.availableImages,n.brightness,n.elevationFeatures);n.featureIndex.insert(e[w].feature,b,w,I,this.index)}}update(e,n,a,u,p,m,_){this.bufferData.update(e,n,a,u,p,m,_,this.worldview),this.elevationBufferData.update(e,n,a,u,p,m,_,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,n,a,u,p,m,_,this.worldview)}addFeatures(e,n,a,u,p,m){for(let _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,n,a,u,m,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,n,a,u,p,m=[],_,b){let w=p_(n,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,w,u,a,b):this.addGeometry(w,this.bufferData),this.bufferData.populatePaintArrays(e,a,p,m,u,_,this.worldview),this.elevationBufferData.populatePaintArrays(e,a,p,m,u,_,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,n,a,u,p){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(n,a,u,p,this.worldview))}addElevatedRoadFeature(e,n,a,u,p){let m=new Array,_=$t.getElevationFeature(e,p);if(!_)return void this.addGeometry(n,this.bufferData);{let w=this.clipPolygonsToTile(n,1);w.length>0&&m.push({polygons:w,elevationFeature:_,elevationTileID:a})}let b={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},a),featureIndex:u};for(let w of m)if(w.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new rs(w.elevationTileID,this.layers,this.zoom,this.lut));let S=w.elevationFeature.isTunnel(),D=0;e.properties.hasOwnProperty(gt)&&(D=+e.properties[gt]);for(let P of w.polygons)this.elevatedStructures.addPortalCandidates(w.elevationFeature.id,P,S,w.elevationFeature,D)}w.elevationFeature.constantHeight==null&&(w.polygons=this.prepareElevatedPolygons(w.polygons,w.elevationFeature,w.elevationTileID));let I=new wn(a,w.elevationTileID);this.addElevatedGeometry(w.polygons,I,w.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,u,b)}}addElevatedGeometry(e,n,a,u,p,m){let _={elevation:a,elevationSampler:n,bias:u,index:p,featureInfo:m},[b,w]=this.addGeometry(e,this.elevationBufferData,_);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:b,max:w}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,b),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,w))}addGeometry(e,n,a){let u=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,m=null;a&&(m=a.elevationSampler.constantElevation(a.elevation,a.bias),m!=null&&(u=m,p=m));let _=(b,w,I)=>{if(a!=null)if(w.push(b),m!=null)n.elevatedLayoutVertexArray.emplaceBack(m),I.push(m);else{let S=a.elevationSampler.pointElevation(b,a.elevation,a.bias);n.elevatedLayoutVertexArray.emplaceBack(S),I.push(S),u=Math.min(u,S),p=Math.max(p,S)}};for(let b of e){let w=0;for(let X of b)w+=X.length;let I=n.triangleSegments.prepareSegment(w,n.layoutVertexArray,n.indexArray),S=I.vertexLength,D=[],P=[],O=[],N=[],V=[],U=n.layoutVertexArray.length;for(let X of b){if(X.length===0)continue;X!==b[0]&&P.push(D.length/2);let K=n.lineSegments.prepareSegment(X.length,n.layoutVertexArray,n.lineIndexArray),le=K.vertexLength;a&&V.push(n.layoutVertexArray.length-U),_(X[0],O,N),n.layoutVertexArray.emplaceBack(X[0].x,X[0].y),n.lineIndexArray.emplaceBack(le+X.length-1,le),D.push(X[0].x),D.push(X[0].y);for(let re=1;re<X.length;re++)_(X[re],O,N),n.layoutVertexArray.emplaceBack(X[re].x,X[re].y),n.lineIndexArray.emplaceBack(le+re-1,le+re),D.push(X[re].x),D.push(X[re].y);K.vertexLength+=X.length,K.primitiveLength+=X.length}let W=pp(D,P);for(let X=0;X<W.length;X+=3)n.indexArray.emplaceBack(S+W[X],S+W[X+1],S+W[X+2]);if(W.length>0&&a&&this.elevationMode==="hd-road-base"){let X=a.elevation.isTunnel(),K=a.elevation.safeArea,le=this.elevatedStructures.addVertices(O,N);this.elevatedStructures.addTriangles(W,le,X);let re=V.length;if(re>0){for(let de=0;de<re-1;de++)this.elevatedStructures.addRenderableRing(a.index,V[de]+le,V[de+1]-V[de],X,K,a.featureInfo);this.elevatedStructures.addRenderableRing(a.index,V[re-1]+le,O.length-V[re-1],X,K,a.featureInfo)}}I.vertexLength+=w,I.primitiveLength+=W.length/3}return[u,p]}prepareElevatedPolygons(e,n,a){let u=1/ue(a),p=[];for(let m of e){let _=Gz(m,new ui(n,u));p.push(..._)}return p}clipPolygonsToTile(e,n){let a=-n,u=-n,p=rt+n,m=rt+n,_=0,b=[],w=[];for(;_<e.length;_++){let D=e[_],P=jd(D);(P.min.x>=a&&P.max.x<=p&&P.min.y>=u&&P.max.y<=m?b:w).push(D)}if(b.length===e.length)return e;let I=[new Ze(a,u),new Ze(p,u),new Ze(p,m),new Ze(a,m),new Ze(a,u)],S=b;for(let D of w)S.push(...$z(D,I));return S}}let RA,PA,OA,LA;vt(wE,"FillBucket",{omit:["layers","patternFeatures"]}),vt(bE,"FillBufferData"),vt(rs,"ElevatedStructures");class D0{constructor(e,n,a,u){if(this.triangleCount=n.length/3,this.min=new Ze(0,0),this.max=new Ze(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;let[p,m]=[e[0].clone(),e[0].clone()];for(let S=1;S<e.length;++S){let D=e[S];p.x=Math.min(p.x,D.x),p.y=Math.min(p.y,D.y),m.x=Math.max(m.x,D.x),m.y=Math.max(m.y,D.y)}if(u){let S=Math.ceil(Math.max(m.x-p.x,m.y-p.y)/u);a=Math.max(a,S)}if(a===0)return;this.min=p,this.max=m;let _=this.max.sub(this.min);_.x=Math.max(_.x,1),_.y=Math.max(_.y,1);let b=Math.max(_.x,_.y)/a;this.cellsX=Math.max(1,Math.ceil(_.x/b)),this.cellsY=Math.max(1,Math.ceil(_.y/b)),this.xScale=1/b,this.yScale=1/b;let w=[];for(let S=0;S<this.triangleCount;S++){let D=e[n[3*S+0]].sub(this.min),P=e[n[3*S+1]].sub(this.min),O=e[n[3*S+2]].sub(this.min),N=Tl(Math.floor(Math.min(D.x,P.x,O.x)),this.xScale,this.cellsX),V=Tl(Math.floor(Math.max(D.x,P.x,O.x)),this.xScale,this.cellsX),U=Tl(Math.floor(Math.min(D.y,P.y,O.y)),this.yScale,this.cellsY),W=Tl(Math.floor(Math.max(D.y,P.y,O.y)),this.yScale,this.cellsY),X=new Ze(0,0),K=new Ze(0,0),le=new Ze(0,0),re=new Ze(0,0);for(let de=U;de<=W;++de){X.y=K.y=de*b,le.y=re.y=(de+1)*b;for(let pe=N;pe<=V;++pe)X.x=le.x=pe*b,K.x=re.x=(pe+1)*b,(Yi(D,P,O,X,K,re)||Yi(D,P,O,X,re,le))&&w.push({cellIdx:de*this.cellsX+pe,triIdx:S})}}if(w.length===0)return;w.sort((S,D)=>S.cellIdx-D.cellIdx||S.triIdx-D.triIdx);let I=0;for(;I<w.length;){let S=w[I].cellIdx,D={start:this.payload.length,len:0};for(;I<w.length&&w[I].cellIdx===S;)++D.len,this.payload.push(w[I++].triIdx);this.cells[S]=D}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,n){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;let a=Tl(e.x-this.min.x,this.xScale,this.cellsX),u=Tl(e.y-this.min.y,this.yScale,this.cellsY),p=this.cells[u*this.cellsX+a];if(p){this._lazyInitLookup();for(let m=0;m<p.len;m++){let _=this.payload[p.start+m],b=Math.floor(_/8),w=1<<_%8;if(!(this.lookup[b]&w)&&(this.lookup[b]|=w,n.push(_),n.length===this.triangleCount))return}}}query(e,n,a){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>n.x||e.y>this.max.y||this.min.y>n.y)return;this._lazyInitLookup();let u=Tl(e.x-this.min.x,this.xScale,this.cellsX),p=Tl(n.x-this.min.x,this.xScale,this.cellsX),m=Tl(e.y-this.min.y,this.yScale,this.cellsY),_=Tl(n.y-this.min.y,this.yScale,this.cellsY);for(let b=m;b<=_;b++)for(let w=u;w<=p;w++){let I=this.cells[b*this.cellsX+w];if(I)for(let S=0;S<I.len;S++){let D=this.payload[I.start+S],P=Math.floor(D/8),O=1<<D%8;if(!(this.lookup[P]&O)&&(this.lookup[P]|=O,a.push(D),a.length===this.triangleCount))return}}}}function Tl(r,e,n){return Math.max(0,Math.min(n-1,Math.floor(r*e)))}vt(D0,"TriangleGridIndex");class FA{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.footprints=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,n){for(let a of this.footprints)n.push({footprint:a,id:e})}updateAppearances(e,n,a,u){}populate(e,n,a,u){let p=[];for(let{feature:m,id:_,index:b,sourceLayerIndex:w}of e){let I=this.layers[0]._featureFilter.needGeometry,S=De(m,I);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),S,a))continue;let D={id:_,properties:m.properties,type:m.type,sourceLayerIndex:w,index:b,geometry:I?S.geometry:Ve(m,a,u),patterns:{}};p.push(D)}for(let m of p){let{geometry:_,index:b,sourceLayerIndex:w}=m;this.addFeature(m,_,b,a,{},n.availableImages,n.brightness),n.featureIndex.insert(e[b].feature,_,b,w,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,n,a,u,p,m,_){}destroy(){}addFeature(e,n,a,u,p,m=[],_){for(let b of p_(n,2)){let w=[],I=[],S=[],D=new Ze(1/0,1/0),P=new Ze(-1/0,-1/0);for(let V of b)if(V.length!==0){V!==b[0]&&S.push(I.length/2);for(let U=0;U<V.length;U++)I.push(V[U].x),I.push(V[U].y),w.push(V[U]),D.x=Math.min(D.x,V[U].x),D.y=Math.min(D.y,V[U].y),P.x=Math.max(P.x,V[U].x),P.y=Math.max(P.y,V[U].y)}let O=pp(I,S),N=new D0(w,O,8,256);this.footprints.push({vertices:w,indices:O,grid:N,min:D,max:P})}}}vt(FA,"ClipBucket",{omit:["layers"]});let qz=hn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Wz=hn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Zz=hn([{name:"a_flood_light_ground_radius",components:1,type:"Float32"}]),Xz=hn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Yz=hn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Kz=hn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Jz=hn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Qz}=qz,m_=Number.MAX_SAFE_INTEGER,kA=m_-1;function NA(r,e,n,a){return r.order<e||r.order===m_||!(r.clipMask&n)||(function(u,p){return p.length!==0&&p.find(m=>m===u)===void 0})(a,r.clipScope)}function C0(r,e){return r.x-e.x||r.y-e.y}function zA(r,e){return C0(r.min,e.min)===0&&C0(r.max,e.max)===0}function EE(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function A0(r,e){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(r[n].sourceId!==e[n].sourceId||!zA(r[n],e[n])||r[n].order!==e[n].order||r[n].clipMask!==e[n].clipMask||!Aa(r[n].clipScope,e[n].clipScope))return!1;return!0}function BA(r,e,n){let a=1/rt,u=1/(1<<n.canonical.z),p=(e.x*a+n.canonical.x)*u+n.wrap,m=(e.y*a+n.canonical.y)*u;return{min:new Ze((r.x*a+n.canonical.x)*u+n.wrap,(r.y*a+n.canonical.y)*u),max:new Ze(p,m)}}function eB(r,e,n){let a=1<<n.canonical.z,u=((e.x-n.wrap)*a-n.canonical.x)*rt,p=(e.y*a-n.canonical.y)*rt;return{min:new Ze(((r.x-n.wrap)*a-n.canonical.x)*rt,(r.y*a-n.canonical.y)*rt),max:new Ze(u,p)}}function TE(r,e,n,a,u,p,m){let _=r.indices,b=r.vertices,w=[];for(let I=a;I<a+u;I+=3){let S=e[n[I+0]+p],D=e[n[I+1]+p],P=e[n[I+2]+p],O=Math.min(S.x,D.x,P.x),N=Math.max(S.x,D.x,P.x),V=Math.min(S.y,D.y,P.y),U=Math.max(S.y,D.y,P.y);w.length=0,r.grid.query(new Ze(O,V),new Ze(N,U),w);for(let W=0;W<w.length;W++){let X=w[W];if(Yi(b[_[3*X+0]],b[_[3*X+1]],b[_[3*X+2]],S,D,P,m))return!0}}return!1}function VA(r,e,n,a){if(!r||!n)return!1;let u=r.vertices;if(!e.canonical.equals(a.canonical)||e.wrap!==a.wrap){if(n.vertices.length<r.vertices.length)return VA(n,a,r,e);let p=e.canonical,m=a.canonical,_=Math.pow(2,m.z-p.z);u=r.vertices.map(b=>new Ze((b.x+p.x*rt)*_-m.x*rt,(b.y+p.y*rt)*_-m.y*rt))}return TE(n,u,r.indices,0,r.indices.length,0,0)}function jA(r,e,n,a){let u=Math.pow(2,a.z-n.z);return new Ze((r+n.x*rt)*u-a.x*rt,(e+n.y*rt)*u-a.y*rt)}function IE(r,e){let n=[];e.grid.queryPoint(r,n);let a=e.indices,u=e.vertices;for(let p=0;p<n.length;p++){let m=n[p];if(Cr([u[a[3*m+0]],u[a[3*m+1]],u[a[3*m+2]]],r))return!0}return!1}let SE=[new Ze(0,0),new Ze(rt,0),new Ze(rt,rt),new Ze(0,rt)];function UA(r,e){let n=[],a=[];if(!e||r.length<2)return[r];if(r.length===2)return Gi(r[0],r[1],SE)?[r]:[];for(let u=0;u<r.length+2;u++){let p=r[u%r.length],m=r[(u+1)%r.length],_=Gi(u===0?r[r.length-1]:r[(u-1)%r.length],p,SE),b=Gi(p,m,SE),w=_||b;w&&a.push(p),w&&b||a.length>0&&(a.length>1&&n.push(a),a=[])}return a.length>1&&n.push(a),n}let DE=Ge.types,tB=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],nB=["fill-extrusion-flood-light-ground-radius"],iB=Math.pow(2,13),rB=Math.pow(2,15)-1,HA=new Ze(0,1),Ou=2147483648,$A=7,GA=450;function g_(r,e,n,a,u,p,m,_){r.emplaceBack((e<<1)+m,(n<<1)+p,(Math.floor(a*iB)<<1)+u,Math.round(_))}function __(r,e,n){r.emplaceBack(e.x*rt,e.y*rt,n?1:0)}function M0(r,e,n,a,u,p){r.emplaceBack(e.x,e.y,(n.x<<1)+a,(n.y<<1)+u,p)}function y_(r,e,n){r.emplaceBack(e.x,e.y,e.z,n[0]*16384,n[1]*16384,n[2]*16384)}class qA{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class WA{constructor(){this.centroidXY=new Ze(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new Ze(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new Ze(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new Ze(this.max.x-this.min.x,this.max.y-this.min.y)}}class ZA{constructor(){this.acc=new Ze(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,n){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=n.x,e.min.y=e.max.y=n.y)}appendEdge(e,n,a){this.accCount++,this.acc._add(n);let u=!!this.borders;n.x<e.min.x?(e.min.x=n.x,u=!0):n.x>e.max.x&&(e.max.x=n.x,u=!0),n.y<e.min.y?(e.min.y=n.y,u=!0):n.y>e.max.y&&(e.max.y=n.y,u=!0),((n.x===0||n.x===rt)&&n.x===a.x)!=((n.y===0||n.y===rt)&&n.y===a.y)&&this.processBorderOverlap(n,a),u&&this.checkBorderIntersection(n,a)}checkBorderIntersection(e,n){n.x<0!=e.x<0&&this.addBorderIntersection(0,zt(n.y,e.y,(0-n.x)/(e.x-n.x))),n.x>rt!=e.x>rt&&this.addBorderIntersection(1,zt(n.y,e.y,(rt-n.x)/(e.x-n.x))),n.y<0!=e.y<0&&this.addBorderIntersection(2,zt(n.x,e.x,(0-n.y)/(e.y-n.y))),n.y>rt!=e.y>rt&&this.addBorderIntersection(3,zt(n.x,e.x,(rt-n.y)/(e.y-n.y)))}addBorderIntersection(e,n){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let a=this.borders[e];n<a[0]&&(a[0]=n),n>a[1]&&(a[1]=n)}processBorderOverlap(e,n){if(e.x===n.x){if(e.y===n.y)return;let a=e.x===0?0:1;this.addBorderIntersection(a,n.y),this.addBorderIntersection(a,e.y)}else{let a=e.y===0?2:3;this.addBorderIntersection(a,n.x),this.addBorderIntersection(a,e.x)}}centroid(){return this.accCount===0?new Ze(0,0):new Ze(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,n)=>e+ +(n[0]!==Number.MAX_VALUE),0):0}}function XA(r,e){let n=r.add(e)._unit(),a=G(r.x*n.x+r.y*n.y,-1,1);var u,p,m;return u=Math.acos(a),Math.min(4,Math.max(-4,Math.tan(u)))/4*rB*((p=r).x*(m=e).y-p.y*m.x<0?-1:1)}let oB=[r=>r.x<0,r=>r.x>rt,r=>r.y<0,r=>r.y>rt];function sB(r,e,n,a){let u=[4];if(a===0)return u;n._mult(a);let p=r.sub(n),m=e.sub(n),_=[r,e,p,m];for(let b=0;b<4;b++)for(let w of _)if(oB[b](w)){u.push(b);break}return u}class CE{constructor(e){this.groundRadiusArray=null,this.groundRadiusBuffer=null,this.vertexArray=new Qf,this.indexArray=new wi,this.programConfigurations=new Gs(e.layers,{zoom:e.zoom,lut:e.lut},n=>nB.includes(n)),this._segments=new Ci,this.hiddenByLandmarkVertexArray=new sp,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Ci}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,n,a,u=!1){let p=e.length;if(p>2){let m=Math.max(0,this._segments.get().length-1),_=this._segments._prepareSegment(4*p,this.vertexArray.length,2*this._segmentToGroundQuads[m].length),b;m!==this._segments.get().length-1&&(m++,this._segmentToGroundQuads[m]=[],this._segmentToRegionTriCounts[m]=[0,0,0,0,0]);{let w=e[0],I=e[1];b=XA(w.sub(e[p-1])._perp()._unit(),I.sub(w)._perp()._unit())}for(let w=0;w<p;w++){let I=w===p-1?0:w+1,S=e[w],D=e[I],P=e[I===p-1?0:I+1],O=D.sub(S)._perp()._unit(),N=XA(O,P.sub(D)._perp()._unit()),V=b,U=N;if(AE(S,D,n)||u&&JA(S,n)&&JA(D,n)){b=N;continue}let W=_.vertexLength;M0(this.vertexArray,S,D,1,1,V),M0(this.vertexArray,S,D,1,0,V),M0(this.vertexArray,S,D,0,1,U),M0(this.vertexArray,S,D,0,0,U),_.vertexLength+=4;let X=sB(S,D,O,a);for(let K of X)this._segmentToGroundQuads[m].push({id:W,region:K}),this._segmentToRegionTriCounts[m][K]+=2,_.primitiveLength+=2;b=N}}}prepareBorderSegments(){if(!this.hasData())return;let e=this._segments.get(),n=e.length;for(let a=0;a<n;a++)this._segmentToGroundQuads[a].sort((u,p)=>u.region-p.region);for(let a=0;a<n;a++){let u=this._segmentToGroundQuads[a],p=e[a],m=this._segmentToRegionTriCounts[a];m.reduce((b,w)=>b+w,0);let _=0;for(let b=0;b<=4;b++){let w=m[b];if(w!==0){let I=this.regionSegments[b];I||(I=this.regionSegments[b]=new Ci);let S={vertexOffset:p.vertexOffset,primitiveOffset:p.primitiveOffset+_,vertexLength:p.vertexLength,primitiveLength:w};I.get().push(S)}_+=w}for(let b=0;b<u.length;b++){let w=u[b].id;this.indexArray.emplaceBack(w,w+1,w+3),this.indexArray.emplaceBack(w,w+3,w+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,n,a,u,p,m,_){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,n,a,u,p,m,void 0,_)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,Wz.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.groundRadiusArray!=null&&(this.groundRadiusBuffer=e.createVertexBuffer(this.groundRadiusArray,Zz.members)))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,n,a,u,p,m,_,b){this.hasData()&&this.programConfigurations.updatePaintArrays(e,n,a,u,p,m,_,b)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&Ou))}updateHiddenByLandmarkRange(e,n,a){if(!this.hasData())return;let u=n+e;if(n!==0){for(let p=e;p<u;++p)this.hiddenByLandmarkVertexArray.emplace(p,a?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,Kz.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this.groundRadiusBuffer&&this.groundRadiusBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){let n=this.regionSegments[e];n&&n.destroy()}}}}class R0{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new wi,this.footprintVertices=new To,this.footprintSegments=[],this.layoutVertexArray=new bu,this.centroidVertexArray=new h0,this.wallVertexArray=new p0,this.indexArray=new wi,this.programConfigurations=new Gs(e.layers,{zoom:e.zoom,lut:e.lut},n=>tB.includes(n)),this.segments=new Ci,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.groundEffect=new CE(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,n){}updateAppearances(e,n,a,u){}populate(e,n,a,u){this.features=[],this.hasPattern=yE("fill-extrusion",this.layers,this.pixelRatio,n),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=ue(a),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(let{feature:p,id:m,index:_,sourceLayerIndex:b}of e){let w=this.layers[0]._featureFilter.needGeometry,I=De(p,w);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),I,a))continue;let S={id:m,sourceLayerIndex:b,index:_,geometry:w?I.geometry:Ve(p,a,u),properties:p.properties,type:p.type,patterns:{}},D=this.layoutVertexArray.length,P=DE[S.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:p.id,feature:vE("fill-extrusion",this.layers,S,this.zoom,this.pixelRatio,n)});else if(this.wallMode)for(let O of S.geometry)for(let N of UA(O,P))this.addFeature(p.id,S,[N],_,a,{},n.availableImages,u,n.brightness);else this.addFeature(p.id,S,S.geometry,_,a,{},n.availableImages,u,n.brightness);n.featureIndex.insert(p,S.geometry,_,b,this.index,D)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,n,a,u,p,m){for(let{featureId:_,feature:b}of this.features){let w=DE[b.type]==="Polygon",{geometry:I}=b;if(this.wallMode)for(let S of I)for(let D of UA(S,w))this.addFeature(_,b,[D],b.index,n,a,u,p,m);else this.addFeature(_,b,I,b.index,n,a,u,p,m)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,n,a,u,p,m,_){this.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_,this.worldview),this.groundEffect.update(e,n,p,a,u,m,_,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Qz),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,Yz.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Jz.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Xz.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,n,a,u,p,m,_,b,w){let I=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(n,{})/this.tileToMeter,S=[new Ze(0,0),new Ze(rt,rt)],D=b.projection,P=D.name==="globe",O=this.wallMode||DE[n.type]==="Polygon",N=new ZA;N.centroidDataIndex=this.centroidData.length;let V=new WA;V.buildingId=e,n.properties&&n.properties.hasOwnProperty("building_id")&&(V.buildingId=n.properties.building_id);let U=this.layers[0].paint.get("fill-extrusion-base").evaluate(n,{},p)<=0,W=this.layers[0].paint.get("fill-extrusion-height").evaluate(n,{},p),X;if(V.height=W,V.vertexArrayOffset=this.layoutVertexArray.length,V.groundVertexArrayOffset=this.groundEffect.vertexArray.length,P&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new tp),this.wallMode){if(P)return void Rt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(a.length!==1)return;X=(function(Te){let ke=Te[0].x===Te[Te.length-1].x&&Te[0].y===Te[Te.length-1].y;(function(ft){let at=0,Gt=ft.length;for(let ut=0;ut<Gt;ut++)at+=(ft[(ut+1)%Gt].x-ft[ut].x)*(ft[(ut+1)%Gt].y+ft[ut].y);return at>=0})(Te)||(Te=Te.reverse());let $e={geometry:[],joinNormals:[],indices:[]},nt=[],Ye=[],Ue=[],Xe=Te.length;for(;Xe>=2&&Te[Xe-1].equals(Te[Xe-2]);)Xe--;if(Xe<(ke?3:2))return $e;let Re,Ae,qe,Qe,He,_t=0;for(;_t<Xe-1&&Te[_t].equals(Te[_t+1]);)_t++;ke&&(Re=Te[Xe-2],He=Te[_t].sub(Re)._unit()._perp());for(let ft=_t;ft<Xe;ft++){if(qe=ft===Xe-1?ke?Te[_t+1]:void 0:Te[ft+1],qe&&Te[ft].equals(qe))continue;He&&(Qe=He),Re&&(Ae=Re),Re=Te[ft],He=qe?qe.sub(Re)._unit()._perp():Qe,Qe=Qe||He;let at=Qe.add(He);at.x===0&&at.y===0||at._unit();let Gt=at.x*He.x+at.y*He.y,ut=Gt!==0?1/Gt:1/0,Mt=Qe.x*He.y-Qe.y*He.x>0,Zt="miter",an=2;Zt==="miter"&&ut>an&&(Zt="bevel"),Zt==="bevel"&&(ut>100&&(Zt="flipbevel"),ut<an&&(Zt="miter"));let En=(Yt,Cn,An,Ii)=>{let oe=new Ze(Yt.x,Yt.y),te=new Ze(Yt.x,Yt.y);oe.x+=Cn.x*Ii,oe.y+=Cn.y*Ii,te.x-=Cn.x*Math.max(An,1),te.y-=Cn.y*Math.max(An,1),Ue.push(Cn),nt.push(oe),Ye.push(te)};if(Zt==="miter")at._mult(ut),En(Re,at,0,0);else if(Zt==="flipbevel")at=He.mult(-1),En(Re,at,0,0),En(Re,at.mult(-1),0,0);else{let Yt=-Math.sqrt(ut*ut-1),Cn=Mt?Yt:0,An=Mt?0:Yt;Ae&&En(Re,Qe,Cn,An),qe&&En(Re,He,Cn,An)}}$e.geometry=[...nt,...Ye.reverse(),nt[0]],$e.joinNormals=[...Ue,...Ue.reverse(),Ue[Ue.length-1]];let bt=$e.geometry.length-1;for(let ft=0;ft<bt/2;ft++)if(ft+1<bt/2){let at=ft,Gt=ft+1,ut=bt-1-ft,Mt=bt-2-ft;at=at===0?bt-1:at-1,Gt=Gt===0?bt-1:Gt-1,ut=ut===0?bt-1:ut-1,Mt=Mt===0?bt-1:Mt-1,$e.indices.push(ut),$e.indices.push(Gt),$e.indices.push(at),$e.indices.push(ut),$e.indices.push(Mt),$e.indices.push(Gt)}return $e})(a[0]),a=[X.geometry]}let K=(Te,ke)=>Te<(ke.length-1)/2||Te===ke.length-1,le=this.wallMode?[a]:p_(a,500);for(let Te=le.length-1;Te>=0;Te--){let ke=le[Te];(ke.length===0||(re=ke[0]).every(je=>je.x<=0)||re.every(je=>je.x>=rt)||re.every(je=>je.y<=0)||re.every(je=>je.y>=rt))&&le.splice(Te,1)}var re;let de;if(P)de=nM(le,S,p);else{de=[];for(let Te of le)de.push({polygon:Te,bounds:S})}let pe=O?this.edgeRadius:0,ge=pe>0&&this.zoom<17,Le=(Te,ke)=>{if(Te.length===0)return!1;let je=Te[Te.length-1];return ke.x===je.x&&ke.y===je.y};for(let{polygon:Te,bounds:ke}of de){let je=0,$e=0;for(let Xe of Te)O&&!Xe[0].equals(Xe[Xe.length-1])&&Xe.push(Xe[0]),$e+=O?Xe.length-1:Xe.length;let nt=this.segments.prepareSegment((O?5:4)*$e,this.layoutVertexArray,this.indexArray);V.footprintSegIdx<0&&(V.footprintSegIdx=this.footprintSegments.length),V.polygonSegIdx<0&&(V.polygonSegIdx=this.polygonSegments.length);let Ye={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ue=new qA;if(Ue.vertexOffset=this.footprintVertices.length,Ue.indexOffset=3*this.footprintIndices.length,Ue.ringIndices=[],O){let Xe=[],Re=[];je=nt.vertexLength;for(let qe=0;qe<Te.length;qe++){let Qe=Te[qe];Qe.length&&qe!==0&&Re.push(Xe.length/2);let He=[],_t,bt;_t=Qe[1].sub(Qe[0])._perp()._unit(),Ue.ringIndices.push(Qe.length-1);for(let ft=1;ft<Qe.length;ft++){let at=Qe[ft],Gt=Qe[ft===Qe.length-1?1:ft+1],ut=at.clone();if(pe){bt=Gt.sub(at)._perp()._unit();let Mt=_t.add(bt)._unit(),Zt=pe*Math.min(4,1/(_t.x*Mt.x+_t.y*Mt.y));ut.x+=Zt*Mt.x,ut.y+=Zt*Mt.y,ut.x=Math.round(ut.x),ut.y=Math.round(ut.y),_t=bt}if(!U||pe!==0&&!ge||Le(He,ut)||He.push(ut),g_(this.layoutVertexArray,ut.x,ut.y,0,0,1,1,0),this.wallMode){let Mt=K(ft,Qe);__(this.wallVertexArray,X.joinNormals[ft],!Mt)}nt.vertexLength++,this.footprintVertices.emplaceBack(at.x,at.y),Xe.push(at.x,at.y),P&&y_(this.layoutVertexExtArray,D.projectTilePoint(ut.x,ut.y,p),D.upVector(p,ut.x,ut.y))}U&&(pe===0||ge)&&(He.length!==0&&Le(He,He[0])&&He.pop(),this.groundEffect.addData(He,ke,I))}let Ae=this.wallMode?X.indices:pp(Xe,Re);for(let qe=0;qe<Ae.length;qe+=3)this.footprintIndices.emplaceBack(Ue.vertexOffset+Ae[qe+0],Ue.vertexOffset+Ae[qe+1],Ue.vertexOffset+Ae[qe+2]),this.indexArray.emplaceBack(je+Ae[qe],je+Ae[qe+2],je+Ae[qe+1]),nt.primitiveLength++;Ue.indexCount+=Ae.length,Ue.vertexCount+=this.footprintVertices.length-Ue.vertexOffset}for(let Xe=0;Xe<Te.length;Xe++){let Re=Te[Xe];N.startRing(V,Re[0]);let Ae=Re.length>4&&QA(Re[Re.length-2],Re[0],Re[1]),qe=pe?aB(Re[Re.length-2],Re[0],Re[1],pe):0,Qe=[],He,_t,bt;_t=Re[1].sub(Re[0])._perp()._unit();let ft=!0;for(let at=1,Gt=0;at<Re.length;at++){let ut=Re[at-1],Mt=Re[at],Zt=Re[at===Re.length-1?1:at+1];if(N.appendEdge(V,Mt,ut),AE(Mt,ut,ke)){pe&&(_t=Zt.sub(Mt)._perp()._unit(),ft=!ft);continue}let an=Mt.sub(ut)._perp(),En=an.x/(Math.abs(an.x)+Math.abs(an.y)),Yt=an.y>0?1:0,Cn=ut.dist(Mt);if(Gt+Cn>32768&&(Gt=0),pe){bt=Zt.sub(Mt)._perp()._unit();let te=KA(ut,Mt,Zt,YA(_t,bt),pe);isNaN(te)&&(te=0);let Ne=Mt.sub(ut)._unit();ut=ut.add(Ne.mult(qe))._round(),Mt=Mt.add(Ne.mult(-te))._round(),qe=te,_t=bt,U&&this.zoom>=17&&(Le(Qe,ut)||Qe.push(ut),Le(Qe,Mt)||Qe.push(Mt))}let An=nt.vertexLength,Ii=Re.length>4&&QA(ut,Mt,Zt),oe=eM(Gt,Ae,ft);if(g_(this.layoutVertexArray,ut.x,ut.y,En,Yt,0,0,oe),g_(this.layoutVertexArray,ut.x,ut.y,En,Yt,0,1,oe),this.wallMode){let te=K(at-1,Re),Ne=X.joinNormals[at-1];__(this.wallVertexArray,Ne,te),__(this.wallVertexArray,Ne,te)}if(Gt+=Cn,oe=eM(Gt,Ii,!ft),Ae=Ii,g_(this.layoutVertexArray,Mt.x,Mt.y,En,Yt,0,0,oe),g_(this.layoutVertexArray,Mt.x,Mt.y,En,Yt,0,1,oe),this.wallMode){let te=K(at,Re),Ne=X.joinNormals[at];__(this.wallVertexArray,Ne,te),__(this.wallVertexArray,Ne,te)}if(nt.vertexLength+=4,this.indexArray.emplaceBack(An+0,An+1,An+2),this.indexArray.emplaceBack(An+1,An+3,An+2),nt.primitiveLength+=2,pe){let te=je+(at===1?Re.length-2:at-2),Ne=at===1?je:te+1;if(this.indexArray.emplaceBack(An+1,te,An+3),this.indexArray.emplaceBack(te,Ne,An+3),nt.primitiveLength+=2,He===void 0&&(He=An),!AE(Zt,Re[at],ke)){let st=at===Re.length-1?He:nt.vertexLength;this.indexArray.emplaceBack(An+2,An+3,st),this.indexArray.emplaceBack(An+3,st+1,st),this.indexArray.emplaceBack(An+3,Ne,st+1),nt.primitiveLength+=3}ft=!ft}if(P){let te=this.layoutVertexExtArray,Ne=D.projectTilePoint(ut.x,ut.y,p),st=D.projectTilePoint(Mt.x,Mt.y,p),ze=D.upVector(p,ut.x,ut.y),lt=D.upVector(p,Mt.x,Mt.y);y_(te,Ne,ze),y_(te,Ne,ze),y_(te,st,lt),y_(te,st,lt)}}O&&(je+=Re.length-1),U&&pe&&this.zoom>=17&&(Qe.length!==0&&Le(Qe,Qe[0])&&Qe.pop(),this.groundEffect.addData(Qe,ke,I,pe>0))}this.footprintSegments.push(Ue),Ye.triangleCount=this.indexArray.length-Ye.triangleArrayOffset,this.polygonSegments.push(Ye),++V.footprintSegLen,++V.polygonSegLen}if(V.vertexCount=this.layoutVertexArray.length-V.vertexArrayOffset,V.groundVertexCount=this.groundEffect.vertexArray.length-V.groundVertexArrayOffset,V.vertexCount!==0){if(V.centroidXY=N.borders?HA:this.encodeCentroid(N,V),this.centroidData.push(V),N.borders){this.featuresOnBorder.push(N);let Te=this.featuresOnBorder.length-1;for(let ke=0;ke<N.borders.length;ke++)N.borders[ke][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ke].push(Te)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,n,u,m,_,p,w,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(n,u,m,_,p,w,this.worldview),this.maxHeight=Math.max(this.maxHeight,W)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((n,a)=>this.featuresOnBorder[n].borders[e][0]-this.featuresOnBorder[a].borders[e][0])}splitToSubtiles(){let e=[];for(let _=0;_<this.centroidData.length;_++){let b=this.centroidData[_],w=+(b.min.y+b.max.y>rt),I=2*w+(+(b.min.x+b.max.x>rt)^w);for(let S=0;S<b.polygonSegLen;S++){let D=b.polygonSegIdx+S;e.push({centroidIdx:_,subtile:I,polygonSegmentIdx:D,triangleSegmentIdx:this.polygonSegments[D].triangleSegIdx})}}let n=new wi;e.sort((_,b)=>_.triangleSegmentIdx===b.triangleSegmentIdx?_.subtile-b.subtile:_.triangleSegmentIdx-b.triangleSegmentIdx);let a=0,u=0,p=0;for(let _ of e){if(_.triangleSegmentIdx!==a)break;p++}let m=e.length;for(;u!==e.length;){a=e[u].triangleSegmentIdx;let _=0,b=u,w=u;for(let I=b;I<p&&e[I].subtile===_;I++)w++;for(;b!==p;){let I=e[b];_=I.subtile;let S=this.centroidData[I.centroidIdx].min.clone(),D=this.centroidData[I.centroidIdx].max.clone(),P={vertexOffset:this.segments.segments[a].vertexOffset,primitiveOffset:n.length,vertexLength:this.segments.segments[a].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let O=b;O<w;O++){let N=e[O],V=this.polygonSegments[N.polygonSegmentIdx],U=this.centroidData[N.centroidIdx].min,W=this.centroidData[N.centroidIdx].max,X=this.indexArray.uint16;for(let K=V.triangleArrayOffset;K<V.triangleArrayOffset+V.triangleCount;K++)n.emplaceBack(X[3*K],X[3*K+1],X[3*K+2]);P.primitiveLength+=V.triangleCount,S.x=Math.min(S.x,U.x),S.y=Math.min(S.y,U.y),D.x=Math.max(D.x,W.x),D.y=Math.max(D.y,W.y)}P.primitiveLength>0&&this.triangleSubSegments.push({segment:P,min:S,max:D}),b=w;for(let O=b;O<p&&e[O].subtile===e[b].subtile;O++)w++}u=p;for(let I=u;I<m&&e[I].triangleSegmentIdx===e[u].triangleSegmentIdx;I++)p++}n._trim(),this.indexArray=n}getVisibleSegments(e,n,a){let u=new Ci;if(this.wallMode){for(let N of this.triangleSubSegments)u.segments.push(N.segment);return u}let p=0,m=0,_=1<<e.canonical.z;if(n){let N=n.getMinMaxForTile(e);N&&(p=N.min,m=N.max)}m+=this.maxHeight;let b=e.toUnwrapped(),w,I=[b.canonical.x/_+b.wrap,b.canonical.y/_],S=[(b.canonical.x+1)/_+b.wrap,(b.canonical.y+1)/_],D=(N,V,U)=>[N[0]*(1-U[0])+V[0]*U[0],N[1]*(1-U[1])+V[1]*U[1]],P=[],O=[];for(let N of this.triangleSubSegments){P[0]=N.min.x/rt,P[1]=N.min.y/rt,O[0]=N.max.x/rt,O[1]=N.max.y/rt;let V=D(I,S,P),U=D(I,S,O);if(new on([V[0],V[1],p],[U[0],U[1],m]).intersectsPrecise(a)===0){w&&(u.segments.push(w),w=void 0);continue}let W=N.segment;w&&w.vertexOffset!==W.vertexOffset&&(u.segments.push(w),w=void 0),w?(w.vertexLength+=W.vertexLength,w.primitiveLength+=W.primitiveLength):w={vertexOffset:W.vertexOffset,primitiveLength:W.primitiveLength,vertexLength:W.vertexLength,primitiveOffset:W.primitiveOffset,sortKey:void 0,vaos:{}}}return w&&u.segments.push(w),u}encodeCentroid(e,n){let a=e.centroid(),u=n.span(),p=Math.min(7,Math.round(u.x*this.tileToMeter/10)),m=Math.min(7,Math.round(u.y*this.tileToMeter/10));return new Ze(G(a.x,1,rt-1)<<3|p,G(a.y,1,rt-1)<<3|m)}encodeBorderCentroid(e){if(!e.borders)return new Ze(0,0);let n=e.borders,a=Number.MAX_VALUE;if(n[0][0]!==a||n[1][0]!==a){let u=n[0][0]!==a?0:1;return new Ze(6|(n[0][0]!==a?0:65528),(n[u][0]+n[u][1])/2<<3|6)}{let u=n[2][0]!==a?2:3;return new Ze((n[u][0]+n[u][1])/2<<3|6,6|(n[2][0]!==a?0:65528))}}showCentroid(e){let n=this.centroidData[e.centroidDataIndex];n.flags&=2147483647,n.centroidXY.x=0,n.centroidXY.y=0,this.writeCentroidToBuffer(n)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);let n=e.vertexArrayOffset,a=e.vertexCount+e.vertexArrayOffset,u=e.flags&Ou?HA:e.centroidXY,p=this.centroidVertexArray.geta_centroid_pos0(n);if(this.centroidVertexArray.geta_centroid_pos1(n)!==u.y||p!==u.x){for(let m=n;m<a;++m)this.centroidVertexArray.emplace(m,u.x,u.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,n,a){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let u=n.getReplacementRegionsForTile(e.toUnwrapped());if(A0(this.activeReplacements,u))return;if(this.activeReplacements=u,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(let m of this.centroidData)m.flags&=2147483647;let p=[];for(let m of this.activeReplacements){if(m.order<a)continue;let _=Math.max(1,Math.pow(2,m.footprintTileId.canonical.z-e.canonical.z));if(m.footprint.buildingId){let b=m.footprint.buildingId;for(let w of this.centroidData)w.buildingId===b&&(w.flags|=Ou)}else for(let b of this.centroidData)if(!(b.flags&Ou||m.min.x>b.max.x||b.min.x>m.max.x||m.min.y>b.max.y||b.min.y>m.max.y))for(let w=0;w<b.footprintSegLen;w++){let I=this.footprintSegments[b.footprintSegIdx+w];if(p.length=0,lB(this.footprintVertices,I.vertexOffset,I.vertexCount,m.footprintTileId.canonical,e.canonical,p),TE(m.footprint,p,this.footprintIndices.uint16,I.indexOffset,I.indexCount,-I.vertexOffset,-_)){b.flags|=Ou;break}}}for(let m of this.centroidData)this.writeCentroidToBuffer(m);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,n,a){let u=!1;for(let p=0;p<a.footprintSegLen;p++){let m=this.footprintSegments[a.footprintSegIdx+p],_=0;for(let b of m.ringIndices){for(let w=_,I=b+_-1;w<b+_;I=w++){let S=this.footprintVertices.int16[2*(w+m.vertexOffset)+0],D=this.footprintVertices.int16[2*(w+m.vertexOffset)+1],P=this.footprintVertices.int16[2*(I+m.vertexOffset)+1];D>n!=P>n&&e<(this.footprintVertices.int16[2*(I+m.vertexOffset)+0]-S)*(n-D)/(P-D)+S&&(u=!u)}_=b}}return u}getHeightAtTileCoord(e,n){let a=Number.NEGATIVE_INFINITY,u=!0,p=4*(e+rt)*rt+(n+rt);if(this.partLookup.hasOwnProperty(p)){let m=this.partLookup[p];return m?{height:m.height,hidden:!!(m.flags&Ou)}:void 0}for(let m of this.centroidData)e>m.max.x||m.min.x>e||n>m.max.y||m.min.y>n||m.height<=a||this.footprintContainsPoint(e,n,m)&&(a=m.height,this.partLookup[p]=m,u=!!(m.flags&Ou));if(a!==Number.NEGATIVE_INFINITY)return{height:a,hidden:u};this.partLookup[p]=void 0}}function YA(r,e){let n=r.add(e)._unit();return r.x*n.x+r.y*n.y}function aB(r,e,n,a){let u=e.sub(r)._perp()._unit(),p=n.sub(e)._perp()._unit();return KA(r,e,n,YA(u,p),a)}function KA(r,e,n,a,u){let p=Math.sqrt(1-a*a);return Math.min(r.dist(e)/3,e.dist(n)/3,u*p/a)}function AE(r,e,n){return r.x<n[0].x&&e.x<n[0].x||r.x>n[1].x&&e.x>n[1].x||r.y<n[0].y&&e.y<n[0].y||r.y>n[1].y&&e.y>n[1].y}function JA(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function QA(r,e,n){if(r.x<0||r.x>=rt||e.x<0||e.x>=rt||n.x<0||n.x>=rt)return!1;let a=n.sub(e),u=a.perp(),p=r.sub(e);return(a.x*p.x+a.y*p.y)/Math.sqrt((a.x*a.x+a.y*a.y)*(p.x*p.x+p.y*p.y))>-.866&&u.x*p.x+u.y*p.y<0}function eM(r,e,n){let a=e?2|r:-3&r;return n?1|a:-2&a}function tM(){let r=Math.PI/32,e=Math.tan(r),n=A;return n*Math.sqrt(1+2*e*e)-n}function nM(r,e,n){let a=1<<n.z,u=J(n.x/a),p=J((n.x+1)/a),m=Y(n.y/a),_=Y((n.y+1)/a);return(function(b,w,I,S,D=0,P){let O=[];if(!b.length||!I||!S)return O;let N=(re,de)=>{for(let pe of re)O.push({polygon:pe,bounds:de})},V=Math.ceil(Math.log2(I)),U=Math.ceil(Math.log2(S)),W=V-U,X=[];for(let re=0;re<Math.abs(W);re++)X.push(W>0?0:1);for(let re=0;re<Math.min(V,U);re++)X.push(0),X.push(1);let K=b;if(K=S0(K,w[0].y-D,w[1].y+D,1),K=S0(K,w[0].x-D,w[1].x+D,0),!K.length)return O;let le=[];for(X.length?le.push({polygons:K,bounds:w,depth:0}):N(K,w);le.length;){let re=le.pop(),de=re.depth,pe=X[de],ge=re.bounds[0],Le=re.bounds[1],Te=pe===0?ge.x:ge.y,ke=pe===0?Le.x:Le.y,je=P?P(pe,Te,ke):.5*(Te+ke),$e=S0(re.polygons,Te-D,je+D,pe),nt=S0(re.polygons,je-D,ke+D,pe);if($e.length){let Ye=[ge,new Ze(pe===0?je:Le.x,pe===1?je:Le.y)];X.length>de+1?le.push({polygons:$e,bounds:Ye,depth:de+1}):N($e,Ye)}if(nt.length){let Ye=[new Ze(pe===0?je:ge.x,pe===1?je:ge.y),Le];X.length>de+1?le.push({polygons:nt,bounds:Ye,depth:de+1}):N(nt,Ye)}}return O})(r,e,Math.ceil((p-u)/11.25),Math.ceil((m-_)/11.25),1,(b,w,I)=>{if(b===0)return .5*(w+I);{let S=Y((n.y+w/rt)/a);return($(.5*(Y((n.y+I/rt)/a)+S))*a-n.y)*rt}})}function lB(r,e,n,a,u,p){let m=Math.pow(2,a.z-u.z);for(let _=0;_<n;_++){let b=r.int16[2*(_+e)+0],w=r.int16[2*(_+e)+1];b=(b+u.x*rt)*m-a.x*rt,w=(w+u.y*rt)*m-a.y*rt,p.push(new Ze(b,w))}}let iM,rM;vt(R0,"FillExtrusionBucket",{omit:["layers","features"]}),vt(WA,"PartData"),vt(qA,"FootprintSegment"),vt(ZA,"BorderCentroidData"),vt(CE,"GroundEffect");class dh extends Ze{constructor(e,n,a){super(e,n),this.z=a}}class oM extends dh{constructor(e,n,a,u){super(e,n,a),this.w=u}}function sM(r,e,n,a){let u=n==="x"?"y":"x",p=(a-r[n])/(e[n]-r[n]);r[u]=Math.round(r[u]+(e[u]-r[u])*p),r[n]=a,r.hasOwnProperty("z")&&(r.z=zt(r.z,e.z,p)),r.hasOwnProperty("w")&&(r.w=zt(r.w,e.w,p))}function aM(r,e,n,a){let u=n,p=a;for(let m of["x","y"]){let _=r,b=e;_[m]>=b[m]&&(_=e,b=r),_[m]<u&&b[m]>u&&sM(_,b,m,u),_[m]<p&&b[m]>p&&sM(b,_,m,p)}}function P0(r,e,n,a,u,p){let m=[];for(let _=0;_<r.length;_++){let b=r[_],w,I=m.length,S=0;for(let D=0;D<b.length-1;D++){let P=b[D],O=b[D+1],N=0,V=S,U,W;p&&(N=Math.hypot(O.x-P.x,O.y-P.y),S+=N,U=P,W=O),P.x<e&&O.x<e||(P.x<e?P=new Ze(e,P.y+(e-P.x)/(O.x-P.x)*(O.y-P.y))._round():O.x<e&&(O=new Ze(e,P.y+(e-P.x)/(O.x-P.x)*(O.y-P.y))._round()),P.y<n&&O.y<n||(P.y<n?P=new Ze(P.x+(n-P.y)/(O.y-P.y)*(O.x-P.x),n)._round():O.y<n&&(O=new Ze(P.x+(n-P.y)/(O.y-P.y)*(O.x-P.x),n)._round()),P.x>=a&&O.x>=a||(P.x>=a?P=new Ze(a,P.y+(a-P.x)/(O.x-P.x)*(O.y-P.y))._round():O.x>=a&&(O=new Ze(a,P.y+(a-P.x)/(O.x-P.x)*(O.y-P.y))._round()),P.y>=u&&O.y>=u||(P.y>=u?P=new Ze(P.x+(u-P.y)/(O.y-P.y)*(O.x-P.x),u)._round():O.y>=u&&(O=new Ze(P.x+(u-P.y)/(O.y-P.y)*(O.x-P.x),u)._round()),w&&P.equals(w[w.length-1])||(w=[P],m.push(w),p&&p.push({progress:{min:V+lM(U,W,P)*N,max:1},parentIndex:_,prevPoint:U,nextPoint:W})),w.push(O),p&&(p[p.length-1].progress.max=V+lM(U,W,O)*N,p[p.length-1].nextPoint=W)))))}if(p&&S>0)for(let D=I;D<m.length;D++)p[D].progress.min/=S,p[D].progress.max/=S}return m}function cB(r,e,n,a,u){if(r.length<2)return void a.push(r);let p=[];for(;e.valid();){let[w,I]=e.get();for(let S=0;S<r.length-1;S++){let D=r[S],P=r[S+1],O=Qo(D,P,w,I);if(O){let[N]=O,V=new Ze(zt(D.x,P.x,N),zt(D.y,P.y,N));p.push({t:S+N,distance:0,point:V})}}e.next()}if(p.length===0)return void a.push(r);p.sort((w,I)=>w.t-I.t);let m=0,_=0,b=[];for(a.push(b);m!==r.length;){if(_===p.length){for(;m!==r.length;)b.length!==0&&b[b.length-1].equals(r[m])||b.push(r[m]),m++;break}p[_].t<=m?(b.length!==0&&b[b.length-1].equals(p[_].point)||b.push(p[_].point),Math.trunc(p[_].t),_++):(b.length!==0&&b[b.length-1].equals(r[m])||b.push(r[m]),m++)}}function lM(r,e,n){return r.x!==e.x?(n.x-r.x)/(e.x-r.x):r.y!==e.y?(n.y-r.y)/(e.y-r.y):0}function v_(r,e){return r.x*e.x+r.y*e.y}function cM(r,e){if(r.length===1){let n=0,a=e[n++],u;for(;!u||a.equals(u);)if(u=e[n++],!u)return 1/0;for(;n<e.length;n++){let p=e[n],m=r[0],_=u.sub(a),b=p.sub(a),w=m.sub(a),I=v_(_,_),S=v_(_,b),D=v_(b,b),P=v_(w,_),O=v_(w,b),N=I*D-S*S,V=(D*P-S*O)/N,U=(I*O-S*P)/N,W=a.z*(1-V-U)+u.z*V+p.z*U;if(isFinite(W))return W}return 1/0}{let n=1/0;for(let a of e)n=Math.min(n,a.z);return n}}function uM(r,e,n){let a=1/0;Bi(n,e)&&(a=cM(n,e[0]));for(let u=0;u<e.length;u++){let p=e[u],m=r[u];for(let _=0;_<p.length-1;_++){let b=p[_],w=[b,p[_+1],m[_+1],m[_],b];$i(n,w)&&(a=Math.min(a,cM(n,w)))}}return a!==1/0&&a}function dM(r,e,n,a,u,p,m,_,b,w,I){return r.projection.name==="globe"?(function(S,D,P,O,N,V,U,W,X,K,le){let re=[],de=[],pe=S.projection.upVectorScale(le,S.center.lat,S.worldSize).metersToTile,ge=[0,0,0,1],Le=[0,0,0,1],Te=(je,$e,nt,Ye)=>{je[0]=$e,je[1]=nt,je[2]=Ye,je[3]=1},ke=tM();P>0&&(P+=ke),O+=ke;for(let je of D){let $e=[],nt=[];for(let Ye of je){let Ue=Ye.x+N.x,Xe=Ye.y+N.y,Re=S.projection.projectTilePoint(Ue,Xe,le),Ae=S.projection.upVector(le,Ye.x,Ye.y),qe=P,Qe=O;if(U){let He=hM(Ue,Xe,P,O,U,W,X,K);qe+=He.base,Qe+=He.top}P!==0?Te(ge,Re.x+Ae[0]*pe*qe,Re.y+Ae[1]*pe*qe,Re.z+Ae[2]*pe*qe):Te(ge,Re.x,Re.y,Re.z),Te(Le,Re.x+Ae[0]*pe*Qe,Re.y+Ae[1]*pe*Qe,Re.z+Ae[2]*pe*Qe),ki(ge,ge,V),ki(Le,Le,V),$e.push(new dh(ge[0],ge[1],ge[2])),nt.push(new dh(Le[0],Le[1],Le[2]))}re.push($e),de.push(nt)}return[re,de]})(r,e,n,a,u,p,m,_,b,w,I):m?(function(S,D,P,O,N,V,U,W,X){let K=[],le=[],re=[0,0,0,1];for(let de of S){let pe=[],ge=[];for(let Le of de){let Te=Le.x+O.x,ke=Le.y+O.y,je=hM(Te,ke,D,P,V,U,W,X);re[0]=Te,re[1]=ke,re[2]=je.base,re[3]=1,co(re,re,N),re[3]=Math.max(re[3],1e-5);let $e=new dh(re[0]/re[3],re[1]/re[3],re[2]/re[3]);re[0]=Te,re[1]=ke,re[2]=je.top,re[3]=1,co(re,re,N),re[3]=Math.max(re[3],1e-5);let nt=new dh(re[0]/re[3],re[1]/re[3],re[2]/re[3]);pe.push($e),ge.push(nt)}K.push(pe),le.push(ge)}return[K,le]})(e,n,a,u,p,m,_,b,w):(function(S,D,P,O,N){let V=[],U=[],W=N[8]*D,X=N[9]*D,K=N[10]*D,le=N[11]*D,re=N[8]*P,de=N[9]*P,pe=N[10]*P,ge=N[11]*P;for(let Le of S){let Te=[],ke=[];for(let je of Le){let $e=je.x+O.x,nt=je.y+O.y,Ye=N[0]*$e+N[4]*nt+N[12],Ue=N[1]*$e+N[5]*nt+N[13],Xe=N[2]*$e+N[6]*nt+N[14],Re=N[3]*$e+N[7]*nt+N[15],Ae=Ye+W,qe=Ue+X,Qe=Xe+K,He=Math.max(Re+le,1e-5),_t=Ye+re,bt=Ue+de,ft=Xe+pe,at=Math.max(Re+ge,1e-5);Te.push(new dh(Ae/He,qe/He,Qe/He)),ke.push(new dh(_t/at,bt/at,ft/at))}V.push(Te),U.push(ke)}return[V,U]})(e,n,a,u,p)}function hM(r,e,n,a,u,p,m,_){let b=m*u.getElevationAt(r,e,!0,!0),w=p[0]!==0,I=w?p[1]===0?m*(p[0]/$A-GA):m*(function(S,D,P){let O=Math.floor(D[0]/8),N=Math.floor(D[1]/8),V=10*(D[0]-8*O),U=10*(D[1]-8*N),W=S.getElevationAt(O,N,!0,!0),X=S.getMeterToDEM(P),K=Math.floor(.5*(V*X-1)),le=Math.floor(.5*(U*X-1)),re=S.tileCoordToPixel(O,N),de=2*K+1,pe=2*le+1,ge=(function(nt,Ye,Ue,Xe,Re){return[nt.getElevationAtPixel(Ye,Ue,!0),nt.getElevationAtPixel(Ye+Re,Ue,!0),nt.getElevationAtPixel(Ye,Ue+Re,!0),nt.getElevationAtPixel(Ye+Xe,Ue+Re,!0)]})(S,re.x-K,re.y-le,de,pe),Le=Math.abs(ge[0]-ge[1]),Te=Math.abs(ge[2]-ge[3]),ke=Math.abs(ge[0]-ge[2])+Math.abs(ge[1]-ge[3]),je=Math.min(.25,.5*X*(Le+Te)/de),$e=Math.min(.25,.5*X*ke/pe);return W+Math.max(je*V,$e*U)})(u,p,_):b;return{base:b+(n===0?-1:n),top:w?Math.max(I+a,b+n+2):b+a}}class uB{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class dB{constructor(){this.tasks={},this.taskQueue=[],Ce(["process"],this),this.invoker=new uB(this.process),this.nextId=0}add(e,n){let a=this.nextId++,u=(function({type:p,isSymbolTile:m,zoom:_}){return _=_||0,p==="message"?0:p!=="maybePrepare"||m?p!=="parseTile"||m?p==="parseTile"&&m?300-_:p==="maybePrepare"&&m?400-_:500:200-_:100-_})(n);if(u===0){try{e()}finally{}return null}return this.tasks[a]={fn:e,metadata:n,priority:u,id:a},this.taskQueue.push(a),this.invoker.trigger(),{cancel:()=>{delete this.tasks[a]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(a=>!!this.tasks[a]),!this.taskQueue.length)return;let e=this.pick();if(e===null)return;let n=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!n)return;n.fn()}finally{}}pick(){let e=null,n=1/0;for(let u=0;u<this.taskQueue.length;u++){let p=this.tasks[this.taskQueue[u]];p.priority<n&&(n=p.priority,e=u)}if(e===null)return null;let a=this.taskQueue[e];return this.taskQueue.splice(e,1),a}remove(){this.invoker.remove()}}class fM{constructor(e,n,a){this.target=e,this.parent=n,this.mapId=a,this.callbacks={},this.cancelCallbacks={},Ce(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new dB}send(e,n,a,u,p=!1,m){let _=Math.round(1e18*Math.random()).toString(36).substring(0,10);a&&(a.metadata=m,this.callbacks[_]=a);let b=new Set;return this.target.postMessage({id:_,type:e,hasCallback:!!a,targetMapId:u,mustQueue:p,sourceMapId:this.mapId,data:_l(n,b)},b),{cancel:()=>{a&&delete this.callbacks[_],this.target.postMessage({id:_,type:"<cancel>",targetMapId:u,sourceMapId:this.mapId})}}}receive(e){let n=e.data;if(!n)return;let a=n.id;if(a&&(!n.targetMapId||this.mapId===n.targetMapId))if(n.type==="<cancel>"){let u=this.cancelCallbacks[a];delete this.cancelCallbacks[a],u&&u.cancel()}else if(n.mustQueue||Ni(self)){let u=this.callbacks[a],p=this.scheduler.add(()=>this.processTask(a,n),u&&u.metadata||{type:"message"});p&&(this.cancelCallbacks[a]=p)}else this.processTask(a,n)}processTask(e,n){if(delete this.cancelCallbacks[e],n.type==="<response>"){let a=this.callbacks[e];delete this.callbacks[e],a&&(n.error?a(yl(n.error)):a(null,yl(n.data)))}else{let a=new Set,u=n.hasCallback?(m,_)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:m?_l(m):null,data:_l(_,a)},a)}:()=>{},p=yl(n.data);if(this.parent[n.type])this.parent[n.type](n.sourceMapId,p,u);else if(this.parent.getWorkerSource){let m=n.type.split("."),{source:_,scope:b}=p;this.parent.getWorkerSource(n.sourceMapId,m[0],_,b)[m[1]](p,u)}else u(new Error(`Could not find function ${n.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var x_={workerUrl:"",workerClass:null,workerParams:void 0};let ME="mapboxgl_preloaded_worker_pool",O0=(()=>{class r{constructor(){this.active={}}acquire(n,a=r.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<a;)this.workers.push(x_.workerClass!=null?new x_.workerClass:new self.Worker(x_.workerUrl,x_.workerParams));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.workers&&this.numActive()===0&&(this.workers.forEach(a=>{a.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[ME]}numActive(){return Object.keys(this.active).length}}return r.workerCount=2,r})();class gp{constructor(e,n,a="Worker",u=O0.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Me();let p=this.workerPool.acquire(this.id,u);for(let m=0;m<p.length;m++){let _=new gp.Actor(p[m],n,this.id);_.name=`${a} ${m}`,this.actors.push(_)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,n,a){he(this.actors,(u,p)=>{u.send(e,n,p)},a=a||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}let b_,RE;function L0(){return b_||(b_=new O0),b_}gp.Actor=fM;class hB{constructor(e){this.module=e}createIntArray(e){let n=new Int32Array(e),a=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heap32.set(n,a/n.BYTES_PER_ELEMENT),a}createFloatArray(e){let n=new Float32Array(e),a=this.module.malloc(n.length*n.BYTES_PER_ELEMENT);return this.module.heapF32.set(n,a/n.BYTES_PER_ELEMENT),a}createStringBuffer(e){let n=this.module.malloc(e.length+1);for(let a=0;a<e.length;++a)this.module.heapU8[n+a]=e.charCodeAt(a);return this.module.heapU8[n+e.length]=0,n}readStringBuffer(e){let n="";for(;this.module.heapU8[e]!==0;)n+=String.fromCharCode(this.module.heapU8[e]),++e;return n}setStyle(e){let n=e.entranceColorRgb,a=e.facadeGlazingColorRgb,u=e.roofColorRgb,p=e.wallColorRgb,m=e.normalScale;this.module.setStyle(n[0],n[1],n[2],a[0],a[1],a[2],u[0],u[1],u[2],p[0],p[1],p[2],m[0],m[1],m[2],e.tileToMeters)}setAOOptions(e,n){this.module.setAOOptions(e?1:0,n)}setMetricOptions(e,n){this.module.setMetricOptions(e?1:0,n)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,n){this.module.setFacadeOptions(e,n?1:0)}setFauxFacadeOptions(e,n,a){this.module.setFauxFacadeOptions(e?1:0,n?1:0,a)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,n){for(let _ of e){let b=this.createStringBuffer(_.roofType),w=[0],I=[];for(let P of _.coordinates)if(Array.isArray(P)){for(let O of P)I.push(O.x),I.push(O.y);w.push(I.length)}let S=this.createIntArray(w),D=this.createFloatArray(I);this.module.addFeature(_.id,_.sourceId,_.minHeight,_.height,b,_.roofType.length,D,S,w.length-1),this.module.free(b),this.module.free(S),this.module.free(D)}for(let _ of n){let b;b=_.entrances?JSON.parse(_.entrances):[];let w=this.createFloatArray(b),I=[];for(let D of _.coordinates)I.push(D.x),I.push(D.y);let S=this.createFloatArray(I);this.module.addFacade(_.sourceId,_.crossPerc,_.distanceToRoad,w,b.length,S,I.length),this.module.free(w),this.module.free(S)}if(!this.module.generateMesh()){let _=this.module.getLastError();return this.readStringBuffer(_)}let a=this.module.getMeshCount(),u=new Array(a);for(let _=0;_<a;_++){let b=this.module.getPositionsPtr(_),w=this.module.getPositionsLength(_),I=new Float32Array(this.module.heapF32.buffer,b,w),S=this.module.getNormalsPtr(_),D=this.module.getNormalsLength(_),P=new Float32Array(this.module.heapF32.buffer,S,D),O=this.module.getColorsPtr(_),N=this.module.getColorsLength(_),V=new Uint8Array(this.module.heapU8.buffer,O,N),U=this.module.getAOPtr(_),W=this.module.getAOLength(_),X=new Float32Array(this.module.heapF32.buffer,U,W),K=this.module.getUVPtr(_),le=this.module.getUVLength(_),re=new Float32Array(this.module.heapF32.buffer,K,le),de=this.module.getFauxFacadePtr(_),pe=this.module.getFauxFacadeLength(_),ge=new Uint8Array(this.module.heapU8.buffer,de,pe),Le=this.module.getIndicesPtr(_),Te=this.module.getIndicesLength(_),ke=new Int32Array(this.module.heap32.buffer,Le,Te),je=this.module.getBuildingPart(_),$e=this.readStringBuffer(je);u[_]={positions:I,normals:P,colors:V,ao:X,uv:re,isFauxFacade:ge,indices:ke,buildingPart:$e}}let p=this.module.getRingCount(),m=[];for(let _=0;_<p;_++){let b=this.module.getRingPtr(_),w=this.module.getRingLength(_),I=new Float32Array(this.module.heapF32.buffer,b,w);m.push(I)}return{meshes:u,outerRingLength:this.module.getOuterRingLength(),modifiedPolygonRings:m}}}let w_,PE,Ha,_p,OE,yp=null,vp=null,pM=null,F0=null;function mM(){return Ni(self)&&self.worker.dracoUrl?self.worker.dracoUrl:PE||pi.DRACO_URL}function gM(){if(Ni(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(_p)return _p;let r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return _p=WebAssembly.validate(r)?pi.MESHOPT_SIMD_URL:pi.MESHOPT_URL,_p}function fB(){return F0}let k0={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},pB={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},E_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function _M(r,e,n){let a=n.json.bufferViews.length,u=n.buffers.length;e.bufferView=a,n.json.bufferViews[a]={buffer:u,byteLength:r.byteLength},n.buffers[u]=r}let LE="KHR_draco_mesh_compression";function mB(r,e){let n=r.extensions&&r.extensions[LE];if(!n)return;let a=new Ha.Decoder,u=bM(e,n.bufferView),p=new Ha.Mesh;if(!a.DecodeArrayToMesh(u,u.byteLength,p))throw new Error("Failed to decode Draco mesh");let m=e.json.accessors[r.indices],_=k0[m.componentType],b=m.count*_.BYTES_PER_ELEMENT,w=Ha._malloc(b);_===Uint16Array?a.GetTrianglesUInt16Array(p,b,w):a.GetTrianglesUInt32Array(p,b,w),_M(Ha.memory.buffer.slice(w,w+b),m,e),Ha._free(w);for(let I of Object.keys(n.attributes)){let S=a.GetAttributeByUniqueId(p,n.attributes[I]),D=e.json.accessors[r.attributes[I]],P=pB[D.componentType],O=D.count*E_[D.type]*k0[D.componentType].BYTES_PER_ELEMENT,N=Ha._malloc(O);a.GetAttributeDataArrayForAllPoints(p,S,Ha[P],O,N),_M(Ha.memory.buffer.slice(N,N+O),D,e),Ha._free(N)}a.destroy(),p.destroy(),delete r.extensions[LE]}let N0="EXT_meshopt_compression";function gB(r,e){if(!r.extensions||!r.extensions[N0])return;let n=r.extensions[N0],a=new Uint8Array(e.buffers[n.buffer],n.byteOffset||0,n.byteLength||0),u=new Uint8Array(n.count*n.byteStride);OE.decodeGltfBuffer(u,n.count,n.byteStride,a,n.mode,n.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=u.buffer,delete r.extensions[N0]}let yM=1179937895,vM=new TextDecoder("utf8");function xM(r,e){return new URL(r,e).href}function _B(r,e,n,a){return fetch(xM(r.uri,a)).then(u=>u.arrayBuffer()).then(u=>{e.buffers[n]=u})}function bM(r,e){let n=r.json.bufferViews[e];return new Uint8Array(r.buffers[n.buffer],n.byteOffset||0,n.byteLength)}function yB(r,e,n,a){if(r.uri){let u=xM(r.uri,a);return fetch(u).then(p=>p.blob()).then(p=>createImageBitmap(p)).then(p=>{e.images[n]=p})}if(r.bufferView!==void 0){let u=bM(e,r.bufferView),p=new Blob([u],{type:r.mimeType});return createImageBitmap(p).then(m=>{e.images[n]=m})}}function wM(r,e=0,n){let a={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===yM){let I=new Uint32Array(r,e),S=2,D=(I[S++]>>2)-3,P=I[S++]>>2;if(S++,a.json=JSON.parse(vM.decode(I.subarray(S,S+P))),S+=P,S<D){let O=I[S++];S++;let N=e+(S<<2);a.buffers[0]=r.slice(N,N+O)}}else a.json=JSON.parse(vM.decode(new Uint8Array(r,e)));let{buffers:u,images:p,meshes:m,extensionsUsed:_,bufferViews:b}=a.json,w=Promise.resolve();if(u){let I=[];for(let S=0;S<u.length;S++){let D=u[S];D.uri?I.push(_B(D,a,S,n)):a.buffers[S]||(a.buffers[S]=null)}w=Promise.all(I)}return w.then(()=>{let I=[],S=_&&_.includes(LE),D=_&&_.includes(N0);if(S&&I.push((function(){if(!Ha)return w_??(w_=(function(P){let O,N=null;function V(){O=new Uint8Array(N.buffer)}function U(){throw new Error("Unexpected Draco error.")}let W={a:{a:U,d:function(X,K,le){return O.copyWithin(X,K,K+le)},c:function(X){let K=O.length,le=Math.max(X>>>0,Math.ceil(1.2*K)),re=Math.ceil((le-K)/65536);try{return N.grow(re),V(),!0}catch{return!1}},b:U}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(P,W):P.then(X=>X.arrayBuffer()).then(X=>WebAssembly.instantiate(X,W))).then(X=>{let{Rb:K,Qb:le,P:re,T:de,X:pe,Ja:ge,La:Le,Qa:Te,Va:ke,Wa:je,eb:$e,jb:nt,f:Ye,e:Ue,yb:Xe,zb:Re,Ab:Ae,Bb:qe,Db:Qe,Gb:He}=X.instance.exports;N=Ue;let _t=(()=>{let bt=0,ft=0,at=0,Gt=0;return ut=>{at&&(K(Gt),K(bt),ft+=at,at=bt=0),bt||(ft+=128,bt=le(ft));let Mt=ut.length+7&-8,Zt=bt;Mt>=ft&&(at=Mt,Zt=Gt=le(Mt));for(let an=0;an<ut.length;an++)O[Zt+an]=ut[an];return Zt}})();return V(),Ye(),{memory:Ue,_free:K,_malloc:le,Mesh:class{constructor(){this.ptr=re()}destroy(){de(this.ptr)}},Decoder:class{constructor(){this.ptr=ge()}destroy(){nt(this.ptr)}DecodeArrayToMesh(bt,ft,at){let Gt=_t(bt),ut=Le(this.ptr,Gt,ft,at.ptr);return!!pe(ut)}GetAttributeByUniqueId(bt,ft){return{ptr:Te(this.ptr,bt.ptr,ft)}}GetTrianglesUInt16Array(bt,ft,at){ke(this.ptr,bt.ptr,ft,at)}GetTrianglesUInt32Array(bt,ft,at){je(this.ptr,bt.ptr,ft,at)}GetAttributeDataArrayForAllPoints(bt,ft,at,Gt,ut){$e(this.ptr,bt.ptr,ft.ptr,at,Gt,ut)}},DT_INT8:Xe(),DT_UINT8:Re(),DT_INT16:Ae(),DT_UINT16:qe(),DT_UINT32:Qe(),DT_FLOAT32:He()}})})(fetch(mM())),w_.then(P=>{Ha=P,w_=void 0}))})()),D&&I.push((function(){if(OE)return;let P=(function(O){let N,V=WebAssembly.instantiateStreaming(O,{}).then(X=>{N=X.instance,N.exports.__wasm_call_ctors()}),U={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},W={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:V,supported:!0,decodeGltfBuffer(X,K,le,re,de,pe){(function(ge,Le,Te,ke,je,$e,nt){let Ye=ge.exports.sbrk,Ue=ke+3&-4,Xe=Ye(Ue*je),Re=Ye($e.length),Ae=new Uint8Array(ge.exports.memory.buffer);Ae.set($e,Re);let qe=Le(Xe,ke,je,Re,$e.length);if(qe===0&&nt&&nt(Xe,Ue,je),Te.set(Ae.subarray(Xe,Xe+ke*je)),Ye(Xe-Ye(0)),qe!==0)throw new Error(`Malformed buffer data: ${qe}`)})(N,N.exports[W[de]],X,K,le,re,N.exports[U[pe]])}}})(fetch(gM()));return P.ready.then(()=>{OE=P})})()),p)for(let P=0;P<p.length;P++)I.push(yB(p[P],a,P,n));return(I.length?Promise.all(I):Promise.resolve()).then(()=>{if(S&&m)for(let{primitives:P}of m)for(let O of P)mB(O,a);if(D&&m&&b)for(let P of b)gB(P,a);return a})})}function EM(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>wM(e,0,r))}function FE(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function kE(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class NE{constructor(e,n,a,u){this.context=e,this.format=a,this.useMipmap=u&&u.useMipmap,this.texture=e.gl.createTexture(),this.update(n,{premultiply:u&&u.premultiply})}update(e,n){let a=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,u=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:p}=this,{gl:m}=p,{x:_,y:b}=n&&n.position?n.position:{x:0,y:0},w=_+a,I=b+u;!this.size||this.size[0]===w&&this.size[1]===I||(m.bindTexture(m.TEXTURE_2D,null),m.deleteTexture(this.texture),this.texture=m.createTexture(),this.size=null),m.bindTexture(m.TEXTURE_2D,this.texture),p.pixelStoreUnpackFlipY.set(!1),p.pixelStoreUnpack.set(1),p.pixelStoreUnpackPremultiplyAlpha.set(this.format===m.RGBA8&&(!n||n.premultiply!==!1));let S=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&w>0&&I>0){let D=this.useMipmap?Math.floor(Math.log2(Math.max(w,I)))+1:1;m.texStorage2D(m.TEXTURE_2D,D,this.format,w,I),this.size=[w,I]}this.size&&(S?m.texSubImage2D(m.TEXTURE_2D,0,_,b,FE(this.format),kE(this.format),e):"data"in e&&e.data&&m.texSubImage2D(m.TEXTURE_2D,0,_,b,a,u,FE(this.format),kE(this.format),e.data)),this.useMipmap&&m.generateMipmap(m.TEXTURE_2D)}bind(e,n,a=!1){let{context:u}=this,{gl:p}=u;p.bindTexture(p.TEXTURE_2D,this.texture),e!==this.minFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,e),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,this.useMipmap&&!a?e===p.NEAREST?p.NEAREST_MIPMAP_NEAREST:p.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),n!==this.wrapS&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,n),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,n),this.wrapS=n)}bindExtraParam(e,n,a,u,p){let{context:m}=this,{gl:_}=m;_.bindTexture(_.TEXTURE_2D,this.texture),n!==this.magFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,n),this.magFilter=n),e!==this.minFilter&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,this.useMipmap?e===_.NEAREST?_.NEAREST_MIPMAP_NEAREST:_.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),a!==this.wrapS&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,a),this.wrapS=a),u!==this.wrapT&&(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,u),this.wrapT=u),p!==this.compareMode&&(p?(_.texParameteri(_.TEXTURE_2D,_.TEXTURE_COMPARE_MODE,_.COMPARE_REF_TO_TEXTURE),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_COMPARE_FUNC,p)):_.texParameteri(_.TEXTURE_2D,_.TEXTURE_COMPARE_MODE,_.NONE),this.compareMode=p)}destroy(){let{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class T_{constructor(e,n){this.context=e,this.texture=n}bind(e,n){let{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_2D,this.texture),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,e),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,e),this.minFilter=e),n!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,n),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,n),this.wrapS=n)}}let vB=hn([{name:"a_pos_3f",components:3,type:"Float32"}]),xB=hn([{name:"a_color_3f",components:3,type:"Float32"}]),bB=hn([{name:"a_color_4f",components:4,type:"Float32"}]),wB=hn([{name:"a_uv_2f",components:2,type:"Float32"}]),EB=hn([{name:"a_normal_3f",components:3,type:"Float32"}]),TB=hn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),IB=hn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function TM(r,e){let n=z0(r.projection,r.zoom,r.width,r.height),a=(function(p,m,_,b,w){let I=new L(_.lng-180*Lu,_.lat),S=new L(_.lng+180*Lu,_.lat),D=p.project(I.lng,I.lat),P=p.project(S.lng,S.lat),O=-Math.atan2(P.y-D.y,P.x-D.x),N=be.fromLngLat(_);N.y=G(N.y,-1+Lu,1-Lu);let V=N.toLngLat(),U=p.project(V.lng,V.lat),W=be.fromLngLat(V);W.x+=Lu;let X=W.toLngLat(),K=p.project(X.lng,X.lat),le=SM(K.x-U.x,K.y-U.y,O),re=be.fromLngLat(V);re.y+=Lu;let de=re.toLngLat(),pe=p.project(de.lng,de.lat),ge=SM(pe.x-U.x,pe.y-U.y,O),Le=Math.abs(le.x)/Math.abs(ge.y),Te=yt([]);jr(Te,Te,-O*(1-(w?0:b)));let ke=yt([]);return qn(ke,ke,[1,1-(1-Le)*b,1]),ke[4]=-ge.x/ge.y*b,jr(ke,ke,O),At(ke,Te,ke),ke})(r.projection,0,r.center,n,e),u=IM(r);return qn(a,a,[u,u,1]),a}function IM(r){let e=r.projection,n=z0(r.projection,r.zoom,r.width,r.height),a=zE(e,r.center),u=zE(e,L.convert(e.center));return Math.pow(2,a*n+(1-n)*u)}function z0(r,e,n,a,u=1/0){let p=r.range;if(!p)return 0;let m=Math.min(u,Math.max(n,a)),_=Math.log2(m/1024);return ne(p[0]+_,p[1]+_,e)}let Lu=1/4e4;function zE(r,e){let n=G(e.lat,-Q,Q),a=new L(e.lng-180*Lu,n),u=new L(e.lng+180*Lu,n),p=r.project(a.lng,n),m=r.project(u.lng,n),_=be.fromLngLat(a),b=be.fromLngLat(u),w=m.x-p.x,I=m.y-p.y,S=b.x-_.x,D=b.y-_.y,P=Math.sqrt((S*S+D*D)/(w*w+I*I));return Math.log2(P)}function SM(r,e,n){let a=Math.cos(n),u=Math.sin(n);return{x:r*a-e*u,y:r*u+e*a}}function DM(r,e,n){yt(r),jr(r,r,gn(e[2])),Sr(r,r,gn(e[0])),Vi(r,r,gn(e[1])),qn(r,r,n),At(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function B0(r,e,n,a,u,p,m,_){let b=[n[0]-e[0],n[1]-e[1],0],w=[a[0]-e[0],a[1]-e[1],0];if(Qr(b)<1e-12||Qr(w)<1e-12)return la(r);let I=Or([],b,w);li(I,I),ra(w,a,e),b[2]=(p-u)*_,w[2]=(m-u)*_;let S=b;return Or(S,b,w),li(S,S),Gc(r,I,S)}function V0(r,e,n=!1){let a=Ru(e.zoom),u=(function(p,m,_){let b=m.worldSize,w=[p[12],p[13],p[14]],I=Y(w[1]/b),S=J(w[0]/b),D=yt([]),P=Z(1,I)*b,O=Z(1,0)*b*se(I,m.zoom),N=1/fE(b),V=O*N;if(_){let K=z0(m.projection,m.zoom,m.width,m.height,1024);V=N*m.projection.pixelSpaceConversion(m.center.lat,b,K)}let U=T(I,S);or(U,U,Mi([],li([],U),P*V*w[2]));let W=(function(K){let le=[K[0],K[1],K[2]],re=[0,1,0],de=Or([],re,le);return Or(re,le,de),pd(re)===0&&(re=[0,1,0],Or(de,le,re)),li(de,de),li(re,re),li(le,le),[de[0],de[1],de[2],0,re[0],re[1],re[2],0,le[0],le[1],le[2],0,K[0],K[1],K[2],1]})(U);qn(D,D,[V,V,V*P]),Lt(D,D,[-w[0],-w[1],-w[2]]);let X=At([],m.globeMatrix,W);return At(X,X,D),At(X,X,p),X})(r,e,n);if(a>0){let p=(function(m,_){let b=_.worldSize,w=Z(1,0)*b*se(_.center.lat,_.zoom)/fE(b),I=Z(1,_.center.lat)*b,S=yt([]);Vi(S,S,gn(_.center.lng)),Sr(S,S,gn(_.center.lat)),Lt(S,S,[0,0,Io]),qn(S,S,[w,w,w*I]);let D=_.point;return Lt(S,S,[-D.x,-D.y,0]),At(S,S,m),At(S,_.globeMatrix,S)})(r,e);return(function(m,_,b){let w=(O,N,V)=>{let U=Qr(O),W=Qr(N),X=gc(O,N,V);return Mi(X,X,1/Qr(X)*zt(U,W,V))},I=w([m[0],m[1],m[2]],[_[0],_[1],_[2]],b),S=w([m[4],m[5],m[6]],[_[4],_[5],_[6]],b),D=w([m[8],m[9],m[10]],[_[8],_[9],_[10]],b),P=gc([m[12],m[13],m[14]],[_[12],_[13],_[14]],b);return[I[0],I[1],I[2],0,S[0],S[1],S[2],0,D[0],D[1],D[2],0,P[0],P[1],P[2],1]})(u,p,a)}return u}function BE(r,e,n,a){let u=on.projectAabbCorners(a,n),p=Number.MAX_VALUE;for(let _=0;_<u.length;++_){let b=u[_];b[0]=(.5*b[0]+.5)*e.width,b[1]=(.5-.5*b[1])*e.height,b[2]<p&&(p=b[2])}let m=(function(_){let b=[],w=0;for(let P=1;P<_.length;P++)(_[P][0]<_[w][0]||_[P][0]===_[w][0]&&_[P][1]<_[w][1])&&(w=P);let I,S=w,D=new Uint8Array(_.length);do{if(D[S])break;b.push(new Ze(_[S][0],_[S][1])),D[S]=1,I=(S+1)%_.length;for(let P=0;P<_.length;P++){if(_[P][0]===_[I][0]&&_[P][1]===_[I][1]||_[P][0]===_[S][0]&&_[P][1]===_[S][1])continue;let O=[_[P][0]-_[S][0],_[P][1]-_[S][1]],N=[_[I][0]-_[S][0],_[I][1]-_[S][1]],V=O[0]*N[1]-O[1]*N[0];(V>0||V===0&&O[0]*N[0]+O[1]*N[1]>=0&&O[0]*O[0]+O[1]*O[1]>N[0]*N[0]+N[1]*N[1])&&(I=P)}S=I}while(S!==w);return b.length>0&&b.push(b[0]),b})(u);if($i(r,m))return p}let hh=64,xp={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function j0(r,e,n,a,u,p,m,_,b,w=!1){let I=n.zoom,S=n.project(a),D=se(a.lat,I),P=1/D;yt(r),Lt(r,r,[S.x+m[0]*P,S.y+m[1]*P,m[2]]);let O=1,N=1,V=n.worldSize;if(w){if(n.projection.name==="mercator"){let K=0;n.elevation&&(K=n.elevation.getAtPointOrZero(new be(S.x/V,S.y/V),0));let le=co([],[S.x,S.y,K,1],n.projMatrix)[3]/n.cameraToCenterDistance;O=le,N=le*se(n.center.lat,I)}else if(n.projection.name==="globe"){let K=V0(r,n),le=[0,0,0,1];co(le,le,At([],n.projMatrix,K));let re=le[3]/n.cameraToCenterDistance,de=Ru(I),pe=n.projection.pixelsPerMeter(a.lat,V)*se(a.lat,I),ge=n.projection.pixelsPerMeter(n.center.lat,V)*se(n.center.lat,I);O=re/zt(pe,ce(n.center.lat),de),N=re*D/pe,O*=ge,N*=ge}}else O=P;qn(r,r,[O,O,N]);let U=[...r],W=e.orientation,X=[];if(DM(X,[W[0]+(u?u[0]:0),W[1]+(u?u[1]:0),W[2]+(u?u[2]:0)],p),At(r,U,X),_&&n.elevation){let K=0,le=[];if(b&&n.elevation){K=(function(de,pe,ge,Le,Te){let ke=pe.elevation;if(!ke)return 0;let je=on.projectAabbCorners(ge,Le),$e=Z(1,Te.lat)*pe.worldSize,nt=(function(ft,at){let Gt=[0,0,1],ut=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let Mt of ut){let Zt=ft[Mt.corners[0]],an=ft[Mt.corners[1]],En=ft[Mt.corners[2]],Yt=[an[0]-Zt[0],an[1]-Zt[1],at*(an[2]-Zt[2])],Cn=Or(Yt,Yt,[En[0]-Zt[0],En[1]-Zt[1],at*(En[2]-Zt[2])]);li(Cn,Cn),Mt.dotProductWithUp=sr(Cn,Gt)}return ut.sort((Mt,Zt)=>Mt.dotProductWithUp-Zt.dotProductWithUp),ut[0].corners})(je,$e),Ye=je[nt[0]],Ue=je[nt[1]],Xe=je[nt[2]],Re=je[nt[3]],Ae=ke.getAtPointOrZero(new be(Ye[0]/pe.worldSize,Ye[1]/pe.worldSize),0),qe=ke.getAtPointOrZero(new be(Ue[0]/pe.worldSize,Ue[1]/pe.worldSize),0),Qe=ke.getAtPointOrZero(new be(Xe[0]/pe.worldSize,Xe[1]/pe.worldSize),0),He=ke.getAtPointOrZero(new be(Re[0]/pe.worldSize,Re[1]/pe.worldSize),0),_t=(Ae+He)/2,bt=(qe+Qe)/2;return _t>bt?qe<Qe?B0(de,Ue,Re,Ye,qe,He,Ae,$e):B0(de,Xe,Ye,Re,Qe,Ae,He,$e):Ae<He?B0(de,Ye,Ue,Xe,Ae,qe,Qe,$e):B0(de,Re,Xe,Ue,He,Qe,qe,$e),Math.max(_t,bt)})(le,n,e.aabb,r,a);let re=At([],dd([],le),X);At(r,U,re)}else K=n.elevation.getAtPointOrZero(new be(S.x/V,S.y/V),0);K!==0&&(r[14]+=K)}}class CM{constructor(e,n,a,u,p){this.materialOverrides=new Map,this.nodeOverrides=new Map,this.materialOverrideNames=[],this.nodeOverrideNames=[],this.featureProperties={},this.id=e,this.uri=n,this.position=a!=null?new L(a[0],a[1]):new L(0,0),this.orientation=u??[0,0,0],this.nodes=p,this.uploaded=!1,this.aabb=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(e,n){At(e.globalMatrix,n,e.localMatrix);let a=this.nodeOverrides.get(e.name);if(a!==void 0){let m=[];p=a.orientation,yt(u=m),Vi(u,u,gn(p[1])),jr(u,u,gn(p[2])),Sr(u,u,gn(p[0])),At(e.globalMatrix,e.globalMatrix,m)}var u,p;if(e.meshes)for(let m of e.meshes){let _=on.applyTransformFast(m.aabb,e.globalMatrix);this.aabb.encapsulate(_)}if(e.children)for(let m of e.children)this._applyTransformations(m,e.globalMatrix)}computeBoundsAndApplyParent(){let e=yt([]);this.aabb=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let n of this.nodes)this._applyTransformations(n,e)}computeModelMatrix(e,n,a,u,p,m,_=!1){j0(this.matrix,this,e.transform,this.position,n,a,u,p,m,_)}upload(e){if(!this.uploaded){for(let n of this.nodes)VE(n,e);for(let n of this.nodes)U0(n);this.uploaded=!0}}destroy(){for(let e of this.nodes)jE(e)}}function I_(r,e,n=!1){r.uploaded||(r.gfxTexture=new NE(e,r.image,n?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function SB(r,e,n){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,vB.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,EB.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,wB.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(r.colorArray.bytesPerElement===12?xB:bB).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,IB.members,!0)),r.segments=Ci.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);let a=r.material;a.pbrMetallicRoughness.baseColorTexture&&I_(a.pbrMetallicRoughness.baseColorTexture,e),a.pbrMetallicRoughness.metallicRoughnessTexture&&I_(a.pbrMetallicRoughness.metallicRoughnessTexture,e),a.normalTexture&&I_(a.normalTexture,e),a.occlusionTexture&&I_(a.occlusionTexture,e,n),a.emissionTexture&&I_(a.emissionTexture,e)}function VE(r,e,n){if(r.meshes)for(let a of r.meshes)SB(a,e,n);if(r.children)for(let a of r.children)VE(a,e,n)}function U0(r){if(r.meshes)for(let e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(let e of r.children)U0(e)}function jE(r){if(r.meshes)for(let n of r.meshes)n.vertexBuffer&&(n.vertexBuffer.destroy(),n.indexBuffer.destroy(),n.normalBuffer&&n.normalBuffer.destroy(),n.texcoordBuffer&&n.texcoordBuffer.destroy(),n.colorBuffer&&n.colorBuffer.destroy(),n.pbrBuffer&&n.pbrBuffer.destroy(),n.segments.destroy(),n.material&&((e=n.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(let n of r.children)jE(n)}function fh(r,e){let n=r.json.bufferViews[e.bufferView],a=k0[e.componentType];return new a(r.buffers[n.buffer],(e.byteOffset||0)+(n.byteOffset||0),e.count*(n.byteStride&&n.byteStride!==E_[e.type]*a.BYTES_PER_ELEMENT?n.byteStride/a.BYTES_PER_ELEMENT:E_[e.type]))}function UE(r,e,n,a){let u=k0[e.componentType],p=(function(I){switch(I){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}})(u),m=r.json.bufferViews[e.bufferView],_=m.byteStride?m.byteStride/u.BYTES_PER_ELEMENT:E_[e.type],b=n.float32,w=b.length/n.capacity;for(let I=0,S=0;I<e.count*_;I+=_,S+=w)for(let D=0;D<w;D++)b[S+D]=a[I+D]*p;n._trim()}function DB(r,e,n){let a=r.indices,u=r.attributes,p={};p.indexArray=new wi;let m=e.json.accessors[a],_=m.count/3;p.indexArray.reserve(_);let b=fh(e,m);for(let D=0;D<_;D++)p.indexArray.emplaceBack(b[3*D],b[3*D+1],b[3*D+2]);p.indexArray._trim(),p.vertexArray=new Jo;let w=e.json.accessors[u.POSITION];p.vertexArray.reserve(w.count);let I=fh(e,w);for(let D=0;D<w.count;D++)p.vertexArray.emplaceBack(I[3*D],I[3*D+1],I[3*D+2]);if(p.vertexArray._trim(),p.aabb=new on(w.min,w.max),p.centroid=(function(D,P){let O=[0,0,0],N=D.length;if(N>0){for(let V=0;V<N;V++){let U=3*D[V];O[0]+=P[U],O[1]+=P[U+1],O[2]+=P[U+2]}O[0]/=N,O[1]/=N,O[2]/=N}return O})(b,I),u.COLOR_0!==void 0){let D=e.json.accessors[u.COLOR_0],P=E_[D.type],O=fh(e,D);p.colorArray=P===3?new Jo:new bl,p.colorArray.resize(D.count),UE(e,D,p.colorArray,O)}if(u.NORMAL!==void 0){p.normalArray=new Jo;let D=e.json.accessors[u.NORMAL];p.normalArray.resize(D.count);let P=fh(e,D);UE(e,D,p.normalArray,P)}if(u.TEXCOORD_0!==void 0&&n.length>0){p.texcoordArray=new wl;let D=e.json.accessors[u.TEXCOORD_0];p.texcoordArray.resize(D.count);let P=fh(e,D);UE(e,D,p.texcoordArray,P)}if(u._FEATURE_ID_RGBA4444!==void 0){let D=e.json.accessors[u._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(p.featureData=fh(e,D))}u._FEATURE_RGBA4444!==void 0&&(p.featureData=new Uint32Array(fh(e,e.json.accessors[u._FEATURE_RGBA4444]).buffer));let S=r.material;return p.material=(function(D,P){let{emissiveFactor:O=[0,0,0],alphaMode:N="OPAQUE",alphaCutoff:V=.5,normalTexture:U,occlusionTexture:W,emissiveTexture:X,doubleSided:K,name:le}=D,{baseColorFactor:re=[1,1,1,1],metallicFactor:de=1,roughnessFactor:pe=1,baseColorTexture:ge,metallicRoughnessTexture:Le}=D.pbrMetallicRoughness||{},Te=W?P[W.index]:void 0;if(W&&W.extensions&&W.extensions.KHR_texture_transform&&Te){let ke=W.extensions.KHR_texture_transform;Te.offsetScale=[ke.offset[0],ke.offset[1],ke.scale[0],ke.scale[1]]}return{name:le,pbrMetallicRoughness:{baseColorFactor:new Nn(...re),metallicFactor:de,roughnessFactor:pe,baseColorTexture:ge?P[ge.index]:void 0,metallicRoughnessTexture:Le?P[Le.index]:void 0},doubleSided:K,emissiveFactor:new Nn(...O),alphaMode:N,alphaCutoff:V,normalTexture:U?P[U.index]:void 0,occlusionTexture:Te,emissionTexture:X?P[X.index]:void 0,defined:D.defined===void 0}})(S!==void 0?e.json.materials[S]:{defined:!1},n),p}function AM(r,e,n){let{matrix:a,rotation:u,translation:p,scale:m,mesh:_,extras:b,children:w,name:I}=r,S={};if(S.name=I,S.localMatrix=a||(function(D,P,O,N){var V=P[0],U=P[1],W=P[2],X=P[3],K=V+V,le=U+U,re=W+W,de=V*K,pe=V*le,ge=V*re,Le=U*le,Te=U*re,ke=W*re,je=X*K,$e=X*le,nt=X*re,Ye=N[0],Ue=N[1],Xe=N[2];return D[0]=(1-(Le+ke))*Ye,D[1]=(pe+nt)*Ye,D[2]=(ge-$e)*Ye,D[3]=0,D[4]=(pe-nt)*Ue,D[5]=(1-(de+ke))*Ue,D[6]=(Te+je)*Ue,D[7]=0,D[8]=(ge+$e)*Xe,D[9]=(Te-je)*Xe,D[10]=(1-(de+Le))*Xe,D[11]=0,D[12]=O[0],D[13]=O[1],D[14]=O[2],D[15]=1,D})([],u||[0,0,0,1],p||[0,0,0],m||[1,1,1]),S.globalMatrix=Fe(S.localMatrix),_!==void 0){S.meshes=n[_];let D=S.anchor=[0,0];for(let P of S.meshes){let{min:O,max:N}=P.aabb;D[0]+=O[0]+N[0],D[1]+=O[1]+N[1]}D[0]=Math.floor(D[0]/S.meshes.length/2),D[1]=Math.floor(D[1]/S.meshes.length/2)}if(b&&(b.id&&(S.id=b.id),b.lights&&(S.lights=(function(D){if(!D.length)return[];let P=(function(W){let X=atob(W),K=new Uint8Array(X.length);for(let le=0;le<X.length;le++)K[le]=X.codePointAt(le);return K})(D),O=[],N=P.length/24,V=new Uint16Array(P.buffer),U=new Float32Array(P.buffer);for(let W=0;W<N;W++){let X=V[2*W*6]/30,K=V[2*W*6+1]/30,le=V[2*W*6+10]/100,re=U[6*W+1],de=U[6*W+2],pe=U[6*W+3],ge=U[6*W+4],Le=pe-re,Te=ge-de,ke=Math.hypot(Le,Te);O.push({pos:[re+.5*Le,de+.5*Te,K],normal:[Te/ke,-Le/ke,0],width:ke,height:X,depth:le,points:[re,de,pe,ge]})}return O})(b.lights)),b.MAPBOX_geometry_bloom&&(S.isGeometryBloom=b.MAPBOX_geometry_bloom)),w){let D=[];for(let P of w)D.push(AM(e.json.nodes[P],e,n));S.children=D}return S}function CB(r){if(r.vertices.length===0||r.indices.length===0)return null;let e=new D0(r.vertices,r.indices,8,256),[n,a]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:n,max:a}}function AB(r){if(!r.extras||!r.extras.ground)return null;let e=r.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;let n=e[0];if(!n||!Array.isArray(n)||n.length===0)return null;let a=[];for(let m of n){if(!Array.isArray(m)||m.length!==2)continue;let _=m[0],b=m[1];typeof _=="number"&&typeof b=="number"&&a.push(new Ze(_,b))}if(a.length<3)return null;a.length>1&&a[a.length-1].equals(a[0])&&a.pop();let u=0;for(let m=0;m<a.length;m++){let _=a[m],b=a[(m+1)%a.length],w=a[(m+2)%a.length];u+=(_.x-b.x)*(w.y-b.y)-(w.x-b.x)*(_.y-b.y)}u>0&&a.reverse();let p=pp(a.flatMap(m=>[m.x,m.y]),[]);return p.length===0?null:{vertices:a,indices:p}}function MB(r,e){let n=[],a=[],u=0,p=[];for(let m of r){u=n.length;let _=m.vertexArray.float32,b=m.indexArray.uint16;for(let w=0;w<m.vertexArray.length;w++)p[0]=_[3*w+0],p[1]=_[3*w+1],p[2]=_[3*w+2],ki(p,p,e),n.push(new Ze(p[0],p[1]));for(let w=0;w<3*m.indexArray.length;w++)a.push(b[w]+u)}if(a.length%3!=0)return null;for(let m=0;m<a.length;m+=3){let _=n[a[m+0]],b=n[a[m+1]],w=n[a[m+2]];(_.x-b.x)*(w.y-b.y)-(w.x-b.x)*(_.y-b.y)>0&&([a[m+1],a[m+2]]=[a[m+2],a[m+1]])}return{vertices:n,indices:a}}function HE(r){let e=(function(b,w){let I=[],S=WebGL2RenderingContext;if(b.json.textures)for(let D of b.json.textures){let P={magFilter:S.LINEAR,minFilter:S.NEAREST,wrapS:S.REPEAT,wrapT:S.REPEAT};D.sampler!==void 0&&Object.assign(P,b.json.samplers[D.sampler]),I.push({image:w[D.source],sampler:P,uploaded:!1})}return I})(r,r.images),n=(function(b,w){let I=[];for(let S of b.json.meshes){let D=[];for(let P of S.primitives)D.push(DB(P,b,w));I.push(D)}return I})(r,e),{scenes:a,scene:u,nodes:p}=r.json,m=a?a[u||0].nodes:[...p.keys()],_=[];for(let b of m)_.push(AM(p[b],r,n));return(function(b,w,I){let S={},D=new Set;for(let P=0;P<b.length;P++){let O=I[w[P]];if(!O.extras)continue;let N=O.extras["mapbox:footprint:version"],V=O.extras["mapbox:footprint:id"];(N||V)&&D.add(P),N==="1.0.0"&&V&&(S[V]=P)}for(let P=0;P<b.length;P++){if(D.has(P))continue;let O=b[P],N=I[w[P]];if(!N.extras)continue;let V=null;O.id in S&&(V=MB(b[S[O.id]].meshes,O.localMatrix)),V||(V=AB(N)),V&&(O.footprint=CB(V))}if(D.size>0){let P=Array.from(D.values()).sort((O,N)=>O-N);for(let O=P.length-1;O>=0;O--)b.splice(P[O],1)}})(_,m,r.json.nodes),_}function RB(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);let e=r.vertexArray.float32,n=r.aabb.min[0]-1,a=r.aabb.min[1]-1,u=hh/(r.aabb.max[0]-n+2),p=hh/(r.aabb.max[1]-a+2);for(let m=0;m<e.length;m+=3){let _=e[m+2],b=(e[m+0]-n)*u|0,w=(e[m+1]-a)*p|0;_>r.heightmap[w*hh+b]&&(r.heightmap[w*hh+b]=_)}}function MM(r,e,n,a,u){n.reserve(n.length+4*r.length),a.reserve(a.length+10*r.length),u.reserve(u.length+10*r.length);let p=a.length;for(let m of r){let _=Math.min(10,Math.max(4,1.3*m.height))*e,b=[-m.normal[1],m.normal[0],0],w=Math.min(.29,.1*m.width/m.depth),I=m.width-2*m.depth*e*(w+.01),S=Bs([],m.pos,b,I/2),D=Bs([],m.pos,b,-I/2),P=[S[0],S[1],S[2]+m.height],O=[D[0],D[1],D[2]+m.height],N=Bs([],m.normal,b,w);Mi(N,N,_);let V=Bs([],m.normal,b,-w);Mi(V,V,_),or(N,S,N),or(V,D,V),S[2]+=.1,D[2]+=.1,a.emplaceBack(N[0],N[1],N[2]),a.emplaceBack(V[0],V[1],V[2]),a.emplaceBack(S[0],S[1],S[2]),a.emplaceBack(D[0],D[1],D[2]),a.emplaceBack(P[0],P[1],P[2]),a.emplaceBack(O[0],O[1],O[2]),a.emplaceBack(S[0],S[1],S[2]),a.emplaceBack(D[0],D[1],D[2]),a.emplaceBack(N[0],N[1],N[2]),a.emplaceBack(V[0],V[1],V[2]);let U=I/_/2;u.emplaceBack(-U-w,-1,U,.8),u.emplaceBack(U+w,-1,U,.8),u.emplaceBack(-U,0,U,1.3),u.emplaceBack(U,0,U,1.3),u.emplaceBack(U+w,-.8,U,.7),u.emplaceBack(U+w,-.8,U,.7),u.emplaceBack(0,0,U,1.3),u.emplaceBack(0,0,U,1.3),u.emplaceBack(U+w,-1.2,U,.8),u.emplaceBack(U+w,-1.2,U,.8),n.emplaceBack(6+p,4+p,8+p),n.emplaceBack(7+p,9+p,5+p),n.emplaceBack(0+p,1+p,2+p),n.emplaceBack(1+p,3+p,2+p),p+=10}}function PB(r,e){let n={};n.indexArray=new wi,n.vertexArray=new Jo,n.colorArray=new bl,MM(r,e,n.indexArray,n.vertexArray,n.colorArray);let a={defined:!0};a.emissiveFactor=Nn.black;let u={};return u.baseColorFactor=Nn.white,a.pbrMetallicRoughness=u,n.material=a,n.aabb=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),n}let RM=hn([{name:"a_pos_3f",components:3,type:"Float32"}]),OB=hn([{name:"a_normal_3",components:3,type:"Int16"}]),LB=hn([{name:"a_centroid_3",components:3,type:"Int16"}]),PM=hn([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),FB=hn([{name:"a_faux_facade_color_emissive",components:2,type:"Uint16"}]),kB=hn([{name:"a_faux_facade_data",components:4,type:"Uint16"}]),NB=hn([{name:"a_faux_facade_vertical_range",components:2,type:"Uint16"}]),zB=hn([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),BB=hn([{name:"a_flood_light_wall_radius_1i16",components:1,type:"Uint16"}]),OM=Ge.types,H0=32767;function VB(r,e){let n=rt+e;for(let a of r)for(let u of a)if(u.x<-e||u.x>n||u.y<-e||u.y>n)return!1;return!0}class LM{constructor(){this.layoutVertexArray=new Jo,this.layoutAttenuationArray=new bl,this.layoutColorArray=new Ss,this.indexArray=new wi,this.indexArrayForConflation=new wi,this.segmentsBucket=new Ci}}class $E{constructor(){this.layoutVertexArray=new Jo,this.layoutNormalArray=new hc,this.layoutCentroidArray=new hc,this.layoutColorArray=new Ss,this.layoutFacadePaintArray=null,this.layoutFacadeDataArray=null,this.layoutFacadeVerticalRangeArray=null,this.layoutFloodLightDataArray=new rp,this.layoutAOArray=new Ba,this.indexArray=new wi,this.indexArrayForConflation=new wi,this.segmentsBucket=new Ci,this.entranceBloom=new LM}}class FM{constructor(e){this.colorBufferUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.buildingWithoutFacade=new $E,this.buildingWithFacade=new $E,this.indexArrayForConflationUploaded=!1,this.featureFootprintLookup=new Map,this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.lut=e.lut,this.buildingWithFacade.layoutFacadePaintArray=new Ss,this.buildingWithFacade.layoutFacadeDataArray=new fc,this.buildingWithFacade.layoutFacadeVerticalRangeArray=new Ss,this.programConfigurations=new Gs(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.projection=e.projection,this.groundEffect=new CE(e),this.groundEffect.groundRadiusArray=new Ba,this.hasAppearances=null}updateFootprints(e,n){for(let a of this.footprints)n.push({footprint:a,id:e})}updateAppearances(e,n,a,u){}prepare(){return(function(){if(F0!=null||pM!=null)return null;if(vp!=null)return vp;let e=fetch(pi.BUILDING_GEN_URL);return vp=(function(n){let a,u,p,m;function _(){a=new Uint8Array(m.buffer),u=new Int32Array(m.buffer),p=new Float32Array(m.buffer)}function b(){throw new Error("Unexpected BuildingGen error.")}let w=()=>{},I={a:{a:b,f:function(S){let D=a.length,P=Math.max(S>>>0,Math.ceil(1.2*D)),O=Math.ceil((P-D)/65536);try{return m.grow(O),_(),!0}catch{return!1}},g:b,b:w,c:w,d:w,e:w}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(n,I):n.then(S=>S.arrayBuffer()).then(S=>WebAssembly.instantiate(S,I))).then(S=>{let D=S.instance.exports;return(0,D.g)(),m=D.f,_(),new hB({setStyle:D.h,setAOOptions:D.i,setMetricOptions:D.j,setStructuralOptions:D.k,setFacadeOptions:D.l,setFauxFacadeOptions:D.m,setFacadeClassifierOptions:D.n,addFeature:D.o,addFacade:D.p,generateMesh:D.q,getLastError:D.r,getOuterRingLength:D.s,getMeshCount:D.t,getPositionsPtr:D.u,getPositionsLength:D.v,getNormalsPtr:D.w,getNormalsLength:D.x,getColorsPtr:D.y,getColorsLength:D.z,getAOPtr:D.A,getAOLength:D.B,getUVPtr:D.C,getUVLength:D.D,getFauxFacadePtr:D.E,getFauxFacadeLength:D.F,getIndicesPtr:D.G,getIndicesLength:D.H,getBuildingPart:D.I,getRingCount:D.J,getRingPtr:D.K,getRingLength:D.L,free:D.M,malloc:D.N,heapU8:a,heap32:u,heapF32:p})})})(e).then(n=>(vp=null,F0=n,F0)).catch(n=>{Rt("Could not load building-gen"),vp=null,pM=n}),vp})()}populate(e,n,a,u){let p=fB();if(!p)return;let m=ue(a);this.tileToMeter=m,this.brightness=n.brightness,p.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,m],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:m,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),p.setAOOptions(!1,.3),p.setMetricOptions(!1,16),p.setStructuralOptions(!0),p.setFacadeClassifierOptions(3);let _=new Map,b=new Map;for(let{feature:w}of e){if(OM[w.type]!=="LineString"){_.set(w.id,w.properties.source_id);continue}let I=this.layers[0]._featureFilter.needGeometry,S=De(w,I);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom),S,a))continue;let D=I?S.geometry:Ve(w,a,u),P=[];for(let U of D)for(let W of U)P.push({x:W.x,y:W.y});let O={coordinates:P,crossPerc:w.properties.cross_perc,distanceToRoad:w.properties.distance_to_road,entrances:w.properties.entrances,sourceId:0},N=w.properties.source_id,V=b.get(N);V||(V=[],b.set(N,V)),V.push(O)}this.maxHeight=0;for(let{feature:w,id:I,index:S,sourceLayerIndex:D}of e){if(OM[w.type]==="LineString")continue;let P=this.layers[0]._featureFilter.needGeometry,O=De(w,P);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom),O,a))continue;let N=P?O.geometry:Ve(w,a,u),V=p_(N,500);if(!VB(N,163))continue;let U=this.layers[0],W=U.layout.get("building-roof-shape").evaluate(w,{},a);if(W==="flat")continue;let X=U.layout.get("building-base").evaluate(w,{},a),K=U.layout.get("building-height").evaluate(w,{},a),le=U.layout.get("building-flood-light-ground-radius").evaluate(w,{},a),re=U.paint.get("building-ambient-occlusion-intensity"),de=le/this.tileToMeter,pe=U.layout.get("building-flood-light-wall-radius").evaluate(w,{},a);pe=G(pe,0,2048);let ge=pe/2048*H0,Le=_.get(I),Te;Te=b.has(Le)?b.get(Le):[];let ke=Te.length!==0&&U.layout.get("building-facade").evaluate(w,{},a);p.setFacadeOptions(4,!0),p.setFauxFacadeOptions(ke,!1,1);let je=0,$e=0,nt=0,Ye=0,Ue=0,Xe=0;if(ke){let ze=Math.round(U.layout.get("building-facade-floors").evaluate(w,{},a));if(X===0){ze=Math.max(1,ze-(Te.length>0?1:0));let Dt=4;if(K>100){let It=[10,13,15];Dt=It[w.id?w.id%It.length:0],p.setFacadeOptions(Dt,!0)}Ue=1.6803*Dt/m}else Ue=X/m;Xe=K/m,Ue=Math.min(Ue,Xe),nt=U.layout.get("building-facade-unit-width").evaluate(w,{},a)/m,Ye=(Xe-Ue)/ze,p.setFauxFacadeOptions(!0,!0,nt);let lt=U.layout.get("building-facade-window").evaluate(w,{},a);je=lt[0],$e=lt[1]}let Re=[],Ae=new Ze(1/0,1/0),qe=new Ze(-1/0,-1/0),Qe=new Ze(0,0),He=0;for(let ze of V)if(ze.length>0){let lt=[];for(let Dt of ze){let It=[];for(let Jt=Dt.length-1;Jt>=0;Jt--){let Ft=Dt[Jt];It.push({x:Ft.x,y:Ft.y}),Ae.x=Math.min(Ae.x,Ft.x),Ae.y=Math.min(Ae.y,Ft.y),qe.x=Math.max(qe.x,Ft.x),qe.y=Math.max(qe.y,Ft.y),Qe.x+=Ft.x,Qe.y+=Ft.y,He++}lt.push(It)}Re.push({id:w.id?w.id:0,height:K,minHeight:X,sourceId:0,roofType:W,coordinates:lt})}Qe.x/=He||1,Qe.y/=He||1;let _t=p.generateMesh(Re,Te);if(typeof _t=="string"){Rt(`Unable to generate building ${w.id}: ${_t}`);continue}if(_t.meshes.length===0||_t.modifiedPolygonRings.length===0)continue;let bt=0;for(let ze of _t.meshes)bt+=ze.positions.length/3;let ft=ke?this.buildingWithFacade:this.buildingWithoutFacade,at=ft.segmentsBucket.prepareSegment(bt,ft.layoutVertexArray,ft.indexArray),Gt=[],ut=null,Mt=0,Zt=-1,an=ft.layoutVertexArray.length,En=ft.indexArray.length,Yt=0;for(let ze of _t.meshes){let lt=ft.layoutVertexArray.length;if(ze.buildingPart==="entrance"){let Et=new Array;for(let bn=0;bn<ze.positions.length;bn+=12){let Jn=ze.positions[bn+0],zn=ze.positions[bn+1],Fi=ze.positions[bn+3],gi=ze.positions[bn+4],si=ze.positions[bn+2],$n=ze.positions[bn+8]-si,Mn=1,Qt=Fi-Jn,Rn=gi-zn,ai=Math.hypot(Qt,Rn);Et.push({pos:[Jn+.5*Qt,zn+.5*Rn,si],normal:[Rn/ai,-Qt/ai,0],width:ai,height:$n,depth:Mn,points:[Jn,zn,Fi,gi]})}let Dn=ft.entranceBloom.segmentsBucket.prepareSegment(10*Et.length,ft.entranceBloom.layoutVertexArray,ft.entranceBloom.indexArray),Kn=ft.entranceBloom.layoutVertexArray.length;Mt=ft.entranceBloom.indexArray.length,MM(Et,.5/this.tileToMeter,ft.entranceBloom.indexArray,ft.entranceBloom.layoutVertexArray,ft.entranceBloom.layoutAttenuationArray);let Nt=ft.entranceBloom.layoutVertexArray.length-Kn;Zt=ft.entranceBloom.indexArray.length-Mt;for(let bn=0;bn<Nt;bn++)ft.entranceBloom.layoutColorArray.emplaceBack(65535,65535);Dn.vertexLength+=Nt,Dn.primitiveLength+=Zt,ut={part:ze.buildingPart,vertexOffset:Kn,vertexLength:Nt}}for(let Et=0;Et<ze.positions.length;Et+=3)Yt=Math.max(Yt,ze.positions[Et+2]),ft.layoutVertexArray.emplaceBack(ze.positions[Et],ze.positions[Et+1],ze.positions[Et+2]);let Dt=Math.floor(Qe.x),It=Math.floor(Qe.y),Jt=Math.floor(Yt);for(let Et=0;Et<ze.positions.length;Et+=3)ft.layoutCentroidArray.emplaceBack(Dt,It,Jt),ft.layoutFloodLightDataArray.emplaceBack(ze.buildingPart==="wall"?ge:0);for(let Et=0;Et<ze.normals.length;Et+=3)ft.layoutNormalArray.emplaceBack(ze.normals[Et+0]*H0,ze.normals[Et+1]*H0,ze.normals[Et+2]*H0);for(let Et=0;Et<ze.ao.length;Et++)ft.layoutAOArray.emplaceBack(ze.ao[Et]);for(let Et=0;Et<ze.colors.length;Et+=3){let Dn=1+(ze.ao[Et/3]-1)*re;ft.layoutColorArray.emplaceBack(ze.colors[Et]*Dn<<8|ze.colors[Et+1]*Dn,ze.colors[Et+2]*Dn<<8)}if(ke){for(let Et=0;Et<ze.positions.length;Et+=3)ft.layoutFacadePaintArray.emplaceBack(65535,255);for(let Et=0;Et<ze.isFauxFacade.length;Et++)if(ze.isFauxFacade[Et]){let Dn=1|Math.min(65535,Math.floor(ze.uv[2*Et]*_t.outerRingLength)),Kn=Math.floor(255*je)<<8|Math.floor(255*$e),Nt=Math.floor(65535*Math.min(1,nt/rt)),bn=Math.floor(65535*Math.min(1,Ye/rt));ft.layoutFacadeDataArray.emplaceBack(Dn,Kn,Nt,bn);let Jn=Math.floor(65535*Math.min(1,Ue/rt)),zn=Math.floor(65535*Math.min(1,Xe/rt));ft.layoutFacadeVerticalRangeArray.emplaceBack(Jn,zn)}else ft.layoutFacadeDataArray.emplaceBack(0,0,0,0),ft.layoutFacadeVerticalRangeArray.emplaceBack(0,0)}let Ft=at.vertexLength;for(let Et=0;Et<ze.indices.length;Et+=3)ft.indexArray.emplaceBack(Ft+ze.indices[Et],Ft+ze.indices[Et+1],Ft+ze.indices[Et+2]);at.vertexLength+=ze.positions.length/3,at.primitiveLength+=ze.indices.length/3,(ze.buildingPart==="roof"||ze.buildingPart==="wall"||ze.buildingPart==="facade_glazing"||ze.buildingPart==="entrance")&&Gt.push({part:ze.buildingPart,vertexOffset:lt,vertexLength:ze.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,Yt),this.buildingFeatures.push({promoteId:I,feature:O,hasFauxFacade:ke,segment:at,parts:Gt,buildingBloom:ut});let Cn=ft.indexArray.length-En,An=[],Ii=[],oe=new Ze(1/0,1/0),te=new Ze(-1/0,-1/0),Ne=this.groundEffect.vertexArray.length;for(let ze of _t.modifiedPolygonRings){let lt=[],Dt=new Ze(1/0,1/0),It=new Ze(-1/0,-1/0);for(let Jt=0;Jt<ze.length;Jt+=2){let Ft=ze.length-Jt-2;Dt.x=Math.min(Dt.x,ze[Ft]),Dt.y=Math.min(Dt.y,ze[Ft+1]),It.x=Math.max(It.x,ze[Ft]),It.y=Math.max(It.y,ze[Ft+1]);let Et=new Ze(ze[Ft],ze[Ft+1]);lt.push(Et),An.push(Et.x,Et.y),Ii.push(Et.clone())}oe.x=Math.min(oe.x,Dt.x),oe.y=Math.min(oe.y,Dt.y),te.x=Math.max(te.x,It.x),te.y=Math.max(te.y,It.y),this.groundEffect.addData(lt,[Dt,It],de)}let st=this.groundEffect.vertexArray.length-Ne;for(let ze=0;ze<st;ze++)this.groundEffect.groundRadiusArray.emplaceBack(le);(Ae.x<0||qe.x>rt||Ae.y<0||qe.y>rt)&&this.featuresOnBorder.push({featureId:w.id,footprintIndex:this.footprints.length});{let ze=pp(An,null,2),lt=new D0(Ii,ze,8,256),Dt=w.id;w.properties&&w.properties.hasOwnProperty("building_id")&&(Dt=w.properties.building_id);let It={vertices:Ii,indices:ze,grid:lt,min:oe,max:te,buildingId:Dt,hiddenFlags:0,indicesOffset:En,indicesLength:Cn,bloomIndicesOffset:Mt,bloomIndicesLength:Zt,groundEffectVertexOffset:Ne,groundEffectVertexLength:st,hasFauxFacade:ke,segment:at,height:Yt};w.id!==void 0&&this.featureFootprintLookup.set(w.id,this.footprints.length),this.footprints.push(It)}this.programConfigurations.populatePaintArrays(ft.layoutVertexArray.length,w,S,{},n.availableImages,a,n.brightness),this.groundEffect.addPaintPropertiesData(w,S,{},n.availableImages,a,n.brightness),n.featureIndex.insert(w,N,S,D,this.index,an)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0],{})}update(e,n,a,u,p,m,_){this.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_),this.groundEffect.update(e,n,p,a,u,m,_),this.evaluate(this.layers[0],e),this.colorBufferUploaded=!1}isEmpty(){return this.buildingWithoutFacade.layoutVertexArray.length===0&&this.buildingWithFacade.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){let n=a=>{a.layoutVertexBuffer=e.createVertexBuffer(a.layoutVertexArray,RM.members),a.layoutNormalBuffer=e.createVertexBuffer(a.layoutNormalArray,OB.members),a.layoutCentroidBuffer=e.createVertexBuffer(a.layoutCentroidArray,LB.members),a.layoutFloodLightDataBuffer=e.createVertexBuffer(a.layoutFloodLightDataArray,BB.members),a.layoutFacadeDataArray&&a.layoutFacadeDataArray.length&&(a.layoutFacadeDataBuffer=e.createVertexBuffer(a.layoutFacadeDataArray,kB.members)),a.layoutFacadeVerticalRangeArray&&a.layoutFacadeVerticalRangeArray.length&&(a.layoutFacadeVerticalRangeBuffer=e.createVertexBuffer(a.layoutFacadeVerticalRangeArray,NB.members)),a.entranceBloom.layoutVertexArray.length&&(a.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(a.entranceBloom.layoutVertexArray,RM.members),a.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(a.entranceBloom.layoutAttenuationArray,zB.members)),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e)};this.uploaded||(n(this.buildingWithoutFacade),n(this.buildingWithFacade),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){let e=n=>{n.layoutVertexBuffer&&(n.layoutVertexBuffer.destroy(),n.layoutNormalBuffer.destroy(),n.layoutColorBuffer.destroy(),n.segmentsBucket.destroy(),n.indexBuffer&&n.indexBuffer.destroy(),n.entranceBloom.layoutVertexBuffer&&(n.entranceBloom.layoutVertexBuffer.destroy(),n.entranceBloom.layoutColorBuffer.destroy(),n.entranceBloom.layoutAttenuationBuffer.destroy(),n.entranceBloom.indexBuffer.destroy(),n.entranceBloom.segmentsBucket.destroy()))};e(this.buildingWithoutFacade),e(this.buildingWithFacade),this.groundEffect.destroy(),this.programConfigurations.destroy()}updateFootprintHiddenFlags(e,n,a=!0){let u=!1,p=a?n:0,m=0|(a?-1:~n);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let _ of e){let b=this.footprints[_],w=b.hiddenFlags&m|p;b.hiddenFlags!==w&&(b.hiddenFlags=w,u=!0,this.groundEffect.updateHiddenByLandmarkRange(b.groundEffectVertexOffset,b.groundEffectVertexLength,b.hiddenFlags!==0))}return u&&(this.indexArrayForConflationUploaded=!1),u}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),this.indexArrayForConflationUploaded)return;let n=u=>{u.indexArray.length!==0&&(u.indexArrayForConflation.resize(u.indexArray.length),u.indexArrayForConflation.uint16.set(u.indexArray.uint16),u.entranceBloom.indexArrayForConflation.resize(u.entranceBloom.indexArray.length),u.entranceBloom.indexArrayForConflation.uint16.set(u.entranceBloom.indexArray.uint16))};n(this.buildingWithoutFacade),n(this.buildingWithFacade);for(let u of this.footprints){let p=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade,m=u.indicesOffset+u.indicesLength;if(u.hiddenFlags!==0){for(let b=u.indicesOffset;b<m;b++)p.indexArrayForConflation.uint16[3*b+0]=0,p.indexArrayForConflation.uint16[3*b+1]=0,p.indexArrayForConflation.uint16[3*b+2]=0;let _=u.bloomIndicesOffset+u.bloomIndicesLength;for(let b=u.bloomIndicesOffset;b<_;b++)p.entranceBloom.indexArrayForConflation.uint16[3*b+0]=0,p.entranceBloom.indexArrayForConflation.uint16[3*b+1]=0,p.entranceBloom.indexArrayForConflation.uint16[3*b+2]=0}}let a=u=>{u.indexArray.length!==0&&(u.indexBuffer?u.indexBuffer.updateData(u.indexArrayForConflation):u.indexBuffer=e.createIndexBuffer(u.indexArrayForConflation,!0),u.entranceBloom.indexBuffer?u.entranceBloom.indexBuffer.updateData(u.entranceBloom.indexArrayForConflation):u.entranceBloom.indexBuffer=e.createIndexBuffer(u.entranceBloom.indexArrayForConflation,!0))};a(this.buildingWithoutFacade),a(this.buildingWithFacade),this.indexArrayForConflationUploaded=!0}uploadUpdatedColorBuffer(e){let n=a=>{a.layoutColorBuffer?a.layoutColorBuffer.updateData(a.layoutColorArray):a.layoutColorBuffer=e.createVertexBuffer(a.layoutColorArray,PM.members,!0),a.layoutFacadePaintArray&&(a.layoutFacadePaintBuffer?a.layoutFacadePaintBuffer.updateData(a.layoutFacadePaintArray):a.layoutFacadePaintBuffer=e.createVertexBuffer(a.layoutFacadePaintArray,FB.members,!0)),a.entranceBloom.layoutColorBuffer?a.entranceBloom.layoutColorBuffer.updateData(a.entranceBloom.layoutColorArray):a.entranceBloom.layoutColorBuffer=e.createVertexBuffer(a.entranceBloom.layoutColorArray,PM.members,!0)};n(this.buildingWithoutFacade),n(this.buildingWithFacade),this.colorBufferUploaded=!0}evaluate(e,n){let a=e.paint.get("building-ambient-occlusion-intensity");for(let u of this.buildingFeatures){let p=n[u.promoteId],m=u.feature;m.properties["building-part"]="roof";let _=e.paint.get("building-color").evaluate(m,p,this.canonical).toPremultipliedRenderColor(this.lut),b=e.paint.get("building-emissive-strength").evaluate(m,p,this.canonical);m.properties["building-part"]="wall";let w=e.paint.get("building-color").evaluate(m,p,this.canonical).toPremultipliedRenderColor(this.lut),I=e.paint.get("building-emissive-strength").evaluate(m,p,this.canonical);m.properties["building-part"]="window";let S=e.paint.get("building-color").evaluate(m,p,this.canonical).toPremultipliedRenderColor(this.lut),D=e.paint.get("building-emissive-strength").evaluate(m,p,this.canonical);m.properties["building-part"]="door";let P=e.paint.get("building-color").evaluate(m,p,this.canonical).toPremultipliedRenderColor(this.lut),O=e.paint.get("building-emissive-strength").evaluate(m,p,this.canonical),N=u.hasFauxFacade?this.buildingWithFacade:this.buildingWithoutFacade;for(let U of u.parts){let W,X=_;U.part==="roof"?(X=_,W=b):U.part==="wall"?(X=w,W=I):U.part==="facade_glazing"?(X=S,W=D):U.part==="entrance"&&(X=P,W=O),W=G(W,0,1);for(let K=0;K<U.vertexLength;K++){let le=U.vertexOffset+K,re=1+(N.layoutAOArray.float32[le]-1)*a;N.layoutColorArray.emplace(le,X.r*re*255<<8|X.g*re*255,X.b*re*255<<8|255*W),u.hasFauxFacade&&N.layoutFacadePaintArray.emplace(le,255*S.r<<8|255*S.g,255*S.b<<8|255*D)}}let V=u.buildingBloom;if(V)for(let U=0;U<V.vertexLength;U++)N.entranceBloom.layoutColorArray.emplace(V.vertexOffset+U,255*P.r<<8|255*P.g,255*P.b<<8|51*O)}}needsEvaluation(){return!this.colorBufferUploaded}updateReplacement(e,n,a){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let u=n.getReplacementRegionsForTile(e.toUnwrapped());if(A0(this.activeReplacements,u))return;this.activeReplacements=u;for(let m of this.footprints)m.hiddenFlags&=-2;let p=[];for(let m of this.activeReplacements){if(m.order<=kA)continue;let _=Math.max(1,Math.pow(2,m.footprintTileId.canonical.z-e.canonical.z));for(let b of this.footprints)b.min.x>m.max.x||b.max.x<m.min.x||b.min.y>m.max.y||b.max.y<m.min.y||(p.length=0,jB(b.vertices,0,b.vertices.length,m.footprintTileId.canonical,e.canonical,p),TE(m.footprint,p,b.indices,0,b.indices.length,0,-_)&&(b.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(let m of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(m.groundEffectVertexOffset,m.groundEffectVertexLength,m.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getFootprint(e){if(e.id!==void 0){let n=this.featureFootprintLookup.get(e.id);return this.footprints[n]}return null}getHeightAtTileCoord(e,n){let a=Number.NEGATIVE_INFINITY,u=!0,p=4*(e+rt)*rt+(n+rt);if(this.footprintLookup.hasOwnProperty(p)){let _=this.footprintLookup[p];return _?{height:_.height,hidden:_.hiddenFlags!==0}:void 0}let m=new Ze(e,n);for(let _ of this.footprints)e>_.max.x||_.min.x>e||n>_.max.y||_.min.y>n||_.height<=a||IE(m,_)&&(a=_.height,this.footprintLookup[p]=_,u=_.hiddenFlags!==0);if(a!==Number.NEGATIVE_INFINITY)return{height:a,hidden:u};this.footprintLookup[p]=void 0}}function jB(r,e,n,a,u,p){let m=Math.pow(2,a.z-u.z);for(let _=0;_<n;_++){let b=r[_+e].x,w=r[_+e].y;b=(b+u.x*rt)*m-a.x*rt,w=(w+u.y*rt)*m-a.y*rt,p.push(new Ze(b,w))}}let kM,NM;vt(FM,"BuildingBucket",{omit:["layers"]}),vt($E,"BuildingGeometry"),vt(LM,"BuildingBloomGeometry");let UB=hn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),HB=hn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:$B}=UB,GB=hn([{name:"a_packed",components:3,type:"Float32"}]),{members:qB}=GB,WB=hn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:ZB}=WB;class zM{constructor(e,n){this.width=e,this.height=n,this.nextRow=0,this.image=new Pu({width:e,height:n}),this.positions={},this.uploaded=!1}getDash(e,n){let a=this.getKey(e,n);return this.positions[a]}trim(){let e=this.width,n=this.height=xe(this.nextRow);this.image.resize({width:e,height:n})}getKey(e,n){return e.join(",")+n}getDashRanges(e,n,a){let u=[],p=e.length%2==1?-e[e.length-1]*a:0,m=e[0]*a,_=!0;u.push({left:p,right:m,isDash:_,zeroLength:e[0]===0});let b=e[0];for(let w=1;w<e.length;w++){_=!_;let I=e[w];p=b*a,b+=I,m=b*a,u.push({left:p,right:m,isDash:_,zeroLength:I===0})}return u}addRoundDash(e,n,a){let u=n/2;for(let p=-a;p<=a;p++){let m=this.width*(this.nextRow+a+p),_=0,b=e[_];for(let w=0;w<this.width;w++){w/b.right>1&&(b=e[++_]);let I=Math.abs(w-b.left),S=Math.abs(w-b.right),D=Math.min(I,S),P,O=p/a*(u+1);if(b.isDash){let N=u-Math.abs(O);P=Math.sqrt(D*D+N*N)}else P=u-Math.sqrt(D*D+O*O);this.image.data[m+w]=Math.max(0,Math.min(255,P+128))}}}addRegularDash(e,n){for(let b=e.length-1;b>=0;--b){let w=e[b],I=e[b+1];w.zeroLength?e.splice(b,1):I&&I.isDash===w.isDash&&(I.left=w.left,e.splice(b,1))}let a=e[0],u=e[e.length-1];a.isDash===u.isDash&&(a.left=u.left-this.width,u.right=a.right+this.width);let p=this.width*this.nextRow,m=0,_=e[m];for(let b=0;b<this.width;b++){b/_.right>1&&(_=e[++m]);let w=Math.abs(b-_.left),I=Math.abs(b-_.right),S=Math.min(w,I);this.image.data[p+b]=Math.max(0,Math.min(255,(_.isDash?S:-S)+n+128))}}addDash(e,n){let a=this.getKey(e,n);if(this.positions[a])return this.positions[a];let u=n==="round",p=u?7:0,m=2*p+1;if(this.nextRow+m>this.height)return Rt("LineAtlas out of space"),null;e.length===0&&e.push(1);let _=0;for(let I=0;I<e.length;I++)e[I]<0&&(Rt("Negative value is found in line dasharray, replacing values with 0"),e[I]=0),_+=e[I];if(_!==0){let I=this.width/_,S=this.getDashRanges(e,this.width,I);u?this.addRoundDash(S,I,p):this.addRegularDash(S,n==="square"?.5*I:0)}let b=this.nextRow+p;this.nextRow+=m;let w={tl:[b,p],br:[_,0]};return this.positions[a]=w,w}}vt(zM,"LineAtlas");let XB=Ge.types,YB=Math.cos(Math.PI/180*37.5),KB=Math.cos(Math.PI/180*5);class GE{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(n=>{this.gradients[n.id]={}}),this.layoutVertexArray=new ep,this.layoutVertexArray2=new Jo,this.patternVertexArray=new Jo,this.indexArray=new wi,this.programConfigurations=new Gs(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new Ci,this.maxLineLength=0,this.zOffsetVertexArray=new Jo,this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:rt/64,this.worldview=e.worldview,this.hasAppearances=null}updateFootprints(e,n){}updateAppearances(e,n,a,u){}populate(e,n,a,u){this.hasPattern=yE("line",this.layers,this.pixelRatio,n);let p=this.layers[0].layout.get("line-sort-key");this.tileToMeter=ue(a);let m=this.layers[0].layout.get("line-elevation-reference");if(m==="hd-road-markup")this.elevationType="road";else{let D=this.layers[0].layout.get("line-z-offset"),P=D.isConstant()&&!D.constantOr(0);this.elevationType=m!=="sea"&&m!=="ground"&&P?"none":"offset",this.elevationType==="offset"&&m==="none"&&Rt(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}let _=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&_!==void 0;let b=[];for(let{feature:D,id:P,index:O,sourceLayerIndex:N}of e){let V=this.layers[0]._featureFilter.needGeometry,U=De(D,V);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),U,a))continue;let W=p?p.evaluate(U,{},a):void 0,X={id:P,properties:D.properties,type:D.type,sourceLayerIndex:N,index:O,geometry:V?U.geometry:Ve(D,a,u),patterns:{},sortKey:W};b.push(X)}p&&b.sort((D,P)=>D.sortKey-P.sortKey);let{lineAtlas:w,featureIndex:I}=n,S=this.addConstantDashes(w);for(let D of b){let{geometry:P,index:O,sourceLayerIndex:N}=D;if(S&&this.addFeatureDashes(D,w),this.hasPattern){let V=vE("line",this.layers,D,this.zoom,this.pixelRatio,n);this.patternFeatures.push(V)}else this.addFeature(D,P,O,a,w.positions,n.availableImages,n.brightness,n.elevationFeatures);I.insert(e[O].feature,P,O,N,this.index)}}addConstantDashes(e){let n=!1;for(let a of this.layers){let u=a.paint.get("line-dasharray").value,p=a.layout.get("line-cap").value;if(u.kind!=="constant"||p.kind!=="constant")n=!0;else{let m=p.value,_=u.value;if(!_)continue;e.addDash(_,m)}}return n}addFeatureDashes(e,n){let a=this.zoom;for(let u of this.layers){let p=u.paint.get("line-dasharray").value,m=u.layout.get("line-cap").value;if(p.kind==="constant"&&m.kind==="constant")continue;let _,b;if(p.kind==="constant"){if(_=p.value,!_)continue}else _=p.evaluate({zoom:a},e);b=m.kind==="constant"?m.value:m.evaluate({zoom:a},e),n.addDash(_,b),e.patterns[u.id]=[n.getKey(_,b)]}}update(e,n,a,u,p,m,_,b){this.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_,b)}addFeatures(e,n,a,u,p,m){for(let _ of this.patternFeatures)this.addFeature(_,_.geometry,_.index,n,a,u,m)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,qB)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,ZB)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,HB.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,$B),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e,n){let a,u;if(n&&n>0?(a=`mapbox_clip_start_${n}`,u=`mapbox_clip_end_${n}`):(a="mapbox_clip_start",u="mapbox_clip_end"),e.properties&&e.properties.hasOwnProperty(a)&&e.properties.hasOwnProperty(u))return{start:+e.properties[a],end:+e.properties[u]}}addFeature(e,n,a,u,p,m,_,b){let w=this.layers[0].layout,I=w.get("line-join").evaluate(e,{}),S=w.get("line-cap").evaluate(e,{}),D=w.get("line-miter-limit"),P=w.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e;let O=!(!e.properties||!e.properties.hasOwnProperty("mapbox_line_metrics"))&&e.properties.mapbox_line_metrics;this.zOffsetValue=w.get("line-z-offset").value;let N=this.layers[0].paint.get("line-width").value;if(N.kind!=="constant"&&N.isLineProgressConstant===!1&&(this.variableWidthValue=N),this.elevationType==="road"){let V=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,n,u,b,I,S,D,P)){let[U,W]=this.clipRuntimeLinesToTile(n,1);for(let X=0;X<U.length;X++){let K=U[X],le=W[X],re={progress:{min:le.progress.min,max:le.progress.max},nextDir:this.computeSegNextDir(le,K),prevDir:this.computeSegPrevDir(le,K)};this.addLine(K,e,u,I,S,D,P,re,O&&le.parentIndex>0?le.parentIndex:null)}this.fillNonElevatedRoadSegment(V)}}else for(let V=0;V<n.length;V++)this.addLine(n[V],e,u,I,S,D,P,void 0,O&&V>0?V:null);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,a,p,m,u,_,void 0,this.worldview)}computeSegNextDir(e,n){return e.nextPoint.sub(n.at(-2)).unit()}computeSegPrevDir(e,n){return n[1].sub(e.prevPoint).unit()}clipLinesToTile(e,n){return P0(e,-n,-n,rt+n,rt+n)}clipRuntimeLinesToTile(e,n){let a=[];return[P0(e,-n,-n,rt+n,rt+n,a),a]}addElevatedRoadFeature(e,n,a,u,p,m,_,b){let w=[],I=$t.getElevationFeature(e,u);if(I){let S=this.clipLinesToTile(n,1),D=this.prepareElevatedLines(S,I,a);for(let P of D)w.push({geometry:P,elevation:I,elevationTileID:a,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(w.length===0)return!1;for(let S of w){let D=this.layoutVertexArray.length;this.addLine(S.geometry,e,a,p,m,_,b);let P=new wn(a,S.elevationTileID);if(S.elevation)for(let O=D;O<this.layoutVertexArray.length;O++){let N=new Ze(this.layoutVertexArray.int16[6*O]>>1,this.layoutVertexArray.int16[6*O+1]>>1),V=P.pointElevation(N,S.elevation,.05);this.updateHeightRange(V),this.zOffsetVertexArray.emplaceBack(V,0,0)}else this.fillNonElevatedRoadSegment(D)}return!0}prepareElevatedLines(e,n,a){if(n.constantHeight!=null)return e;let u=[],p=1/ue(a);for(let m of e)cB(m,new ui(n,p),0,u);return u}fillNonElevatedRoadSegment(e){for(let n=e;n<this.layoutVertexArray.length;n++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,n,a,u,p,m,_,b,w){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0,this.lineClips=w?this.lineFeatureClips(n,w):this.lineClips;let I=u==="none";this.patternJoinNone=this.hasPattern&&I,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];let S=b&&b.progress.min>0,D=b&&b.progress.max<1;if(this.lineClips){let ge={min:this.lineClips.start,max:this.lineClips.end},Le=1;if(b){let je=this.lineClips.end-this.lineClips.start;ge=(function($e,nt,Ye){return{min:Yn($e.min,nt,Ye),max:Yn($e.max,nt,Ye)}})(b.progress,{min:0,max:1},ge),je>0&&(Le=(ge.max-ge.min)/je)}let Te=+n.properties.mapbox_clip_feature_len,ke=+n.properties.mapbox_clip_seg_len;if(Number.isNaN(Te)||Number.isNaN(ke)){for(let $e=0;$e<e.length-1;$e++)this.totalDistance+=e[$e].dist(e[$e+1]);let je=this.totalDistance/(ge.max-ge.min);this.totalFeatureLength=Number.isFinite(je)?je:0,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=Te,this.distance=ke*Le,this.lineClips.start=ge.min,this.lineClips.end=ge.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}let P=XB[n.type]==="Polygon",O=e.length;for(;O>=2&&e[O-1].equals(e[O-2]);)O--;let N=0;for(;N<O-1&&e[N].equals(e[N+1]);)N++;if(O<(P?3:2))return;u==="bevel"&&(m=1.05);let V=this.segments.prepareSegment(10*O,this.layoutVertexArray,this.indexArray),U,W,X,K,le,re,de,pe;b&&b.prevDir&&(re=b.prevDir.perp()),b&&b.nextDir&&(de=b.nextDir.perp()),this.e1=this.e2=-1,P&&(U=e[O-2],le=e[N].sub(U)._unit()._perp());for(let ge=N;ge<O;ge++){if(X=ge===O-1?P?e[N+1]:void 0:e[ge+1],X&&e[ge].equals(X))continue;le&&(K=le),U&&(W=U),U=e[ge],pe=this.evaluateLineProgressFeatures(W?W.dist(U):0),le=X?X.sub(U)._unit()._perp():K,K=K||le;let Le=W&&X,Te=Le?u:P||I?"butt":p,ke=K.x*le.x+K.y*le.y;if(I){let Ae=function(qe){if(qe.patternJoinNone){let Qe=qe.segmentPoints.length/2,He=qe.lineSoFar-qe.segmentStart;for(let _t=0;_t<Qe;++_t){let bt=qe.segmentPoints[2*_t+1],ft=Math.round(qe.segmentPoints[2*_t])+.5+.25*bt;qe.patternVertexArray.emplaceBack(ft,He,qe.segmentStart),qe.patternVertexArray.emplaceBack(ft,He,qe.segmentStart)}qe.segmentPoints.length=0}qe.e1=qe.e2=-1};if(Le&&ke<KB){this.updateDistance(W,U),this.addCurrentVertex(U,K,1,1,V,pe),Ae(this),this.addCurrentVertex(U,le,-1,-1,V,pe);continue}if(W){if(!X){this.updateDistance(W,U),this.addCurrentVertex(U,K,1,1,V,pe),Ae(this);continue}Te="miter"}}let je=K.add(le);je.x===0&&je.y===0||je._unit();let $e=je.x*le.x+je.y*le.y,nt=$e!==0?1/$e:1/0,Ye=2*Math.sqrt(2-2*$e),Ue=$e<YB&&W&&X,Xe=K.x*le.y-K.y*le.x>0,Re=this.overscaling<=16?15*rt/(512*this.overscaling):0;if(Le&&Te==="round"){if(nt<_)Te="miter";else if(nt<=2){let Ae=qE(U,-10,rt+10);Te=this.elevationType==="offset"&&(Ae||this.hasCrossSlope)?"miter":"fakeround"}}if(Te==="miter"&&nt>m&&(Te="bevel"),Te==="bevel"&&(nt>2&&(Te="flipbevel"),nt<m&&(Te="miter")),W&&!(Te==="miter"&&Ue)&&this.updateDistance(W,U),Te==="miter")if(Ue){let Ae=U.dist(W);if(Ae>2*Re){let Qe=U.sub(U.sub(W)._mult(Re/Ae)._round());this.updateDistance(W,Qe),this.addCurrentVertex(Qe,K,0,0,V,pe),W=Qe}this.updateDistance(W,U),je._mult(nt),this.addCurrentVertex(U,je,0,0,V,pe);let qe=U.dist(X);if(qe>2*Re){let Qe=U.add(X.sub(U)._mult(Re/qe)._round());this.updateDistance(U,Qe),this.addCurrentVertex(Qe,le,0,0,V,pe),U=Qe}}else je._mult(nt),this.addCurrentVertex(U,je,0,0,V,pe);else if(Te==="flipbevel"){if(nt>100)je=le.mult(-1);else{let Ae=nt*K.add(le).mag()/K.sub(le).mag();je._perp()._mult(Ae*(Xe?-1:1))}this.addCurrentVertex(U,je,0,0,V,pe),this.addCurrentVertex(U,je.mult(-1),0,0,V,pe)}else if(Te==="bevel"||Te==="fakeround"){pe!=null&&W&&this.addCurrentVertex(U,de||K,-1,-1,V,pe);let Ae=U.dist(W)<=2*Re&&Te!=="bevel",qe=je.mult(Xe?1:-1);qe._mult(nt);let Qe=le.mult(Xe?-1:1),He=K.mult(Xe?-1:1),_t=this.evaluateLineProgressFeatures(this.distance);if(pe==null&&(this.addHalfVertex(U,qe.x,qe.y,!1,!Xe,0,V,_t),Ae||this.addHalfVertex(U,qe.x+2*He.x,qe.y+2*He.y,!1,Xe,0,V,_t)),Te==="fakeround"){let bt=Math.round(180*Ye/Math.PI/20);this.addHalfVertex(U,He.x,He.y,!1,Xe,0,V,_t);for(let ft=0;ft<bt;ft++){let at=ft/bt;if(at!==.5){let ut=at-.5;at+=at*ut*(at-1)*((1.0904+ke*(ke*(3.55645-1.43519*ke)-3.2452))*ut*ut+(.848013+ke*(.215638*ke-1.06021)))}let Gt=Qe.sub(He)._mult(at)._add(He)._unit();this.addHalfVertex(U,Gt.x,Gt.y,!1,Xe,0,V,_t)}this.addHalfVertex(U,Qe.x,Qe.y,!1,Xe,0,V,_t)}Ae||pe!=null||this.addHalfVertex(U,qe.x+2*Qe.x,qe.y+2*Qe.y,!1,Xe,0,V,_t),pe!=null&&X&&this.addCurrentVertex(U,re||le,1,1,V,pe)}else if(Te==="butt")this.addCurrentVertex(U,je,0,0,V,pe);else if(Te==="square"){if(!W){let Ae=S?0:-1;this.addCurrentVertex(U,je,Ae,Ae,V,pe)}if(this.addCurrentVertex(U,je,0,0,V,pe),W){let Ae=D?0:1;this.addCurrentVertex(U,je,Ae,Ae,V,pe)}}else if(Te==="round"){if(W){let Ae=!Le&&de?de:K;this.addCurrentVertex(U,Ae,0,0,V,pe),!Le&&D||this.addCurrentVertex(U,Ae,1,1,V,pe,!0)}if(X){let Ae=!Le&&re?re:le;!Le&&S||this.addCurrentVertex(U,Ae,-1,-1,V,pe,!0),this.addCurrentVertex(U,Ae,0,0,V,pe)}}}}addVerticesTo(e,n,a,u,p,m,_,b,w,I){let S=(n.w-e.w)/this.tessellationStep|0,D=0,P=this.scaledDistance;if(S>1){this.lineSoFar=e.w;let N=(n.x-e.x)/S,V=(n.y-e.y)/S,U=(n.z-e.z)/S,W=(n.w-e.w)/S;for(let X=1;X<S;++X){e.x+=N,e.y+=V,e.z+=U,this.lineSoFar+=W,D+=W;let K=this.evaluateLineProgressFeatures(this.prevDistance+D);this.scaledDistance=(this.prevDistance+D)/this.totalDistance,this.addHalfVertex(e,a,u,I,!1,_,w,K),this.addHalfVertex(e,p,m,I,!0,-b,w,K)}}this.lineSoFar=n.w,this.scaledDistance=P;let O=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(n,a,u,I,!1,_,w,O),this.addHalfVertex(n,p,m,I,!0,-b,w,O)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):Rt(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let n=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(n=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:n}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:n}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:n}}addCurrentVertex(e,n,a,u,p,m,_=!1){let b=n.x+n.y*a,w=n.y-n.x*a,I=n.y*u-n.x,S=-n.y-n.x*u;if(m!=null){let D=this.elevationType==="offset",P=-10,O=rt+10,N=m.zOffset,V=new oM(e.x,e.y,N,this.lineSoFar),U=!!D&&qE(e,P,O),W=this.lineSoFar,X=this.distance;if(this.currentVertex)if(U){let K=this.currentVertexIsOutside,le=this.currentVertex,re=new oM(e.x,e.y,N,this.lineSoFar);if(aM(le,re,P,O),!qE(re,P,O)){if(K){this.e1=this.e2=-1,this.distance-=le.dist(V),this.lineSoFar=le.w;let de=this.evaluateLineProgressFeatures(le.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(le,b,w,_,!1,a,p,de),this.addHalfVertex(le,I,S,_,!0,-u,p,de),this.prevDistance=this.distance}this.distance=this.prevDistance+le.dist(re),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(le,re,b,w,I,S,a,u,p,_),this.distance=X,this.scaledDistance=this.distance/this.totalDistance}}else{let K=this.currentVertex;if(this.currentVertexIsOutside){aM(K,V,P,O),this.e1=this.e2=-1,this.distance-=K.dist(V),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=K.w;let le=this.evaluateLineProgressFeatures(K.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(K,b,w,_,!1,a,p,le),this.addHalfVertex(K,I,S,_,!0,-u,p,le),this.prevDistance=this.distance,this.distance=X,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(K,V,b,w,I,S,a,u,p,_)}else U||(this.addHalfVertex(e,b,w,_,!1,a,p,m),this.addHalfVertex(e,I,S,_,!0,-u,p,m));this.currentVertex=V,this.currentVertexIsOutside=U,this.lineSoFar=W}else this.addHalfVertex(e,b,w,_,!1,a,p,m),this.addHalfVertex(e,I,S,_,!0,-u,p,m)}addHalfVertex({x:e,y:n},a,u,p,m,_,b,w){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),m||this.segmentPoints.push(this.lineSoFar-this.segmentStart,_)),this.layoutVertexArray.emplaceBack((e<<1)+(p?1:0),(n<<1)+(m?1:0),Math.round(63*a)+128,Math.round(63*u)+128,1+(_===0?0:_<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let S=zt(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,S)}let I=b.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,I),b.primitiveLength++),m?this.e2=I:this.e1=I,w!=null&&this.zOffsetVertexArray.emplaceBack(w.zOffset,w.variableWidth,w.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,n){this.prevDistance=this.distance,this.distance+=e.dist(n),this.updateScaledDistance()}}function qE(r,e,n){return r.x<e||r.x>n||r.y<e||r.y>n}let BM,VM;function jM(r,e,n){return e*(rt/(r.tileSize*Math.pow(2,n-r.tileID.overscaledZ)))}vt(GE,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let UM=(r,e,n)=>(1-n)*r+n*e;function HM(r,e){return 1/jM(r,1,e.tileZoom)}function $M(r,e,n,a){return r.translatePosMatrix(a||e.tileID.projMatrix,e,n.paint.get("line-translate"),n.paint.get("line-translate-anchor"))}let GM=r=>{let e=[];qM(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");let n=r.paint.get("line-trim-offset");n[0]===0&&n[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),r.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");let a=r.layout.get("line-join").constantOr("miter")==="none",u=!!r.paint.get("line-pattern").constantOr(1);return a&&u&&e.push("LINE_JOIN_NONE"),e};function qM(r){let e=r.paint.get("line-dasharray").value;return e.kind!=="constant"||e.value}let WE,WM=()=>WE||(WE={layout:BM||(BM=new zi({"line-cap":new dt(Ee.layout_line["line-cap"]),"line-join":new dt(Ee.layout_line["line-join"]),"line-miter-limit":new Ke(Ee.layout_line["line-miter-limit"]),"line-round-limit":new Ke(Ee.layout_line["line-round-limit"]),"line-sort-key":new dt(Ee.layout_line["line-sort-key"]),"line-z-offset":new dt(Ee.layout_line["line-z-offset"]),"line-elevation-reference":new Ke(Ee.layout_line["line-elevation-reference"]),"line-cross-slope":new Ke(Ee.layout_line["line-cross-slope"]),visibility:new Ke(Ee.layout_line.visibility),"line-width-unit":new Ke(Ee.layout_line["line-width-unit"])})),paint:VM||(VM=new zi({"line-opacity":new dt(Ee.paint_line["line-opacity"]),"line-color":new dt(Ee.paint_line["line-color"]),"line-translate":new Ke(Ee.paint_line["line-translate"]),"line-translate-anchor":new Ke(Ee.paint_line["line-translate-anchor"]),"line-width":new dt(Ee.paint_line["line-width"]),"line-gap-width":new dt(Ee.paint_line["line-gap-width"]),"line-offset":new dt(Ee.paint_line["line-offset"]),"line-blur":new dt(Ee.paint_line["line-blur"]),"line-dasharray":new dt(Ee.paint_line["line-dasharray"]),"line-pattern":new dt(Ee.paint_line["line-pattern"]),"line-pattern-cross-fade":new Ke(Ee.paint_line["line-pattern-cross-fade"]),"line-gradient":new gu(Ee.paint_line["line-gradient"]),"line-trim-offset":new Ke(Ee.paint_line["line-trim-offset"]),"line-trim-fade-range":new Ke(Ee.paint_line["line-trim-fade-range"]),"line-trim-color":new Ke(Ee.paint_line["line-trim-color"]),"line-emissive-strength":new Ke(Ee.paint_line["line-emissive-strength"]),"line-border-width":new dt(Ee.paint_line["line-border-width"]),"line-border-color":new dt(Ee.paint_line["line-border-color"]),"line-occlusion-opacity":new Ke(Ee.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},WE);class JB extends dt{possiblyEvaluate(e,n){return n=new ci(Math.floor(n.zoom),{now:n.now,fadeDuration:n.fadeDuration,transition:n.transition,worldview:n.worldview}),super.possiblyEvaluate(e,n)}evaluate(e,n,a,u){return n=Object.assign({},n,{zoom:Math.floor(n.zoom)}),super.evaluate(e,n,a,u)}}let S_;function ZM(r,e){return e>0?e+2*r:r}let QB=hn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),e3=hn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),t3=hn([{name:"a_projected_pos",components:4,type:"Float32"}],4);hn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let n3=hn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),i3=hn([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),r3=hn([{name:"a_texb",components:2,type:"Uint16"}]),o3=hn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),s3=hn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);hn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let XM=hn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),a3=hn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);hn([{name:"triangle",components:3,type:"Uint16"}]),hn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),hn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),hn([{type:"Float32",name:"offsetX"}]),hn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Nr=24;function l3(r,e,n){return r.sections.forEach(a=>{a.text=(function(u,p,m){let _=p.layout.get("text-transform").evaluate(m,{});return _==="uppercase"?u=u.toLocaleUpperCase():_==="lowercase"&&(u=u.toLocaleLowerCase()),No.applyArabicShaping&&(u=No.applyArabicShaping(u)),u})(a.text,e,n)}),r}let D_={"!":"\uFE15","#":"\uFF03",$:"\uFF04","%":"\uFF05","&":"\uFF06","(":"\uFE35",")":"\uFE36","*":"\uFF0A","+":"\uFF0B",",":"\uFE10","-":"\uFE32",".":"\u30FB","/":"\uFF0F",":":"\uFE13",";":"\uFE14","<":"\uFE3F","=":"\uFF1D",">":"\uFE40","?":"\uFE16","@":"\uFF20","[":"\uFE47","\\":"\uFF3C","]":"\uFE48","^":"\uFF3E",_:"\uFE33","`":"\uFF40","{":"\uFE37","|":"\u2015","}":"\uFE38","~":"\uFF5E","\xA2":"\uFFE0","\xA3":"\uFFE1","\xA5":"\uFFE5","\xA6":"\uFFE4","\xAC":"\uFFE2","\xAF":"\uFFE3","\u2013":"\uFE32","\u2014":"\uFE31","\u2018":"\uFE43","\u2019":"\uFE44","\u201C":"\uFE41","\u201D":"\uFE42","\u2026":"\uFE19","\u2027":"\u30FB","\u20A9":"\uFFE6","\u3001":"\uFE11","\u3002":"\uFE12","\u3008":"\uFE3F","\u3009":"\uFE40","\u300A":"\uFE3D","\u300B":"\uFE3E","\u300C":"\uFE41","\u300D":"\uFE42","\u300E":"\uFE43","\u300F":"\uFE44","\u3010":"\uFE3B","\u3011":"\uFE3C","\u3014":"\uFE39","\u3015":"\uFE3A","\u3016":"\uFE17","\u3017":"\uFE18","\uFF01":"\uFE15","\uFF08":"\uFE35","\uFF09":"\uFE36","\uFF0C":"\uFE10","\uFF0D":"\uFE32","\uFF0E":"\u30FB","\uFF1A":"\uFE13","\uFF1B":"\uFE14","\uFF1C":"\uFE3F","\uFF1E":"\uFE40","\uFF1F":"\uFE16","\uFF3B":"\uFE47","\uFF3D":"\uFE48","\uFF3F":"\uFE33","\uFF5B":"\uFE37","\uFF5C":"\u2015","\uFF5D":"\uFE38","\uFF5F":"\uFE35","\uFF60":"\uFE36","\uFF61":"\uFE12","\uFF62":"\uFE41","\uFF63":"\uFE42","\u2190":"\u2191","\u2192":"\u2193"};function c3(r){return r==="\uFE36"||r==="\uFE48"||r==="\uFE38"||r==="\uFE44"||r==="\uFE42"||r==="\uFE3E"||r==="\uFE3C"||r==="\uFE3A"||r==="\uFE18"||r==="\uFE40"||r==="\uFE10"||r==="\uFE13"||r==="\uFE14"||r==="\uFF40"||r==="\uFFE3"||r==="\uFE11"||r==="\uFE12"}function u3(r){return r==="\uFE35"||r==="\uFE47"||r==="\uFE37"||r==="\uFE43"||r==="\uFE41"||r==="\uFE3D"||r==="\uFE3B"||r==="\uFE39"||r==="\uFE17"||r==="\uFE3F"}let ZE=4294967296,YM=1/ZE,KM=typeof TextDecoder>"u"?null:new TextDecoder("utf-8"),$0=class{constructor(r=new Uint8Array(16)){this.buf=ArrayBuffer.isView(r)?r:new Uint8Array(r),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(r,e,n=this.length){for(;this.pos<n;){let a=this.readVarint(),u=a>>3,p=this.pos;this.type=7&a,r(u,e,this),this.pos===p&&this.skip(a)}return e}readMessage(r,e){return this.readFields(r,e,this.readVarint()+this.pos)}readFixed32(){let r=this.dataView.getUint32(this.pos,!0);return this.pos+=4,r}readSFixed32(){let r=this.dataView.getInt32(this.pos,!0);return this.pos+=4,r}readFixed64(){let r=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*ZE;return this.pos+=8,r}readSFixed64(){let r=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*ZE;return this.pos+=8,r}readFloat(){let r=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,r}readDouble(){let r=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,r}readVarint(r){let e=this.buf,n,a;return a=e[this.pos++],n=127&a,a<128?n:(a=e[this.pos++],n|=(127&a)<<7,a<128?n:(a=e[this.pos++],n|=(127&a)<<14,a<128?n:(a=e[this.pos++],n|=(127&a)<<21,a<128?n:(a=e[this.pos],n|=(15&a)<<28,(function(u,p,m){let _=m.buf,b,w;if(w=_[m.pos++],b=(112&w)>>4,w<128||(w=_[m.pos++],b|=(127&w)<<3,w<128)||(w=_[m.pos++],b|=(127&w)<<10,w<128)||(w=_[m.pos++],b|=(127&w)<<17,w<128)||(w=_[m.pos++],b|=(127&w)<<24,w<128)||(w=_[m.pos++],b|=(1&w)<<31,w<128))return bp(u,b,p);throw new Error("Expected varint not more than 10 bytes")})(n,r,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){let r=this.readVarint();return r%2==1?(r+1)/-2:r/2}readBoolean(){return!!this.readVarint()}readString(){let r=this.readVarint()+this.pos,e=this.pos;return this.pos=r,r-e>=12&&KM?KM.decode(this.buf.subarray(e,r)):(function(n,a,u){let p="",m=a;for(;m<u;){let _=n[m],b,w,I,S=null,D=_>239?4:_>223?3:_>191?2:1;if(m+D>u)break;D===1?_<128&&(S=_):D===2?(b=n[m+1],(192&b)==128&&(S=(31&_)<<6|63&b,S<=127&&(S=null))):D===3?(b=n[m+1],w=n[m+2],(192&b)==128&&(192&w)==128&&(S=(15&_)<<12|(63&b)<<6|63&w,(S<=2047||S>=55296&&S<=57343)&&(S=null))):D===4&&(b=n[m+1],w=n[m+2],I=n[m+3],(192&b)==128&&(192&w)==128&&(192&I)==128&&(S=(15&_)<<18|(63&b)<<12|(63&w)<<6|63&I,(S<=65535||S>=1114112)&&(S=null))),S===null?(S=65533,D=1):S>65535&&(S-=65536,p+=String.fromCharCode(S>>>10&1023|55296),S=56320|1023&S),p+=String.fromCharCode(S),m+=D}return p})(this.buf,e,r)}readBytes(){let r=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,r);return this.pos=r,e}readPackedVarint(r=[],e){let n=this.readPackedEnd();for(;this.pos<n;)r.push(this.readVarint(e));return r}readPackedSVarint(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSVarint());return r}readPackedBoolean(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readBoolean());return r}readPackedFloat(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFloat());return r}readPackedDouble(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readDouble());return r}readPackedFixed32(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed32());return r}readPackedSFixed32(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed32());return r}readPackedFixed64(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readFixed64());return r}readPackedSFixed64(r=[]){let e=this.readPackedEnd();for(;this.pos<e;)r.push(this.readSFixed64());return r}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(r){let e=7&r;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(r,e){this.writeVarint(r<<3|e)}realloc(r){let e=this.length||16;for(;e<this.pos+r;)e*=2;if(e!==this.length){let n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.dataView=new DataView(n.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeSFixed32(r){this.realloc(4),this.dataView.setInt32(this.pos,r,!0),this.pos+=4}writeFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*YM),!0),this.pos+=8}writeSFixed64(r){this.realloc(8),this.dataView.setInt32(this.pos,-1&r,!0),this.dataView.setInt32(this.pos+4,Math.floor(r*YM),!0),this.pos+=8}writeVarint(r){(r=+r||0)>268435455||r<0?(function(e,n){let a,u;if(e>=0?(a=e%4294967296|0,u=e/4294967296|0):(a=~(-e%4294967296),u=~(-e/4294967296),4294967295^a?a=a+1|0:(a=0,u=u+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),(function(p,m,_){_.buf[_.pos++]=127&p|128,p>>>=7,_.buf[_.pos++]=127&p|128,p>>>=7,_.buf[_.pos++]=127&p|128,p>>>=7,_.buf[_.pos++]=127&p|128,_.buf[_.pos]=127&(p>>>=7)})(a,0,n),(function(p,m){let _=(7&p)<<4;m.buf[m.pos++]|=_|((p>>>=3)?128:0),p&&(m.buf[m.pos++]=127&p|((p>>>=7)?128:0),p&&(m.buf[m.pos++]=127&p|((p>>>=7)?128:0),p&&(m.buf[m.pos++]=127&p|((p>>>=7)?128:0),p&&(m.buf[m.pos++]=127&p|((p>>>=7)?128:0),p&&(m.buf[m.pos++]=127&p)))))})(u,n)})(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))}writeSVarint(r){this.writeVarint(r<0?2*-r-1:2*r)}writeBoolean(r){this.writeVarint(+r)}writeString(r){r=String(r),this.realloc(4*r.length),this.pos++;let e=this.pos;this.pos=(function(a,u,p){for(let m,_,b=0;b<u.length;b++){if(m=u.charCodeAt(b),m>55295&&m<57344){if(!_){m>56319||b+1===u.length?(a[p++]=239,a[p++]=191,a[p++]=189):_=m;continue}if(m<56320){a[p++]=239,a[p++]=191,a[p++]=189,_=m;continue}m=_-55296<<10|m-56320|65536,_=null}else _&&(a[p++]=239,a[p++]=191,a[p++]=189,_=null);m<128?a[p++]=m:(m<2048?a[p++]=m>>6|192:(m<65536?a[p++]=m>>12|224:(a[p++]=m>>18|240,a[p++]=m>>12&63|128),a[p++]=m>>6&63|128),a[p++]=63&m|128)}return p})(this.buf,r,this.pos);let n=this.pos-e;n>=128&&JM(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n}writeFloat(r){this.realloc(4),this.dataView.setFloat32(this.pos,r,!0),this.pos+=4}writeDouble(r){this.realloc(8),this.dataView.setFloat64(this.pos,r,!0),this.pos+=8}writeBytes(r){let e=r.length;this.writeVarint(e),this.realloc(e);for(let n=0;n<e;n++)this.buf[this.pos++]=r[n]}writeRawMessage(r,e){this.pos++;let n=this.pos;r(e,this);let a=this.pos-n;a>=128&&JM(n,a,this),this.pos=n-1,this.writeVarint(a),this.pos+=a}writeMessage(r,e,n){this.writeTag(r,2),this.writeRawMessage(e,n)}writePackedVarint(r,e){e.length&&this.writeMessage(r,d3,e)}writePackedSVarint(r,e){e.length&&this.writeMessage(r,h3,e)}writePackedBoolean(r,e){e.length&&this.writeMessage(r,m3,e)}writePackedFloat(r,e){e.length&&this.writeMessage(r,f3,e)}writePackedDouble(r,e){e.length&&this.writeMessage(r,p3,e)}writePackedFixed32(r,e){e.length&&this.writeMessage(r,g3,e)}writePackedSFixed32(r,e){e.length&&this.writeMessage(r,_3,e)}writePackedFixed64(r,e){e.length&&this.writeMessage(r,y3,e)}writePackedSFixed64(r,e){e.length&&this.writeMessage(r,v3,e)}writeBytesField(r,e){this.writeTag(r,2),this.writeBytes(e)}writeFixed32Field(r,e){this.writeTag(r,5),this.writeFixed32(e)}writeSFixed32Field(r,e){this.writeTag(r,5),this.writeSFixed32(e)}writeFixed64Field(r,e){this.writeTag(r,1),this.writeFixed64(e)}writeSFixed64Field(r,e){this.writeTag(r,1),this.writeSFixed64(e)}writeVarintField(r,e){this.writeTag(r,0),this.writeVarint(e)}writeSVarintField(r,e){this.writeTag(r,0),this.writeSVarint(e)}writeStringField(r,e){this.writeTag(r,2),this.writeString(e)}writeFloatField(r,e){this.writeTag(r,5),this.writeFloat(e)}writeDoubleField(r,e){this.writeTag(r,1),this.writeDouble(e)}writeBooleanField(r,e){this.writeVarintField(r,+e)}};function bp(r,e,n){return n?4294967296*e+(r>>>0):4294967296*(e>>>0)+(r>>>0)}function JM(r,e,n){let a=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));n.realloc(a);for(let u=n.pos-1;u>=r;u--)n.buf[u+a]=n.buf[u]}function d3(r,e){for(let n=0;n<r.length;n++)e.writeVarint(r[n])}function h3(r,e){for(let n=0;n<r.length;n++)e.writeSVarint(r[n])}function f3(r,e){for(let n=0;n<r.length;n++)e.writeFloat(r[n])}function p3(r,e){for(let n=0;n<r.length;n++)e.writeDouble(r[n])}function m3(r,e){for(let n=0;n<r.length;n++)e.writeBoolean(r[n])}function g3(r,e){for(let n=0;n<r.length;n++)e.writeFixed32(r[n])}function _3(r,e){for(let n=0;n<r.length;n++)e.writeSFixed32(r[n])}function y3(r,e){for(let n=0;n<r.length;n++)e.writeFixed64(r[n])}function v3(r,e){for(let n=0;n<r.length;n++)e.writeSFixed64(r[n])}let XE=3;function x3(r,e,n){e.glyphs=[],r===1&&n.readMessage(b3,e)}function b3(r,e,n){if(r===3){let{id:a,bitmap:u,width:p,height:m,left:_,top:b,advance:w}=n.readMessage(w3,{});e.glyphs.push({id:a,bitmap:new Pu({width:p+2*XE,height:m+2*XE},u),metrics:{width:p,height:m,left:_,top:b,advance:w}})}else r===4?e.ascender=n.readSVarint():r===5&&(e.descender=n.readSVarint())}function w3(r,e,n){r===1?e.id=n.readVarint():r===2?e.bitmap=n.readBytes():r===3?e.width=n.readVarint():r===4?e.height=n.readVarint():r===5?e.left=n.readSVarint():r===6?e.top=n.readSVarint():r===7&&(e.advance=n.readVarint())}let QM=XE,os={horizontal:1,vertical:2,horizontalOnly:3};class C_{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,n){let a=new C_;return a.scale=e||1,a.fontStack=n,a}static forImage(e){let n=new C_;return n.image=e,n}}class wp{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,n,a){let u=new wp;for(let p=0;p<e.sections.length;p++){let m=e.sections[p];m.image?u.addImageSection(m,a):u.addTextSection(m,n)}return u}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=(function(n,a){let u="";for(let p=0;p<n.length;p++){let m=n.charCodeAt(p+1)||null,_=n.charCodeAt(p-1)||null;u+=!a&&(m&&Pg(m)&&!D_[n[p+1]]||_&&Pg(_)&&!D_[n[p-1]])||!D_[n[p]]?n[p]:D_[n[p]]}return u})(this.text,e)}trim(){let e=0;for(let a=0;a<this.text.length&&G0[this.text.charCodeAt(a)];a++)e++;let n=this.text.length;for(let a=this.text.length-1;a>=0&&a>=e&&G0[this.text.charCodeAt(a)];a--)n--;this.text=this.text.substring(e,n),this.sectionIndex=this.sectionIndex.slice(e,n)}substring(e,n){let a=new wp;return a.text=this.text.substring(e,n),a.sectionIndex=this.sectionIndex.slice(e,n),a.sections=this.sections,a}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,n)=>Math.max(e,this.sections[n].scale),0)}addTextSection(e,n){this.text+=e.text,this.sections.push(C_.forText(e.scale,e.fontStack||n));let a=this.sections.length-1;for(let u=0;u<e.text.length;++u)this.sectionIndex.push(a)}addImageSection(e,n){let a=e.image?e.image.getPrimary():null;if(!a)return void Rt("Can't add FormattedSection with an empty image.");a.scaleSelf(n);let u=this.getNextImageSectionCharCode();u?(this.text+=String.fromCodePoint(u),this.sections.push(C_.forImage(a)),this.sectionIndex.push(this.sections.length-1)):Rt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function YE(r,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N=1){let V=wp.fromFeature(r,u,N);S===os.vertical&&V.verticalizePunctuation(D);let U=[],W=(function(de,pe,ge,Le,Te,ke){if(!de)return[];let je=[],$e=(function(Xe,Re,Ae,qe,Qe,He){let _t=0;for(let bt=0;bt<Xe.length();bt++){let ft=Xe.getSection(bt);_t+=eR(Xe.getCodePoint(bt),ft,qe,Qe,Re,He)}return _t/Math.max(1,Math.ceil(_t/Ae))})(de,pe,ge,Le,Te,ke),nt=de.text.indexOf("\u200B")>=0,Ye=0;for(let Xe=0;Xe<de.length();Xe++){let Re=de.getSection(Xe),Ae=de.getCodePoint(Xe);if(G0[Ae]||(Ye+=eR(Ae,Re,Le,Te,pe,ke)),Xe<de.length()-1){let qe=!((Ue=Ae)<11904||!(Pt["Bopomofo Extended"](Ue)||Pt.Bopomofo(Ue)||Pt["CJK Compatibility Forms"](Ue)||Pt["CJK Compatibility Ideographs"](Ue)||Pt["CJK Compatibility"](Ue)||Pt["CJK Radicals Supplement"](Ue)||Pt["CJK Strokes"](Ue)||Pt["CJK Symbols and Punctuation"](Ue)||Pt["CJK Unified Ideographs Extension A"](Ue)||Pt["CJK Unified Ideographs"](Ue)||Pt["Enclosed CJK Letters and Months"](Ue)||Pt["Halfwidth and Fullwidth Forms"](Ue)||Pt.Hiragana(Ue)||Pt["Ideographic Description Characters"](Ue)||Pt["Kangxi Radicals"](Ue)||Pt["Katakana Phonetic Extensions"](Ue)||Pt.Katakana(Ue)||Pt["Vertical Forms"](Ue)||Pt["Yi Radicals"](Ue)||Pt["Yi Syllables"](Ue)));(E3[Ae]||qe||Re.image)&&je.push(nR(Xe+1,Ye,$e,je,T3(Ae,de.getCodePoint(Xe+1),qe&&nt),!1))}}var Ue;return iR(nR(de.length(),Ye,$e,je,0,!0))})(V,w,p,e,a,P),{processBidirectionalText:X,processStyledBidirectionalText:K}=No;if(X&&V.sections.length===1){let de=X(V.toString(),W);for(let pe of de){let ge=new wp;ge.text=pe,ge.sections=V.sections;for(let Le=0;Le<pe.length;Le++)ge.sectionIndex.push(0);U.push(ge)}}else if(K){let de=K(V.text,V.sectionIndex,W);for(let pe of de){let ge=new wp;ge.text=pe[0],ge.sectionIndex=pe[1],ge.sections=V.sections,U.push(ge)}}else U=(function(de,pe){let ge=[],Le=de.text,Te=0;for(let ke of pe)ge.push(de.substring(Te,ke)),Te=ke;return Te<Le.length&&ge.push(de.substring(Te,Le.length)),ge})(V,W);let le=[],re={positionedLines:le,text:V.toString(),top:I[1],bottom:I[1],left:I[0],right:I[0],writingMode:S,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if((function(de,pe,ge,Le,Te,ke,je,$e,nt,Ye,Ue,Xe){let Re=0,Ae=0,qe=0,Qe=$e==="right"?1:$e==="left"?0:.5,He=!1;for(let ut of Te){let Mt=ut.getSections();for(let Zt of Mt){if(Zt.image)continue;let an=pe[Zt.fontStack];if(an&&(He=an.ascender!==void 0&&an.descender!==void 0,!He))break}if(!He)break}let _t=0;for(let ut of Te){ut.trim();let Mt=ut.getMaxScale(),Zt=(Mt-1)*Nr,an={positionedGlyphs:[],lineOffset:0};de.positionedLines[_t]=an;let En=an.positionedGlyphs,Yt=0;if(!ut.length()){Ae+=ke,++_t;continue}let Cn=0,An=0;for(let oe=0;oe<ut.length();oe++){let te=ut.getSection(oe),Ne=ut.getSectionIndex(oe),st=ut.getCodePoint(oe),ze=te.scale,lt=null,Dt=null,It=null,Jt=Nr,Ft=0,Et=nt;Et===os.vertical&&((bt=st)===12312||bt===12313||bt===12316||bt===12540||bt===12448)&&(Et=os.horizontal);let Dn=!(Et===os.horizontal||!Ue&&!Xf(st)||Ue&&(G0[st]||Og(st)));if(te.image){let Kn=Le.get(te.image.toString());if(!Kn)continue;It=te.image,de.iconsInText=de.iconsInText||!0,Dt=Kn.paddedRect;let Nt=Kn.displaySize;ze=ze*Nr/Xe,lt={width:Nt[0],height:Nt[1],left:0,top:-QM,advance:Dn?Nt[1]:Nt[0],localGlyph:!1},Ft=He?-lt.height*ze:Mt*Nr-17-Nt[1]*ze,Jt=lt.advance;let bn=(Dn?Nt[0]:Nt[1])*ze-Nr*Mt;bn>0&&bn>Yt&&(Yt=bn)}else{let Kn=ge[te.fontStack];if(!Kn)continue;Kn[st]&&(Dt=Kn[st]);let Nt=pe[te.fontStack];if(!Nt)continue;let bn=Nt.glyphs[st];if(!bn)continue;if(lt=bn.metrics,Jt=st!==8203?Nr:0,He){let Jn=Nt.ascender!==void 0?Math.abs(Nt.ascender):0,zn=Nt.descender!==void 0?Math.abs(Nt.descender):0,Fi=(Jn+zn)*ze;Cn<Fi&&(Cn=Fi,An=(Jn-zn)/2*ze),Ft=-Jn*ze}else Ft=(Mt-ze)*Nr-17}Dn?(de.verticalizable=!0,En.push({glyph:st,image:It,x:Re,y:Ae+Ft,vertical:Dn,scale:ze,localGlyph:lt.localGlyph,fontStack:te.fontStack,sectionIndex:Ne,metrics:lt,rect:Dt}),Re+=Jt*ze+Ye):(En.push({glyph:st,image:It,x:Re,y:Ae+Ft,vertical:Dn,scale:ze,localGlyph:lt.localGlyph,fontStack:te.fontStack,sectionIndex:Ne,metrics:lt,rect:Dt}),Re+=lt.advance*ze+Ye)}En.length!==0&&(qe=Math.max(Re-Ye,qe),He?rR(En,Qe,Yt,An,ke*Mt/2):rR(En,Qe,Yt,0,ke/2)),Re=0;let Ii=ke*Mt+Yt;an.lineOffset=Math.max(Yt,Zt),Ae+=Ii,++_t}var bt;let ft=Ae,{horizontalAlign:at,verticalAlign:Gt}=KE(je);(function(ut,Mt,Zt,an,En,Yt){let Cn=(Mt-Zt)*En,An=-Yt*an;for(let Ii of ut)for(let oe of Ii.positionedGlyphs)oe.x+=Cn,oe.y+=An})(de.positionedLines,Qe,at,Gt,qe,ft),de.top+=-Gt*ft,de.bottom=de.top+ft,de.left+=-at*qe,de.right=de.left+qe,de.hasBaseline=He})(re,e,n,a,U,m,_,b,S,w,D,O),!(function(de){for(let pe of de)if(pe.positionedGlyphs.length!==0)return!1;return!0})(le))return re}let G0={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},E3={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function eR(r,e,n,a,u,p){if(e.image){let m=a.get(e.image.toString());return m?m.displaySize[0]*e.scale*Nr/p+u:0}{let m=n[e.fontStack],_=m&&m.glyphs[r];return _?_.metrics.advance*e.scale+u:0}}function tR(r,e,n,a){let u=Math.pow(r-e,2);return a?r<e?u/2:2*u:u+Math.abs(n)*n}function T3(r,e,n){let a=0;return r===10&&(a-=1e4),n&&(a+=150),r!==40&&r!==65288||(a+=50),e!==41&&e!==65289||(a+=50),a}function nR(r,e,n,a,u,p){let m=null,_=tR(e,n,u,p);for(let b of a){let w=tR(e-b.x,n,u,p)+b.badness;w<=_&&(m=b,_=w)}return{index:r,x:e,priorBreak:m,badness:_}}function iR(r){return r?iR(r.priorBreak).concat(r.index):[]}function KE(r){let e=.5,n=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0}return{horizontalAlign:e,verticalAlign:n}}function rR(r,e,n,a,u){if(!(e||n||a||u))return;let p=r.length-1,m=r[p],_=(m.x+m.metrics.advance*m.scale)*e;for(let b=0;b<=p;b++)r[b].x-=_,r[b].y+=n+a+u}function oR(r){return r.imagePrimary!==void 0&&r.top!==void 0&&r.bottom!==void 0&&r.left!==void 0&&r.right!==void 0}function q0(r,e,n,a){let{horizontalAlign:u,verticalAlign:p}=KE(a),m=n[0]-r.displaySize[0]*u,_=n[1]-r.displaySize[1]*p;return{imagePrimary:r,imageSecondary:e,top:_,bottom:_+r.displaySize[1],left:m,right:m+r.displaySize[0]}}function JE(r,e,n,a,u,p){let m=r.imagePrimary,_;if(m.content){let V=m.content,U=m.pixelRatio||1;_=[V[0]/U,V[1]/U,m.displaySize[0]-V[2]/U,m.displaySize[1]-V[3]/U]}let b=e.left*p,w=e.right*p,I,S,D,P;n==="width"||n==="both"?(P=u[0]+b-a[3],S=u[0]+w+a[1]):(P=u[0]+(b+w-m.displaySize[0])/2,S=P+m.displaySize[0]);let O=e.top*p,N=e.bottom*p;return n==="height"||n==="both"?(I=u[1]+O-a[0],D=u[1]+N+a[2]):(I=u[1]+(O+N-m.displaySize[1])/2,D=I+m.displaySize[1]),{imagePrimary:m,imageSecondary:void 0,top:I,right:S,bottom:D,left:P,collisionPadding:_}}function sR(r){return!r.imagePrimary.stretchX}function aR(r){return!r.imagePrimary.stretchY}function lR(r){return{width:r.right-r.left,height:r.bottom-r.top}}let $a=128;function Ep(r,e,n){let{expression:a}=e;if(a.kind==="constant")return{kind:"constant",layoutSize:a.evaluate(new ci(r+1,{worldview:n}))};if(a.kind==="source")return{kind:"source"};{let{zoomStops:u,interpolationType:p}=a,m=0;for(;m<u.length&&u[m]<=r;)m++;m=Math.max(0,m-1);let _=m;for(;_<u.length&&u[_]<r+1;)_++;_=Math.min(u.length-1,_);let b=u[m],w=u[_];return a.kind==="composite"?{kind:"composite",minZoom:b,maxZoom:w,interpolationType:p}:{kind:"camera",minZoom:b,maxZoom:w,minSize:a.evaluate(new ci(b,{worldview:n})),maxSize:a.evaluate(new ci(w,{worldview:n})),interpolationType:p}}}function QE(r,{uSize:e,uSizeT:n},{lowerSize:a,upperSize:u}){return r.kind==="source"?a/$a:r.kind==="composite"?zt(a/$a,u/$a,n):e}function Tp(r,e,n=1){let a=0,u=0;if(r.kind==="constant")u=r.layoutSize*n;else if(r.kind!=="source"){let{interpolationType:p,minZoom:m,maxZoom:_}=r,b=p?G(Yo.interpolationFactor(p,e,m,_),0,1):0;r.kind==="camera"?u=zt(r.minSize,r.maxSize,b)*n:a=b*n}return{uSizeT:a,uSize:u}}class yc extends Ze{constructor(e,n,a,u,p){super(e,n),this.angle=u,this.z=a,p!==void 0&&(this.segment=p)}clone(){return new yc(this.x,this.y,this.z,this.angle,this.segment)}}function cR(r,e,n,a,u){if(e.segment===void 0)return!0;let p=e,m=e.segment+1,_=0;for(;_>-n/2;){if(m--,m<0)return!1;_-=r[m].dist(p),p=r[m]}_+=r[m].dist(r[m+1]),m++;let b=[],w=0;for(;_<n/2;){let I=r[m],S=r[m+1];if(!S)return!1;let D=r[m-1].angleTo(I)-I.angleTo(S);for(D=Math.abs((D+3*Math.PI)%(2*Math.PI)-Math.PI),b.push({distance:_,angleDelta:D}),w+=D;_-b[0].distance>a;)w-=b.shift().angleDelta;if(w>u)return!1;m++,_+=I.dist(S)}return!0}function uR(r){let e=0;for(let n=0;n<r.length-1;n++)e+=r[n].dist(r[n+1]);return e}function dR(r,e,n){return r?.6*e*n:0}function hR(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function I3(r,e,n,a,u,p){let m=dR(n,u,p),_=hR(n,a)*p,b=0,w=uR(r)/2;for(let I=0;I<r.length-1;I++){let S=r[I],D=r[I+1],P=S.dist(D);if(b+P>w){let O=(w-b)/P,N=zt(S.x,D.x,O),V=zt(S.y,D.y,O),U=new yc(N,V,0,D.angleTo(S),I);return!m||cR(r,U,_,m,e)?U:void 0}b+=P}}function S3(r,e,n,a,u,p,m,_,b){let w=dR(a,p,m),I=hR(a,u),S=I*m,D=r[0].x===0||r[0].x===b||r[0].y===0||r[0].y===b;return e-S<e/4&&(e=S+e/4),fR(r,D?e/2*_%e:(I/2+2*p)*m*_%e,e,w,n,S,D,!1,b)}function fR(r,e,n,a,u,p,m,_,b){let w=p/2,I=uR(r),S=0,D=e-n,P=[];for(let O=0;O<r.length-1;O++){let N=r[O],V=r[O+1],U=N.dist(V),W=V.angleTo(N);for(;D+n<S+U;){D+=n;let X=(D-S)/U,K=zt(N.x,V.x,X),le=zt(N.y,V.y,X);if(K>=0&&K<b&&le>=0&&le<b&&D-w>=0&&D+w<=I){let re=new yc(K,le,0,W,O);a&&!cR(r,re,p,a,u)||P.push(re)}}S+=U}return _||P.length||m||(P=fR(r,S/2,n,a,u,p,m,!0,b)),P}function pR(r){let e=0,n=0;for(let m of r)e+=m.w*m.h,n=Math.max(n,m.w);r.sort((m,_)=>_.h-m.h);let a=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),n),h:1/0}],u=0,p=0;for(let m of r)for(let _=a.length-1;_>=0;_--){let b=a[_];if(!(m.w>b.w||m.h>b.h)){if(m.x=b.x,m.y=b.y,p=Math.max(p,m.y+m.h),u=Math.max(u,m.x+m.w),m.w===b.w&&m.h===b.h){let w=a.pop();w&&_<a.length&&(a[_]=w)}else m.h===b.h?(b.x+=m.w,b.w-=m.w):m.w===b.w?(b.y+=m.h,b.h-=m.h):(a.push({x:b.x+m.w,y:b.y,w:b.w-m.w,h:m.h}),b.y+=m.h,b.h-=m.h);break}}return{w:u,h:p,fill:e/(u*p)||0}}vt(yc,"Anchor");let ph=1;class A_{static getImagePositionScale(e,n,a){if(n&&e&&e.options&&e.options.transform){let u=e.options.transform;return{x:u.a,y:u.d}}return{x:a,y:a}}constructor(e,n,a,u){this.paddedRect=e;let{pixelRatio:p,version:m,stretchX:_,stretchY:b,content:w,sdf:I,usvg:S}=n;this.pixelRatio=p,this.stretchX=_,this.stretchY=b,this.content=w,this.version=m,this.padding=a,this.sdf=I,this.usvg=S,this.scale=A_.getImagePositionScale(u,S,p)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function eT(r,e,n){let a=Oa.parse(r),u=(function(p,m,_=[1,1]){return{x:0,y:0,w:(p.data?p.data.width:p.width*_[0])+2*m,h:(p.data?p.data.height:p.height*_[1])+2*m}})(e,n,[a.options.transform.a,a.options.transform.d]);return{bin:u,imagePosition:new A_(u,e,n,a),imageVariant:a}}class mR{constructor(e,n,a){let u=new Map,p=new Map;this.haveRenderCallbacks=[];let m=[];this.addImages(e,u,ph,m),this.addImages(n,p,2,m);let{w:_,h:b}=pR(m),w=new Yr({width:_||1,height:b||1});for(let[I,S]of e.entries()){let D=u.get(I).paddedRect;Yr.copy(S.data,w,{x:0,y:0},{x:D.x+ph,y:D.y+ph},S.data,null,S.sdf)}for(let[I,S]of n.entries()){let D=p.get(I),P=D.paddedRect,O=D.padding,N=P.x+O,V=P.y+O,U=S.data.width,W=S.data.height;O=O>1?O-1:O,Yr.copy(S.data,w,{x:0,y:0},{x:N,y:V},S.data,a),Yr.copy(S.data,w,{x:0,y:W-O},{x:N,y:V-O},{width:U,height:O},a),Yr.copy(S.data,w,{x:0,y:0},{x:N,y:V+W},{width:U,height:O},a),Yr.copy(S.data,w,{x:U-O,y:0},{x:N-O,y:V},{width:O,height:W},a),Yr.copy(S.data,w,{x:0,y:0},{x:N+U,y:V},{width:O,height:W},a),Yr.copy(S.data,w,{x:U-O,y:W-O},{x:N-O,y:V-O},{width:O,height:O},a),Yr.copy(S.data,w,{x:0,y:W-O},{x:N+U,y:V-O},{width:O,height:O},a),Yr.copy(S.data,w,{x:0,y:0},{x:N+U,y:V+W},{width:O,height:O},a),Yr.copy(S.data,w,{x:U-O,y:0},{x:N-O,y:V+W},{width:O,height:O},a)}this.lut=a,this.image=w,this.iconPositions=u,this.patternPositions=p}addImages(e,n,a,u){for(let[p,m]of e.entries()){let{bin:_,imagePosition:b,imageVariant:w}=eT(p,m,a);n.set(p,b),u.push(_),m.hasRenderCallback&&this.haveRenderCallbacks.push(w.id)}}patchUpdatedImages(e,n,a){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(u=>e.hasImage(u,a)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,a);for(let u of e.getUpdatedImages(a)){for(let p of this.iconPositions.keys()){let m=Oa.parse(p);if(gr.isEqual(m.id,u)){let _=e.getImage(u,a);this.patchUpdatedImage(this.iconPositions.get(p),_,n,null)}}for(let p of this.patternPositions.keys()){let m=Oa.parse(p);if(gr.isEqual(m.id,u)){let _=e.getImage(u,a);this.patchUpdatedImage(this.patternPositions.get(p),_,n,this.lut)}}}}patchUpdatedImage(e,n,a,u=null){if(!e||!n||e.version===n.version)return;e.version=n.version;let[p,m]=e.tl,_=e.sdf;if(this.lut||_){let b={width:n.data.width,height:n.data.height},w=new Yr(b);Yr.copy(n.data,w,{x:0,y:0},{x:0,y:0},b,u,_),a.update(w,{position:{x:p,y:m}})}else a.update(n.data,{position:{x:p,y:m}})}}vt(A_,"ImagePosition"),vt(mR,"ImageAtlas");let M_=1e20;function gR(r,e,n,a,u,p,m,_,b){for(let w=e;w<e+a;w++)_R(r,n*p+w,p,u,m,_,b);for(let w=n;w<n+u;w++)_R(r,w*p+e,1,a,m,_,b)}function _R(r,e,n,a,u,p,m){p[0]=0,m[0]=-M_,m[1]=M_,u[0]=r[e];for(let _=1,b=0,w=0;_<a;_++){u[_]=r[e+_*n];let I=_*_;do{let S=p[b];w=(u[_]-u[S]+I-S*S)/(_-S)/2}while(w<=m[b]&&--b>-1);b++,p[b]=_,m[b]=w,m[b+1]=M_}for(let _=0,b=0;_<a;_++){for(;m[b+1]<_;)b++;let w=p[b],I=_-w;r[e+_*n]=u[w]+I*I}}let Ga=2,tT={none:0,ideographs:1,all:2};class Ip{constructor(e,n,a){this.requestManager=e,this.localGlyphMode=n,this.localFontFamily=a,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,n){let a=[],u=this.url||pi.GLYPHS_URL;for(let p in e)for(let m of e[p])a.push({stack:p,id:m});he(a,({stack:p,id:m},_)=>{let b=this.entries[p];b||(b=this.entries[p]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let w=b.glyphs[m];if(w!==void 0)return void _(null,{stack:p,id:m,glyph:w});if(w=this._tinySDF(b,p,m),w)return b.glyphs[m]=w,void _(null,{stack:p,id:m,glyph:w});let I=Math.floor(m/256);if(256*I>65535)return Rt("glyphs > 65535 not supported"),void _(null,{stack:p,id:m,glyph:w});if(b.ranges[I])return void _(null,{stack:p,id:m,glyph:w});let S=b.requests[I];S||(S=b.requests[I]=[],Ip.loadGlyphRange(p,I,u,this.requestManager,(D,P)=>{if(P){b.ascender=P.ascender,b.descender=P.descender;for(let O in P.glyphs)this._doesCharSupportLocalGlyph(+O)||(b.glyphs[+O]=P.glyphs[+O]);b.ranges[I]=!0}for(let O of S)O(D,P);delete b.requests[I]})),S.push((D,P)=>{D?_(D):P&&_(null,{stack:p,id:m,glyph:P.glyphs[m]||null})})},(p,m)=>{if(p)n(p);else if(m){let _={};for(let{stack:b,id:w,glyph:I}of m)_[b]===void 0&&(_[b]={}),_[b].glyphs===void 0&&(_[b].glyphs={}),_[b].glyphs[w]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},_[b].ascender=this.entries[b].ascender,_[b].descender=this.entries[b].descender;n(null,_)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==tT.none&&(this.localGlyphMode===tT.all?!!this.localFontFamily:!!this.localFontFamily&&(Pt["CJK Unified Ideographs"](e)||Pt["Hangul Syllables"](e)||Pt.Hiragana(e)||Pt.Katakana(e)||Pt["CJK Symbols and Punctuation"](e)||Pt["CJK Unified Ideographs Extension A"](e)||Pt["CJK Unified Ideographs Extension B"](e)||Pt.Osage(e)))}_tinySDF(e,n,a){let u=this.localFontFamily;if(!u||!this._doesCharSupportLocalGlyph(a))return;let p=e.tinySDF;if(!p){let N="400";/bold/i.test(n)?N="900":/medium/i.test(n)?N="500":/light/i.test(n)&&(N="200"),p=e.tinySDF=new Ip.TinySDF({fontFamily:u,fontWeight:N,fontSize:24*Ga,buffer:3*Ga,radius:8*Ga}),p.fontWeight=N}if(this.localGlyphs[p.fontWeight][a])return this.localGlyphs[p.fontWeight][a];let m=String.fromCodePoint(a),{data:_,width:b,height:w,glyphWidth:I,glyphHeight:S,glyphLeft:D,glyphTop:P,glyphAdvance:O}=p.draw(m);return this.localGlyphs[p.fontWeight][a]={id:a,bitmap:new Pu({width:b,height:w},_),metrics:{width:I/Ga,height:S/Ga,left:D/Ga,top:P/Ga-27,advance:O/Ga,localGlyph:!0}}}}Ip.loadGlyphRange=function(r,e,n,a,u){let p=256*e,m=p+255,_=a.transformRequest(a.normalizeGlyphsURL(n).replace("{fontstack}",r).replace("{range}",`${p}-${m}`),Jl.Glyphs);Zc(_,(b,w)=>{if(b)u(b);else if(w){let I={},S=(function(D){return new $0(D).readFields(x3,{})})(w);for(let D of S.glyphs)I[D.id]=D;u(null,{glyphs:I,ascender:S.ascender,descender:S.descender})}})},Ip.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:n=8,cutoff:a=.25,fontFamily:u="sans-serif",fontWeight:p="normal",fontStyle:m="normal",lang:_=null}={}){this.buffer=e,this.cutoff=a,this.radius=n,this.lang=_;let b=this.size=r+4*e,w=this._createCanvas(b),I=this.ctx=w.getContext("2d",{willReadFrequently:!0});I.font=`${m} ${p} ${r}px ${u}`,I.textBaseline="alphabetic",I.textAlign="left",I.fillStyle="black",this.gridOuter=new Float64Array(b*b),this.gridInner=new Float64Array(b*b),this.f=new Float64Array(b),this.z=new Float64Array(b+1),this.v=new Uint16Array(b)}_createCanvas(r){let e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){let{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:a,actualBoundingBoxLeft:u,actualBoundingBoxRight:p}=this.ctx.measureText(r),m=Math.ceil(n),_=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(p-u))),b=Math.min(this.size-this.buffer,m+Math.ceil(a)),w=_+2*this.buffer,I=b+2*this.buffer,S=Math.max(w*I,0),D=new Uint8ClampedArray(S),P={data:D,width:w,height:I,glyphWidth:_,glyphHeight:b,glyphTop:m,glyphLeft:0,glyphAdvance:e};if(_===0||b===0)return P;let{ctx:O,buffer:N,gridInner:V,gridOuter:U}=this;this.lang&&(O.lang=this.lang),O.clearRect(N,N,_,b),O.fillText(r,N,N+m);let W=O.getImageData(N,N,_,b);U.fill(M_,0,S),V.fill(0,0,S);for(let X=0;X<b;X++)for(let K=0;K<_;K++){let le=W.data[4*(X*_+K)+3]/255;if(le===0)continue;let re=(X+N)*w+K+N;if(le===1)U[re]=0,V[re]=M_;else{let de=.5-le;U[re]=de>0?de*de:0,V[re]=de<0?de*de:0}}gR(U,0,0,w,I,w,this.f,this.v,this.z),gR(V,N,N,_,b,w,this.f,this.v,this.z);for(let X=0;X<S;X++){let K=Math.sqrt(U[X])-Math.sqrt(V[X]);D[X]=Math.round(255-255*(K/this.radius+this.cutoff))}return P}};let Il=ph;function yR(r,e){return r+e[1]-e[0]}function nT(r,e,n,a,u=1){let p=[],m=r.imagePrimary,_=m.pixelRatio,b=m.paddedRect.w-2*Il,w=m.paddedRect.h-2*Il,I=(r.right-r.left)*u,S=(r.bottom-r.top)*u,D=m.stretchX||[[0,b]],P=m.stretchY||[[0,w]],O=D.reduce(yR,0),N=P.reduce(yR,0),V=b-O,U=w-N,W=0,X=O,K=0,le=N,re=0,de=V,pe=0,ge=U;if(m.content&&a){let Te=m.content;W=W0(D,0,Te[0]),K=W0(P,0,Te[1]),X=W0(D,Te[0],Te[2]),le=W0(P,Te[1],Te[3]),re=Te[0]-W,pe=Te[1]-K,de=Te[2]-Te[0]-X,ge=Te[3]-Te[1]-le}let Le=(Te,ke,je,$e)=>{let nt=Z0(Te.stretch-W,X,I,r.left*u),Ye=X0(Te.fixed-re,de,Te.stretch,O),Ue=Z0(ke.stretch-K,le,S,r.top*u),Xe=X0(ke.fixed-pe,ge,ke.stretch,N),Re=Z0(je.stretch-W,X,I,r.left*u),Ae=X0(je.fixed-re,de,je.stretch,O),qe=Z0($e.stretch-K,le,S,r.top*u),Qe=X0($e.fixed-pe,ge,$e.stretch,N),He=new Ze(nt,Ue),_t=new Ze(Re,Ue),bt=new Ze(Re,qe),ft=new Ze(nt,qe),at=new Ze(Ye/_,Xe/_),Gt=new Ze(Ae/_,Qe/_),ut=e*Math.PI/180;if(ut){let Cn=Math.sin(ut),An=Math.cos(ut),Ii=[An,-Cn,Cn,An];He._matMult(Ii),_t._matMult(Ii),ft._matMult(Ii),bt._matMult(Ii)}let Mt=Te.stretch+Te.fixed,Zt=je.stretch+je.fixed,an=ke.stretch+ke.fixed,En=$e.stretch+$e.fixed,Yt=r.imageSecondary;return{tl:He,tr:_t,bl:ft,br:bt,texPrimary:{x:m.paddedRect.x+Il+Mt,y:m.paddedRect.y+Il+an,w:Zt-Mt,h:En-an},texSecondary:Yt?{x:Yt.paddedRect.x+Il+Mt,y:Yt.paddedRect.y+Il+an,w:Zt-Mt,h:En-an}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:at,pixelOffsetBR:Gt,minFontScaleX:de/_/I,minFontScaleY:ge/_/S,isSDF:n}};if(a&&(m.stretchX||m.stretchY)){let Te=vR(D,V,O),ke=vR(P,U,N);for(let je=0;je<Te.length-1;je++){let $e=Te[je],nt=Te[je+1];for(let Ye=0;Ye<ke.length-1;Ye++)p.push(Le($e,ke[Ye],nt,ke[Ye+1]))}}else p.push(Le({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:b+1},{fixed:0,stretch:w+1}));return p}function D3(r,e){let n=r.stretchY||[[0,r.paddedRect.h-2*Il]];return e&&(r.stretchX||r.stretchY)?xR(r.stretchX||[[0,r.paddedRect.w-2*Il]])*xR(n):1}function W0(r,e,n){let a=0;for(let u of r)a+=Math.max(e,Math.min(n,u[1]))-Math.max(e,Math.min(n,u[0]));return a}function vR(r,e,n){let a=[{fixed:-Il,stretch:0}];for(let[u,p]of r){let m=a[a.length-1];a.push({fixed:u-m.stretch,stretch:m.stretch}),a.push({fixed:u-m.stretch,stretch:m.stretch+(p-u)})}return a.push({fixed:e+Il,stretch:n}),a}function xR(r){return 2*r.length+1}function Z0(r,e,n,a){return r/e*n+a}function X0(r,e,n,a){return r-e*n/a}function C3(r,e,n,a){let u=e+r.positionedLines[a].lineOffset;return a===0?n+u/2:n+(u+(e+r.positionedLines[a-1].lineOffset))/2}function A3(r,e=1,n=!1){let a=1/0,u=1/0,p=-1/0,m=-1/0,_=r[0];for(let P=0;P<_.length;P++){let O=_[P];(!P||O.x<a)&&(a=O.x),(!P||O.y<u)&&(u=O.y),(!P||O.x>p)&&(p=O.x),(!P||O.y>m)&&(m=O.y)}let b=Math.min(p-a,m-u),w=b/2,I=new bf([],M3);if(b===0)return new Ze(a,u);for(let P=a;P<p;P+=b)for(let O=u;O<m;O+=b)I.push(new Sp(P+w,O+w,w,r));let S=(function(P){let O=0,N=0,V=0,U=P[0];for(let W=0,X=U.length,K=X-1;W<X;K=W++){let le=U[W],re=U[K],de=le.x*re.y-re.x*le.y;N+=(le.x+re.x)*de,V+=(le.y+re.y)*de,O+=3*de}return new Sp(N/O,V/O,0,P)})(r),D=I.length;for(;I.length;){let P=I.pop();(P.d>S.d||!S.d)&&(S=P,n&&console.log("found best %d after %d probes",Math.round(1e4*P.d)/1e4,D)),P.max-S.d<=e||(w=P.h/2,I.push(new Sp(P.p.x-w,P.p.y-w,w,r)),I.push(new Sp(P.p.x+w,P.p.y-w,w,r)),I.push(new Sp(P.p.x-w,P.p.y+w,w,r)),I.push(new Sp(P.p.x+w,P.p.y+w,w,r)),D+=4)}return n&&(console.log(`num probes: ${D}`),console.log(`best distance: ${S.d}`)),S.p}function M3(r,e){return e.max-r.max}class Sp{constructor(e,n,a,u){this.p=new Ze(e,n),this.h=a,this.d=(function(p,m){let _=!1,b=1/0;for(let w=0;w<m.length;w++){let I=m[w];for(let S=0,D=I.length,P=D-1;S<D;P=S++){let O=I[S],N=I[P];O.y>p.y!=N.y>p.y&&p.x<(N.x-O.x)*(p.y-O.y)/(N.y-O.y)+O.x&&(_=!_),b=Math.min(b,es(p,O,N))}}return(_?1:-1)*Math.sqrt(b)})(this.p,u),this.max=this.d+this.h*Math.SQRT2}}let R3=Object.keys,iT=Number.POSITIVE_INFINITY,P3=Math.sqrt(2);function Y0(r,e,n,a){let u=r.collisionPadding||[0,0,0,0],p={top:r.top-u[1],bottom:r.bottom+u[3],left:r.left-u[0],right:r.right+u[2],scaled:!1};return a!==void 0&&(function(m,_){m.top*=_,m.bottom*=_,m.left*=_,m.right*=_,m.scaled=!0})(p,a),n&&(function(m,_){if(!_)return;let b=gn(_),w=new Ze(m.left,m.top),I=new Ze(m.right,m.top),S=new Ze(m.left,m.bottom),D=new Ze(m.right,m.bottom);w._rotateAround(b,new Ze(0,0)),I._rotateAround(b,new Ze(0,0)),S._rotateAround(b,new Ze(0,0)),D._rotateAround(b,new Ze(0,0)),m.left=Math.min(w.x,I.x,S.x,D.x),m.right=Math.max(w.x,I.x,S.x,D.x),m.top=Math.min(w.y,I.y,S.y,D.y),m.bottom=Math.max(w.y,I.y,S.y,D.y)})(p,n),e?{top:Math.min(e.top,p.top),bottom:Math.max(e.bottom,p.bottom),left:Math.min(e.left,p.left),right:Math.max(e.right,p.right),scaled:e.scaled||p.scaled}:p}function bR(r,[e,n]){let a=0,u=0;if(n===iT){e<0&&(e=0);let p=e/P3;switch(r){case"top-right":case"top-left":u=p-7;break;case"bottom-right":case"bottom-left":u=7-p;break;case"bottom":u=7-e;break;case"top":u=e-7}switch(r){case"top-right":case"bottom-right":a=-p;break;case"top-left":case"bottom-left":a=p;break;case"left":a=e;break;case"right":a=-e}}else{switch(e=Math.abs(e),n=Math.abs(n),r){case"top-right":case"top-left":case"top":u=n-7;break;case"bottom-right":case"bottom-left":case"bottom":u=7-n}switch(r){case"top-right":case"bottom-right":case"right":a=-e;break;case"top-left":case"bottom-left":case"left":a=e}}return[a,u]}function O3(r,e,n,a,u,p,m,_,b,w,I){let S=r.layers[0],D=S.appearances;if(D.length===0)return{iconBBox:null,iconVerticalBBox:null};let P=null,O=null,N=a.get("icon-rotate").evaluate(u,{},p);e&&(P=Y0(e,P,N,m),n)&&(O=Y0(n,O,N+90,m));let[V,U]=a.get("icon-size-scale-range"),W=G(1,V,U);for(let X of D){let K=X.getUnevaluatedProperties(),le=K._values["icon-image"].value!==void 0,re=K._values["icon-size"].value!==void 0,de=K._values["icon-offset"].value!==void 0,pe=K._values["icon-rotate"].value!==void 0;if(le||re||de||pe){let ge=de?S.getAppearanceValueAndResolveTokens(X,"icon-offset",u,p,[]):null,Le=ge&&Array.isArray(ge)?ge:_,Te=pe?S.getAppearanceValueAndResolveTokens(X,"icon-rotate",u,p,[]):null,ke=typeof Te=="number"?Te:N,je=re?S.getAppearanceValueAndResolveTokens(X,"icon-size",u,p,[]):null,$e=typeof je=="number"?je*b.iconScaleFactor:m,nt=null,Ye=null,Ue=null;if(le){let Xe=S.getAppearanceValueAndResolveTokens(X,"icon-image",u,p,[]);if(Xe){let Re=r.getResolvedImageFromTokens(Xe),Ae=K._values["icon-size"],qe=R_(Re,Ep(r.zoom,Ae,r.worldview),Ae,p,r.zoom,u,r.pixelRatio,W,r.worldview);Ue=w.get(qe.iconPrimary.toString())}}else e&&(Ue=e.imagePrimary);Ue&&(nt=q0(Ue,null,Le,I),r.allowVerticalPlacement&&(Ye=q0(Ue,null,Le,I))),nt&&(P=Y0(nt,P,ke,$e)),Ye&&(O=Y0(Ye,O,ke+90,$e))}}return{iconBBox:P,iconVerticalBBox:O}}function K0(r,e,n,a,u,p,m,_,b){if(!e||!e.usvg)return;let w=lR(a),I=lR(u),S=p!=="both"&&p!=="width"||!sR(a)?1:I.width/w.width,D=p!=="both"&&p!=="height"||!aR(a)?1:I.height/w.height;n.scaleSelf(S,D);let P=n.toString();m.set(P,n),_.set(P,e);let{imagePosition:O}=eT(P,e,ph);b.set(P,O)}function wR(r,e,n,a,u,p,m,_,b){if(!r)return;let w=(function(I,S,D,P,O,N){if(I.kind==="camera")return I.maxSize;if(I.kind==="composite"){let V=S.possiblyEvaluate(new ci(I.maxZoom,{worldview:N}),D).evaluate(O,{},D),U=S.possiblyEvaluate(new ci(I.minZoom,{worldview:N}),D).evaluate(O,{},D);return Math.max(V,U)}return S.possiblyEvaluate(new ci(P,{worldview:N})).evaluate(O,{},D)})(e,n,a,u,p,b);return r.scaleSelf(w*_*m)}function R_(r,e,n,a,u,p,m,_,b){return{iconPrimary:wR(r.getPrimary(),e,n,a,u,p,m,_,b),iconSecondary:wR(r.getSecondary(),e,n,a,u,p,m,_,b)}}function L3(r,e,n){if(!e)return;let a=n.get(r.toString()),u=n.get(e.toString());a&&u&&(a.paddedRect.w===u.paddedRect.w&&a.paddedRect.h===u.paddedRect.h||Rt(`Mismatch in icon variant sizes: ${r.toString()} and ${e.toString()}`),a.usvg!==u.usvg&&Rt(`Mismatch in icon variant image types: ${r.id} and ${e.id}`))}function ER(r,e,n,a){if(!r)return;let u=e.get(n.toString());if(r.imagePrimary=u,a){let p=e.get(a.toString());r.imageSecondary=p}}function F3(r,e){for(let n in r.horizontal)TR(r.horizontal[n],e);TR(r.vertical,e)}function TR(r,e){if(r){for(let n of r.positionedLines)for(let a of n.positionedGlyphs)if(a.image!==null){let u=a.image.toString();a.rect=e.get(u).paddedRect}}}function rT(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function k3(r,e,n,a,u,p,m,_,b){let w=oT(p.horizontal)||p.vertical,I=n.get("icon-text-fit-padding").evaluate(a,{},u),S,D=e;return e&&b!=="none"&&(r.allowVerticalPlacement&&p.vertical&&(S=JE(e,p.vertical,b,I,_,m)),w&&(D=JE(e,w,b,I,_,m))),{defaultShapedIcon:D,verticallyShapedIcon:S}}function N3(r,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W,X,K,le){let re=m.textMaxSize.evaluate(e,{},D);re===void 0?re=_*m.textScaleFactor:re*=m.textScaleFactor;let de=r.layers[0].layout,pe=Nr,ge=_*m.textScaleFactor/pe,Le=oT(n.horizontal)||n.vertical;if(V!=="none"&&r.appearanceFeatureData&&e.index<r.appearanceFeatureData.length){let He=r.appearanceFeatureData[e.index];He&&(He.textShaping=Le,He.iconTextFitPadding=de.get("icon-text-fit-padding").evaluate(e,{},D),He.fontScale=ge)}let Te=P.name==="globe",ke=r.tilePixelRatio*re/pe,je=(Re=r.overscaling,r.zoom>18&&Re>2&&(Re>>=1),Math.max(rt/(512*Re),1)*de.get("symbol-spacing")),$e=de.get("text-padding")*r.tilePixelRatio,nt=de.get("icon-padding")*r.tilePixelRatio,Ye=gn(de.get("text-max-angle")),Ue=de.get("icon-rotation-alignment")==="map"&&X!=="point",Xe=je/2;var Re;r.hasAnyIconTextFit===!1&&V!=="none"&&(r.hasAnyIconTextFit=!0);let Ae=e.properties?+e.properties[ht]:null,qe=Ae&&r.elevationFeatureIdToIndex?r.elevationFeatureIdToIndex.get(Ae):65535,Qe=(He,_t,bt)=>{if(_t.x<0||_t.x>=rt||_t.y<0||_t.y>=rt)return;let ft=null;if(Te){let{x:at,y:Gt,z:ut}=P.projectTilePoint(_t.x,_t.y,bt);ft={anchor:new yc(at,Gt,ut,0,void 0),up:P.upVector(bt,_t.x,_t.y)}}(function(at,Gt,ut,Mt,Zt,an,En,Yt,Cn,An,Ii,oe,te,Ne,st,ze,lt,Dt,It,Jt,Ft,Et,Dn,Kn,Nt,bn,Jn,zn,Fi,gi,si){let $n=at.addToLineVertexArray(Gt,Mt),Mn,Qt,Rn,ai,kt,Tn,_i,Ui=0,Ki=0,fr=0,yi=0,lr=-1,zo=-1,cr={},ss=Md(""),Kr=ut?ut.anchor:Gt,Ws=zn!=="none",Bo=0,as=0;if(Cn._unevaluatedLayout.getValue("text-radial-offset")===void 0){let zr=Cn.layout.get("text-offset").evaluate(Ft,{},Nt);Bo=zr[0]*Nr,as=zr[1]*Nr}else Bo=Cn.layout.get("text-radial-offset").evaluate(Ft,{},Nt)*Nr,as=iT;if(at.allowVerticalPlacement&&Zt.vertical){let zr=Zt.vertical;if(st)Tn=sT(zr),Yt&&(_i=sT(Yt));else{let mo=Cn.layout.get("text-rotate").evaluate(Ft,{},Nt)+90;Rn=J0(An,Kr,Gt,Ii,oe,te,zr,Ne,mo,ze),Yt&&(ai=J0(An,Kr,Gt,Ii,oe,te,Yt,Dt,mo,null,si))}}if(an){let zr=at.iconSizeData,mo=Cn.layout.get("icon-rotate").evaluate(Ft,{},Nt),Sl=nT(an,mo,Dn,Ws,Et.iconScaleFactor),Nu=Yt?nT(Yt,mo,Dn,Ws,Et.iconScaleFactor):void 0;Qt=J0(An,Kr,Gt,Ii,oe,te,an,Dt,mo,null,gi);let Op=(function(Dl,mx,Lp,YV,HP,$P,KV,JV){let GP=Dl.layers[0],qP=GP.appearances,Fp=mx.length;if(Lp&&(Fp=Math.max(Fp,Lp.length)),qP.length===0)return Fp;let[QV,ej]=YV.get("icon-size-scale-range"),tj=G(1,QV,ej);for(let WP of qP){let ZP=WP.getUnevaluatedProperties();if(ZP._values["icon-image"].value!==void 0){let XP=GP.getAppearanceValueAndResolveTokens(WP,"icon-image",HP,$P,[]);if(XP){let YP=Dl.getResolvedImageFromTokens(XP);if(YP){let KP=ZP._values["icon-size"],nj=R_(YP,Ep(Dl.zoom,KP,Dl.worldview),KP,$P,Dl.zoom,HP,Dl.pixelRatio,tj,Dl.worldview),ij=KV.get(nj.iconPrimary.toString());Fp=Math.max(Fp,D3(ij,JV))}}}}return Fp})(at,Sl,Nu,Cn.layout,Ft,Nt,at.iconAtlasPositions,Ws);Ui=4*Op;let zu=null;zr.kind==="source"?(zu=[$a*Cn.layout.get("icon-size").evaluate(Ft,{},Nt)*Et.iconScaleFactor],zu[0]>vc&&Rt(`${at.layerIds[0]}: Value for "icon-size" is >= ${P_}. Reduce your "icon-size".`)):zr.kind==="composite"&&(zu=[$a*Et.compositeIconSizes[0].evaluate(Ft,{},Nt)*Et.iconScaleFactor,$a*Et.compositeIconSizes[1].evaluate(Ft,{},Nt)*Et.iconScaleFactor],(zu[0]>vc||zu[1]>vc)&&Rt(`${at.layerIds[0]}: Value for "icon-size" is >= ${P_}. Reduce your "icon-size".`)),at.addSymbols(at.icon,Sl,zu,Jt,It,Ft,void 0,ut,Gt,$n.lineStartIndex,$n.lineLength,-1,Kn,Nt,bn,Jn,at.symbolInstances.length,Op),lr=at.icon.placedSymbolArray.length-1,Nu&&(Ki=4*Op,at.addSymbols(at.icon,Nu,zu,Jt,It,Ft,os.vertical,ut,Gt,$n.lineStartIndex,$n.lineLength,-1,Kn,Nt,bn,Jn,at.symbolInstances.length,Op),zo=at.icon.placedSymbolArray.length-1)}for(let zr in Zt.horizontal){let mo=zr,Sl=Zt.horizontal[mo];Mn||(ss=Md(Sl.text),st?kt=sT(Sl):Mn=J0(An,Kr,Gt,Ii,oe,te,Sl,Ne,Cn.layout.get("text-rotate").evaluate(Ft,{},Nt),ze));let Nu=Sl.positionedLines.length===1;if(fr+=IR(at,ut,Gt,Sl,En,Cn,st,Ft,ze,$n,Zt.vertical?os.horizontal:os.horizontalOnly,Nu?R3(Zt.horizontal):[mo],cr,lr,Et,Kn,Nt,at.symbolInstances.length,bn),Nu)break}Zt.vertical&&(yi+=IR(at,ut,Gt,Zt.vertical,En,Cn,st,Ft,ze,$n,os.vertical,["vertical"],cr,zo,Et,Kn,Nt,at.symbolInstances.length,bn));let Jr=-1,ls=(zr,mo)=>zr?Math.max(zr,mo):mo;Jr=ls(kt,Jr),Jr=ls(Tn,Jr),Jr=ls(_i,Jr);let Zs=Jr>-1?1:0;at.glyphOffsetArray.length>=65535&&Rt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Ft.sortKey!==void 0&&at.addToSortKeyRanges(at.symbolInstances.length,Ft.sortKey),at.symbolInstances.emplaceBack(Gt.x,Gt.y,Kr.x,Kr.y,Kr.z,cr.right>=0?cr.right:-1,cr.center>=0?cr.center:-1,cr.left>=0?cr.left:-1,cr.vertical>=0?cr.vertical:-1,lr,zo,ss,Mn!==void 0?Mn:at.collisionBoxArray.length,Mn!==void 0?Mn+1:at.collisionBoxArray.length,Rn!==void 0?Rn:at.collisionBoxArray.length,Rn!==void 0?Rn+1:at.collisionBoxArray.length,Qt!==void 0?Qt:at.collisionBoxArray.length,Qt!==void 0?Qt+1:at.collisionBoxArray.length,ai||at.collisionBoxArray.length,ai?ai+1:at.collisionBoxArray.length,Ii,fr,yi,Ui,Ki,Zs,0,Bo,as,Jr,0,Ws?1:0,Fi)})(r,_t,ft,He,n,a,p,u,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,$e,W,w,0,nt,Ue,U,e,m,I,S,D,O,N,V,qe,K,le)};if(X==="line")for(let He of P0(e.geometry,0,0,rt,rt)){let _t=S3(He,je,Ye,n.vertical||Le,a,pe,ke,r.overscaling,rt);for(let bt of _t)Le&&z3(r,Le.text,Xe,bt)||Qe(He,bt,D)}else if(X==="line-center"){for(let He of e.geometry)if(He.length>1){let _t=I3(He,Ye,n.vertical||Le,a,pe,ke);_t&&Qe(He,_t,D)}}else if(e.type==="Polygon")for(let He of p_(e.geometry,0)){let _t=A3(He,16);Qe(He[0],new yc(_t.x,_t.y,0,0,void 0),D)}else if(e.type==="LineString")for(let He of e.geometry)Qe(He,new yc(He[0].x,He[0].y,0,0,void 0),D);else if(e.type==="Point")for(let He of e.geometry)for(let _t of He)Qe([_t],new yc(_t.x,_t.y,0,0,void 0),D)}let P_=255,vc=P_*$a;function IR(r,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W){let X=(function(re,de,pe,ge,Le,Te,ke,je){let $e=[];if(de.positionedLines.length===0)return $e;let nt=ge.layout.get("text-rotate").evaluate(Te,{})*Math.PI/180,Ye=(function(qe){let Qe=qe[0],He=qe[1],_t=Qe*He;return _t>0?[Qe,-He]:_t<0?[-Qe,He]:Qe===0?[He,Qe]:[He,-Qe]})(pe),Ue=Math.abs(de.top-de.bottom);for(let qe of de.positionedLines)Ue-=qe.lineOffset;let Xe=de.positionedLines.length,Re=Ue/Xe,Ae=de.top-pe[1];for(let qe=0;qe<Xe;++qe){let Qe=de.positionedLines[qe];Ae=C3(de,Re,Ae,qe);for(let He of Qe.positionedGlyphs){if(!He.rect)continue;let _t=He.rect||{},bt=QM+1,ft=!0,at=1,Gt=0;if(He.image){let It=ke.get(He.image.toString());if(!It)continue;if(It.sdf){Rt("SDF images are not supported in formatted text and will be ignored.");continue}ft=!1,at=It.pixelRatio,bt=ph/at}let ut=(Le||je)&&He.vertical,Mt=He.metrics.advance*He.scale/2,Zt=He.metrics,an=He.rect;if(an===null)continue;je&&de.verticalizable&&(Gt=He.image?Mt-He.metrics.width*He.scale/2:0);let En=Le?[He.x+Mt,He.y]:[0,0],Yt=[0,0],Cn=[0,0],An=!1;Le||(ut?(Cn=[He.x+Mt+Ye[0],He.y+Ye[1]-Gt],An=!0):Yt=[He.x+Mt+pe[0],He.y+pe[1]-Gt]);let Ii=an.w*He.scale/(at*(He.localGlyph?Ga:1)),oe=an.h*He.scale/(at*(He.localGlyph?Ga:1)),te,Ne,st,ze;if(ut){let It=He.y-Ae,Jt=new Ze(-Mt,Mt-It),Ft=-Math.PI/2,Et=new Ze(...Cn);te=new Ze(-Mt+Yt[0],Yt[1]),te._rotateAround(Ft,Jt)._add(Et),te.x+=-It+Mt,te.y-=(Zt.left-bt)*He.scale;let Dn=He.image?Zt.advance*He.scale:Nr*He.scale,Kn=String.fromCodePoint(He.glyph);c3(Kn)?te.x+=(1-bt)*He.scale:u3(Kn)?te.x+=Dn-Zt.height*He.scale+(-bt-1)*He.scale:te.x+=He.image||Zt.width+2*bt===an.w&&Zt.height+2*bt===an.h?(Dn-oe)/2:(Dn-(Zt.height+2*bt)*He.scale)/2,Ne=new Ze(te.x,te.y-Ii),st=new Ze(te.x+oe,te.y),ze=new Ze(te.x+oe,te.y-Ii)}else{let It=(Zt.left-bt)*He.scale-Mt+Yt[0],Jt=(-Zt.top-bt)*He.scale+Yt[1],Ft=It+Ii,Et=Jt+oe;te=new Ze(It,Jt),Ne=new Ze(Ft,Jt),st=new Ze(It,Et),ze=new Ze(Ft,Et)}if(nt){let It;It=Le?new Ze(0,0):An?new Ze(Ye[0],Ye[1]):new Ze(pe[0],pe[1]),te._rotateAround(nt,It),Ne._rotateAround(nt,It),st._rotateAround(nt,It),ze._rotateAround(nt,It)}let lt=new Ze(0,0),Dt=new Ze(0,0);$e.push({tl:te,tr:Ne,bl:st,br:ze,texPrimary:_t,texSecondary:void 0,writingMode:de.writingMode,glyphOffset:En,sectionIndex:He.sectionIndex,isSDF:ft,pixelOffsetTL:lt,pixelOffsetBR:Dt,minFontScaleX:0,minFontScaleY:0})}}return $e})(0,a,b,p,m,_,u,r.allowVerticalPlacement),K=r.textSizeData,le=null;K.kind==="source"?(le=[$a*p.layout.get("text-size").evaluate(_,{},V)*O.textScaleFactor],le[0]>vc&&Rt(`${r.layerIds[0]}: Value for "text-size" is >= ${P_}. Reduce your "text-size".`)):K.kind==="composite"&&(le=[$a*O.compositeTextSizes[0].evaluate(_,{},V)*O.textScaleFactor,$a*O.compositeTextSizes[1].evaluate(_,{},V)*O.textScaleFactor],(le[0]>vc||le[1]>vc)&&Rt(`${r.layerIds[0]}: Value for "text-size" is >= ${P_}. Reduce your "text-size".`)),r.addSymbols(r.text,X,le,b,m,_,I,e,n,w.lineStartIndex,w.lineLength,P,N,V,W,!1,U,X.length);for(let re of S)D[re]=r.text.placedSymbolArray.length-1;return 4*X.length}function oT(r){for(let e in r)return r[e];return null}function J0(r,e,n,a,u,p,m,_,b,w,I){let S,D,P,O;if(S=I?I.top:m.top,D=I?I.bottom:m.bottom,P=I?I.left:m.left,O=I?I.right:m.right,oR(m)&&m.collisionPadding){let N=m.collisionPadding;P-=N[0],S-=N[1],O+=N[2],D+=N[3]}if(b){let N=new Ze(P,S),V=new Ze(O,S),U=new Ze(P,D),W=new Ze(O,D),X=gn(b),K=new Ze(0,0);w&&(K=new Ze(w[0],w[1])),N._rotateAround(X,K),V._rotateAround(X,K),U._rotateAround(X,K),W._rotateAround(X,K),P=Math.min(N.x,V.x,U.x,W.x),O=Math.max(N.x,V.x,U.x,W.x),S=Math.min(N.y,V.y,U.y,W.y),D=Math.max(N.y,V.y,U.y,W.y)}return r.emplaceBack(e.x,e.y,e.z,n.x,n.y,P,S,O,D,_,a,u,p),r.length-1}function sT(r){oR(r)&&r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);let e=r.bottom-r.top;return e>0?Math.max(10,e):null}function z3(r,e,n,a){let u=r.compareText;if(e in u){let p=u[e];for(let m=p.length-1;m>=0;m--)if(a.dist(p[m])<n)return!0}else u[e]=[];return u[e].push(a),!1}function SR(r,e){let n=r.fovAboveCenter,a=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,u=(r._camera.position[2]*r.worldSize-a)/Math.cos(r._pitch),p=Math.sin(n)*u/Math.sin(Math.max(Math.PI/2-r._pitch-n,.01)),m=Math.sin(r._pitch)*p+u,_=u*(1/r._horizonShift);if(!r.elevation||r.elevation.exaggeration()===0){let b=Math.max(r.zoom-17,0);r.isOrthographic&&(b/=10),m*=1+b}return Math.min(1.01*m,_)}function O_(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};let n=Math.pow(2,-r.z),a=r.x*n,u=(r.x+1)*n,p=r.y*n,m=(r.y+1)*n,_=J(a),b=J(u),w=Y(p),I=Y(m),S=e.project(_,w),D=e.project(b,w),P=e.project(b,I),O=e.project(_,I),N=Math.min(S.x,D.x,P.x,O.x),V=Math.min(S.y,D.y,P.y,O.y),U=Math.max(S.x,D.x,P.x,O.x),W=Math.max(S.y,D.y,P.y,O.y),X=n/16;function K(re,de,pe,ge,Le,Te){let ke=(pe+Le)/2,je=(ge+Te)/2,$e=e.project(J(ke),Y(je)),nt=Math.max(0,N-$e.x,V-$e.y,$e.x-U,$e.y-W);N=Math.min(N,$e.x),U=Math.max(U,$e.x),V=Math.min(V,$e.y),W=Math.max(W,$e.y),nt>X&&(K(re,$e,pe,ge,ke,je),K($e,de,ke,je,Le,Te))}K(S,D,a,p,u,p),K(D,P,u,p,u,m),K(P,O,u,m,a,m),K(O,S,a,m,a,p),N-=X,V-=X,U+=X,W+=X;let le=1/Math.max(U-N,W-V);return{scale:le,x:N*le,y:V*le,x2:U*le,y2:W*le,projection:e}}function DR(r,{x:e,y:n},a=0){return new Ze(((e-a)*r.scale-r.x)*rt,(n*r.scale-r.y)*rt)}let B3=yt(new Float32Array(16));class Fu{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,n){return{x:0,y:0,z:0}}unproject(e,n){return new L(0,0)}projectTilePoint(e,n,a){return{x:e,y:n,z:0}}locationPoint(e,n,a,u=!0){return e._coordinatePoint(e.locationCoordinate(n,a),u)}pixelsPerMeter(e,n){return Z(1,e)*n}pixelSpaceConversion(e,n,a){return 1}farthestPixelDistance(e){return SR(e,e.pixelsPerMeter)}pointCoordinate(e,n,a,u){let p=e.horizonLineFromTop(!1),m=new Ze(n,Math.max(p,a));return e.rayIntersectionCoordinate(e.pointRayIntersection(m,u))}pointCoordinate3D(e,n,a){let u=new Ze(n,a);if(e.elevation)return e.elevation.pointCoordinate(u);{let p=this.pointCoordinate(e,u.x,u.y,0);return[p.x,p.y,p.z]}}isPointAboveHorizon(e,n){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,n.x,n.y);let a=e.horizonLineFromTop();return n.y<a}createInversionMatrix(e,n){return B3}createTileMatrix(e,n,a){let u,p,m,_=a.canonical,b=yt(new Float64Array(16));if(this.isReprojectedInTileSpace){let w=O_(_,this);u=1,p=w.x+a.wrap*w.scale,m=w.y,qn(b,b,[u/w.scale,u/w.scale,e.pixelsPerMeter/n])}else u=n/e.zoomScale(_.z),p=(_.x+Math.pow(2,_.z)*a.wrap)*u,m=_.y*u;return Lt(b,b,[p,m,0]),qn(b,b,[u/rt,u/rt,1]),b}upVector(e,n,a){return[0,0,1]}upVectorScale(e,n,a){return{metersToTile:1}}}class V3 extends Fu{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];let[n,a]=this.parallels=e.parallels||[29.5,45.5],u=Math.sin(gn(n));this.n=(u+Math.sin(gn(a)))/2,this.c=1+u*(2*this.n-u),this.r0=Math.sqrt(this.c)/this.n}project(e,n){let{n:a,c:u,r0:p}=this,m=gn(e-this.center[0]),_=gn(n),b=Math.sqrt(u-2*a*Math.sin(_))/a;return{x:b*Math.sin(m*a),y:b*Math.cos(m*a)-p,z:0}}unproject(e,n){let{n:a,c:u,r0:p}=this,m=p+n,_=Math.atan2(e,Math.abs(m))*Math.sign(m);m*a<0&&(_-=Math.PI*Math.sign(e)*Math.sign(m));let b=gn(this.center[0])*a;_=fe(_,-Math.PI-b,Math.PI-b);let w=G(eo(_/a)+this.center[0],-180,180),I=Math.asin(G((u-(e*e+m*m)*a*a)/(2*a),-1,1)),S=G(eo(I),-Q,Q);return new L(w,S)}}let L_=1.340264,F_=-.081106,k_=893e-6,N_=.003796,Q0=Math.sqrt(3)/2;class j3 extends Fu{project(e,n){n=n/180*Math.PI,e=e/180*Math.PI;let a=Math.asin(Q0*Math.sin(n)),u=a*a,p=u*u*u;return{x:.5*(e*Math.cos(a)/(Q0*(L_+3*F_*u+p*(7*k_+9*N_*u)))/Math.PI+.5),y:1-.5*(a*(L_+F_*u+p*(k_+N_*u))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let a=n=(2*(1-n)-1)*Math.PI,u=a*a,p=u*u*u;for(let I,S,D,P=0;P<12&&(S=a*(L_+F_*u+p*(k_+N_*u))-n,D=L_+3*F_*u+p*(7*k_+9*N_*u),I=S/D,a=G(a-I,-Math.PI/3,Math.PI/3),u=a*a,p=u*u*u,!(Math.abs(I)<1e-12));++P);let m=Q0*e*(L_+3*F_*u+p*(7*k_+9*N_*u))/Math.cos(a),_=Math.asin(Math.sin(a)/Q0),b=G(180*m/Math.PI,-180,180),w=G(180*_/Math.PI,-Q,Q);return new L(b,w)}}class U3 extends Fu{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){return{x:.5+e/360,y:.5-n/360,z:0}}unproject(e,n){let a=360*(e-.5),u=G(360*(.5-n),-Q,Q);return new L(a,u)}}let Dp=Math.PI/2;function ex(r){return Math.tan((Dp+r)/2)}class H3 extends Fu{constructor(e){super(e),this.center=e.center||[0,30];let[n,a]=this.parallels=e.parallels||[30,30],u=gn(n),p=gn(a);this.southernCenter=u+p<0,this.southernCenter&&(u=-u,p=-p);let m=Math.cos(u),_=ex(u);this.n=u===p?Math.sin(u):Math.log(m/Math.cos(p))/Math.log(ex(p)/_),this.f=m*Math.pow(ex(u),this.n)/this.n}project(e,n){n=gn(n),this.southernCenter&&(n=-n),e=gn(e-this.center[0]);let a=1e-6,{n:u,f:p}=this;p>0?n<-Dp+a&&(n=-Dp+a):n>Dp-a&&(n=Dp-a);let m=p/Math.pow(ex(n),u),_=m*Math.sin(u*e),b=p-m*Math.cos(u*e);return _=.5*(_/Math.PI+.5),b=.5*(b/Math.PI+.5),{x:_,y:this.southernCenter?b:1-b,z:0}}unproject(e,n){e=(2*e-.5)*Math.PI,this.southernCenter&&(n=1-n),n=(2*(1-n)-.5)*Math.PI;let{n:a,f:u}=this,p=u-n,m=Math.sign(p),_=Math.sign(a)*Math.sqrt(e*e+p*p),b=Math.atan2(e,Math.abs(p))*m;p*a<0&&(b-=Math.PI*Math.sign(e)*m);let w=G(eo(b/a)+this.center[0],-180,180),I=G(eo(2*Math.atan(Math.pow(u/_,1/a))-Dp),-Q,Q);return new L(w,this.southernCenter?-I:I)}}class CR extends Fu{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,n){return{x:q(e),y:$(n),z:0}}unproject(e,n){let a=J(e),u=Y(n);return new L(a,u)}}let AR=gn(Q);class $3 extends Fu{project(e,n){let a=(n=gn(n))*n,u=a*a;return{x:.5*((e=gn(e))*(.8707-.131979*a+u*(u*(.003971*a-.001529*u)-.013791))/Math.PI+.5),y:1-.5*(n*(1.007226+a*(.015085+u*(.028874*a-.044475-.005916*u)))/Math.PI+1),z:0}}unproject(e,n){e=(2*e-.5)*Math.PI;let a=n=(2*(1-n)-1)*Math.PI,u=25,p=0,m=a*a;do{m=a*a;let w=m*m;p=(a*(1.007226+m*(.015085+w*(.028874*m-.044475-.005916*w)))-n)/(1.007226+m*(.045255+w*(.259866*m-.311325-.005916*11*w))),a=G(a-p,-AR,AR)}while(Math.abs(p)>1e-6&&--u>0);m=a*a;let _=G(eo(e/(.8707+m*(m*(m*m*m*(.003971-.001529*m)-.013791)-.131979))),-180,180),b=eo(a);return new L(_,b)}}let MR=gn(Q);class G3 extends Fu{project(e,n){n=gn(n),e=gn(e);let a=Math.cos(n),u=2/Math.PI,p=Math.acos(a*Math.cos(e/2)),m=Math.sin(p)/p,_=.5*(e*u+2*a*Math.sin(e/2)/m)||0,b=.5*(n+Math.sin(n)/m)||0;return{x:.5*(_/Math.PI+.5),y:1-.5*(b/Math.PI+1),z:0}}unproject(e,n){let a=e=(2*e-.5)*Math.PI,u=n=(2*(1-n)-1)*Math.PI,p=25,m=1e-6,_=0,b=0;do{let w=Math.cos(u),I=Math.sin(u),S=2*I*w,D=I*I,P=w*w,O=Math.cos(a/2),N=Math.sin(a/2),V=2*O*N,U=N*N,W=1-P*O*O,X=W?1/W:0,K=W?Math.acos(w*O)*Math.sqrt(1/W):0,le=.5*(2*K*w*N+2*a/Math.PI)-e,re=.5*(K*I+u)-n,de=.5*X*(P*U+K*w*O*D)+1/Math.PI,pe=X*(V*S/4-K*I*N),ge=.125*X*(S*N-K*I*P*V),Le=.5*X*(D*O+K*U*w)+.5,Te=pe*ge-Le*de;_=(re*pe-le*Le)/Te,b=(le*ge-re*de)/Te,a=G(a-_,-Math.PI,Math.PI),u=G(u-b,-MR,MR)}while((Math.abs(_)>m||Math.abs(b)>m)&&--p>0);return new L(eo(a),eo(u))}}class RR extends Fu{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(gn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,n){let{scale:a,cosPhi:u}=this;return{x:gn(e)*u*a+.5,y:-Math.sin(gn(n))/u*a+.5,z:0}}unproject(e,n){let{scale:a,cosPhi:u}=this,p=-(n-.5)/a,m=G(eo((e-.5)/a)/u,-180,180),_=Math.asin(G(p*u,-1,1)),b=G(eo(_),-Q,Q);return new L(m,b)}}class q3 extends CR{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,n,a){let u=l_(e,n,a);return ki(u,u,E0(El(a))),{x:u[0],y:u[1],z:u[2]}}locationPoint(e,n,a){let u=T(n.lat,n.lng),p=li([],u),m=a?e._centerAltitude+a:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(n),e._centerAltitude):e._centerAltitude;Bs(u,u,p,Z(1,0)*rt*m);let _=yt(new Float64Array(16));return At(_,e.pixelMatrix,e.globeMatrix),ki(u,u,_),new Ze(u[0],u[1])}pixelsPerMeter(e,n){return Z(1,0)*n}pixelSpaceConversion(e,n,a){let u=Z(1,e)*n,p=zt(Z(1,45)*n,u,a);return this.pixelsPerMeter(e,n)/p}createTileMatrix(e,n,a){let u=hE(El(a.canonical));return At(new Float64Array(16),e.globeMatrix,u)}createInversionMatrix(e,n){let{center:a}=e,u=E0(El(n));return Vi(u,u,gn(a.lng)),Sr(u,u,gn(a.lat)),qn(u,u,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(u)}pointCoordinate(e,n,a,u){return tA(e,n,a,!0)||new be(0,0)}pointCoordinate3D(e,n,a){let u=this.pointCoordinate(e,n,a,0);return[u.x,u.y,u.z]}isPointAboveHorizon(e,n){return!tA(e,n.x,n.y,!1)}farthestPixelDistance(e){let n=(function(u,p){let m=u.cameraToCenterDistance,_=u._centerAltitude*p,b=u._camera,w=u._camera.forward(),I=or([],Mi([],w,-m),[0,0,_]),S=u.worldSize/(2*Math.PI),D=[0,0,-S],P=u.width/u.height,O=Math.tan(u.fovAboveCenter),N=Mi([],b.up(),O),V=Mi([],b.right(),O*P),U=li([],or([],or([],w,N),V)),W=[],X;if(new en(I,U).closestPointOnSphere(D,S,W)){let K=or([],W,D),le=tr([],K,I);X=Math.cos(u.fovAboveCenter)*Qr(le)}else{let K=tr([],I,D),le=tr([],D,I);li(le,le);let re=Qr(K)-S;X=Math.sqrt(re*(re+2*S));let de=Math.acos(X/(S+re))-Math.acos(sr(w,le));X*=Math.cos(de)}return 1.01*X})(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),a=Ru(e.zoom);if(a>0){let u=SR(e,Z(1,e.center.lat)*e.worldSize),p=e.worldSize/(2*Math.PI),m=Math.max(e.width,e.height)/e.worldSize*Math.PI;return zt(n,u+p*(1-Math.cos(m)),Math.pow(a,10))}return n}upVector(e,n,a){return l_(n,a,e,1)}upVectorScale(e){return{metersToTile:x0(w0(El(e)))}}}function PR(r){let e=r.parallels,n=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new CR(r);case"equirectangular":return new U3(r);case"naturalEarth":return new $3(r);case"equalEarth":return new j3(r);case"winkelTripel":return new G3(r);case"albers":return n?new RR(r):new V3(r);case"lambertConformalConic":return n?new RR(r):new H3(r);case"globe":return new q3(r)}throw new Error(`Invalid projection name: ${r.name}`)}let W3=Ge.types,Z3=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function z_(r,e,n,a,u,p,m,_,b,w,I,S,D){let P=_?Math.min(vc,Math.round(_[0])):0,O=_?Math.min(vc,Math.round(_[1])):0;r.emplaceBack(e,n,Math.round(32*a),Math.round(32*u),p,m,(P<<1)+(b?1:0),0+(O<<1),16*w,16*I,256*S,256*D)}function B_(r,e,n){r.emplaceBack(e,n)}function V_(r,e,n,a,u,p,m){r.emplaceBack(e,n,a,u,p,m)}let tx=(r,e,n,a)=>{for(let u=0;u<e;u++)r.emplaceBack(n[0],n[1],n[2],a[0],a[1],a[2])};function Cp(r,e,n,a,u){r.emplaceBack(e,n,a,u),r.emplaceBack(e,n,a,u),r.emplaceBack(e,n,a,u),r.emplaceBack(e,n,a,u)}function X3(r){for(let e of r.sections)if(X1(e.text))return!0;return!1}class aT{constructor(e){this.layoutVertexArray=new np,this.indexArray=new wi,this.programConfigurations=e,this.segments=new Ci,this.dynamicLayoutVertexArray=new bl,this.opacityVertexArray=new qg,this.placedSymbolArray=new rh,this.iconTransitioningVertexArray=new Ss,this.globeExtVertexArray=new wu,this.zOffsetVertexArray=new Ba,this.orientationVertexArray=new Xg,this.symbolInstanceIndices=[]}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}getIconVertexData(e,n){let a=[],u=this.layoutVertexArray.uint16;for(let p=0;p<n;++p){let m=12*(e+p);a.push(...u.slice(m,m+12))}return a}updateIconVertexData(e,n,a,u,p,m,_,b,w,I,S,D,P){let O=this.layoutVertexArray.uint16,N=12*e;O[N]=n,O[N+1]=a,O[N+2]=u,O[N+3]=p,O[N+4]=m,O[N+5]=_,O[N+6]=b,O[N+7]=w,O[N+8]=I,O[N+9]=S,O[N+10]=D,O[N+11]=P}upload(e,n,a,u,p,m){this.isEmpty()||(a&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,QB.members,!!m),this.indexBuffer=e.createIndexBuffer(this.indexArray,n),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,t3.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,Z3,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,r3.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,e3.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||p)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,n3.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,i3.members,!0)),this.opacityVertexBuffer.itemSize=1),(a||u)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}vt(aT,"SymbolBuffers");class lT{constructor(e,n,a){this.layoutVertexArray=new e,this.layoutAttributes=n,this.indexArray=new a,this.segments=new Ci,this.collisionVertexArray=new Tu,this.collisionVertexArrayExt=new bl}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,o3.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,s3.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}vt(lT,"CollisionBuffers");class nx{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(m=>m.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=yt([]),this.placementViewportMatrix=yt([]);let n=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=Ep(this.zoom,n["text-size"],this.worldview),this.iconSizeData=Ep(this.zoom,n["icon-size"],this.worldview);let a=this.layers[0].layout,u=a.get("symbol-sort-key"),p=a.get("symbol-z-order");this.lut=e.lut,this.canOverlap=a.get("text-allow-overlap")||a.get("icon-allow-overlap")||a.get("text-ignore-placement")||a.get("icon-ignore-placement"),this.sortFeaturesByKey=p!=="viewport-y"&&u.constantOr(1)!==void 0,this.sortFeaturesByY=(p==="viewport-y"||p==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=a.get("text-writing-mode").map(m=>os[m]),this.stateDependentLayerIds=this.layers.filter(m=>m.isStateDependent()).map(m=>m.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1,this.hasAppearances=null,this.lastActiveApperance=null}hasAnyAppearanceProperty(e){let n=this.layers[0].getAppearances();return!(!n||n.length===0)&&n.some(a=>a.getProperty(e)!=null)}createArrays(){this.text=new aT(new Gs(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new aT(new Gs(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new n_,this.lineVertexArray=new u0,this.symbolInstances=new c0}calculateGlyphDependencies(e,n,a,u,p){for(let m of e){let _=m.codePointAt(0);if(_===void 0)break;if(n[_]=!0,u&&p&&_<=65535){let b=D_[m];b&&(n[b.charCodeAt(0)]=!0)}}}calculateEffectiveAppearanceIconSize(e,n,a,u,p,m){let _=1,b=e.getUnevaluatedProperties()._values["icon-size"],w=Ep(this.zoom,b,this.worldview),I=Tp(w,n);if(w.kind!=="constant"&&w.kind!=="camera"||(_=I.uSize),w.kind==="composite"){let{minZoom:S,maxZoom:D}=w,P=b.possiblyEvaluate(new ci(S,{worldview:this.worldview}),u),O=b.possiblyEvaluate(new ci(D,{worldview:this.worldview}),u),N=P.evaluate(a,{},u,p);_=N+(O.evaluate(a,{},u,p)-N)*I.uSizeT}return w.kind==="source"&&(_=b.possiblyEvaluate(new ci(this.zoom,{worldview:this.worldview}),u).evaluate(a,{},u,p)),_*m}updateFootprints(e,n){}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let a=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!A0(this.activeReplacements,a)&&(this.activeReplacements=a,!0)}getResolvedImageFromTokens(e){return typeof e=="string"?Eo.build(e):e}populate(e,n,a,u){let p=this.layers[0],m=p.layout,_=this.projection.name==="globe",b=m.get("text-font"),w=m.get("text-field"),I=m.get("icon-image"),[S,D]=m.get("icon-size-scale-range"),P=G(n.scaleFactor||1,S,D),O=(w.value.kind!=="constant"||w.value.value instanceof Dr&&!w.value.value.isEmpty()||w.value.value.toString().length>0)&&(b.value.kind!=="constant"||b.value.value.length>0),N=I.value.kind!=="constant"||!!I.value.value||Object.keys(I.parameters).length>0,V=this.hasAnyAppearanceProperty("icon-image"),U=m.get("symbol-sort-key");if(this.features=[],this.appearanceFeatureData=[],!O&&!N&&!V)return;let W=n.iconDependencies,X=n.glyphDependencies,K=n.availableImages,le=new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),re=de=>{let pe=de.id.toString();W.has(pe)?W.get(pe).push(de):W.set(pe,[de])};for(let de of e){let{feature:pe,id:ge,index:Le,sourceLayerIndex:Te}=de,ke=p._featureFilter.needGeometry,je=De(pe,ke);if(!p._featureFilter.filter(le,je,a))continue;if(ke||(je.geometry=Ve(pe,a,u)),_&&pe.type!==1&&a.z<=5){let qe=je.geometry,Qe=.98078528056,He=(_t,bt)=>sr(l_(_t.x,_t.y,a,1),l_(bt.x,bt.y,a,1))<Qe;for(let _t=0;_t<qe.length;_t++)qe[_t]=Be(qe[_t],He)}let $e,nt;if(O){let qe=p.getValueAndResolveTokens("text-field",je,a,K),Qe=Dr.factory(qe);X3(Qe)&&(this.hasRTLText=!0),(!this.hasRTLText||Ng()==="unavailable"||this.hasRTLText&&No.isParsed())&&($e=l3(Qe,p,je))}if(N){let qe=p.getValueAndResolveTokens("icon-image",je,a,K);nt=this.getResolvedImageFromTokens(qe)}let Ye=this.layers[0],Ue=!1;if(!nt&&V){let qe=Ye.getAppearances();for(let Qe of qe)if(Qe.getProperty("icon-image")){let He=Ye.getAppearanceValueAndResolveTokens(Qe,"icon-image",je,a,K);if(He){nt=this.getResolvedImageFromTokens(He),Ue=!0;break}}}if(!$e&&!nt)continue;let Xe=this.sortFeaturesByKey?U.evaluate(je,{},a):void 0,Re={id:ge,text:$e,icon:nt,index:Le,sourceLayerIndex:Te,geometry:je.geometry,properties:pe.properties,type:W3[pe.type],sortKey:Xe};if(this.features.push(Re),this.appearanceFeatureData.push({id:ge,properties:pe.properties,usesAppearanceIconAsPlaceholder:Ue,isUsingAppearanceVertexData:!1,layoutBasedVertexData:[],activeAppearance:null}),nt){let qe=Ye._unevaluatedLayout._values,{iconPrimary:Qe,iconSecondary:He}=R_(nt,this.iconSizeData,qe["icon-size"],a,this.zoom,Re,this.pixelRatio,P,this.worldview);re(Qe),He&&(this.hasAnySecondaryIcon=!0,re(He))}let Ae=Ye.getAppearances();if(Ae.length!==0&&Ae.forEach(qe=>{if(!qe.getProperty("icon-image"))return;let Qe=this.getCombinedIconPrimary(qe,Ye,je,a,K,Re,P);Qe&&re(Qe)}),$e){let qe=b.evaluate(je,{},a).join(","),Qe=m.get("text-rotation-alignment")==="map"&&m.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(os.vertical)>=0;for(let He of $e.sections)if(He.image){let _t=He.image.getPrimary().scaleSelf(this.pixelRatio),bt=_t.id.toString(),ft=W.get(bt)||[];ft.push(_t),W.set(bt,ft)}else{let _t=Rg($e.toString()),bt=He.fontStack||qe,ft=X[bt]=X[bt]||{};this.calculateGlyphDependencies(He.text,ft,Qe,this.allowVerticalPlacement,_t)}}}if(m.get("symbol-placement")==="line"&&(this.features=(function(de){let pe={},ge={},Le=[],Te=0;function ke(Ye){Le.push(de[Ye]),Te++}function je(Ye,Ue,Xe){let Re=ge[Ye];return delete ge[Ye],ge[Ue]=Re,Le[Re].geometry[0].pop(),Le[Re].geometry[0]=Le[Re].geometry[0].concat(Xe[0]),Re}function $e(Ye,Ue,Xe){let Re=pe[Ue];return delete pe[Ue],pe[Ye]=Re,Le[Re].geometry[0].shift(),Le[Re].geometry[0]=Xe[0].concat(Le[Re].geometry[0]),Re}function nt(Ye,Ue,Xe){let Re=Xe?Ue[0][Ue[0].length-1]:Ue[0][0];return`${Ye}:${Re.x}:${Re.y}`}for(let Ye=0;Ye<de.length;Ye++){let Ue=de[Ye],Xe=Ue.geometry,Re=Ue.text?Ue.text.toString():null;if(!Re){ke(Ye);continue}let Ae=nt(Re,Xe),qe=nt(Re,Xe,!0);if(Ae in ge&&qe in pe&&ge[Ae]!==pe[qe]){let Qe=$e(Ae,qe,Xe),He=je(Ae,qe,Le[Qe].geometry);delete pe[Ae],delete ge[qe],ge[nt(Re,Le[He].geometry,!0)]=He,Le[Qe].geometry=null}else Ae in ge?je(Ae,qe,Xe):qe in pe?$e(Ae,qe,Xe):(ke(Ye),pe[Ae]=Te-1,ge[qe]=Te-1)}return Le.filter(Ye=>Ye.geometry)})(this.features)),m.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",n.elevationFeatures){!this.elevationFeatures&&n.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(let de of n.elevationFeatures)this.elevationFeatureIdToIndex.set(de.id,this.elevationFeatures.length),this.elevationFeatures.push(de)}}else m.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((de,pe)=>de.sortKey-pe.sortKey)}getCombinedIconPrimary(e,n,a,u,p,m,_){let b,w,I=e.getUnevaluatedProperties();if(I._values["icon-image"].value!==void 0){let S=n.getAppearanceValueAndResolveTokens(e,"icon-image",a,u,p);b=this.getResolvedImageFromTokens(S)}else{let S=n.getValueAndResolveTokens("icon-image",a,u,p);b=this.getResolvedImageFromTokens(S)}if(b){let S=I._values["icon-size"]||n._unevaluatedLayout._values["icon-size"];w=R_(b,Ep(this.zoom,S,this.worldview),S,u,this.zoom,m,this.pixelRatio,_,this.worldview).iconPrimary}return w}updateAppearanceBasedIconTextures(e,n,a,u){if(!this.appearanceFeatureData||!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)return!1;let p=this.layers[0],m=!1,_=0,b=p.layout,[w,I]=b.get("icon-size-scale-range"),S=G(1,w,I);for(let D=0;D<this.symbolInstances.length;D++){let P=this.symbolInstances.get(D),O=this.appearanceFeatureData[P.featureIndex];if(O&&P.placedIconSymbolIndex>=0){let N=O.id,V=n&&N!==void 0?n[String(N)]:void 0,U={type:"Point",id:O.id,properties:O.properties,geometry:[]},W=this.layers[0].appearances&&this.layers[0].appearances.find(X=>X.isActive({globals:u,feature:U,canonical:e,featureState:V}));if(O.activeAppearance===W)continue;if(W){O.activeAppearance=W;let X={sortKey:void 0,text:void 0,icon:null,index:P.featureIndex,sourceLayerIndex:P.featureIndex,geometry:[],properties:O.properties,type:"Point",id:O.id};if(!W.hasCachedIconPrimary()){let de=this.getCombinedIconPrimary(W,p,U,e,a,X,S);W.setCachedIconPrimary(de)}let K=W.getCachedIconPrimary();if(!K)continue;let le=K.toString(),re=this.iconAtlasPositions&&this.iconAtlasPositions.get(le);if(re){let de=p.getAppearanceValueAndResolveTokens(W,"icon-offset",U,e,a),pe=de&&Array.isArray(de)?de:[0,0],ge=q0(re,void 0,pe,p.layout.get("icon-anchor").evaluate(U,{},e)),Le=p.getAppearanceValueAndResolveTokens(W,"icon-rotate",U,e,a),Te=typeof Le=="number"?Le:0,ke=re.sdf,je=p.layout.get("icon-text-fit").constantOr("none");je!=="none"&&O.textShaping&&O.iconTextFitPadding&&O.fontScale&&(ge=JE(ge,O.textShaping,je,O.iconTextFitPadding,pe,O.fontScale));let $e=this.calculateEffectiveAppearanceIconSize(W,u.zoom,U,e,a,S),nt=0,Ye=1+(Math.min(vc,Math.round($e*$a))<<1),Ue=nT(ge,Te,ke,je!=="none",S);O.isUsingAppearanceVertexData||(O.isUsingAppearanceVertexData=!0,O.layoutBasedVertexData=this.icon.getIconVertexData(_,P.numIconVertices));for(let Re=0;Re<Ue.length;++Re){let Ae=Ue[Re],qe=O.layoutBasedVertexData[0]||P.tileAnchorX,Qe=O.layoutBasedVertexData[1]||P.tileAnchorY,He=16*Ae.pixelOffsetTL.x,_t=16*Ae.pixelOffsetTL.y,bt=16*Ae.pixelOffsetBR.x,ft=16*Ae.pixelOffsetBR.y,at=16*Ae.minFontScaleX,Gt=16*Ae.minFontScaleY;this.icon.updateIconVertexData(_,qe,Qe,Math.round(32*Ae.tl.x),Math.round(32*Ae.tl.y),Ae.texPrimary.x,Ae.texPrimary.y,nt,Ye,He,_t,at,Gt),this.icon.updateIconVertexData(_+1,qe,Qe,Math.round(32*Ae.tr.x),Math.round(32*Ae.tr.y),Ae.texPrimary.x+Ae.texPrimary.w,Ae.texPrimary.y,nt,Ye,bt,_t,at,Gt),this.icon.updateIconVertexData(_+2,qe,Qe,Math.round(32*Ae.bl.x),Math.round(32*Ae.bl.y),Ae.texPrimary.x,Ae.texPrimary.y+Ae.texPrimary.h,nt,Ye,He,ft,at,Gt),this.icon.updateIconVertexData(_+3,qe,Qe,Math.round(32*Ae.br.x),Math.round(32*Ae.br.y),Ae.texPrimary.x+Ae.texPrimary.w,Ae.texPrimary.y+Ae.texPrimary.h,nt,Ye,bt,ft,at,Gt),_+=4}let Xe=P.numIconVertices-4*Ue.length;for(let Re=0;Re<Xe;++Re)this.icon.updateIconVertexData(_+Re,0,0,0,0,0,0,0,0,0,0,0,0);m=!0}else _+=P.numIconVertices}else if(O.usesAppearanceIconAsPlaceholder)this.layers[0].appearances&&this.layers[0].appearances.length>0&&(this.icon.updateIconVertexData(_,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(_+1,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(_+2,0,0,0,0,0,0,0,0,0,0,0,0),this.icon.updateIconVertexData(_+3,0,0,0,0,0,0,0,0,0,0,0,0),m=!0),_+=P.numIconVertices,O.activeAppearance=null;else if(O.isUsingAppearanceVertexData){let K=O.layoutBasedVertexData.length/12;for(let le=0;le<K;++le){let re=le*12;this.icon.updateIconVertexData(_+le,O.layoutBasedVertexData[re+0],O.layoutBasedVertexData[re+1],O.layoutBasedVertexData[re+2],O.layoutBasedVertexData[re+3],O.layoutBasedVertexData[re+4],O.layoutBasedVertexData[re+5],O.layoutBasedVertexData[re+6],O.layoutBasedVertexData[re+7],O.layoutBasedVertexData[re+8],O.layoutBasedVertexData[re+9],O.layoutBasedVertexData[re+10],O.layoutBasedVertexData[re+11])}_+=K,O.isUsingAppearanceVertexData=!1,O.activeAppearance=null,m=!0}else _+=P.numIconVertices,O.activeAppearance=null}}return m}update(e,n,a,u,p,m,_){this.text.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,n,p,a,u,m,_,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let n=!1,a=ue(e),u=1/a,p=!1,m=!1;for(let _=0;_<this.symbolInstances.length;_++){let b=this.symbolInstances.get(_),w=ji(1,0,0),I=ji(0,1,0),{numHorizontalGlyphVertices:S,numVerticalGlyphVertices:D,numIconVertices:P,numVerticalIconVertices:O}=b,N=S>0||D>0,V=P>0,U=this.elevationFeatures[b.elevationFeatureIndex];if(U){let W=new Ze(b.tileAnchorX,b.tileAnchorY),X=.075+U.pointElevation(W);b.zOffset!==X&&(n=!0,b.zOffset=X),X!==0&&(this.hasAnyZOffset=!0);let K=U.computeSlopeNormal(W,u),le=Gc(cl(),ji(0,0,1),K);Go(w,w,le),Go(I,I,le),w[2]*=a,I[2]*=a,w[0]===1&&w[1]===0&&w[2]===0&&I[0]===0&&I[1]===1&&I[2]===0||(p=p||N,m=m||V)}if(N&&(tx(this.text.orientationVertexArray,S,w,I),tx(this.text.orientationVertexArray,D,w,I)),V){let{placedIconSymbolIndex:W,verticalPlacedIconSymbolIndex:X}=b;W>=0&&tx(this.icon.orientationVertexArray,P,w,I),X>=0&&tx(this.icon.orientationVertexArray,O,w,I)}}p||(this.text.orientationVertexArray=void 0),m||(this.icon.orientationVertexArray=void 0),n&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let e=(p,m,_)=>{a+=m,a>p.length&&p.resize(a);for(let b=-m;b<0;b++)p.emplace(b+a,_)},n=(p,m,_)=>{u+=m,u>p.length&&p.resize(u);for(let b=-m;b<0;b++)p.emplace(b+u,_)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let a=0,u=0;for(let p=0;p<this.symbolInstances.length;p++){let m=this.symbolInstances.get(p),{numHorizontalGlyphVertices:_,numVerticalGlyphVertices:b,numIconVertices:w}=m,I=m.zOffset,S=w>0;if((_>0||b>0)&&(e(this.text.zOffsetVertexArray,_,I),e(this.text.zOffsetVertexArray,b,I)),S){let{placedIconSymbolIndex:D,verticalPlacedIconSymbolIndex:P}=m;D>=0&&n(this.icon.zOffsetVertexArray,w,I),P>=0&&n(this.icon.zOffsetVertexArray,m.numVerticalIconVertices,I)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e,n,a,u,p){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,!1),this.hasAppearances===null&&(this.hasAppearances=this.layers.some(m=>m.appearances&&m.appearances.length>0)),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload,this.hasAppearances),this.uploaded=!0}updateAppearances(e,n,a,u){return!!(e&&n&&a)&&!(!this.icon.layoutVertexArray||this.icon.layoutVertexArray.length===0)&&!!this.icon.layoutVertexArray.arrayBuffer&&void(this.updateAppearanceBasedIconTextures(e,n,a,u)&&this.icon.layoutVertexBuffer&&this.icon.layoutVertexArray.arrayBuffer!==null&&this.icon.layoutVertexArray.length===this.icon.layoutVertexBuffer.length&&this.icon.layoutVertexBuffer.updateData(this.icon.layoutVertexArray))}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=PR(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,n){let a=this.lineVertexArray.length;if(e.segment!==void 0)for(let{x:u,y:p}of n)this.lineVertexArray.emplaceBack(u,p);return{lineStartIndex:a,lineLength:this.lineVertexArray.length-a}}addSymbols(e,n,a,u,p,m,_,b,w,I,S,D,P,O,N,V,U,W){let X=e.indexArray,K=e.layoutVertexArray,le=e.globeExtVertexArray,re=e.segments.prepareSegment(4*W,K,X,this.canOverlap?m.sortKey:void 0),de=this.glyphOffsetArray.length,pe=re.vertexLength,ge=this.allowVerticalPlacement&&_===os.vertical?Math.PI/2:0,Le=m.text&&m.text.sections;for(let je=0;je<n.length;je++){let{tl:$e,tr:nt,bl:Ye,br:Ue,texPrimary:Xe,texSecondary:Re,pixelOffsetTL:Ae,pixelOffsetBR:qe,minFontScaleX:Qe,minFontScaleY:He,glyphOffset:_t,isSDF:bt,sectionIndex:ft}=n[je],at=re.vertexLength,Gt=_t[1];if(z_(K,w.x,w.y,$e.x,Gt+$e.y,Xe.x,Xe.y,a,bt,Ae.x,Ae.y,Qe,He),z_(K,w.x,w.y,nt.x,Gt+nt.y,Xe.x+Xe.w,Xe.y,a,bt,qe.x,Ae.y,Qe,He),z_(K,w.x,w.y,Ye.x,Gt+Ye.y,Xe.x,Xe.y+Xe.h,a,bt,Ae.x,qe.y,Qe,He),z_(K,w.x,w.y,Ue.x,Gt+Ue.y,Xe.x+Xe.w,Xe.y+Xe.h,a,bt,qe.x,qe.y,Qe,He),b){let{x:ut,y:Mt,z:Zt}=b.anchor,[an,En,Yt]=b.up;V_(le,ut,Mt,Zt,an,En,Yt),V_(le,ut,Mt,Zt,an,En,Yt),V_(le,ut,Mt,Zt,an,En,Yt),V_(le,ut,Mt,Zt,an,En,Yt),Cp(e.dynamicLayoutVertexArray,ut,Mt,Zt,ge)}else Cp(e.dynamicLayoutVertexArray,w.x,w.y,w.z,ge);if(V){let ut=Re||Xe;B_(e.iconTransitioningVertexArray,ut.x,ut.y),B_(e.iconTransitioningVertexArray,ut.x+ut.w,ut.y),B_(e.iconTransitioningVertexArray,ut.x,ut.y+ut.h),B_(e.iconTransitioningVertexArray,ut.x+ut.w,ut.y+ut.h)}X.emplaceBack(at,at+1,at+2),X.emplaceBack(at+1,at+2,at+3),re.vertexLength+=4,re.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(_t[0]),je!==n.length-1&&ft===n[je+1].sectionIndex||e.programConfigurations.populatePaintArrays(K.length,m,m.index,{},P,O,N,Le&&Le[ft],this.worldview)}let Te=W-n.length;Te!==0&&this._addNullVertices(Te,K,a,b,le,e,V,re,X);let ke=b?b.anchor:w;e.placedSymbolArray.emplaceBack(ke.x,ke.y,ke.z,w.x,w.y,de,this.glyphOffsetArray.length-de,pe,I,S,w.segment,a?a[0]:0,a?a[1]:0,u[0],u[1],_,0,0,0,D,0),e.symbolInstanceIndices.push(U)}_addNullVertices(e,n,a,u,p,m,_,b,w){for(let I=0;I<e;I++){for(let D=0;D<4;D++)z_(n,0,0,0,0,0,0,a,!1,0,0,0,0),u&&V_(p,0,0,0,0,0,0),Cp(m.dynamicLayoutVertexArray,0,0,0,0),_&&B_(m.iconTransitioningVertexArray,0,0);let S=b.vertexLength;w.emplaceBack(S,S+1,S+2),w.emplaceBack(S+1,S+2,S+3),b.vertexLength+=4,b.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(0)}}_commitLayoutVertex(e,n,a,u,p,m,_){e.emplaceBack(n,a,u,p,m,Math.round(_.x),Math.round(_.y))}_addCollisionDebugVertices(e,n,a,u,p,m,_){let b=a.segments.prepareSegment(4,a.layoutVertexArray,a.indexArray),w=b.vertexLength,I=_.tileAnchorX,S=_.tileAnchorY;for(let P=0;P<4;P++)a.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(a.collisionVertexArrayExt,n,e.padding,_.zOffset),this._commitLayoutVertex(a.layoutVertexArray,u,p,m,I,S,new Ze(e.x1,e.y1)),this._commitLayoutVertex(a.layoutVertexArray,u,p,m,I,S,new Ze(e.x2,e.y1)),this._commitLayoutVertex(a.layoutVertexArray,u,p,m,I,S,new Ze(e.x2,e.y2)),this._commitLayoutVertex(a.layoutVertexArray,u,p,m,I,S,new Ze(e.x1,e.y2)),b.vertexLength+=4;let D=a.indexArray;D.emplaceBack(w,w+1),D.emplaceBack(w+1,w+2),D.emplaceBack(w+2,w+3),D.emplaceBack(w+3,w),b.primitiveLength+=4}_addTextDebugCollisionBoxes(e,n,a,u,p,m){for(let _=u;_<p;_++){let b=a.get(_),w=this.getSymbolInstanceTextSize(e,m,n,_);this._addCollisionDebugVertices(b,w,this.textCollisionBox,b.projectedAnchorX,b.projectedAnchorY,b.projectedAnchorZ,m)}}_addIconDebugCollisionBoxes(e,n,a,u,p,m){for(let _=u;_<p;_++){let b=a.get(_),w=this.getSymbolInstanceIconSize(e,n,m.placedIconSymbolIndex);this._addCollisionDebugVertices(b,w,this.iconCollisionBox,b.projectedAnchorX,b.projectedAnchorY,b.projectedAnchorZ,m)}}generateCollisionDebugBuffers(e,n,a){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new lT(ip,XM.members,Ss),this.iconCollisionBox=new lT(ip,XM.members,Ss);let u=Tp(this.iconSizeData,e),p=Tp(this.textSizeData,e,a);for(let m=0;m<this.symbolInstances.length;m++){let _=this.symbolInstances.get(m);this._addTextDebugCollisionBoxes(p,e,n,_.textBoxStartIndex,_.textBoxEndIndex,_),this._addTextDebugCollisionBoxes(p,e,n,_.verticalTextBoxStartIndex,_.verticalTextBoxEndIndex,_),this._addIconDebugCollisionBoxes(u,e,n,_.iconBoxStartIndex,_.iconBoxEndIndex,_),this._addIconDebugCollisionBoxes(u,e,n,_.verticalIconBoxStartIndex,_.verticalIconBoxEndIndex,_)}}getSymbolInstanceTextSize(e,n,a,u){let p=this.text.placedSymbolArray.get(n.rightJustifiedTextSymbolIndex>=0?n.rightJustifiedTextSymbolIndex:n.centerJustifiedTextSymbolIndex>=0?n.centerJustifiedTextSymbolIndex:n.leftJustifiedTextSymbolIndex>=0?n.leftJustifiedTextSymbolIndex:n.verticalPlacedTextSymbolIndex>=0?n.verticalPlacedTextSymbolIndex:u),m=QE(this.textSizeData,e,p)/Nr;return this.tilePixelRatio*m}getSymbolInstanceIconSize(e,n,a){let u=this.icon.placedSymbolArray.get(a),p=QE(this.iconSizeData,e,u);return this.tilePixelRatio*p}_commitDebugCollisionVertexUpdate(e,n,a,u){e.emplaceBack(n,-a,-a,u),e.emplaceBack(n,a,-a,u),e.emplaceBack(n,a,a,u),e.emplaceBack(n,-a,a,u)}_updateTextDebugCollisionBoxes(e,n,a,u,p,m,_){for(let b=u;b<p;b++){let w=a.get(b),I=this.getSymbolInstanceTextSize(e,m,n,b);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,I,w.padding,m.zOffset)}}_updateIconDebugCollisionBoxes(e,n,a,u,p,m,_){for(let b=u;b<p;b++){let w=a.get(b),I=this.getSymbolInstanceIconSize(e,n,m.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,I,w.padding,m.zOffset)}}updateCollisionDebugBuffers(e,n,a,u){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let p=Tp(this.iconSizeData,e,u),m=Tp(this.textSizeData,e,a);for(let _=0;_<this.symbolInstances.length;_++){let b=this.symbolInstances.get(_);this._updateTextDebugCollisionBoxes(m,e,n,b.textBoxStartIndex,b.textBoxEndIndex,b,a),this._updateTextDebugCollisionBoxes(m,e,n,b.verticalTextBoxStartIndex,b.verticalTextBoxEndIndex,b,a),this._updateIconDebugCollisionBoxes(p,e,n,b.iconBoxStartIndex,b.iconBoxEndIndex,b,u),this._updateIconDebugCollisionBoxes(p,e,n,b.verticalIconBoxStartIndex,b.verticalIconBoxEndIndex,b,u)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,n,a,u,p,m,_,b,w){let I={};if(n<a){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K,featureIndex:le}=e.get(n);I.textBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K},I.textFeatureIndex=le}if(u<p){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K,featureIndex:le}=e.get(u);I.verticalTextBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K},I.verticalTextFeatureIndex=le}if(m<_){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K,featureIndex:le}=e.get(m);I.iconBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K},I.iconFeatureIndex=le}if(b<w){let{x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K,featureIndex:le}=e.get(b);I.verticalIconBox={x1:S,y1:D,x2:P,y2:O,padding:N,projectedAnchorX:V,projectedAnchorY:U,projectedAnchorZ:W,tileAnchorX:X,tileAnchorY:K},I.verticalIconFeatureIndex=le}return I}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let n=0;n<this.symbolInstances.length;n++){let a=this.symbolInstances.get(n);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,a.textBoxStartIndex,a.textBoxEndIndex,a.verticalTextBoxStartIndex,a.verticalTextBoxEndIndex,a.iconBoxStartIndex,a.iconBoxEndIndex,a.verticalIconBoxStartIndex,a.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,n){let a=e.placedSymbolArray.get(n),u=a.vertexStartIndex+4*a.numGlyphs;for(let p=a.vertexStartIndex;p<u;p+=4)e.indexArray.emplaceBack(p,p+1,p+2),e.indexArray.emplaceBack(p+1,p+2,p+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;let n=Math.sin(e),a=Math.cos(e),u=[],p=[],m=[];for(let _=0;_<this.symbolInstances.length;++_){m.push(_);let b=this.symbolInstances.get(_);u.push(0|Math.round(n*b.tileAnchorX+a*b.tileAnchorY)),p.push(b.featureIndex)}return m.sort((_,b)=>u[_]-u[b]||p[b]-p[_]),m}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,n)=>this.symbolInstances.get(n).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,n){let a=this.sortKeyRanges[this.sortKeyRanges.length-1];a&&a.sortKey===n?a.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:n,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(let n of this.symbolInstanceIndexes){let a=this.symbolInstances.get(n);this.featureSortOrder.push(a.featureIndex);let{rightJustifiedTextSymbolIndex:u,centerJustifiedTextSymbolIndex:p,leftJustifiedTextSymbolIndex:m,verticalPlacedTextSymbolIndex:_,placedIconSymbolIndex:b,verticalPlacedIconSymbolIndex:w}=a;u>=0&&this.addIndicesForPlacedSymbol(this.text,u),p>=0&&p!==u&&this.addIndicesForPlacedSymbol(this.text,p),m>=0&&m!==p&&m!==u&&this.addIndicesForPlacedSymbol(this.text,m),_>=0&&this.addIndicesForPlacedSymbol(this.text,_),b>=0&&this.addIndicesForPlacedSymbol(this.icon,b),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}getElevationFeatureForText(e){let n=this.symbolInstances.get(this.text.symbolInstanceIndices[e]).elevationFeatureIndex,a;return this.elevationFeatures&&n<this.elevationFeatures.length&&(a=this.elevationFeatures[n]),a}}function OR(r,e){return e.replace(/{([^{}]+)}/g,(n,a)=>a in r?String(r[a]):"")}let LR,FR,cT;vt(nx,"SymbolBucket",{omit:["layers","collisionBoxArray","compareText","features"]}),nx.addDynamicAttributes=Cp;class kR{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Yc,this.defaultValue=e}evaluate(e){if(e.formattedSection){let n=this.defaultValue.property.overrides;if(n&&n.hasOverride(e.formattedSection))return n.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}vt(kR,"FormatSectionOverride",{omit:["defaultValue"]});let uT=()=>cT||(cT={layout:LR||(LR=new zi({"symbol-placement":new Ke(Ee.layout_symbol["symbol-placement"]),"symbol-spacing":new Ke(Ee.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ke(Ee.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new dt(Ee.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ke(Ee.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Ke(Ee.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Ke(Ee.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Ke(Ee.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ke(Ee.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ke(Ee.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ke(Ee.layout_symbol["icon-rotation-alignment"]),"icon-size":new dt(Ee.layout_symbol["icon-size"]),"icon-size-scale-range":new Ke(Ee.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new dt(Ee.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new dt(Ee.layout_symbol["icon-text-fit-padding"]),"icon-image":new dt(Ee.layout_symbol["icon-image"]),"icon-image-use-theme":new Ke({type:"string",default:"default","property-type":"data-constant"}),"icon-rotate":new dt(Ee.layout_symbol["icon-rotate"]),"icon-padding":new Ke(Ee.layout_symbol["icon-padding"]),"icon-keep-upright":new Ke(Ee.layout_symbol["icon-keep-upright"]),"icon-offset":new dt(Ee.layout_symbol["icon-offset"]),"icon-anchor":new dt(Ee.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ke(Ee.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ke(Ee.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ke(Ee.layout_symbol["text-rotation-alignment"]),"text-field":new dt(Ee.layout_symbol["text-field"]),"text-font":new dt(Ee.layout_symbol["text-font"]),"text-size":new dt(Ee.layout_symbol["text-size"]),"text-size-scale-range":new Ke(Ee.layout_symbol["text-size-scale-range"]),"text-max-width":new dt(Ee.layout_symbol["text-max-width"]),"text-line-height":new dt(Ee.layout_symbol["text-line-height"]),"text-letter-spacing":new dt(Ee.layout_symbol["text-letter-spacing"]),"text-justify":new dt(Ee.layout_symbol["text-justify"]),"text-radial-offset":new dt(Ee.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ke(Ee.layout_symbol["text-variable-anchor"]),"text-anchor":new dt(Ee.layout_symbol["text-anchor"]),"text-max-angle":new Ke(Ee.layout_symbol["text-max-angle"]),"text-writing-mode":new Ke(Ee.layout_symbol["text-writing-mode"]),"text-rotate":new dt(Ee.layout_symbol["text-rotate"]),"text-padding":new Ke(Ee.layout_symbol["text-padding"]),"text-keep-upright":new Ke(Ee.layout_symbol["text-keep-upright"]),"text-transform":new dt(Ee.layout_symbol["text-transform"]),"text-offset":new dt(Ee.layout_symbol["text-offset"]),"text-allow-overlap":new Ke(Ee.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ke(Ee.layout_symbol["text-ignore-placement"]),"text-optional":new Ke(Ee.layout_symbol["text-optional"]),visibility:new Ke(Ee.layout_symbol.visibility)})),paint:FR||(FR=new zi({"icon-opacity":new dt(Ee.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new dt(Ee.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new dt(Ee.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new dt(Ee.paint_symbol["text-emissive-strength"]),"icon-color":new dt(Ee.paint_symbol["icon-color"]),"icon-halo-color":new dt(Ee.paint_symbol["icon-halo-color"]),"icon-halo-width":new dt(Ee.paint_symbol["icon-halo-width"]),"icon-halo-blur":new dt(Ee.paint_symbol["icon-halo-blur"]),"icon-translate":new Ke(Ee.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ke(Ee.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ke(Ee.paint_symbol["icon-image-cross-fade"]),"text-opacity":new dt(Ee.paint_symbol["text-opacity"]),"text-occlusion-opacity":new dt(Ee.paint_symbol["text-occlusion-opacity"]),"text-color":new dt(Ee.paint_symbol["text-color"],{runtimeType:Fo,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new dt(Ee.paint_symbol["text-halo-color"]),"text-halo-width":new dt(Ee.paint_symbol["text-halo-width"]),"text-halo-blur":new dt(Ee.paint_symbol["text-halo-blur"]),"text-translate":new Ke(Ee.paint_symbol["text-translate"]),"text-translate-anchor":new Ke(Ee.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Ke(Ee.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Ke(Ee.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Ke(Ee.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Ke(Ee.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new dt(Ee.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},cT);class ix extends io{constructor(e,n,a,u){super(e,uT(),n,a,u,e.layout?e.layout["icon-image-use-theme"]:null),this._colorAdjustmentMatrix=yt([]),this.hasOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}_handleSpecialPaintPropertyUpdate(e){e!=="icon-occlusion-opacity"&&e!=="text-occlusion-opacity"||(this.hasOcclusionOpacityProperties=!0)}recalculate(e,n){super.recalculate(e,n),this.appearances&&this.appearances.forEach(u=>{u.recalculate(e,n,this.iconImageUseTheme)}),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let a=this.layout.get("text-writing-mode");if(a){let u=[];for(let p of a)u.indexOf(p)<0&&u.push(p);this.layout._values["text-writing-mode"]=u}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,n,a,u){return this._saturation===e&&this._contrast===n&&this._brightnessMin===a&&this._brightnessMax===u||(this._colorAdjustmentMatrix=(function(p,m,_,b){p=Pi(p),m=fi(m);let w=ct(),I=p/3,S=1-2*I,D=[S,I,I,0,I,S,I,0,I,I,S,0,0,0,0,1],P=.5-.5*m,O=b-_;return At(w,[O,0,0,0,0,O,0,0,0,0,O,0,_,_,_,1],[m,0,0,0,0,m,0,0,0,0,m,0,P,P,P,1]),At(w,w,D),w})(e,n,a,u),this._saturation=e,this._contrast=n,this._brightnessMin=a,this._brightnessMax=u),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,n,a,u){let p=this.layout.get(e).evaluate(n,{},a,u),m=this._unevaluatedLayout._values[e];return m.isDataDriven()||$f(m.value)||!p?p:OR(n.properties,p)}getAppearanceValueAndResolveTokens(e,n,a,u,p){let m=e.getProperty(n);if(!m)return;let _=m.evaluate(a,{},u,p),b=e.getUnevaluatedProperties()._values[n];return b.isDataDriven()||$f(b.value)||!_||typeof _!="string"?_:OR(a.properties,_)}createBucket(e){return new nx(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let e of uT().paint.overridableProperties){if(!ix.hasPaintOverride(this.layout,e))continue;let n=this.paint.get(e),a=new kR(n),u=new Hf(a,n.property.specification,this.scope,this.options,this.layout.get("icon-image-use-theme")),p=null;p=n.value.kind==="constant"||n.value.kind==="source"?new Jd("source",u):new gl("composite",u,n.value.zoomStops,n.value.interpolationType),this.paint._values[e]=new Is(n.property,p,n.parameters)}}_handleOverridablePaintPropertyUpdate(e,n,a){return!(!this.layout||n.isDataDriven()||a.isDataDriven())&&ix.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,n){let a=e.get("text-field"),u=uT().paint.properties[n],p=!1,m=_=>{for(let b of _)if(u.overrides&&u.overrides.hasOverride(b))return void(p=!0)};if(a.value.kind==="constant"&&a.value.value instanceof Dr)m(a.value.value.sections);else if(a.value.kind==="source"){let _=w=>{p||(w instanceof La&&xr(w.value)===tc?m(w.value.sections):w instanceof nc?m(w.sections):w.eachChild(_))},b=a.value;b._styleExpression&&_(b._styleExpression.expression)}return p}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,n,a){return{config:new ja(this,{zoom:n,lut:a}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let NR,zR,BR,VR;var dT=hn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function rx(r,e,n,a,u,p,m,_){let b=[r,e,1,n,a,1,u,p,1],w=[m,_,1],I=_e([],b),[S,D,P]=al(w,w,I);return Oe(b,b,[S,0,0,0,D,0,0,0,P])}function jR(r,e,n,a,u,p,m,_){let b=(function(w,I,S,D,P,O,N,V){let U=rx(0,0,1,0,1,1,0,1),W=rx(w,I,S,D,P,O,N,V);return Oe(W,W,_e([],U))})(r,e,n,a,u,p,m,_);return[b[2]/b[8]/rt,b[5]/b[8]/rt]}function ox(r){return[r[0],Math.min(Math.max(r[1],-Q),Q)]}class UR extends Ra{constructor(e,n,a,u){super(),this.id=e,this.dispatcher=a,this.coordinates=n.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(u),this.options=n,this._dirty=!1}load(e,n){if(this._loaded=n||!1,this.fire(new Zo("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Ym(this.map._requestManager.transformRequest(this.url,Jl.Image),(a,u)=>{this._imageRequest=null,this._loaded=!0,a?this.fire(new Rd(a)):u&&(this.image=u instanceof HTMLImageElement?Lo.getImageData(u):u,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new T_(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Zo("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof T_||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let n=e[0][1],a=e[0][1];for(let p of e)p[1]>a&&(a=p[1]),p[1]<n&&(n=p[1]);let u=(a+n)/2;if(u>Q?this.onNorthPole=!0:u<-Q&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let p=e.map(be.fromLngLat);this.tileID=(function(m){let _=1/0,b=1/0,w=-1/0,I=-1/0;for(let N of m)_=Math.min(_,N.x),b=Math.min(b,N.y),w=Math.max(w,N.x),I=Math.max(I,N.y);let S=Math.max(w-_,I-b),D=Math.max(0,Math.floor(-Math.log2(S))),P=Math.pow(2,D),O=Math.floor((_+w)/2*P);return O>1&&(O-=1),new ns(D,O,Math.floor((b+I)/2*P))})(p),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Zo("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof T_||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(let U in this.tiles){let W=this.tiles[U];W.state!=="loaded"&&(W.state="loaded",W.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let n=O_(new ns(0,0,0),this.map.transform.projection),a=[n.projection.project(this.coordinates[0][0],this.coordinates[0][1]),n.projection.project(this.coordinates[1][0],this.coordinates[1][1]),n.projection.project(this.coordinates[2][0],this.coordinates[2][1]),n.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!(function(U){let W=U[1].x-U[0].x,X=U[1].y-U[0].y,K=U[2].x-U[1].x,le=U[2].y-U[1].y,re=U[3].x-U[2].x,de=U[3].y-U[2].y,pe=U[0].x-U[3].x,ge=U[0].y-U[3].y,Le=W*le-K*X,Te=K*de-re*le,ke=re*ge-pe*de,je=pe*X-W*ge;return Le>0&&Te>0&&ke>0&&je>0||Le<0&&Te<0&&ke<0&&je<0})(a))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let u=O_(this.tileID,this.map.transform.projection),[p,m,_,b]=this.coordinates.map(U=>{let W=u.projection.project(U[0],U[1]);return DR(u,W)._round()});this.perspectiveTransform=jR(p.x,p.y,m.x,m.y,_.x,_.y,b.x,b.y);let w=this._boundsArray=new bu;w.emplaceBack(p.x,p.y,0,0),w.emplaceBack(m.x,m.y,rt,0),w.emplaceBack(b.x,b.y,0,rt),w.emplaceBack(_.x,_.y,rt,rt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(w,dT.members),this.boundsSegments=Ci.simpleSegment(0,0,4,2);let I=[],S=[ox((D=this.coordinates)[0]),ox(D[1]),ox(D[2]),ox(D[3])];var D;let[P,O,N,V]=(function(U){let W=U[0][0],X=W,K=U[0][1],le=K;for(let re=1;re<U.length;re++)U[re][0]<W?W=U[re][0]:U[re][0]>X&&(X=U[re][0]),U[re][1]<K?K=U[re][1]:U[re][1]>le&&(le=U[re][1]);return[W,K,X-W,le-K]})(S);{let U=new bu,[W,X,K,le]=(function(Ue){let Xe=Ue[0].x,Re=Xe,Ae=Ue[0].y,qe=Ae;for(let Qe=1;Qe<Ue.length;Qe++)Ue[Qe].x<Xe?Xe=Ue[Qe].x:Ue[Qe].x>Re&&(Re=Ue[Qe].x),Ue[Qe].y<Ae?Ae=Ue[Qe].y:Ue[Qe].y>qe&&(qe=Ue[Qe].y);return[Xe,Ae,Re-Xe,qe-Ae]})(a),re=Ue=>[(Ue.x-W)/K,(Ue.y-X)/le],[de,pe,ge,Le]=a.map(re),Te=(function(Ue,Xe,Re,Ae,qe,Qe,He,_t){let bt=rx(0,0,1,0,1,1,0,1);return Oe(bt,bt,_e([],rx(Ue,Xe,Re,Ae,qe,Qe,He,_t)))})(de[0],de[1],pe[0],pe[1],ge[0],ge[1],Le[0],Le[1]);this.elevatedGlobePerspectiveTransform=jR(de[0],de[1],pe[0],pe[1],ge[0],ge[1],Le[0],Le[1]);let ke=(Ue,Xe)=>{I.push(Ue.lng);let Re=Math.round((Ue.lng-P)/N*rt),Ae=Math.round((Ue.lat-O)/V*rt),qe=re(Xe),Qe=al([],[qe[0],qe[1],1],Te),He=Math.round(Qe[0]/Qe[2]*rt),_t=Math.round(Qe[1]/Qe[2]*rt);U.emplaceBack(Re,Ae,He,_t)},je=a[3].x-a[0].x,$e=a[3].y-a[0].y,nt=a[2].x-a[1].x,Ye=a[2].y-a[1].y;for(let Ue=0;Ue<65;Ue++){let Xe=Ue/64,Re=[a[0].x+Xe*je,a[0].y+Xe*$e],Ae=[a[1].x+Xe*nt,a[1].y+Xe*Ye],qe=Ae[0]-Re[0],Qe=Ae[1]-Re[1];for(let He=0;He<65;He++){let _t=He/64,bt={x:Re[0]+qe*_t,y:Re[1]+Qe*_t};ke(n.projection.unproject(bt.x,bt.y),bt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(U,dT.members)}{this.maxLongitudeTriangleSize=0;let U=[],W=new wi,X=(K,le,re)=>{W.emplaceBack(K,le,re);let de=I[K],pe=I[le],ge=I[re],Le=Math.min(Math.min(de,pe),ge),Te=Math.max(Math.max(de,pe),ge)-Le;Te>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Te),U.push(Le+Te/2)};for(let K=0;K<64;K++)for(let le=0;le<64;le++){let re=65*K+le,de=re+1,pe=re+65,ge=pe+1;X(re,pe,de),X(de,pe,ge)}[U,W]=(function(K,le){let re=Array.from({length:K.length},(ge,Le)=>Le);re.sort((ge,Le)=>K[ge]-K[Le]);let de=[],pe=new wi;for(let ge=0;ge<re.length;ge++){let Le=re[ge];de.push(K[Le]);let Te=3*Le,ke=Te+1;pe.emplaceBack(le.uint16[Te],le.uint16[ke],le.uint16[ke+1])}return[de,pe]})(U,W),this.elevatedGlobeTrianglesCenterLongitudes=U,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(W)}this.elevatedGlobeSegments=Ci.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,N/rt,0,V/rt,0,0,O,P,0])}prepare(){let e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;let n=this.map.painter.context,a=n.gl;!this._dirty||this.texture instanceof T_||(this.texture?this.texture.update(this.image):(this.texture=new NE(n,this.image,a.RGBA8),this.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(n)}loadTile(e,n){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},n(null)):(e.state="errored",n(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){let n=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!n)return null;let a=this.elevatedGlobeTrianglesCenterLongitudes,u=(p=e+180)+360*Math.round((a[0]-p)/360);var p;let m=new Ci,_=(S,D)=>{m.segments.push({vertexOffset:0,primitiveOffset:S,vertexLength:n.segments[0].vertexLength,primitiveLength:D,sortKey:void 0,vaos:{}})},b=.51*this.maxLongitudeTriangleSize;if(Math.abs(a[0]-u)<=b){let S=_n(a,0,a.length,u+b);return S===a.length||_(S,Hn(a,S+1,a.length,u+360-b)-S),m}u<a[0]&&(u+=360);let w=Hn(a,0,a.length,u-b);if(w===a.length)return _(0,a.length),m;_(0,w-0);let I=_n(a,w+1,a.length,u+b);return I!==a.length&&_(I,a.length-I),m}}let Y3=(Math.pow(256,2)-1)/16907520;class HR extends io{constructor(e,n,a,u){super(e,{layout:BR||(BR=new zi({visibility:new Ke(Ee.layout_raster.visibility)})),paint:VR||(VR=new zi({"raster-opacity":new Ke(Ee.paint_raster["raster-opacity"]),"raster-color":new gu(Ee.paint_raster["raster-color"]),"raster-color-mix":new Ke(Ee.paint_raster["raster-color-mix"]),"raster-color-range":new Ke(Ee.paint_raster["raster-color-range"]),"raster-hue-rotate":new Ke(Ee.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ke(Ee.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ke(Ee.paint_raster["raster-brightness-max"]),"raster-saturation":new Ke(Ee.paint_raster["raster-saturation"]),"raster-contrast":new Ke(Ee.paint_raster["raster-contrast"]),"raster-resampling":new Ke(Ee.paint_raster["raster-resampling"]),"raster-fade-duration":new Ke(Ee.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Ke(Ee.paint_raster["raster-emissive-strength"]),"raster-array-band":new Ke(Ee.paint_raster["raster-array-band"]),"raster-elevation":new Ke(Ee.paint_raster["raster-elevation"]),"raster-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},n,a,u),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof UR&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;let n=this._transitionablePaint._values["raster-color"].value.expression,[a,u]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(a)&&isNaN(u)||a===this._curRampRange[0]&&u===this._curRampRange[1]||(this.colorRamp=c_({expression:n,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:a,end:u}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[a,u])}}let $R,GR,qR,WR,ZR;class XR extends io{constructor(e,n,a,u){super(e,{layout:$R||($R=new zi({visibility:new Ke(Ee["layout_raster-particle"].visibility)})),paint:GR||(GR=new zi({"raster-particle-array-band":new Ke(Ee["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Ke(Ee["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new gu(Ee["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Ke(Ee["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Ke(Ee["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Ke(Ee["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Ke(Ee["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Ke(Ee["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},n,a,u),this._updateColorRamp(),this.lastInvalidatedAt=Lo.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let e=this._transitionablePaint._values["raster-particle-color"].value.expression,n=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=c_({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:n}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=Lo.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class K3 extends io{constructor(e,n){super(e,{},n,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function hT(r,e,n){let a=[0,0,1],u=la([]);return ql(u,u,n?-gn(r)+Math.PI:gn(r)),Da(u,u,-gn(e)),Go(a,a,u),li(a,a)}let YR={None:0,Model:1,Symbol:2,FillExtrusion:4};class sx{constructor(e,n,a,u){this.message=(e?`${e}: `:"")+a,u&&(this.identifier=u),n!=null&&n.__line__&&(this.line=n.__line__)}}function fT(r,e){let n=r.indexOf("://")===-1;try{return new URL(r,n&&e?"http://example.com":void 0),!0}catch{return!1}}class KR{constructor(e,n){this.feature=e,this.instancedDataOffset=n,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class JR{constructor(){this.maxScale=1,this.maxXYTranslationDistance=0,this.instancedDataArray=new op,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}colorForInstance(e){let n=16*e,a=this.instancedDataArray.float32,u=Math.floor(a[n+2]),p=1.05*(a[n+2]-u);return u/=100,[a[n]%1*1.05,a[n+1]%1*1.05,p,u]}tileCoordinatesForInstance(e){let n=16*e,a=this.instancedDataArray.float32,u=a[n+0];return u=u>rt?u-rt:u,new Ze(Math.trunc(u),Math.trunc(a[n+1]))}translationForInstance(e){let n=16*e,a=this.instancedDataArray.float32;return[a[n+4],a[n+5],a[n+6]]}rotationScaleForInstance(e){let n=16*e,a=this.instancedDataArray.float32;return[a[n+7],a[n+8],a[n+9],a[n+10],a[n+11],a[n+12],a[n+13],a[n+14],a[n+15]]}transformForInstance(e){let n=16*e,a=this.instancedDataArray.float32;return[a[n+7],a[n+8],a[n+9],a[n+4],a[n+10],a[n+11],a[n+12],a[n+5],a[n+13],a[n+14],a[n+15],a[n+6],0,0,0,1]}}class pT{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaledZ=this.canonical.z+Math.log2(e.overscaling),this.layers=e.layers,this.layerIds=this.layers.map(n=>n.fqid),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(n=>n.isStateDependent()).map(n=>n.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z+1?0:this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs,this.hasAppearances=null}updateFootprints(e,n){}updateAppearances(e,n,a,u){}populate(e,n,a,u){this.tileToMeter=ue(a);let p=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(let{feature:m,id:_,index:b,sourceLayerIndex:w}of e){let I=_??(m.properties&&m.properties.hasOwnProperty("id")?m.properties.id:void 0),S=De(m,p);if(!this.layers[0]._featureFilter.filter(new ci(this.zoom,{worldview:this.worldview,activeFloors:n.activeFloors}),S,a))continue;let D={id:I,sourceLayerIndex:w,index:b,geometry:p?S.geometry:Ve(m,a,u),properties:m.properties,type:m.type,patterns:{}},P=this.addFeature(D,D.geometry,S);P&&n.featureIndex.insert(m,D.geometry,b,w,this.index,this.instancesPerModel[P].instancedDataArray.length,rt/32)}this.lookup=null}evaluateQueryRenderedFeaturePadding(){let e=this.layers[0].modelManager,n=this.layers[0].scope,a=0;for(let u of this.modelUris){let p=e.getModel(u,n);if(!p)continue;let m=this.instancesPerModel[u];if(m){let _=.5*fd(p.aabb.max,p.aabb.min)*m.maxScale+m.maxXYTranslationDistance,b=Math.min(rt,Math.max(_/this.tileToMeter,rt/32));a=Math.max(b,a)}}return a}update(e,n,a,u){for(let p in this.instancesPerModel){let m=this.instancesPerModel[p];for(let _ in e)m.idToFeaturesIndex.hasOwnProperty(_)&&(this.evaluate(m.features[m.idToFeaturesIndex[_]],e[_],m,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(let n in this.instancesPerModel){let a=this.instancesPerModel[n];for(let u of a.features){let p=this.layers[0],m=u.feature,_=this.canonical,b=p.paint.get("model-rotation").evaluate(m,{},_),w=p.paint.get("model-scale").evaluate(m,{},_),I=p.paint.get("model-translation").evaluate(m,{},_);aa(u.rotation,b)&&aa(u.scale,w)&&aa(u.translation,I)||(this.evaluate(u,u.featureStates,a,!0),e=!0)}}return e}updateReplacement(e,n,a,u){if(n.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=n.updateTime;let p=n.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(A0(this.activeReplacements,p))return!1;this.activeReplacements=p;let m=!1;for(let _ in this.instancesPerModel){let b=this.instancesPerModel[_],w=b.instancedDataArray;for(let I of b.features){let S=I.instancedDataOffset,D=I.instancedDataCount;for(let P=0;P<D;P++){let O=16*(P+S),N=w.float32[O+0],V=N>rt;N=V?N-rt:N;let U=Math.floor(N),W=Math.floor(w.float32[O+1]),X=!1;for(let K of this.activeReplacements)if(!NA(K,a,YR.Model,u)&&!(K.min.x>U||U>K.max.x||K.min.y>W||W>K.max.y)&&(X=IE(jA(U,W,e.canonical,K.footprintTileId.canonical),K.footprint),X))break;w.float32[O]=X?N+rt:N,m=m||X!==V}}}return m}isEmpty(){for(let e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(let n in this.instancesPerModel){let a=this.instancesPerModel[n];a.instancedDataArray.length<0||a.instancedDataArray.length===0||(a.instancedDataBuffer?a.instancedDataBuffer.updateData(a.instancedDataArray):a.instancedDataBuffer=e.createVertexBuffer(a.instancedDataArray,TB.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let n in this.instancesPerModel){let a=this.instancesPerModel[n];a.instancedDataArray.length!==0&&a.instancedDataBuffer&&a.instancedDataBuffer.destroy()}let e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(let n of this.modelUris)e.removeModel(n,"",!0)}addFeature(e,n,a){let u=this.layers[0],p=u.layout.get("model-id").evaluate(a,{},this.canonical);if(!p)return Rt(`modelId is not evaluated for layer ${u.id} and it is not going to get rendered.`),p;(fT(p,!1)||this.styleDefinedModelURLs[p]!==void 0)&&(this.modelUris.includes(p)||this.modelUris.push(p)),this.instancesPerModel[p]||(this.instancesPerModel[p]=new JR);let m=this.instancesPerModel[p],_=m.instancedDataArray,b=new KR(a,_.length);for(let w of n)for(let I of w){if(I.x<0||I.x>=rt||I.y<0||I.y>=rt)continue;if(this.lookupDim!==0){let D=(this.lookupDim-1)/rt,P=this.lookupDim*(I.y*D|0)+I.x*D|0;if(this.lookup){if(this.lookup[P]!==0)continue;this.lookup[P]=1}}this.instanceCount++;let S=_.length;_.resize(S+1),m.instancesEvaluatedElevation.push(0),_.float32[16*S]=I.x,_.float32[16*S+1]=I.y}return b.instancedDataCount=m.instancedDataArray.length-b.instancedDataOffset,b.instancedDataCount>0&&(e.id&&(m.idToFeaturesIndex[e.id]=m.features.length),m.features.push(b),this.evaluate(b,{},m,!1)),p}getModelUris(){return this.modelUris}evaluate(e,n,a,u){let p=this.layers[0],m=e.feature,_=this.canonical,b=e.rotation=p.paint.get("model-rotation").evaluate(m,n,_),w=e.scale=p.paint.get("model-scale").evaluate(m,n,_),I=e.translation=p.paint.get("model-translation").evaluate(m,n,_),S=Object.assign({},p.paint.get("model-color").evaluate(m,n,_));S.a=p.paint.get("model-color-mix-intensity").evaluate(m,n,_);let D=[];this.maxVerticalOffset<I[2]&&(this.maxVerticalOffset=I[2]);let P=I[0]*I[0]+I[1]*I[1],O=P>0?Math.sqrt(P):0;a.maxScale=Math.max(Math.max(a.maxScale,w[0]),Math.max(w[1],w[2])),a.maxXYTranslationDistance=Math.max(a.maxXYTranslationDistance,O),this.maxScale=Math.max(Math.max(this.maxScale,w[0]),Math.max(w[1],w[2])),DM(D,b,w);let N=Math.round(100*S.a)+S.b/1.05;for(let V=0;V<e.instancedDataCount;++V){let U=e.instancedDataOffset+V,W=16*U,X=a.instancedDataArray.float32,K=0;u&&(K=X[W+6]-a.instancesEvaluatedElevation[U]);let le=0|X[W+1];X[W]=(0|X[W])+S.r/1.05,X[W+1]=le+S.g/1.05,X[W+2]=N,X[W+3]=1/(_.z>10?this.tileToMeter:ue(_,le)),X[W+4]=I[0],X[W+5]=I[1],X[W+6]=I[2]+K,X[W+7]=D[0],X[W+8]=D[1],X[W+9]=D[2],X[W+10]=D[4],X[W+11]=D[5],X[W+12]=D[6],X[W+13]=D[8],X[W+14]=D[9],X[W+15]=D[10],a.instancesEvaluatedElevation[U]=I[2]}}}let QR,eP;vt(pT,"ModelBucket",{omit:["layers"]}),vt(JR,"PerModelAttributes"),vt(KR,"ModelFeature");class Ap{constructor(e,n,a){this._demTile=e,this._dem=this._demTile.dem,this._scale=n,this._offset=a}static create(e,n,a){let u=a||e.findDEMTileFor(n);if(!u||!u.dem)return;let p=u.dem,m=u.tileID,_=1<<n.canonical.z-m.canonical.z;return new Ap(u,p.dim/rt/_,[(n.canonical.x/_-m.canonical.x)*p.dim,(n.canonical.y/_-m.canonical.y)*p.dim])}tileCoordToPixel(e,n){let a=n*this._scale+this._offset[1];return new Ze(Math.floor(e*this._scale+this._offset[0]),Math.floor(a))}getElevationAt(e,n,a,u){let p=e*this._scale+this._offset[0],m=n*this._scale+this._offset[1],_=Math.floor(p),b=Math.floor(m),w=this._dem;return u=!!u,a?zt(zt(w.get(_,b,u),w.get(_,b+1,u),m-b),zt(w.get(_+1,b,u),w.get(_+1,b+1,u),m-b),p-_):w.get(_,b,u)}getElevationAtPixel(e,n,a){return this._dem.get(e,n,!!a)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*Z(1,e)*this._dem.stride}}let mT=new Float32Array(262144),mh=new Uint8Array(262144);function tP(r){let e=0;if(r.meshes)for(let n of r.meshes)e=Math.max(e,n.aabb.max[2]);if(r.children)for(let n of r.children)e=Math.max(e,tP(n));return e}function nP(r,e,n){if(r.meshes)for(let a of r.meshes){if(a.aabb.min[0]===1/0)continue;let u=on.applyTransform(a.aabb,r.globalMatrix);n.insert(e,u.min[0],u.min[1],u.max[0],u.max[1])}if(r.children)for(let a of r.children)nP(a,e,n)}let iP=["","wall","door","roof","window","lamp","logo"];class rP{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:tP(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0,n=new on([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let a of this.node.meshes)this.node.lightMeshIndex!==e&&(a.transformedAabb=on.applyTransformFast(a.aabb,this.node.globalMatrix),n.encapsulate(a.transformedAabb)),e++;this.aabb=n}return this.aabb}}class ax{constructor(e,n,a,u,p,m,_,b){this.id=a,this.layers=e,this.layerIds=this.layers.map(w=>w.fqid),this.stateDependentLayerIds=this.layers.filter(w=>w.isStateDependent()).map(w=>w.id),this.modelTraits|=xp.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,u&&(this.modelTraits|=xp.HasMapboxMeshFeatures),p&&(this.modelTraits|=xp.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=m,this.worldview=b,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(let w of n)this.nodesInfo.push(new rP(w)),nP(w,_.featureIndexArray.length,_.grid),_.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,_.bucketLayerIDs.length-1,0);this.states={},this.hasAppearances=null}updateFootprints(e,n){for(let a of this.getNodesInfo()){let u=a.node;u.footprint&&n.push({footprint:u.footprint,id:e})}}updateAppearances(e,n,a,u){}update(e){let n=Object.keys(e).length!==0;if(n&&!this.stateDependentLayers.length)return;let a=n?this.stateDependentLayers:this.layers;if(!Aa(e,this.states))for(let u of a)this.evaluate(u,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;let n=this.getNodesInfo();for(let a of n){let u=a.node;this.uploaded?this.updatePbrBuffer(u):VE(u,e,!0)}for(let a of n)U0(a.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let n=!1;if(!e.meshes)return n;for(let a of e.meshes)a.pbrBuffer&&(a.pbrBuffer.updateData(a.featureArray),n=!0);return n}needsReEvaluation(e,n,a){let u=e.transform.projectionOptions,p=e.style.getBrightness(),m=this.brightness!==p;if(!this.uploaded||this.dirty||u.name!==this.projection.name||j_(a.paint.get("model-color").value,m)||j_(a.paint.get("model-color-mix-intensity").value,m)||j_(a.paint.get("model-roughness").value,m)||j_(a.paint.get("model-emissive-strength").value,m)||j_(a.paint.get("model-height-based-emissive-strength-multiplier").value,m)){this.projection=u,this.brightness=p;let _=this.getNodesInfo();for(let b of _)b.state=null;return!0}return!1}evaluateTransform(e,n){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;let a=this.getNodesInfo(),u=this.id.canonical;for(let p of a){let m=p.feature;p.evaluatedTranslation=n.paint.get("model-translation").evaluate(m,{},u),p.evaluatedScale=n.paint.get("model-scale").evaluate(m,{},u)}}evaluate(e,n){let a=this.getNodesInfo();for(let u of a){if(!u.node.meshes)continue;let p=u.feature,m=n&&n[p.id];if(Aa(m,u.state))continue;u.state=structuredClone(m);let _=u.node.meshes&&u.node.meshes[0].featureData,b=u.evaluatedColor[2],w=u.evaluatedRMEA[2],I=this.id.canonical;if(u.hasTranslucentParts=!1,_){for(let S=0;S<iP.length;S++){let D=iP[S];D.length&&(p.properties.part=D);let P=e.paint.get("model-color").evaluate(p,m,I).toPremultipliedRenderColor(null),O=e.paint.get("model-color-mix-intensity").evaluate(p,m,I);u.evaluatedColor[S]=[P.r,P.g,P.b,O],u.evaluatedRMEA[S][0]=e.paint.get("model-roughness").evaluate(p,m,I),u.evaluatedRMEA[S][2]=e.paint.get("model-emissive-strength").evaluate(p,m,I),u.evaluatedRMEA[S][3]=P.a,u.emissionHeightBasedParams[S]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(p,m,I),!u.hasTranslucentParts&&P.a<1&&(u.hasTranslucentParts=!0)}delete p.properties.part,Q3(u,b!==u.evaluatedColor[2]||w!==u.evaluatedRMEA[2],this.modelTraits)}else u.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(p,m,I);u.evaluatedTranslation=e.paint.get("model-translation").evaluate(p,m,I),u.evaluatedScale=e.paint.get("model-scale").evaluate(p,m,I),this.updatePbrBuffer(u.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,n,a,u){let p=e.findDEMTileFor(a);if(p&&(p.tileID.canonical!==this.terrainTile||n!==this.terrainExaggeration)){if(p.dem&&p.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=p.tileID.overscaledZ;let m=Ap.create(e,a,p);if(!m)return;this.modelTraits&xp.HasMapboxMeshFeatures&&this.updateDEM(e,m,a,u);for(let _ of this.getNodesInfo()){let b=_.node;if(!b.footprint||!b.footprint.vertices||!b.footprint.vertices.length)continue;let w=b.footprint.vertices,I=m.getElevationAt(w[0].x,w[0].y,!0,!0);for(let S=1;S<w.length;S++)I=Math.min(I,m.getElevationAt(w[S].x,w[S].y,!0,!0));b.elevation=I}}this.terrainTile=p.tileID.canonical,this.terrainExaggeration=n}}updateDEM(e,n,a,u){let p=n._dem._modifiedForSources[u];if(p===void 0&&(n._dem._modifiedForSources[u]=[],p=n._dem._modifiedForSources[u]),p.includes(a.canonical))return;let m=n._dem.dim;p.push(a.canonical);let _=!1;for(let b of this.getNodesInfo()){let w=b.node;if(!w.footprint||!w.footprint.grid)continue;let I=w.footprint.grid,S=n.tileCoordToPixel(I.min.x,I.min.y),D=n.tileCoordToPixel(I.max.x,I.max.y),P=Math.min(Math.min(m-D.y,S.x),Math.min(S.y,m-D.x));if(P<0)continue;let O=G(P,2,5),N=Math.max(0,S.x-O),V=Math.max(0,S.y-O),U=Math.min(D.x+O,m-1),W=Math.min(D.y+O,m-1);for(let re=V;re<=W;++re)for(let de=N;de<=U;++de)mh[re*m+de]=255;let X=0,K=0;for(let re=0;re<I.cellsY;++re)for(let de=0;de<I.cellsX;++de){if(!I.cells[re*I.cellsX+de])continue;let pe=n.tileCoordToPixel(I.min.x+de/I.xScale,I.min.y+re/I.yScale),ge=n.tileCoordToPixel(I.min.x+(de+1)/I.xScale,I.min.y+(re+1)/I.yScale);for(let Le=pe.y;Le<=Math.min(ge.y+1,m-1);++Le)for(let Te=pe.x;Te<=Math.min(ge.x+1,m-1);++Te)mh[Le*m+Te]===255&&(mh[Le*m+Te]=0,X+=n.getElevationAtPixel(Te,Le),K++)}let le=X/K;N=Math.max(1,S.x-O),V=Math.max(1,S.y-O),U=Math.min(D.x+O,m-2),W=Math.min(D.y+O,m-2),_=!0;for(let re=V;re<=W;++re)for(let de=N;de<=U;++de)mh[re*m+de]===0&&(mT[re*m+de]=n._dem.set(de,re,le));for(let re=1;re<O;++re){N=Math.max(1,S.x-re),V=Math.max(1,S.y-re),U=Math.min(D.x+re,m-2),W=Math.min(D.y+re,m-2);for(let de=V;de<=W;++de)for(let pe=N;pe<=U;++pe){let ge=de*m+pe;if(mh[ge]===255){let Le=0,Te=0,ke=-1,je=-1;for(let $e=-1;$e<=1;++$e)for(let nt=-1;nt<=1;++nt){let Ye=(de+$e)*m+pe+nt;if(mh[Ye]>=re)continue;let Ue=mT[Ye],Xe=Math.abs(Ue);Xe>Te&&(Le=Ue,Te=Xe,ke=nt,je=$e)}if(Te>.1){let $e=1-(re+.5*Math.abs(ke*je))/O,nt=n._dem.get(pe,de)+Le*$e,Ye=n._dem.get(pe+ke,de+je),Ue=n._dem.get(pe-ke,de-je,!0);(nt-Ye)*(nt-Ue)>0&&(nt=(Ye+Ue)/2),mT[ge]=n._dem.set(pe,de,nt),mh[ge]=re}}}}}_&&(n._demTile.needsDEMTextureUpload=!0,n._dem._timestamp=Lo.now())}setFilter(e){this.filter=e?Yf(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(e=>this.filter.filter(new ci(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical)):this.nodesInfo}destroy(){let e=this.getNodesInfo();for(let n of e)U0(n.node),jE(n.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,n){if(n.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=n.updateTime;let a=n.getReplacementRegionsForTile(e.toUnwrapped());for(let u of this.getNodesInfo()){let p=u.node.footprint;u.hiddenByReplacement=!!p&&!a.find(m=>m.footprint===p)}}getHeightAtTileCoord(e,n){let a=[],u=[0,0,0],p=yt([]);for(let m of this.getNodesInfo()){let _=m.node.meshes[0],b=_.transformedAabb;if(e<b.min[0]||n<b.min[1]||e>b.max[0]||n>b.max[1])continue;if(m.node.hidden===!0)return{height:1/0,maxHeight:m.feature.properties.height,hidden:!1,verticalScale:m.evaluatedScale[2]};Xt(p,m.node.globalMatrix),u[0]=e,u[1]=n,ki(u,u,p);let w=(u[0]-_.aabb.min[0])/(_.aabb.max[0]-_.aabb.min[0])*hh|0,I=Math.min(63,(u[1]-_.aabb.min[1])/(_.aabb.max[1]-_.aabb.min[1])*hh|0)*hh+Math.min(63,w),S=_.heightmap[I];if(!(S<0&&m.node.footprint))return m.hiddenByReplacement?void 0:{height:S,maxHeight:m.feature.properties.height,hidden:!1,verticalScale:m.evaluatedScale[2]};if(m.node.footprint.grid.query(new Ze(e,n),new Ze(e,n),a),a.length>0)return{height:void 0,maxHeight:m.feature.properties.height,hidden:m.hiddenByReplacement,verticalScale:m.evaluatedScale[2]}}}}function j_(r,e){return r instanceof Jd&&!r.isLightConstant&&e}function J3(r,e,n,a,u,p,m,_){let b=(61440&e|(61440&e)>>4)>>8,w=(3840&e|(3840&e)>>4)>>4,I=240&e|(240&e)>>4;n[3]>0&&(b=zt(b,255*n[0],n[3]),w=zt(w,255*n[1],n[3]),I=zt(I,255*n[2],n[3]));let S=b<<8|w,D=I<<8|Math.floor(255*a[3]),P=(function(re){let de=G(re,0,2);return Math.min(Math.round(.5*de*255),255)})(a[2])<<8|15*a[0]<<4|15*a[1],O=G(u[0],0,1),N=G(u[1],0,1),V=G(u[2],0,1),U=G(u[3],0,1),W,X,K,le;if(O!==N&&m!==p&&N!==O){let re=m-p;X=1/(re*(N-O)),K=-(p+re*O)/(re*(N-O));let de=G(u[4],-1,1);le=Math.pow(10,de),W=255*V<<8|255*U}else W=65535,X=0,K=1,le=1;if(r.emplaceBack(S,D,P,W,X,K,le),_){let re=_.length;_.clear();for(let de=0;de<re;de++)_.emplaceBack(S,D,P,W,X,K,le)}}function Q3(r,e,n){let a=r.node,u=0,p=n&xp.HasMeshoptCompression;for(let m of a.meshes){if(a.lights&&a.lightMeshIndex===u||!m.featureData)continue;m.featureArray=new Su,m.featureArray.reserve(m.featureData.length);let _=e;for(let b of m.featureData){let w=p?65535&b:b>>16&65535,I=p?b>>16&65535:65535&b,S=(15&I)<8?15&I:0,D=r.evaluatedRMEA[S],P=r.evaluatedColor[S],O=r.emissionHeightBasedParams[S],N;if(_&&S===2&&a.lights&&(N=new Su,N.resize(10*a.lights.length)),J3(m.featureArray,w,P,D,O,m.aabb.min[2],m.aabb.max[2],N),N&&_){_=!1;let V=a.meshes[a.lightMeshIndex];V.featureArray=N,V.featureArray._trim()}}m.featureArray._trim(),u++}}vt(ax,"Tiled3dModelBucket",{omit:["layers"]}),vt(rP,"Tiled3dModelFeature");let eV=["id","tile","layer","source","sourceLayer","state"];class gh{constructor(e,n,a,u,p){this.type="Feature",this._vectorTileFeature=e,this._z=n,this._x=a,this._y=u,this.properties=e?e.properties:{},this.id=p}clone(){let e=new gh(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&this._vectorTileFeature&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){let e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let n of eV)this[n]!==void 0&&(e[n]=this[n]);return e}}class _h extends Ra{constructor(e,n,a,u){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=n,this._modelsInfo=new Map}load(){let e=[];for(let n in this._options.models){let a=this._options.models[n],u=this._modelsInfo.get(n);if(u){let p=u.model;p.position=a.position!=null?new L(a.position[0],a.position[1]):new L(0,0),p.orientation=a.orientation!=null?a.orientation:[0,0,0],u.modelSpec=a,_h.applyModelSpecification(p,a),p.computeBoundsAndApplyParent(),this.models.push(p)}else{let p=EM(this.map._requestManager.transformRequest(a.uri,Jl.Model).url).then(m=>{if(!m)return;let _=HE(m),b=new CM(n,a.uri,a.position,a.orientation,_);_h.applyModelSpecification(b,a),b.computeBoundsAndApplyParent(),this.models.push(b),this._modelsInfo.set(n,{modelSpec:a,model:b})}).catch(m=>{this.fire(new Rd(new Error(`Could not load model ${n} from ${a.uri}: ${m.message}`)))});e.push(p)}}Promise.allSettled(e).then(()=>{this._loaded=!0,this.fire(new Zo("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(n=>{this._loaded=!0,this.fire(new Rd(new Error(`Could not load models: ${n.message}`)))})}static applyModelSpecification(e,n){n.nodeOverrides&&_h.convertNodeOverrides(e,n.nodeOverrides),n.materialOverrides&&_h.convertMaterialOverrides(e,n.materialOverrides),n.nodeOverrideNames&&(e.nodeOverrideNames=[...n.nodeOverrideNames]),n.materialOverrideNames&&(e.materialOverrideNames=[...n.materialOverrideNames]),n.featureProperties&&(e.featureProperties=n.featureProperties)}static convertNodeOverrides(e,n){if(Array.isArray(n)&&n.every(a=>typeof a=="string")){e.nodeOverrideNames=[];for(let a of n)e.nodeOverrideNames.push(a)}else Object.entries(n).forEach(([a,u])=>{let p={orientation:[0,0,0]};if(u.hasOwnProperty("orientation")){let m=u.orientation;m&&(p.orientation=m)}e.nodeOverrides.set(a,p)})}static convertMaterialOverrides(e,n){if(Array.isArray(n)&&n.every(a=>typeof a=="string")){e.materialOverrideNames=[];for(let a of n)e.materialOverrideNames.push(a)}else Object.entries(n).forEach(([a,u])=>{let p={color:new Nn(1,1,1),colorMix:0,emissionStrength:0,opacity:1},m=u["model-color"];m!==void 0&&(p.color.r=m[0],p.color.g=m[1],p.color.b=m[2]);let _=u["model-color-mix-intensity"];_!==void 0&&(p.colorMix=_);let b=u["model-emissive-strength"];b!==void 0&&(p.emissionStrength=b);let w=u["model-opacity"];w!==void 0&&(p.opacity=w),e.materialOverrides.set(a,p)})}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,n){}serialize(){return this._options}setProperty(e,n){return!1}reload(){let e=dc(this.id,this.scope);this.map.style.clearSource(e),this.models=[],this._modelsInfo.clear(),this._loaded=!1,this.load()}setModels(e){this.models=[];let n=new Map;for(let a in e){let u=e[a];if(this._modelsInfo.has(a)){let p=this._modelsInfo.get(a);p&&p.modelSpec.uri===u.uri&&n.set(a,p)}}this._modelsInfo=n,this._options.models=e,this._loaded=!1,this.load()}}function gT(r,e,n,a){let u=1<<r.z;e.lat=Y((a/rt+r.y)/u),e.lng=J((n/rt+r.x)/u)}function tV(r,e,n,a){let u=r.getNodesInfo()[e];if(!u||u.hiddenByReplacement||!u.node.meshes)return;let p=Number.MAX_VALUE,m=u.node,_=n.tile,b=a.calculatePosMatrix(_.tileID.toUnwrapped(),a.worldSize),w=u.evaluatedScale,I=0;a.elevation&&m.elevation&&(I=m.elevation*a.elevation.exaggeration()),Lt(b,b,[(m.anchor?m.anchor[0]:0)*(w[0]-1),(m.anchor?m.anchor[1]:0)*(w[1]-1),I]),qn(b,b,w);let S=n.queryGeometry,D=S.isPointQuery()?S.screenBounds:S.screenGeometry,P=function(N){let V=At([],b,N.globalMatrix);At(V,a.expandedFarZProjMatrix,V);for(let U=0;U<N.meshes.length;++U){let W=N.meshes[U];if(U===N.lightMeshIndex)continue;let X=BE(D,a,V,W.aabb);X!=null&&(p=Math.min(X,p))}if(N.children)for(let U of N.children)P(U)};if(P(m),p===Number.MAX_VALUE)return;let O=new L(0,0);return gT(_.tileID.canonical,O,u.node.anchor[0],u.node.anchor[1]),{intersectionZ:p,position:O,feature:u.feature}}let nV={circle:class extends io{constructor(r,e,n,a){super(r,{layout:Ua||(Ua=new zi({"circle-sort-key":new dt(Ee.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Ke(Ee.layout_circle["circle-elevation-reference"]),visibility:new Ke(Ee.layout_circle.visibility)})),paint:Au||(Au=new zi({"circle-radius":new dt(Ee.paint_circle["circle-radius"]),"circle-color":new dt(Ee.paint_circle["circle-color"]),"circle-blur":new dt(Ee.paint_circle["circle-blur"]),"circle-opacity":new dt(Ee.paint_circle["circle-opacity"]),"circle-translate":new Ke(Ee.paint_circle["circle-translate"]),"circle-translate-anchor":new Ke(Ee.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ke(Ee.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ke(Ee.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new dt(Ee.paint_circle["circle-stroke-width"]),"circle-stroke-color":new dt(Ee.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new dt(Ee.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Ke(Ee.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a)}createBucket(r){return new Ti(r)}queryRadius(r){let e=r;return Ar("circle-radius",this,e)+Ar("circle-stroke-width",this,e)+Li(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,n,a,u,p,m,_){let b=Cu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),p.angle,r.pixelToTileUnitsFactor),w=this.paint.get("circle-radius").evaluate(e,n)+this.paint.get("circle-stroke-width").evaluate(e,n);return uA(r,a,p,m,_,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",b,w)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,n){let a=cA(this);return{config:new ja(this,{zoom:e,lut:n}),defines:a,overrideFog:!1}}is3D(r){return!r&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends io{createBucket(r){return new hA(r)}constructor(r,e,n,a){super(r,{layout:fA||(fA=new zi({visibility:new Ke(Ee.layout_heatmap.visibility)})),paint:pA||(pA=new zi({"heatmap-radius":new dt(Ee.paint_heatmap["heatmap-radius"]),"heatmap-weight":new dt(Ee.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ke(Ee.paint_heatmap["heatmap-intensity"]),"heatmap-color":new gu(Ee.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ke(Ee.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){r==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=c_({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(r){return Ar("heatmap-radius",this,r)}queryIntersectsFeature(r,e,n,a,u,p,m,_){let b=this.paint.get("heatmap-radius").evaluate(e,n);return uA(r,a,p,m,_,!0,!0,new Ze(0,0),b)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,n){return r==="heatmap"?{config:new ja(this,{zoom:e,lut:n}),overrideFog:!1}:{}}},hillshade:class extends io{constructor(r,e,n,a){super(r,{layout:mA||(mA=new zi({visibility:new Ke(Ee.layout_hillshade.visibility)})),paint:gA||(gA=new zi({"hillshade-illumination-direction":new Ke(Ee.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ke(Ee.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ke(Ee.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ke(Ee.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ke(Ee.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ke(Ee.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Ke(Ee.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,n){return{overrideFog:!1}}},fill:class extends io{constructor(r,e,n,a){super(r,{layout:RA||(RA=new zi({"fill-sort-key":new dt(Ee.layout_fill["fill-sort-key"]),visibility:new Ke(Ee.layout_fill.visibility),"fill-elevation-reference":new Ke(Ee.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new dt(Ee.layout_fill["fill-construct-bridge-guard-rail"])})),paint:PA||(PA=new zi({"fill-antialias":new Ke(Ee.paint_fill["fill-antialias"]),"fill-opacity":new dt(Ee.paint_fill["fill-opacity"]),"fill-color":new dt(Ee.paint_fill["fill-color"]),"fill-outline-color":new dt(Ee.paint_fill["fill-outline-color"]),"fill-translate":new Ke(Ee.paint_fill["fill-translate"]),"fill-translate-anchor":new Ke(Ee.paint_fill["fill-translate-anchor"]),"fill-pattern":new dt(Ee.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new Ke(Ee.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new Ke(Ee.paint_fill["fill-emissive-strength"]),"fill-z-offset":new dt(Ee.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new dt(Ee.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new dt(Ee.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a)}getProgramIds(){let r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),n=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&n.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),n}getDefaultProgramParams(r,e,n){return{config:new ja(this,{zoom:e,lut:n}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);let n=this.paint._values["fill-outline-color"];n.value.kind==="constant"&&n.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new wE(r)}queryRadius(){return Li(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,n,a,u,p){return!r.queryGeometry.isAboveHorizon&&Bi(ts(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),p.angle,r.pixelToTileUnitsFactor),a)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(r){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;let e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return r!=null?e&&!r:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends io{constructor(r,e,n,a){super(r,{layout:iM||(iM=new zi({visibility:new Ke(Ee["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Ke(Ee["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:rM||(rM=new zi({"fill-extrusion-opacity":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new dt(Ee["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Ke(Ee["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new R0(r)}queryRadius(){return Li(this.paint.get("fill-extrusion-translate"))}is3D(r){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,n,a,u,p,m,_,b){let w=Cu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),p.angle,r.pixelToTileUnitsFactor),I=this.paint.get("fill-extrusion-height").evaluate(e,n),S=this.paint.get("fill-extrusion-base").evaluate(e,n),D=[0,0],P=_&&p.elevation,O=p.elevation?p.elevation.exaggeration():1,N=r.tile.getBucket(this);if(P&&N instanceof R0){let K=N.centroidVertexArray,le=b+1;le<K.length&&(D[0]=K.geta_centroid_pos0(le),D[1]=K.geta_centroid_pos1(le))}if(D[0]===0&&D[1]===1)return!1;p.projection.name==="globe"&&(a=nM([a],[new Ze(0,0),new Ze(rt,rt)],r.tileID.canonical).map(K=>K.polygon).flat());let V=P?_:null,[U,W]=dM(p,a,S,I,w,m,V,D,O,p.center.lat,r.tileID.canonical),X=r.queryGeometry;return uM(U,W,X.isPointQuery()?X.screenBounds:X.screenGeometry)}},building:class extends io{constructor(r,e,n,a){super(r,{layout:kM||(kM=new zi({visibility:new Ke(Ee.layout_building.visibility),"building-facade":new dt(Ee.layout_building["building-facade"]),"building-facade-floors":new dt(Ee.layout_building["building-facade-floors"]),"building-facade-unit-width":new dt(Ee.layout_building["building-facade-unit-width"]),"building-facade-window":new dt(Ee.layout_building["building-facade-window"]),"building-roof-shape":new dt(Ee.layout_building["building-roof-shape"]),"building-height":new dt(Ee.layout_building["building-height"]),"building-base":new dt(Ee.layout_building["building-base"]),"building-flood-light-wall-radius":new dt(Ee.layout_building["building-flood-light-wall-radius"]),"building-flood-light-ground-radius":new dt(Ee.layout_building["building-flood-light-ground-radius"]),"building-flip-roof-orientation":new dt(Ee.layout_building["building-flip-roof-orientation"])})),paint:NM||(NM=new zi({"building-opacity":new Ke(Ee.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new Ke(Ee.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new Ke(Ee.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new Ke(Ee.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new Ke(Ee.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new Ke(Ee.paint_building["building-vertical-scale"]),"building-cast-shadows":new Ke(Ee.paint_building["building-cast-shadows"]),"building-color":new dt(Ee.paint_building["building-color"]),"building-emissive-strength":new dt(Ee.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new Ke(Ee.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new Ke(Ee.paint_building["building-cutoff-fade-range"]),"building-flood-light-color":new Ke(Ee.paint_building["building-flood-light-color"]),"building-flood-light-intensity":new Ke(Ee.paint_building["building-flood-light-intensity"]),"building-flood-light-ground-attenuation":new Ke(Ee.paint_building["building-flood-light-ground-attenuation"]),"building-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"building-flood-light-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new FM(r)}cutoffRange(){return this.paint.get("building-cutoff-fade-range")}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(r){return!0}queryRadius(r){return 0}queryIntersectsFeature(r,e,n,a,u,p,m,_,b){let w=this.layout.get("building-height").evaluate(e,n),I=this.layout.get("building-base").evaluate(e,n),S=r.tile.getBucket(this).getFootprint(e);if(S){if(S.hiddenFlags!==0)return!1;w=S.height}let[D,P]=dM(p,a,I,w,new Ze(0,0),m,null,[0,0],1,p.center.lat,r.tileID.canonical),O=r.queryGeometry;return uM(D,P,O.isPointQuery()?O.screenBounds:O.screenGeometry)}},line:class extends io{constructor(r,e,n,a){let u=WM();super(r,u,e,n,a),u.layout&&(this.layout=new uc(u.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if(r==="line-gradient"){let e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof qd,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(S_)return S_;let n=WM();return S_=new JB(n.paint.properties["line-width"].specification),S_.useIntegerZoom=!0,S_})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new GE(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,n){let a=GM(this);return{config:new ja(this,{zoom:e,lut:n}),defines:a,overrideFog:!1}}queryRadius(r){let e=r,n=ZM(Ar("line-width",this,e),Ar("line-gap-width",this,e)),a=Ar("line-offset",this,e);return n/2+Math.abs(a)+Li(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,n,a,u,p){if(r.queryGeometry.isAboveHorizon)return!1;let m=ts(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),p.angle,r.pixelToTileUnitsFactor),_=r.pixelToTileUnitsFactor/2*ZM(this.paint.get("line-width").evaluate(e,n),this.paint.get("line-gap-width").evaluate(e,n)),b=this.paint.get("line-offset").evaluate(e,n);return b&&(a=(function(w,I){let S=[],D=new Ze(0,0);for(let P=0;P<w.length;P++){let O=w[P],N=[];for(let V=0;V<O.length;V++){let U=O[V],W=O[V+1],X=V===0?D:U.sub(O[V-1])._unit()._perp(),K=V===O.length-1?D:W.sub(U)._unit()._perp(),le=X._add(K)._unit();le._mult(1/(le.x*K.x+le.y*K.y)),N.push(le._mult(I)._add(U))}S.push(N)}return S})(a,b*r.pixelToTileUnitsFactor)),(function(w,I,S){for(let D=0;D<I.length;D++){let P=I[D];if(w.length>=3){for(let O=0;O<P.length;O++)if(Cr(w,P[O]))return!0}if(So(w,P,S))return!0}return!1})(m,a,_)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(r){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:ix,background:class extends io{constructor(r,e,n,a){super(r,{layout:NR||(NR=new zi({visibility:new Ke(Ee.layout_background.visibility)})),paint:zR||(zR=new zi({"background-pitch-alignment":new Ke(Ee.paint_background["background-pitch-alignment"]),"background-color":new Ke(Ee.paint_background["background-color"]),"background-pattern":new Ke(Ee.paint_background["background-pattern"]),"background-opacity":new Ke(Ee.paint_background["background-opacity"]),"background-emissive-strength":new Ke(Ee.paint_background["background-emissive-strength"]),"background-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,n){return{overrideFog:!1}}is3D(r){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:HR,"raster-particle":XR,sky:class extends io{constructor(r,e,n,a){super(r,{layout:qR||(qR=new zi({visibility:new Ke(Ee.layout_sky.visibility)})),paint:WR||(WR=new zi({"sky-type":new Ke(Ee.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ke(Ee.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ke(Ee.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ke(Ee.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ke(Ee.paint_sky["sky-gradient-radius"]),"sky-gradient":new gu(Ee.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ke(Ee.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ke(Ee.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ke(Ee.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(r){r==="sky-gradient"?this._updateColorRamp():r!=="sky-atmosphere-sun"&&r!=="sky-atmosphere-halo-color"&&r!=="sky-atmosphere-color"&&r!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=c_({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if(this.paint.get("sky-type")==="atmosphere"){let a=this.paint.get("sky-atmosphere-sun"),u=!a,p=r.style.light,m=p.properties.get("position");return u&&p.properties.get("anchor")==="viewport"&&Rt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),u?hT(m.azimuthal,90-m.polar,e):hT(a[0],90-a[1],e)}let n=this.paint.get("sky-gradient-center");return hT(n[0],90-n[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let r=this.paint.get("sky-type");return r==="atmosphere"?["skyboxCapture","skybox"]:r==="gradient"?["skyboxGradient"]:null}},slot:class extends io{constructor(r,e,n,a){super(r,{paint:ZR||(ZR=new zi({}))},e,null)}},model:class extends io{constructor(r,e,n,a){super(r,{layout:QR||(QR=new zi({visibility:new Ke(Ee.layout_model.visibility),"model-id":new dt(Ee.layout_model["model-id"])})),paint:eP||(eP=new zi({"model-opacity":new dt(Ee.paint_model["model-opacity"]),"model-rotation":new dt(Ee.paint_model["model-rotation"]),"model-scale":new dt(Ee.paint_model["model-scale"]),"model-translation":new dt(Ee.paint_model["model-translation"]),"model-color":new dt(Ee.paint_model["model-color"]),"model-color-mix-intensity":new dt(Ee.paint_model["model-color-mix-intensity"]),"model-type":new Ke(Ee.paint_model["model-type"]),"model-cast-shadows":new Ke(Ee.paint_model["model-cast-shadows"]),"model-receive-shadows":new Ke(Ee.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Ke(Ee.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new dt(Ee.paint_model["model-emissive-strength"]),"model-roughness":new dt(Ee.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new dt(Ee.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Ke(Ee.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Ke(Ee.paint_model["model-front-cutoff"]),"model-elevation-reference":new Ke(Ee.paint_model["model-elevation-reference"]),"model-color-use-theme":new dt({type:"string",default:"default","property-type":"data-driven"})}))},e,n,a),this.layer=r,this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new pT(r)}getProgramIds(){return["model"]}is3D(r){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof ax?rt-1:0}queryRenderedFeatures(r,e,n){let a=e.getSource();if(!(a&&a instanceof _h))return{};let u=a,p={};p[this.id]=[];let m=p[this.id],_=0;for(let b of u.models){let w=e.getFeatureState(this.sourceLayer,b.id),I={type:"Unknown",id:b.id,properties:b.featureProperties},S=this.paint.get("model-rotation").evaluate(I,w),D=this.paint.get("model-scale").evaluate(I,w),P=this.paint.get("model-translation").evaluate(I,w),O=this.paint.get("model-elevation-reference"),N=[];j0(N,b,n,b.position,S,D,P,O==="ground",O==="ground",!1),n.projection.name==="globe"&&(N=V0(N,n));let V=At([],n.projMatrix,N),U=BE(r.isPointQuery()?r.screenBounds:r.screenGeometry,n,V,b.aabb);if(U!=null){let W=new gh(void 0,0,0,0,b.id);W.layer=this.layer,W.properties=structuredClone(b.featureProperties),W.properties.layer=this.id,W.properties.uri=b.uri,W.properties.orientation=b.orientation,W.sourceLayer=this.sourceLayer,W.geometry={type:"Point",coordinates:[b.position.lng,b.position.lat]},W.state=w,W.source=this.source,m.push({featureIndex:_,feature:W,intersectionZ:U})}++_}return p}queryIntersectsFeature(r,e,n,a,u,p){if(!this.modelManager)return!1;let m=this.modelManager,_=r.tile.getBucket(this);if(!(_&&_ instanceof pT))return!1;for(let b in _.instancesPerModel){let w=_.instancesPerModel[b],I=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(w.idToFeaturesIndex.hasOwnProperty(I)){let S=w.features[w.idToFeaturesIndex[I]],D=m.getModel(b,this.scope);if(!D)return!1;let P=[],O=new L(0,0),N=_.canonical,V=Number.MAX_VALUE;for(let U=0;U<S.instancedDataCount;++U){let W=16*(S.instancedDataOffset+U),X=w.instancedDataArray.float32,K=[X[W+4],X[W+5],X[W+6]];gT(N,O,Math.floor(X[W]),Math.floor(X[W+1])),j0(P,D,p,O,S.rotation,S.scale,K,!1,!1,!1),p.projection.name==="globe"&&(P=V0(P,p));let le=At([],p.projMatrix,P),re=r.queryGeometry,de=BE(re.isPointQuery()?re.screenBounds:re.screenGeometry,p,le,D.aabb);de!=null&&(V=Math.min(de,V))}return V!==Number.MAX_VALUE&&V}}return!1}_handleOverridablePaintPropertyUpdate(r,e,n){return!(!this.layout||e.isDataDriven()||n.isDataDriven()||r!=="model-color"&&r!=="model-color-mix-intensity"&&r!=="model-rotation"&&r!=="model-scale"&&r!=="model-translation"&&r!=="model-emissive-strength")}_isPropertyZoomDependent(r){let e=this._transitionablePaint._values[r];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof gl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends io{constructor(r,e,n,a){super(r,{layout:OA||(OA=new zi({"clip-layer-types":new Ke(Ee.layout_clip["clip-layer-types"]),"clip-layer-scope":new Ke(Ee.layout_clip["clip-layer-scope"])})),paint:LA||(LA=new zi({}))},e,n,a)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new FA(r)}is3D(r){return!0}}},_T=new Nn(0,0,0),yT={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},vT={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},lx={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},iV={PAINT_ORDER_FILL_AND_STROKE:1},U_={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},oP={MASK_TYPE_LUMINANCE:1};function rV(r,e,n){r===1&&e.icons.push((function(a,u){return(function(p){if(p.usvg_tree.height||(p.usvg_tree.height=p.usvg_tree.width),!p.metadata)return p;let{metadata:m}=p;if(m.content_area){let{content_area:_}=m;_.left==null&&(_.left=0),_.top==null&&(_.top=_.left),_.width==null&&(_.width=p.usvg_tree.width),_.height==null&&(_.height=_.width)}if(m.text_placeholder){let{text_placeholder:_}=m;_.top==null&&(_.top=_.left),_.height==null&&(_.height=_.width)}return m.stretch_x&&m.stretch_x.length&&sP(m,"x"),m.stretch_y&&m.stretch_y.length&&sP(m,"y"),p})(a.readFields(oV,{name:void 0},u))})(n,n.readVarint()+n.pos))}function sP(r,e){let n=[],a=r[`stretch_${e}`],u=null;for(let p=0;p<a.length;p++)u===null?u=n.length===0?a[0]:n[n.length-1][1]+a[p]:(n.push([u,u+a[p]]),u=null);r[`stretch_${e}_areas`]=n}function oV(r,e,n){r===1?e.name=n.readString():r===2?e.metadata=(function(a,u){return a.readFields(sV,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},u)})(n,n.readVarint()+n.pos):r===3&&(e.usvg_tree=(function(a,u){return a.readFields(cV,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},u)})(n,n.readVarint()+n.pos),e.data="usvg_tree")}function sV(r,e,n){r===1?e.stretch_x=n.readPackedVarint():r===2?e.stretch_y=n.readPackedVarint():r===3?e.content_area=aP(n,n.readVarint()+n.pos):r===4?e.variables.push((function(a,u){return a.readFields(lV,{name:void 0},u)})(n,n.readVarint()+n.pos)):r===5&&(e.text_placeholder=aP(n,n.readVarint()+n.pos))}function aP(r,e){return r.readFields(aV,{},e)}function aV(r,e,n){r===1?e.left=n.readVarint():r===2?e.width=n.readVarint():r===3?e.top=n.readVarint():r===4&&(e.height=n.readVarint())}function lV(r,e,n){r===1?e.name=n.readString():r===2&&(e.rgb_color=dx(n.readVarint()),e.value="rgb_color")}function cV(r,e,n){r===1?e.width=e.height=n.readVarint():r===2?e.height=n.readVarint():r===3?e.children.push(cx(n,n.readVarint()+n.pos)):r===4?e.linear_gradients.push((function(a,u){return a.readFields(gV,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},u)})(n,n.readVarint()+n.pos)):r===5?e.radial_gradients.push((function(a,u){return a.readFields(yV,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},u)})(n,n.readVarint()+n.pos)):r===7?e.clip_paths.push((function(a,u){return a.readFields(vV,{children:[]},u)})(n,n.readVarint()+n.pos)):r===8&&e.masks.push((function(a,u){let p=a.readFields(xV,{left:0,width:20,mask_type:oP.MASK_TYPE_LUMINANCE,children:[]},u);return p.height==null&&(p.height=p.width),p.top==null&&(p.top=p.left),p})(n,n.readVarint()+n.pos))}function cx(r,e){return r.readFields(uV,{},e)}function uV(r,e,n){r===1?(e.group=(function(a,u){return a.readFields(dV,{opacity:255,children:[]},u)})(n,n.readVarint()+n.pos),e.node="group"):r===2&&(e.path=(function(a,u){return a.readFields(fV,{paint_order:1,commands:[],step:1,diffs:[],rule:yT.PATH_RULE_NON_ZERO},u)})(n,n.readVarint()+n.pos),e.node="path")}function dV(r,e,n){r===1?e.transform=ux(n,n.readVarint()+n.pos):r===2?e.opacity=n.readVarint():r===5?e.clip_path_idx=n.readVarint():r===6?e.mask_idx=n.readVarint():r===7&&e.children.push(cx(n,n.readVarint()+n.pos))}function ux(r,e){return r.readFields(hV,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function hV(r,e,n){r===1?e.sx=n.readFloat():r===2?e.ky=n.readFloat():r===3?e.kx=n.readFloat():r===4?e.sy=n.readFloat():r===5?e.tx=n.readFloat():r===6&&(e.ty=n.readFloat())}function fV(r,e,n){r===1?e.fill=(function(a,u){return a.readFields(pV,{rgb_color:_T,paint:"rgb_color",opacity:255},u)})(n,n.readVarint()+n.pos):r===2?e.stroke=(function(a,u){return a.readFields(mV,{rgb_color:_T,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},u)})(n,n.readVarint()+n.pos):r===3?e.paint_order=n.readVarint():r===5?n.readPackedVarint(e.commands):r===6?e.step=n.readFloat():r===7?n.readPackedSVarint(e.diffs):r===8&&(e.rule=n.readVarint())}function pV(r,e,n){r===1?(e.rgb_color=dx(n.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):r===5&&(e.opacity=n.readVarint())}function dx(r){return new Nn((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function mV(r,e,n){r===1?(e.rgb_color=dx(n.readVarint()),e.paint="rgb_color"):r===2?(e.linear_gradient_idx=n.readVarint(),e.paint="linear_gradient_idx"):r===3?(e.radial_gradient_idx=n.readVarint(),e.paint="radial_gradient_idx"):r===5?n.readPackedFloat(e.dasharray):r===6?e.dashoffset=n.readFloat():r===7?e.miterlimit=n.readFloat():r===8?e.opacity=n.readVarint():r===9?e.width=n.readFloat():r===10?e.linecap=n.readVarint():r===11&&(e.linejoin=n.readVarint())}function gV(r,e,n){r===1?e.transform=ux(n,n.readVarint()+n.pos):r===2?e.spread_method=n.readVarint():r===3?e.stops.push(lP(n,n.readVarint()+n.pos)):r===4?e.x1=n.readFloat():r===5?e.y1=n.readFloat():r===6?e.x2=n.readFloat():r===7&&(e.y2=n.readFloat())}function lP(r,e){return r.readFields(_V,{offset:0,opacity:255,rgb_color:_T},e)}function _V(r,e,n){r===1?e.offset=n.readFloat():r===2?e.opacity=n.readVarint():r===3&&(e.rgb_color=dx(n.readVarint()))}function yV(r,e,n){r===1?e.transform=ux(n,n.readVarint()+n.pos):r===2?e.spread_method=n.readVarint():r===3?e.stops.push(lP(n,n.readVarint()+n.pos)):r===4?e.cx=n.readFloat():r===5?e.cy=n.readFloat():r===6?e.r=n.readFloat():r===7?e.fx=n.readFloat():r===8?e.fy=n.readFloat():r===9&&(e.fr=n.readFloat())}function vV(r,e,n){r===1?e.transform=ux(n,n.readVarint()+n.pos):r===2?e.clip_path_idx=n.readVarint():r===3&&e.children.push(cx(n,n.readVarint()+n.pos))}function xV(r,e,n){r===1?e.left=e.top=n.readFloat():r===2?e.width=e.height=n.readFloat():r===3?e.top=n.readFloat():r===4?e.height=n.readFloat():r===5?e.mask_type=n.readVarint():r===6?e.mask_idx=n.readVarint():r===7&&e.children.push(cx(n,n.readVarint()+n.pos))}class bV{static calculate(e={},n=[]){let a=new Map,u=new Map;if(Object.keys(e).length===0)return a;n.forEach(p=>{u.set(p.name,p.rgb_color||new Nn(0,0,0))});for(let[p,m]of Object.entries(e))u.has(p)?a.set(u.get(p).toString(),m):console.warn(`Ignoring unknown image variable "${p}"`);return a}}function Mp(r,e=255,n){let a=e/255,u=r.toString(),p=n.has(u)?n.get(u).clone():r.clone();return p.a*=a,p.toString()}function H_(r,e){if(!Oo()){let n=document.createElement("canvas");return n.width=r,n.height=e,n}return new OffscreenCanvas(r,e)}function wV(r,e){let n=bV.calculate(e.params,r.metadata?r.metadata.variables:[]),a=r.usvg_tree,u=a.width,p=a.height,m=e.transform?e.transform:new DOMMatrix,_=Math.max(1,Math.round(u*m.a)),b=Math.max(1,Math.round(p*m.d)),w=new DOMMatrix([_/u,0,0,b/p,0,0]),I=H_(_,b).getContext("2d");return xT(I,w,a,a,n),I.getImageData(0,0,_,b)}function xT(r,e,n,a,u){for(let p of a.children)cP(r,e,n,p,u)}function cP(r,e,n,a,u){a.group?(r.save(),(function(p,m,_,b,w){let I=b.mask_idx!=null?_.masks[b.mask_idx]:null,S=b.clip_path_idx!=null?_.clip_paths[b.clip_path_idx]:null;if(b.transform&&(m=Rp(b.transform).preMultiplySelf(m)),!(function(O,N,V){return O.opacity!==255||N||V})(b,S!=null,I!=null))return void xT(p,m,_,b,w);let D=H_(p.canvas.width,p.canvas.height),P=D.getContext("2d");xT(P,m,_,b,w),S&&gP(P,m,_,S),I&&_P(P,m,_,I,w),p.globalAlpha=b.opacity/255,p.drawImage(D,0,0)})(r,e,n,a.group,u),r.restore()):a.path&&(r.save(),(function(p,m,_,b,w){p.setTransform(m),b.paint_order===iV.PAINT_ORDER_FILL_AND_STROKE?(uP(p,_,b,w),hP(p,_,b,w)):(hP(p,_,b,w),uP(p,_,b,w))})(r,e,n,a.path,u),r.restore())}function uP(r,e,n,a){let u=n.fill;if(!u)return;let p=u.opacity/255;switch(r.save(),r.beginPath(),yP(n,r),u.paint){case"rgb_color":r.fillStyle=Mp(u.rgb_color,u.opacity,a);break;case"linear_gradient_idx":{let m=e.linear_gradients[u.linear_gradient_idx];m.transform&&r.setTransform(Rp(m.transform).preMultiplySelf(r.getTransform())),r.fillStyle=fP(r,m,p,a);break}case"radial_gradient_idx":{let m=e.radial_gradients[u.radial_gradient_idx];m.transform&&r.setTransform(Rp(m.transform).preMultiplySelf(r.getTransform())),r.fillStyle=pP(r,m,p,a)}}r.fill(dP(n)),r.restore()}function dP(r){return r.rule===yT.PATH_RULE_NON_ZERO?"nonzero":r.rule===yT.PATH_RULE_EVEN_ODD?"evenodd":void 0}function hP(r,e,n,a){let u=n.stroke;if(!u)return;let p=vP(n);r.lineWidth=u.width,r.miterLimit=u.miterlimit,r.setLineDash(u.dasharray),r.lineDashOffset=u.dashoffset;let m=u.opacity/255;switch(u.paint){case"rgb_color":r.strokeStyle=Mp(u.rgb_color,u.opacity,a);break;case"linear_gradient_idx":r.strokeStyle=fP(r,e.linear_gradients[u.linear_gradient_idx],m,a,!0);break;case"radial_gradient_idx":r.strokeStyle=pP(r,e.radial_gradients[u.radial_gradient_idx],m,a,!0)}switch(u.linejoin){case lx.LINE_JOIN_MITER_CLIP:case lx.LINE_JOIN_MITER:r.lineJoin="miter";break;case lx.LINE_JOIN_ROUND:r.lineJoin="round";break;case lx.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(u.linecap){case vT.LINE_CAP_BUTT:r.lineCap="butt";break;case vT.LINE_CAP_ROUND:r.lineCap="round";break;case vT.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(p)}function fP(r,e,n,a,u=!1){if(e.stops.length===1){let D=e.stops[0];return Mp(D.rgb_color,D.opacity*n,a)}let{x1:p,y1:m,x2:_,y2:b}=e,w=new DOMPoint(p,m),I=new DOMPoint(_,b);if(u){let D=Rp(e.transform);w=D.transformPoint(w),I=D.transformPoint(I)}let S=r.createLinearGradient(w.x,w.y,I.x,I.y);for(let D of e.stops)S.addColorStop(D.offset,Mp(D.rgb_color,D.opacity*n,a));return S}function pP(r,e,n,a,u=!1){if(e.stops.length===1){let U=e.stops[0];return Mp(U.rgb_color,U.opacity*n,a)}let p=Rp(e.transform),{fx:m,fy:_,fr:b,cx:w,cy:I,r:S}=e,D=new DOMPoint(m,_),P=new DOMPoint(w,I),O=b,N=S;if(u){D=p.transformPoint(D),P=p.transformPoint(P);let U=(p.a+p.d)/2;O=b*U,N=e.r*U}let V=r.createRadialGradient(D.x,D.y,O,P.x,P.y,N);for(let U of e.stops)V.addColorStop(U.offset,Mp(U.rgb_color,U.opacity*n,a));return V}function mP(r,e,n,a){let u=a.transform?Rp(a.transform).preMultiplySelf(e):e,p=H_(r.canvas.width,r.canvas.height),m=p.getContext("2d");for(let b of a.children)if(b.group)mP(m,u,n,b.group);else if(b.path){let w=b.path,I=new Path2D;I.addPath(vP(w),u),m.fill(I,dP(w))}let _=a.clip_path_idx!=null?n.clip_paths[a.clip_path_idx]:null;_&&gP(m,u,n,_),r.globalCompositeOperation="source-over",r.drawImage(p,0,0)}function gP(r,e,n,a){let u=H_(r.canvas.width,r.canvas.height);mP(u.getContext("2d"),e,n,a),r.globalCompositeOperation="destination-in",r.drawImage(u,0,0)}function _P(r,e,n,a,u){if(a.children.length===0)return;let p=a.mask_idx!=null?n.masks[a.mask_idx]:null;p&&_P(r,e,n,p,u);let m=r.canvas.width,_=r.canvas.height,b=H_(m,_),w=b.getContext("2d"),I=a.width,S=a.height,D=a.left,P=a.top,O=new Path2D,N=new Path2D;N.rect(D,P,I,S),O.addPath(N,e),w.clip(O);for(let W of a.children)cP(w,e,n,W,u);let V=w.getImageData(0,0,m,_),U=V.data;if(a.mask_type===oP.MASK_TYPE_LUMINANCE)for(let W=0;W<U.length;W+=4)U[W+3]=U[W+3]/255*(.2126*U[W]+.7152*U[W+1]+.0722*U[W+2]);w.putImageData(V,0,0),r.globalCompositeOperation="destination-in",r.drawImage(b,0,0)}function Rp(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function yP(r,e){let n=r.step,a=r.diffs[0]*n,u=r.diffs[1]*n;e.moveTo(a,u);for(let p=0,m=2;p<r.commands.length;p++)switch(r.commands[p]){case U_.PATH_COMMAND_MOVE:a+=r.diffs[m++]*n,u+=r.diffs[m++]*n,e.moveTo(a,u);break;case U_.PATH_COMMAND_LINE:a+=r.diffs[m++]*n,u+=r.diffs[m++]*n,e.lineTo(a,u);break;case U_.PATH_COMMAND_QUAD:{let _=a+r.diffs[m++]*n,b=u+r.diffs[m++]*n;a=_+r.diffs[m++]*n,u=b+r.diffs[m++]*n,e.quadraticCurveTo(_,b,a,u);break}case U_.PATH_COMMAND_CUBIC:{let _=a+r.diffs[m++]*n,b=u+r.diffs[m++]*n,w=_+r.diffs[m++]*n,I=b+r.diffs[m++]*n;a=w+r.diffs[m++]*n,u=I+r.diffs[m++]*n,e.bezierCurveTo(_,b,w,I,a,u);break}case U_.PATH_COMMAND_CLOSE:e.closePath()}return e}function vP(r){return yP(r,new Path2D)}class hx{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;let n=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,n),n}put(e,n){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,n)}delete(e){this.cache.delete(e)}}vt(hx,"LRUCache");class bT{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new Yr(e,e.data)}getFromCache(e,n,a){return this.cacheMap.has(a)||this.cacheMap.set(a,new hx(150)),this.cacheMap.get(a).get(dc(e.toString(),n))}setInCache(e,n,a,u){this.cacheDependenciesMap.has(u)||this.cacheDependenciesMap.set(u,new Map),this.cacheMap.has(u)||this.cacheMap.set(u,new hx(150));let p=this.cacheDependenciesMap.get(u),m=dc(e.id.toString(),a);p.get(m)||p.set(m,new Set);let _=this.cacheMap.get(u),b=e.toString();p.get(m).add(b),_.put(dc(e.toString(),a),n)}removeImagesFromCacheByIds(e,n,a=0){if(!this.cacheMap.has(a)||!this.cacheDependenciesMap.has(a))return;let u=this.cacheMap.get(a),p=this.cacheDependenciesMap.get(a);for(let m of e){let _=dc(m.toString(),n);if(p.has(_)){for(let b of p.get(_))u.delete(b);p.delete(_)}}}rasterize(e,n,a,u,p=wV){let m=this.getFromCache(e,a,u);if(m)return m.clone();let _=p(n.icon,e.options),b=bT._getImage(_);return this.setInCache(e,b,a,u),b.clone()}}class xP{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,n){let a=this.toIdx(e,n);return{min:this.minimums[a],max:this.maximums[a]}}isLeaf(e,n){return this.leaves[this.toIdx(e,n)]}toIdx(e,n){return n*this.size+e}}function bP(r,e,n,a){let u=0,p=Number.MAX_VALUE;for(let m=0;m<3;m++)if(Math.abs(a[m])<1e-15){if(n[m]<r[m]||n[m]>e[m])return null}else{let _=1/a[m],b=(r[m]-n[m])*_,w=(e[m]-n[m])*_;if(b>w){let I=b;b=w,w=I}if(b>u&&(u=b),w<p&&(p=w),u>p)return null}return u}function wP(r,e,n,a,u,p,m,_,b,w,I){let S=a-r,D=u-e,P=p-n,O=m-r,N=_-e,V=b-n,U=I[1]*V-I[2]*N,W=I[2]*O-I[0]*V,X=I[0]*N-I[1]*O,K=S*U+D*W+P*X;if(Math.abs(K)<1e-15)return null;let le=1/K,re=w[0]-r,de=w[1]-e,pe=w[2]-n,ge=(re*U+de*W+pe*X)*le;if(ge<0||ge>1)return null;let Le=de*P-pe*D,Te=pe*S-re*P,ke=re*D-de*S,je=(I[0]*Le+I[1]*Te+I[2]*ke)*le;return je<0||ge+je>1?null:(O*Le+N*Te+V*ke)*le}function EP(r,e,n){return(r-e)/(n-e)}function TP(r,e,n,a,u,p,m,_,b){let w=1<<n,I=p-a,S=m-u,D=(r+1)/w*I+a,P=(e+0)/w*S+u,O=(e+1)/w*S+u;_[0]=(r+0)/w*I+a,_[1]=P,b[0]=D,b[1]=O}class IP{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let n=(function(p){let m=Math.ceil(Math.log2(p.dim/8)),_=[],b=Math.ceil(Math.pow(2,m)),w=1/b,I=(P,O,N,V,U)=>{let W=V?1:0,X=(P+1)*N-W,K=O*N,le=(O+1)*N-W;U[0]=P*N,U[1]=K,U[2]=X,U[3]=le},S=new xP(b),D=[];for(let P=0;P<b*b;P++){I(P%b,Math.floor(P/b),w,!1,D);let O=ku(D[0],D[1],p),N=ku(D[2],D[1],p),V=ku(D[2],D[3],p),U=ku(D[0],D[3],p);S.minimums.push(Math.min(O,N,V,U)),S.maximums.push(Math.max(O,N,V,U)),S.leaves.push(1)}for(_.push(S),b/=2;b>=1;b/=2){let P=_[_.length-1];S=new xP(b);for(let O=0;O<b*b;O++){I(O%b,Math.floor(O/b),2,!0,D);let N=P.getElevation(D[0],D[1]),V=P.getElevation(D[2],D[1]),U=P.getElevation(D[2],D[3]),W=P.getElevation(D[0],D[3]),X=P.isLeaf(D[0],D[1]),K=P.isLeaf(D[2],D[1]),le=P.isLeaf(D[2],D[3]),re=P.isLeaf(D[0],D[3]),de=Math.min(N.min,V.min,U.min,W.min),pe=Math.max(N.max,V.max,U.max,W.max),ge=X&&K&&le&&re;S.maximums.push(pe),S.minimums.push(de),S.leaves.push(pe-de<=5&&ge?1:0)}_.push(S)}return _})(this.dem),a=n.length-1,u=n[a];this._addNode(u.minimums[0],u.maximums[0],u.leaves[0]),this._construct(n,0,0,a,0)}raycastRoot(e,n,a,u,p,m,_=1){return bP([e,n,-100],[a,u,this.maximums[0]*_],p,m)}raycast(e,n,a,u,p,m,_=1){if(!this.nodeCount)return null;let b=this.raycastRoot(e,n,a,u,p,m,_);if(b==null)return null;let w=[],I=[],S=[],D=[],P=[{idx:0,t:b,nodex:0,nodey:0,depth:0}];for(;P.length>0;){let{idx:O,t:N,nodex:V,nodey:U,depth:W}=P.pop();if(this.leaves[O]){TP(V,U,W,e,n,a,u,S,D);let K=1<<W,le=(V+0)/K,re=(V+1)/K,de=(U+0)/K,pe=(U+1)/K,ge=ku(le,de,this.dem)*_,Le=ku(re,de,this.dem)*_,Te=ku(re,pe,this.dem)*_,ke=ku(le,pe,this.dem)*_,je=wP(S[0],S[1],ge,D[0],S[1],Le,D[0],D[1],Te,p,m),$e=wP(D[0],D[1],Te,S[0],D[1],ke,S[0],S[1],ge,p,m),nt=Math.min(je!==null?je:Number.MAX_VALUE,$e!==null?$e:Number.MAX_VALUE);if(nt!==Number.MAX_VALUE)return nt;{let Ye=Bs([],p,m,N);if(SP(ge,Le,ke,Te,EP(Ye[0],S[0],D[0]),EP(Ye[1],S[1],D[1]))>=Ye[2])return N}continue}let X=0;for(let K=0;K<this._siblingOffset.length;K++){TP((V<<1)+this._siblingOffset[K][0],(U<<1)+this._siblingOffset[K][1],W+1,e,n,a,u,S,D),S[2]=-100,D[2]=this.maximums[this.childOffsets[O]+K]*_;let le=bP(S,D,p,m);if(le!=null){let re=le;w[K]=re;let de=!1;for(let pe=0;pe<X&&!de;pe++)re>=w[I[pe]]&&(I.splice(pe,0,K),de=!0);de||(I[X]=K),X++}}for(let K=0;K<X;K++){let le=I[K];P.push({idx:this.childOffsets[O]+le,t:w[le],nodex:(V<<1)+this._siblingOffset[le][0],nodey:(U<<1)+this._siblingOffset[le][1],depth:W+1})}}return null}_addNode(e,n,a){return this.minimums.push(e),this.maximums.push(n),this.leaves.push(a),this.childOffsets.push(0),this.nodeCount++}_construct(e,n,a,u,p){if(e[u].isLeaf(n,a)===1)return;this.childOffsets[p]||(this.childOffsets[p]=this.nodeCount);let m=u-1,_=e[m],b=0,w=0;for(let I=0;I<this._siblingOffset.length;I++){let S=2*n+this._siblingOffset[I][0],D=2*a+this._siblingOffset[I][1],P=_.getElevation(S,D),O=_.isLeaf(S,D),N=this._addNode(P.min,P.max,O);O&&(b|=1<<I),w||(w=N)}for(let I=0;I<this._siblingOffset.length;I++)b&1<<I||this._construct(e,2*n+this._siblingOffset[I][0],2*a+this._siblingOffset[I][1],m,w+I)}}function SP(r,e,n,a,u,p){return zt(zt(r,n,p),zt(e,a,p),u)}function ku(r,e,n){let a=n.dim,u=G(r*a-.5,0,a-1),p=G(e*a-.5,0,a-1),m=Math.floor(u),_=Math.floor(p),b=Math.min(m+1,a-1),w=Math.min(_+1,a-1);return SP(n.get(m,_),n.get(b,_),n.get(m,w),n.get(b,w),u-m,p-_)}let EV={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function TV(r,e,n){return(256*r*256+256*e+n)/10-1e4}function IV(r,e,n){return 256*r+e+n/256-32768}class fx{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,n,a,u=!1){if(this.uid=e,n.height!==n.width)throw new RangeError("DEM tiles must be square");if(a&&a!=="mapbox"&&a!=="terrarium")return void Rt(`"${a}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=n.height;let p=this.dim=n.height-2,m=new Uint32Array(n.data.buffer);if(this.pixels=new Uint8Array(n.data.buffer),this.floatView=new Float32Array(n.data.buffer),this.borderReady=u,this._modifiedForSources={},!u){for(let b=0;b<p;b++)m[this._idx(-1,b)]=m[this._idx(0,b)],m[this._idx(p,b)]=m[this._idx(p-1,b)],m[this._idx(b,-1)]=m[this._idx(b,0)],m[this._idx(b,p)]=m[this._idx(b,p-1)];m[this._idx(-1,-1)]=m[this._idx(0,0)],m[this._idx(p,-1)]=m[this._idx(p-1,0)],m[this._idx(-1,p)]=m[this._idx(0,p-1)],m[this._idx(p,p)]=m[this._idx(p-1,p-1)]}let _=a==="terrarium"?IV:TV;for(let b=0;b<m.length;++b){let w=4*b;this.floatView[b]=_(this.pixels[w],this.pixels[w+1],this.pixels[w+2])}this._timestamp=Lo.now()}_buildQuadTree(){this._tree=new IP(this)}get(e,n,a=!1){a&&(e=G(e,-1,this.dim),n=G(n,-1,this.dim));let u=this._idx(e,n);return this.floatView[u]}set(e,n,a){let u=this._idx(e,n),p=this.floatView[u];return this.floatView[u]=a,a-p}static getUnpackVector(e){return EV[e]}_idx(e,n){if(e<-1||e>=this.dim+1||n<-1||n>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(n+1)*this.stride+(e+1)}static pack(e,n){let a=[0,0,0,0],u=fx.getUnpackVector(n),p=Math.floor((e+u[3])/u[2]);return a[2]=p%256,p=Math.floor(p/256),a[1]=p%256,p=Math.floor(p/256),a[0]=p,a}getPixels(){return new vA({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,n,a){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let u=n*this.dim,p=n*this.dim+this.dim,m=a*this.dim,_=a*this.dim+this.dim;switch(n){case-1:u=p-1;break;case 1:p=u+1}switch(a){case-1:m=_-1;break;case 1:_=m+1}let b=-n*this.dim,w=-a*this.dim;for(let I=m;I<_;I++)for(let S=u;S<p;S++){let D=4*this._idx(S,I),P=4*this._idx(S+b,I+w);this.pixels[D+0]=e.pixels[P+0],this.pixels[D+1]=e.pixels[P+1],this.pixels[D+2]=e.pixels[P+2],this.pixels[D+3]=e.pixels[P+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function SV(r,e,n){r===1?e.headerLength=n.readFixed32():r===2?e.x=n.readVarint():r===3?e.y=n.readVarint():r===4?e.z=n.readVarint():r===5&&e.layers.push((function(a,u){return a.readFields(RV,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},u)})(n,n.readVarint()+n.pos))}function DV(r,e,n){r===1?(e.delta_filter=(function(a,u){return a.readFields(CV,{blockSize:0},u)})(n,n.readVarint()+n.pos),e.filter="delta_filter"):r===2?(n.readVarint(),e.filter="zigzag_filter"):r===3?(n.readVarint(),e.filter="bitshuffle_filter"):r===4&&(n.readVarint(),e.filter="byteshuffle_filter")}function CV(r,e,n){r===1&&(e.blockSize=n.readVarint())}function AV(r,e,n){r===1?(n.readVarint(),e.codec="gzip_data"):r===2?(n.readVarint(),e.codec="jpeg_image"):r===3?(n.readVarint(),e.codec="webp_image"):r===4&&(n.readVarint(),e.codec="png_image")}function MV(r,e,n){let a=0,u=0;r===1?e.firstByte=n.readFixed64():r===2?e.lastByte=n.readFixed64():r===3?e.filters.push((function(p,m){return p.readFields(DV,{},m)})(n,n.readVarint()+n.pos)):r===4?e.codec=(function(p,m){return p.readFields(AV,{},m)})(n,n.readVarint()+n.pos):r===5?u=n.readFloat():r===6?a=n.readFloat():r===7?e.bands.push(n.readString()):r===8?e.offset=n.readDouble():r===9&&(e.scale=n.readDouble()),e.offset===0&&(e.offset=u),e.scale===0&&(e.scale=a)}function RV(r,e,n){r===1?e.version=n.readVarint():r===2?e.name=n.readString():r===3?e.units=n.readString():r===4?e.tileSize=n.readVarint():r===5?e.buffer=n.readVarint():r===6?e.pixelFormat=n.readVarint():r===7&&e.dataIndex.push((function(a,u){return a.readFields(MV,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},u)})(n,n.readVarint()+n.pos))}function PV(r,e,n){if(r===2)(function(a,u,p){a.readFields(OV,p,u)})(n,n.readVarint()+n.pos,e);else if(r===3)throw new Error("Not implemented")}function OV(r,e,n){if(r===1){let a=0,u=n.readVarint()+n.pos;for(;n.pos<u;)e[a++]=n.readVarint()}}function LV(r,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let n=e[3];for(let a=2;a>=1;a--){let u=a===1?1:0,p=a===2?1:0;for(let m=0;m<e[0];m++){let _=e[1]*m;for(let b=u;b<e[1];b++){let w=e[2]*(b+_);for(let I=p;I<e[2];I++){let S=e[3]*(I+w);for(let D=0;D<e[3];D++){let P=S+D;r[P]+=r[P-n]}}}}n*=e[a]}return r}function FV(r){for(let e=0,n=r.length;e<n;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function kV(r,e){switch(e){case"uint32":return r;case"uint16":for(let n=0;n<r.length;n+=2){let a=r[n],u=r[n+1];r[n]=(240&a)>>4|(61440&a)>>8|(240&u)<<4|61440&u,r[n+1]=15&a|(3840&a)>>4|(15&u)<<8|(3840&u)<<4}return r;case"uint8":for(let n=0;n<r.length;n+=4){let a=r[n],u=r[n+1],p=r[n+2],m=r[n+3];r[n+0]=(192&a)>>6|(192&u)>>4|(192&p)>>2|192&m,r[n+1]=(48&a)>>4|(48&u)>>2|48&p|(48&m)<<2,r[n+2]=(12&a)>>2|12&u|(12&p)<<2|(12&m)<<4,r[n+3]=3&a|(3&u)<<2|(3&p)<<4|(3&m)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}vt(fx,"DEMData"),vt(IP,"DemMinMaxQuadTree",{omit:["dem"]});var qs=Uint8Array,$_=Uint16Array,NV=Int32Array,DP=new qs([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),CP=new qs([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),zV=new qs([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),AP=function(r,e){for(var n=new $_(31),a=0;a<31;++a)n[a]=e+=1<<r[a-1];var u=new NV(n[30]);for(a=1;a<30;++a)for(var p=n[a];p<n[a+1];++p)u[p]=p-n[a]<<5|a;return{b:n,r:u}},MP=AP(DP,2),RP=MP.b,BV=MP.r;RP[28]=258,BV[258]=28;for(var VV=AP(CP,0).b,PP=new $_(32768),_r=0;_r<32768;++_r){var Pp=(43690&_r)>>1|(21845&_r)<<1;PP[_r]=((65280&(Pp=(61680&(Pp=(52428&Pp)>>2|(13107&Pp)<<2))>>4|(3855&Pp)<<4))>>8|(255&Pp)<<8)>>1}var G_=function(r,e,n){for(var a=r.length,u=0,p=new $_(e);u<a;++u)r[u]&&++p[r[u]-1];var m,_=new $_(e);for(u=1;u<e;++u)_[u]=_[u-1]+p[u-1]<<1;m=new $_(1<<e);var b=15-e;for(u=0;u<a;++u)if(r[u])for(var w=u<<4|r[u],I=e-r[u],S=_[r[u]-1]++<<I,D=S|(1<<I)-1;S<=D;++S)m[PP[S]>>b]=w;return m},q_=new qs(288);for(_r=0;_r<144;++_r)q_[_r]=8;for(_r=144;_r<256;++_r)q_[_r]=9;for(_r=256;_r<280;++_r)q_[_r]=7;for(_r=280;_r<288;++_r)q_[_r]=8;var OP=new qs(32);for(_r=0;_r<32;++_r)OP[_r]=5;var jV=G_(q_,9),UV=G_(OP,5),wT=function(r){for(var e=r[0],n=1;n<r.length;++n)r[n]>e&&(e=r[n]);return e},qa=function(r,e,n){var a=e/8|0;return(r[a]|r[a+1]<<8)>>(7&e)&n},ET=function(r,e){var n=e/8|0;return(r[n]|r[n+1]<<8|r[n+2]<<16)>>(7&e)},HV=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Wa=function(r,e,n){var a=new Error(e||HV[r]);if(a.code=r,Error.captureStackTrace&&Error.captureStackTrace(a,Wa),!n)throw a;return a},$V=new qs(0),GV=typeof TextDecoder<"u"&&new TextDecoder;try{GV.decode($V,{stream:!0})}catch{}let qV={gzip_data:"gzip"};class _a extends Error{constructor(e){super(e),this.name="MRTError"}}let WV={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},LP={uint32:1,uint16:2,uint8:4},ZV={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array},TT;class px{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){let n=this.layers[e];if(!n)throw new _a(`Layer '${e}' not found`);return n}getHeaderLength(e){let n=new Uint8Array(e),a=new DataView(e);if(n[0]!==13)throw new _a("File is not a valid MRT.");return a.getUint32(1,!0)}parseHeader(e){let n=new Uint8Array(e),a=this.getHeaderLength(e);if(n.length<a)throw new _a(`Expected header with length >= ${a} but got buffer of length ${n.length}`);let u=new TT(n.subarray(0,a)).readFields(SV,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==u.x||this.y!==u.y||this.z!==u.z))throw new _a(`Invalid attempt to parse header ${u.z}/${u.x}/${u.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=u.x,this.y=u.y,this.z=u.z;for(let p of u.layers)this.layers[p.name]=new FP(p,{cacheSize:this._cacheSize});return this}createDecodingTask(e){let n=[],a=this.getLayer(e.layerName);for(let u of e.blockIndices){let p=a.dataIndex[u],m=p.firstByte-e.firstByte,_=p.lastByte-e.firstByte;if(a._blocksInProgress.has(u))continue;let b={layerName:a.name,firstByte:m,lastByte:_,pixelFormat:a.pixelFormat,blockIndex:u,blockShape:[p.bands.length].concat(a.bandShape),buffer:a.buffer,codec:p.codec.codec,filters:p.filters.map(w=>w.filter)};a._blocksInProgress.add(u),n.push(b)}return new kP(n,()=>{n.forEach(u=>a._blocksInProgress.delete(u.blockIndex))},(u,p)=>{if(n.forEach(m=>a._blocksInProgress.delete(m.blockIndex)),u)throw u;p.forEach(m=>{this.getLayer(m.layerName).processDecodedData(m)})})}}class FP{constructor({version:e,name:n,units:a,tileSize:u,pixelFormat:p,buffer:m,dataIndex:_},b){if(this.version=e,this.version!==1)throw new _a(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=n,this.units=a,this.tileSize=u,this.buffer=m,this.pixelFormat=WV[p],this.dataIndex=_,this.bandShape=[u+2*m,u+2*m,LP[this.pixelFormat]],this._decodedBlocks=new hx(b?b.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return LP[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){let n=e.blockIndex.toString();this._decodedBlocks.get(n)||this._decodedBlocks.put(n,e.data)}getBlockForBand(e){let n=0;switch(typeof e){case"string":for(let[a,u]of this.dataIndex.entries()){for(let[p,m]of u.bands.entries())if(m===e)return{bandIndex:n+p,blockIndex:a,blockBandIndex:p};n+=u.bands.length}break;case"number":for(let[a,u]of this.dataIndex.entries()){if(e>=n&&e<n+u.bands.length)return{bandIndex:e,blockIndex:a,blockBandIndex:e-n};n+=u.bands.length}break;default:throw new _a(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let n=1/0,a=-1/0,u=[],p=new Set;for(let m of e){let{blockIndex:_}=this.getBlockForBand(m);if(_<0)throw new _a(`Invalid band: ${JSON.stringify(m)}`);let b=this.dataIndex[_];u.includes(_)||u.push(_),p.add(_),n=Math.min(n,b.firstByte),a=Math.max(a,b.lastByte)}if(p.size>this.cacheSize)throw new _a(`Number of blocks to decode (${p.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:n,lastByte:a,blockIndices:u}}hasBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0}hasDataForBand(e){let{blockIndex:n}=this.getBlockForBand(e);return n>=0&&!!this._decodedBlocks.get(n.toString())}getBandView(e){let{blockIndex:n,blockBandIndex:a}=this.getBlockForBand(e);if(n<0)throw new _a(`Band not found: ${JSON.stringify(e)}`);let u=this._decodedBlocks.get(n.toString());if(!u)throw new _a(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);let p=this.dataIndex[n],m=this.bandShape.reduce((w,I)=>w*I,1),_=a*m,b=u.subarray(_,_+m);return{data:b,bytes:new Uint8Array(b.buffer).subarray(b.byteOffset,b.byteOffset+b.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:p.offset,scale:p.scale}}}px.setPbf=function(r){TT=r};class kP{constructor(e,n,a){this.tasks=e,this._onCancel=n,this._onComplete=a,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,n){this._finalized||(this._onComplete(e,n),this._finalized=!0)}}px.performDecoding=function(r,e){let n=new Uint8Array(r);return Promise.all(e.tasks.map(a=>{let{layerName:u,firstByte:p,lastByte:m,pixelFormat:_,blockShape:b,blockIndex:w,filters:I,codec:S}=a,D=n.subarray(p,m+1),P=new Uint32Array(b[0]*b[1]*b[2]),O;if(S!=="gzip_data")throw new _a(`Unhandled codec: ${S}`);return O=(function(N,V){if(!globalThis.DecompressionStream&&V==="gzip_data")return Promise.resolve(((K=(function(de){de[0]==31&&de[1]==139&&de[2]==8||Wa(6,"invalid gzip data");var pe=de[3],ge=10;4&pe&&(ge+=2+(de[10]|de[11]<<8));for(var Le=(pe>>3&1)+(pe>>4&1);Le>0;Le-=!de[ge++]);return ge+(2&pe)})(X=N))+8>X.length&&Wa(6,"invalid gzip data"),(function(de,pe,ge,Le){var Te=de.length;if(!Te||pe.f&&!pe.l)return ge||new qs(0);var ke=!ge,je=ke||pe.i!=2,$e=pe.i;ke&&(ge=new qs(3*Te));var nt,Ye,Ue=function(Fi){var gi=ge.length;if(Fi>gi){var si=new qs(Math.max(2*gi,Fi));si.set(ge),ge=si}},Xe=pe.f||0,Re=pe.p||0,Ae=pe.b||0,qe=pe.l,Qe=pe.d,He=pe.m,_t=pe.n,bt=8*Te;do{if(!qe){Xe=qa(de,Re,1);var ft=qa(de,Re+1,3);if(Re+=3,!ft){var at=de[(oe=4+((Re+7)/8|0))-4]|de[oe-3]<<8,Gt=oe+at;if(Gt>Te){$e&&Wa(0);break}je&&Ue(Ae+at),ge.set(de.subarray(oe,Gt),Ae),pe.b=Ae+=at,pe.p=Re=8*Gt,pe.f=Xe;continue}if(ft==1)qe=jV,Qe=UV,He=9,_t=5;else if(ft==2){var ut=qa(de,Re,31)+257,Mt=qa(de,Re+10,15)+4,Zt=ut+qa(de,Re+5,31)+1;Re+=14;for(var an=new qs(Zt),En=new qs(19),Yt=0;Yt<Mt;++Yt)En[zV[Yt]]=qa(de,Re+3*Yt,7);Re+=3*Mt;var Cn=wT(En),An=(1<<Cn)-1,Ii=G_(En,Cn);for(Yt=0;Yt<Zt;){var oe,te=Ii[qa(de,Re,An)];if(Re+=15&te,(oe=te>>4)<16)an[Yt++]=oe;else{var Ne=0,st=0;for(oe==16?(st=3+qa(de,Re,3),Re+=2,Ne=an[Yt-1]):oe==17?(st=3+qa(de,Re,7),Re+=3):oe==18&&(st=11+qa(de,Re,127),Re+=7);st--;)an[Yt++]=Ne}}var ze=an.subarray(0,ut),lt=an.subarray(ut);He=wT(ze),_t=wT(lt),qe=G_(ze,He),Qe=G_(lt,_t)}else Wa(1);if(Re>bt){$e&&Wa(0);break}}je&&Ue(Ae+131072);for(var Dt=(1<<He)-1,It=(1<<_t)-1,Jt=Re;;Jt=Re){var Ft=(Ne=qe[ET(de,Re)&Dt])>>4;if((Re+=15&Ne)>bt){$e&&Wa(0);break}if(Ne||Wa(2),Ft<256)ge[Ae++]=Ft;else{if(Ft==256){Jt=Re,qe=null;break}var Et=Ft-254;Ft>264&&(Et=qa(de,Re,(1<<(Nt=DP[Yt=Ft-257]))-1)+RP[Yt],Re+=Nt);var Dn=Qe[ET(de,Re)&It],Kn=Dn>>4;if(Dn||Wa(3),Re+=15&Dn,lt=VV[Kn],Kn>3){var Nt=CP[Kn];lt+=ET(de,Re)&(1<<Nt)-1,Re+=Nt}if(Re>bt){$e&&Wa(0);break}je&&Ue(Ae+131072);var bn=Ae+Et;if(Ae<lt){var Jn=0-lt,zn=Math.min(lt,bn);for(Jn+Ae<0&&Wa(3);Ae<zn;++Ae)ge[Ae]=(void 0)[Jn+Ae]}for(;Ae<bn;++Ae)ge[Ae]=ge[Ae-lt]}}pe.l=qe,pe.p=Jt,pe.b=Ae,pe.f=Xe,qe&&(Xe=1,pe.m=He,pe.d=Qe,pe.n=_t)}while(!Xe);return Ae!=ge.length&&ke?(nt=ge,((Ye=Ae)==null||Ye>nt.length)&&(Ye=nt.length),new qs(nt.subarray(0,Ye))):ge.subarray(0,Ae)})(X.subarray(K,-8),{i:2},new qs(((U=X)[(W=U.length)-4]|U[W-3]<<8|U[W-2]<<16|U[W-1]<<24)>>>0))));var U,W,X,K;let le=qV[V];if(!le)throw new Error(`Unhandled codec: ${V}`);let re=new globalThis.DecompressionStream(le);return new Response(new Blob([N]).stream().pipeThrough(re)).arrayBuffer().then(de=>new Uint8Array(de))})(D,S).then(N=>((function(V,U){V.readFields(PV,U)})(new TT(N),P),new ZV[_](P.buffer))),O.then(N=>{for(let V=I.length-1;V>=0;V--)switch(I[V]){case"delta_filter":LV(N,b);break;case"zigzag_filter":FV(N);break;case"bitshuffle_filter":kV(N,_);break;default:throw new _a(`Unhandled filter "${I[V]}"`)}return{layerName:u,blockIndex:w,data:N}}).catch(N=>{throw N})}))},vt(kP,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),vt(px,"MapboxRasterTile"),vt(FP,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class NP{constructor(e){this._stringToNumber={},this._numberToString=[];for(let n=0;n<e.length;n++){let a=e[n];this._stringToNumber[a]=n,this._numberToString[n]=a}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}class zP{constructor(e,n){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new cc(rt,16,0),this.featureIndexArray=new d0,this.promoteId=n,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,n,a,u,p,m=0,_=0){let b=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(a,u,p,m);let w=this.grid;for(let I=0;I<n.length;I++){let S=n[I],D=[1/0,1/0,-1/0,-1/0];for(let P=0;P<S.length;P++){let O=S[P];D[0]=Math.min(D[0],O.x),D[1]=Math.min(D[1],O.y),D[2]=Math.max(D[2],O.x),D[3]=Math.max(D[3],O.y)}_!==0&&(D[0]-=_,D[1]-=_,D[2]+=_,D[3]+=_),D[0]<rt&&D[1]<rt&&D[2]>=0&&D[3]>=0&&w.insert(b,D[0],D[1],D[2],D[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new wt(new $0(this.rawTileData)).layers,this.sourceLayerCoder=new NP(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(let e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,n){let{tilespaceGeometry:a,transform:u,tileTransform:p,pixelPosMatrix:m,availableImages:_,worldview:b}=n;this.loadVTLayers(),this.serializedLayersCache.clear();let w=n.queryRadius?n.queryRadius:0,I=a.bufferedTilespaceBounds,S=this.grid.query(I.min.x,I.min.y,I.max.x,I.max.y,(N,V,U,W)=>Oi(a.bufferedTilespaceGeometry,N-w,V-w,U+w,W+w));S.sort(XV);let D=null;u.elevation&&S.length>0&&(D=Ap.create(u.elevation,this.tileID));let P={},O;for(let N=0;N<S.length;N++){let V=S[N];if(V===O)continue;O=V;let U=this.featureIndexArray.get(V),W=null;this.is3DTile?this.loadMatchingModelFeature(P,U,e,a,u,b):this.loadMatchingFeature(P,U,e,_,b,(X,K,le,re=0)=>(W||(W=Ve(X,this.tileID.canonical,p)),K.queryIntersectsFeature(a,X,le,W,this.z,u,m,D,re)))}return P}loadMatchingFeature(e,n,a,u,p,m){let{featureIndex:_,bucketIndex:b,sourceLayerIndex:w,layoutVertexArrayOffset:I}=n,S=this.bucketLayerIDs[b],D=a.layers,P=Object.keys(D);if(P.length&&!Ht(P,S))return;let O=a.sourceCache,N=this.sourceLayerCoder.decode(w),V=this.vtLayers[N].feature(_),U=this.getId(V,N);for(let W=0;W<S.length;W++){let X=S[W];if(!D[X])continue;let{styleLayer:K,targets:le}=D[X],re={};U!==void 0&&(re=O.getFeatureState(K.sourceLayer,U));let de=!m||m(V,K,re,I);if(!de)continue;let pe=new gh(V,this.z,this.x,this.y,U);pe.tile=this.tileID.canonical,pe.state=re;let ge=this.serializedLayersCache.get(X);ge||(ge=K.serialize(),ge.id=X,this.serializedLayersCache.set(X,ge)),pe.source=ge.source,pe.sourceLayer=ge["source-layer"],pe.layer=Object.assign({},ge),pe.layer.paint=BP(ge.paint,K.paint,V,re,u),pe.layer.layout=BP(ge.layout,K.layout,V,re,u);let Le=!1;for(let Te of le){this.updateFeatureProperties(pe,Te);let{filter:ke}=Te;if(ke){if(V.properties=pe.properties,ke.needGeometry){let je=De(V,!0);if(!ke.filter(new ci(this.tileID.overscaledZ,{worldview:p}),je,this.tileID.canonical))continue}else if(!ke.filter(new ci(this.tileID.overscaledZ,{worldview:p}),V))continue}Le=!0,Te.targetId&&this.addFeatureVariant(pe,Te)}Le&&this.appendToResult(e,X,_,pe,de)}}loadMatchingModelFeature(e,n,a,u,p,m){let{featureIndex:_,bucketIndex:b}=n,w=this.bucketLayerIDs[b],I=a.layers,S=Object.keys(I);if(!S.length||Ht(S,w))for(let D=0;D<w.length;D++){let P=w[D],{styleLayer:O,targets:N}=I[P];if(O.type!=="model")continue;let V=u.tile,U=V.getBucket(O);if(!(U&&U instanceof ax))continue;let W=tV(U,_,u,p);if(!W)continue;let{z:X,x:K,y:le}=V.tileID.canonical,{feature:re,intersectionZ:de,position:pe}=W,ge={};re.id!==void 0&&(ge=a.sourceCache.getFeatureState(O.sourceLayer,re.id));let Le=new gh({},X,K,le,re.id);Le.tile=this.tileID.canonical,Le.state=ge,Le.properties=re.properties,Le.geometry={type:"Point",coordinates:[pe.lng,pe.lat]};let Te=this.serializedLayersCache.get(P);Te||(Te=O.serialize(),Te.id=P,this.serializedLayersCache.set(P,Te)),Le.source=Te.source,Le.sourceLayer=Te["source-layer"],Le.layer=Object.assign({},Te);let ke=!1;for(let je of N){this.updateFeatureProperties(Le,je);let{filter:$e}=je;if($e){if(re.properties=Le.properties,$e.needGeometry){if(!$e.filter(new ci(this.tileID.overscaledZ,{worldview:m}),re,this.tileID.canonical))continue}else if(!$e.filter(new ci(this.tileID.overscaledZ,{worldview:m}),re))continue}ke=!0,je.targetId&&this.addFeatureVariant(Le,je)}ke&&this.appendToResult(e,P,_,Le,de)}}updateFeatureProperties(e,n,a){if(n.properties){let u={};for(let p in n.properties){let m=n.properties[p].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,a);m!=null&&(u[p]=m)}e.properties=u}}addFeatureVariant(e,n,a){let u={target:n.target,namespace:n.namespace,uniqueFeatureID:n.uniqueFeatureID};n.properties&&(u.properties=e.properties),e.variants=e.variants||{},e.variants[n.targetId]=e.variants[n.targetId]||[],e.variants[n.targetId].push(u)}appendToResult(e,n,a,u,p){let m=e[n];m===void 0&&(m=e[n]=[]),m.push({featureIndex:a,feature:u,intersectionZ:p})}lookupSymbolFeatures(e,n,a,u,p,m){let _={};this.loadVTLayers();for(let b of e)this.loadMatchingFeature(_,{bucketIndex:n,sourceLayerIndex:a,featureIndex:b,layoutVertexArrayOffset:0},u,p,m);return _}loadFeature(e){let{featureIndex:n,sourceLayerIndex:a}=e;this.loadVTLayers();let u=this.sourceLayerCoder.decode(a),p=this.vtFeatures[u];if(p[n])return p[n];let m=this.vtLayers[u].feature(n);return p[n]=m,m}hasLayer(e){for(let n of this.bucketLayerIDs)for(let a of n)if(e===a)return!0;return!1}getId(e,n){let a=e.id;if(this.promoteId){let u=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[n];if(u!=null)if(Array.isArray(u)){if(!this.promoteIdExpression){let p=pa(u);if(p.result!=="success"){let m=p.value.map(_=>`${_.key}: ${_.message}`).join(", ");return void Rt(`Failed to create expression for promoteId: ${m}`)}this.promoteIdExpression=p.value}a=this.promoteIdExpression.evaluate({zoom:0},e)}else a=e.properties[u];typeof a=="boolean"&&(a=Number(a))}return a}}function BP(r,e,n,a,u){return et(r,(p,m)=>{let _=e instanceof uc?e.get(m):null;return _&&_.evaluate?_.evaluate(n,a,void 0,u):_})}function XV(r,e){return e-r}vt(zP,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let VP=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class IT{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");let[n,a]=new Uint8Array(e,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");let u=a>>4;if(u!==1)throw new Error(`Got v${u} data when expected v1.`);let p=VP[15&a];if(!p)throw new Error("Unrecognized array type.");let[m]=new Uint16Array(e,2,1),[_]=new Uint32Array(e,4,1);return new IT(_,m,p,e)}constructor(e,n=64,a=Float64Array,u){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=a,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;let p=VP.indexOf(this.ArrayType),m=2*e*this.ArrayType.BYTES_PER_ELEMENT,_=e*this.IndexArrayType.BYTES_PER_ELEMENT,b=(8-_%8)%8;if(p<0)throw new Error(`Unexpected typed array class: ${a}.`);u&&u instanceof ArrayBuffer?(this.data=u,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+_+b,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+m+_+b),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+_+b,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+p]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=e)}add(e,n){let a=this._pos>>1;return this.ids[a]=a,this.coords[this._pos++]=e,this.coords[this._pos++]=n,a}finish(){let e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return ST(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,n,a,u){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:p,coords:m,nodeSize:_}=this,b=[0,p.length-1,0],w=[];for(;b.length;){let I=b.pop()||0,S=b.pop()||0,D=b.pop()||0;if(S-D<=_){for(let V=D;V<=S;V++){let U=m[2*V],W=m[2*V+1];U>=e&&U<=a&&W>=n&&W<=u&&w.push(p[V])}continue}let P=D+S>>1,O=m[2*P],N=m[2*P+1];O>=e&&O<=a&&N>=n&&N<=u&&w.push(p[P]),(I===0?e<=O:n<=N)&&(b.push(D),b.push(P-1),b.push(1-I)),(I===0?a>=O:u>=N)&&(b.push(P+1),b.push(S),b.push(1-I))}return w}within(e,n,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");let{ids:u,coords:p,nodeSize:m}=this,_=[0,u.length-1,0],b=[],w=a*a;for(;_.length;){let I=_.pop()||0,S=_.pop()||0,D=_.pop()||0;if(S-D<=m){for(let V=D;V<=S;V++)UP(p[2*V],p[2*V+1],e,n)<=w&&b.push(u[V]);continue}let P=D+S>>1,O=p[2*P],N=p[2*P+1];UP(O,N,e,n)<=w&&b.push(u[P]),(I===0?e-a<=O:n-a<=N)&&(_.push(D),_.push(P-1),_.push(1-I)),(I===0?e+a>=O:n+a>=N)&&(_.push(P+1),_.push(S),_.push(1-I))}return b}}function ST(r,e,n,a,u,p){if(u-a<=n)return;let m=a+u>>1;jP(r,e,m,a,u,p),ST(r,e,n,a,m-1,1-p),ST(r,e,n,m+1,u,1-p)}function jP(r,e,n,a,u,p){for(;u>a;){if(u-a>600){let w=u-a+1,I=n-a+1,S=Math.log(w),D=.5*Math.exp(2*S/3),P=.5*Math.sqrt(S*D*(w-D)/w)*(I-w/2<0?-1:1);jP(r,e,n,Math.max(a,Math.floor(n-I*D/w+P)),Math.min(u,Math.floor(n+(w-I)*D/w+P)),p)}let m=e[2*n+p],_=a,b=u;for(W_(r,e,a,n),e[2*u+p]>m&&W_(r,e,a,u);_<b;){for(W_(r,e,_,b),_++,b--;e[2*_+p]<m;)_++;for(;e[2*b+p]>m;)b--}e[2*a+p]===m?W_(r,e,a,b):(b++,W_(r,e,b,u)),b<=n&&(a=b+1),n<=b&&(u=b-1)}}function W_(r,e,n,a){DT(r,n,a),DT(e,2*n,2*a),DT(e,2*n+1,2*a+1)}function DT(r,e,n){let a=r[e];r[e]=r[n],r[n]=a}function UP(r,e,n,a){let u=r-n,p=e-a;return u*u+p*p}i.$=gf,i.A=Oa,i.B=dc,i.C=2,i.D=gp,i.E=Ra,i.F=A_,i.G=pR,i.H=mf,i.I=gr,i.J=Vg,i.K=Qc,i.L=Bd,i.M=Vf,i.N=Bf,i.O=Dg,i.P=Ze,i.Q=$f,i.R=Jl,i.S=_u,i.T=NE,i.U=pa,i.V=sx,i.W=Ag,i.X=au,i.Y=su,i.Z=Gd,i._=no,i.a=function(r){return pi.API_CDN_URL_REGEX.test(r)},i.a$=bu,i.a0=jt,i.a1=Qm,i.a2=yu,i.a3=class extends sx{},i.a4=jf,i.a5=Sg,i.a6=Ee,i.a7=function(r){let e=r.value;return e?jt(e)?fT(e,!0)?[]:[new sx(r.key,e,`invalid url "${e}"`)]:[new sx(r.key,e,`string expected, "${Qc(e)}" found`)]:[]},i.a8=e0,i.a9=zi,i.aA=G,i.aB=At,i.aC=co,i.aD=Io,i.aE=Cr,i.aF=q,i.aG=Pe,i.aH=function(r,e){let n={};for(let a=0;a<e.length;a++){let u=e[a];u in r&&(n[u]=r[u])}return n},i.aI=R,i.aJ=$,i.aK=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,n,a){let u=this.entries[r]=this.entries[r]||{callbacks:[]};if(u.result){let[p,m]=u.result;return this.scheduler?this.scheduler.add(()=>{a(p,m)},e):a(p,m),()=>{}}return u.callbacks.push(a),u.cancel||(u.cancel=n((p,m)=>{u.result=[p,m];for(let _ of u.callbacks)this.scheduler?this.scheduler.add(()=>{_(p,m)},e):_(p,m);setTimeout(()=>delete this.entries[r],3e3)})),()=>{u.result||(u.callbacks=u.callbacks.filter(p=>p!==a),u.callbacks.length||(u.cancel(),delete this.entries[r]))}}},i.aL=function(r,e,n){let a=JSON.stringify(r.request);return r.data&&(this.deduped.entries[a]={result:[null,r.data]}),this.deduped.request(a,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},u=>{let p=Zc(r.request,(m,_,b)=>{m?u(m):_&&u(null,{vectorTile:n?void 0:new wt(new $0(_)),rawData:_,responseHeaders:new Map(b.entries())})});return()=>{p.cancel(),u()}},e)},i.aM=function(r){return r?{cacheControl:r.get("Cache-Control"),expires:r.get("Expires")}:{cacheControl:void 0,expires:void 0}},i.aN=function(r){uf++,uf>wo&&(r.getActor().send("enforceCacheSizeLimit",Ed),uf=0)},i.aO=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log2(r)))},i.aP=br,i.aQ=HR,i.aR=XR,i.aS=L,i.aT=UR,i.aU=function(r,e){let n=document.createElement("video");n.muted=!0,n.onloadstart=function(){e(null,n)};for(let a=0;a<r.length;a++){let u=document.createElement("source");Pn(r[a])||(n.crossOrigin="Anonymous"),u.src=r[a],n.appendChild(u)}return{cancel:()=>{}}},i.aV=T_,i.aW=_h,i.aX=Ce,i.aY=O_,i.aZ=J,i.a_=Y,i.aa=Ke,i.ab=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return Wn(r.expression.evaluate(e))}interpolate(r,e,n){return{x:zt(r.x,e.x,n),y:zt(r.y,e.y,n),z:zt(r.z,e.z,n),azimuthal:zt(r.azimuthal,e.azimuthal,n),polar:zt(r.polar,e.polar,n)}}},i.ac=ci,i.ad=gl,i.ae=be,i.af=ki,i.ag=Qr,i.ah=ne,i.ai=uc,i.aj=Ru,i.ak=zt,i.al=rt,i.am=Od,i.an=gn,i.ao=Nn,i.ap=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return(function([n,a]){let u=Wn([1,n,a]);return{x:u.x,y:u.y,z:u.z}})(r.expression.evaluate(e))}interpolate(r,e,n){return{x:zt(r.x,e.x,n),y:zt(r.y,e.y,n),z:zt(r.z,e.z,n)}}},i.aq=function(r,e,n=0,a=!0){let u=new Ze(n,n),p=r.sub(u),m=e.add(u),_=[p,new Ze(m.x,p.y),m,new Ze(p.x,m.y)];return a&&_.push(p.clone()),_},i.ar=function(r,e){let n=[];for(let a=0;a<r.length;a++){let u=fe(a-1,-1,r.length-1),p=fe(a+1,-1,r.length-1),m=r[a],_=r[p],b=r[u].sub(m).unit(),w=_.sub(m).unit(),I=w.angleWithSep(b.x,b.y),S=b.add(w).unit().mult(-1*e/Math.sin(I/2));n.push(m.add(S))}return n},i.as=DR,i.at=Oi,i.au=function(r,e,n=0){return ji(((e.x-n)*r.scale-r.x)*rt,(e.y*r.scale-r.y)*rt,ae(e.z,e.y))},i.av=tr,i.aw=li,i.ax=en,i.ay=jM,i.az=function(r){let e=1/0,n=1/0,a=-1/0,u=-1/0;for(let p of r)e=Math.min(e,p.x),n=Math.min(n,p.y),a=Math.max(a,p.x),u=Math.max(u,p.y);return{min:new Ze(e,n),max:new Ze(a,u)}},i.b=function(r){return pi.API_FONTS_REGEX.test(r)},i.b$=IE,i.b0=wi,i.b1=Me,i.b2=l0,i.b3=nx,i.b4=function(){No.isLoading()||No.isLoaded()||Ng()!=="deferred"||zg()},i.b5=Yf,i.b6=De,i.b7=gh,i.b8=ar,i.b9=GE,i.bA=jr,i.bB=ct,i.bC=function(r,e){let{x:n,y:a}=r.point,u=sA(n,a,r.worldSize/r._pixelsPerMercatorPixel,0,0);return At(u,u,hE(El(e)))},i.bD=B,i.bE=Vs,i.bF=fd,i.bG=Bs,i.bH=Or,i.bI=sr,i.bJ=Tp,i.bK=os,i.bL=QE,i.bM=function(r,e,n,a,u){let p=5*e+2;r.float32[p+0]=n,r.float32[p+1]=a,r.float32[p+2]=u},i.bN=Cp,i.bO=Zl,i.bP=gs,i.bQ=Ca,i.bR=lf,i.bS=fe,i.bT=function(r,e,n,a){var u=new k(4);return u[0]=r,u[1]=e,u[2]=n,u[3]=a,u},i.bU=class{isDataAvailableAtPoint(r){let e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;let n=e.getSource().maxzoom,a=1<<n,u=Math.floor(r.x),p=Math.floor((r.x-u)*a),m=Math.floor(r.y*a),_=this.findDEMTileFor(new br(n,u,n,p,m));return!(!_||!_.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,n=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);let a=this._source();if(!a||r.y<0||r.y>1)return e;let u=a.getSource().maxzoom,p=1<<u,m=Math.floor(r.x),_=r.x-m,b=new br(u,m,u,Math.floor(_*p),Math.floor(r.y*p)),w=this.findDEMTileFor(b);if(!w||!w.dem)return e;let I=w.dem,S=1<<w.tileID.canonical.z,D=(_*S-w.tileID.canonical.x)*I.dim,P=(r.y*S-w.tileID.canonical.y)*I.dim,O=Math.floor(D),N=Math.floor(P);return(n?this.exaggeration():1)*zt(zt(I.get(O,N),I.get(O,N+1),P-N),zt(I.get(O+1,N),I.get(O+1,N+1),P-N),D-O)}static getAtTileOffset(r,e,n,a){let u=1<<r.canonical.z;return a?a.pointElevation(e):n?n.getAtPointOrZero(new be(r.wrap+(r.canonical.x+e.x/rt)/u,(r.canonical.y+e.y/rt)/u)):0}static getAtTileOffsetFunc(r,e,n,a){return(u,p,m)=>{let _=this.getAtTileOffset(r,u,p,m),b=a.upVector(r.canonical,u.x,u.y);return Mi(b,b,_*a.upVectorScale(r.canonical,e,n).metersToTile),b}}getForTilePoints(r,e,n,a){if(this.isUsingMockSource())return!1;let u=Ap.create(this,r,a);return!!u&&(e.forEach(p=>{p[2]=this.exaggeration()*u.getElevationAt(p[0],p[1],n)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;let e=this.findDEMTileFor(r);if(!e||!e.dem)return null;let n=e.dem.tree,a=e.tileID,u=1<<r.canonical.z-a.canonical.z,p=r.canonical.x/u-a.canonical.x,m=r.canonical.y/u-a.canonical.y,_=0;for(let b=0;b<r.canonical.z-a.canonical.z&&!n.leaves[_];b++){p*=2,m*=2;let w=2*Math.floor(m)+Math.floor(p);_=n.childOffsets[_]+w,p%=1,m%=1}return{min:this.exaggeration()*n.minimums[_],max:this.exaggeration()*n.maximums[_]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,n){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let r=this.visibleDemTiles;if(r.length===0)return null;let e=!1,n=Number.MAX_VALUE,a=Number.MIN_VALUE;for(let u of r){let p=this.getMinMaxForTile(u.tileID);p&&(n=Math.min(n,p.min),a=Math.max(a,p.max),e=!0)}return e?{min:n,max:a}:null}},i.bV=P0,i.bW=$i,i.bX=Nr,i.bY=NA,i.bZ=YR,i.b_=jA,i.ba=wE,i.bb=Ve,i.bc=To,i.bd=rp,i.be=eA,i.bf=Ci,i.bg=pp,i.bh=dT,i.bi=function(r,e){let n=Ru(e.zoom);if(n===0)return El(r);let a=b0(r),u=dE(a),p=q(a.getWest())*e.worldSize,m=q(a.getEast())*e.worldSize,_=$(a.getNorth())*e.worldSize,b=$(a.getSouth())*e.worldSize,w=[p,_,0],I=[m,_,0],S=[p,b,0],D=[m,b,0],P=Xt([],e.globeMatrix);return ki(w,w,P),ki(I,I,P),ki(S,S,P),ki(D,D,P),u[0]=gc(u[0],S,n),u[1]=gc(u[1],D,n),u[2]=gc(u[2],I,n),u[3]=gc(u[3],w,n),on.fromPoints(u)},i.bj=E0,i.bk=Xt,i.bl=l_,i.bm=gc,i.bn=hc,i.bo=xz,i.bp=lo,i.bq=Lt,i.br=px,i.bs=$0,i.bt=Zc,i.bu=function(r,e){let n=[];for(let a in r)a in e||n.push(a);return n},i.bv=he,i.bw=["type","source","source-layer","minzoom","maxzoom","filter","layout"],i.bx=Aa,i.by=Fe,i.bz=yt,i.c=to,i.c$=function(r){return r*r*r*r*r},i.c0=KE,i.c1=bR,i.c2=rT,i.c3=IT,i.c4=Mi,i.c5=Gl,i.c6=la,i.c7=function(r,e,n){n*=.5;var a=e[0],u=e[1],p=e[2],m=e[3],_=Math.sin(n),b=Math.cos(n);return r[0]=a*b+u*_,r[1]=u*b-a*_,r[2]=p*b+m*_,r[3]=m*b-p*_,r},i.c8=Da,i.c9=Hi,i.cA=On,i.cB=IM,i.cC=ns,i.cD=iA,i.cE=function(r,e,n,a,u,p,m,_,b){if(b.name==="globe")return iA(r,e,new ns(n,a,u),!1);let w=O_({z:n,x:a,y:u},b);return new on([(p+w.x/w.scale)*e,e*(w.y/w.scale),m],[(p+w.x2/w.scale)*e,e*(w.y2/w.scale),_])},i.cF=function(r,e,n){return r[0]=Math.min(e[0],n[0]),r[1]=Math.min(e[1],n[1]),r[2]=Math.min(e[2],n[2]),r[3]=Math.min(e[3],n[3]),r},i.cG=function(r,e,n){return r[0]=Math.max(e[0],n[0]),r[1]=Math.max(e[1],n[1]),r[2]=Math.max(e[2],n[2]),r[3]=Math.max(e[3],n[3]),r},i.cH=function(r){let e=Math.round((r+45+360)%360/90)%4;return Gm[e]},i.cI=Q,i.cJ=ll,i.cK=t,i.cL=function(r){let e=yt(new Float64Array(16));At(e,r.pixelMatrix,r.globeMatrix);let n=[0,y,0],a=[0,x,0];return ki(n,n,e),ki(a,a,e),[n[0]>0&&n[0]<=r.width&&n[1]>0&&n[1]<=r.height&&!pE(r,new L(r.center.lat,90)),a[0]>0&&a[0]<=r.width&&a[1]>0&&a[1]<=r.height&&!pE(r,new L(r.center.lat,-90))]},i.cM=function(r,e){let{scale:n}=r.tileTransform,a=n*rt/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return(function(u,p,m){var _=p[1],b=p[2],w=p[3],I=m[0],S=m[1];return u[0]=p[0]*I,u[1]=_*I,u[2]=b*S,u[3]=w*S,u})(new Float32Array(4),e.inverseAdjustmentMatrix,[a,a])},i.cN=z0,i.cO=hd,i.cP=TM,i.cQ=function(r){let e=TM(r,!0);return B([],[e[0],e[1],e[4],e[5]])},i.cR=qn,i.cS=jn,i.cT=Sr,i.cU=function(r){let{x:e,y:n}=r.point,{lng:a,lat:u}=r._center;return sA(e,n,r.worldSize,a,u)},i.cV=zs,i.cW=eo,i.cX=is,i.cY=Gi,i.cZ=d,i.c_=function(r,e,n){let a=0;for(let u=0;u<2;++u)r[u]>0&&(a+=(r[u]-0)*(r[u]-0)),e[u]<0&&(a+=(0-e[u])*(0-e[u]));return a},i.ca=function(r,e){return r[0]=-e[0],r[1]=-e[1],r[2]=-e[2],r[3]=e[3],r},i.cb=dd,i.cc=function(r,e,n,a,u){var p=1/Math.tan(e/2);if(r[0]=p/n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=p,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,u!=null&&u!==1/0){var m=1/(a-u);r[10]=(u+a)*m,r[14]=2*u*a*m}else r[10]=-1,r[14]=-2*a;return r},i.cd=function(r,e,n,a,u,p,m){var _=1/(e-n),b=1/(a-u),w=1/(p-m);return r[0]=-2*_,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*b,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*w,r[11]=0,r[12]=(e+n)*_,r[13]=(u+a)*b,r[14]=(m+p)*w,r[15]=1,r},i.ce=Z,i.cf=function(r,e,n){r[4*e+0]=n[0],r[4*e+1]=n[1],r[4*e+2]=n[2],r[4*e+3]=n[3]},i.cg=up,i.ch=Du,i.ci=nr,i.cj=ma,i.ck=lh,i.cl=PR,i.cm=function(){var r=new k(4);return k!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r},i.cn=function(r,e,n){var a=e[0],u=e[1],p=e[2],m=e[3],_=Math.sin(n),b=Math.cos(n);return r[0]=a*b+p*_,r[1]=u*b+m*_,r[2]=a*-_+p*b,r[3]=u*-_+m*b,r},i.co=function(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]},i.cp=aa,i.cq=function(r){var e=r[0],n=r[1],a=r[2],u=r[3];return Math.sqrt(e*e+n*n+a*a+u*u)},i.cr=$c,i.cs=Go,i.ct=ga,i.cu=3,i.cv=2,i.cw=7,i.cx=6,i.cy=Hc,i.cz=Un,i.d=function(r){return pi.API_TILEJSON_REGEX.test(r)},i.d$=cA,i.d0=j,i.d1=45,i.d2=ah,i.d3=function(r,e,n){let a=Math.sqrt(r*r+e*e+n*n),u=a>0?Math.acos(n/a)*vd:0,p=r!==0||e!==0?Math.atan2(-e,-r)*vd+90:0;return p<0&&(p+=360),[a,p,u]},i.d4=ji,i.d5=Wn,i.d6=ue,i.d7=or,i.d8=on,i.d9=ra,i.dA=r_,i.dB=class extends Ds{constructor(r){super(r),this.current=oE}set(r,e,n){if(this.fetchUniformLocation(r,e)){for(let a=0;a<9;a++)if(n[a]!==this.current[a]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}},i.dC=xd,i.dD=function(r,e,n){let a=Ru(n.zoom),u=r.style.map._antialias,p=r.terrain&&r.terrain.exaggeration()>0;return a===0&&!u&&!p},i.dE=function(r){let e=r.pixelsPerMeter,n=e/Z(1,r.center.lat),a=yt(new Float64Array(16));return Lt(a,a,[r.point.x,r.point.y,0]),qn(a,a,[n,n,e]),Float32Array.from(a)},i.dF=b0,i.dG=function(r){let e=Q-5;r=G(r,-e,e)/e*90;let n=Math.pow(Math.abs(Math.sin(gn(r))),3);return Math.round(n*(g.length-1))},i.dH=function(r,e,n,a){let u=e.getNorth(),p=e.getSouth(),m=e.getWest(),_=e.getEast(),b=1<<r.z,w=_-m,I=u-p,S=w/h,D=-I/g[n],P=[0,S,0,D,0,0,u,m,0];if(r.z>0){let O=180/a;Oe(P,P,[O/w+1,0,0,0,O/I+1,0,-.5*O/S,.5*O/D,1])}return P[2]=b,P[5]=r.x,P[8]=r.y,P},i.dI=El,i.dJ=function(r,e,n){let a=yt(new Float64Array(16)),u=(e/(1<<r)-.5)*Math.PI*2;return Vi(a,n.globeMatrix,u),Float32Array.from(a)},i.dK=vA,i.dL=x0,i.dM=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},i.dN=ee,i.dO=function(r,e){var n=Math.sin(e),a=Math.cos(e);return r[0]=a,r[1]=n,r[2]=0,r[3]=-n,r[4]=a,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},i.dP=al,i.dQ=oA,i.dR=fi,i.dS=Pi,i.dT=256,i.dU=function(r,e){let n=[0,0,0];return ki(n,n,E0(El(e.canonical))),ki(n,n,r),n},i.dV=r=>({u_matrix:new lh(r),u_texsize:new ma(r),u_pixels_to_tile_units:new o_(r),u_device_pixel_ratio:new nr(r),u_width_scale:new nr(r),u_floor_width_scale:new nr(r),u_image:new up(r),u_units_to_pixels:new ma(r),u_tile_units_to_pixels:new nr(r),u_alpha_discard_threshold:new nr(r),u_trim_offset:new ma(r),u_trim_fade_range:new ma(r),u_trim_color:new ah(r),u_emissive_strength:new nr(r),u_zbias_factor:new nr(r),u_tile_to_meter:new nr(r),u_ground_shadow_factor:new Du(r),u_pattern_transition:new nr(r)}),i.dW=r=>({u_matrix:new lh(r),u_pixels_to_tile_units:new o_(r),u_device_pixel_ratio:new nr(r),u_width_scale:new nr(r),u_floor_width_scale:new nr(r),u_units_to_pixels:new ma(r),u_dash_image:new up(r),u_gradient_image:new up(r),u_image_height:new nr(r),u_texsize:new ma(r),u_tile_units_to_pixels:new nr(r),u_alpha_discard_threshold:new nr(r),u_trim_offset:new ma(r),u_trim_fade_range:new ma(r),u_trim_color:new ah(r),u_emissive_strength:new nr(r),u_zbias_factor:new nr(r),u_tile_to_meter:new nr(r),u_ground_shadow_factor:new Du(r)}),i.dX=r=>({u_camera_to_center_distance:new nr(r),u_extrude_scale:new o_(r),u_device_pixel_ratio:new nr(r),u_matrix:new lh(r),u_inv_rot_matrix:new lh(r),u_merc_center:new ma(r),u_tile_id:new Du(r),u_zoom_transition:new nr(r),u_up_dir:new Du(r),u_emissive_strength:new nr(r)}),i.dY=Eu,i.dZ=a3,i.d_=class{constructor(r,e,n,a){this.context=r,this.format=a,this.size=n,this.texture=r.gl.createTexture();let[u,p,m]=this.size,{gl:_}=r;_.bindTexture(_.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),"data"in e&&e.data&&_.texImage3D(_.TEXTURE_3D,0,this.format,u,p,m,0,FE(this.format),kE(this.format),e.data)}bind(r,e){let{context:n}=this,{gl:a}=n;a.bindTexture(a.TEXTURE_3D,this.texture),r!==this.minFilter&&(a.texParameteri(a.TEXTURE_3D,a.TEXTURE_MAG_FILTER,r),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_S,e),a.texParameteri(a.TEXTURE_3D,a.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){let{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},i.da=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},i.db=EM,i.dc=HE,i.dd=CM,i.de=fT,i.df=function(r,e){return r.readFields(rV,{icons:[]},e)},i.dg=L0,i.dh=Ip,i.di=tT,i.dj=Zm,i.dk=Qv,i.dl=bd,i.dm=Md,i.dn=St,i.dp=function(r){let e=r.indexOf(th);return e>=0?r.slice(0,e):r},i.dq=function(r){return r.indexOf(th)>=0},i.dr=function(r){let e=r.lastIndexOf(th);return e>=0?r.slice(e+1):""},i.ds=function(r){let e=[],n=r.id;return n===void 0&&e.push({message:`layers.${n}: missing required property "id"`}),r.render===void 0&&e.push({message:`layers.${n}: missing required method "render"`}),r.renderingMode&&r.renderingMode!=="2d"&&r.renderingMode!=="3d"&&e.push({message:`layers.${n}: property "renderingMode" must be either "2d" or "3d"`}),e},i.dt=function(r,e,n,a){return r.type==="custom"?new K3(r,e):new nV[r.type](r,e,n,a)},i.du=We,i.dv=function(r){let e=r.indexOf(th);return e>=0?r.slice(e+1):""},i.dw=class extends gh{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){let r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},i.dx=kg,i.dy=Td,i.dz=function(r){return r({pluginStatus:fo,pluginURL:vl}),kg.on("pluginStateChange",r),r},i.e=pi,i.e$=function([r,e,n]){let a=Math.hypot(r,e,n),u=Math.atan2(r,n),p=.5*Math.PI-Math.acos(-e/a);return new L(eo(u),eo(p))},i.e0=(r,e,n,a,u,p)=>{let m=r.transform,_=m.projection.name==="globe",b;if(p.paint.get("circle-pitch-alignment")==="map")if(_){let I=oA(m.zoom,e.canonical)*m._pixelsPerMercatorPixel;b=Float32Array.from([I,0,0,I])}else b=m.calculatePixelsToTileUnitsMatrix(n);else b=new Float32Array([m.pixelsToGLUnits[0],0,0,m.pixelsToGLUnits[1]]);let w={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(m.projection),u_matrix:r.translatePosMatrix(e.projMatrix,n,p.paint.get("circle-translate"),p.paint.get("circle-translate-anchor")),u_device_pixel_ratio:Lo.devicePixelRatio,u_extrude_scale:b,u_inv_rot_matrix:Iz,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:p.paint.get("circle-emissive-strength")};if(_){w.u_inv_rot_matrix=a,w.u_merc_center=u,w.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],w.u_zoom_transition=Ru(m.zoom);let I=u[0]*rt,S=u[1]*rt;w.u_up_dir=m.projection.upVector(new ns(0,0,0),I,S)}return w},i.e1=GM,i.e2=Eo,i.e3=(r,e,n,a,u,p,m,_,b,w)=>{let I=r.transform,S=I.pitch<15?UM(.07,.7,G((14-I.zoom)/5,0,1)):.07,D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:$M(r,e,n,a),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:I.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:u,u_width_scale:p,u_floor_width_scale:m,u_image:0,u_tile_units_to_pixels:HM(e,I),u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:_,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:S,u_tile_to_meter:ue(e.tileID.canonical,0),u_ground_shadow_factor:b,u_pattern_transition:w}},i.e4=(r,e,n,a,u,p,m,_,b,w)=>{let I=r.transform,S=I.calculatePixelsToTileUnitsMatrix(e),D=n.paint.get("line-trim-color-use-theme").constantOr("default")==="none",P=I.pitch<15?UM(.07,.7,G((14-I.zoom)/5,0,1)):.07;return{u_matrix:$M(r,e,n,a),u_pixels_to_tile_units:S,u_device_pixel_ratio:p,u_width_scale:m,u_floor_width_scale:_,u_units_to_pixels:[1/I.pixelsToGLUnits[0],1/I.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:u,u_texsize:qM(n)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:HM(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:b,u_trim_fade_range:n.paint.get("line-trim-fade-range"),u_trim_color:n.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:n.lut).toArray01(),u_emissive_strength:n.paint.get("line-emissive-strength"),u_zbias_factor:P,u_tile_to_meter:ue(e.tileID.canonical,0),u_ground_shadow_factor:w}},i.e5=xe,i.e6=c_,i.e7=ae,i.e8=mc,i.e9=R0,i.eA=gT,i.eB=j0,i.eC=V0,i.eD=[1,1,1],i.eE=Ap,i.eF=Po,i.eG=function(r,e,n,a){var u=e[0],p=e[1],m=e[2],_=e[3];return r[0]=u+a*(n[0]-u),r[1]=p+a*(n[1]-p),r[2]=m+a*(n[2]-m),r[3]=_+a*(n[3]-_),r},i.eH=xp,i.eI=Ss,i.eJ=wl,i.eK=function(r,e,n,a,u,p,m,_,b,w,I,S,D,P,O,N){var V=new k(16);return V[0]=r,V[1]=e,V[2]=n,V[3]=a,V[4]=u,V[5]=p,V[6]=m,V[7]=_,V[8]=b,V[9]=w,V[10]=I,V[11]=S,V[12]=D,V[13]=P,V[14]=O,V[15]=N,V},i.eL=A,i.eM=Kg,i.eN=ih,i.eO=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new Ze(1/0,1/0),max:new Ze(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){let n=BA(new Ze(0,0),new Ze(rt,rt),r),a=[];if(e&&!EE(n,this._globalClipBounds))return a;for(let u of this._activeRegions){if(u.hiddenByOverlap||!EE(n,u))continue;let p=eB(u.min,u.max,r);a.push({min:p.min,max:p.max,sourceId:this._sourceIds[u.priority],footprint:u.footprint,footprintTileId:u.tileId,order:u.order,clipMask:u.clipMask,clipScope:u.clipScope})}return a}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{let n=[];for(let a of e.cache.getVisibleCoordinates()){let u=e.cache.getTile(a).buckets[e.layer];u&&u.updateFootprints(a.toUnwrapped(),n)}return n},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){let e=r.getFootprints();if(e.length===0)return;let n=r.getOrder(),a=r.getClipMask(),u=r.getClipScope();for(let p of e){if(!p.footprint)continue;let m=BA(p.footprint.min,p.footprint.max,p.id);this._activeRegions.push({min:m.min,max:m.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:p.id,footprint:p.footprint,order:n,clipMask:a,clipScope:u})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,n)=>e.priority-n.priority||C0(e.min,n.min)||C0(e.max,n.max)||e.order-n.order||e.clipMask-n.clipMask||(function(a,u){let p=(m,_)=>m+_;return a.length-u.length||a.reduce(p,"").localeCompare(u.reduce(p,""))})(e.clipScope,n.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){let n=this._activeRegions[e],a=this._prevRegions[e];r=n.priority!==a.priority||!zA(n,a)||n.order!==a.order||n.clipMask!==a.clipMask||!Aa(n.clipScope,a.clipScope),this._activeRegions[e].hiddenByOverlap=a.hiddenByOverlap,++e}}if(r){++this._updateTime;for(let n of this._activeRegions)n.order!==m_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,n.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,n.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,n.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,n.max.y));let e=n=>{let a=this._activeRegions;if(n>=a.length)return n;let u=a[n].priority;for(;n<a.length&&a[n].priority===u;)++n;return n};if(this._sourceIds.length>1){let n=0,a=e(n);for(;n!==a;){let u=n,p=n;for(;u!==a;){let m=this._activeRegions[u];m.hiddenByOverlap=!1;for(let _=0;_<p;_++){let b=this._activeRegions[_];if(!b.hiddenByOverlap&&m.order===m_&&EE(m,b)&&(m.hiddenByOverlap=VA(m.footprint,m.tileId,b.footprint,b.tileId),m.hiddenByOverlap))break}++u}n=a,a=e(n)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},i.eP=m_,i.eQ=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(let r of this._poleSegments)r.destroy();for(let r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){let n=new To,a=new wi,u=[],p=r+1+2,m=e[0]+1,_=e[0]+1+(1+e.length),b=(w,I,S)=>{let D=w===p-1?w-2:w===0?w:w-1;return D+=S?24575:0,[D,I]};for(let w=0;w<p;++w)n.emplaceBack(...b(w,0,!0));for(let w=0;w<m;++w)for(let I=0;I<p;++I)n.emplaceBack(...b(I,w,(I===0||I===p-1)&&!0));for(let w=0;w<e.length;++w){let I=e[w];for(let S=0;S<p;++S)n.emplaceBack(...b(S,I,!0))}for(let w=0;w<e.length;++w){let I=a.length,S=e[w]+1+2,D=new wi;for(let N=0;N<S-1;N++){let V=N===S-2,U=V?p*(_-e.length+w-N):p;for(let W=0;W<p-1;W++){let X=N*p+W;N===0||V||W===0||W===p-2?(D.emplaceBack(X+1,X,X+U),D.emplaceBack(X+U,X+U+1,X+1)):(a.emplaceBack(X+1,X,X+U),a.emplaceBack(X+U,X+U+1,X+1))}}let P=Ci.simpleSegment(0,I,n.length,a.length-I);for(let N=0;N<D.uint16.length;N+=3)a.emplaceBack(D.uint16[N],D.uint16[N+1],D.uint16[N+2]);let O=Ci.simpleSegment(0,I,n.length,a.length-I);u.push({withoutSkirts:P,withSkirts:O})}return{vertices:n,indices:a,segments:u}}_createGrid(r){let e=this._fillGridMeshWithLods(h,g);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,eA.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){let e=new wi;for(let m=0;m<=h;m++)e.emplaceBack(0,m+1,m+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);let n=new pc,a=new pc,u=new pc,p=new pc;this._poleSegments=[];for(let m=0,_=0;m<d;m++){let b=360/(1<<m);n.emplaceBack(0,-Io,0,.5,0),a.emplaceBack(0,-Io,0,.5,1),u.emplaceBack(0,-Io,0,.5,.5),p.emplaceBack(0,-Io,0,.5,.5);for(let w=0;w<=h;w++){let I=w/h,S=0,D=zt(0,b,I),[P,O,N]=E(Ez,Tz,D,Io);n.emplaceBack(P,O,N,I,S),a.emplaceBack(P,O,N,I,1-S);let V=gn(D);I=.5+.5*Math.sin(V),S=.5+.5*Math.cos(V),u.emplaceBack(P,O,N,I,S),p.emplaceBack(P,O,N,I,1-S)}this._poleSegments.push(Ci.simpleSegment(_,0,66,64)),_+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(n,fp,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(a,fp,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(u,fp,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(p,fp,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},i.eR=kA,i.eS=we,i.eT=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},i.eU=H,i.eV=ie,i.eW=function(r,e,n){return r[0]=e[0]/n[0],r[1]=e[1]/n[1],r[2]=e[2]/n[2],r},i.eX=md,i.eY=T,i.eZ=pd,i.e_=bi,i.ea=tM,i.eb=Ou,i.ec=GA,i.ed=$A,i.ee=se,i.ef=function(r,e){if(r===e){var n=e[1],a=e[2],u=e[3],p=e[6],m=e[7],_=e[11];r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=n,r[6]=e[9],r[7]=e[13],r[8]=a,r[9]=p,r[11]=e[14],r[12]=u,r[13]=m,r[14]=_}else r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15];return r},i.eg=Y3,i.eh=hn,i.ei=Qg,i.ej=256,i.ek=hE,i.el=Jo,i.em=Vi,i.en=function(r,e){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],r},i.eo=pc,i.ep=Yg,i.eq=Gv,i.er=function(r,e,n,a,u){return G((r-e)/(n-e)*(u-a)+a,a,u)},i.es=ql,i.et=function(r,e){var n=e[0],a=e[1],u=e[2],p=e[3],m=e[4],_=e[5],b=e[6],w=e[7],I=e[8],S=I*m-_*w,D=-I*p+_*b,P=w*p-m*b,O=n*S+a*D+u*P;return O?(r[0]=S*(O=1/O),r[1]=(-I*a+u*w)*O,r[2]=(_*a-u*m)*O,r[3]=D*O,r[4]=(I*n-u*b)*O,r[5]=(-_*n+u*p)*O,r[6]=P*O,r[7]=(-w*n+a*b)*O,r[8]=(m*n-a*p)*O,r):null},i.eu=2,i.ev=sa,i.ew=cl,i.ex=ud,i.ey=function(r,e){var n=new k(3);ud(n,e);var a=1/n[0],u=1/n[1],p=1/n[2],m=e[0]*a,_=e[1]*u,b=e[2]*p,w=e[4]*a,I=e[5]*u,S=e[6]*p,D=e[8]*a,P=e[9]*u,O=e[10]*p,N=m+I+O,V=0;return N>0?(V=2*Math.sqrt(N+1),r[3]=.25*V,r[0]=(S-P)/V,r[1]=(D-b)/V,r[2]=(_-w)/V):m>I&&m>O?(V=2*Math.sqrt(1+m-I-O),r[3]=(S-P)/V,r[0]=.25*V,r[1]=(_+w)/V,r[2]=(D+b)/V):I>O?(V=2*Math.sqrt(1+I-m-O),r[3]=(D-b)/V,r[0]=(_+w)/V,r[1]=.25*V,r[2]=(S+P)/V):(V=2*Math.sqrt(1+O-m-I),r[3]=(_-w)/V,r[0]=(D+b)/V,r[1]=(S+P)/V,r[2]=.25*V),r},i.ez=function(r,e){var n=2*Math.acos(e[3]),a=Math.sin(n/2);return a>C?(r[0]=e[0]/a,r[1]=e[1]/a,r[2]=e[2]/a):(r[0]=1,r[1]=0,r[2]=0),n},i.f=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,n)=>String.fromCharCode(+("0x"+n))))},i.f0=gd,i.f1=zE,i.f2=function(r){let e=r.navigator?r.navigator.userAgent:null;return!!(function(n){if(Zi==null){let a=n.navigator?n.navigator.userAgent:null;Zi=!!n.safari||!(!a||!(/\b(iPad|iPhone|iPod)\b/.test(a)||a.match("Safari")&&!a.match("Chrome")))}return Zi})(r)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},i.f3=function(r,e){Ed=r,wo=e},i.f4=pE,i.f5=aA,i.f6=function(r){let e=[0,0,0],n=yt(new Float64Array(16));return At(n,r.pixelMatrix,r.globeMatrix),ki(e,e,n),new Ze(e[0],e[1])},i.f7=function(){let r=b_;r&&(r.isPreloaded()&&r.numActive()===1?(r.release(ME),b_=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},i.f8=function(){L0().acquire(ME)},i.f9=Ng,i.fA=Ge,i.fB=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==yM){let n=new Uint32Array(r,0,7),[,,a,u,p,m]=n;e=n.byteLength+u+p+m+p,(a!==r.byteLength||e>=r.byteLength)&&Rt("Invalid b3dm header information.")}return wM(r,e)},i.fC=function(r,e){let n=HE(r);for(let a of n){for(let u of a.meshes)RB(u);a.lights&&(a.lightMeshIndex=a.meshes.length,a.meshes.push(PB(a.lights,e)))}return n},i.fD=ax,i.fE=Ni,i.fF=fM,i.fG=No,i.fH=ko,i.fI=function(r){Kl(),ho?.then(e=>{e.keys().then(n=>{for(let a=0;a<n.length-r;a++)e.delete(n[a]).catch(u=>Rt(u.message))}).catch(n=>Rt(n.message))}).catch(e=>Rt(e.message))},i.fa=function(r,e,n=!1){if(fo===ko.deferred||fo===ko.loading||fo===ko.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");vl=Lo.resolveURL(r),fo=ko.deferred,Lg=e,Fg(),n||zg()},i.fb=function(r){_p=Lo.resolveURL(r),yp||(yp=new gp(L0(),new Ra)),yp.broadcast("setMeshoptUrl",_p)},i.fc=gM,i.fd=function(r){PE=Lo.resolveURL(r),yp||(yp=new gp(L0(),new Ra)),yp.broadcast("setDracoUrl",PE)},i.fe=mM,i.ff=x_,i.fg=function(r){let e=Ma();if(!e)return;let n=e.delete(wd);r&&n.then(()=>r()).catch(r)},i.fh=O0,i.fi=vt,i.fj=Pu,i.fk=Ga,i.fl=NP,i.fm=zP,i.fn=zM,i.fo=ht,i.fp="hd_road_elevation",i.fq=$t,i.fr=et,i.fs=_c,i.ft=eT,i.fu=ph,i.fv=function(r,e,n,a,u,p,m,_=1,b,w,I){r.createArrays(),r.tilePixelRatio=rt/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;let S=r.layers[0].layout,D=r.layers[0]._unevaluatedLayout._values,P={};P.scaleFactor=_,P.textSizeScaleRange=S.get("text-size-scale-range"),P.iconSizeScaleRange=S.get("icon-size-scale-range");let[O,N]=P.textSizeScaleRange,[V,U]=P.iconSizeScaleRange;P.textScaleFactor=G(P.scaleFactor,O,N),P.iconScaleFactor=G(P.scaleFactor,V,U);let W=D["text-size"],X=D["icon-size"];if(r.textSizeData.kind==="composite"){let{minZoom:ge,maxZoom:Le}=r.textSizeData;P.compositeTextSizes=[W.possiblyEvaluate(new ci(ge,{worldview:I}),p),W.possiblyEvaluate(new ci(Le,{worldview:I}),p)]}if(r.iconSizeData.kind==="composite"){let{minZoom:ge,maxZoom:Le}=r.iconSizeData;P.compositeIconSizes=[X.possiblyEvaluate(new ci(ge,{worldview:I}),p),X.possiblyEvaluate(new ci(Le,{worldview:I}),p)]}P.layoutTextSize=W.possiblyEvaluate(new ci(m+1,{worldview:I}),p),P.layoutIconSize=X.possiblyEvaluate(new ci(m+1,{worldview:I}),p),P.textMaxSize=W.possiblyEvaluate(new ci(18,{worldview:I}),p);let K=S.get("symbol-placement"),le=S.get("text-rotation-alignment")==="map"&&K!=="point",re=S.get("text-size"),de=!1,pe=[];for(let ge of r.features){let Le=S.get("text-font").evaluate(ge,{},p).join(","),Te=re.evaluate(ge,{},p)*P.textScaleFactor,ke=P.layoutTextSize.evaluate(ge,{},p)*P.textScaleFactor,je=P.layoutIconSize.evaluate(ge,{},p)*P.iconScaleFactor,$e={horizontal:{},vertical:void 0},nt=ge.text,Ye,Ue=[0,0];if(nt){let an=nt.toString(),En=S.get("text-letter-spacing").evaluate(ge,{},p)*Nr,Yt=S.get("text-line-height").evaluate(ge,{},p)*Nr,Cn=Kv(an)?En:0,An=S.get("text-anchor").evaluate(ge,{},p),Ii=S.get("text-variable-anchor");if(!Ii){let ze=S.get("text-radial-offset").evaluate(ge,{},p);if(ze)Ue=bR(An,[ze*Nr,iT]);else{let lt=S.get("text-offset").evaluate(ge,{},p);Ue=[lt[0]*Nr,lt[1]*Nr]}}let oe=le?"center":S.get("text-justify").evaluate(ge,{},p),te=K==="point",Ne=te?S.get("text-max-width").evaluate(ge,{},p)*Nr:1/0,st=ze=>{r.allowVerticalPlacement&&Rg(an)&&($e.vertical=YE(nt,e,n,u,Le,Ne,Yt,An,ze,Cn,Ue,os.vertical,!0,ke,Te,b))};if(!le&&Ii){let ze=oe==="auto"?Ii.map(Dt=>rT(Dt)):[oe],lt=!1;for(let Dt=0;Dt<ze.length;Dt++){let It=ze[Dt];if(!$e.horizontal[It])if(lt)$e.horizontal[It]=$e.horizontal[0];else{let Jt=YE(nt,e,n,u,Le,Ne,Yt,"center",It,Cn,Ue,os.horizontal,!1,ke,Te,b);Jt&&($e.horizontal[It]=Jt,lt=Jt.positionedLines.length===1)}}st("left")}else{if(oe==="auto"&&(oe=rT(An)),te||S.get("text-writing-mode").indexOf("horizontal")>=0||!Rg(an)){let ze=YE(nt,e,n,u,Le,Ne,Yt,An,oe,Cn,Ue,os.horizontal,!1,ke,Te,b);ze&&($e.horizontal[oe]=ze)}st(te?"left":oe)}}let Xe,Re,Ae,qe,Qe,He,_t=!1,bt=S.get("icon-text-fit").evaluate(ge,{},p);if(ge.icon&&ge.icon.hasPrimary()){let an=R_(ge.icon,r.iconSizeData,D["icon-size"],p,r.zoom,ge,b,P.iconScaleFactor,I);Xe=an.iconPrimary,Ae=an.iconSecondary;let En=Xe.toString();if(Re=a.get(En),Re&&(Qe=S.get("icon-offset").evaluate(ge,{},p),He=S.get("icon-anchor").evaluate(ge,{},p),Ye=q0(u.get(En),Ae?u.get(Ae.toString()):void 0,Qe,He),_t=Re.sdf,r.sdfIcons===void 0?r.sdfIcons=Re.sdf:r.sdfIcons!==Re.sdf&&Rt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Re.pixelRatio!==r.pixelRatio||S.get("icon-rotate").constantOr(1)!==0)&&(r.iconsNeedLinear=!0)),Ae){let Yt=Ae.toString();qe=a.get(Yt)}}de=de||!(!ge.icon||!ge.icon.hasSecondary());let ft=oT($e.horizontal)||$e.vertical;r.iconsInText||(r.iconsInText=!!ft&&ft.iconsInText);let at=ke*P.textScaleFactor/Nr,{defaultShapedIcon:Gt,verticallyShapedIcon:ut}=k3(r,Ye,S,ge,p,$e,at,Qe,bt);bt!=="none"&&Ye&&(sR(Ye)||aR(Ye))&&(K0(0,Re,Xe,Ye,Gt,bt,w,a,u),K0(0,qe,Ae,Ye,Gt,bt,w,a,u),ut&&(K0(0,Re,Xe,Ye,ut,bt,w,a,u),K0(0,qe,Ae,Ye,ut,bt,w,a,u))),Ye=Gt;let{iconBBox:Mt,iconVerticalBBox:Zt}=O3(r,Ye,ut,S,ge,p,je,Qe,P,u,He);pe.push({feature:ge,shapedTextOrientations:$e,shapedText:ft,shapedIcon:Ye,iconPrimary:Xe,iconSecondary:Ae,iconOffset:Qe,iconAnchor:He,verticallyShapedIcon:ut,layoutTextSize:ke,layoutIconSize:je,textOffset:Ue,isSDFIcon:_t,iconTextFit:bt,iconCollisionBounds:Mt,iconVerticalCollisionBounds:Zt})}return{featureData:pe,sizes:P,hasAnySecondaryIcon:de,textAlongLine:le,symbolPlacement:K}},i.fw=mR,i.fx=function(r,e,n,a,u,p,m,_,b,w){r.iconAtlasPositions=w.iconPositions;let{featureData:I,hasAnySecondaryIcon:S,sizes:D,textAlongLine:P,symbolPlacement:O}=e;for(let N of I){let{shapedIcon:V,verticallyShapedIcon:U,feature:W,shapedTextOrientations:X,shapedText:K,layoutTextSize:le,textOffset:re,isSDFIcon:de,iconPrimary:pe,iconSecondary:ge,iconTextFit:Le,iconOffset:Te,iconCollisionBounds:ke,iconVerticalCollisionBounds:je}=N;ER(V,w.iconPositions,pe,ge),ER(U,w.iconPositions,pe,ge),F3(X,w.iconPositions),L3(pe,ge,w.iconPositions),(K||V)&&N3(r,W,X,V,U,b,D,le,0,re,de,a,u,m,_,S,Le,Te,P,O,ke,je)}n&&r.generateCollisionDebugBuffers(p,r.collisionBoxArray,D.textScaleFactor)},i.fy=wt,i.fz=fx,i.g=function(r,e){return Td(Object.assign(r,{method:"GET"}),e)},i.h=function(r){return r.indexOf("mapbox:")===0},i.i=function(r){return pi.API_STYLE_REGEX.test(r)&&!to(r)},i.j=mr,i.k=df,i.l=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},i.m=function(r,e){return Td(Object.assign(r,{type:"json"}),e)},i.n=Ym,i.o=Lo,i.p=function(r,e){return Td(Object.assign(r,{method:"POST"}),e)},i.q=Yr,i.r=Oo,i.s=function(r){try{let e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},i.t=function(){return RE||(RE=new O0),RE},i.u=function(){return(function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)})()},i.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},i.w=Rt,i.x=bT,i.y=Rd,i.z=Zo}),f(["./shared"],function(i){function C(we){let H=we?we.url.toString():void 0;return H?performance.getEntriesByName(H):[]}function k(we){if(typeof we=="number"||typeof we=="boolean"||typeof we=="string"||we==null)return JSON.stringify(we);if(Array.isArray(we)){let G="[";for(let ne of we)G+=`${k(ne)},`;return`${G}]`}let H="{";for(let G of Object.keys(we).sort())H+=`${G}:${k(we[G])},`;return`${H}}`}function B(we){let H="";for(let G of i.bw)H+=`/${k(we[G])}`;return H}class ee{constructor(H){this.keyCache={},this._layers={},this._layerConfigs={},H&&this.replace(H)}replace(H,G){this._layerConfigs={},this._layers={},this.update(H,[],G)}update(H,G,ne){this._options=ne;for(let he of H)this._layerConfigs[he.id]=he,(this._layers[he.id]=i.dt(he,this.scope,null,this._options)).compileFilter(ne),this.keyCache[he.id]&&delete this.keyCache[he.id];for(let he of G)delete this.keyCache[he],delete this._layerConfigs[he],delete this._layers[he];this.familiesBySource={};let fe=(function(he,ve){let Me={};for(let Ce=0;Ce<he.length;Ce++){let et=he[Ce],We=ve&&ve[et.id];We||(et.type==="symbol"?We=et.id:(We=B(et),et.type==="line"&&et.paint&&(function Ht(Vt){return typeof Vt=="string"&&Vt==="line-progress"||(Array.isArray(Vt)?Vt.some(Ht):!(!Vt||typeof Vt!="object")&&Object.values(Vt).some(Ht))})(et.paint["line-width"])&&(We+=`/${k(et.paint["line-width"])}`))),ve&&(ve[et.id]=We);let St=Me[We];St||(St=Me[We]=[]),St.push(et)}let xe=[];for(let Ce in Me)xe.push(Me[Ce]);return xe})(Object.values(this._layerConfigs),this.keyCache);for(let he of fe){let ve=he.map(St=>this._layers[St.id]),Me=ve[0];if(Me.visibility==="none")continue;let xe=Me.source||"",Ce=this.familiesBySource[xe];Ce||(Ce=this.familiesBySource[xe]={});let et=Me.sourceLayer||"_geojsonTileLayer",We=Ce[et];We||(We=Ce[et]=[]),We.push(ve)}}}let _e=1*i.fk;class Oe{constructor(H){let G={},ne=[];for(let Me in H){let xe=H[Me],Ce=G[Me]={};for(let et in xe.glyphs){let We=xe.glyphs[+et];if(!We||We.bitmap.width===0||We.bitmap.height===0)continue;let St=We.metrics.localGlyph?_e:1,Ht={x:0,y:0,w:We.bitmap.width+2*St,h:We.bitmap.height+2*St};ne.push(Ht),Ce[et]=Ht}}let{w:fe,h:he}=i.G(ne),ve=new i.fj({width:fe||1,height:he||1});for(let Me in H){let xe=H[Me];for(let Ce in xe.glyphs){let et=xe.glyphs[+Ce];if(!et||et.bitmap.width===0||et.bitmap.height===0)continue;let We=G[Me][Ce],St=et.metrics.localGlyph?_e:1;i.fj.copy(et.bitmap,ve,{x:0,y:0},{x:We.x+St,y:We.y+St},et.bitmap)}}this.image=ve,this.positions=G}}function ct(we,H,G){we[H]?G&&(we[H].center=G):we[H]={floorIds:new Set,center:G||[0,0],floors:{}}}function Fe(we,H,G,ne){for(let fe of H)ct(we,fe),we[fe].floors[G]=ne,we[fe].floorIds.add(G)}function yt(we){return{id:we.properties.id.toString(),center:we.properties.center.toString().split(";").map(Number)}}function Xt(we){return{id:we.properties.id.toString(),isDefault:!!we.properties.is_default&&we.properties.is_default,connections:we.properties.connected_floor_ids?new Set(we.properties.connected_floor_ids.toString().split(";")):new Set,conflicts:we.properties.conflicted_floor_ids?new Set(we.properties.conflicted_floor_ids.toString().split(";")):new Set,buildings:we.properties.building_ids?new Set(we.properties.building_ids.toString().split(";")):new Set,name:we.properties.name.toString(),zIndex:we.properties.z_index}}function At(we,H){return H.every(G=>we.properties&&we.properties[G]!=null)}function Lt(we){return At(we,["type","id","name"])&&we.properties.type==="building"}function qn(we){return At(we,["type","id","name","z_index"])&&we.properties.type==="floor"}i.fi(Oe,"GlyphAtlas");class Sr{constructor(H){this.tileID=new i.aP(H.tileID.overscaledZ,H.tileID.wrap,H.tileID.canonical.z,H.tileID.canonical.x,H.tileID.canonical.y),this.tileZoom=H.tileZoom,this.uid=H.uid,this.zoom=H.zoom,this.lut=H.lut,this.canonical=H.tileID.canonical,this.pixelRatio=H.pixelRatio,this.tileSize=H.tileSize,this.source=H.source,this.scope=H.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=H.showCollisionBoxes,this.collectResourceTiming=!!H.request&&H.request.collectResourceTiming,this.promoteId=H.promoteId,this.isSymbolTile=H.isSymbolTile,this.tileTransform=i.aY(H.tileID.canonical,H.projection),this.projection=H.projection,this.worldview=H.worldview,this.localizableLayerIds=H.localizableLayerIds,this.brightness=H.brightness,this.extraShadowCaster=!!H.extraShadowCaster,this.tessellationStep=H.tessellationStep,this.scaleFactor=H.scaleFactor,this.worldview=H.worldview,this.indoor=H.indoor}parse(H,G,ne,fe,he,ve){this.status="parsing",this.data=H,this.collisionBoxArray=new i.b2;let Me=new i.fl(Object.keys(H.layers).sort()),xe=new i.fm(this.tileID,this.promoteId);xe.bucketLayerIDs=[];let Ce={},et=new i.fn(256,256),We={featureIndex:xe,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:et,availableImages:ne,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0,activeFloors:void 0};if(this.indoor){let Rt=this.indoor.indoorState.activeFloorsVisible,sn=(function(dn,Wn,Ni){let ar=(function(Hn,_n){if(!Hn)return i.w("No source layers defined in indoor specification"),_n;if(Hn.size===0)return _n;let fi=Hn.difference(_n);for(let Pi of fi)i.w(`Missing source layer required in indoor specification: ${Pi}`);return _n.intersection(_n)})(Wn.sourceLayers,new Set(Object.keys(dn.layers))),Zi=Wn.indoorState,Hi=(function(Hn,_n,fi,Pi){let Yn=new Set,pi=new Set,mr=new Set,to=new Map,_s={},Yl=vr=>{let ys=to.get(vr)||new Set;for(let uo of Yn)if((to.get(uo)||new Set).has(vr)||ys.has(uo))return!0;return!1};for(let vr of _n){let ys=Hn.layers[vr];if(ys)for(let uo=0;uo<ys.length;uo++){let Us=ys.feature(uo);if(Lt(Us)){let{id:Oo,center:Lo}=yt(Us);ct(_s,Oo,Lo),Yn.add(Oo)}else if(qn(Us)){let{id:Oo,isDefault:Lo,connections:cf,conflicts:bd,buildings:wd,name:Ed,zIndex:wo}=Xt(Us);Fe(_s,wd,Oo,{name:Ed,zIndex:wo}),to.set(Oo,bd),(Oo===Pi||cf.has(Pi))&&Yn.add(Oo),pi.add(Oo),Lo&&mr.add(Oo)}}else i.w(`indoor source layer not found: ${vr}`)}if(fi)for(let vr of fi)pi.has(vr)&&(Yl(vr)||Yn.add(vr));for(let vr of mr)Yn.has(vr)||Yl(vr)||Yn.add(vr);return{buildings:_s,activeFloors:Yn}})(dn,ar,Zi.lastActiveFloors,Zi.selectedFloorId);return Ni.send("setIndoorData",Hi),Hi})(H,this.indoor,he);We.activeFloors=Rt?sn.activeFloors:void 0}let St=[],Ht=G.familiesBySource[this.source];for(let Rt in Ht){let sn=H.layers[Rt];if(!sn)continue;let dn=!1,Wn=!1,Ni=!1;for(let Hn of Ht[Rt])Hn[0].type==="symbol"?dn=!0:Wn=!0,Hn[0].is3D()&&Hn[0].type!=="model"&&(Ni=!0);if(this.extraShadowCaster&&!Ni||this.isSymbolTile===!0&&!dn||this.isSymbolTile===!1&&!Wn)continue;sn.version===1&&i.w(`Vector tile source "${this.source}" layer "${Rt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let ar=Me.encode(Rt),Zi=[],Hi=!1;for(let Hn=0,_n=0;Hn<sn.length;Hn++){let fi=sn.feature(Hn),Pi=xe.getId(fi,Rt);if(this.localizableLayerIds&&this.localizableLayerIds.has(Rt)){let Yn=fi.properties?fi.properties.worldview:null;if(this.worldview&&typeof Yn=="string")if(Yn==="all")fi.properties.$localized=!0;else{if(!Yn.split(",").includes(this.worldview))continue;fi.properties.$localized=!0,fi.properties.worldview=this.worldview}}!Hi&&fi.properties&&fi.properties.hasOwnProperty(i.fo)&&(Hi=!0),Zi.push({feature:fi,id:Pi,index:_n,sourceLayerIndex:ar}),_n++}Hi&&!We.elevationFeatures&&H.layers.hasOwnProperty(i.fp)&&(We.elevationFeatures=i.fq.parseFrom(H.layers[i.fp],this.canonical));for(let Hn of Ht[Rt]){let _n=Hn[0];if(this.extraShadowCaster&&(!_n.is3D()||_n.type==="model")||this.isSymbolTile!==void 0&&_n.type==="symbol"!==this.isSymbolTile||_n.minzoom&&this.zoom<Math.floor(_n.minzoom)||_n.maxzoom&&this.zoom>=_n.maxzoom||_n.visibility==="none")continue;Vi(Hn,this.zoom,We.brightness,ne,this.worldview);let fi=Ce[_n.id]=_n.createBucket({index:xe.bucketLayerIDs.length,layers:Hn,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ar,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:fe,worldview:this.worldview});xe.bucketLayerIDs.push(Hn.map(Yn=>i.B(Yn.id,Yn.scope)));let Pi=fi.prepare?fi.prepare():null;Pi!=null?(Pi=Pi.then(()=>fi.populate(Zi,We,this.tileID.canonical,this.tileTransform)),St.push(Pi)):fi.populate(Zi,We,this.tileID.canonical,this.tileTransform)}}let Vt=()=>{let Rt,sn,dn,Wn,Ni,ar;et.trim();let Zi={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Hi=()=>{if(Rt)return this.status="done",ve(Rt);if(this.extraShadowCaster)this.status="done",ve(null,{buckets:Object.values(Ce).filter(_n=>!_n.isEmpty()),featureIndex:xe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:We.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(sn&&dn&&Wn){let _n=new Oe(sn),fi=new Map;for(let[pi,mr]of dn.entries()){let{imagePosition:to}=i.ft(pi,mr,i.fu);fi.set(pi,to)}let Pi={};for(let pi in Ce){let mr=Ce[pi];mr instanceof i.b3&&(Vi(mr.layers,this.zoom,We.brightness,ne,this.worldview),Pi[pi]=i.fv(mr,sn,_n.positions,dn,fi,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,Ni,this.worldview))}let Yn={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(he,dn,Ni,()=>{Yn.iconsPending=!1,Hn(Pi,_n,Yn)}),this.rasterizeIfNeeded(he,Wn,ar,()=>{Yn.patternsPending=!1,Hn(Pi,_n,Yn)})}},Hn=(_n,fi,Pi,Yn)=>{if(Pi.iconsPending||Pi.patternsPending)return;let pi=new i.fw(dn,Wn,this.lut);for(let mr in Ce){let to=Ce[mr];if(mr in _n)i.fx(to,_n[mr],this.showCollisionBoxes,ne,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,dn,pi);else if(to.hasPattern&&(to instanceof i.b9||to instanceof i.ba||to instanceof i.e9)){Vi(to.layers,this.zoom,We.brightness,ne,this.worldview);let _s=Object.fromEntries(pi.patternPositions);to.addFeatures(We,this.tileID.canonical,_s,ne,this.tileTransform,this.brightness)}}this.status="done",ve(null,{buckets:Object.values(Ce).filter(mr=>!mr.isEmpty()),featureIndex:xe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:fi.image,lineAtlas:et,imageAtlas:pi,brightness:We.brightness})};if(!this.extraShadowCaster){let _n=i.fr(We.glyphDependencies,Yn=>Object.keys(Yn).map(Number));Object.keys(_n).length?he.send("getGlyphs",{uid:this.uid,stacks:_n},(Yn,pi)=>{Rt||(Rt=Yn,sn=pi,Hi())},void 0,!1,Zi):sn={};let fi=Array.from(We.iconDependencies.keys()).map(Yn=>i.I.parse(Yn));fi.length?he.send("getImages",{images:fi,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Yn,pi)=>{Rt||(Rt=Yn,dn=new Map,Ni=this.updateImageMapAndGetImageTaskQueue(dn,pi,We.iconDependencies),Hi())},void 0,!1,Zi):(dn=new Map,Ni=new Map);let Pi=Array.from(We.patternDependencies.keys()).map(Yn=>i.I.parse(Yn));Pi.length?he.send("getImages",{images:Pi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Yn,pi)=>{Rt||(Rt=Yn,Wn=new Map,ar=this.updateImageMapAndGetImageTaskQueue(Wn,pi,We.patternDependencies),Hi())},void 0,!1,Zi):(Wn=new Map,ar=new Map)}if(We.elevationFeatures&&We.elevationFeatures.length>0){let _n=[];for(let Pi of Object.values(Ce))if(Pi instanceof i.ba){let Yn=Pi.getUnevaluatedPortalGraph();Yn&&_n.push(Yn)}let fi=i.fs.evaluate(_n);for(let Pi of Object.values(Ce))if(Pi instanceof i.ba){let Yn=H.layers[Me.decode(Pi.sourceLayerIndex)];Pi.setEvaluatedPortalGraph(fi,Yn,this.tileID.canonical,We.availableImages,We.brightness)}}Hi()};St.length>0?Promise.allSettled(St).then(Vt).catch(ve):Vt()}updateParameters(H){this.scaleFactor=H.scaleFactor,this.showCollisionBoxes=H.showCollisionBoxes,this.projection=H.projection,this.brightness=H.brightness,this.tileTransform=i.aY(H.tileID.canonical,H.projection),this.extraShadowCaster=H.extraShadowCaster,this.lut=H.lut,this.worldview=H.worldview,this.indoor=H.indoor}rasterizeIfNeeded(H,G,ne,fe){Array.from(G.values()).some(he=>he.usvg)?this.rasterize(H,G,ne,fe):fe()}updateImageMapAndGetImageTaskQueue(H,G,ne){let fe=new Map;for(let he of G.keys()){let ve=ne.get(he)||[];for(let Me of ve){let xe=Me.toString(),Ce=G.get(Me.id.toString());Ce.usvg?fe.has(xe)||(fe.set(xe,Me),H.set(xe,Object.assign({},Ce))):H.set(xe,Ce)}}return fe}rasterize(H,G,ne,fe){this.rasterizeTask=H.send("rasterizeImages",{scope:this.scope,tasks:ne},(he,ve)=>{if(!he)for(let[Me,xe]of ve.entries()){let Ce=Object.assign(G.get(Me),{data:xe});G.set(Me,Ce)}fe()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Vi(we,H,G,ne,fe){let he=new i.ac(H,{brightness:G,worldview:fe});for(let ve of we)ve.recalculate(he,ne)}class jr extends i.E{constructor(H,G,ne,fe,he,ve,Me){super(),this.actor=H,this.layerIndex=G,this.availableImages=ne,this.availableModels=fe,this.loadVectorData=ve||i.aL,this.loading={},this.loaded={},this.deduped=new i.aK(H.scheduler),this.isSpriteLoaded=he,this.scheduler=H.scheduler,this.brightness=Me}loadTile(H,G){let ne=H.uid,fe=H&&H.request,he=fe&&fe.collectResourceTiming,ve=this.loading[ne]=new Sr(H);ve.abort=this.loadVectorData(H,(Me,xe)=>{let Ce=!this.loading[ne];if(delete this.loading[ne],ve.cancelRasterize(),Ce||Me||!xe)return ve.status="done",Ce||(this.loaded[ne]=ve),G(Me);let et=xe.rawData,We={},St=i.aM(xe.responseHeaders);St&&St.expires&&(We.expires=St.expires),St&&St.cacheControl&&(We.cacheControl=St.cacheControl),ve.vectorTile=xe.vectorTile||new i.fy(new i.bs(et));let Ht=()=>{ve.parse(ve.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,(Vt,Rt)=>{if(Vt||!Rt)return G(Vt);let sn={};if(he){let dn=C(fe);dn.length>0&&(sn.resourceTiming=JSON.parse(JSON.stringify(dn)))}G(null,Object.assign({rawTileData:et.slice(0),responseHeaders:xe.responseHeaders},Rt,We,sn))})};this.isSpriteLoaded?Ht():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Ht,{type:"parseTile",isSymbolTile:H.isSymbolTile,zoom:H.tileZoom}):Ht()}),this.loaded=this.loaded||{},this.loaded[ne]=ve})}reloadTile(H,G){let ne=this.loaded,fe=H.uid;if(ne&&ne[fe]){let he=ne[fe];he.updateParameters(H);let ve=(Me,xe)=>{let Ce=he.reloadCallback;Ce&&(delete he.reloadCallback,he.parse(he.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ce)),G(Me,xe)};he.status==="parsing"?he.reloadCallback=ve:he.status==="done"&&(he.vectorTile?he.parse(he.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,ve):ve())}else G(null,void 0)}abortTile(H,G){let ne=H.uid,fe=this.loading[ne];fe&&(fe.abort&&fe.abort(),delete this.loading[ne]),G()}removeTile(H,G){let ne=this.loaded,fe=H.uid;ne&&ne[fe]&&delete ne[fe],G()}}class lo{loadTile(H,G){let{uid:ne,encoding:fe,rawImageData:he,padding:ve}=H,Me=ImageBitmap&&he instanceof ImageBitmap?this.getImageData(he,ve):he;G(null,new i.fz(ne,Me,fe,ve<1))}reloadTile(H,G){G(null,null)}abortTile(H,G){G()}removeTile(H,G){G()}getImageData(H,G){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(H.width,H.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=H.width,this.offscreenCanvas.height=H.height,this.offscreenCanvasContext.drawImage(H,0,0,H.width,H.height);let ne=this.offscreenCanvasContext.getImageData(-G,-G,H.width+2*G,H.height+2*G);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ne}}i.br.setPbf(i.bs);class Sa{constructor(H){this._mrt=new i.br(H.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=H.uid,this.tileID=H.tileID,this.source=H.source}parse(H,G){let ne=this._mrt;this.status="parsing",this._entireBuffer=H;try{ne.parseHeader(H),this._isHeaderLoaded=!0;let fe=[];for(let he in ne.layers){let ve=ne.getLayer(he),Me=ve.getDataRange(ve.getBandList()),xe=ne.createDecodingTask(Me),Ce=H.slice(Me.firstByte,Me.lastByte+1),et=i.br.performDecoding(Ce,xe).then(We=>xe.complete(null,We)).catch(We=>xe.complete(We,null));fe.push(et)}Promise.allSettled(fe).then(()=>G(null,ne)).catch(he=>G(he))}catch(fe){G(fe)}}}class ud{constructor(H){this.actor=H,this.loading={},this.loaded={}}loadTile(H,G){let ne=H.uid,fe=H.request,he=this.loading[ne]=new Sa(H),{cancel:ve}=i.bt(fe,(Me,xe,Ce)=>{let et=!this.loading[ne];if(delete this.loading[ne],et||Me||!xe)return he.status="done",et||(this.loaded[ne]=he),G(Me);he.parse(xe,(We,St)=>{if(We||!St)return G(We);G(null,St,Ce)}),this.loaded[ne]=he});he.abort=ve}reloadTile(H,G){G(null,void 0)}abortTile(H,G){let ne=H.uid,fe=this.loading[ne];fe&&(fe.abort&&fe.abort(),delete this.loading[ne]),G()}removeTile(H,G){let ne=H.uid;this.loaded[ne]&&delete this.loaded[ne],G()}decodeRasterArray(H,G){i.br.performDecoding(H.buffer,H.task).then(ne=>G(null,ne)).catch(ne=>G(ne))}}let dd=i.fA.prototype.toGeoJSON;class hd{constructor(H){this._feature=H,this.extent=i.al,this.type=H.type,this.properties=H.tags,"id"in H&&!isNaN(H.id)&&(this.id=parseInt(H.id,10))}loadGeometry(){if(this._feature.type===1){let H=[];for(let G of this._feature.geometry)H.push([new i.P(G[0],G[1])]);return H}{let H=[];for(let G of this._feature.geometry){let ne=[];for(let fe of G)ne.push(new i.P(fe[0],fe[1]));H.push(ne)}return H}}toGeoJSON(H,G,ne){return dd.call(this,H,G,ne)}}class Un{constructor(H,G){this.name=H,this.extent=i.al,this.length=G.length,this._jsonFeatures=G}feature(H){return new hd(this._jsonFeatures[H])}}class sf{constructor(H){this.layers={},this.extent=i.al;for(let G of Object.keys(H))this.layers[G]=new Un(G,H[G])}}let Qr=64/4096,ji=128;class bi{constructor(){this.features=new Map}clear(){this.features.clear()}load(H=[],G){for(let ne of H){let fe=ne.id;if(fe==null)continue;let he=this.features.get(fe);he&&this.updateCache(he,G),ne.geometry?(he=ra(ne),this.updateCache(he,G),this.features.set(fe,he)):this.features.delete(fe),this.updateCache(he,G)}}updateCache(H,G){for(let{canonical:ne,uid:fe}of Object.values(G)){let{z:he,x:ve,y:Me}=ne;or(H,Math.pow(2,he),ve,Me)&&delete G[fe]}}getTile(H,G,ne){let fe=Math.pow(2,H),he=[];for(let ve of this.features.values())or(ve,fe,G,ne)&&he.push(Mi(ve,fe,G,ne));return{features:he}}getFeatures(){return[...this.features.values()]}}function or({minX:we,minY:H,maxX:G,maxY:ne},fe,he,ve){return we<(he+1+Qr)/fe&&H<(ve+1+Qr)/fe&&G>(he-Qr)/fe&&ne>(ve-Qr)/fe}function ra(we){let{id:H,geometry:G,properties:ne}=we;if(!G)return;if(G.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");let{type:fe,coordinates:he}=G,ve={id:H,type:1,geometry:[],tags:ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},Me=ve.geometry;if(fe==="Point")zs(he,Me,ve);else if(fe==="MultiPoint")for(let xe of he)zs(xe,Me,ve);else if(fe==="LineString")ve.type=2,oa(he,Me,ve);else if(fe==="MultiLineString")ve.type=2,ms(he,Me,ve);else if(fe==="Polygon")ve.type=3,ms(he,Me,ve,!0);else{if(fe!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");ve.type=3;for(let xe of he)ms(xe,Me,ve,!0)}return ve}function zs([we,H],G,ne){let fe=i.aF(we),he=i.aJ(H);he=he<0?0:he>1?1:he,G.push(fe,he),ne.minX=Math.min(ne.minX,fe),ne.minY=Math.min(ne.minY,he),ne.maxX=Math.max(ne.maxX,fe),ne.maxY=Math.max(ne.maxY,he)}function oa(we,H,G,ne=!1,fe=!1){let he=[];for(let ve of we)zs(ve,he,G);H.push(he),ne&&(function(ve,Me){let xe=0;for(let Ce=0,et=ve.length,We=et-2;Ce<et;We=Ce,Ce+=2)xe+=(ve[Ce]-ve[We])*(ve[Ce+1]+ve[We+1]);if(xe>0===Me)for(let Ce=0,et=ve.length;Ce<et/2;Ce+=2){let We=ve[Ce],St=ve[Ce+1];ve[Ce]=ve[et-2-Ce],ve[Ce+1]=ve[et-1-Ce],ve[et-2-Ce]=We,ve[et-1-Ce]=St}})(he,fe)}function ms(we,H,G,ne=!1){for(let fe=0;fe<we.length;fe++)oa(we[fe],H,G,ne,fe===0)}function Mi(we,H,G,ne){let{id:fe,type:he,geometry:ve,tags:Me}=we,xe=[];if(he===1)(function(Ce,et,We,St,Ht){for(let Vt=0;Vt<Ce.length;Vt+=2){let Rt=Math.round(i.al*(Ce[Vt+0]*et-We)),sn=Math.round(i.al*(Ce[Vt+1]*et-St));Ht.push([Rt,sn])}})(ve,H,G,ne,xe);else for(let Ce of ve)Bs(Ce,H,G,ne,xe);return{id:fe,type:he,geometry:xe,tags:Me}}function Bs(we,H,G,ne,fe){let he=-ji,ve=i.al+ji,Me;for(let xe=0;xe<we.length-2;xe+=2){let Ce=Math.round(i.al*(we[xe+0]*H-G)),et=Math.round(i.al*(we[xe+1]*H-ne)),We=Math.round(i.al*(we[xe+2]*H-G)),St=Math.round(i.al*(we[xe+3]*H-ne)),Ht=We-Ce,Vt=St-et;Ce<he&&We<he||(Ce<he?(et+=Math.round(Vt*((he-Ce)/Ht)),Ce=he):We<he&&(St=et+Math.round(Vt*((he-Ce)/Ht)),We=he),et<he&&St<he||(et<he?(Ce+=Math.round(Ht*((he-et)/Vt)),et=he):St<he&&(We=Ce+Math.round(Ht*((he-et)/Vt)),St=he),Ce>=ve&&We>=ve||(Ce>=ve?(et+=Math.round(Vt*((ve-Ce)/Ht)),Ce=ve):We>=ve&&(St=et+Math.round(Vt*((ve-Ce)/Ht)),We=ve),et>=ve&&St>=ve||(et>=ve?(Ce+=Math.round(Ht*((ve-et)/Vt)),et=ve):St>=ve&&(We=Ce+Math.round(Ht*((ve-et)/Vt)),St=ve),Me&&Ce===Me[Me.length-1][0]&&et===Me[Me.length-1][1]||(Me=[[Ce,et]],fe.push(Me)),Me.push([We,St])))))}}function fd({name:we,features:H},G){G.writeStringField(1,we),G.writeVarintField(5,i.al);let ne=new Map,fe=new Map,he={keys:ne,values:fe,feature:null};for(let ve of H)he.feature=ve,G.writeMessage(2,af,he);for(let ve of ne.keys())G.writeStringField(3,ve);for(let ve of fe.keys())G.writeMessage(4,Or,ve)}function af(we,H){let G=we.feature;G.id!==void 0&&Number.isSafeInteger(+G.id)&&H.writeVarintField(1,+G.id),G.tags&&H.writeMessage(2,pd,we),H.writeVarintField(3,G.type),H.writeMessage(4,sr,G)}function pd({keys:we,values:H,feature:G},ne){for(let fe of Object.keys(G.tags)){let he=G.tags[fe];if(he===null)continue;let ve=we.get(fe);ve===void 0&&(ve=we.size,we.set(fe,ve)),ne.writeVarint(ve);let Me=typeof he;Me!=="string"&&Me!=="boolean"&&Me!=="number"&&(he=JSON.stringify(he));let xe=H.get(he);xe===void 0&&(xe=H.size,H.set(he,xe)),ne.writeVarint(xe)}}function sa(we,H){return(H<<3)+(7&we)}function li(we){return we<<1^we>>31}function sr(we,H){let{geometry:G,type:ne}=we,fe=0,he=0;if(ne===1){H.writeVarint(sa(1,G.length));for(let ve of G){let Me=ve[0]-fe,xe=ve[1]-he;H.writeVarint(li(Me)),H.writeVarint(li(xe)),fe+=Me,he+=xe}}else for(let ve of G){H.writeVarint(sa(1,1));let Me=ve.length-(ne===3?1:0);for(let xe=0;xe<Me;xe++){xe===1&&H.writeVarint(sa(2,Me-1));let Ce=ve[xe][0]-fe,et=ve[xe][1]-he;H.writeVarint(li(Ce)),H.writeVarint(li(et)),fe+=Ce,he+=et}ne===3&&H.writeVarint(sa(7,1))}}function Or(we,H){let G=typeof we;G==="string"?H.writeStringField(1,we):G==="boolean"?H.writeBooleanField(7,we):G==="number"&&(we%1!=0?H.writeDoubleField(3,we):we<0?H.writeSVarintField(6,we):H.writeVarintField(5,we))}let Hc={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:we=>we},ki=Math.fround||(al=new Float32Array(1),we=>(al[0]=+we,al[0]));var al;let Go=3,Vs=5,aa=6;class tr{constructor(H){this.options=Object.assign(Object.create(Hc),H),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(H){let{log:G,minZoom:ne,maxZoom:fe}=this.options;G&&console.time("total time");let he=`prepare ${H.length} points`;G&&console.time(he),this.points=H;let ve=[];for(let xe=0;xe<H.length;xe++){let Ce=H[xe];if(!Ce.geometry)continue;let[et,We]=Ce.geometry.coordinates,St=ki(Po(et)),Ht=ki(ll(We));ve.push(St,Ht,1/0,xe,-1,1),this.options.reduce&&ve.push(0)}let Me=this.trees[fe+1]=this._createTree(ve);G&&console.timeEnd(he);for(let xe=fe;xe>=ne;xe--){let Ce=+Date.now();Me=this.trees[xe]=this._createTree(this._cluster(Me,xe)),G&&console.log("z%d: %d clusters in %dms",xe,Me.numItems,+Date.now()-Ce)}return G&&console.timeEnd("total time"),this}getClusters(H,G){let ne=((H[0]+180)%360+360)%360-180,fe=Math.max(-90,Math.min(90,H[1])),he=H[2]===180?180:((H[2]+180)%360+360)%360-180,ve=Math.max(-90,Math.min(90,H[3]));if(H[2]-H[0]>=360)ne=-180,he=180;else if(ne>he){let We=this.getClusters([ne,fe,180,ve],G),St=this.getClusters([-180,fe,he,ve],G);return We.concat(St)}let Me=this.trees[this._limitZoom(G)],xe=Me.range(Po(ne),ll(ve),Po(he),ll(fe)),Ce=Me.data,et=[];for(let We of xe){let St=this.stride*We;et.push(Ce[St+Vs]>1?md(Ce,St,this.clusterProps):this.points[Ce[St+Go]])}return et}getChildren(H){let G=this._getOriginId(H),ne=this._getOriginZoom(H),fe="No cluster with the specified id.",he=this.trees[ne];if(!he)throw new Error(fe);let ve=he.data;if(G*this.stride>=ve.length)throw new Error(fe);let Me=this.options.radius/(this.options.extent*Math.pow(2,ne-1)),xe=he.within(ve[G*this.stride],ve[G*this.stride+1],Me),Ce=[];for(let et of xe){let We=et*this.stride;ve[We+4]===H&&Ce.push(ve[We+Vs]>1?md(ve,We,this.clusterProps):this.points[ve[We+Go]])}if(Ce.length===0)throw new Error(fe);return Ce}getLeaves(H,G,ne){let fe=[];return this._appendLeaves(fe,H,G=G||10,ne=ne||0,0),fe}getTile(H,G,ne){let fe=this.trees[this._limitZoom(H)],he=Math.pow(2,H),{extent:ve,radius:Me}=this.options,xe=Me/ve,Ce=(ne-xe)/he,et=(ne+1+xe)/he,We={features:[]};return this._addTileFeatures(fe.range((G-xe)/he,Ce,(G+1+xe)/he,et),fe.data,G,ne,he,We),G===0&&this._addTileFeatures(fe.range(1-xe/he,Ce,1,et),fe.data,he,ne,he,We),G===he-1&&this._addTileFeatures(fe.range(0,Ce,xe/he,et),fe.data,-1,ne,he,We),We.features.length?We:null}getClusterExpansionZoom(H){let G=this._getOriginZoom(H)-1;for(;G<=this.options.maxZoom;){let ne=this.getChildren(H);if(G++,ne.length!==1)break;H=ne[0].properties.cluster_id}return G}_appendLeaves(H,G,ne,fe,he){let ve=this.getChildren(G);for(let Me of ve){let xe=Me.properties;if(xe&&xe.cluster?he+xe.point_count<=fe?he+=xe.point_count:he=this._appendLeaves(H,xe.cluster_id,ne,fe,he):he<fe?he++:H.push(Me),H.length===ne)break}return he}_createTree(H){let G=new i.c3(H.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ne=0;ne<H.length;ne+=this.stride)G.add(H[ne],H[ne+1]);return G.finish(),G.data=H,G}_addTileFeatures(H,G,ne,fe,he,ve){for(let Me of H){let xe=Me*this.stride,Ce=G[xe+Vs]>1,et,We,St;if(Ce)et=Gl(G,xe,this.clusterProps),We=G[xe],St=G[xe+1];else{let Rt=this.points[G[xe+Go]];et=Rt.properties;let[sn,dn]=Rt.geometry.coordinates;We=Po(sn),St=ll(dn)}let Ht={type:1,geometry:[[Math.round(this.options.extent*(We*he-ne)),Math.round(this.options.extent*(St*he-fe))]],tags:et},Vt;Vt=Ce||this.options.generateId?G[xe+Go]:this.points[G[xe+Go]].id,Vt!==void 0&&(Ht.id=Vt),ve.features.push(Ht)}}_limitZoom(H){return Math.max(this.options.minZoom,Math.min(Math.floor(+H),this.options.maxZoom+1))}_cluster(H,G){let{radius:ne,extent:fe,reduce:he,minPoints:ve}=this.options,Me=ne/(fe*Math.pow(2,G)),xe=H.data,Ce=[],et=this.stride;for(let We=0;We<xe.length;We+=et){if(xe[We+2]<=G)continue;xe[We+2]=G;let St=xe[We],Ht=xe[We+1],Vt=H.within(xe[We],xe[We+1],Me),Rt=xe[We+Vs],sn=Rt;for(let dn of Vt){let Wn=dn*et;xe[Wn+2]>G&&(sn+=xe[Wn+Vs])}if(sn>Rt&&sn>=ve){let dn,Wn=St*Rt,Ni=Ht*Rt,ar=-1,Zi=(We/et<<5)+(G+1)+this.points.length;for(let Hi of Vt){let Hn=Hi*et;if(xe[Hn+2]<=G)continue;xe[Hn+2]=G;let _n=xe[Hn+Vs];Wn+=xe[Hn]*_n,Ni+=xe[Hn+1]*_n,xe[Hn+4]=Zi,he&&(dn||(dn=this._map(xe,We,!0),ar=this.clusterProps.length,this.clusterProps.push(dn)),he(dn,this._map(xe,Hn)))}xe[We+4]=Zi,Ce.push(Wn/sn,Ni/sn,1/0,Zi,-1,sn),he&&Ce.push(ar)}else{for(let dn=0;dn<et;dn++)Ce.push(xe[We+dn]);if(sn>1)for(let dn of Vt){let Wn=dn*et;if(!(xe[Wn+2]<=G)){xe[Wn+2]=G;for(let Ni=0;Ni<et;Ni++)Ce.push(xe[Wn+Ni])}}}}return Ce}_getOriginId(H){return H-this.points.length>>5}_getOriginZoom(H){return(H-this.points.length)%32}_map(H,G,ne){if(H[G+Vs]>1){let ve=this.clusterProps[H[G+aa]];return ne?Object.assign({},ve):ve}let fe=this.points[H[G+Go]].properties,he=this.options.map(fe);return ne&&he===fe?Object.assign({},he):he}}function md(we,H,G){return{type:"Feature",id:we[H+Go],properties:Gl(we,H,G),geometry:{type:"Point",coordinates:[(ne=we[H],360*(ne-.5)),gd(we[H+1])]}};var ne}function Gl(we,H,G){let ne=we[H+Vs],fe=ne>=1e4?`${Math.round(ne/1e3)}k`:ne>=1e3?Math.round(ne/100)/10+"k":ne,he=we[H+aa],ve=he===-1?{}:Object.assign({},G[he]);return Object.assign(ve,{cluster:!0,cluster_id:we[H+Go],point_count:ne,point_count_abbreviated:fe})}function Po(we){return we/360+.5}function ll(we){let H=Math.sin(we*Math.PI/180),G=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return G<0?0:G>1?1:G}function gd(we){let H=(180-360*we)*Math.PI/180;return 360*Math.atan(Math.exp(H))/Math.PI-90}function co(we,H,G,ne){let fe=ne,he=H+(G-H>>1),ve,Me=G-H,xe=we[H],Ce=we[H+1],et=we[G],We=we[G+1];for(let St=H+3;St<G;St+=3){let Ht=cl(we[St],we[St+1],xe,Ce,et,We);if(Ht>fe)ve=St,fe=Ht;else if(Ht===fe){let Vt=Math.abs(St-he);Vt<Me&&(ve=St,Me=Vt)}}fe>ne&&(ve-H>3&&co(we,H,ve,ne),we[ve+2]=fe,G-ve>3&&co(we,ve,G,ne))}function cl(we,H,G,ne,fe,he){let ve=fe-G,Me=he-ne;if(ve!==0||Me!==0){let xe=((we-G)*ve+(H-ne)*Me)/(ve*ve+Me*Me);xe>1?(G=fe,ne=he):xe>0&&(G+=ve*xe,ne+=Me*xe)}return ve=we-G,Me=H-ne,ve*ve+Me*Me}function la(we,H,G,ne){let fe={id:we??null,type:H,geometry:G,tags:ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(H==="Point"||H==="MultiPoint"||H==="LineString")Da(fe,G);else if(H==="Polygon")Da(fe,G[0]);else if(H==="MultiLineString")for(let he of G)Da(fe,he);else if(H==="MultiPolygon")for(let he of G)Da(fe,he[0]);return fe}function Da(we,H){for(let G=0;G<H.length;G+=3)we.minX=Math.min(we.minX,H[G]),we.minY=Math.min(we.minY,H[G+1]),we.maxX=Math.max(we.maxX,H[G]),we.maxY=Math.max(we.maxY,H[G+1])}function ql(we,H,G,ne){if(!H.geometry)return;let fe=H.geometry.coordinates;if(fe&&fe.length===0)return;let he=H.geometry.type,ve=Math.pow(G.tolerance/((1<<G.maxZoom)*G.extent),2),Me=[],xe=H.id;if(G.promoteId?xe=H.properties[G.promoteId]:G.generateId&&(xe=ne||0),he==="Point")bo(fe,Me);else if(he==="MultiPoint")for(let Ce of fe)bo(Ce,Me);else if(he==="LineString")Wl(fe,Me,ve,!1);else if(he==="MultiLineString"){if(G.lineMetrics){for(let Ce of fe)Me=[],Wl(Ce,Me,ve,!1),we.push(la(xe,"LineString",Me,H.properties));return}ca(fe,Me,ve,!1)}else if(he==="Polygon")ca(fe,Me,ve,!0);else{if(he!=="MultiPolygon"){if(he==="GeometryCollection"){for(let Ce of H.geometry.geometries)ql(we,{id:xe,geometry:Ce,properties:H.properties},G,ne);return}throw new Error("Input data is not a valid GeoJSON object.")}for(let Ce of fe){let et=[];ca(Ce,et,ve,!0),Me.push(et)}}we.push(la(xe,he,Me,H.properties))}function bo(we,H){H.push($c(we[0]),Gc(we[1]),0)}function Wl(we,H,G,ne){let fe,he,ve=0;for(let xe=0;xe<we.length;xe++){let Ce=$c(we[xe][0]),et=Gc(we[xe][1]);H.push(Ce,et,0),xe>0&&(ve+=ne?(fe*et-Ce*he)/2:Math.sqrt(Math.pow(Ce-fe,2)+Math.pow(et-he,2))),fe=Ce,he=et}let Me=H.length-3;H[2]=1,co(H,0,Me,G),H[Me+2]=1,H.size=Math.abs(ve),H.start=0,H.end=H.size}function ca(we,H,G,ne){for(let fe=0;fe<we.length;fe++){let he=[];Wl(we[fe],he,G,ne),H.push(he)}}function $c(we){return we/360+.5}function Gc(we){let H=Math.sin(we*Math.PI/180),G=.5-.25*Math.log((1+H)/(1-H))/Math.PI;return G<0?0:G>1?1:G}function dr(we,H,G,ne,fe,he,ve,Me){if(ne/=H,he>=(G/=H)&&ve<ne)return we;if(ve<G||he>=ne)return null;let xe=[];for(let Ce of we){let et=Ce.geometry,We=Ce.type,St=fe===0?Ce.minX:Ce.minY,Ht=fe===0?Ce.maxX:Ce.maxY;if(St>=G&&Ht<ne){xe.push(Ce);continue}if(Ht<G||St>=ne)continue;let Vt=[];if(We==="Point"||We==="MultiPoint")Zl(et,Vt,G,ne,fe);else if(We==="LineString")qc(et,Vt,G,ne,fe,!1,Me.lineMetrics);else if(We==="MultiLineString")js(et,Vt,G,ne,fe,!1);else if(We==="Polygon")js(et,Vt,G,ne,fe,!0);else if(We==="MultiPolygon")for(let Rt of et){let sn=[];js(Rt,sn,G,ne,fe,!0),sn.length&&Vt.push(sn)}if(Vt.length){if(Me.lineMetrics&&We==="LineString"){for(let Rt of Vt)xe.push(la(Ce.id,We,Rt,Ce.tags));continue}We!=="LineString"&&We!=="MultiLineString"||(Vt.length===1?(We="LineString",Vt=Vt[0]):We="MultiLineString"),We!=="Point"&&We!=="MultiPoint"||(We=Vt.length===3?"Point":"MultiPoint"),xe.push(la(Ce.id,We,Vt,Ce.tags))}}return xe.length?xe:null}function Zl(we,H,G,ne,fe){for(let he=0;he<we.length;he+=3){let ve=we[he+fe];ve>=G&&ve<=ne&&gs(H,we[he],we[he+1],we[he+2])}}function qc(we,H,G,ne,fe,he,ve){let Me=Ca(we),xe=fe===0?Ri:Wr,Ce,et,We=we.start;for(let sn=0;sn<we.length-3;sn+=3){let dn=we[sn],Wn=we[sn+1],Ni=we[sn+2],ar=we[sn+3],Zi=we[sn+4],Hi=fe===0?dn:Wn,Hn=fe===0?ar:Zi,_n=!1;ve&&(Ce=Math.sqrt(Math.pow(dn-ar,2)+Math.pow(Wn-Zi,2))),Hi<G?Hn>G&&(et=xe(Me,dn,Wn,ar,Zi,G),ve&&(Me.start=We+Ce*et)):Hi>ne?Hn<ne&&(et=xe(Me,dn,Wn,ar,Zi,ne),ve&&(Me.start=We+Ce*et)):gs(Me,dn,Wn,Ni),Hn<G&&Hi>=G&&(et=xe(Me,dn,Wn,ar,Zi,G),_n=!0),Hn>ne&&Hi<=ne&&(et=xe(Me,dn,Wn,ar,Zi,ne),_n=!0),!he&&_n&&(ve&&(Me.end=We+Ce*et),H.push(Me),Me=Ca(we)),ve&&(We+=Ce)}let St=we.length-3,Ht=we[St],Vt=we[St+1],Rt=fe===0?Ht:Vt;Rt>=G&&Rt<=ne&&gs(Me,Ht,Vt,we[St+2]),St=Me.length-3,he&&St>=3&&(Me[St]!==Me[0]||Me[St+1]!==Me[1])&&gs(Me,Me[0],Me[1],Me[2]),Me.length&&H.push(Me)}function Ca(we){let H=[];return H.size=we.size,H.start=we.start,H.end=we.end,H}function js(we,H,G,ne,fe,he){for(let ve of we)qc(ve,H,G,ne,fe,he,!1)}function gs(we,H,G,ne){we.push(H,G,ne)}function Ri(we,H,G,ne,fe,he){let ve=(he-H)/(ne-H);return gs(we,he,G+(fe-G)*ve,1),ve}function Wr(we,H,G,ne,fe,he){let ve=(he-G)/(fe-G);return gs(we,H+(ne-H)*ve,he,1),ve}function Xl(we,H){let G=[];for(let ne=0;ne<we.length;ne++){let fe=we[ne],he=fe.type,ve;if(he==="Point"||he==="MultiPoint"||he==="LineString")ve=ul(fe.geometry,H);else if(he==="MultiLineString"||he==="Polygon"){ve=[];for(let Me of fe.geometry)ve.push(ul(Me,H))}else if(he==="MultiPolygon"){ve=[];for(let Me of fe.geometry){let xe=[];for(let Ce of Me)xe.push(ul(Ce,H));ve.push(xe)}}G.push(la(fe.id,he,ve,fe.tags))}return G}function ul(we,H){let G=[];G.size=we.size,we.start!==void 0&&(G.start=we.start,G.end=we.end);for(let ne=0;ne<we.length;ne+=3)G.push(we[ne]+H,we[ne+1],we[ne+2]);return G}function qo(we,H){if(we.transformed)return we;let G=1<<we.z,ne=we.x,fe=we.y;for(let he of we.features){let ve=he.geometry,Me=he.type;if(he.geometry=[],Me===1)for(let xe=0;xe<ve.length;xe+=2)he.geometry.push(lf(ve[xe],ve[xe+1],H,G,ne,fe));else for(let xe=0;xe<ve.length;xe++){let Ce=[];for(let et=0;et<ve[xe].length;et+=2)Ce.push(lf(ve[xe][et],ve[xe][et+1],H,G,ne,fe));he.geometry.push(Ce)}}return we.transformed=!0,we}function lf(we,H,G,ne,fe,he){return[Math.round(G*(we*ne-fe)),Math.round(G*(H*ne-he))]}function _d(we,H,G,ne,fe){let he=H===fe.maxZoom?0:fe.tolerance/((1<<H)*fe.extent),ve={features:[],numPoints:0,numSimplified:0,numFeatures:we.length,source:null,x:G,y:ne,z:H,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let Me of we)$m(ve,Me,he,fe);return ve}function $m(we,H,G,ne){let fe=H.geometry,he=H.type,ve=[];if(we.minX=Math.min(we.minX,H.minX),we.minY=Math.min(we.minY,H.minY),we.maxX=Math.max(we.maxX,H.maxX),we.maxY=Math.max(we.maxY,H.maxY),he==="Point"||he==="MultiPoint")for(let Me=0;Me<fe.length;Me+=3)ve.push(fe[Me],fe[Me+1]),we.numPoints++,we.numSimplified++;else if(he==="LineString")Wc(ve,fe,we,G,!1,!1);else if(he==="MultiLineString"||he==="Polygon")for(let Me=0;Me<fe.length;Me++)Wc(ve,fe[Me],we,G,he==="Polygon",Me===0);else if(he==="MultiPolygon")for(let Me=0;Me<fe.length;Me++){let xe=fe[Me];for(let Ce=0;Ce<xe.length;Ce++)Wc(ve,xe[Ce],we,G,!0,Ce===0)}if(ve.length){let Me=H.tags||null;if(he==="LineString"&&ne.lineMetrics){Me={};for(let Ce in H.tags)Me[Ce]=H.tags[Ce];Me.mapbox_clip_start=fe.start/fe.size,Me.mapbox_clip_end=fe.end/fe.size}let xe={geometry:ve,type:he==="Polygon"||he==="MultiPolygon"?3:he==="LineString"||he==="MultiLineString"?2:1,tags:Me};H.id!==null&&(xe.id=H.id),we.features.push(xe)}}function Wc(we,H,G,ne,fe,he){let ve=ne*ne;if(ne>0&&H.size<(fe?ve:ne))return void(G.numPoints+=H.length/3);let Me=[];for(let xe=0;xe<H.length;xe+=3)(ne===0||H[xe+2]>ve)&&(G.numSimplified++,Me.push(H[xe],H[xe+1])),G.numPoints++;fe&&(function(xe,Ce){let et=0;for(let We=0,St=xe.length,Ht=St-2;We<St;Ht=We,We+=2)et+=(xe[We]-xe[Ht])*(xe[We+1]+xe[Ht+1]);if(et>0===Ce)for(let We=0,St=xe.length;We<St/2;We+=2){let Ht=xe[We],Vt=xe[We+1];xe[We]=xe[St-2-We],xe[We+1]=xe[St-1-We],xe[St-2-We]=Ht,xe[St-1-We]=Vt}})(Me,he),we.push(Me)}let Ze={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Aa{constructor(H,G){let ne=(G=this.options=(function(he,ve){for(let Me in ve)he[Me]=ve[Me];return he})(Object.create(Ze),G)).debug;if(ne&&console.time("preprocess data"),G.maxZoom<0||G.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(G.promoteId&&G.generateId)throw new Error("promoteId and generateId cannot be used together.");let fe=(function(he,ve){let Me=[];if(he.type==="FeatureCollection")for(let xe=0;xe<he.features.length;xe++)ql(Me,he.features[xe],ve,xe);else ql(Me,he.type==="Feature"?he:{geometry:he},ve);return Me})(H,G);this.tiles={},this.tileCoords=[],ne&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",G.indexMaxZoom,G.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),fe=(function(he,ve){let Me=ve.buffer/ve.extent,xe=he,Ce=dr(he,1,-1-Me,Me,0,-1,2,ve),et=dr(he,1,1-Me,2+Me,0,-1,2,ve);return(Ce||et)&&(xe=dr(he,1,-Me,1+Me,0,-1,2,ve)||[],Ce&&(xe=Xl(Ce,1).concat(xe)),et&&(xe=xe.concat(Xl(et,-1)))),xe})(fe,G),fe.length&&this.splitTile(fe,0,0,0),ne&&(fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(H,G,ne,fe,he,ve,Me){let xe=[H,G,ne,fe],Ce=this.options,et=Ce.debug;for(;xe.length;){fe=xe.pop(),ne=xe.pop(),G=xe.pop(),H=xe.pop();let We=1<<G,St=yd(G,ne,fe),Ht=this.tiles[St];if(!Ht&&(et>1&&console.time("creation"),Ht=this.tiles[St]=_d(H,G,ne,fe,Ce),this.tileCoords.push({z:G,x:ne,y:fe}),et)){et>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",G,ne,fe,Ht.numFeatures,Ht.numPoints,Ht.numSimplified),console.timeEnd("creation"));let _n=`z${G}`;this.stats[_n]=(this.stats[_n]||0)+1,this.total++}if(Ht.source=H,he==null){if(G===Ce.indexMaxZoom||Ht.numPoints<=Ce.indexMaxPoints)continue}else{if(G===Ce.maxZoom||G===he)continue;if(he!=null){let _n=he-G;if(ne!==ve>>_n||fe!==Me>>_n)continue}}if(Ht.source=null,H.length===0)continue;et>1&&console.time("clipping");let Vt=.5*Ce.buffer/Ce.extent,Rt=.5-Vt,sn=.5+Vt,dn=1+Vt,Wn=null,Ni=null,ar=null,Zi=null,Hi=dr(H,We,ne-Vt,ne+sn,0,Ht.minX,Ht.maxX,Ce),Hn=dr(H,We,ne+Rt,ne+dn,0,Ht.minX,Ht.maxX,Ce);H=null,Hi&&(Wn=dr(Hi,We,fe-Vt,fe+sn,1,Ht.minY,Ht.maxY,Ce),Ni=dr(Hi,We,fe+Rt,fe+dn,1,Ht.minY,Ht.maxY,Ce),Hi=null),Hn&&(ar=dr(Hn,We,fe-Vt,fe+sn,1,Ht.minY,Ht.maxY,Ce),Zi=dr(Hn,We,fe+Rt,fe+dn,1,Ht.minY,Ht.maxY,Ce),Hn=null),et>1&&console.timeEnd("clipping"),xe.push(Wn||[],G+1,2*ne,2*fe),xe.push(Ni||[],G+1,2*ne,2*fe+1),xe.push(ar||[],G+1,2*ne+1,2*fe),xe.push(Zi||[],G+1,2*ne+1,2*fe+1)}}getTile(H,G,ne){H=+H,G=+G,ne=+ne;let fe=this.options,{extent:he,debug:ve}=fe;if(H<0||H>24)return null;let Me=1<<H,xe=yd(H,G=G+Me&Me-1,ne);if(this.tiles[xe])return qo(this.tiles[xe],he);ve>1&&console.log("drilling down to z%d-%d-%d",H,G,ne);let Ce,et=H,We=G,St=ne;for(;!Ce&&et>0;)et--,We>>=1,St>>=1,Ce=this.tiles[yd(et,We,St)];return Ce&&Ce.source?(ve>1&&(console.log("found parent tile z%d-%d-%d",et,We,St),console.time("drilling down")),this.splitTile(Ce.source,et,We,St,H,G,ne),ve>1&&console.timeEnd("drilling down"),this.tiles[xe]?qo(this.tiles[xe],he):null):null}}function yd(we,H,G){return 32*((1<<we)*G+H)+we}function vd(we,H){let G=we.tileID.canonical;if(!this._geoJSONIndex)return void H(null,null);let ne=this._geoJSONIndex.getTile(G.z,G.x,G.y);if(!ne)return void H(null,null);let fe=Ce=>Ce.tags&&"3d_elevation_id"in Ce.tags&&"source"in Ce.tags&&Ce.tags.source==="elevation",he=ne.features.filter(Ce=>fe(Ce)),ve={_geojsonTileLayer:ne.features};he.length>0&&(ve={_geojsonTileLayer:ne.features.filter(Ce=>!fe(Ce)),hd_road_elevation:he});let Me=new sf(ve),xe=(function(Ce){let et=new i.bs;for(let We of Object.keys(Ce))et.writeMessage(3,fd,{name:We,features:Ce[We]});return et.finish()})(ve).buffer;H(null,{vectorTile:Me,rawData:xe})}class gn extends jr{constructor(H,G,ne,fe,he,ve,Me){super(H,G,ne,fe,he,vd,Me),ve&&(this.loadGeoJSON=ve),this._dynamicIndex=new bi}loadData(H,G){let ne=H&&H.request,fe=ne&&ne.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(H,(he,ve)=>{if(he||!ve)return G(he);if(typeof ve!="object")return G(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`));{try{if(H.filter){let xe=i.U(H.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(xe.result==="error")throw new Error(xe.value.map(Ce=>`${Ce.key}: ${Ce.message}`).join(", "));ve.features=ve.features.filter(Ce=>xe.value.evaluate({zoom:0},Ce))}H.dynamic?(ve.type==="Feature"&&(ve={type:"FeatureCollection",features:[ve]}),H.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(ve.features,this.loaded),H.cluster&&(ve.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=H.cluster?new tr((function({superclusterOptions:xe,clusterProperties:Ce}){if(!Ce||!xe)return xe;let et={},We={},St={accumulated:null,zoom:0},Ht={properties:null},Vt=Object.keys(Ce);for(let Rt of Vt){let[sn,dn]=Ce[Rt],Wn=i.U(dn),Ni=i.U(typeof sn=="string"?[sn,["accumulated"],["get",Rt]]:sn);et[Rt]=Wn.value,We[Rt]=Ni.value}return xe.map=Rt=>{Ht.properties=Rt;let sn={};for(let dn of Vt)sn[dn]=et[dn].evaluate(St,Ht);return sn},xe.reduce=(Rt,sn)=>{Ht.properties=sn;for(let dn of Vt)St.accumulated=Rt[dn],Rt[dn]=We[dn].evaluate(St,Ht)},xe})(H)).load(ve.features):H.dynamic?this._dynamicIndex:(function(xe,Ce){return new Aa(xe,Ce)})(ve,H.geojsonVtOptions)}catch(xe){return G(xe)}let Me={};if(fe){let xe=C(ne);xe&&(Me.resourceTiming={},Me.resourceTiming[H.source]=JSON.parse(JSON.stringify(xe)))}G(null,Me)}})}reloadTile(H,G){let ne=this.loaded;return ne&&ne[H.uid]?H.partial?G(null,void 0):super.reloadTile(H,G):this.loadTile(H,G)}loadGeoJSON(H,G){if(H.request)i.m(H.request,G);else{if(typeof H.data!="string")return G(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`));setTimeout(()=>{try{return G(null,JSON.parse(H.data))}catch{return G(new Error(`Input data given to '${H.source}' is not a valid GeoJSON object.`))}},0)}}getClusterExpansionZoom(H,G){try{G(null,this._geoJSONIndex.getClusterExpansionZoom(H.clusterId))}catch(ne){G(ne)}}getClusterChildren(H,G){try{G(null,this._geoJSONIndex.getChildren(H.clusterId))}catch(ne){G(ne)}}getClusterLeaves(H,G){try{G(null,this._geoJSONIndex.getLeaves(H.clusterId,H.limit,H.offset))}catch(ne){G(ne)}}}class eo{constructor(H,G,ne){this.tileID=new i.aP(H.tileID.overscaledZ,H.tileID.wrap,H.tileID.canonical.z,H.tileID.canonical.x,H.tileID.canonical.y),this.tileZoom=H.tileZoom,this.uid=H.uid,this.zoom=H.zoom,this.canonical=H.tileID.canonical,this.pixelRatio=H.pixelRatio,this.tileSize=H.tileSize,this.source=H.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=H.projection,this.brightness=G,this.worldview=ne}parse(H,G,ne,fe){this.status="parsing";let he=new i.aP(ne.tileID.overscaledZ,ne.tileID.wrap,ne.tileID.canonical.z,ne.tileID.canonical.x,ne.tileID.canonical.y),ve=[],Me=G.familiesBySource[ne.source],xe=new i.fm(he,ne.promoteId);xe.bucketLayerIDs=[],xe.is3DTile=!0,i.fB(H).then(Ce=>{if(!Ce)return fe(new Error("Could not parse tile"));let et=Ce.json.extensionsUsed&&Ce.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ce.json.asset.extras&&Ce.json.asset.extras.MAPBOX_mesh_features,We=Ce.json.extensionsUsed&&Ce.json.extensionsUsed.includes("EXT_meshopt_compression"),St=new i.ac(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(let Ht in Me)for(let Vt of Me[Ht]){let Rt=Vt[0];xe.bucketLayerIDs.push(Vt.map(Wn=>i.B(Wn.id,Wn.scope))),Rt.recalculate(St,[]);let sn=i.fC(Ce,1/i.d6(ne.tileID.canonical)),dn=new i.fD(Vt,sn,he,et,We,this.brightness,xe,this.worldview);et||(dn.needsUpload=!0),ve.push(dn),dn.evaluate(Rt)}this.status="done",fe(null,{buckets:ve,featureIndex:xe,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ce=>fe(new Error(Ce.message)))}}class Gm{constructor(H,G,ne,fe,he,ve,Me,xe){this.actor=H,this.layerIndex=G,this.availableImages=ne,this.availableModels=fe,this.brightness=Me,this.loading={},this.loaded={},this.worldview=xe}loadTile(H,G){let ne=H.uid,fe=this.loading[ne]=new eo(H,this.brightness,this.worldview);i.bt(H.request,(he,ve)=>{let Me=!this.loading[ne];return delete this.loading[ne],Me||he?(fe.status="done",Me||(this.loaded[ne]=fe),G(he)):ve&&ve.byteLength!==0?void fe.parse(ve,this.layerIndex,H,(xe,Ce)=>{fe.status="done",this.loaded=this.loaded||{},this.loaded[ne]=fe,xe||!Ce?G(xe):G(null,Ce)}):(fe.status="done",this.loaded[ne]=fe,G())})}reloadTile(H,G){let ne=this.loaded,fe=H.uid;if(ne&&ne[fe]){let he=ne[fe];he.projection=H.projection,he.brightness=H.brightness;let ve=(Me,xe)=>{he.reloadCallback&&(delete he.reloadCallback,this.loadTile(H,G)),G(Me,xe)};he.status==="parsing"?he.reloadCallback=ve:he.status==="done"&&this.loadTile(H,G)}}abortTile(H,G){let ne=H.uid;this.loading[ne]&&delete this.loading[ne],G()}removeTile(H,G){let ne=this.loaded,fe=H.uid;ne&&ne[fe]&&delete ne[fe],G()}}class xd{constructor(H){this.self=H,this.actor=new i.fF(H,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new i.x,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=i.cl({name:"mercator"}),this.workerSourceTypes={vector:jr,geojson:gn,"raster-dem":lo,"raster-array":ud,"batched-model":Gm},this.workerSources={},this.self.registerWorkerSource=(G,ne)=>{if(this.workerSourceTypes[G])throw new Error(`Worker source with name "${G}" already registered.`);this.workerSourceTypes[G]=ne},this.self.registerRTLTextPlugin=G=>{if(i.fG.isParsed())throw new Error("RTL text plugin already registered.");i.fG.setState({pluginStatus:i.fH.parsed,pluginURL:i.fG.getPluginURL()}),i.fG.applyArabicShaping=G.applyArabicShaping,i.fG.processBidirectionalText=G.processBidirectionalText,i.fG.processStyledBidirectionalText=G.processStyledBidirectionalText;for(let ne of this.rtlPluginParsingListeners)ne(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(H,G,ne){delete this.layerIndexes[H],delete this.availableImages[H],delete this.availableModels[H],delete this.workerSources[H],ne()}checkIfReady(H,G,ne){ne()}setReferrer(H,G){this.referrer=G}spriteLoaded(H,G){this.isSpriteLoaded[H]||(this.isSpriteLoaded[H]={});let{scope:ne,isLoaded:fe}=G;if(this.isSpriteLoaded[H][ne]=fe,this.workerSources[H]&&this.workerSources[H][ne])for(let he in this.workerSources[H][ne]){let ve=this.workerSources[H][ne][he];for(let Me in ve){let xe=ve[Me];xe instanceof jr&&(xe.isSpriteLoaded=fe,xe.fire(new i.z("isSpriteLoaded")))}}}setImages(H,G,ne){this.availableImages[H]||(this.availableImages[H]={});let{scope:fe,images:he}=G;if(this.availableImages[H][fe]=he,this.workerSources[H]&&this.workerSources[H][fe]){for(let ve in this.workerSources[H][fe]){let Me=this.workerSources[H][fe][ve];for(let xe in Me)Me[xe].availableImages=he}ne()}else ne()}setModels(H,{scope:G,models:ne},fe){if(this.availableModels[H]||(this.availableModels[H]={}),this.availableModels[H][G]=ne,this.workerSources[H]&&this.workerSources[H][G]){for(let he in this.workerSources[H][G]){let ve=this.workerSources[H][G][he];for(let Me in ve)ve[Me].availableModels=ne}fe()}else fe()}setProjection(H,G){this.projections[H]=i.cl(G)}setBrightness(H,G,ne){this.brightness=G,ne()}setWorldview(H,G,ne){this.worldview=G,ne()}setLayers(H,G,ne){this.getLayerIndex(H,G.scope).replace(G.layers,G.options),ne()}updateLayers(H,G,ne){this.getLayerIndex(H,G.scope).update(G.layers,G.removedIds,G.options),ne()}loadTile(H,G,ne){G.projection=this.projections[H]||this.defaultProjection,this.getWorkerSource(H,G.type,G.source,G.scope).loadTile(G,ne)}decodeRasterArray(H,G,ne){this.getWorkerSource(H,G.type,G.source,G.scope).decodeRasterArray(G,ne)}reloadTile(H,G,ne){G.projection=this.projections[H]||this.defaultProjection,this.getWorkerSource(H,G.type,G.source,G.scope).reloadTile(G,ne)}abortTile(H,G,ne){this.getWorkerSource(H,G.type,G.source,G.scope).abortTile(G,ne)}removeTile(H,G,ne){this.getWorkerSource(H,G.type,G.source,G.scope).removeTile(G,ne)}removeSource(H,G,ne){if(!(this.workerSources[H]&&this.workerSources[H][G.scope]&&this.workerSources[H][G.scope][G.type]&&this.workerSources[H][G.scope][G.type][G.source]))return;let fe=this.workerSources[H][G.scope][G.type][G.source];delete this.workerSources[H][G.scope][G.type][G.source],fe.removeSource!==void 0?fe.removeSource(G,ne):ne()}loadWorkerSource(H,G,ne){try{this.self.importScripts(G.url),ne()}catch(fe){ne(fe.toString())}}syncRTLPluginState(H,G,ne){if(i.fG.isParsed())ne(null,!0);else if(i.fG.isParsing())this.rtlPluginParsingListeners.push(ne);else try{i.fG.setState(G);let fe=i.fG.getPluginURL();!i.fG.isLoaded()||i.fG.isParsed()||i.fG.isParsing()||fe==null||(i.fG.setState({pluginStatus:i.fH.parsing,pluginURL:i.fG.getPluginURL()}),this.self.importScripts(fe),i.fG.isParsed()?ne(null,!0):this.rtlPluginParsingListeners.push(ne))}catch(fe){ne(fe.toString())}}setDracoUrl(H,G){this.dracoUrl=G}getAvailableImages(H,G){this.availableImages[H]||(this.availableImages[H]={});let ne=this.availableImages[H][G];return ne||(ne=[]),ne}getAvailableModels(H,G){this.availableModels[H]||(this.availableModels[H]={});let ne=this.availableModels[H][G];return ne||(ne={}),ne}getLayerIndex(H,G){this.layerIndexes[H]||(this.layerIndexes[H]={});let ne=this.layerIndexes[H][G];return ne||(ne=this.layerIndexes[H][G]=new ee,ne.scope=G),ne}getWorkerSource(H,G,ne,fe){let he=this.workerSources;return he[H]||(he[H]={}),he[H][fe]||(he[H][fe]={}),he[H][fe][G]||(he[H][fe][G]={}),this.isSpriteLoaded[H]||(this.isSpriteLoaded[H]={}),he[H][fe][G][ne]||(he[H][fe][G][ne]=new this.workerSourceTypes[G]({send:(ve,Me,xe,Ce,et,We)=>this.actor.send(ve,Me,xe,H,et,We),scheduler:this.actor.scheduler},this.getLayerIndex(H,fe),this.getAvailableImages(H,fe),this.getAvailableModels(H,fe),this.isSpriteLoaded[H][fe],void 0,this.brightness,this.worldview)),he[H][fe][G][ne]}rasterizeImagesWorker(H,G,ne){let fe=new Map;for(let[he,{image:ve,imageVariant:Me}]of G.tasks.entries()){let xe=this.imageRasterizer.rasterize(Me,ve,G.scope,H);fe.set(he,xe)}ne(void 0,fe)}removeRasterizedImages(H,G,ne){this.imageRasterizer.removeImagesFromCacheByIds(G.imageIds,G.scope,H),ne()}enforceCacheSizeLimit(H,G){i.fI(G)}getWorkerPerformanceMetrics(H,G,ne){ne(void 0,void 0)}}return i.fE(self)&&(self.worker=new xd(self)),xd}),f(["./shared"],function(i){var C="3.16.0";let k={create:"create",load:"load",fullLoad:"fullLoad"},B={mark(d){performance.mark(d)},measure(d,t,o){performance.measure(d,t,o)}};function ee(d){let t=d.name.split("?")[0];return i.a(t)&&t.includes("mapbox-gl.js")?"javascript":i.a(t)&&t.includes("mapbox-gl.css")?"css":i.b(t)?"fontRange":i.c(t)?"sprite":i.i(t)?"style":i.d(t)?"tilejson":"other"}var _e,Oe={},ct=(function(){if(_e)return Oe;function d(h){return!t(h)}function t(h){return typeof window>"u"||typeof document>"u"?"not a browser":(function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var y,x,E=new Blob([""],{type:"text/javascript"}),T=URL.createObjectURL(E);try{x=new Worker(T),y=!0}catch{y=!1}return x&&x.terminate(),URL.revokeObjectURL(T),y})()?(function(){var y=document.createElement("canvas");y.width=y.height=1;var x=y.getContext("2d");if(!x)return!1;var E=x.getImageData(0,0,1,1);return E&&E.width===y.width})()?(o[g=h&&h.failIfMajorPerformanceCaveat]===void 0&&(o[g]=(function(y){var x,E=(function(T){var A=document.createElement("canvas"),M=Object.create(d.webGLContextAttributes);return M.failIfMajorPerformanceCaveat=T,A.getContext("webgl2",M)})(y);if(!E)return!1;try{x=E.createShader(E.VERTEX_SHADER)}catch{return!1}return!(!x||E.isContextLost())&&(E.shaderSource(x,"void main() {}"),E.compileShader(x),E.getShaderParameter(x,E.COMPILE_STATUS)===!0)})(g)),o[g]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var g}_e=1,Oe.supported=d,Oe.notSupportedReason=t;var o={};return d.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},Oe})();function Fe(d,t,o){let h=document.createElement(d);return t!=null&&(h.className=t),o&&o.appendChild(h),h}function yt(d,t,o){let h=document.createElementNS("http://www.w3.org/2000/svg",d);for(let g of Object.keys(t))h.setAttributeNS(null,g,String(t[g]));return o&&o.appendChild(h),h}let Xt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,At=Xt&&Xt.userSelect!==void 0?"userSelect":"WebkitUserSelect",Lt;function qn(){Xt&&At&&(Lt=Xt[At],Xt[At]="none")}function Sr(){Xt&&At&&(Xt[At]=Lt)}function Vi(d){d.preventDefault(),d.stopPropagation(),window.removeEventListener("click",Vi,!0)}function jr(){window.addEventListener("click",Vi,!0),window.setTimeout(()=>{window.removeEventListener("click",Vi,!0)},0)}function lo(d,t){let o=d.getBoundingClientRect();return dd(d,o,t)}function Sa(d,t){let o=d.getBoundingClientRect(),h=[];for(let g=0;g<t.length;g++)h.push(dd(d,o,t[g]));return h}function ud(d){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&d.button===2&&d.ctrlKey?0:d.button}function dd(d,t,o){let h=d.offsetWidth===t.width?1:d.offsetWidth/t.width;return new i.P((o.clientX-t.left)*h,(o.clientY-t.top)*h)}let hd="01",Un="NO_ACCESS_TOKEN";class sf{constructor(t,o,h){this._transformRequestFn=t,this._customAccessToken=o,this._silenceAuthErrors=!!h,this._createSkuToken()}_createSkuToken(){let t=(function(){let o="";for(let h=0;h<10;h++)o+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",hd,o].join(""),tokenExpiresAt:Date.now()+432e5}})();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,o){return this._transformRequestFn&&this._transformRequestFn(t,o)||{url:t}}normalizeStyleURL(t,o){if(!i.h(t))return t;let h=ji(t);return h.params.push(`sdk=js-${C}`),h.path=`/styles/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeGlyphsURL(t,o){if(!i.h(t))return t;let h=ji(t);return h.path=`/fonts/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeModelURL(t,o){if(!i.h(t))return t;let h=ji(t);return h.path=`/models/v1${h.path}`,this._makeAPIURL(h,this._customAccessToken||o)}normalizeSourceURL(t,o,h,g){if(!i.h(t))return t;let y=ji(t);return y.path=`/v4/${y.authority}.json`,y.params.push("secure"),h&&y.params.push(`language=${h}`),g&&y.params.push(`worldview=${g}`),this._makeAPIURL(y,this._customAccessToken||o)}normalizeIconsetURL(t,o){let h=ji(t);return i.h(t)?(h.path=`/styles/v1${h.path}/iconset.pbf`,this._makeAPIURL(h,this._customAccessToken||o)):bi(h)}normalizeSpriteURL(t,o,h,g){let y=ji(t);return i.h(t)?(y.path=`/styles/v1${y.path}/sprite${o}${h}`,this._makeAPIURL(y,this._customAccessToken||g)):(y.path+=`${o}${h}`,bi(y))}normalizeTileURL(t,o,h){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!i.h(t))return t;let g=ji(t);g.path=g.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${o||h&&g.authority!=="raster"&&h===512?"@2x":""}${i.k.supported?".webp":"$1"}`),g.authority==="raster"?g.path=`/${i.e.RASTER_URL_PREFIX}${g.path}`:g.authority==="rasterarrays"?g.path=`/${i.e.RASTERARRAYS_URL_PREFIX}${g.path}`:g.authority==="3dtiles"?g.path=`/${i.e.TILES3D_URL_PREFIX}${g.path}`:(g.path=g.path.replace(/^.+\/v4\//,"/"),g.path=`/${i.e.TILE_URL_VERSION}${g.path}`);let y=this._customAccessToken||(function(x){for(let E of x){let T=E.match(/^access_token=(.*)$/);if(T)return T[1]}return null})(g.params)||i.e.ACCESS_TOKEN;return i.e.REQUIRE_ACCESS_TOKEN&&y&&this._skuToken&&g.params.push(`sku=${this._skuToken}`),this._makeAPIURL(g,y)}canonicalizeTileURL(t,o){let h=ji(t);if(!h.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!h.path.match(/\.[\w]+$/))return t;let g="mapbox://";h.path.match(/^\/raster\/v1\//)?g+=`raster/${h.path.replace(`/${i.e.RASTER_URL_PREFIX}/`,"")}`:h.path.match(/^\/rasterarrays\/v1\//)?g+=`rasterarrays/${h.path.replace(`/${i.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:g+=`tiles/${h.path.replace(`/${i.e.TILE_URL_VERSION}/`,"")}`;let y=h.params;return o&&(y=y.filter(x=>!x.match(/^access_token=/))),y.length&&(g+=`?${y.join("&")}`),g}canonicalizeTileset(t,o){let h=!!o&&i.h(o),g=[];for(let y of t.tiles||[])i.j(y)?g.push(this.canonicalizeTileURL(y,h)):g.push(y);return g}_makeAPIURL(t,o){let h="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",g=ji(i.e.API_URL);if(t.protocol=g.protocol,t.authority=g.authority,t.protocol==="http"){let y=t.params.indexOf("secure");y>=0&&t.params.splice(y,1)}if(g.path!=="/"&&(t.path=`${g.path}${t.path}`),!i.e.REQUIRE_ACCESS_TOKEN)return bi(t);if(o=o||i.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!o)throw new Error(`An API access token is required to use Mapbox GL. ${h}`);if(o[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${h}`)}return t.params=t.params.filter(y=>y.indexOf("access_token")===-1),t.params.push(`access_token=${o||""}`),bi(t)}}let Qr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function ji(d){let t=d.match(Qr);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function bi(d){let t=d.params.length?`?${d.params.join("&")}`:"";return`${d.protocol}://${d.authority}${d.path}${t}`}let or="mapbox.eventData";function ra(d){if(!d)return null;let t=d.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(i.l(t[1]))}catch{return null}}class zs{constructor(t){this.type=t,this.anonId=null,this.anonIdTimestamp=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){let o=ra(i.e.ACCESS_TOKEN),h="";return h=o&&o.u?i.f(o.u):i.e.ACCESS_TOKEN||"",t?`${or}.${t}:${h}`:`${or}:${h}`}fetchEventData(){let t=i.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid"),g=this.getStorageKey("uuidTimestamp");if(t)try{let y=localStorage.getItem(o);y&&(this.eventData=JSON.parse(y));let x=localStorage.getItem(h);x&&(this.anonId=x);let E=localStorage.getItem(g);E&&(this.anonIdTimestamp=Number(E));let T=Date.now()-864e5;(!this.anonIdTimestamp||this.anonIdTimestamp<T)&&this.refreshUUID()}catch{i.w("Unable to read from LocalStorage")}}refreshUUID(){this.anonId=i.u(),this.anonIdTimestamp=Date.now()}saveEventData(){let t=i.s("localStorage"),o=this.getStorageKey(),h=this.getStorageKey("uuid"),g=this.getStorageKey("uuidTimestamp"),y=this.anonId,x=this.anonIdTimestamp;if(t&&y)try{localStorage.setItem(h,y),Object.keys(this.eventData).length>=1&&localStorage.setItem(o,JSON.stringify(this.eventData)),x&&localStorage.setItem(g,x.toString())}catch{i.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,o,h,g){if(!i.e.EVENTS_URL)return;let y=ji(i.e.EVENTS_URL);y.params.push(`access_token=${g||i.e.ACCESS_TOKEN||""}`);let x={event:this.type,created:new Date(t).toISOString()},E=o?Object.assign(x,o):x,T={url:bi(y),headers:{"Content-Type":"text/plain"},body:JSON.stringify([E])};this.pendingRequest=i.p(T,A=>{this.pendingRequest=null,h(A),this.saveEventData(),this.processRequests(g)})}queueRequest(t,o){this.queue.push(t),this.processRequests(o)}}let oa=new class extends zs{constructor(d){super("appUserTurnstile"),this._customAccessToken=d}postTurnstileEvent(d,t){i.e.EVENTS_URL&&i.e.ACCESS_TOKEN&&Array.isArray(d)&&d.some(o=>i.h(o)||i.j(o))&&this.queueRequest(Date.now(),t)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.anonIdTimestamp&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let t=ra(i.e.ACCESS_TOKEN),o=t?t.u:i.e.ACCESS_TOKEN,h=o!==this.eventData.tokenU;i.v(this.anonId)||(this.refreshUUID(),h=!0);let g=this.queue.shift();if(this.eventData.lastSuccess){let y=new Date(this.eventData.lastSuccess),x=new Date(g),E=(g-this.eventData.lastSuccess)/864e5;h=h||E>=1||E<-1||y.getDate()!==x.getDate()}else h=!0;h?this.postEvent(g,{sdkIdentifier:"mapbox-gl-js",sdkVersion:C,skuId:hd,"enabled.telemetry":!1,userId:this.anonId},y=>{y||(this.eventData.lastSuccess=g,this.eventData.tokenU=o)},d):this.processRequests()}},ms=oa.postTurnstileEvent.bind(oa),Mi=new class extends zs{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(d,t,o,h){this.skuToken=t,this.errorCb=h,i.e.EVENTS_URL&&(o||i.e.ACCESS_TOKEN?this.queueRequest({id:d,timestamp:Date.now()},o):this.errorCb(new Error(Un)))}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||(this.anonId&&this.anonIdTimestamp||this.fetchEventData(),i.v(this.anonId)||this.refreshUUID(),this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:C,skuId:hd,skuToken:this.skuToken,userId:this.anonId},h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},d))}remove(){this.errorCb=null}},Bs=Mi.postMapLoadEvent.bind(Mi),fd=new class extends zs{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(d){let t=this.mapInstanceIdMap.get(d);return t||(t=i.u(),this.mapInstanceIdMap.set(d,t)),t}getEventId(d){let t=this.eventIdPerMapInstanceMap.get(d)||0;return this.eventIdPerMapInstanceMap.set(d,t+1),t}postStyleLoadEvent(d,t){let{map:o,style:h,importedStyles:g}=t;if(!i.e.EVENTS_URL||!d&&!i.e.ACCESS_TOKEN)return;let y=this.getMapInstanceId(o),x={mapInstanceId:y,eventId:this.getEventId(y),style:h};g.length&&(x.importedStyles=g),this.queueRequest({timestamp:Date.now(),payload:x},d)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},d)}},af=fd.postStyleLoadEvent.bind(fd),pd=new class extends zs{constructor(d){super("metrics"),d&&(this.data=d)}postMetricsEvent(d){if(!i.e.EVENTS_URL||!d&&!i.e.ACCESS_TOKEN)return;this.anonId||this.fetchEventData(),i.v(this.anonId)||this.refreshUUID();let t=Object.assign({},this.data,{sessionId:this.anonId});this.queueRequest({timestamp:Date.now(),payload:t},d)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,payload:o}=this.queue.shift();this.postEvent(t,o,()=>{},d)}}({attributes:[{name:"maps/js/layer-animations/style-with-appearances"}]}),sa=pd.postMetricsEvent.bind(pd),li=new class extends zs{constructor(){super("gljs.performance")}postPerformanceEvent(d,t){i.e.EVENTS_URL&&(d||i.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},d)}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{timestamp:t,performanceData:o}=this.queue.shift(),h=(function(g){let y=performance.getEntriesByType("resource"),x=performance.getEntriesByType("mark"),E=(function(F){let z={};if(F){for(let j in F)if(j!=="other")for(let q of F[j]){let $=`${j}ResolveRangeMin`,Z=`${j}ResolveRangeMax`,J=`${j}RequestCount`,Y=`${j}RequestCachedCount`;z[$]=Math.min(z[$]||1/0,q.startTime),z[Z]=Math.max(z[Z]||-1/0,q.responseEnd);let ae=Q=>{z[Q]===void 0&&(z[Q]=0),++z[Q]};q.transferSize!==void 0&&q.transferSize===0&&ae(Y),ae(J)}}return z})((function(F,z){let j={};if(F)for(let q of F){let $=z(q);j[$]===void 0&&(j[$]=[]),j[$].push(q)}return j})(y,ee)),T=window.devicePixelRatio,A=navigator.connection||navigator.mozConnection||navigator.webkitConnection,M=A?A.effectiveType:void 0,L={counters:[],metadata:[],attributes:[]},R=(F,z,j)=>{j!=null&&F.push({name:z,value:j.toString()})};for(let F in E)R(L.counters,F,E[F]);if(g.interactionRange[0]!==1/0&&g.interactionRange[1]!==-1/0&&(R(L.counters,"interactionRangeMin",g.interactionRange[0]),R(L.counters,"interactionRangeMax",g.interactionRange[1])),x)for(let F of Object.values(k)){let z=x.find(j=>j.name===F);z&&R(L.counters,F,z.startTime)}return R(L.counters,"visibilityHidden",g.visibilityHidden),R(L.attributes,"style",(function(F){if(F)for(let z of F){let j=z.name.split("?")[0];if(i.i(j)){let q=j.split("/").slice(-2);if(q.length===2)return`mapbox://styles/${q[0]}/${q[1]}`}}})(y)),R(L.attributes,"terrainEnabled",g.terrainEnabled?"true":"false"),R(L.attributes,"fogEnabled",g.fogEnabled?"true":"false"),R(L.attributes,"projection",g.projection),R(L.attributes,"zoom",g.zoom),R(L.metadata,"devicePixelRatio",T),R(L.metadata,"connectionEffectiveType",M),R(L.metadata,"navigatorUserAgent",navigator.userAgent),R(L.metadata,"screenWidth",window.screen.width),R(L.metadata,"screenHeight",window.screen.height),R(L.metadata,"windowWidth",window.innerWidth),R(L.metadata,"windowHeight",window.innerHeight),R(L.metadata,"mapWidth",g.width/T),R(L.metadata,"mapHeight",g.height/T),R(L.metadata,"webglRenderer",g.renderer),R(L.metadata,"webglVendor",g.vendor),R(L.metadata,"sdkVersion",C),R(L.metadata,"sdkIdentifier","mapbox-gl-js"),L})(o);for(let g of h.metadata);for(let g of h.counters);for(let g of h.attributes);this.postEvent(t,h,()=>{},d)}},sr=li.postPerformanceEvent.bind(li),Or=new class extends zs{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(d,t,o,h){if(!i.e.API_URL||!i.e.SESSION_PATH)return;let g=ji(i.e.API_URL+i.e.SESSION_PATH);g.params.push(`sku=${t||""}`),g.params.push(`access_token=${h||i.e.ACCESS_TOKEN||""}`);let y={url:bi(g),headers:{"Content-Type":"text/plain"}};this.pendingRequest=i.g(y,x=>{this.pendingRequest=null,o(x),this.saveEventData(),this.processRequests(h)})}getSessionAPI(d,t,o,h){this.skuToken=t,this.errorCb=h,i.e.SESSION_PATH&&i.e.API_URL&&(o||i.e.ACCESS_TOKEN?this.queueRequest({id:d,timestamp:Date.now()},o):this.errorCb(new Error(Un)))}processRequests(d){if(this.pendingRequest||this.queue.length===0)return;let{id:t,timestamp:o}=this.queue.shift();t&&this.success[t]||this.getSession(o,this.skuToken,h=>{h?this.errorCb(h):t&&(this.success[t]=!0)},d)}remove(){this.errorCb=null}},Hc=Or.getSessionAPI.bind(Or),ki=new Set;function al(d,t){t?ki.add(d):ki.delete(d)}class Go{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,o){this._updatedSourceCaches[t]=o,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){let o=t.scope;this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._updatedLayers[o].add(t.id),this.setDirty()}removeLayer(t){let o=t.scope;this._removedLayers[o]=this._removedLayers[o]||{},this._updatedLayers[o]=this._updatedLayers[o]||new Set,this._removedLayers[o][t.id]=t,this._updatedLayers[o].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){let t={};for(let o in this._updatedLayers)t[o]=t[o]||{},t[o].updatedIds=Array.from(this._updatedLayers[o].values());for(let o in this._removedLayers)t[o]=t[o]||{},t[o].removedIds=Object.keys(this._removedLayers[o]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,o){this._updatedImages[o]=this._updatedImages[o]||new Set,this._updatedImages[o].add(i.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Vs(d){let{userImage:t}=d;return!!(t&&t.render&&t.render())&&(d.data.replace(new Uint8Array(t.data.buffer)),!0)}class aa extends i.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&i.r()&&(this.imageRasterizerDispatcher=new i.D(i.t(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new i.q({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);let o=this.atlasTexture.get(t);o&&(o.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,o){this.imageProviders.has(o)||this.imageProviders.set(o,new Map),this.imageProviders.get(o).set(t.id,t)}removeImageProvider(t,o){this.imageProviders.has(o)&&this.imageProviders.get(o).delete(t)}getPendingImageProviders(){let t=[];for(let o of this.imageProviders.values())for(let h of o.values())h.hasPendingRequests()&&t.push(h);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new i.x),this._imageRasterizer}isLoaded(){for(let t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,o){if(this.loaded.get(o)!==t&&(this.loaded.set(o,t),t)){for(let{ids:h,callback:g}of this.requestors)this._notify(h,o,g);this.requestors=[]}}hasImage(t,o){return!!this.getImage(t,o)}getImage(t,o){return this.images.get(o).get(t.toString())}addImage(t,o,h){this._validate(t,h)&&this.images.get(o).set(t.toString(),h)}_validate(t,o){let h=!0;return this._validateStretch(o.stretchX,o.data&&o.data.width)||(this.fire(new i.y(new Error(`Image "${t.name}" has invalid "stretchX" value`))),h=!1),this._validateStretch(o.stretchY,o.data&&o.data.height)||(this.fire(new i.y(new Error(`Image "${t.name}" has invalid "stretchY" value`))),h=!1),this._validateContent(o.content,o)||(this.fire(new i.y(new Error(`Image "${t.name}" has invalid "content" value`))),h=!1),h}_validateStretch(t,o){if(!t)return!0;let h=0;for(let g of t){if(g[0]<h||g[1]<g[0]||o<g[1])return!1;h=g[1]}return!0}_validateContent(t,o){return t?t.length!==4||!o.usvg&&(t[0]<0||o.data.width<t[0]||t[1]<0||o.data.height<t[1]||t[2]<0||o.data.width<t[2]||t[3]<0||o.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,o,h){let g=this.images.get(o).get(t.toString());h.version=g.version+1,this.images.get(o).set(t.toString(),h),this.updatedImages.get(o).add(t),this.removeFromImageRasterizerCache(t,o)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,o){this.spriteFormat!=="raster"&&(i.r()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:o}):this.imageRasterizer.removeImagesFromCacheByIds([t],o))}removeImage(t,o){let h=this.images.get(o),g=h.get(t.toString());h.delete(t.toString()),this.patterns.get(o).delete(t.toString()),this.removeFromImageRasterizerCache(t,o),g.userImage&&g.userImage.onRemove&&g.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map(o=>i.I.from(o))}getImages(t,o,h){let g=[],y=[],x=this.imageProviders.get(o);for(let M of t){if(!M.iconsetId){g.push(M);continue}let L=x.get(M.iconsetId);L&&(this.getImage(M,o)?y.push(M):L.addPendingRequest(M))}if(g.length===0)return void this._notify(y,o,h);let E=!0,T=!!this.loaded.get(o),A=this.images.get(o);if(!T)for(let M of g)A.has(M.toString())||(E=!1);T||E?this._notify(g,o,h):this.requestors.push({ids:g,scope:o,callback:h})}rasterizeImages(t,o){let h=new Map,{tasks:g,scope:y}=t;for(let[x,E]of g.entries()){let T=this.getImage(E.id,y);T&&h.set(x,{image:T,imageVariant:E})}this._rasterizeImages(y,h,o)}_rasterizeImages(t,o,h){if(i.r())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:o,scope:t},h);else{let g=new Map;for(let[y,{image:x,imageVariant:E}]of o.entries())g.set(y,this.imageRasterizer.rasterize(E,x,t,0));h(void 0,g)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,o,h){let g=this.images.get(o),y=new Map;for(let x of t){if(!g.get(x.toString())){if(x.iconsetId)continue;this.fire(new i.z("styleimagemissing",{id:x.name}))}let E=g.get(x.toString());if(!E){i.w(`Image "${x.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}let T={data:E.usvg?null:E.data.clone(),pixelRatio:E.pixelRatio,sdf:E.sdf,usvg:E.usvg,version:E.version,stretchX:E.stretchX,stretchY:E.stretchY,content:E.content,hasRenderCallback:!!(E.userImage&&E.userImage.render)};E.usvg&&Object.assign(T,{width:E.icon.usvg_tree.width,height:E.icon.usvg_tree.height}),y.set(i.I.toString(x),T)}h(null,y)}getPixelSize(t){let{width:o,height:h}=this.atlasImage.get(t);return{width:o,height:h}}getPattern(t,o,h){let g=t.toString(),y=this.patterns.get(o),x=y.get(g),E=this.getImage(t,o);if(!E)return null;if(x){if(x.position.version===E.version)return x.position;x.position.version=E.version}else{if(E.usvg&&!E.data){let T=this.getPatternInFlightId(g,o);if(this.patternsInFlight.has(T))return null;this.patternsInFlight.add(T);let A=new i.A(t).scaleSelf(i.o.devicePixelRatio),M=new Map([[A.toString(),{image:E,imageVariant:A}]]);return this._rasterizeImages(o,M,(L,R)=>this.storePatternImage(A,o,E,h,R)),null}this.storePattern(t,o,E)}return this._updatePatternAtlas(o,h),y.get(g).position}getPatternInFlightId(t,o){return i.B(t,o)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,o,h,g,y){let x=t.toString(),E=y?y.get(x):void 0;E&&(h.data=E,this.storePattern(t.id,o,h),this._updatePatternAtlas(o,g),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),o)))}storePattern(t,o,h){let g={w:h.data.width+2*i.C,h:h.data.height+2*i.C,x:0,y:0},y=new i.F(g,h,i.C);this.patterns.get(o).set(t.toString(),{bin:g,position:y})}destroyAtlasTextures(){for(let t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,o){let h=t.gl,g=this.atlasTexture.get(o);g?this.dirty&&(g.update(this.atlasImage.get(o)),this.dirty=!1):(g=new i.T(t,this.atlasImage.get(o),h.RGBA8),this.atlasTexture.set(o,g)),g.bind(h.LINEAR,h.CLAMP_TO_EDGE)}_updatePatternAtlas(t,o){let h=this.patterns.get(t),g=Array.from(h.values()).map(({bin:A})=>A),{w:y,h:x}=i.G(g),E=this.atlasImage.get(t);E.resize({width:y||1,height:x||1});let T=this.images.get(t);for(let[A,{bin:M,position:L}]of h.entries()){let R=L.padding,F=M.x+R,z=M.y+R,j=T.get(A).data,q=j.width,$=j.height;R=R>1?R-1:R,i.q.copy(j,E,{x:0,y:0},{x:F,y:z},{width:q,height:$},o),i.q.copy(j,E,{x:0,y:$-R},{x:F,y:z-R},{width:q,height:R},o),i.q.copy(j,E,{x:0,y:0},{x:F,y:z+$},{width:q,height:R},o),i.q.copy(j,E,{x:q-R,y:0},{x:F-R,y:z},{width:R,height:$},o),i.q.copy(j,E,{x:0,y:0},{x:F+q,y:z},{width:R,height:$},o),i.q.copy(j,E,{x:q-R,y:$-R},{x:F-R,y:z-R},{width:R,height:R},o),i.q.copy(j,E,{x:0,y:$-R},{x:F+q,y:z-R},{width:R,height:R},o),i.q.copy(j,E,{x:0,y:0},{x:F+q,y:z+$},{width:R,height:R},o),i.q.copy(j,E,{x:q-R,y:0},{x:F-R,y:z+$},{width:R,height:R},o)}this.dirty=!0}beginFrame(){for(let t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,o){let h=this.images.get(o);for(let g of t){if(this.callbackDispatchedThisFrame.get(o).has(g.toString()))continue;this.callbackDispatchedThisFrame.get(o).add(g.toString());let y=h.get(g.toString());Vs(y)&&this.updateImage(g,o,y)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function tr(d){let t=d.value,o=d.valueSpec,h=d.style,g=d.styleSpec,y=d.key,x=d.arrayElementValidator||Ri;if(!Array.isArray(t))return[new i.V(y,t,`array expected, ${i.K(t)} found`)];if(o.length&&t.length!==o.length)return[new i.V(y,t,`array length ${o.length} expected, length ${t.length} found`)];if(o["min-length"]&&t.length<o["min-length"])return[new i.V(y,t,`array length at least ${o["min-length"]} expected, length ${t.length} found`)];let E={type:o.value,values:o.values,minimum:o.minimum,maximum:o.maximum,function:void 0};g.$version<7&&(E.function=o.function),i.H(o.value)&&(E=o.value);let T=[];for(let A=0;A<t.length;A++)T=T.concat(x({array:t,arrayIndex:A,value:t[A],valueSpec:E,style:h,styleSpec:g,key:`${y}[${A}]`},!0));return T}function md(d){let t=d.key,o=d.value,h=d.valueSpec;if(!i.L(o))return[new i.V(t,o,`number expected, ${i.K(o)} found`)];if(o!=o)return[new i.V(t,o,"number expected, NaN found")];if("minimum"in h){let g=h.minimum;if(Array.isArray(h.minimum)&&(g=h.minimum[d.arrayIndex]),o<g)return[new i.V(t,o,`${o} is less than the minimum value ${g}`)]}if("maximum"in h){let g=h.maximum;if(Array.isArray(h.maximum)&&(g=h.maximum[d.arrayIndex]),o>g)return[new i.V(t,o,`${o} is greater than the maximum value ${g}`)]}return[]}function Gl(d){let t=d.key,o=d.value;if(!i.H(o))return[new i.V(t,o,`object expected, ${i.K(o)} found`)];let h=d.valueSpec,g=i.J(o.type),y,x,E,T={},A=g!=="categorical"&&o.property===void 0,M=!A,L=(function(j){let q=j.stops;return Array.isArray(q)&&Array.isArray(q[0])&&i.H(q[0][0])})(o),R=Wr({key:d.key,value:d.value,valueSpec:d.styleSpec.function,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{stops:function(j){if(g==="identity")return[new i.V(j.key,j.value,'identity function may not have a "stops" property')];let q=[],$=j.value;return q=q.concat(tr({key:j.key,value:$,valueSpec:j.valueSpec,style:j.style,styleSpec:j.styleSpec,arrayElementValidator:F})),Array.isArray($)&&$.length===0&&q.push(new i.V(j.key,$,"array must have at least one stop")),q},default:function(j){return Ri({key:j.key,value:j.value,valueSpec:h,style:j.style,styleSpec:j.styleSpec})}}});return g==="identity"&&A&&R.push(new i.V(d.key,d.value,'missing required property "property"')),g==="identity"||o.stops||R.push(new i.V(d.key,d.value,'missing required property "stops"')),g==="exponential"&&h.expression&&!i.M(h)&&R.push(new i.V(d.key,d.value,"exponential functions not supported")),d.styleSpec.$version>=8&&(M&&!i.N(h)?R.push(new i.V(d.key,d.value,"property functions not supported")):A&&!i.O(h)&&R.push(new i.V(d.key,d.value,"zoom functions not supported"))),g!=="categorical"&&!L||o.property!==void 0||R.push(new i.V(d.key,d.value,'"property" property is required')),R;function F(j){let q=[],$=j.value,Z=j.key;if(!Array.isArray($))return[new i.V(Z,$,`array expected, ${i.K($)} found`)];if($.length!==2)return[new i.V(Z,$,`array length 2 expected, length ${$.length} found`)];if(L){if(!i.H($[0]))return[new i.V(Z,$,`object expected, ${i.K($[0])} found`)];let J=$[0];if(J.zoom===void 0)return[new i.V(Z,$,"object stop key must have zoom")];if(J.value===void 0)return[new i.V(Z,$,"object stop key must have value")];let Y=i.J(J.zoom);if(typeof Y!="number")return[new i.V(Z,J.zoom,"stop zoom values must be numbers")];if(E&&E>Y)return[new i.V(Z,J.zoom,"stop zoom values must appear in ascending order")];Y!==E&&(E=Y,x=void 0,T={}),q=q.concat(Wr({key:`${Z}[0]`,value:$[0],valueSpec:{zoom:{}},style:j.style,styleSpec:j.styleSpec,objectElementValidators:{zoom:md,value:z}}))}else q=q.concat(z({key:`${Z}[0]`,value:$[0],style:j.style,styleSpec:j.styleSpec},$));return i.Q(i.S($[1]))?q.concat([new i.V(`${Z}[1]`,$[1],"expressions are not allowed in function stops.")]):q.concat(Ri({key:`${Z}[1]`,value:$[1],valueSpec:h,style:j.style,styleSpec:j.styleSpec}))}function z(j,q){let $=i.K(j.value),Z=i.J(j.value),J=j.value!==null?j.value:q;if(y){if($!==y)return[new i.V(j.key,J,`${$} stop domain type must match previous stop domain type ${y}`)]}else y=$;if($!=="number"&&$!=="string"&&$!=="boolean"&&typeof Z!="number"&&typeof Z!="string"&&typeof Z!="boolean")return[new i.V(j.key,J,"stop domain value must be a number, string, or boolean")];if($!=="number"&&g!=="categorical"){let Y=`number expected, ${$} found`;return i.N(h)&&g===void 0&&(Y+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new i.V(j.key,J,Y)]}return g!=="categorical"||$!=="number"||typeof Z=="number"&&isFinite(Z)&&Math.floor(Z)===Z?g!=="categorical"&&$==="number"&&typeof Z=="number"&&typeof x=="number"&&x!==void 0&&Z<x?[new i.V(j.key,J,"stop domain values must appear in ascending order")]:(x=Z,g==="categorical"&&Z in T?[new i.V(j.key,J,"stop domain values must be unique")]:(T[Z]=!0,[])):[new i.V(j.key,J,`integer expected, found ${String(Z)}`)]}}function Po(d){let t=(d.expressionContext==="property"?i.W:i.U)(i.S(d.value),d.valueSpec);if(t.result==="error")return t.value.map(h=>new i.V(`${d.key}${h.key}`,d.value,h.message));let o=t.value.expression||t.value._styleExpression.expression;if(d.expressionContext==="property"&&d.propertyKey==="text-font"&&!o.outputDefined())return[new i.V(d.key,d.value,`Invalid data expression for "${d.propertyKey}". Output values must be contained as literals within the expression.`)];if(d.expressionContext==="property"&&d.propertyType==="layout"&&!i.Z(o))return[new i.V(d.key,d.value,'"feature-state" data expressions are not supported with layout properties.')];if(d.expressionContext==="filter")return ll(o,d);if(d.expressionContext==="appearance")return gd(o,d);if(d.expressionContext&&d.expressionContext.indexOf("cluster")===0){if(!i.X(o,["zoom","feature-state"]))return[new i.V(d.key,d.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(d.expressionContext==="cluster-initial"&&!i.Y(o))return[new i.V(d.key,d.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function ll(d,t){let o=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(let g of t.valueSpec.expression.parameters)o.delete(g);if(o.size===0)return[];let h=[];return d instanceof i._&&o.has(d.name)?[new i.V(t.key,t.value,`["${d.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(d.eachChild(g=>{h.push(...ll(g,t))}),h)}function gd(d,t){let o=new Set;if(t.valueSpec&&t.valueSpec.expression)for(let g of t.valueSpec.expression.parameters)o.add(g);if(o.size===0)return[];let h=[];return d instanceof i._&&!o.has(d.name)?[new i.V(t.key,t.value,`["${d.name}"] is not an allowed parameter`)]:(d.eachChild(g=>{h.push(...gd(g,t))}),h)}function co(d){let t=d.key,o=d.value,h=d.valueSpec,g=[];return Array.isArray(h.values)?h.values.indexOf(i.J(o))===-1&&g.push(new i.V(t,o,`expected one of [${h.values.join(", ")}], ${JSON.stringify(o)} found`)):Object.keys(h.values).indexOf(i.J(o))===-1&&g.push(new i.V(t,o,`expected one of [${Object.keys(h.values).join(", ")}], ${JSON.stringify(o)} found`)),g}function cl(d){return i.a2(i.S(d.value))?Po(Object.assign({},d,{expressionContext:"filter",valueSpec:d.styleSpec[`filter_${d.layerType||"fill"}`]})):la(d)}function la(d){let t=d.value,o=d.key;if(!Array.isArray(t))return[new i.V(o,t,`array expected, ${i.K(t)} found`)];if(t.length<1)return[new i.V(o,t,"filter array must have at least 1 element")];let h=d.styleSpec,g=co({key:`${o}[0]`,value:t[0],valueSpec:h.filter_operator});switch(i.J(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&i.J(t[1])==="$type"&&g.push(new i.V(o,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&g.push(new i.V(o,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(i.a0(t[1])||g.push(new i.V(`${o}[1]`,t[1],`string expected, ${i.K(t[1])} found`)));for(let y=2;y<t.length;y++)i.J(t[1])==="$type"?g=g.concat(co({key:`${o}[${y}]`,value:t[y],valueSpec:h.geometry_type})):i.a0(t[y])||i.L(t[y])||i.$(t[y])||g.push(new i.V(`${o}[${y}]`,t[y],`string, number, or boolean expected, ${i.K(t[y])} found.`));break;case"any":case"all":case"none":for(let y=1;y<t.length;y++)g=g.concat(la({key:`${o}[${y}]`,value:t[y],style:d.style,styleSpec:d.styleSpec}));break;case"has":case"!has":t.length!==2?g.push(new i.V(o,t,`filter array for "${t[0]}" operator must have 2 elements`)):i.a0(t[1])||g.push(new i.V(`${o}[1]`,t[1],`string expected, ${i.K(t[1])} found`))}return g}function Da(d,t){let o=d.key,h=d.style,g=d.layer,y=d.styleSpec,x=d.value,E=d.objectKey,T=y[`${t}_${d.layerType}`];if(!T)return[];let A=E.match(/^(.*)-use-theme$/);if(A&&T[A[1]])return i.Q(i.S(x))?[].concat(Ri({key:o,value:x,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:h,styleSpec:y,expressionContext:"property",propertyType:t,propertyKey:E})):Ri({key:o,value:x,valueSpec:{type:"string"},style:h,styleSpec:y});let M=E.match(/^(.*)-transition$/);if(t==="paint"&&M&&T[M[1]]&&T[M[1]].transition)return Ri({key:o,value:x,valueSpec:y.transition,style:h,styleSpec:y});let L=d.valueSpec||T[E];if(!L)return[new i.a3(o,x,`unknown property "${E}"`)];let R;if(i.a0(x)&&i.N(L)&&!L.tokens&&(R=/^{([^}]+)}$/.exec(x))){let z=`\`{ "type": "identity", "property": ${R?JSON.stringify(R[1]):'"_"'} }\``;return[new i.V(o,x,`"${E}" does not support interpolation syntax
Use an identity property function instead: ${z}.`)]}let F=[];if(d.layerType==="symbol")E!=="text-field"||!h||h.glyphs||h.imports||F.push(new i.V(o,x,'use of "text-field" requires a style "glyphs" property')),E==="text-font"&&i.a4(i.S(x))&&i.J(x.type)==="identity"&&F.push(new i.V(o,x,'"text-font" does not support identity functions'));else if(d.layerType==="model"&&t==="paint"&&g&&g.layout&&g.layout.hasOwnProperty("model-id")&&i.N(L)&&(i.a5(L)||i.O(L))){let z=i.W(i.S(x),L).value,j="expression"in z&&z.expression||"_styleExpression"in z&&z._styleExpression&&z._styleExpression.expression;j&&!i.X(j,["measure-light"])&&(E==="model-emissive-strength"&&i.Y(j)&&i.Z(j)||F.push(new i.V(o,x,`${E} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return F.concat(Ri({key:d.key,value:x,valueSpec:L,style:h,styleSpec:y,expressionContext:"property",propertyType:t,propertyKey:E}))}function ql(d){return Da(d,"paint")}function bo(d){return Da(d,"layout")}function Wl(d){let t=[],o=d.value,h=d.key,g=d.style,y=d.styleSpec;if(!i.H(o))return[new i.V(h,o,"object expected")];o.type||o.ref||t.push(new i.V(h,o,'either "type" or "ref" is required'));let x=i.J(o.type),E=i.J(o.ref);if(o.id){let T=i.J(o.id);for(let A=0;A<d.arrayIndex;A++){let M=g.layers[A];i.J(M.id)===T&&t.push(new i.V(h,o.id,`duplicate layer id "${T}", previously used at line ${M.id.__line__}`))}}if("ref"in o){let T;["type","source","source-layer","filter","layout"].forEach(A=>{A in o&&t.push(new i.V(h,o[A],`"${A}" is prohibited for ref layers`))}),g.layers.forEach(A=>{i.J(A.id)===E&&(T=A)}),T?T.ref?t.push(new i.V(h,o.ref,"ref cannot reference another ref layer")):x=i.J(T.type):typeof E=="string"&&t.push(new i.V(h,o.ref,`ref layer "${E}" not found`))}else if(x!=="background"&&x!=="sky"&&x!=="slot")if(o.source)if(i.a0(o.source)){let T=g.sources&&g.sources[o.source],A=T&&i.J(T.type);T?A==="vector"&&x==="raster"?t.push(new i.V(h,o.source,`layer "${o.id}" requires a raster source`)):A==="raster"&&x!=="raster"?t.push(new i.V(h,o.source,`layer "${o.id}" requires a vector source`)):A!=="vector"||o["source-layer"]?A==="raster-dem"&&x!=="hillshade"?t.push(new i.V(h,o.source,"raster-dem source can only be used with layer type 'hillshade'.")):A!=="raster-array"||["raster","raster-particle"].includes(x)?x==="line"&&o.paint&&(o.paint["line-gradient"]||o.paint["line-trim-offset"])&&A==="geojson"&&!T.lineMetrics?t.push(new i.V(h,o,`layer "${o.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):x==="raster-particle"&&A!=="raster-array"&&t.push(new i.V(h,o.source,`layer "${o.id}" requires a 'raster-array' source.`)):t.push(new i.V(h,o.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new i.V(h,o,`layer "${o.id}" must specify a "source-layer"`)):t.push(new i.V(h,o.source,`source "${o.source}" not found`))}else t.push(new i.V(`${h}.source`,o.source,'"source" must be a string'));else t.push(new i.V(h,o,'missing required property "source"'));return t=t.concat(Wr({key:h,value:o,valueSpec:y.layer,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Ri({key:`${h}.type`,value:o.type,valueSpec:y.layer.type,style:d.style,styleSpec:d.styleSpec,object:o,objectKey:"type"}),filter:T=>cl(Object.assign({layerType:x},T)),layout:T=>Wr({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":A=>bo(Object.assign({layerType:x},A))}}),paint:T=>Wr({layer:o,key:T.key,value:T.value,valueSpec:{},style:T.style,styleSpec:T.styleSpec,objectElementValidators:{"*":A=>ql(Object.assign({layerType:x,layer:o},A))}}),appearances(T){let A=tr({key:T.key,value:T.value,valueSpec:T.valueSpec,style:T.style,styleSpec:T.styleSpec,arrayElementValidator:R=>(function(F){let{key:z,layer:j,layerType:q}=F,$=i.J(F.value),Z=i.J($.name),J=i.J($.condition),Y=Wr({key:z,value:$,valueSpec:F.styleSpec.appearance,style:F.style,styleSpec:F.styleSpec,objectElementValidators:{condition:ae=>(function(Q){let ce=[];return ce.push(...Po({key:Q.key,value:Q.object.condition,valueSpec:i.a6.appearance.condition,expressionContext:"appearance"})),ce})(Object.assign({layer:j,layerType:q},ae)),properties:ae=>(function(Q){let ce=[],{styleSpec:se,layer:ie,layerType:ue}=Q,be=se[`paint_${ue}`],ye=se[`layout_${ue}`],Pe=Q.object[Q.objectKey];for(let Se in Pe){let Be=Se in be?"paint":Se in ye?"layout":void 0;if(!Be){ce.push(new i.V(Q.key,Se,`unknown property "${Se}" for layer type "${ue}"`));continue}let tt=Object.assign({},Q,{key:`${Q.key}.${Se}`,object:Pe,objectKey:Se,layer:ie,layerType:ue,value:Pe[Se],valueSpec:Be==="paint"?be[Se]:ye[Se]});ce.push(...Da(tt,Be))}return ce})(Object.assign({layer:j,layerType:q},ae))}});return Z!=="hidden"&&J===void 0&&Y.push(new i.V(F.key,"name",'Appearance with name different than "hidden" must have a condition')),Y})(Object.assign({layerType:x,layer:o},R))}),M=Array.isArray(T.value)?T.value:[],L=new Set;return M.forEach((R,F)=>{let z=i.J(R.name);if(z)if(L.has(z)){let j=i.J(o.id);A.push(new i.V(T.key,z,`Duplicated appearance name "${z}" for layer "${j}"`))}else L.add(z)}),A}}})),t}function ca({key:d,value:t}){return i.a0(t)?[]:[new i.V(d,t,`string expected, ${i.K(t)} found`)]}let $c={promoteId:function d({key:t,value:o}){if(i.a0(o))return ca({key:t,value:o});if(Array.isArray(o)){let g=[],y=i.S(o),x=i.U(y);return x.result==="error"&&x.value.forEach(E=>{g.push(new i.V(`${t}${E.key}`,null,`${E.message}`))}),i.X(x.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||g.push(new i.V(`${t}`,null,"promoteId expression should be only feature dependent")),g}if(!i.H(o))return[new i.V(t,o,`string, expression or object expected, "${i.K(o)}" found`)];let h=[];for(let g in o)h.push(...d({key:`${t}.${g}`,value:o[g]}));return h}};function Gc(d){let t=d.value,o=d.key,h=d.styleSpec,g=d.style;if(!i.H(t))return[new i.V(o,t,`object expected, ${i.K(t)} found`)];if(!("type"in t))return[new i.V(o,t,'"type" is required')];let y=i.J(t.type),x=[];switch(["vector","raster","raster-dem","raster-array"].includes(y)&&("url"in t||"tiles"in t||x.push(new i.a3(o,t,'Either "url" or "tiles" is required.'))),y){case"vector":case"raster":case"raster-dem":case"raster-array":return x=x.concat(Wr({key:o,value:t,valueSpec:h[`source_${y.replace("-","_")}`],style:d.style,styleSpec:h,objectElementValidators:$c})),x;case"geojson":if(x=Wr({key:o,value:t,valueSpec:h.source_geojson,style:g,styleSpec:h,objectElementValidators:$c}),"cluster"in t&&"clusterProperties"in t){if(!i.H(t.clusterProperties))return[new i.V(`${o}.clusterProperties`,t,`object expected, ${i.K(t)} found`)];for(let E in t.clusterProperties){let T=t.clusterProperties[E];if(!Array.isArray(T))return[new i.V(`${o}.clusterProperties.${E}`,T,"array expected")];let[A,M]=T,L=typeof A=="string"?[A,["accumulated"],["get",E]]:A;x.push(...Po({key:`${o}.${E}.map`,value:M,expressionContext:"cluster-map"})),x.push(...Po({key:`${o}.${E}.reduce`,value:L,expressionContext:"cluster-reduce"}))}}return x;case"video":return Wr({key:o,value:t,valueSpec:h.source_video,style:g,styleSpec:h});case"image":return Wr({key:o,value:t,valueSpec:h.source_image,style:g,styleSpec:h});case"canvas":return[new i.V(o,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return co({key:`${o}.type`,value:t.type,valueSpec:{values:dr(h)}})}}function dr(d){return d.source.reduce((t,o)=>{let h=d[o];return h.type.type==="enum"&&(t=t.concat(Object.keys(h.type.values||{}))),t},[])}function Zl(d){let t=d.value,o=d.styleSpec,h=o.light,g=d.style;if(t===void 0)return[];if(!i.H(t))return[new i.V("light",t,`object expected, ${i.K(t)} found`)];let y=[];for(let x in t){let E=x.match(/^(.*)-transition$/),T=x.match(/^(.*)-use-theme$/);y=y.concat(T&&h[T[1]]?Ri({key:x,value:t[x],valueSpec:{type:"string"},style:g,styleSpec:o}):E&&h[E[1]]&&h[E[1]].transition?Ri({key:x,value:t[x],valueSpec:o.transition,style:g,styleSpec:o}):h[x]?Ri({key:x,value:t[x],valueSpec:h[x],style:g,styleSpec:o}):[new i.V(x,t[x],`unknown property "${x}"`)])}return y}function qc(d){let t=d.value;if(!t)return[];let o=d.key;if(!i.H(t))return[new i.V(o,t,`object expected, ${i.K(t)} found`)];let h=[],g=d.styleSpec,y=g["light-3d"],x=d.style,E=d.style.lights;for(let M of["type","id"])if(!(M in t))return h=h.concat([new i.V(o,t,`missing property "${M}"`)]),h;if(!i.a0(t.type))return h=h.concat([new i.V(`${o}.type`,t.type,"string expected")]),h;if(E)for(let M=0;M<d.arrayIndex;M++){let L=i.J(t.type),R=E[M];i.J(R.type)===L&&h.push(new i.V(o,t.id,`duplicate light type "${t.type}", previously defined at line ${R.id.__line__}`))}let T=`properties_light_${t.type}`;if(!(T in g))return h=h.concat([new i.V(`${o}.type`,t,`Invalid light type ${t.type}`)]),h;let A=g[T];for(let M in t)if(M==="properties"){let L=t[M];if(!i.H(L))return h=h.concat([new i.V("properties",L,`object expected, ${i.K(L)} found`)]),h;for(let R in L){let F=R.match(/^(.*)-transition$/),z=R.match(/^(.*)-use-theme$/);h=h.concat(z&&A[z[1]]?Ri({key:M,value:L[R],valueSpec:{type:"string"},style:x,styleSpec:g}):F&&A[F[1]]&&A[F[1]].transition?Ri({key:M,value:t[M],valueSpec:g.transition,style:x,styleSpec:g}):A[R]?Ri({key:R,value:L[R],valueSpec:A[R],style:x,styleSpec:g}):[new i.a3(d.key,L[R],`unknown property "${R}"`)])}}else h=h.concat(y[M]?Ri({key:M,value:t[M],valueSpec:y[M],style:x,styleSpec:g}):[new i.a3(M,t[M],`unknown property "${M}"`)]);return h}function Ca(d){let t=d.value,o=d.key,h=d.style,g=d.styleSpec,y=g.terrain;if(t==null)return[];if(!i.H(t))return[new i.V("terrain",t,`object expected, ${i.K(t)} found`)];let x=[];for(let E in t){let T=E.match(/^(.*)-transition$/),A=E.match(/^(.*)-use-theme$/);x=x.concat(A&&y[A[1]]?Ri({key:E,value:t[E],valueSpec:{type:"string"},style:h,styleSpec:g}):T&&y[T[1]]&&y[T[1]].transition?Ri({key:E,value:t[E],valueSpec:g.transition,style:h,styleSpec:g}):y[E]?Ri({key:E,value:t[E],valueSpec:y[E],style:h,styleSpec:g}):[new i.a3(E,t[E],`unknown property "${E}"`)])}if(t.source)if(i.a0(t.source)){let E=h.sources&&h.sources[t.source],T=E&&i.J(E.type);E?T!=="raster-dem"&&x.push(new i.V(`${o}.source`,t.source,`terrain cannot be used with a source of type ${T}, it only be used with a "raster-dem" source type`)):x.push(new i.V(`${o}.source`,t.source,`source "${t.source}" not found`))}else x.push(new i.V(`${o}.source`,t.source,"source must be a string"));else x.push(new i.V(o,t,'terrain is missing required property "source"'));return x}function js(d){let t=d.value,o=d.style,h=d.styleSpec,g=h.fog;if(t===void 0)return[];if(!i.H(t))return[new i.V("fog",t,`object expected, ${i.K(t)} found`)];let y=[];for(let x in t){let E=x.match(/^(.*)-transition$/),T=x.match(/^(.*)-use-theme$/);y=y.concat(T&&g[T[1]]?Ri({key:x,value:t[x],valueSpec:{type:"string"},style:o,styleSpec:h}):E&&g[E[1]]&&g[E[1]].transition?Ri({key:x,value:t[x],valueSpec:h.transition,style:o,styleSpec:h}):g[x]?Ri({key:x,value:t[x],valueSpec:g[x],style:o,styleSpec:h}):[new i.a3(x,t[x],`unknown property "${x}"`)])}return y}let gs={"*":()=>[],array:tr,boolean:function(d){let t=d.value,o=d.key;return i.$(t)?[]:[new i.V(o,t,`boolean expected, ${i.K(t)} found`)]},number:md,color:function({key:d,value:t}){return i.a0(t)?i.a1.parseCSSColor(t)===null?[new i.V(d,t,`color expected, "${t}" found`)]:[]:[new i.V(d,t,`color expected, ${i.K(t)} found`)]},enum:co,filter:cl,function:Gl,layer:Wl,object:Wr,source:Gc,model:i.a7,light:Zl,"light-3d":qc,terrain:Ca,fog:js,string:ca,formatted:function(d){return ca(d).length===0?[]:Po(d)},resolvedImage:function(d){return ca(d).length===0?[]:Po(d)},projection:function(d){let t=d.value,o=d.styleSpec,h=o.projection,g=d.style;if(i.H(t)){let y=[];for(let x in t)y=y.concat(Ri({key:x,value:t[x],valueSpec:h[x],style:g,styleSpec:o}));return y}return i.a0(t)?[]:[new i.V("projection",t,`object or string expected, ${i.K(t)} found`)]},import:function(d){let t=d.key,{value:o,styleSpec:h}=d;if(!i.H(o))return[new i.V(t,o,"import must be an object")];let E=o,{data:g}=E,y=_x(E,["data"]);Object.defineProperty(y,"__line__",{value:o.__line__,enumerable:!1});let x=Wr(Object.assign({},d,{value:y,valueSpec:h.import}));return i.J(y.id)===""&&x.push(new i.V(`${d.key}.id`,y,"import id can't be an empty string")),g&&(x=x.concat(ul(g,h,{key:`${d.key}.data`}))),x},iconset:function(d){let t=d.value,o=d.key,h=d.styleSpec,g=d.style;if(!i.H(t))return[new i.V(o,t,"object expected")];if(!t.type)return[new i.V(o,t,'"type" is required')];let y=i.J(t.type),x=[];if(x=x.concat(Wr({key:o,value:t,valueSpec:h[`iconset_${y}`],style:g,styleSpec:h})),(function(E,T){return!(E!=="source"||!T.source)})(y,t)){let E=g.sources&&g.sources[t.source],T=E&&i.J(E.type);E?T!=="raster-array"&&x.push(new i.V(o,t.source,`iconset cannot be used with a source of type ${String(T)}, it only be used with a "raster-array" source type`)):x.push(new i.V(o,t.source,`source "${t.source}" not found`))}return x}};function Ri(d,t=!1){let o=d.value,h=d.valueSpec,g=d.styleSpec;if(h.expression){if(i.a4(i.J(o)))return Gl(d);if(i.Q(i.S(o)))return Po(d)}if(h.type&&gs[h.type]){let y=gs[h.type](d);return t===!0&&y.length>0&&Array.isArray(d.value)?Po(d):y}return Wr(Object.assign({},d,{valueSpec:h.type?g[h.type]:h}))}function Wr(d){let t=d.key,o=d.value,h=d.valueSpec||{},g=d.objectElementValidators||{},y=d.style,x=d.styleSpec;if(!i.H(o))return[new i.V(t,o,`object expected, ${i.K(o)} found`)];let E=[];for(let T in o){let A=T.split(".")[0],M;g[A]?M=g[A]:h[A]?M=Ri:g["*"]?M=g["*"]:h["*"]&&(M=Ri),M?E=E.concat(M({key:(t&&`${t}.`)+T,value:o[T],valueSpec:h[A]||h["*"],style:y,styleSpec:x,object:o,objectKey:T},o)):E.push(new i.a3(t,o[T],`unknown property "${T}"`))}for(let T in h){if(g[T])continue;let A=h[T];A.required&&A.default===void 0&&o[T]===void 0&&E.push(new i.V(t,o,`missing required property "${T}"`))}return E}function Xl({key:d,value:t}){let o=ca({key:d,value:t});if(o.length)return o;let h=t;return h.indexOf("{fontstack}")===-1&&o.push(new i.V(d,t,'"glyphs" url must include a "{fontstack}" token')),h.indexOf("{range}")===-1&&o.push(new i.V(d,t,'"glyphs" url must include a "{range}" token')),o}function ul(d,t=i.a6,o={}){return Wr({key:o.key||"",value:d,valueSpec:Object.assign(t.$root,{"*":{type:"*"}}),styleSpec:t,style:d,objectElementValidators:{glyphs:Xl}})}function qo(d,t=i.a6){return we(ul(d,t))}let lf=d=>we(Gc(d)),_d=d=>we(Zl(d)),$m=d=>we(qc(d)),Wc=d=>we(Ca(d)),Ze=d=>we(js(d)),Aa=d=>we((function(t){let o=t.value,h=t.style,g=t.styleSpec,y=g.snow;if(o===void 0)return[];if(!i.H(o))return[new i.V("snow",o,`object expected, ${i.K(o)} found`)];let x=[];for(let E in o){let T=E.match(/^(.*)-transition$/);x=x.concat(T&&y[T[1]]&&y[T[1]].transition?Ri({key:E,value:o[E],valueSpec:g.transition,style:h,styleSpec:g}):y[E]?Ri({key:E,value:o[E],valueSpec:y[E],style:h,styleSpec:g}):[new i.a3(E,o[E],`unknown property "${E}"`)])}return x})(d)),yd=d=>we((function(t){let o=t.value,h=t.style,g=t.styleSpec,y=g.rain;if(o===void 0)return[];if(!i.H(o))return[new i.V("rain",o,`object expected, ${i.K(o)} found`)];let x=[];for(let E in o){let T=E.match(/^(.*)-transition$/);x=x.concat(T&&y[T[1]]&&y[T[1]].transition?Ri({key:E,value:o[E],valueSpec:g.transition,style:h,styleSpec:g}):y[E]?Ri({key:E,value:o[E],valueSpec:y[E],style:h,styleSpec:g}):[new i.a3(E,o[E],`unknown property "${E}"`)])}return x})(d)),vd=d=>we(Wl(d)),gn=d=>we(cl(d)),eo=d=>we(ql(d)),Gm=d=>we(bo(d)),xd=d=>we(i.a7(d));function we(d){return d.slice().sort((t,o)=>t.line&&o.line?t.line-o.line:0)}function H(d,t){let o=!1;if(t&&t.length)for(let h of t)h instanceof i.a3?i.w(h.message):(d.fire(new i.y(new Error(h.message))),o=!0);return o}let G=i.a6.light,ne;class fe extends i.E{constructor(t,o="flat"){super(),this._transitionable=new i.a8(ne||(ne=new i.a9({anchor:new i.aa(G.anchor),position:new i.ab(G.position),color:new i.aa(G.color),intensity:new i.aa(G.intensity)}))),this.setLight(t,o),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,o,h={}){this._validate(_d,t,h)||(this._transitionable.setTransitionOrValue(t),this.id=o)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&H(this,t.call(qo,Object.assign({value:o,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}}let he=i.a6.terrain,ve=class extends i.E{constructor(d,t,o,h,g){super(),this.scope=o,this._transitionable=new i.a8(new i.a9({source:new i.aa(he.source),exaggeration:new i.aa(he.exaggeration)}),o,h),this._transitionable.setTransitionOrValue(d,h),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=g}get(){return this._transitionable.serialize()}set(d,t){this._transitionable.setTransitionOrValue(d,t)}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}getExaggeration(d){return this._transitioning.possiblyEvaluate(new i.ac(d,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let d=this._transitionable._values.exaggeration;if(!d)return null;let t=d.value.expression;if(!t)return null;let o=-1,h=-1,g=1;for(let y of t.zoomStops)g=t.evaluate(new i.ac(y,{worldview:this.worldview})),g>.01?(o=y,h=-1):h=y;return g<.01&&o>0&&h>o?[o,h]:null}isZoomDependent(){let d=this._transitionable._values.exaggeration;return d!=null&&d.value!=null&&d.value.expression!=null&&d.value.expression instanceof i.ad}},Me=45,xe=65,Ce=.05;function et(d,t,o,h){let g=i.ah(Me,xe,o),[y,x]=We(d,h),E=1-Math.min(1,Math.exp((t-y)/(x-y)*-6));return E*=E*E,E=Math.min(1,1.00747*E),E*g*d.alpha}function We(d,t){let o=.5/Math.tan(.5*t);return[d.range[0]+o,d.range[1]+o]}function St(d,t,o,h,g){let y=i.af([],[t,o,h],g.mercatorFogMatrix);return et(d,i.ag(y),g.pitch,g._fov)}function Ht(d,t,o,h,g,y,x){let E=[[o,h,0],[g,h,0],[g,y,0],[o,y,0]],T=Number.MAX_VALUE,A=-Number.MAX_VALUE;for(let M of E){let L=i.af([],M,t),R=i.ag(L);T=Math.min(T,R),A=Math.max(A,R)}return[et(d,T,x.pitch,x._fov),et(d,A,x.pitch,x._fov)]}let Vt=i.a6.fog;class Rt extends i.E{constructor(t,o,h,g){super();let y=new i.a9({range:new i.aa(Vt.range),color:new i.aa(Vt.color),"color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"high-color":new i.aa(Vt["high-color"]),"high-color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"space-color":new i.aa(Vt["space-color"]),"space-color-use-theme":new i.aa({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new i.aa(Vt["horizon-blend"]),"star-intensity":new i.aa(Vt["star-intensity"]),"vertical-range":new i.aa(Vt["vertical-range"])});this._transitionable=new i.a8(y,h,new Map(g)),this.set(t,g),this._transitioning=this._transitionable.untransitioned(),this._transform=o,this.properties=new i.ai(y),this.scope=h}get state(){let t=this._transform,o=t.projection.name==="globe",h=i.aj(t.zoom),g=this.properties.get("range"),y=[.5,3];return{range:o?[i.ak(y[0],g[0],h),i.ak(y[1],g[1],h)]:g,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,o,h={}){if(this._validate(Ze,t,h))return;let g=Object.assign({},t);for(let y of Object.keys(Vt))g[y]===void 0&&(g[y]=Vt[y].default);this._options=g,this._transitionable.setTransitionOrValue(this._options,o)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;let o=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:i.ah(Me,xe,t))*o.a}getOpacityAtLatLng(t,o){return this._transform.projection.supportsFog?(function(h,g,y){let x=i.ae.fromLngLat(g),E=y.elevation?y.elevation.getAtPointOrZero(x):0;return St(h,x.x,x.y,E,y)})(this.state,t,o):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];let o=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Ht(this.state,o,0,0,i.al,i.al,this._transform)}getOpacityForBounds(t,o,h,g,y){return this._transform.projection.supportsFog?Ht(this.state,t,o,h,g,y,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?We(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;let o=[4,5,6,7];for(let h of o){let g=t.points[h],y;if(g[2]>=0)y=g;else{let x=t.points[h-4];y=i.am(x,g,x[2]/(x[2]-g[2]))}if(St(this.state,y[0],y[1],0,this._transform)>=Ce)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,o,h){return(!h||h.validate!==!1)&&H(this,t.call(qo,Object.assign({value:o,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}}let sn,dn,Wn,Ni,ar=class extends i.E{constructor(d,t,o,h){super();let g=sn||(sn=new i.a9({density:new i.aa(i.a6.snow.density),intensity:new i.aa(i.a6.snow.intensity),color:new i.aa(i.a6.snow.color),opacity:new i.aa(i.a6.snow.opacity),vignette:new i.aa(i.a6.snow.vignette),"vignette-color":new i.aa(i.a6.snow["vignette-color"]),"center-thinning":new i.aa(i.a6.snow["center-thinning"]),direction:new i.aa(i.a6.snow.direction),"flake-size":new i.aa(i.a6.snow["flake-size"])}));this._transitionable=new i.a8(g,o,new Map(h)),this.set(d,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ai(g),this.scope=o}get state(){let d=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=i.an(o[0]),g=-Math.max(i.an(o[1]),.01),y=[Math.cos(h)*Math.cos(g),Math.sin(h)*Math.cos(g),Math.sin(g)],x=this.properties.get("vignette"),E=this.properties.get("vignette-color");return E.a=x,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.ao(t.r,t.g,t.b,t.a*d),direction:y,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:E}}get(){return this._transitionable.serialize()}set(d,t,o={}){if(this._validate(Aa,d,o))return;let h=Object.assign({},d),g=i.a6.snow;for(let y of Object.keys(g))h[y]===void 0&&(h[y]=g[y].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(d){this._transitionable.setTransitionOrValue(this._options,new Map(d))}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}_validate(d,t,o){return(!o||o.validate!==!1)&&H(this,d.call(qo,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}},Zi=class extends i.E{constructor(d,t,o,h){super();let g=dn||(dn=new i.a9({density:new i.aa(i.a6.rain.density),intensity:new i.aa(i.a6.rain.intensity),color:new i.aa(i.a6.rain.color),opacity:new i.aa(i.a6.rain.opacity),vignette:new i.aa(i.a6.rain.vignette),"vignette-color":new i.aa(i.a6.rain["vignette-color"]),"center-thinning":new i.aa(i.a6.rain["center-thinning"]),direction:new i.aa(i.a6.rain.direction),"droplet-size":new i.aa(i.a6.rain["droplet-size"]),"distortion-strength":new i.aa(i.a6.rain["distortion-strength"])}));this._transitionable=new i.a8(g,o,new Map(h)),this.set(d,h),this._transitioning=this._transitionable.untransitioned(),this.properties=new i.ai(g),this.scope=o}get state(){let d=this.properties.get("opacity"),t=this.properties.get("color"),o=this.properties.get("direction"),h=i.an(o[0]),g=-Math.max(i.an(o[1]),.01),y=[Math.cos(h)*Math.cos(g),Math.sin(h)*Math.cos(g),Math.sin(g)],x=this.properties.get("vignette-color");return x.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new i.ao(t.r,t.g,t.b,t.a*d),direction:y,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:x}}get(){return this._transitionable.serialize()}set(d,t,o={}){if(this._validate(yd,d,o))return;let h=Object.assign({},d),g=i.a6.rain;for(let y of Object.keys(g))h[y]===void 0&&(h[y]=g[y].default);this._options=h,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(d){this._transitionable.setTransitionOrValue(this._options,new Map(d))}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}_validate(d,t,o){return(!o||o.validate!==!1)&&H(this,d.call(qo,Object.assign({value:t,style:{glyphs:!0,sprite:!0},styleSpec:i.a6})))}};class Hi extends i.E{constructor(t,o,h,g){super(),this.scope=h,this._options=t,this.properties=new i.ai(o),this._transitionable=new i.a8(o,h,new Map(g)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,o){this._options=t,this._transitionable.setTransitionOrValue(t.properties,o)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class Hn{constructor(t,o,h){this.screenBounds=t,this.cameraPoint=h.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=o,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,h)}static createFromScreenPoints(t,o){let h,g;if(t instanceof i.P||typeof t[0]=="number"){let y=i.P.convert(t);h=[y],g=o.isPointAboveHorizon(y)}else{let y=i.P.convert(t[0]),x=i.P.convert(t[1]),E=y.add(x)._div(2);h=[y,x],g=i.aq(y,x).every(T=>o.isPointAboveHorizon(T))&&o.isPointAboveHorizon(E)}return new Hn(h,g,o)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return i.aq(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],g=i.aq(o,h,0,!1);return this.cameraPoint.y>h.y&&(this.cameraPoint.x>o.x&&this.cameraPoint.x<h.x?g.splice(3,0,this.cameraPoint):this.cameraPoint.x>=h.x?g[2]=this.cameraPoint:this.cameraPoint.x<=o.x&&(g[3]=this.cameraPoint)),i.ar(g,t)}bufferedCameraGeometryGlobe(t){let o=this.screenBounds[0],h=this.screenBounds.length===1?this.screenBounds[0].add(new i.P(1,1)):this.screenBounds[1],g=i.aq(o,h,t),y=this.cameraPoint.clone();switch(3*((y.y>o.y)+(y.y>h.y))+((y.x>o.x)+(y.x>h.x))){case 0:g[0]=y,g[4]=y.clone();break;case 1:g.splice(1,0,y);break;case 2:g[1]=y;break;case 3:g.splice(4,0,y);break;case 5:g.splice(2,0,y);break;case 6:g[3]=y;break;case 7:g.splice(3,0,y);break;case 8:g[2]=y}return g}containsTile(t,o,h,g=0){let y=Math.max(t.queryPadding,t.evaluateQueryRenderedFeaturePadding())/o._pixelsPerMercatorPixel+1,x=h?this._bufferedCameraMercator(y,o):this._bufferedScreenMercator(y,o),E=t.tileID.wrap+(x.unwrapped?g:0),T=x.polygon.map(q=>i.as(t.tileTransform,q,E));if(!i.at(T,0,0,i.al,i.al))return;E=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?g:0);let A=this.screenGeometryMercator.polygon.map(q=>i.au(t.tileTransform,q,E)),M=A.map(q=>new i.P(q[0],q[1])),L=o.getFreeCameraOptions().position||new i.ae(0,0,0),R=i.au(t.tileTransform,L,E),F=A.map(q=>{let $=i.av(q,q,R);return i.aw($,$),new i.ax(R,$)}),z=i.ay(t,1,o.zoom)*o._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:M,tilespaceRays:F,bufferedTilespaceGeometry:T,bufferedTilespaceBounds:(j=i.az(T),j.min.x=i.aA(j.min.x,0,i.al),j.min.y=i.aA(j.min.y,0,i.al),j.max.x=i.aA(j.max.x,0,i.al),j.max.y=i.aA(j.max.y,0,i.al),j),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:z};var j}_bufferedScreenMercator(t,o){let h=Pi(t);if(this._screenRaycastCache[h])return this._screenRaycastCache[h];{let g;return g=o.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),o):{polygon:this.bufferedScreenGeometry(t).map(y=>o.pointCoordinate3D(y)),unwrapped:!0},this._screenRaycastCache[h]=g,g}}_bufferedCameraMercator(t,o){let h=Pi(t);if(this._cameraRaycastCache[h])return this._cameraRaycastCache[h];{let g;return g=o.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),o):{polygon:this.bufferedCameraGeometry(t).map(y=>o.pointCoordinate3D(y)),unwrapped:!0},this._cameraRaycastCache[h]=g,g}}_projectAndResample(t,o){let h=(function(y,x){let E=i.aB([],x.pixelMatrix,x.globeMatrix),T=[0,-i.aD,0,1],A=[0,i.aD,0,1],M=[0,0,0,1];i.aC(T,T,E),i.aC(A,A,E),i.aC(M,M,E);let L=new i.P(T[0]/T[3],T[1]/T[3]),R=new i.P(A[0]/A[3],A[1]/A[3]),F=i.aE(y,L)&&T[3]<M[3],z=i.aE(y,R)&&A[3]<M[3];if(!F&&!z)return null;let j=(function(ce,se,ie){for(let ue=1;ue<ce.length;ue++){let be=fi(se.pointCoordinate3D(ce[ue-1]).x),ye=fi(se.pointCoordinate3D(ce[ue]).x);if(ie<0){if(be<ye)return{idx:ue,t:-be/(ye-1-be)}}else if(ye<be)return{idx:ue,t:(1-be)/(ye+1-be)}}return null})(y,x,F?-1:1);if(!j)return null;let{idx:q,t:$}=j,Z=q>1?_n(y.slice(0,q),x):[],J=q<y.length?_n(y.slice(q),x):[];Z=Z.map(ce=>new i.P(fi(ce.x),ce.y)),J=J.map(ce=>new i.P(fi(ce.x),ce.y));let Y=[...Z];Y.length===0&&Y.push(J[J.length-1]);let ae=i.ak(Y[Y.length-1].y,(J.length===0?Z[0]:J[0]).y,$),Q;return Q=F?[new i.P(0,ae),new i.P(0,0),new i.P(1,0),new i.P(1,ae)]:[new i.P(1,ae),new i.P(1,1),new i.P(0,1),new i.P(0,ae)],Y.push(...Q),J.length===0?Y.push(Z[0]):Y.push(...J),{polygon:Y.map(ce=>new i.ae(ce.x,ce.y)),unwrapped:!1}})(t,o);if(h)return h;let g=(function(y,x){let E=!1,T=-1/0,A=0;for(let L=0;L<y.length-1;L++)y[L].x>T&&(T=y[L].x,A=L);for(let L=0;L<y.length-1;L++){let R=(A+L)%(y.length-1),F=y[R],z=y[R+1];Math.abs(F.x-z.x)>.5&&(F.x<z.x?(F.x+=1,R===0&&(y[y.length-1].x+=1)):(z.x+=1,R+1===y.length-1&&(y[0].x+=1)),E=!0)}let M=i.aF(x.center.lng);return E&&M<Math.abs(M-1)&&y.forEach(L=>{L.x-=1}),{polygon:y,unwrapped:E}})(_n(t,o).map(y=>new i.P(fi(y.x),y.y)),o);return{polygon:g.polygon.map(y=>new i.ae(y.x,y.y)),unwrapped:g.unwrapped}}}function _n(d,t){return i.aG(d,o=>{let h=t.pointCoordinate3D(o);o.x=h.x,o.y=h.y},1/256)}function fi(d){return d<0?1+d%1:d%1}function Pi(d){return 100*d|0}function Yn(d,t,o,h,g){let y=function(E,T){if(E)return g(E);if(T){if(d.url&&T.tiles&&d.tiles&&delete d.tiles,T.variants){if(!Array.isArray(T.variants))return g(new Error("variants must be an array"));for(let M of T.variants){if(M==null||typeof M!="object"||M.constructor!==Object)return g(new Error("variant must be an object"));if(!Array.isArray(M.capabilities))return g(new Error("capabilities must be an array"));if(M.capabilities.length===1&&M.capabilities[0]==="meshopt"){T=Object.assign(T,M);break}}}let A=i.aH(Object.assign({},T,d),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);A.tiles=t.canonicalizeTileset(A,d.url),g(null,A)}},x=(function(E,T,A){if(!E)return null;if(!T&&!A)return E;A=A||E.worldview_default;let M=Object.values(E.language||{});if(M.length===0)return null;let L=Object.values(E.worldview||{});if(L.length===0)return null;let R=M.every(z=>z===T),F=L.every(z=>z===A);return R&&F?E:T in(E.language_options||{})||A in(E.worldview_options||{})?null:E.language_options&&E.worldview_options?E:null})(d.data,o,h);return x?i.o.frame(()=>y(null,x)):d.url?i.m(t.transformRequest(t.normalizeSourceURL(d.url,null,o,h),i.R.Source),y):i.o.frame(()=>{let A=d,{data:E}=A,T=_x(A,["data"]);y(null,T)})}function pi(d,t){let o=Math.pow(2,t.z),h=Math.floor(i.aF(d.getWest())*o),g=Math.floor(i.aJ(d.getNorth())*o),y=Math.ceil(i.aF(d.getEast())*o),x=Math.ceil(i.aJ(d.getSouth())*o);return t.x>=h&&t.x<y&&t.y>=g&&t.y<x}class mr{constructor(t,o,h){this.bounds=t?i.aI.convert(this.validateBounds(t)):null,this.minzoom=o||0,this.maxzoom=h||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(let o of t)this.extraBounds.push(i.aI.convert(this.validateBounds(o)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!pi(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(let o of this.extraBounds)if(pi(o,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;let o=new mr(t.bounds,t.minzoom,t.maxzoom);return o.addExtraBounds(t.extra_bounds),o}}class to extends i.E{constructor(t,o,h,g){if(super(),this.id=t,this.dispatcher=h,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Object.assign(this,i.aH(o,["url","scheme","tileSize","promoteId"])),this._options=Object.assign({type:"vector"},o),this._collectResourceTiming=!!o.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g),this._tileWorkers={},this._deduped=new i.aK}load(t){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));let o=Array.isArray(this.map._language)?this.map._language.join():this.map._language,h=this.map.getWorldview();this._tileJSONRequest=Yn(this._options,this.map._requestManager,o,h,(g,y)=>{if(this._tileJSONRequest=null,this._loaded=!0,g)o&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${o}`),h&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${h}`),this.fire(new i.y(g));else if(y){if(Object.assign(this,y),this.hasWorldviews=!!y.worldview_options,y.worldview_default&&(this.worldviewDefault=y.worldview_default),y.vector_layers){this.vectorLayers=y.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(let x of y.vector_layers)this.vectorLayerIds.push(x.id),y.worldview&&y.worldview[x.source]&&this.localizableLayerIds.add(x.id)}this.tileBounds=mr.fromTileJSON(y),ms(y.tiles,this.map._requestManager._customAccessToken),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(g)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}loadTile(t,o){let h=t.tileID.canonical.url(this.tiles,this.scheme),g=this.map._requestManager.normalizeTileURL(h),y=this.map._requestManager.transformRequest(g,i.R.Tile),x=this.map.style?this.map.style.getLut(this.scope):null,E=x?{image:x.image.clone()}:null,T={request:y,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:E,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:i.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault,indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};if(this.hasWorldviews&&i.h(h)&&(T.localizableLayerIds=this.localizableLayerIds),T.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=o:t.request=t.actor.send("reloadTile",T,A.bind(this));else if(t.actor=this._tileWorkers[g]=this._tileWorkers[g]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",T,A.bind(this),void 0,!0);else{let M=i.aL.call({deduped:this._deduped},T,(L,R)=>{if(L||!R)A.call(this,L);else{let F=i.aM(R.responseHeaders);T.data={cacheControl:F.cacheControl,expires:F.expires,rawData:R.rawData.slice(0)},t.actor&&t.actor.send("loadTile",T,A.bind(this),void 0,!0)}},!0);t.request={cancel:M}}function A(M,L){return delete t.request,t.aborted?o(null):M&&M.status!==404?o(M):(L&&L.resourceTiming&&(t.resourceTiming=L.resourceTiming),this.map._refreshExpiredTiles&&L&&t.setExpiryData(L),t.loadVectorData(L,this.map.painter),i.aN(this.dispatcher),o(null,L),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class _s extends i.E{constructor(t,o,h,g){super(),this.id=t,this.dispatcher=h,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Object.assign({type:"raster"},o),Object.assign(this,i.aH(o,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));let o=this.map.getWorldview();this._tileJSONRequest=Yn(this._options,this.map._requestManager,null,o,(h,g)=>{this._tileJSONRequest=null,this._loaded=!0,h?this.fire(new i.y(h)):g&&(Object.assign(this,g),g.raster_layers&&(this.rasterLayers=g.raster_layers,this.rasterLayerIds=this.rasterLayers.map(y=>y.id)),this.tileBounds=mr.fromTileJSON(g),ms(g.tiles),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(h)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();let t=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return Object.assign({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,o){let h=i.o.devicePixelRatio>=2,g=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),h,this.tileSize);t.request=i.n(this.map._requestManager.transformRequest(g,i.R.Tile),(y,x,E)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(y)return t.state="errored",o(y);if(!x)return o(null);let T=i.aM(E);this.map._refreshExpiredTiles&&t.setExpiryData(T),t.setTexture(x,this.map.painter),t.state="loaded",i.aN(this.dispatcher),o(null)})}abortTile(t,o){t.request&&(t.request.cancel(),delete t.request),o&&o()}unloadTile(t,o){t.texture&&t.texture instanceof i.T?(t.destroy(!0),t.texture&&t.texture instanceof i.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),o&&o()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Yl([d,t],o,h,{scaled:g=!0}={}){let{tileSize:y,buffer:x}=h,{x:E,y:T,z:A}=o;if(!isFinite(E)||!isFinite(T)||!isFinite(A))throw new Error("Invalid MRT header");let M=2**A,L=M*i.aF(d),R=M*i.aJ(t);return(function([F,z],j,{scaled:q=!0}={}){if(!j)throw new Error("bandView is undefined");let{data:$,tileSize:Z,buffer:J,offset:Y,scale:ae,dimension:Q}=j;if(F<-J||F>Z+J||z<-J||z>Z+J)throw new Error(`Point (${F}, ${z}) out of bounds for tileSize=${Z}, buffer=${J}`);let ce=(z+J)*(Z+2*J)+(F+J);if(new Uint32Array($.buffer)[ce]===4294967295)return null;let se=[];se=q?[]:new j.data.constructor(Q);for(let ie=0;ie<Q;ie++)se[ie]=Math.round(1e12*($[Q*ce+ie]*ae+Y))/1e12;return se})([Math.min(Math.max(-x,Math.floor((L-E)*y)),y-1+x),Math.min(Math.max(-x,Math.floor((R-T)*y)),y-1+x)],h,{scaled:g})}class vr extends _s{constructor(t,o,h,g){super(t,o,h,g),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._loadTilePending={},this._loadTileLoaded={},this._options=Object.assign({type:"raster-array"},o)}triggerRepaint(t){let o=this.map.painter._terrain,h=this.map.style.getSourceCache(this.id);o&&o.enabled&&h&&o._clearRenderCacheForTile(h.id,t.tileID),this.map.triggerRepaint()}loadTile(t,o){let h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(h,i.R.Tile),y={request:g,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=g,t.actor||(t.actor=this.dispatcher.getActor());let x=(E,T,A)=>{if(delete t.request,t.aborted)return t.state="unloaded",o(null);if(E)return E.name==="AbortError"?void 0:(t.state="errored",o(E));if(this.map._refreshExpiredTiles&&T){let M=i.aM(A);t.setExpiryData(M)}if(this.partial&&t.state!=="expired")t.state="empty";else if(!this.partial){if(!T)return o(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=T}o(null)};t.request=this.partial?t.fetchHeader(void 0,x.bind(this)):t.actor.send("loadTile",y,x.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,o){let h=t.texturePerLayer;if(t.flushAllQueues(),h.size){t.destroy(!0);for(let g of h.values())this.map.painter.saveTileTexture(g)}else t.destroy()}prepareTile(t,o,h,g){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBandForRender(o,h,g,(y,x)=>{if(y)return t.state="errored",this.fire(new i.y(y)),void this.triggerRepaint(t);x&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(h,x,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;let o=this.rasterLayers.find(({id:y})=>y===t),h=o&&o.fields,g=h&&h.bands&&h.bands;return g?g[0]:0}getTextureDescriptor(t,o,h){if(!t)return;let g=o.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!g)return;let y=null;o instanceof i.aQ?y=o.paint.get("raster-array-band"):o instanceof i.aR&&(y=o.paint.get("raster-particle-array-band"));let x=y||this.getInitialBand(g);if(x==null)return;if(!t.textureDescriptorPerLayer.get(o.id))return void this.prepareTile(t,g,o.id,x);if(t.updateNeeded(o.id,x)&&!h)return;let E=t.textureDescriptorPerLayer.get(o.id);return Object.assign({},E,{texture:t.texturePerLayer.get(o.id)})}getImages(t,o){let h=new Map;for(let g of t)for(let y of o){let[x,E]=y.split("/"),T=g.getLayer(x);if(!T||!T.hasBand(E)||!T.hasDataForBand(E))continue;let{bytes:A,tileSize:M,buffer:L}=T.getBandView(E),R=M+2*L,F={data:new i.q({width:R,height:R},A),pixelRatio:2,sdf:!1,usvg:!1,version:0};h.set(y,F)}return h}queryRasterArrayValueByBandId(t,o,h){let g=o._mrt;return new Promise(y=>{let x={},E=new Set;for(let[T,A]of Object.entries(g.layers)){if(h.layerName&&T!==h.layerName)continue;let M={};x[T]=M;for(let{bands:L}of A.dataIndex)for(let R of L)h.bands&&!h.bands.includes(R)||(E.add(i.B(T,R)),o.fetchBand(T,null,R,F=>{i.o.frame(()=>{M[R]=F?null:Yl([t.lng,t.lat],g,A.getBandView(R)),E.delete(i.B(T,R)),E.size===0&&y(x)})},!1))}E.size===0&&y(x)})}_loadTileForQuery(t,o){if(this._loadTileLoaded[t.uid])return void o(null,t._mrt);if(this._loadTilePending[t.uid])return void this._loadTilePending[t.uid].push(o);this._loadTilePending[t.uid]=[o];let h=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),g=this.map._requestManager.transformRequest(h,i.R.Tile);t.actor.send("loadTile",{request:g,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:!1},(y,x,E)=>{if(y)return this._loadTilePending[t.uid].forEach(T=>T(y,null)),void delete this._loadTilePending[t.uid];if(!x)return this._loadTilePending[t.uid].forEach(T=>T(null,null)),void delete this._loadTilePending[t.uid];if(this.map._refreshExpiredTiles&&x){let T=i.aM(E);t.setExpiryData(T)}t._mrt=x,t._isHeaderLoaded=!0,t.state="loaded",this._loadTilePending[t.uid].forEach(T=>T(null,x)),this._loadTileLoaded[t.uid]=!0,delete this._loadTilePending[t.uid]},void 0,!0)}queryRasterArrayValueByAllBands(t,o,h){return new Promise((g,y)=>{this._loadTileForQuery(o,(x,E)=>{x?y(x):g(E?this.queryRasterArrayValueByBandId(t,o,h):null)})})}queryRasterArrayValue(t,o){let h=i.aS.convert(t),g=this.findLoadedParent(h);return g&&g._mrt?o.bands||!this.partial?this.queryRasterArrayValueByBandId(h,g,o):this.queryRasterArrayValueByAllBands(h,g,o):Promise.resolve(null)}findLoadedParent(t){let o=i.ae.fromLngLat(t,this.map.transform.tileSize),h=this.maxzoom+1,g=1<<h,y=Math.floor(o.x),x=Math.floor((o.x-y)*g),E=Math.floor(o.y*g),T=this.map.style.getSourceCache(this.id),A=new i.aP(h,y,h,x,E);return T.findLoadedParent(A,this.minzoom)}}let ys={vector:to,raster:_s,"raster-dem":class extends _s{constructor(d,t,o,h){super(d,t,o,h),this.type="raster-dem",this.maxzoom=22,this._options=Object.assign({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(d,t){let o=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function h(g,y){g&&(d.state="errored",t(g)),y&&(d.dem=y,d.dem.onDeserialize(),d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0,d.state="loaded",t(null))}d.request=i.n(this.map._requestManager.transformRequest(o,i.R.Tile),(function(g,y,x){if(delete d.request,d.aborted)d.state="unloaded",t(null);else if(g)d.state="errored",t(g);else if(y){let E=i.aM(x);this.map._refreshExpiredTiles&&d.setExpiryData(E);let T=ImageBitmap&&y instanceof ImageBitmap&&i.r(),A=1-(y.width-i.aO(y.width))/2;A<1||d.neighboringTiles||(d.neighboringTiles=this._getNeighboringTiles(d.tileID));let M=T?y:i.o.getImageData(y,A),L={uid:d.uid,tileID:d.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:M,encoding:this.encoding,padding:A};d.actor&&d.state!=="expired"||(d.actor=this.dispatcher.getActor(),d.actor.send("loadTile",L,h.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(d){let t=d.canonical,o=Math.pow(2,t.z),h=(t.x-1+o)%o,g=t.x===0?d.wrap-1:d.wrap,y=(t.x+1+o)%o,x=t.x+1===o?d.wrap+1:d.wrap,E={};return E[new i.aP(d.overscaledZ,g,t.z,h,t.y).key]={backfilled:!1},E[new i.aP(d.overscaledZ,x,t.z,y,t.y).key]={backfilled:!1},t.y>0&&(E[new i.aP(d.overscaledZ,g,t.z,h,t.y-1).key]={backfilled:!1},E[new i.aP(d.overscaledZ,d.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},E[new i.aP(d.overscaledZ,x,t.z,y,t.y-1).key]={backfilled:!1}),t.y+1<o&&(E[new i.aP(d.overscaledZ,g,t.z,h,t.y+1).key]={backfilled:!1},E[new i.aP(d.overscaledZ,d.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},E[new i.aP(d.overscaledZ,x,t.z,y,t.y+1).key]={backfilled:!1}),E}},"raster-array":vr,geojson:class extends i.E{constructor(d,t,o,h){super(),this.id=d,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=o.getActor(),this.setEventedParent(h),this._data=t.data,this._options=Object.assign({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;let g=i.al/this.tileSize;this.workerOptions=Object.assign({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*g,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*g,extent:i.al,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:i.al,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*g,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(d){this.map=d,this.setData(this._data)}setData(d){return this._data=d,this._updateWorkerData(),this}updateData(d){if(!this._options.dynamic)return this.fire(new i.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof d!="string"&&(d.type==="Feature"&&(d={type:"FeatureCollection",features:[d]}),d.type!=="FeatureCollection"))return this.fire(new i.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof d!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){let t=new Map;for(let o of this._data.features)t.set(o.id,o);for(let o of d.features)t.set(o.id,o);this._data.features=[...t.values()]}else this._data=d;return this._updateWorkerData(!0),this}getClusterExpansionZoom(d,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:d,source:this.id,scope:this.scope},t),this}getClusterChildren(d,t){return this.actor.send("geojson.getClusterChildren",{clusterId:d,source:this.id,scope:this.scope},t),this}getClusterLeaves(d,t,o,h){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:d,limit:t,offset:o},h),this}_updateWorkerData(d=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new i.z("dataloading",{dataType:"source"})),this._loaded=!1;let t=Object.assign({append:d},this.workerOptions);t.scope=this.scope;let o=this._data;typeof o=="string"?(t.request=this.map._requestManager.transformRequest(i.o.resolveURL(o),i.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(o),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(h,g)=>{if(this._loaded=!0,this._pendingLoad=null,h)this.fire(new i.y(h));else{let y={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&g&&g.resourceTiming&&g.resourceTiming[this.id]&&(y.resourceTiming=g.resourceTiming[this.id]),d&&(this._partialReload=!0),this.fire(new i.z("data",y)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(d),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let d=i.B(this.id,this.scope);this.map.style.clearSource(d),this._updateWorkerData()}loadTile(d,t){let o=d.actor?"reloadTile":"loadTile";d.actor=this.actor;let h=this.map.style?this.map.style.getLut(this.scope):null,g=h?{image:h.image.clone()}:null,y=this._partialReload,x={type:this.type,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:g,scope:this.scope,pixelRatio:i.o.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:d.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:y,worldview:this.map.getWorldview(),indoor:this.map.indoor?this.map.indoor.getIndoorTileOptions(this.id,this.scope):null};d.request=this.actor.send(o,x,(E,T)=>y&&!T?(d.state="loaded",t(null)):(delete d.request,d.destroy(),d.aborted?t(null):E?t(E):(d.loadVectorData(T,this.map.painter,o==="reloadTile"),t(null))),void 0,o==="loadTile")}abortTile(d){d.request&&(d.request.cancel(),delete d.request),d.aborted=!0}unloadTile(d,t){this.actor.send("removeTile",{uid:d.uid,type:this.type,source:this.id,scope:this.scope}),d.destroy()}onRemove(d){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Object.assign({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends i.aT{constructor(d,t,o,h){super(d,t,o,h),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;let d=this.options;this.urls=[];for(let t of d.urls)this.urls.push(this.map._requestManager.transformRequest(t,i.R.Source).url);i.aU(this.urls,(t,o)=>{this._loaded=!0,t?this.fire(new i.y(t)):o&&(this.video=o,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(d){if(this.video){let t=this.video.seekable;d<t.start(0)||d>t.end(0)?this.fire(new i.y(new i.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=d}}getVideo(){return this.video}onAdd(d){this.map||(this.map=d,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;let d=this.map.painter.context,t=d.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new i.T(d,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(d)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:i.aT,model:i.aW,"batched-model":class extends i.E{constructor(d,t,o,h){super(),this.type="batched-model",this.id=d,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=o,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(h)}onAdd(d){this.map=d,this.load()}reload(){this.cancelTileJSONRequest();let d=i.B(this.id,this.scope);this.load(()=>this.map.style.clearSource(d))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(d){this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"}));let t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,o=this.map.getWorldview();this._tileJSONRequest=Yn(this._options,this.map._requestManager,t,o,(h,g)=>{this._tileJSONRequest=null,this._loaded=!0,h?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),o&&o.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${o}`),this.fire(new i.y(h))):g&&(Object.assign(this,g),g.bounds&&(this.tileBounds=new mr(g.bounds,this.minzoom,this.maxzoom)),ms(g.tiles,this.map._requestManager._customAccessToken),this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))),d&&d(h)})}hasTransition(){return!1}hasTile(d){return!this.tileBounds||this.tileBounds.contains(d.canonical)}loaded(){return this._loaded}loadTile(d,t){let o=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme)),h={request:this.map._requestManager.transformRequest(o,i.R.Tile),data:void 0,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,tileSize:this.tileSize*d.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:d.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:i.o.devicePixelRatio,promoteId:this.promoteId};if(d.actor&&d.state!=="expired")if(d.state==="loading")d.reloadCallback=t;else{if(d.buckets){let y=Object.values(d.buckets);for(let x of y)x.dirty=!0;return void(d.state="loaded")}d.request=d.actor.send("reloadTile",h,g.bind(this))}else d.actor=this.dispatcher.getActor(),d.request=d.actor.send("loadTile",h,g.bind(this),void 0,!0);function g(y,x){return d.aborted?t(null):y&&y.status!==404?t(y):(this.map._refreshExpiredTiles&&x&&d.setExpiryData(x),d.loadModelData(x,this.map.painter),d.state="loaded",void t(null))}}serialize(){return Object.assign({},this._options)}},canvas:class extends i.aT{constructor(d,t,o,h){super(d,t,o,h),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(g=>!Array.isArray(g)||g.length!==2||g.some(y=>typeof y!="number"))||this.fire(new i.y(new i.V(`sources.${d}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new i.y(new i.V(`sources.${d}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new i.y(new i.V(`sources.${d}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new i.y(new i.V(`sources.${d}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new i.y(new i.V(`sources.${d}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new i.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(d){this.map=d,this.load(),this.canvas&&this.animate&&this.play()}onRemove(d){this.pause()}prepare(){let d=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,d=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,d=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;let t=this.map.painter.context;this.texture?!d&&!this._playing||this.texture instanceof i.aV||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new i.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let d of[this.canvas.width,this.canvas.height])if(isNaN(d)||d<=0)return!0;return!1}},custom:class extends i.E{constructor(d,t,o,h){super(),this.id=d,this.type="custom",this._dataType="raster",this._dispatcher=o,this._implementation=t,this.setEventedParent(h),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new i.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new i.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new mr(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Object.assign(this,i.aH(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return i.aH(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new i.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(d){this.map=d,this._loaded=!1,this.fire(new i.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(d),this.load()}onRemove(d){this._implementation.onRemove&&this._implementation.onRemove(d)}hasTile(d){if(this._implementation.hasTile){let{x:t,y:o,z:h}=d.canonical;return this._implementation.hasTile({x:t,y:o,z:h})}return!this.tileBounds||this.tileBounds.contains(d.canonical)}loadTile(d,t){let{x:o,y:h,z:g}=d.tileID.canonical,y=new AbortController;d.request=Promise.resolve(this._implementation.loadTile({x:o,y:h,z:g},{signal:y.signal})).then((function(x){return delete d.request,d.aborted?(d.state="unloaded",t(null)):x===void 0?(d.state="errored",t(null)):x===null?(this.loadTileData(d,{width:this.tileSize,height:this.tileSize,data:null}),d.state="loaded",t(null)):(function(E){return E instanceof ImageData||E instanceof HTMLCanvasElement||E instanceof ImageBitmap||E instanceof HTMLImageElement})(x)?(this.loadTileData(d,x),d.state="loaded",void t(null)):(d.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(x=>{x.name!=="AbortError"&&(d.state="errored",t(x))}),d.request.cancel=()=>y.abort()}loadTileData(d,t){d.setTexture(t,this.map.painter)}unloadTile(d,t){if(d.texture&&d.texture instanceof i.T?(d.destroy(!0),d.texture&&d.texture instanceof i.T&&this.map.painter.saveTileTexture(d.texture)):d.destroy(),this._implementation.unloadTile){let{x:o,y:h,z:g}=d.tileID.canonical;this._implementation.unloadTile({x:o,y:h,z:g})}t&&t()}abortTile(d,t){d.request&&d.request.cancel&&(d.request.cancel(),delete d.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(d=>({x:d.canonical.x,y:d.canonical.y,z:d.canonical.z}))}_clearTiles(){let d=i.B(this.id,this.scope);this.map.style.clearSource(d)}_update(){this.fire(new i.z("data",{dataType:"source",sourceDataType:"content"}))}}},uo=function(d,t,o,h){let g=new ys[t.type](d,t,o,h);if(g.id!==d)throw new Error(`Expected Source id to be ${d} instead of ${g.id}`);return i.aX(["load","abort","unload","serialize","prepare"],g),g};function Us(d,t,o=""){return`${o}:${t.id||""}:${t.layer.id}:${(function(h){if("layerId"in h)return`layer:${h.layerId}`;{let{featuresetId:g,importId:y}=h;return`featureset:${g}${y?`:import:${y}`:""}`}})(d.target)}`}function Oo(d,t,o,h=""){if(d.uniqueFeatureID){let g=Us(d,t,h);if(o.has(g))return!0;o.add(g)}return!1}function Lo(d,t,o,h,g=!1){let y=t.sourceCache.transform,x=t.sourceCache.tilesIn(d,t.has3DLayers,g);x.sort(wd);let E=[];for(let T of x){let A=T.tile.queryRenderedFeatures(t,T,o,h,y,g);Object.keys(A).length&&E.push({wrappedTileID:T.tile.tileID.wrapped().key,queryResults:A})}for(let T in t.layers){let A=t.layers[T];if(A.styleLayer){let M=A.styleLayer.queryRenderedFeatures(d,t.sourceCache,h);Object.keys(M).length&&E.push({wrappedTileID:0,queryResults:M})}}return E.length===0?{}:(function(T){let A={},M={};for(let L of T){let R=L.queryResults,F=L.wrappedTileID,z=M[F]=M[F]||{};for(let j in R){let q=R[j],$=z[j]=z[j]||{},Z=A[j]=A[j]||[];for(let J of q)$[J.featureIndex]||($[J.featureIndex]=!0,Z.push(J))}}return A})(E)}function cf(d,t,o,h,g,y){let x={},E=h.queryRenderedSymbols(d),T=[];for(let A of Object.keys(E).map(Number))T.push(g[A]);T.sort(wd);for(let A of T){let M=A.featureIndex.lookupSymbolFeatures(E[A.bucketInstanceId],A.bucketIndex,A.sourceLayerIndex,t,o,y);for(let L in M){let R=x[L]=x[L]||[],F=M[L];F.sort((z,j)=>{let q=A.featureSortOrder;if(q){let $=q.indexOf(z.featureIndex);return q.indexOf(j.featureIndex)-$}return j.featureIndex-z.featureIndex});for(let z of F)R.push(z)}}return x}function bd(d,t){let o=d.getRenderableIds().map(y=>d.getTileByID(y)),h=[],g={};for(let y=0;y<o.length;y++){let x=o[y],E=x.tileID.canonical.key;g[E]||(g[E]=!0,x.querySourceFeatures(h,t))}return h}function wd(d,t){let o=d.tileID,h=t.tileID;return o.overscaledZ-h.overscaledZ||o.canonical.y-h.canonical.y||o.wrap-h.wrap||o.canonical.x-h.canonical.x}function Ed(d,t){let o={};if(!t)return o;for(let h of d){let g=h.layerIds.map(y=>t.getLayer(y)).filter(Boolean);if(g.length!==0){h.layers=g,h.stateDependentLayerIds&&(h.stateDependentLayers=h.stateDependentLayerIds.map(y=>g.filter(x=>x.id===y)[0]));for(let y of g)o[y.fqid]=h}}return o}let wo=32,Hs=33,ho=new Uint16Array(8184);for(let d=0;d<2046;d++){let t=d+2,o=0,h=0,g=0,y=0,x=0,E=0;for(1&t?g=y=x=wo:o=h=E=wo;(t>>=1)>1;){let A=o+g>>1,M=h+y>>1;1&t?(g=o,y=h,o=x,h=E):(o=g,h=y,g=x,y=E),x=A,E=M}let T=4*d;ho[T+0]=o,ho[T+1]=h,ho[T+2]=g,ho[T+3]=y}let Wo=new Uint16Array(2178),Ma=new Uint8Array(1089),Kl=new Uint16Array(1089);function uf(d){return d===0?-.03125:d===32?.03125:0}let df={type:2,extent:i.al,loadGeometry:()=>[[new i.P(0,0),new i.P(i.al+1,0),new i.P(i.al+1,i.al+1),new i.P(0,i.al+1),new i.P(0,0)]]};class ua{constructor(t,o,h,g,y,x){this.tileID=t,this.uid=i.b1(),this.uses=0,this.tileSize=o,this.tileZoom=h,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=y,g&&g.style&&(this._lastUpdatedBrightness=g.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",g&&g.transform&&(this.projection=g.transform.projection),this.worldview=x,this._hasAppearances=null}registerFadeDuration(t){let o=t+this.timeAdded;o<i.o.now()||this.fadeEndTime&&o<this.fadeEndTime||(this.fadeEndTime=o)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=i.aY(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,o,h){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=Ed(t.buckets,o.style),this.hasSymbolBuckets=!1;for(let g in this.buckets){let y=this.buckets[g];if(y instanceof i.b3){if(this.hasSymbolBuckets=!0,!h)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let g in this.buckets){let y=this.buckets[g];if(y instanceof i.b3&&y.hasRTLText){this.hasRTLText=!0,i.b4();break}}this.queryPadding=0;for(let g in this.buckets){let y=this.buckets[g],x=o.style.getOwnLayer(g);if(!x)continue;let E=x.queryRadius(y);this.queryPadding=Math.max(this.queryPadding,E)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new i.b2}unloadVectorData(){if(this.hasData()){for(let t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,o,h){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,Ed(t.buckets,o.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t,o){for(let y in this.buckets){let x=this.buckets[y];if(x.uploadPending()){let E={},T=[],A={zoom:0,pitch:0,brightness:0,worldview:""};if(o){if(o.style){T=o.style.listImages();let M=x.layers[0],L=M.sourceLayer||"_geojsonTileLayer",R=o.style.getLayerSourceCache(M);R&&(E=R._state.getState(L,void 0))}A={zoom:o.transform.zoom||0,pitch:o.transform.pitch||0,brightness:o.style.getBrightness()||0,worldview:o.worldview||""}}x.upload(t,this.tileID.canonical,E,T,A)}}let h=t.gl,g=this.imageAtlas;g&&!g.uploaded&&(this.imageAtlasTexture=new i.T(t,g.image,h.RGBA8,{useMipmap:!!g.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new i.T(t,this.glyphAtlasImage,h.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new i.T(t,this.lineAtlas.image,h.R8),this.lineAtlas.uploaded=!0)}prepare(t,o,h){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,h),!o||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let g=o.style.getBrightness();this._hasAppearances===null&&(this._hasAppearances=this.hasAppearances(o)),(this._lastUpdatedBrightness||g||this._hasAppearances)&&(!this._hasAppearances&&this._lastUpdatedBrightness&&g&&Math.abs(this._lastUpdatedBrightness-g)<.001||(this.updateBuckets(o,this._lastUpdatedBrightness!==g),this._lastUpdatedBrightness=g))}evaluateQueryRenderedFeaturePadding(){let t=0;for(let o in this.buckets){let h=this.buckets[o];h.evaluateQueryRenderedFeaturePadding&&(t=Math.max(t,h.evaluateQueryRenderedFeaturePadding()))}return t}queryRenderedFeatures(t,o,h,g,y,x){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let E=this.evaluateQueryRenderedFeaturePadding(),T=(function(A,M){let L=i.bp([],[.5*A.width,.5*-A.height,1]);return i.bq(L,L,[1,-1,0]),i.aB(L,L,A.calculateProjMatrix(M.toUnwrapped())),Float32Array.from(L)})(y,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:o,pixelPosMatrix:T,transform:g,availableImages:h,tileTransform:this.tileTransform,worldview:this.worldview,queryRadius:E})}querySourceFeatures(t,o){let h=this.latestFeatureIndex;if(!h||!h.rawTileData)return;let g=h.loadVTLayers(),y=o?o.sourceLayer:"",x=g._geojsonTileLayer||g[y];if(!x)return;let E=i.b5(o&&o.filter),{z:T,x:A,y:M}=this.tileID.canonical,L={z:T,x:A,y:M};for(let R=0;R<x.length;R++){let F=x.feature(R);if(E.needGeometry){let q=i.b6(F,!0);if(!E.filter(new i.ac(this.tileID.overscaledZ,{worldview:this.worldview}),q,this.tileID.canonical))continue}else if(!E.filter(new i.ac(this.tileID.overscaledZ,{worldview:this.worldview}),F))continue;let z=h.getId(F,y),j=new i.b7(F,T,A,M,z);j.tile=L,t.push(j)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){let o=this.expirationTime;if(t.cacheControl){let h=i.b8(t.cacheControl);h["max-age"]&&(this.expirationTime=Date.now()+1e3*h["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){let h=Date.now(),g=!1;if(this.expirationTime>h)g=!1;else if(o)if(this.expirationTime<o)g=!0;else{let y=this.expirationTime-o;y?this.expirationTime=h+Math.max(y,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}hasAppearances(t){for(let o in this.buckets)if(t.style.hasLayer(o)&&this.buckets[o].layers.some(h=>h.appearances&&h.appearances.length>0))return!0;return!1}updateBuckets(t,o){if(!this.latestFeatureIndex||!t.style)return;let h=this.latestFeatureIndex.loadVTLayers(),g=t.style.listImages(),y=t.style.getBrightness();for(let x in this.buckets){if(!t.style.hasLayer(x))continue;let E=this.buckets[x],T=E.layers[0],A=T.sourceLayer||"_geojsonTileLayer",M=h[A],L=t.style.getLayerSourceCache(T),R={};L&&(R=L._state.getState(A,void 0));let F=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},z=Object.keys(R).length>0&&!o;if(E.hasAppearances=E.layers.some(q=>q.appearances&&q.appearances.length>0),(z&&E.stateDependentLayers.length!==0||o)&&E.update(R,M,g,F,z?E.stateDependentLayers:E.layers,o,y),z&&E.stateDependentLayers.length!==0||o||E.hasAppearances){let q={zoom:t.transform.zoom,pitch:t.transform.pitch,brightness:t.style.getBrightness()||0,worldview:t.worldview};E.updateAppearances(this.tileID.canonical,R,g,q)}(E instanceof i.b9||E instanceof i.ba)&&t._terrain&&t._terrain.enabled&&L&&E.uploadPending()&&t._terrain._clearRenderCacheForTile(L.id,this.tileID);let j=t&&t.style&&t.style.getOwnLayer(x);j&&(this.queryPadding=Math.max(this.queryPadding,j.queryRadius(E)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<i.o.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=i.o.now()+t}setTexture(t,o){let h=o.context,g=h.gl;this.texture=this.texture||o.getTileTexture(t.width),this.texture&&this.texture instanceof i.T?this.texture.update(t):(this.texture=new i.T(h,t,g.RGBA8,{useMipmap:!0}),this.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE))}setDependencies(t,o){let h={};for(let g of o)h[g]=!0;this.dependencies[t]=h}hasDependency(t,o){for(let h of t){let g=this.dependencies[h];if(g){for(let y of o)if(g[y])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,o){if(!o||o.name==="mercator"||this._tileDebugBuffer)return;let h=i.bb(df,this.tileID.canonical,this.tileTransform)[0],g=new i.bc,y=new i.bd;for(let x=0;x<h.length;x++){let{x:E,y:T}=h[x];g.emplaceBack(E,T),y.emplaceBack(x)}y.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(y),this._tileDebugBuffer=t.createVertexBuffer(g,i.be.members),this._tileDebugSegments=i.bf.simpleSegment(0,0,g.length,y.length)}_makeTileBoundsBuffers(t,o){if(this._tileBoundsBuffer||!o||o.name==="mercator")return;let h=i.bb(df,this.tileID.canonical,this.tileTransform)[0],g,y;if(this.isRaster){let x=(function(E,T){let A=i.aY(E,T),M=Math.pow(2,E.z);for(let q=0;q<Hs;q++)for(let $=0;$<Hs;$++){let Z=i.aZ((E.x+($+uf($))/wo)/M),J=i.a_((E.y+(q+uf(q))/wo)/M),Y=T.project(Z,J),ae=q*Hs+$;Wo[2*ae+0]=Math.round((Y.x*A.scale-A.x)*i.al),Wo[2*ae+1]=Math.round((Y.y*A.scale-A.y)*i.al)}Ma.fill(0),Kl.fill(0);for(let q=2045;q>=0;q--){let $=4*q,Z=ho[$+0],J=ho[$+1],Y=ho[$+2],ae=ho[$+3],Q=Z+Y>>1,ce=J+ae>>1,se=Q+ce-J,ie=ce+Z-Q,ue=J*Hs+Z,be=ae*Hs+Y,ye=ce*Hs+Q,Pe=Math.hypot((Wo[2*ue+0]+Wo[2*be+0])/2-Wo[2*ye+0],(Wo[2*ue+1]+Wo[2*be+1])/2-Wo[2*ye+1])>=16;Ma[ye]=Ma[ye]||(Pe?1:0),q<1022&&(Ma[ye]=Ma[ye]||Ma[(J+ie>>1)*Hs+(Z+se>>1)]||Ma[(ae+ie>>1)*Hs+(Y+se>>1)])}let L=new i.a$,R=new i.b0,F=0;function z(q,$){let Z=$*Hs+q;return Kl[Z]===0&&(L.emplaceBack(Wo[2*Z+0],Wo[2*Z+1],q*i.al/wo,$*i.al/wo),Kl[Z]=++F),Kl[Z]-1}function j(q,$,Z,J,Y,ae){let Q=q+Z>>1,ce=$+J>>1;if(Math.abs(q-Y)+Math.abs($-ae)>1&&Ma[ce*Hs+Q])j(Y,ae,q,$,Q,ce),j(Z,J,Y,ae,Q,ce);else{let se=z(q,$),ie=z(Z,J),ue=z(Y,ae);R.emplaceBack(se,ie,ue)}}return j(0,0,wo,wo,wo,0),j(wo,wo,0,0,0,wo),{vertices:L,indices:R}})(this.tileID.canonical,o);g=x.vertices,y=x.indices}else{g=new i.a$,y=new i.b0;for(let{x:E,y:T}of h)g.emplaceBack(E,T,0,0);let x=i.bg(g.int16.subarray(0,4*g.length),void 0,4);for(let E=0;E<x.length;E+=3)y.emplaceBack(x[E],x[E+1],x[E+2])}this._tileBoundsBuffer=t.createVertexBuffer(g,i.bh.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(y),this._tileBoundsSegments=i.bf.simpleSegment(0,0,g.length,y.length)}_makeGlobeTileDebugBuffers(t,o){let h=o.projection;if(!h||h.name!=="globe"||o.freezeTileCoverage)return;let g=this.tileID.canonical,y=i.bi(g,o),x=i.bj(y),E=i.aj(o.zoom),T;E>0&&(T=i.bk(new Float64Array(16),o.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,g,o,x,T,E),this._makeGlobeTileDebugTextBuffer(t,g,o,x,T,E)}_globePoint(t,o,h,g,y,x,E){let T=i.bl(t,o,h);if(x){let A=1<<h.z,M=i.aF(g.center.lng),L=i.aJ(g.center.lat),R=(h.x+.5)/A-M,F=0;R>.5?F=-1:R<-.5&&(F=1);let z=(t/i.al+h.x)/A+F,j=(o/i.al+h.y)/A;z=(z-M)*g._pixelsPerMercatorPixel+M,j=(j-L)*g._pixelsPerMercatorPixel+L;let q=[z*g.worldSize,j*g.worldSize,0];i.af(q,q,x),T=i.bm(T,q,E)}return i.af(T,T,y)}_makeGlobeTileDebugBorderBuffer(t,o,h,g,y,x){let E=new i.bc,T=new i.bd,A=new i.bn,M=(R,F,z,j,q)=>{let $=(z-R)/(q-1),Z=(j-F)/(q-1),J=E.length;for(let Y=0;Y<q;Y++){let ae=R+Y*$,Q=F+Y*Z;E.emplaceBack(ae,Q);let ce=this._globePoint(ae,Q,o,h,g,y,x);A.emplaceBack(ce[0],ce[1],ce[2]),T.emplaceBack(J+Y)}},L=i.al;M(0,0,L,0,16),M(L,0,L,L,16),M(L,L,0,L,16),M(0,L,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(T),this._tileDebugBuffer=t.createVertexBuffer(E,i.be.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(A,i.bo.members),this._tileDebugSegments=i.bf.simpleSegment(0,0,E.length,T.length)}_makeGlobeTileDebugTextBuffer(t,o,h,g,y,x){let E=i.al/4,T=new i.bc,A=new i.b0,M=new i.bn,L=25;A.reserve(32),T.reserve(L),M.reserve(L);let R=(F,z)=>L*F+z;for(let F=0;F<L;F++){let z=F*E;for(let j=0;j<L;j++){let q=j*E;T.emplaceBack(q,z);let $=this._globePoint(q,z,o,h,g,y,x);M.emplaceBack($[0],$[1],$[2])}}for(let F=0;F<4;F++)for(let z=0;z<4;z++){let j=R(F,z),q=R(F,z+1),$=R(F+1,z),Z=R(F+1,z+1);A.emplaceBack(j,q,$),A.emplaceBack($,q,Z)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(A),this._tileDebugTextBuffer=t.createVertexBuffer(T,i.be.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(M,i.bo.members),this._tileDebugTextSegments=i.bf.simpleSegment(0,0,L,32)}destroy(t=!1){for(let o in this.buckets)this.buckets[o].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof i.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}i.br.setPbf(i.bs);class dl extends ua{constructor(t,o,h,g,y){super(t,o,h,g,y),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._taskQueue=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,o,h){let g=h.context,y=g.gl,x=this.texturePerLayer.get(t)||h.getTileTexture(o.width);x&&x instanceof i.T?x.update(o,{premultiply:!1}):x=new i.T(g,o,y.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,x)}flushQueues(t){let o=this._workQueuePerLayer.get(t)||[],h=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()();for(;h.length;)h.pop()()}flushAllQueues(){for(let t of this._workQueuePerLayer.keys()){let o=this._workQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}for(let t of this._fetchQueuePerLayer.keys()){let o=this._fetchQueuePerLayer.get(t)||[];for(;o.length;)o.pop()()}}fetchHeader(t=16384,o){let h=this._mrt=new i.br(30),g=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=i.bt(g,(y,x,E)=>{if(y)o(y);else try{let T=h.getHeaderLength(x);if(T>t)return void(this.request=this.fetchHeader(T,o));h.parseHeader(x),this._isHeaderLoaded=!0;let A=0;for(let M of Object.values(h.layers))A=Math.max(A,M.dataIndex[M.dataIndex.length-1].lastByte);x.byteLength>=A&&(this.entireBuffer=x),o(null,this.entireBuffer||x,E)}catch(T){o(T)}}),this.request}fetchBandForRender(t,o,h,g){this.fetchBand(t,o,h,y=>{if(y)return void g(y);this.updateTextureDescriptor(t,o,h);let x=this.textureDescriptorPerLayer.get(o);g(null,x?x.img:null)})}fetchBand(t,o,h,g,y=!0){let x=this._mrt;if(!this._isHeaderLoaded||!x)return void g(new Error("Tile header is not ready"));let E=this.actor;if(!E)return void g(new Error("Can't fetch tile band without an actor"));let T,A=i.B(String(h),i.B(this.tileID.key,t)),M=this._taskQueue.get(A);M?M.add(g):(M=new Set,M.add(g),this._taskQueue.set(A,M));let L=(j,q)=>{T.complete(j,q),j?g(j):(M.values().forEach($=>$(null,q)),this._taskQueue.delete(A))},R=(j,q)=>{if(j)return g(j);let $=E.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:q,task:T},L,void 0,!0);if(o!==null){let Z=this._workQueuePerLayer.get(o)||[];Z.push(()=>{$&&$.cancel(),T.cancel()}),this._workQueuePerLayer.has(o)||this._workQueuePerLayer.set(o,Z)}},F;try{F=x.getLayer(t)}catch(j){if(this.state==="reloading")return;throw j}if(!F)return void g(new Error(`Unknown sourceLayer "${t}"`));if(F.hasDataForBand(h))return M.values().forEach(j=>j(null,null)),void this._taskQueue.delete(A);let z=F.getDataRange([h]);if(T=x.createDecodingTask(z),!T||T.tasks.length)if(o!==null&&this.flushQueues(o),this.entireBuffer)R(null,this.entireBuffer.slice(z.firstByte,z.lastByte+1));else{let j=Object.assign({},this.requestParams,{headers:{Range:`bytes=${z.firstByte}-${z.lastByte}`}}),q=i.bt(j,R);if(o!==null){let $=this._fetchQueuePerLayer.get(o)||[];$.push(()=>{q.cancel(),T.cancel()}),this._fetchQueuePerLayer.has(o)||this._fetchQueuePerLayer.set(o,$)}}}updateNeeded(t,o){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==o||this.refreshedUponExpiration)&&this.state!=="errored"}updateTextureDescriptor(t,o,h){if(!this._mrt)return;let g=this._mrt.getLayer(t);if(!g||!g.hasBand(h)||!g.hasDataForBand(h))return;let{bytes:y,tileSize:x,buffer:E,offset:T,scale:A}=g.getBandView(h),M=x+2*E,L=new i.q({width:M,height:M},y),R=this.texturePerLayer.get(o);R&&R instanceof i.T&&R.update(L,{premultiply:!1}),this.textureDescriptorPerLayer.set(o,{layer:t,band:h,img:L,buffer:E,offset:T,tileSize:x,format:g.pixelFormat,mix:[A,256*A,65536*A,16777216*A]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(let o of this.texturePerLayer.values())o&&o instanceof i.T&&o.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class qm{constructor(t,o){this.max=t,this.onRemove=o,this.reset()}reset(){for(let t in this.data)for(let o of this.data[t])o.timeout&&clearTimeout(o.timeout),this.onRemove(o.value);return this.data={},this.order=[],this}add(t,o,h){let g=t.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);let y={value:o,timeout:void 0};if(h!==void 0&&(y.timeout=setTimeout(()=>{this.remove(t,y)},h)),this.data[g].push(y),this.order.push(g),this.order.length>this.max){let x=this._getAndRemoveByKey(this.order[0]);x&&this.onRemove(x)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){let o=this.data[t].shift();return o.timeout&&clearTimeout(o.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),o.value}getByKey(t){let o=this.data[t];return o?o[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,o){if(!this.has(t))return this;let h=t.wrapped().key,g=o===void 0?0:this.data[h].indexOf(o),y=this.data[h][g];return this.data[h].splice(g,1),y.timeout&&clearTimeout(y.timeout),this.data[h].length===0&&delete this.data[h],this.onRemove(y.value),this.order.splice(this.order.indexOf(h),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){let o=this._getAndRemoveByKey(this.order[0]);o&&this.onRemove(o)}return this}filter(t){let o=[];for(let h in this.data)for(let g of this.data[h])t(g.value)||o.push(g);for(let h of o)this.remove(h.value.tileID,h)}}class Ev{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,o,h){let g=String(o);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][g]=this.stateChanges[t][g]||{},Object.assign(this.stateChanges[t][g],h),this.deletedStates[t]===null){this.deletedStates[t]={};for(let y in this.state[t])y!==g&&(this.deletedStates[t][y]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][g]===null){this.deletedStates[t][g]={};for(let y in this.state[t][g])h[y]||(this.deletedStates[t][g][y]=null)}else for(let y in h)this.deletedStates[t]&&this.deletedStates[t][g]&&this.deletedStates[t][g][y]===null&&delete this.deletedStates[t][g][y]}removeFeatureState(t,o,h){if(this.deletedStates[t]===null)return;let g=String(o);if(this.deletedStates[t]=this.deletedStates[t]||{},h&&o!==void 0)this.deletedStates[t][g]!==null&&(this.deletedStates[t][g]=this.deletedStates[t][g]||{},this.deletedStates[t][g][h]=null);else if(o!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][g])for(h in this.deletedStates[t][g]={},this.stateChanges[t][g])this.deletedStates[t][g][h]=null;else this.deletedStates[t][g]=null;else this.deletedStates[t]=null}getState(t,o){let h=this.state[t]||{},g=this.stateChanges[t]||{},y=this.deletedStates[t];if(y===null)return{};if(o!==void 0){let E=String(o),T=Object.assign({},h[E],g[E]);if(y){let A=y[o];if(A===null)return{};for(let M in A)delete T[M]}return T}let x=Object.assign({},h,g);if(y)for(let E in y)delete x[E];return x}initializeTileState(t,o){t.refreshFeatureState(o)}coalesceChanges(t,o){let h={};for(let g in this.stateChanges){this.state[g]=this.state[g]||{};let y={};for(let x in this.stateChanges[g])this.state[g][x]||(this.state[g][x]={}),Object.assign(this.state[g][x],this.stateChanges[g][x]),y[x]=this.state[g][x];h[g]=y}for(let g in this.deletedStates){this.state[g]=this.state[g]||{};let y={};if(this.deletedStates[g]===null)for(let x in this.state[g])y[x]={},this.state[g][x]={};else for(let x in this.deletedStates[g]){if(this.deletedStates[g][x]===null)this.state[g][x]={};else if(this.state[g][x])for(let E of Object.keys(this.deletedStates[g][x]))delete this.state[g][x][E];y[x]=this.state[g][x]}h[g]=h[g]||{},Object.assign(h[g],y)}if(this.stateChanges={},this.deletedStates={},Object.keys(h).length!==0)for(let g in t)t[g].refreshFeatureState(o)}}class vs extends i.E{constructor(t,o,h){super(),this.id=t,this._onlySymbols=h,o.on("data",g=>{g.dataType==="source"&&g.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&g.dataType==="source"&&g.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),o.on("error",()=>{this._sourceErrored=!0}),this._source=o,this._tiles={},this._cache=new qm(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=o.minTileCacheSize,this._maxTileCacheSize=o.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ev,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,o){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,o)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(let o in this._tiles){let h=this._tiles[o];h.upload(t,this.map?this.map.painter:void 0),h.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(t=>t.tileID).sort(Wm).map(t=>t.key)}getRenderableIds(t,o){let h=[];for(let g in this._tiles)this._isIdRenderable(+g,t,o)&&h.push(this._tiles[g]);return t?h.sort((g,y)=>{let x=g.tileID,E=y.tileID,T=new i.P(x.canonical.x,x.canonical.y)._rotate(this.transform.angle),A=new i.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return x.overscaledZ-E.overscaledZ||A.y-T.y||A.x-T.x}).map(g=>g.tileID.key):h.map(g=>g.tileID).sort(Wm).map(g=>g.key)}hasRenderableParent(t){let o=this.findLoadedParent(t,0);return!!o&&this._isIdRenderable(o.tileID.key)}_isIdRenderable(t,o,h){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(o||!this._tiles[t].holdingForFade())&&(h||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(let t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,o){let h=this._tiles[t];h&&(h.state!=="loading"&&(h.state=o),this._loadTile(h,this._tileLoaded.bind(this,h,t,o)))}_tileLoaded(t,o,h,g,y){if(g){if(t.state="errored",g.status!==404)this._source.fire(new i.y(g,{tile:t}));else{if(this._source.fire(new i.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){let E=this.map.painter.terrain;this.update(this.transform,E.getScaledDemTileSize(),!0),E.resetTileLookupCache(this.id)}else this.update(this.transform)}return}t.timeAdded=i.o.now(),h==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(o,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null);let x=new Map;y&&y.responseHeaders&&(x=y.responseHeaders),this._source.fire(new i.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id,responseHeaders:x}))}_backfillDEM(t){let o=this.getRenderableIds();for(let g=0;g<o.length;g++){let y=o[g];if(t.neighboringTiles&&t.neighboringTiles[y]){let x=this.getTileByID(y);h(t,x),h(x,t)}}function h(g,y){if(!g.dem||g.dem.borderReady)return;g.needsHillshadePrepare=!0,g.needsDEMTextureUpload=!0;let x=y.tileID.canonical.x-g.tileID.canonical.x,E=y.tileID.canonical.y-g.tileID.canonical.y,T=Math.pow(2,g.tileID.canonical.z),A=y.tileID.key;x===0&&E===0||Math.abs(E)>1||(Math.abs(x)>1&&(Math.abs(x+T)===1?x+=T:Math.abs(x-T)===1&&(x-=T)),y.dem&&g.dem&&(g.dem.backfillBorder(y.dem,x,E),g.neighboringTiles&&g.neighboringTiles[A]&&(g.neighboringTiles[A].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,o,h,g){for(let y in this._tiles){let x=this._tiles[y];if(g[y]||!x.hasData()||x.tileID.overscaledZ<=o||x.tileID.overscaledZ>h)continue;let E=x.tileID;for(;x&&x.tileID.overscaledZ>o+1;){let A=x.tileID.scaledTo(x.tileID.overscaledZ-1);x=this._tiles[A.key],x&&x.hasData()&&(E=A)}let T=E;for(;T.overscaledZ>o;)if(T=T.scaledTo(T.overscaledZ-1),t[T.key]){g[E.key]=E;break}}}findLoadedParent(t,o){if(t.key in this._loadedParentTiles){let h=this._loadedParentTiles[t.key];return h&&h.tileID.overscaledZ>=o?h:null}for(let h=t.overscaledZ-1;h>=o;h--){let g=t.scaledTo(h),y=this._getLoadedTile(g);if(y)return y}}_getLoadedTile(t){let o=this._tiles[t.key];return o&&o.hasData()?o:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,o){o=o||this._source.tileSize;let h=Math.ceil(t.width/o)+1,g=Math.ceil(t.height/o)+1,y=Math.floor(h*g*5),x=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,y):y,E=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,x):x;this._cache.setMaxSize(E)}handleWrapJump(t){let o=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,o){let h={};for(let g in this._tiles){let y=this._tiles[g];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+o),h[y.tileID.key]=y}this._tiles=h;for(let g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(let g in this._tiles)this._setTileReloadTimer(+g,this._tiles[g])}}update(t,o,h,g,y){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!h)return;this.updateCacheSize(t,o),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let x=this._source.type==="batched-model",E,T=this._source.maxzoom,A=this.map&&this.map.painter?this.map.painter._terrain:null;if(A&&A.sourceCache===this&&A.attenuationRange()){let R=A.attenuationRange()[0],F=Math.floor(R)-Math.log2(A.getDemUpscale());T>F&&(T=F)}if(this.used||this.usedForTerrain){if(this._source.tileID)E=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(R=>new i.aP(R.canonical.z,R.wrap,R.canonical.z,R.canonical.x,R.canonical.y));else if(this.tileCoverLift!==0){let R=t.clone();R.tileCoverLift=this.tileCoverLift,E=R.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:x}),this._source.minzoom<=1&&t.projection.name==="globe"&&(E.push(new i.aP(1,0,1,0,0)),E.push(new i.aP(1,0,1,1,0)),E.push(new i.aP(1,0,1,0,1)),E.push(new i.aP(1,0,1,1,1)))}else if(E=t.coveringTiles({tileSize:o||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:T,roundZoom:this._source.roundZoom&&!h,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:x}),this._source.hasTile){let R=this._source.hasTile.bind(this._source);E=E.filter(F=>R(F))}}else E=[];if(E.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Jl(this._source.type)){let R=t.coveringZoomLevel({tileSize:o||this._source.tileSize,roundZoom:this._source.roundZoom&&!h}),F=Math.min(R,this._source.maxzoom);if(x){let z=t.extendTileCover(E,F);for(let j of z)E.push(j)}else if(y){let z=t.extendTileCoverToNearPlane(E,this.transform.getFrustum(F),F);for(let j of z)E.push(j)}else if(this.castsShadows&&g){let z=t.extendTileCover(E,F,g);for(let j of z)this._shadowCasterTiles[j.key]=!0,E.push(j)}}let M=this._updateRetainedTiles(E);if(Jl(this._source.type)&&E.length!==0){let R={},F={},z=Object.keys(M);for(let q of z){let $=M[q],Z=this._tiles[q];if(!Z||Z.fadeEndTime&&Z.fadeEndTime<=i.o.now())continue;let J=this.findLoadedParent($,Math.max($.overscaledZ-vs.maxOverzooming,this._source.minzoom));J&&(this._addTile(J.tileID),R[J.tileID.key]=J.tileID),F[q]=$}let j=E[E.length-1].overscaledZ;for(let q in this._tiles){let $=this._tiles[q];if(M[q]||!$.hasData())continue;let Z=$.tileID;for(;Z.overscaledZ>j;){Z=Z.scaledTo(Z.overscaledZ-1);let J=this._tiles[Z.key];if(J&&J.hasData()&&F[Z.key]){M[q]=$.tileID;break}}}for(let q in R)M[q]||(this._coveredTiles[q]=!0,M[q]=R[q])}for(let R in M)this._tiles[R].clearFadeHold();let L=i.bu(this._tiles,M);for(let R of L){let F=this._tiles[R];F.hasSymbolBuckets&&!F.holdingForFade()?F.setHoldDuration(this.map._fadeDuration):F.hasSymbolBuckets&&!F.symbolFadeFinished()||this._removeTile(+R)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){let o={};if(t.length===0)return o;let h={},g=t.reduce((A,M)=>Math.min(A,M.overscaledZ),1/0),y=t[0].overscaledZ,x=Math.max(y-vs.maxOverzooming,this._source.minzoom),E=Math.max(y+vs.maxUnderzooming,this._source.minzoom),T={};for(let A of t){let M=this._addTile(A);o[A.key]=A,M.hasData()||g<this._source.maxzoom&&(T[A.key]=A)}this._retainLoadedChildren(T,g,E,o);for(let A of t){let M=this._tiles[A.key];if(M.hasData())continue;if(A.canonical.z>=this._source.maxzoom){let R=A.children(this._source.maxzoom)[0],F=this.getTile(R);if(F&&F.hasData()){o[R.key]=R;continue}}else{let R=A.children(this._source.maxzoom);if(o[R[0].key]&&o[R[1].key]&&o[R[2].key]&&o[R[3].key])continue}let L=M.wasRequested();for(let R=A.overscaledZ-1;R>=x;--R){let F=A.scaledTo(R);if(h[F.key]||(h[F.key]=!0,M=this.getTile(F),!M&&L&&(M=this._addTile(F)),M&&(o[F.key]=F,L=M.wasRequested(),M.hasData())))break}}return o}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(let t in this._tiles){let o=[],h,g=this._tiles[t].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){h=this._loadedParentTiles[g.key];break}o.push(g.key);let y=g.scaledTo(g.overscaledZ-1);if(h=this._getLoadedTile(y),h)break;g=y}for(let y of o)this._loadedParentTiles[y]=h}}_addTile(t){let o=this._tiles[t.key];if(o)return o.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),o;o=this._cache.getAndRemove(t),o&&(this._setTileReloadTimer(t.key,o),o.tileID=t,this._state.initializeTileState(o,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,o)));let h=!!o;if(!h){let g=this.map?this.map.painter:null,y=this._source.tileSize*t.overscaleFactor();o=this._source.type==="raster-array"?new dl(t,y,this.transform.tileZoom,g,this._isRaster):new ua(t,y,this.transform.tileZoom,g,this._isRaster,this._source.worldview),this._loadTile(o,this._tileLoaded.bind(this,o,t.key,o.state))}return o.uses++,this._tiles[t.key]=o,h||this._source.fire(new i.z("dataloading",{tile:o,coord:o.tileID,dataType:"source"})),o}_setTileReloadTimer(t,o){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);let h=o.getExpiryTimeout();h&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},h))}_removeTile(t){let o=this._tiles[t];o&&(o.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),o.uses>0||(o.hasData()&&o.state!=="reloading"||o.state==="empty"?this._cache.add(o.tileID,o,o.getExpiryTimeout()):(o.aborted=!0,this._abortTile(o),this._unloadTile(o))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(let t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,o,h){let g=[],y=this.transform;if(!y)return g;let x=y.projection.name==="globe",E=i.aF(y.center.lng);for(let T in this._tiles){let A=this._tiles[T];if(h&&A.clearQueryDebugViz(),A.holdingForFade())continue;let M;if(x){let L=A.tileID.canonical;if(L.z===0){let R=[Math.abs(i.aA(E,...Ql(L,-1))-E),Math.abs(i.aA(E,...Ql(L,1))-E)];M=[0,2*R.indexOf(Math.min(...R))-1]}else{let R=[Math.abs(i.aA(E,...Ql(L,-1))-E),Math.abs(i.aA(E,...Ql(L,0))-E),Math.abs(i.aA(E,...Ql(L,1))-E)];M=[R.indexOf(Math.min(...R))-1]}}else M=[0];for(let L of M){let R=t.containsTile(A,y,o,L);R&&g.push(R)}}return g}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,o){let h=this.getRenderableIds(t,o).map(y=>this._tiles[y].tileID),g=this.transform.projection.name==="globe";for(let y of h)y.projMatrix=this.transform.calculateProjMatrix(y.toUnwrapped()),y.expandedProjMatrix=g?this.transform.calculateProjMatrix(y.toUnwrapped(),!1,!0):y.projMatrix;return h}sortCoordinatesByDistance(t){let o=t.slice(),h=this.transform._camera.position,g=this.transform._camera.forward(),y={};for(let x of o){let E=1/(1<<x.canonical.z);y[x.key]=((x.canonical.x+.5)*E+x.wrap-h[0])*g[0]+((x.canonical.y+.5)*E-h[1])*g[1]-h[2]*g[2]}return o.sort((x,E)=>y[x.key]-y[E.key]),o}hasTransition(){if(this._source.hasTransition())return!0;if(Jl(this._source.type))for(let t in this._tiles){let o=this._tiles[t];if(o.fadeEndTime!==void 0&&o.fadeEndTime>=i.o.now())return!0}return!1}setFeatureState(t,o,h){this._state.updateState(t=t||"_geojsonTileLayer",o,h)}removeFeatureState(t,o,h){this._state.removeFeatureState(t=t||"_geojsonTileLayer",o,h)}getFeatureState(t,o){return this._state.getState(t=t||"_geojsonTileLayer",o)}setDependencies(t,o,h){let g=this._tiles[t];g&&g.setDependencies(o,h)}reloadTilesForDependencies(t,o){for(let h in this._tiles)this._tiles[h].hasDependency(t,o)&&this._reloadTile(+h,"reloading");this._cache.filter(h=>!h.hasDependency(t,o))}_preloadTiles(t,o){if(!this._sourceLoaded){let T=()=>{this._sourceLoaded&&(this._source.off("data",T),this._preloadTiles(t,o))};return void this._source.on("data",T)}let h=new Map,g=Array.isArray(t)?t:[t],y=this.map.painter.terrain,x=this.usedForTerrain&&y?y.getScaledDemTileSize():this._source.tileSize;for(let T of g){let A=T.coveringTiles({tileSize:x,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let M of A)h.set(M.key,M);this.usedForTerrain&&T.updateElevation(!1)}let E=Array.from(h.values());i.bv(E,(T,A)=>{let M=new ua(T,this._source.tileSize*T.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(M,L=>{this._source.type==="raster-dem"&&M.dem&&this._backfillDEM(M),A(L,M)})},o)}}function Wm(d,t){let o=Math.abs(2*d.wrap)-+(d.wrap<0),h=Math.abs(2*t.wrap)-+(t.wrap<0);return d.overscaledZ-t.overscaledZ||h-o||t.canonical.y-d.canonical.y||t.canonical.x-d.canonical.x}function Jl(d){return d==="raster"||d==="image"||d==="video"||d==="custom"}function Ql(d,t){let o=1<<d.z;return[d.x/o+t,(d.x+1)/o+t]}vs.maxOverzooming=10,vs.maxUnderzooming=3;class Zm{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];let t=!1,o=!1;for(let h in this.style._mergedLayers){let g=this.style._mergedLayers[h];if(g.type==="fill-extrusion"||g.type==="building")this.layers.push({layer:g,visible:t,visibilityChanged:o});else if(g.type==="model"){let y=this.style.getLayerSource(g);y&&y.type==="batched-model"&&this.layers.push({layer:g,visible:t,visibilityChanged:o})}}}onNewFrame(t){this.layersGotHidden=!1;for(let o of this.layers){let h=o.layer,g=!1;h.type==="fill-extrusion"?g=!h.isHidden(t)&&h.paint.get("fill-extrusion-opacity")>0:h.type==="building"?g=!h.isHidden(t)&&h.paint.get("building-opacity")>0:h.type==="model"&&(g=!h.isHidden(t)&&h.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!g&&o.visible,o.visible=g}}updateZOffset(t,o){this.currentBuildingBuckets=[];for(let g of this.layers){let y=g.layer,x=this.style.getLayerSourceCache(y),E=1;y.type==="fill-extrusion"?E=g.visible?y.paint.get("fill-extrusion-vertical-scale"):0:y.type==="building"&&(E=g.visible?y.paint.get("building-vertical-scale"):0);let T=x?x.getTile(o):null;if(!T&&x)for(let A in x._tiles){let M=x._tiles[A];if(o.canonical.isChildOf(M.tileID.canonical)){T=M;break}}this.currentBuildingBuckets.push({bucket:T?T.getBucket(y):null,tileID:T?T.tileID:o,verticalScale:E})}t.hasAnyZOffset=!1;let h=!1;for(let g=0;g<t.symbolInstances.length;g++){let y=t.symbolInstances.get(g),x=y.zOffset,E=this._getHeightAtTileOffset(o,y.tileAnchorX,y.tileAnchorY);y.zOffset=E!==Number.NEGATIVE_INFINITY?E:x,h||x===y.zOffset||(h=!0),t.hasAnyZOffset||y.zOffset===0||(t.hasAnyZOffset=!0)}h&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,o,h,g){let y=o,x=h;if(t.canonical.z!==g.canonical.z){let E=g.canonical,T=1/(1<<t.canonical.z-E.z);y=(o+t.canonical.x*i.al)*T-E.x*i.al|0,x=(h+t.canonical.y*i.al)*T-E.y*i.al|0}return{tileX:y,tileY:x}}_getHeightAtTileOffset(t,o,h){let g,y;for(let x=0;x<this.layers.length;++x){let E=this.layers[x].layer;if(E.type!=="fill-extrusion"&&E.type!=="building")continue;let{bucket:T,tileID:A,verticalScale:M}=this.currentBuildingBuckets[x];if(!T)continue;let{tileX:L,tileY:R}=this._mapCoordToOverlappingTile(t,o,h,A),F=T.getHeightAtTileCoord(L,R);F&&F.height!==void 0&&(F.hidden?g=F.height:y=Math.max(F.height*M,y||0))}if(y!==void 0)return y;for(let x=0;x<this.layers.length;++x){let E=this.layers[x];if(E.layer.type!=="model"||!E.visible)continue;let{bucket:T,tileID:A}=this.currentBuildingBuckets[x];if(!T)continue;let{tileX:M,tileY:L}=this._mapCoordToOverlappingTile(t,o,h,A),R=T.getHeightAtTileCoord(M,L);if(R&&!R.hidden)return R.height===void 0&&g!==void 0?Math.min(R.maxHeight,g)*R.verticalScale:R.height?R.height*R.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Td(d,t){let o={};for(let h in d)h!=="ref"&&(o[h]=d[h]);return i.bw.forEach(h=>{h in t&&(o[h]=t[h])}),o}function Zc(d){d=d.slice();let t=Object.create(null);for(let o=0;o<d.length;o++)t[d[o].id]=d[o];for(let o=0;o<d.length;o++)"ref"in d[o]&&(d[o]=Td(d[o],t[d[o].ref]));return d}let Pn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function Xm(d,t,o){o.push({command:Pn.addSource,args:[d,t[d]]})}function Id(d,t,o){t.push({command:Pn.removeSource,args:[d]}),o[d]=!0}function Sd(d,t,o,h){Id(d,o,h),Xm(d,t,o)}function Ym(d,t,o){let h;for(h in d[o])if(d[o].hasOwnProperty(h)&&h!=="data"&&!i.bx(d[o][h],t[o][h]))return!1;for(h in t[o])if(t[o].hasOwnProperty(h)&&h!=="data"&&!i.bx(d[o][h],t[o][h]))return!1;return!0}function Dd(d,t,o,h,g,y){let x;for(x in t=t||{},d=d||{})d.hasOwnProperty(x)&&(i.bx(d[x],t[x])||o.push({command:y,args:[h,x,t[x],g]}));for(x in t)t.hasOwnProperty(x)&&!d.hasOwnProperty(x)&&(i.bx(d[x],t[x])||o.push({command:y,args:[h,x,t[x],g]}))}function Cd(d){return d.id}function Ad(d,t){return d[t.id]=t,d}function ec(d,t,o){let h=t.createTileMatrix(d,d.worldSize,o.toUnwrapped());return i.aB(new Float32Array(16),d.projMatrix,h)}function Tv(d,t,o){if(t.projection.name===o.projection.name)return d.projMatrix;let h=o.clone();return h.setProjection(t.projection),ec(h,t.getProjection(),d)}function hf(d,t,o){return t.name===o.projection.name?d.projMatrix:ec(o,t,d)}class I1{constructor(t,o){this.reset(t,o)}reset(t,o){this.points=t||[],this._distances=[0];for(let h=1;h<this.points.length;h++)this._distances[h]=this._distances[h-1]+this.points[h].dist(this.points[h-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(o||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=i.aA(t,0,1);let o=1,h=this._distances[o],g=t*this.paddedLength+this.padding;for(;h<g&&o<this._distances.length;)h=this._distances[++o];let y=o-1,x=this._distances[y],E=h-x,T=E>0?(g-x)/E:0;return this.points[y].mult(1-T).add(this.points[o].mult(T))}}class Md{constructor(t,o,h){let g=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(t/h),this.yCellCount=Math.ceil(o/h);for(let x=0;x<this.xCellCount*this.yCellCount;x++)g.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=o,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/o,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,o,h,g,y){this._forEachCell(o,h,g,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(o),this.bboxes.push(h),this.bboxes.push(g),this.bboxes.push(y)}insertCircle(t,o,h,g){this._forEachCell(o-g,h-g,o+g,h+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(o),this.circles.push(h),this.circles.push(g)}_insertBoxCell(t,o,h,g,y,x){this.boxCells[y].push(x)}_insertCircleCell(t,o,h,g,y,x){this.circleCells[y].push(x)}_query(t,o,h,g,y,x){if(h<0||t>this.width||g<0||o>this.height)return!y&&[];let E=[];if(t<=0&&o<=0&&this.width<=h&&this.height<=g){if(y)return!0;for(let T=0;T<this.boxKeys.length;T++)E.push({key:this.boxKeys[T],x1:this.bboxes[4*T],y1:this.bboxes[4*T+1],x2:this.bboxes[4*T+2],y2:this.bboxes[4*T+3]});for(let T=0;T<this.circleKeys.length;T++){let A=this.circles[3*T],M=this.circles[3*T+1],L=this.circles[3*T+2];E.push({key:this.circleKeys[T],x1:A-L,y1:M-L,x2:A+L,y2:M+L})}return x?E.filter(x):E}return this._forEachCell(t,o,h,g,this._queryCell,E,{hitTest:y,seenUids:{box:{},circle:{}}},x),y?E.length>0:E}_queryCircle(t,o,h,g,y){let x=t-h,E=t+h,T=o-h,A=o+h;if(E<0||x>this.width||A<0||T>this.height)return!g&&[];let M=[];return this._forEachCell(x,T,E,A,this._queryCellCircle,M,{hitTest:g,circle:{x:t,y:o,radius:h},seenUids:{box:{},circle:{}}},y),g?M.length>0:M}query(t,o,h,g,y){return this._query(t,o,h,g,!1,y)}hitTest(t,o,h,g,y){return this._query(t,o,h,g,!0,y)}hitTestCircle(t,o,h,g){return this._queryCircle(t,o,h,!0,g)}_queryCell(t,o,h,g,y,x,E,T){let A=E.seenUids,M=this.boxCells[y];if(M!==null){let R=this.bboxes;for(let F of M)if(!A.box[F]){A.box[F]=!0;let z=4*F;if(t<=R[z+2]&&o<=R[z+3]&&h>=R[z+0]&&g>=R[z+1]&&(!T||T(this.boxKeys[F]))){if(E.hitTest)return x.push(!0),!0;x.push({key:this.boxKeys[F],x1:R[z],y1:R[z+1],x2:R[z+2],y2:R[z+3]})}}}let L=this.circleCells[y];if(L!==null){let R=this.circles;for(let F of L)if(!A.circle[F]){A.circle[F]=!0;let z=3*F;if(this._circleAndRectCollide(R[z],R[z+1],R[z+2],t,o,h,g)&&(!T||T(this.circleKeys[F]))){if(E.hitTest)return x.push(!0),!0;{let j=R[z],q=R[z+1],$=R[z+2];x.push({key:this.circleKeys[F],x1:j-$,y1:q-$,x2:j+$,y2:q+$})}}}}}_queryCellCircle(t,o,h,g,y,x,E,T){let A=E.circle,M=E.seenUids,L=this.boxCells[y];if(L!==null){let F=this.bboxes;for(let z of L)if(!M.box[z]){M.box[z]=!0;let j=4*z;if(this._circleAndRectCollide(A.x,A.y,A.radius,F[j+0],F[j+1],F[j+2],F[j+3])&&(!T||T(this.boxKeys[z])))return x.push(!0),!0}}let R=this.circleCells[y];if(R!==null){let F=this.circles;for(let z of R)if(!M.circle[z]){M.circle[z]=!0;let j=3*z;if(this._circlesCollide(F[j],F[j+1],F[j+2],A.x,A.y,A.radius)&&(!T||T(this.circleKeys[z])))return x.push(!0),!0}}}_forEachCell(t,o,h,g,y,x,E,T){let A=this._convertToXCellCoord(t),M=this._convertToYCellCoord(o),L=this._convertToXCellCoord(h),R=this._convertToYCellCoord(g);for(let F=A;F<=L;F++)for(let z=M;z<=R;z++)if(y.call(this,t,o,h,g,this.xCellCount*z+F,x,E,T))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,o,h,g,y,x){let E=g-t,T=y-o,A=h+x;return A*A>E*E+T*T}_circleAndRectCollide(t,o,h,g,y,x,E){let T=(x-g)/2,A=Math.abs(t-(g+T));if(A>T+h)return!1;let M=(E-y)/2,L=Math.abs(o-(y+M));if(L>M+h)return!1;if(A<=T||L<=M)return!0;let R=A-T,F=L-M;return R*R+F*F<=h*h}}let Zo={unknown:0,flipRequired:1,flipNotRequired:2},Rd=Math.tan(85*Math.PI/180);function Xc(d,t,o,h,g,y,x){let E=i.bB();if(o)if(y.name==="globe"){let T=i.bC(g,t);i.aB(E,E,T)}else{let T=i.bD([],x);E[0]=T[0],E[1]=T[1],E[4]=T[2],E[5]=T[3],h||i.bA(E,E,g.angle)}else i.aB(E,g.labelPlaneMatrix,d);return E}function Pd(d,t,o,h,g,y,x){let E=Xc(d,t,o,h,g,y,x);return y.name==="globe"&&o||(E[2]=E[6]=E[10]=E[14]=0),E}function Ra(d,t,o,h,g,y,x){if(o){if(y.name==="globe"){let E=Xc(d,t,o,h,g,y,x);return i.bk(E,E),i.aB(E,d,E),E}{let E=i.by(d),T=i.bz([]);return T[0]=x[0],T[1]=x[1],T[4]=x[2],T[5]=x[3],i.aB(E,E,T),h||i.bA(E,E,-g.angle),E}}return g.glCoordMatrix}function gr(d,t,o,h){let g=[d,t,o,1];o?i.aC(g,g,h):xs(g,g,h);let y=g[3];return g[0]/=y,g[1]/=y,g[2]/=y,g}function Km(d,t){return Math.min(.5+d/t*.5,1.5)}function Jm(d,t){let o=d[0]/d[3],h=d[1]/d[3];return o>=-t[0]&&o<=t[0]&&h>=-t[1]&&h<=t[1]}function Qm(d,t,o,h,g,y,x,E,T,A,M=1){let L=o.transform,R=h?d.textSizeData:d.iconSizeData,F=i.bJ(R,o.transform.zoom,M),z=L.projection.name==="globe",j=[256/o.width*2+1,256/o.height*2+1],q=h?d.text.dynamicLayoutVertexArray:d.icon.dynamicLayoutVertexArray;q.clear();let $=null;z&&($=h?d.text.globeExtVertexArray:d.icon.globeExtVertexArray);let Z=d.lineVertexArray,J=h?d.text.placedSymbolArray:d.icon.placedSymbolArray,Y=o.transform.width/o.transform.height,ae,Q=!1;for(let ce=0;ce<J.length;ce++){let se=J.get(ce),{numGlyphs:ie,writingMode:ue}=se;if(ue!==i.bK.vertical||Q||ae===i.bK.horizontal||(Q=!0),ae=ue,(se.hidden||ue===i.bK.vertical)&&!Q){Pa(ie,q);continue}Q=!1;let be=new i.P(se.tileAnchorX,se.tileAnchorY),ye=d.elevationType==="road",Pe=!!L.elevation||ye,{x:Se,y:Be,z:tt}=L.projection.projectTilePoint(be.x,be.y,A.canonical),Ie=null;if(Pe){let gt=ye?d.getElevationFeatureForText(ce):null;Ie={getElevation:T,elevation:L.elevation,elevationFeature:gt};let[Ot,fn,vn]=T(be,L.elevation,gt);Se+=Ot,Be+=fn,tt+=vn}let me=[Se,Be,tt,1];if(i.aC(me,me,t),!Jm(me,j)){Pa(ie,q);continue}let Ve=me[3],De=Km(o.transform.getCameraToCenterDistance(L.projection),Ve),Ge=i.bL(R,F,se),ot=x?Ge/De:Ge*De,xt=gr(Se,Be,tt,g);if(xt[3]<=0){Pa(ie,q);continue}let Je={},it=i.an(d.layers[0].layout.get("text-max-angle")),wt=Math.cos(it),mt=x?null:Ie,ht=Iv(se,ot,!1,E,t,g,y,d.glyphOffsetArray,Z,q,$,xt,be,Je,Y,mt,L.projection,A,x,wt);Q=ht.useVertical,mt&&ht.needsFlipping&&(Je={}),(ht.notEnoughRoom||Q||ht.needsFlipping&&Iv(se,ot,!0,E,t,g,y,d.glyphOffsetArray,Z,q,$,xt,be,Je,Y,mt,L.projection,A,x,wt).notEnoughRoom)&&Pa(ie,q)}h?(d.text.dynamicLayoutVertexBuffer.updateData(q),$&&d.text.globeExtVertexBuffer&&d.text.globeExtVertexBuffer.updateData($)):(d.icon.dynamicLayoutVertexBuffer.updateData(q),$&&d.icon.globeExtVertexBuffer&&d.icon.globeExtVertexBuffer.updateData($))}function Nn(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q){let{lineStartIndex:$,glyphStartIndex:Z,segment:J}=E,Y=Z+E.numGlyphs,ae=$+E.lineLength,Q=t.getoffsetX(Z),ce=t.getoffsetX(Y-1),se=Od(d*Q,o,h,g,y,x,J,$,ae,T,A,M,L,R,!0,F,z,j,q);if(!se)return null;let ie=Od(d*ce,o,h,g,y,x,J,$,ae,T,A,M,L,R,!0,F,z,j,q);return ie?{first:se,last:ie}:null}function eg(d,t,o,h){return d===i.bK.horizontal&&Math.abs(h)>Math.abs(o)?{useVertical:!0}:d===i.bK.vertical?h>0?{needsFlipping:!0}:null:t!==Zo.unknown&&(function(g,y){return g===0||Math.abs(y/g)>Rd})(o,h)?t===Zo.flipRequired?{needsFlipping:!0}:null:o<0?{needsFlipping:!0}:null}function Iv(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$,Z,J){let Y=t/24,ae=d.lineOffsetX*Y,Q=d.lineOffsetY*Y,{lineStartIndex:ce,glyphStartIndex:se,numGlyphs:ie,segment:ue,writingMode:be,flipState:ye}=d,Pe=ce+d.lineLength,Se=Be=>{if(M){let[Ve,De,Ge]=Be.up,ot=A.length;i.bM(M,ot+0,Ve,De,Ge),i.bM(M,ot+1,Ve,De,Ge),i.bM(M,ot+2,Ve,De,Ge),i.bM(M,ot+3,Ve,De,Ge)}let[tt,Ie,me]=Be.point;i.bN(A,tt,Ie,me,Be.angle)};if(ie>1){let Be=Nn(Y,E,ae,Q,o,L,R,d,T,y,F,j,!1,q,$,Z,J);if(!Be)return{notEnoughRoom:!0};if(h&&!o){let[tt,Ie,me]=Be.first.point,[Ve,De,Ge]=Be.last.point;[tt,Ie]=gr(tt,Ie,me,x),[Ve,De]=gr(Ve,De,Ge,x);let ot=eg(be,ye,(Ve-tt)*z,De-Ie);if(d.flipState=ot&&ot.needsFlipping?Zo.flipRequired:Zo.flipNotRequired,ot)return ot}Se(Be.first);for(let tt=se+1;tt<se+ie-1;tt++){let Ie=Od(Y*E.getoffsetX(tt),ae,Q,o,L,R,ue,ce,Pe,T,y,F,j,!1,!1,q,$,Z,J);if(!Ie)return A.length-=4*(tt-se),{notEnoughRoom:!0};Se(Ie)}Se(Be.last)}else{if(h&&!o){let tt=gr(R.x,R.y,0,g),Ie=ce+ue+1,me=new i.P(T.getx(Ie),T.gety(Ie)),Ve=gr(me.x,me.y,0,g),De=Ve[3]>0?Ve:zt(R,me,tt,1,g,void 0,q,$.canonical),Ge=eg(be,ye,(De[0]-tt[0])*z,De[1]-tt[1]);if(d.flipState=Ge&&Ge.needsFlipping?Zo.flipRequired:Zo.flipNotRequired,Ge)return Ge}let Be=Od(Y*E.getoffsetX(se),ae,Q,o,L,R,ue,ce,Pe,T,y,F,j,!1,!1,q,$,Z,J);if(!Be)return{notEnoughRoom:!0};Se(Be)}return{}}function Sv(d,t,o,h,g){let{x:y,y:x,z:E}=h.projectTilePoint(d.x,d.y,t);if(!g)return gr(y,x,E,o);let[T,A,M]=g.getElevation(d,g.elevation,g.elevationFeature);return gr(y+T,x+A,E+M,o)}function zt(d,t,o,h,g,y,x,E){let T=Sv(d.sub(t)._unit()._add(d),E,g,x,y);return i.av(T,o,T),i.aw(T,T),i.bG(T,o,T,h)}function Od(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$,Z){let J=h?d-t:d+t,Y=J>0?1:-1,ae=0;h&&(Y*=-1,ae=Math.PI),Y<0&&(ae+=Math.PI);let Q=E+x+(Y>0?0:1)|0,ce=g,se=g,ie=0,ue=0,be=Math.abs(J),ye=[],Pe=[],Se=y,Be=Se,tt=i.bE([]),Ie=()=>zt(Be,Se,se,be-ie+1,M,R,j,q.canonical);for(;ie+ue<=be;){if(Q+=Y,Q<E||Q>=T)return null;if(se=ce,Be=Se,ye.push(se),F&&Pe.push(Be),Se=new i.P(A.getx(Q),A.gety(Q)),ce=L[Q],!ce){let mt=Sv(Se,q.canonical,M,j,R);ce=mt[3]>0?L[Q]=mt:Ie()}ie+=ue;let it=i.av([],ce,se),wt=i.bF(se,ce);if(o&&wt>0&&ue>0&&i.bI(tt,it)/(ue*wt)<Z)return null;ue=wt,tt=it}z&&R&&(L[Q]&&(ce=Ie(),ue=i.bF(se,ce),tt=i.av([],ce,se)),L[Q]=ce);let me=(be-ie)/ue,Ve=Se.sub(Be)._mult(me)._add(Be),De=i.bG([],se,tt,me),Ge=[0,0,1],ot=tt[0],xt=tt[1];if($&&(Ge=j.upVector(q.canonical,Ve.x,Ve.y),Ge[0]!==0||Ge[1]!==0||Ge[2]!==1)){let it=[Ge[2],0,-Ge[0]],wt=i.bH([],Ge,it);i.aw(it,it),i.aw(wt,wt),ot=i.bI(tt,it),xt=i.bI(tt,wt)}if(o){let it=i.bH([],Ge,tt);i.aw(it,it),i.bG(De,De,it,o*Y)}let Je=ae+Math.atan2(xt,ot);return ye.push(De),F&&Pe.push(Ve),{point:De,angle:Je,path:ye,tilePath:Pe,up:Ge}}function Pa(d,t){let o=t.length,h=o+4*d;t.resize(h),t.float32.fill(-1/0,4*o,4*h)}function xs(d,t,o){let h=t[0],g=t[1];return d[0]=o[0]*h+o[4]*g+o[12],d[1]=o[1]*h+o[5]*g+o[13],d[3]=o[3]*h+o[7]*g+o[15],d}let bs=100;class Yc{constructor(t,o,h=new Md(t.width+200,t.height+200,25),g=new Md(t.width+200,t.height+200,25)){this.transform=t,this.grid=h,this.ignoredGrid=g,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+bs,this.screenBottomBoundary=t.height+bs,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=o}placeCollisionBox(t,o,h,g,y,x,E,T,A,M,L){let R=h.projectedAnchorX,F=h.projectedAnchorY,z=h.projectedAnchorZ,j=h.tileAnchorX,q=h.tileAnchorY,$=h.elevation,Z=h.tileID,J=t.getProjection();if($&&Z){let[Pe,Se,Be]=J.upVector(Z.canonical,h.tileAnchorX,h.tileAnchorY),tt=J.upVectorScale(Z.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;R+=Pe*$*tt,F+=Se*$*tt,z+=Be*$*tt}let Y=t.projection.name==="globe",ae=t.projection.name==="globe"?i.aj(this.transform.zoom):0;if(Z&&Y&&ae<1&&!x){let Pe=1<<Z.canonical.z,Se=i.bO(j,q);i.bP(Se,Se,1/i.al),i.bQ(Se,Se,i.bO(Z.canonical.x,Z.canonical.y)),i.bP(Se,Se,1/Pe),i.bR(Se,Se,i.bO(g[0],g[1])),Se[0]=i.bS(Se[0],-.5,.5),i.bP(Se,Se,i.al);let Be=i.bT(Se[0],Se[1],i.al/(2*Math.PI),1);i.aC(Be,Be,y),R=i.ak(R,Be[0],ae),F=i.ak(F,Be[1],ae),z=i.ak(z,Be[2],ae)}let Q=this.projectAndGetPerspectiveRatio(M,R,F,z,h.tileID,J.name==="globe"||!!$||this.transform.pitch>0,J),ce=A*Q.perspectiveRatio,se=(h.x1*o+E.x-h.padding)*ce+Q.point.x,ie=(h.y1*o+E.y-h.padding)*ce+Q.point.y,ue=(h.x2*o+E.x+h.padding)*ce+Q.point.x,be=(h.y2*o+E.y+h.padding)*ce+Q.point.y,ye=Q.perspectiveRatio<=.55||Q.occluded;return!this.isInsideGrid(se,ie,ue,be)||!T&&this.grid.hitTest(se,ie,ue,be,L)||ye?{box:[],offscreen:!1,occluded:Q.occluded}:{box:[se,ie,ue,be],offscreen:this.isOffscreen(se,ie,ue,be),occluded:!1}}placeCollisionCircles(t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q){let $=[],Z=this.transform.elevation,J=t.getProjection(),Y=t.elevationType==="road",ae=!!Z||Y,Q=i.bU.getAtTileOffsetFunc(q,this.transform.center.lat,this.transform.worldSize,J),ce=new i.P(h.tileAnchorX,h.tileAnchorY),se=new i.P(h.tileAnchorX,h.tileAnchorY),{x:ie,y:ue,z:be}=J.projectTilePoint(se.x,se.y,q.canonical),ye=null;if(ae){let wt=Y?t.getElevationFeatureForText(g):null;ye={getElevation:Q,elevation:Z,elevationFeature:wt};let[mt,ht,gt]=Q(ce,Z,wt);ie+=mt,ue+=ht,be+=gt}let Pe=J.name==="globe",Se=this.projectAndGetPerspectiveRatio(T,ie,ue,be,q,Pe||!!Z||this.transform.pitch>0,J),{perspectiveRatio:Be}=Se,tt=(R?E/Be:E*Be)/i.bX,Ie=gr(ie,ue,be,A),me=h.lineOffsetX*tt,Ve=h.lineOffsetY*tt,De=i.an(t.layers[0].layout.get("text-max-angle")),Ge=Math.cos(De),ot=Se.signedDistanceFromCamera>0?Nn(tt,x,me,Ve,Y&&h.flipState===1,Ie,se,h,y,A,{},ae&&!R?ye:null,R&&ae,J,q,R,Ge):null,xt=!1,Je=!1,it=!0;if(ot&&!Se.occluded){let wt=.5*z*Be+j,mt=new i.P(-100,-100),ht=new i.P(this.screenRightBoundary,this.screenBottomBoundary),gt=new I1,{first:Ot,last:fn}=ot,vn=Ot.path.length,Zn=[];for(let en=vn-1;en>=1;en--)Zn.push(Ot.path[en]);for(let en=1;en<fn.path.length;en++)Zn.push(fn.path[en]);let Ut=2.5*wt;M&&(Zn=Zn.map(([en,jn,xn],oi)=>(ae&&!Pe&&(xn=Q(oi<vn-1?Ot.tilePath[vn-1-oi]:fn.tilePath[oi-vn+2],Z,ye.elevationFeature)[2]),gr(en,jn,xn,M))),Zn.some(en=>en[3]<=0)&&(Zn=[]));let yn=[];if(Zn.length>0){let en=1/0,jn=-1/0,xn=1/0,oi=-1/0;for(let Sn of Zn)en=Math.min(en,Sn[0]),xn=Math.min(xn,Sn[1]),jn=Math.max(jn,Sn[0]),oi=Math.max(oi,Sn[1]);jn>=mt.x&&en<=ht.x&&oi>=mt.y&&xn<=ht.y&&(yn=[Zn.map(Sn=>new i.P(Sn[0],Sn[1]))],(en<mt.x||jn>ht.x||xn<mt.y||oi>ht.y)&&(yn=i.bV(yn,mt.x,mt.y,ht.x,ht.y)))}for(let en of yn){gt.reset(en,.25*wt);let jn=0;jn=gt.length<=.5*wt?1:Math.ceil(gt.paddedLength/Ut)+1;for(let xn=0;xn<jn;xn++){let oi=xn/Math.max(jn-1,1),Sn=gt.lerp(oi),nn=Sn.x+bs,On=Sn.y+bs;$.push(nn,On,wt,0);let on=nn-wt,ui=On-wt,kn=nn+wt,$t=On+wt;if(it=it&&this.isOffscreen(on,ui,kn,$t),Je=Je||this.isInsideGrid(on,ui,kn,$t),!o&&this.grid.hitTestCircle(nn,On,wt,F)&&(xt=!0,!L))return{circles:[],offscreen:!1,collisionDetected:xt,occluded:!1}}}}return{circles:!L&&xt||!Je?[]:$,offscreen:it,collisionDetected:xt,occluded:Se.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};let o=[],h=1/0,g=1/0,y=-1/0,x=-1/0;for(let M of t){let L=new i.P(M.x+bs,M.y+bs);h=Math.min(h,L.x),g=Math.min(g,L.y),y=Math.max(y,L.x),x=Math.max(x,L.y),o.push(L)}let E=this.grid.query(h,g,y,x).concat(this.ignoredGrid.query(h,g,y,x)),T={},A={};for(let M of E){let L=M.key;if(T[L.bucketInstanceId]===void 0&&(T[L.bucketInstanceId]={}),T[L.bucketInstanceId][L.featureIndex])continue;let R=[new i.P(M.x1,M.y1),new i.P(M.x2,M.y1),new i.P(M.x2,M.y2),new i.P(M.x1,M.y2)];i.bW(o,R)&&(T[L.bucketInstanceId][L.featureIndex]=!0,A[L.bucketInstanceId]===void 0&&(A[L.bucketInstanceId]=[]),A[L.bucketInstanceId].push(L.featureIndex))}return A}insertCollisionBox(t,o,h,g,y){(o?this.ignoredGrid:this.grid).insert({bucketInstanceId:h,featureIndex:g,collisionGroupID:y},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,o,h,g,y){let x=o?this.ignoredGrid:this.grid,E={bucketInstanceId:h,featureIndex:g,collisionGroupID:y};for(let T=0;T<t.length;T+=4)x.insertCircle(E,t[T],t[T+1],t[T+2])}projectAndGetPerspectiveRatio(t,o,h,g,y,x,E){let T=[o,h,g,1],A=!1;g||this.transform.pitch>0?(i.aC(T,T,t),this.fogState&&y&&E.name!=="globe"&&(A=(function(R,F,z,j,q,$){let Z=$.calculateFogTileMatrix(q),J=[F,z,j];return i.af(J,J,Z),et(R,i.ag(J),$.pitch,$._fov)})(this.fogState,o,h,g,y.toUnwrapped(),this.transform)>.9)):xs(T,T,t);let M=T[3];return{point:new i.P((T[0]/M+1)/2*this.transform.width+bs,(-T[1]/M+1)/2*this.transform.height+bs),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(E)/M*.5,1.5),signedDistanceFromCamera:M,occluded:x&&T[2]>M||A}}isOffscreen(t,o,h,g){return h<bs||t>=this.screenRightBoundary||g<bs||o>this.screenBottomBoundary}isInsideGrid(t,o,h,g){return h>=0&&t<this.gridRightBoundary&&g>=0&&o<this.gridBottomBoundary}getViewportMatrix(){let t=i.bz([]);return i.bq(t,t,[-100,-100,0]),t}}class Ct{constructor(t,o,h,g){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?o:-o))):g&&h?1:0,this.placed=h}isHidden(){return this.opacity===0&&!this.placed}}class In{constructor(t,o,h,g,y,x=!1){this.text=new Ct(t?t.text:null,o,h,y),this.icon=new Ct(t?t.icon:null,o,g,y),this.clipped=x}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Fn{constructor(t,o,h,g=!1){this.text=t,this.icon=o,this.skipFade=h,this.clipped=g}}class Fo{constructor(){this.invProjMatrix=i.bB(),this.viewportMatrix=i.bB(),this.circles=[]}}class Kc{constructor(t,o,h,g,y){this.bucketInstanceId=t,this.featureIndex=o,this.sourceLayerIndex=h,this.bucketIndex=g,this.tileID=y}}class Vn{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){let o=++this.maxGroupID;this.collisionGroups[t]={ID:o,predicate:h=>h.collisionGroupID===o}}return this.collisionGroups[t]}}function Ld(d,t,o,h,g){let{horizontalAlign:y,verticalAlign:x}=i.c0(d),E=-(y-.5)*t,T=-(x-.5)*o,A=i.c1(d,h);return new i.P(E+A[0]*g,T+A[1]*g)}function tc(d,t,o,h,g){let y=new i.P(d,t);return o&&y._rotate(h?g:-g),y}class Fd{constructor(t,o,h,g,y,x){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Yc(this.transform,y),this.buildingIndex=x,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=o,this.retainedQueryData={},this.collisionGroups=new Vn(h),this.collisionCircleArrays={},this.prevPlacement=g,g&&(g.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,o,h,g,y=1){let x=h.getBucket(o),E=h.latestFeatureIndex;if(!x||!E||o.fqid!==x.layerIds[0])return;let T=x.layers[0].layout,A=x.layers[0].paint,M=h.collisionBoxArray,L=Math.pow(2,this.transform.zoom-h.tileID.overscaledZ),R=h.tileSize/i.al,F=h.tileID.toUnwrapped();this.transform.setProjection(x.projection);let z=(j=h.tileID,q=x.getProjection(),$=this.transform,q.name===this.projection?$.calculateProjMatrix(j.toUnwrapped()):ec($,q,j));var j,q,$;let Z=T.get("text-pitch-alignment")==="map",J=T.get("text-rotation-alignment")==="map";o.compileFilter(o.options);let Y=o.dynamicFilter(),ae=o.dynamicFilterNeedsFeature(),Q=this.transform.calculatePixelsToTileUnitsMatrix(h),ce=Pd(z,h.tileID.canonical,Z,J,this.transform,x.getProjection(),Q),se=null,ie=x.getProjection().createInversionMatrix(this.transform,h.tileID.canonical);if(Z){let me=Ra(z,h.tileID.canonical,Z,J,this.transform,x.getProjection(),Q);se=i.aB([],this.transform.labelPlaneMatrix,me)}let ue=null;Y&&h.latestFeatureIndex&&(ue={unwrappedTileID:F,dynamicFilter:Y,dynamicFilterNeedsFeature:ae}),this.retainedQueryData[x.bucketInstanceId]=new Kc(x.bucketInstanceId,E,x.sourceLayerIndex,x.index,h.tileID);let[be,ye]=x.layers[0].layout.get("text-size-scale-range"),Pe=i.aA(y,be,ye),[Se,Be]=T.get("icon-size-scale-range"),tt=i.aA(y,Se,Be),Ie={bucket:x,layout:T,paint:A,posMatrix:z,invMatrix:ie,mercatorCenter:[i.aF(this.transform.center.lng),i.aJ(this.transform.center.lat)],textLabelPlaneMatrix:ce,labelToScreenMatrix:se,clippingData:ue,scale:L,textPixelRatio:R,holdingForFade:h.holdingForFade(),collisionBoxArray:M,partiallyEvaluatedTextSize:i.bJ(x.textSizeData,this.transform.zoom,Pe),partiallyEvaluatedIconSize:i.bJ(x.iconSizeData,this.transform.zoom,tt),collisionGroup:this.collisionGroups.get(x.sourceID),latestFeatureIndex:h.latestFeatureIndex};if(g)for(let me of x.sortKeyRanges){let{sortKey:Ve,symbolInstanceStart:De,symbolInstanceEnd:Ge}=me;t.push({sortKey:Ve,symbolInstanceStart:De,symbolInstanceEnd:Ge,parameters:Ie})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:x.symbolInstances.length,parameters:Ie})}attemptAnchorPlacement(t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$,Z,J,Y,ae){let{textOffset0:Q,textOffset1:ce,crossTileID:se}=j,ie=[Q,ce],ue=Ld(t,x,E,ie,T),be=this.collisionIndex.placeCollisionBox($,T,o,h,g,y,tc(ue.x,ue.y,A,M,this.transform.angle),z,L,R,F.predicate);if(J){let ye=$.getSymbolInstanceIconSize(ae,this.transform.zoom,j.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox($,ye,J,h,g,y,tc(ue.x,ue.y,A,M,this.transform.angle),z,L,R,F.predicate).box.length===0)return}if(be.box.length>0){let ye;return this.prevPlacement&&this.prevPlacement.variableOffsets[se]&&this.prevPlacement.placements[se]&&this.prevPlacement.placements[se].text&&(ye=this.prevPlacement.variableOffsets[se].anchor),this.variableOffsets[se]={textOffset:ie,width:x,height:E,anchor:t,textScale:T,prevAnchor:ye},this.markUsedJustification($,t,j,Z),$.allowVerticalPlacement&&(this.markUsedOrientation($,Z,j),this.placedOrientations[se]=Z),{shift:ue,placedGlyphBoxes:be}}}placeLayerBucketPart(t,o,h,g,y=1){let{bucket:x,layout:E,paint:T,posMatrix:A,textLabelPlaneMatrix:M,labelToScreenMatrix:L,clippingData:R,textPixelRatio:F,mercatorCenter:z,invMatrix:j,holdingForFade:q,collisionBoxArray:$,partiallyEvaluatedTextSize:Z,partiallyEvaluatedIconSize:J,collisionGroup:Y,latestFeatureIndex:ae}=t.parameters,Q=E.get("text-optional"),ce=E.get("icon-optional"),se=E.get("text-allow-overlap"),ie=E.get("icon-allow-overlap"),ue=E.get("text-rotation-alignment")==="map",be=E.get("icon-rotation-alignment")==="map",ye=E.get("text-pitch-alignment")==="map",Pe=T.get("symbol-z-offset"),Se=E.get("symbol-elevation-reference")==="sea",Be=E.get("symbol-placement"),[tt,Ie]=E.get("text-size-scale-range"),[me,Ve]=E.get("icon-size-scale-range"),De=i.aA(y,tt,Ie),Ge=i.aA(y,me,Ve),ot=E.get("text-variable-anchor"),xt=ue&&Be!=="point",Je=be&&Be!=="point",it=ot&&x.hasTextData(),wt=x.hasIconTextFit()&&it&&x.hasIconData();this.transform.setProjection(x.projection);let mt=it||xt,ht=Je||wt,gt=se&&(ie||!x.hasIconData()||ce),Ot=ie&&(se||!x.hasTextData()||Q),fn=!Pe.isConstant();!x.collisionArrays&&$&&x.deserializeCollisionBoxes($),h&&g&&x.updateCollisionDebugBuffers(this.transform.zoom,$,De,Ge);let vn=(Ut,yn,en)=>{let{crossTileID:jn,numVerticalGlyphVertices:xn}=Ut,oi=null;if(R&&R.dynamicFilterNeedsFeature||fn){let Oi=this.retainedQueryData[x.bucketInstanceId];oi=ae.loadFeature({featureIndex:Ut.featureIndex,bucketIndex:Oi.bucketIndex,sourceLayerIndex:Oi.sourceLayerIndex,layoutVertexArrayOffset:0})}if(R&&!(0,R.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch,worldview:x.worldview},oi,this.retainedQueryData[x.bucketInstanceId].tileID.canonical,new i.P(Ut.tileAnchorX,Ut.tileAnchorY),this.transform.calculateDistanceTileData(R.unwrappedTileID)))return this.placements[jn]=new Fn(!1,!1,!1,!0),void o.add(jn);let Sn=Pe.evaluate(oi,{});if(o.has(jn))return;if(q)return void(this.placements[jn]=new Fn(!1,!1,!1));let nn=!1,On=!1,on=!0,ui=!1,kn=!1,$t=null,wn={box:null,offscreen:null,occluded:null},Ti={box:null},$i=null,Ai=null,Bi=null,So=0,po=0,Ur=0;en.textFeatureIndex?So=en.textFeatureIndex:Ut.useRuntimeCollisionCircles&&(So=Ut.featureIndex),en.verticalTextFeatureIndex&&(po=en.verticalTextFeatureIndex);let Xr=x.elevationFeatures?x.elevationFeatures[Ut.elevationFeatureIndex]:void 0,Qo=Oi=>{Oi.tileID=this.retainedQueryData[x.bucketInstanceId].tileID;let Gi=this.transform.elevation;Oi.elevation=Se?Sn:Sn+i.bU.getAtTileOffset(Oi.tileID,new i.P(Oi.tileAnchorX,Oi.tileAnchorY),Gi,Xr),Oi.elevation+=Ut.zOffset},Hr=en.textBox;if(Hr){Qo(Hr);let Oi=ni=>{let Yi=i.bK.horizontal;if(x.allowVerticalPlacement&&!ni&&this.prevPlacement){let Ar=this.prevPlacement.placedOrientations[jn];Ar&&(this.placedOrientations[jn]=Ar,Yi=Ar,this.markUsedOrientation(x,Yi,Ut))}return Yi},Gi=(ni,Yi)=>{if(x.allowVerticalPlacement&&xn>0&&en.verticalTextBox){for(let Ar of x.writingModes)if(Ar===i.bK.vertical?(wn=Yi(),Ti=wn):wn=ni(),wn&&wn.box&&wn.box.length)break}else wn=ni()};if(ot){let ni=ot;if(this.prevPlacement&&this.prevPlacement.variableOffsets[jn]){let Li=this.prevPlacement.variableOffsets[jn];ni.indexOf(Li.anchor)>0&&(ni=ni.filter(ts=>ts!==Li.anchor),ni.unshift(Li.anchor))}let Yi=(Li,ts,Cu)=>{let Ua=x.getSymbolInstanceTextSize(Z,Ut,this.transform.zoom,yn),Au=(Li.x2-Li.x1)*Ua+2*Li.padding,Mu=(Li.y2-Li.y1)*Ua+2*Li.padding,ns=Ut.hasIconTextFit&&!ie?ts:null;ns&&Qo(ns);let ga={box:[],offscreen:!1,occluded:!1},br=se?2*ni.length:ni.length;for(let is=0;is<br;++is){let mc=this.attemptAnchorPlacement(ni[is%ni.length],Li,z,j,mt,Au,Mu,Ua,ue,ye,F,A,Y,is>=ni.length,Ut,yn,x,Cu,ns,Z,J);if(mc&&(ga=mc.placedGlyphBoxes,ga&&ga.box&&ga.box.length)){nn=!0,$t=mc.shift;break}}return ga};Gi(()=>Yi(Hr,en.iconBox,i.bK.horizontal),()=>{let Li=en.verticalTextBox;return Li&&Qo(Li),x.allowVerticalPlacement&&!(wn&&wn.box&&wn.box.length)&&xn>0&&Li?Yi(Li,en.verticalIconBox,i.bK.vertical):{box:null,offscreen:null,occluded:null}}),wn&&(nn=wn.box,on=wn.offscreen,ui=wn.occluded);let Ar=Oi(!(!wn||!wn.box));if(!nn&&this.prevPlacement){let Li=this.prevPlacement.variableOffsets[jn];Li&&(this.variableOffsets[jn]=Li,this.markUsedJustification(x,Li.anchor,Ut,Ar))}}else{let ni=(Yi,Ar)=>{let Li=x.getSymbolInstanceTextSize(Z,Ut,this.transform.zoom,yn),ts=this.collisionIndex.placeCollisionBox(x,Li,Yi,z,j,mt,new i.P(0,0),se,F,A,Y.predicate);return ts&&ts.box&&ts.box.length&&(this.markUsedOrientation(x,Ar,Ut),this.placedOrientations[jn]=Ar),ts};Gi(()=>ni(Hr,i.bK.horizontal),()=>{let Yi=en.verticalTextBox;return x.allowVerticalPlacement&&xn>0&&Yi?(Qo(Yi),ni(Yi,i.bK.vertical)):{box:null,offscreen:null,occluded:null}}),Oi(!!(wn&&wn.box&&wn.box.length))}}if($i=wn,nn=$i&&$i.box&&$i.box.length>0,on=$i&&$i.offscreen,ui=$i&&$i.occluded,Ut.useRuntimeCollisionCircles){let Oi=Ut.centerJustifiedTextSymbolIndex>=0?Ut.centerJustifiedTextSymbolIndex:Ut.verticalPlacedTextSymbolIndex,Gi=x.text.placedSymbolArray.get(Oi),ni=i.bL(x.textSizeData,Z,Gi),Yi=E.get("text-padding");Ai=this.collisionIndex.placeCollisionCircles(x,se,Gi,Oi,x.lineVertexArray,x.glyphOffsetArray,ni,A,M,L,h,ye,Y.predicate,Ut.collisionCircleDiameter*ni/i.bX,Yi,this.retainedQueryData[x.bucketInstanceId].tileID),nn=se||Ai.circles.length>0&&!Ai.collisionDetected,on=on&&Ai.offscreen,ui=Ai.occluded}if(en.iconFeatureIndex&&(Ur=en.iconFeatureIndex),en.iconBox){let Oi=Gi=>{Qo(Gi);let ni=Ut.hasIconTextFit&&$t?tc($t.x,$t.y,ue,ye,this.transform.angle):new i.P(0,0),Yi=x.getSymbolInstanceIconSize(J,this.transform.zoom,Ut.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(x,Yi,Gi,z,j,ht,ni,ie,F,A,Y.predicate)};Ti&&Ti.box&&Ti.box.length&&en.verticalIconBox?(Bi=Oi(en.verticalIconBox),On=Bi.box.length>0):(Bi=Oi(en.iconBox),On=Bi.box.length>0),on=on&&Bi.offscreen,kn=Bi.occluded}let es=Q||Ut.numHorizontalGlyphVertices===0&&xn===0,Cs=ce||Ut.numIconVertices===0;if(es||Cs?Cs?es||(On=On&&nn):nn=On&&nn:On=nn=On&&nn,nn&&$i&&$i.box&&this.collisionIndex.insertCollisionBox($i.box,E.get("text-ignore-placement"),x.bucketInstanceId,Ti&&Ti.box&&po?po:So,Y.ID),On&&Bi&&this.collisionIndex.insertCollisionBox(Bi.box,E.get("icon-ignore-placement"),x.bucketInstanceId,Ur,Y.ID),Ai&&(nn&&this.collisionIndex.insertCollisionCircles(Ai.circles,E.get("text-ignore-placement"),x.bucketInstanceId,So,Y.ID),h)){let Oi=x.bucketInstanceId,Gi=this.collisionCircleArrays[Oi];Gi===void 0&&(Gi=this.collisionCircleArrays[Oi]=new Fo);for(let ni=0;ni<Ai.circles.length;ni+=4)Gi.circles.push(Ai.circles[ni+0]),Gi.circles.push(Ai.circles[ni+1]),Gi.circles.push(Ai.circles[ni+2]),Gi.circles.push(Ai.collisionDetected?1:0)}let Cr=x.projection.name!=="globe";gt=gt&&(Cr||!ui),Ot=Ot&&(Cr||!kn),this.placements[jn]=new Fn(nn||gt,On||Ot,on||x.justReloaded),o.add(jn)},Zn=this.retainedQueryData[x.bucketInstanceId].tileID;if(x.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(x,Zn),x.elevationType==="road"&&x.updateRoadElevation(Zn.canonical),x.updateZOffset(),x.sortFeaturesByY){let Ut=x.getSortedSymbolIndexes(this.transform.angle);for(let yn=Ut.length-1;yn>=0;--yn){let en=Ut[yn];vn(x.symbolInstances.get(en),en,x.collisionArrays[en])}x.hasAnyZOffset&&i.w(`${x.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(x.hasAnyZOffset){let Ut=x.getSortedIndexesByZOffset();for(let yn=0;yn<Ut.length;++yn){let en=Ut[yn];vn(x.symbolInstances.get(en),en,x.collisionArrays[en])}}else for(let Ut=t.symbolInstanceStart;Ut<t.symbolInstanceEnd;Ut++)vn(x.symbolInstances.get(Ut),Ut,x.collisionArrays[Ut]);if(h&&x.bucketInstanceId in this.collisionCircleArrays){let Ut=this.collisionCircleArrays[x.bucketInstanceId];i.bk(Ut.invProjMatrix,A),Ut.viewportMatrix=this.collisionIndex.getViewportMatrix()}x.justReloaded=!1}markUsedJustification(t,o,h,g){let{leftJustifiedTextSymbolIndex:y,centerJustifiedTextSymbolIndex:x,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:T,crossTileID:A}=h,M=i.c2(o),L=g===i.bK.vertical?T:M==="left"?y:M==="center"?x:M==="right"?E:-1;y>=0&&(t.text.placedSymbolArray.get(y).crossTileID=L>=0&&y!==L?0:A),x>=0&&(t.text.placedSymbolArray.get(x).crossTileID=L>=0&&x!==L?0:A),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=L>=0&&E!==L?0:A),T>=0&&(t.text.placedSymbolArray.get(T).crossTileID=L>=0&&T!==L?0:A)}markUsedOrientation(t,o,h){let g=o===i.bK.horizontal||o===i.bK.horizontalOnly?o:0,y=o===i.bK.vertical?o:0,{leftJustifiedTextSymbolIndex:x,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:T,verticalPlacedTextSymbolIndex:A}=h,M=t.text.placedSymbolArray;x>=0&&(M.get(x).placedOrientation=g),E>=0&&(M.get(E).placedOrientation=g),T>=0&&(M.get(T).placedOrientation=g),A>=0&&(M.get(A).placedOrientation=y)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;let o=this.prevPlacement,h=!1;this.prevZoomAdjustment=o?o.zoomAdjustment(this.transform.zoom):0;let g=o?o.symbolFadeChange(t):1,y=o?o.opacities:{},x=o?o.variableOffsets:{},E=o?o.placedOrientations:{};for(let T in this.placements){let A=this.placements[T],M=y[T];M?(this.opacities[T]=new In(M,g,A.text,A.icon,null,A.clipped),h=h||A.text!==M.text.placed||A.icon!==M.icon.placed):(this.opacities[T]=new In(null,g,A.text,A.icon,A.skipFade,A.clipped),h=h||A.text||A.icon)}for(let T in y){let A=y[T];if(!this.opacities[T]){let M=new In(A,g,!1,!1);M.isHidden()||(this.opacities[T]=M,h=h||A.text.placed||A.icon.placed)}}for(let T in x)this.variableOffsets[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.variableOffsets[T]=x[T]);for(let T in E)this.placedOrientations[T]||!this.opacities[T]||this.opacities[T].isHidden()||(this.placedOrientations[T]=E[T]);h?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=o?o.lastPlacementChangeTime:t)}updateLayerOpacities(t,o,h,g){let y=new Set;for(let x of o){let E=x.getBucket(t);E&&x.latestFeatureIndex&&t.fqid===E.layerIds[0]&&(this.updateBucketOpacities(E,y,x,x.collisionBoxArray,h,g,x.tileID,t.scope),E.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(E,x.tileID),E.elevationType==="road"&&E.updateRoadElevation(x.tileID.canonical),E.updateZOffset())}}updateBucketOpacities(t,o,h,g,y,x,E,T){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();let A=t.layers[0].layout,M=t.layers[0].paint,L=!!t.layers[0].dynamicFilter(),R=new In(null,0,!1,!1,!0),F=A.get("text-allow-overlap"),z=A.get("icon-allow-overlap"),j=A.get("text-variable-anchor"),q=A.get("text-rotation-alignment")==="map",$=A.get("text-pitch-alignment")==="map",Z=M.get("symbol-z-offset"),J=A.get("symbol-elevation-reference")==="sea",Y=!Z.isConstant(),ae=new In(null,0,F&&(z||!t.hasIconData()||A.get("icon-optional")),z&&(F||!t.hasTextData()||A.get("text-optional")),!0);!t.collisionArrays&&g&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(g);let Q=(se,ie,ue)=>{for(let be=0;be<ie/4;be++)se.opacityVertexArray.emplaceBack(ue)},ce=0;x&&t.updateReplacement(E,x);for(let se=0;se<t.symbolInstances.length;se++){let ie=t.symbolInstances.get(se),{numHorizontalGlyphVertices:ue,numVerticalGlyphVertices:be,crossTileID:ye,numIconVertices:Pe,tileAnchorX:Se,tileAnchorY:Be}=ie,tt=null,Ie=this.retainedQueryData[t.bucketInstanceId];Y&&ie&&Ie&&(tt=h.latestFeatureIndex.loadFeature({featureIndex:ie.featureIndex,bucketIndex:Ie.bucketIndex,sourceLayerIndex:Ie.sourceLayerIndex,layoutVertexArrayOffset:0}));let me=Z.evaluate(tt,{}),Ve=o.has(ye),De=this.opacities[ye];Ve?De=R:De||(De=ae,this.opacities[ye]=De),o.add(ye);let Ge=ue>0||be>0,ot=Pe>0,xt=this.placedOrientations[ye],Je=xt===i.bK.vertical,it=xt===i.bK.horizontal||xt===i.bK.horizontalOnly;!Ge&&!ot||De.isHidden()||ce++;let wt=!1;if((Ge||ot)&&x)for(let mt of t.activeReplacements){if(i.bY(mt,y,i.bZ.Symbol,T)||mt.min.x>Se||Se>mt.max.x||mt.min.y>Be||Be>mt.max.y)continue;let ht=i.b_(Se,Be,E.canonical,mt.footprintTileId.canonical);if(wt=i.b$(ht,mt.footprint),wt)break}if(Ge){let mt=wt?Dr:zd(De.text);Q(t.text,ue,Je?Dr:mt),Q(t.text,be,it?Dr:mt);let ht=De.text.isHidden(),{leftJustifiedTextSymbolIndex:gt,centerJustifiedTextSymbolIndex:Ot,rightJustifiedTextSymbolIndex:fn,verticalPlacedTextSymbolIndex:vn}=ie,Zn=t.text.placedSymbolArray,Ut=ht||Je?1:0;gt>=0&&(Zn.get(gt).hidden=Ut),Ot>=0&&(Zn.get(Ot).hidden=Ut),fn>=0&&(Zn.get(fn).hidden=Ut),vn>=0&&(Zn.get(vn).hidden=ht||it?1:0);let yn=this.variableOffsets[ye];yn&&this.markUsedJustification(t,yn.anchor,ie,xt);let en=this.placedOrientations[ye];en&&(this.markUsedJustification(t,"left",ie,en),this.markUsedOrientation(t,en,ie))}if(ot){let mt=wt?Dr:zd(De.icon),{placedIconSymbolIndex:ht,verticalPlacedIconSymbolIndex:gt}=ie,Ot=t.icon.placedSymbolArray,fn=De.icon.isHidden()?1:0;ht>=0&&(Q(t.icon,Pe,Je?Dr:mt),Ot.get(ht).hidden=fn),gt>=0&&(Q(t.icon,ie.numVerticalIconVertices,it?Dr:mt),Ot.get(gt).hidden=fn)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){let mt=t.collisionArrays[se];if(mt){let ht=new i.P(0,0),gt=!0;if(mt.textBox||mt.verticalTextBox){if(j){let fn=this.variableOffsets[ye];fn?(ht=Ld(fn.anchor,fn.width,fn.height,fn.textOffset,fn.textScale),q&&ht._rotate($?this.transform.angle:-this.transform.angle)):gt=!1}L&&(gt=!De.clipped),mt.textBox&&Lr(t.textCollisionBox.collisionVertexArray,De.text.placed,!gt||Je,me,J,ht.x,ht.y),mt.verticalTextBox&&Lr(t.textCollisionBox.collisionVertexArray,De.text.placed,!gt||it,me,J,ht.x,ht.y)}let Ot=gt&&!!(!it&&mt.verticalIconBox);mt.iconBox&&Lr(t.iconCollisionBox.collisionVertexArray,De.icon.placed,Ot,me,J,ie.hasIconTextFit?ht.x:0,ie.hasIconTextFit?ht.y:0),mt.verticalIconBox&&Lr(t.iconCollisionBox.collisionVertexArray,De.icon.placed,!Ot,me,J,ie.hasIconTextFit?ht.x:0,ie.hasIconTextFit?ht.y:0)}}}if(t.fullyClipped=ce===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){let se=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=se.invProjMatrix,t.placementViewportMatrix=se.viewportMatrix,t.collisionCircleArray=se.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,o){let h=this.zoomAtLastRecencyCheck===o?1-this.zoomAdjustment(o):1;return this.zoomAtLastRecencyCheck=o,this.commitTime+this.fadeDuration*h>t}setStale(){this.stale=!0}}function Lr(d,t,o,h,g,y,x){d.emplaceBack(t?1:0,o?1:0,y||0,x||0,h,g?1:0),d.emplaceBack(t?1:0,o?1:0,y||0,x||0,h,g?1:0),d.emplaceBack(t?1:0,o?1:0,y||0,x||0,h,g?1:0),d.emplaceBack(t?1:0,o?1:0,y||0,x||0,h,g?1:0)}let hr=Math.pow(2,25),S1=Math.pow(2,24),kd=Math.pow(2,17),tg=Math.pow(2,16),Nd=Math.pow(2,9),ff=Math.pow(2,8),ng=Math.pow(2,1);function zd(d){if(d.opacity===0&&!d.placed)return 0;if(d.opacity===1&&d.placed)return 4294967295;let t=d.placed?1:0,o=Math.floor(127*d.opacity);return o*hr+t*S1+o*kd+t*tg+o*Nd+t*ff+o*ng+t}let Dr=0;class Oa{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,o,h,g,y,x){let E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(o.getBucketParts(E,g,t[this._currentTileIndex],this._sortAcrossTiles,x),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((T,A)=>T.sortKey-A.sortKey));this._currentPartIndex<E.length;){let T=E[this._currentPartIndex];if(o.placeLayerBucketPart(T,this._seenCrossTileIDs,h,T.symbolInstanceStart===0,x),this._currentPartIndex++,y())return!0}return!1}}class Eo{constructor(t,o,h,g,y,x,E,T,A){this.placement=new Fd(t,y,x,E,T,A),this._currentPlacementIndex=o.length-1,this._forceFullPlacement=h,this._showCollisionBoxes=g,this._done=!1}isDone(){return this._done}continuePlacement(t,o,h,g,y){let x=i.o.now(),E=()=>{let T=i.o.now()-x;return!this._forceFullPlacement&&T>2};for(;this._currentPlacementIndex>=0;){let T=o[t[this._currentPlacementIndex]],A=this.placement.collisionIndex.transform.zoom;if(T.type==="symbol"&&(!T.minzoom||T.minzoom<=A)&&(!T.maxzoom||T.maxzoom>A)){let M=T,L=M.layout.get("symbol-z-elevate"),R=M.layout.get("symbol-sort-key").constantOr(1)!==void 0,F=M.layout.get("symbol-z-order"),z=F==="viewport-y"||F==="auto"&&!(F!=="viewport-y"&&R),j=M.layout.get("text-allow-overlap")||M.layout.get("icon-allow-overlap")||M.layout.get("text-ignore-placement")||M.layout.get("icon-ignore-placement"),q=z&&j,$=this._inProgressLayer=this._inProgressLayer||new Oa(M),Z=i.B(T.source,T.scope);if($.continuePlacement(L||q?g[Z]:h[Z],this.placement,this._showCollisionBoxes,T,E,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}let pf=512/i.al/2;class Jc{constructor(t,o,h){this.tileID=t,this.bucketInstanceId=h,this.index=new i.c3(o.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let g=t.canonical.x*i.al,y=t.canonical.y*i.al;for(let x=0;x<o.length;x++){let{key:E,crossTileID:T,tileAnchorX:A,tileAnchorY:M}=o.get(x),L=Math.floor((g+A)*pf),R=Math.floor((y+M)*pf);this.index.add(L,R),this.keys.push(E),this.crossTileIDs.push(T)}this.index.finish()}findMatches(t,o,h){let g=this.tileID.canonical.z<o.canonical.z?1:Math.pow(2,this.tileID.canonical.z-o.canonical.z),y=pf/Math.pow(2,o.canonical.z-this.tileID.canonical.z),x=o.canonical.x*i.al,E=o.canonical.y*i.al;for(let T=0;T<t.length;T++){let A=t.get(T);if(A.crossTileID)continue;let{key:M,tileAnchorX:L,tileAnchorY:R}=A,F=Math.floor((x+L)*y),z=Math.floor((E+R)*y),j=this.index.range(F-g,z-g,F+g,z+g).sort((q,$)=>q-$);for(let q of j){let $=this.crossTileIDs[q];if(this.keys[q]===M&&!h.has($)){h.add($),A.crossTileID=$;break}}}}}class xr{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class da{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){let o=Math.round((t-this.lng)/360);if(o!==0)for(let h in this.indexes){let g=this.indexes[h],y={};for(let x in g){let E=g[x];E.tileID=E.tileID.unwrapTo(E.tileID.wrap+o),y[E.tileID.key]=E}this.indexes[h]=y}this.lng=t}addBucket(t,o,h){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===o.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let y=0;y<o.symbolInstances.length;y++)o.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);let g=this.usedCrossTileIDs[t.overscaledZ];for(let y in this.indexes){let x=this.indexes[y];if(Number(y)>t.overscaledZ)for(let E in x){let T=x[E];T.tileID.isChildOf(t)&&T.findMatches(o.symbolInstances,t,g)}else{let E=x[t.scaledTo(Number(y)).key];E&&E.findMatches(o.symbolInstances,t,g)}}for(let y=0;y<o.symbolInstances.length;y++){let x=o.symbolInstances.get(y);x.crossTileID||(x.crossTileID=h.generate(),g.add(x.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Jc(t,o.symbolInstances,o.bucketInstanceId),!0}removeBucketCrossTileIDs(t,o){for(let h of o.crossTileIDs)this.usedCrossTileIDs[t].delete(h)}removeStaleBuckets(t){let o=!1;for(let h in this.indexes){let g=this.indexes[h];for(let y in g)t[g[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(h,g[y]),delete g[y],o=!0)}return o}}class La{constructor(){this.layerIndexes={},this.crossTileIDs=new xr,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,o,h,g){let y=this.layerIndexes[t.fqid];y===void 0&&(y=this.layerIndexes[t.fqid]=new da);let x=!1,E={};g.name!=="globe"&&y.handleWrapJump(h);for(let T of o){let A=T.getBucket(t);A&&t.fqid===A.layerIds[0]&&(A.bucketInstanceId||(A.bucketInstanceId=++this.maxBucketInstanceId),y.addBucket(T.tileID,A,this.crossTileIDs)&&(x=!0),E[A.bucketInstanceId]=!0)}return y.removeStaleBuckets(E)&&(x=!0),x}pruneUnusedLayers(t){let o={};t.forEach(h=>{o[h]=!0});for(let h in this.layerIndexes)o[h]||delete this.layerIndexes[h]}}let Xi=771;class rn{constructor(t,o,h,g){this.blendFunction=t,this.blendColor=o.toNonPremultipliedRenderColor(null),this.mask=h,this.blendEquation=g}}rn.Replace=[1,0,1,0],rn.disabled=new rn(rn.Replace,i.ao.transparent,[!1,!1,!1,!1]),rn.unblended=new rn(rn.Replace,i.ao.transparent,[!0,!0,!0,!0]),rn.alphaBlended=new rn([1,Xi,1,Xi],i.ao.transparent,[!0,!0,!0,!0]),rn.alphaBlendedNonPremultiplied=new rn([770,Xi,770,Xi],i.ao.transparent,[!0,!0,!0,!0]),rn.multiply=new rn([774,0,774,0],i.ao.transparent,[!0,!0,!0,!0]),rn.additive=new rn([1,1,1,1],i.ao.transparent,[!0,!0,!0,!0]);class Tt{constructor(t,o,h){this.func=t,this.mask=o,this.range=h}}Tt.ReadOnly=!1,Tt.ReadWrite=!0,Tt.disabled=new Tt(519,Tt.ReadOnly,[0,1]);let nc=7680;class qt{constructor(t,o,h,g,y,x){this.test=t,this.ref=o,this.mask=h,this.fail=g,this.depthFail=y,this.pass=x}}qt.disabled=new qt({func:519,mask:0},0,0,nc,nc,nc);let Qc=1029,mf=2305;class jt{constructor(t,o,h){this.enable=t,this.mode=o,this.frontFace=h}}function Bd(d,t){let o=i.c9(d,3);i.cb(d,t),i.cf(d,3,o)}function gf(d,t){let o=i.c6([]);return i.c7(o,o,-t),i.c8(o,o,-d),o}function Dv(d,t){let o=[d[0],d[1],0],h=[t[0],t[1],0];if(i.ag(o)>=1e-15){let x=i.aw([],o);i.c4(h,x,i.bI(h,x)),t[0]=h[0],t[1]=h[1]}let g=i.bH([],t,d);if(i.c5(g)<1e-15)return null;let y=Math.atan2(-g[1],g[0]);return gf(Math.atan2(Math.sqrt(d[0]*d[0]+d[1]*d[1]),-d[2]),y)}jt.disabled=new jt(!1,Qc,mf),jt.backCCW=new jt(!0,Qc,mf),jt.backCW=new jt(!0,Qc,2304),jt.frontCW=new jt(!0,1028,2304),jt.frontCCW=new jt(!0,1028,mf);class ha{constructor(t,o){this.position=t,this.orientation=o}get position(){return this._position}set position(t){if(t){let o=t instanceof i.ae?t:new i.ae(t[0],t[1],t[2]);this._renderWorldCopies&&(o.x=i.bS(o.x,0,1)),this._position=o}else this._position=null}lookAtPoint(t,o,h){if(this.orientation=null,!this.position)return;let g=this.position,y=h||(this._elevation?this._elevation.getAtPointOrZero(i.ae.fromLngLat(t)):0),x=i.ae.fromLngLat(t,y),E=[x.x-g.x,x.y-g.y,x.z-g.z];o||(o=[0,0,1]),o[2]=Math.abs(o[2]),this.orientation=Dv(E,o)}setPitchBearing(t,o){this.orientation=gf(i.an(t),i.an(-o))}}class _f{constructor(t,o){this._transform=i.bz([]),this.orientation=o,this.position=t}get mercatorPosition(){let t=this.position;return new i.ae(t[0],t[1],t[2])}get position(){let t=i.c9(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var o;t&&i.cf(this._transform,3,[(o=t)[0],o[1],o[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||i.c6([]),t&&Bd(this._transform,this._orientation)}getPitchBearing(){let t=this.forward(),o=this.right();return{bearing:Math.atan2(-o[1],o[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,o){this._orientation=gf(t,o),Bd(this._transform,this._orientation)}forward(){let t=i.c9(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){let t=i.c9(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){let t=i.c9(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,o){let h=new Float64Array(16);return i.bk(h,this.getWorldToCamera(t,o)),h}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,o,h){let g=this.position;i.c4(g,g,-t);let y=new Float64Array(16);return i.bp(y,[h,h,h]),i.bq(y,y,g),y[10]*=o,y}getWorldToCamera(t,o){let h=new Float64Array(16),g=new Float64Array(4),y=this.position;return i.ca(g,this._orientation),i.c4(y,y,-t),i.cb(h,g),i.bq(h,h,y),h[1]*=-1,h[5]*=-1,h[9]*=-1,h[13]*=-1,h[8]*=o,h[9]*=o,h[10]*=o,h[11]*=o,h}getCameraToClipPerspective(t,o,h,g){let y=new Float64Array(16);return i.cc(y,t,o,h,g),y}getCameraToClipOrthographic(t,o,h,g,y,x){let E=new Float64Array(16);return i.cd(E,t,o,h,g,y,x),E}getDistanceToElevation(t,o=!1){let h=t===0?0:i.ce(t,o?i.a_(this.position[1]):this.position[1]),g=this.forward();return(h-this.position[2])/g[2]}clone(){return new _f([...this.position],[...this.orientation])}}let Fr={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class no{constructor(t=0,o=0,h=0,g=0){if(isNaN(t)||t<0||isNaN(o)||o<0||isNaN(h)||h<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=o,this.left=h,this.right=g}interpolate(t,o,h){return o.top!=null&&t.top!=null&&(this.top=i.ak(t.top,o.top,h)),o.bottom!=null&&t.bottom!=null&&(this.bottom=i.ak(t.bottom,o.bottom,h)),o.left!=null&&t.left!=null&&(this.left=i.ak(t.left,o.left,h)),o.right!=null&&t.right!=null&&(this.right=i.ak(t.right,o.right,h)),this}getCenter(t,o){let h=i.aA((this.left+t-this.right)/2,0,t),g=i.aA((this.top+o-this.bottom)/2,0,o);return new i.P(h,g)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new no(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}let ic=15;class eu{constructor(t,o,h,g,y,x,E){this.tileSize=512,this._renderWorldCopies=y===void 0||y,this._minZoom=t||0,this._maxZoom=o||22,this._minPitch=h??0,this._maxPitch=g??60,this.setProjection(x),this.setMaxBounds(E),this.width=0,this.height=0,this._center=new i.aS(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new no,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new _f,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let t=new eu(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<ic}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,o=!1){let h=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||h)&&this._updateCameraOnTerrain(),(t||h)&&this._constrainCamera(o),this._calcMatrices()}getProjection(){return i.aH(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};let o=this.projection?this.getProjection():void 0;this.projection=i.cl(this.projectionOptions);let h=this.getProjection(),g=!i.bx(o,h);return g&&this._calcMatrices(),this.mercatorFromTransition=!1,g}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){let t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=i.cl({name:"mercator"});let o=t!==this.projection.name;return o&&this._calcMatrices(),o}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){let t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return i.ce(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new i.P(this.width,this.height)}get bearing(){return i.bS(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){let o=-t*Math.PI/180;this.angle!==o&&(this._unmodified=!1,this.angle=o,this._calcMatrices(),this.rotationMatrix=i.cm(),i.cn(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){let o=i.aA(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==o&&(this._unmodified=!1,this._pitch=o,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=i.an(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){let o=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==o&&(this._unmodified=!1,this._setZoom(o),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){let t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,o=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!o||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let h=this._elevation;o||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&h.exaggeration()&&this._centerAltitudeValidForExaggeration!==h.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*h.exaggeration(),this._centerAltitudeValidForExaggeration=h.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=h.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;let t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;let t=this._elevation,o=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],h=this.horizonLineFromTop(),g=0,y=0;for(let x=0;x<o.length;x++){let E=new i.P(o[x][0]*this.width,h+o[x][1]*(this.height-h)),T=t.pointCoordinate(E);if(!T)continue;let A=1/Math.hypot(T[0]-this._camera.position[0],T[1]-this._camera.position[1]);g+=T[3]*A,y+=A}return y===0?NaN:g/y}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;let t=this._seaLevelZoom,o=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),h=this.pixelsPerMeter/this.worldSize*o,g=this._mercatorZfromZoom(t),y=this._mercatorZfromZoom(this._maxZoom),x=Math.max(g-h,y);this._setZoom(this._zoomFromMercatorZ(x))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){let o=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude())),h;h=t.z<this._camera.position[2]?[o.x,o.y,o.z]:[t.x,t.y,t.z];let g=i.ag(i.av([],this._camera.position,h));return i.aA(this._zoomFromMercatorZ(g),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let o=!1;if(t.orientation&&!i.co(t.orientation,this._camera.orientation)&&(o=this._setCameraOrientation(t.orientation)),t.position){let h=[t.position.x,t.position.y,t.position.z];i.cp(h,this._camera.position)||(this._setCameraPosition(h),o=!0)}o&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let t=this._camera.position,o=new ha;return o.position=new i.ae(t[0],t[1],t[2]),o.orientation=this._camera.orientation,o._elevation=this.elevation,o._renderWorldCopies=this.renderWorldCopies,o}_setCameraOrientation(t){if(!i.cq(t))return!1;i.cr(t,t);let o=i.cs([],[0,0,-1],t),h=i.cs([],[0,-1,0],t);if(h[2]<0)return!1;let g=Dv(o,h);return!!g&&(this._camera.orientation=g,!0)}_setCameraPosition(t){let o=this.zoomScale(this.minZoom)*this.tileSize,h=this.zoomScale(this.maxZoom)*this.tileSize,g=this.cameraToCenterDistance;t[2]=i.aA(t[2],g/h,g/o),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,o,h){this._unmodified=!1,this._edgeInsets.interpolate(t,o,h),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){let o=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,o)}getVisibleUnwrappedCoordinates(t){let o=[new i.ct(0,t)];if(this.renderWorldCopies){let h=this.pointCoordinate(new i.P(0,0)),g=this.pointCoordinate(new i.P(this.width,0)),y=this.pointCoordinate(new i.P(this.width,this.height)),x=this.pointCoordinate(new i.P(0,this.height)),E=Math.floor(Math.min(h.x,g.x,y.x,x.x)),T=Math.floor(Math.max(h.x,g.x,y.x,x.x)),A=1;for(let M=E-A;M<=T+A;M++)M!==0&&o.push(new i.ct(M,t))}return o}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,o,h){let g=[],y=h!=null,x=!y;if(x&&this.zoom<o||y&&h[0]===0&&h[1]===0)return g;let E=new Set,T=(M,L,R,F,z)=>{let j=i.cX(L,M,R,F,z);E.has(j)||(g.push(new i.aP(M,L,R,F,z)),E.add(j))};for(let M=0;M<t.length;M++){let L=t[M];if(x&&L.canonical.z!==o)continue;let R=L.canonical,F=L.overscaledZ,z=L.wrap,j=1<<R.z,q=R.x+1<j,$=R.x>0,Z=R.y+1<j,J=R.y>0,Y=L.wrap-($?0:1),ae=L.wrap+(q?0:1),Q=$?R.x-1:j-1,ce=q?R.x+1:0;if(y)h[0]<0?(T(F,ae,R.z,ce,R.y),h[1]<0&&Z&&(T(F,z,R.z,R.x,R.y+1),T(F,ae,R.z,ce,R.y+1)),h[1]>0&&J&&(T(F,z,R.z,R.x,R.y-1),T(F,ae,R.z,ce,R.y-1))):h[0]>0?(T(F,Y,R.z,Q,R.y),h[1]<0&&Z&&(T(F,z,R.z,R.x,R.y+1),T(F,Y,R.z,Q,R.y+1)),h[1]>0&&J&&(T(F,z,R.z,R.x,R.y-1),T(F,Y,R.z,Q,R.y-1))):h[1]<0&&Z?T(F,z,R.z,R.x,R.y+1):J&&T(F,z,R.z,R.x,R.y-1);else{let se=L.visibleQuadrants;1&se&&(T(F,Y,R.z,Q,R.y),J&&(T(F,z,R.z,R.x,R.y-1),T(F,Y,R.z,Q,R.y-1))),2&se&&(T(F,ae,R.z,ce,R.y),J&&(T(F,z,R.z,R.x,R.y-1),T(F,ae,R.z,ce,R.y-1))),4&se&&(T(F,Y,R.z,Q,R.y),Z&&(T(F,z,R.z,R.x,R.y+1),T(F,Y,R.z,Q,R.y+1))),8&se&&(T(F,ae,R.z,ce,R.y),Z&&(T(F,z,R.z,R.x,R.y+1),T(F,ae,R.z,ce,R.y+1)))}}let A=[];for(let M of g)g.some(L=>M.isChildOf(L))||A.push(M);if(g=A.filter(M=>!t.some(L=>!!(M.overscaledZ<o&&L.isChildOf(M))||M.equals(L)||M.isChildOf(L))),x){let M=1<<o,L=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),R=[M*L.x,M*L.y],F=4,z=F*F;g=g.filter(j=>{let q=j.canonical.x+.5-R[0],$=j.canonical.y+.5-R[1];return q*q+$*$<z})}return g}extendTileCoverToNearPlane(t,o,h){let g=[],y=new Set;for(let Z of t)y.add(Z.key);let x=(Z,J,Y,ae,Q)=>{let ce=i.cX(J,Z,Y,ae,Q);y.has(ce)||(g.push(new i.aP(Z,J,Y,ae,Q)),y.add(ce))},E=t.reduce((Z,J)=>Math.max(Z,J.overscaledZ),h),T=1<<h,A=[new i.P(0,0),new i.P(i.al,0),new i.P(i.al,i.al),new i.P(0,i.al)],M=new i.P(0,0),L=new i.P(0,0),R=(Z,J)=>{let Y=Math.floor(Z[0]),ae=Math.floor(Z[1]),Q=(Z[0]-Y)*i.al,ce=(Z[1]-ae)*i.al,se=Math.floor(J[0]),ie=Math.floor(J[1]),ue=(J[0]-se)*i.al,be=(J[1]-ie)*i.al;for(let ye=-1;ye<=1;ye++){let Pe=Y+ye;if(!(Pe<0||Pe>=T)){M.x=Q-ye*i.al,L.x=ue-(Pe-se)*i.al;for(let Se=-1;Se<=1;Se++){let Be=ae+Se;M.y=ce-Se*i.al,L.y=be-(Be-ie)*i.al,i.cY(M,L,A)&&x(E,0,h,Pe,Be)}}}},F=o.points,z=F[i.cu],j=F[i.cv],q=this._projectToGround(z,F[i.cw]),$=this._projectToGround(j,F[i.cx]);return R(z,q),R(j,$),g}_projectToGround(t,o){return i.cy(i.cz(),t,o,t[2]/(t[2]-o[2]))}coveringTiles(t){let o=this.coveringZoomLevel(t),h=o,g=this.elevation&&this.elevation.exaggeration(),y=g&&!t.isTerrainDEM,x=this.projection.name==="mercator";if(t.minzoom!==void 0&&o<t.minzoom)return[];t.maxzoom!==void 0&&o>t.maxzoom&&(o=t.maxzoom);let E=this.locationCoordinate(this.center),T=this.center.lat,A=1<<o,M=[A*E.x,A*E.y,0],L=this.projection.name==="globe",R=!L,F=i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,o,R),z=L?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),j=A*i.ce(1,this.center.lat),q=this._camera.position[2]/i.ce(1,this.center.lat),$=[A*z.x,A*z.y,q*(R?1:j)],Z=L||g,J=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),Y=this.isLODDisabled(!0)?o:0,ae;if(this._elevation&&t.isTerrainDEM)ae=1e4*this._elevation.exaggeration();else if(this._elevation){let me=this._elevation.getMinMaxForVisibleTiles();ae=me?me.max:this._centerAltitude}else ae=this._centerAltitude;let Q=t.isTerrainDEM?-ae:this._elevation?this._elevation.getMinElevationBelowMSL():0,ce=this.projection.isReprojectedInTileSpace?i.cB(this):1,se=me=>{let De=new i.ae(me.x+25e-6,me.y,me.z),Ge=new i.ae(me.x,me.y+25e-6,me.z),ot=me.toLngLat(),xt=De.toLngLat(),Je=Ge.toLngLat(),it=this.locationCoordinate(ot),wt=this.locationCoordinate(xt),mt=this.locationCoordinate(Je),ht=Math.hypot(wt.x-it.x,wt.y-it.y),gt=Math.hypot(mt.x-it.x,mt.y-it.y);return Math.sqrt(ht*gt)*ce/25e-6},ie=me=>{let Ve=ae,De=Q;return{aabb:i.cE(this,A,0,0,0,me,De,Ve,this.projection),zoom:0,x:0,y:0,minZ:De,maxZ:Ve,wrap:me,fullyVisible:!1}},ue=[],be=[],ye=o,Pe=t.reparseOverscaled?h:o,Se=(q-this._centerAltitude)*j,Be=me=>{if(!this._elevation||!me.tileID||!x)return;let Ve=this._elevation.getMinMaxForTile(me.tileID),De=me.aabb;Ve?(De.min[2]=Ve.min,De.max[2]=Ve.max,De.center[2]=(De.min[2]+De.max[2])/2):(me.shouldSplit=Ie(me),me.shouldSplit||(De.min[2]=De.max[2]=De.center[2]=this._centerAltitude))},tt=(me,Ve)=>{if(.707*Ve<me)return 1;let De=Ve/me;return De/(1.4144271570014144+(Math.pow(1.1,De-1.4144271570014144+1)-1)/(1.1-1)-1)},Ie=me=>{if(me.zoom<Y)return!0;if(me.zoom===ye)return!1;if(me.shouldSplit!=null)return me.shouldSplit;let Ve=me.aabb.distanceX($),De=me.aabb.distanceY($),Ge=Se,ot=1;if(L){Ge=me.aabb.distanceZ($);let gt=Math.pow(2,me.zoom),Ot=i.a_((me.y+1)/gt),fn=i.a_(me.y/gt),vn=Math.min(Math.max(T,Ot),fn),Zn=i.d0(vn)/i.d0(T);if(ot=vn===T?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Zn/this._mercatorScaleRatio),this.zoom<=i.cZ&&me.zoom===ye-1&&Zn>=.9)return!0}else if(y&&(Ge=me.aabb.distanceZ($)*j),this.projection.isReprojectedInTileSpace&&h<=5){let gt=Math.pow(2,me.zoom),Ot=se(new i.ae((me.x+.5)/gt,(me.y+.5)/gt));ot=Ot>.85?1:Ot}if(!x&&!L){let gt=Math.sqrt(Ve*Ve+De*De+Ge*Ge),Ot=(1<<ye-me.zoom)*J*ot;return Ot*=tt(Math.max(Ge,Se),gt),gt<Ot}let xt=Number.MAX_VALUE,Je=0,it=me.aabb.getCorners(),wt=[];for(let gt of it){i.av(wt,gt,$),L||(y?wt[2]*=j:wt[2]=Se);let Ot=i.bI(wt,this._camera.forward());Ot<xt&&(xt=Ot,Je=Math.abs(wt[2]))}let mt=(1<<ye-me.zoom)*J*ot;if(mt*=tt(Math.max(Je,Se),xt),xt<mt)return!0;let ht=me.aabb.closestPoint(M);return ht[0]===M[0]&&ht[1]===M[1]};if(this.renderWorldCopies)for(let me=1;me<=3;me++)ue.push(ie(-me)),ue.push(ie(me));for(ue.push(ie(0));ue.length>0;){let me=ue.pop(),Ve=me.x,De=me.y,Ge=me.fullyVisible,ot=()=>this.projection.name==="globe"&&(me.y===0||me.y===(1<<me.zoom)-1);if(!Ge){let xt=Z?me.aabb.intersects(F):me.aabb.intersectsFlat(F);if(xt===0&&ot()){let Je=new i.cC(me.zoom,Ve,De);xt=i.cD(this,A,Je,!0).intersects(F)}if(xt===0)continue;Ge=xt===2}if(me.zoom!==ye&&Ie(me))for(let xt=0;xt<4;xt++){let Je=(Ve<<1)+xt%2,it=(De<<1)+(xt>>1),wt={aabb:x?me.aabb.quadrant(xt):i.cE(this,A,me.zoom+1,Je,it,me.wrap,me.minZ,me.maxZ,this.projection),zoom:me.zoom+1,x:Je,y:it,wrap:me.wrap,fullyVisible:Ge,tileID:void 0,shouldSplit:void 0,minZ:me.minZ,maxZ:me.maxZ};y&&!L&&(wt.tileID=new i.aP(me.zoom+1===ye?Pe:me.zoom+1,me.wrap,me.zoom+1,Je,it),Be(wt)),ue.push(wt)}else{let xt=me.zoom===ye?Pe:me.zoom;if(t.minzoom&&t.minzoom>xt)continue;let Je=0;if(!Ge){let ht=Z?me.aabb.intersectsPrecise(F):me.aabb.intersectsPreciseFlat(F);if(ht===0&&ot()){let gt=new i.cC(me.zoom,Ve,De);ht=i.cD(this,A,gt,!0).intersectsPrecise(F)}if(ht===0)continue;if(t.calculateQuadrantVisibility)if(F.containsPoint(me.aabb.center))Je=15;else for(let gt=0;gt<4;gt++)me.aabb.quadrant(gt).intersects(F)!==0&&(Je|=1<<gt)}let it=M[0]-(.5+Ve+(me.wrap<<me.zoom))*(1<<o-me.zoom),wt=M[1]-.5-De,mt=me.tileID?me.tileID:new i.aP(xt,me.wrap,me.zoom,Ve,De);t.calculateQuadrantVisibility&&(mt.visibleQuadrants=Je),be.push({tileID:mt,distanceSq:it*it+wt*wt})}}if(this.fogCullDistSq){let me=this.fogCullDistSq,Ve=this.horizonLineFromTop();be=be.filter(De=>{let Ge=[0,0,0,1],ot=[i.al,i.al,0,1],xt=this.calculateFogTileMatrix(De.tileID.toUnwrapped());i.aC(Ge,Ge,xt),i.aC(ot,ot,xt);let Je=i.cF([],Ge,ot),it=i.cG([],Ge,ot),wt=i.c_(Je,it);if(wt===0)return!0;let mt=!1,ht=this._elevation;if(ht&&wt>me&&Ve!==0){let gt=this.calculateProjMatrix(De.tileID.toUnwrapped()),Ot;t.isTerrainDEM||(Ot=ht.getMinMaxForTile(De.tileID)),Ot||(Ot={min:Q,max:ae});let fn=i.cH(this.rotation),vn=[fn[0]*i.al,fn[1]*i.al,Ot.max];i.af(vn,vn,gt),mt=(1-vn[1])*this.height*.5<Ve}return wt<me||mt})}return be.sort((me,Ve)=>me.distanceSq-Ve.distanceSq).map(me=>me.tileID)}resize(t,o){this.width=t,this.height=o,this.pixelsToGLUnits=[2/t,-2/o],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log2(t)}project(t){let o=i.aA(t.lat,-i.cI,i.cI),h=this.projection.project(t.lng,o);return new i.P(h.x*this.worldSize,h.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/i.ce(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,o){let h,g,y=this.centerPoint;if(this.projection.name==="globe"){let E=this.worldSize;h=(o.x-y.x)/E,g=(o.y-y.y)/E}else{let E=this.pointCoordinate(o),T=this.pointCoordinate(y);h=E.x-T.x,g=E.y-T.y}let x=this.locationCoordinate(t);this.setLocation(new i.ae(x.x-h,x.y-g))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,o){return this.projection.locationPoint(this,t,o)}locationPoint3D(t,o){return this.projection.locationPoint(this,t,o,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,o){return this.coordinateLocation(this.pointCoordinate3D(t,o))}locationCoordinate(t,o){let h=o?i.ce(o,t.lat):void 0,g=this.projection.project(t.lng,t.lat);return new i.ae(g.x,g.y,h)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,o){let h=o??this._centerAltitude,g=[t.x,t.y,0,1],y=[t.x,t.y,1,1];i.aC(g,g,this.pixelMatrixInverse),i.aC(y,y,this.pixelMatrixInverse);let x=y[3];i.cJ(g,g,1/g[3]),i.cJ(y,y,1/x);let E=g[2],T=y[2];return{p0:g,p1:y,t:E===T?0:(h-E)/(T-E)}}screenPointToMercatorRay(t){let o=[t.x,t.y,0,1],h=[t.x,t.y,1,1];return i.aC(o,o,this.pixelMatrixInverse),i.aC(h,h,this.pixelMatrixInverse),i.cJ(o,o,1/o[3]),i.cJ(h,h,1/h[3]),o[2]=i.ce(o[2],this._center.lat)*this.worldSize,h[2]=i.ce(h[2],this._center.lat)*this.worldSize,i.cJ(o,o,1/this.worldSize),i.cJ(h,h,1/this.worldSize),new i.ax([o[0],o[1],o[2]],i.aw([],i.av([],h,o)))}rayIntersectionCoordinate(t){let{p0:o,p1:h,t:g}=t,y=i.ce(o[2],this._center.lat),x=i.ce(h[2],this._center.lat);return new i.ae(i.ak(o[0],h[0],g)/this.worldSize,i.ak(o[1],h[1],g)/this.worldSize,i.ak(y,x,g))}pointCoordinate(t,o=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,o)}pointCoordinate3D(t,o){if(!this.elevation)return this.pointCoordinate(t,o);let h=this.projection.pointCoordinate3D(this,t.x,t.y);if(h)return new i.ae(h[0],h[1],h[2]);let g=0,y=this.horizonLineFromTop();if(t.y>y)return this.pointCoordinate(t,o);let x=.02*y,E=t.clone();for(let T=0;T<10&&y-g>x;T++){E.y=i.ak(g,y,.66);let A=this.projection.pointCoordinate3D(this,E.x,E.y);A?(y=E.y,h=A):g=E.y}return h?new i.ae(h[0],h[1],h[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=i.cK)return!this.isPointAboveHorizon(t);let o=this.pointCoordinate(t);return o.y>=0&&o.y<=1}_coordinatePoint(t,o){let h=o&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,g=[t.x*this.worldSize,t.y*this.worldSize,h+t.toAltitude(),1];return i.aC(g,g,this.pixelMatrix),g[3]>0?new i.P(g[0]/g[3],g[1]/g[3]):new i.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:t,left:o}=this._edgeInsets,h=this.height-this._edgeInsets.bottom,g=this.width-this._edgeInsets.right,y=this.pointLocation3D(new i.P(o,t)),x=this.pointLocation3D(new i.P(g,t)),E=this.pointLocation3D(new i.P(g,h)),T=this.pointLocation3D(new i.P(o,h)),A=Math.min(y.lng,x.lng,E.lng,T.lng),M=Math.max(y.lng,x.lng,E.lng,T.lng),L=Math.min(y.lat,x.lat,E.lat,T.lat),R=Math.max(y.lat,x.lat,E.lat,T.lat),F=Math.pow(2,-this.zoom)/16*270,z=this.projection.name==="globe"?1:4,j=(q,$,Z,J,Y)=>{let ae=(q+Z)/2,Q=($+J)/2,ce=new i.P(ae,Q),{lng:se,lat:ie}=this.pointLocation3D(ce),ue=Math.max(0,A-se,L-ie,se-M,ie-R);A=Math.min(A,se),M=Math.max(M,se),L=Math.min(L,ie),R=Math.max(R,ie),(Y<z||ue>F)&&(j(q,$,ae,Q,Y+1),j(ae,Q,Z,J,Y+1))};if(j(o,t,g,t,1),j(g,t,g,h,1),j(g,h,o,h,1),j(o,h,o,t,1),this.projection.name==="globe"){let[q,$]=i.cL(this);q?(R=90,M=180,A=-180):$&&(L=-90,M=180,A=-180)}return new i.aI(new i.aS(A,L),new i.aS(M,R))}_getBoundsRectangular(t,o){let{top:h,left:g}=this._edgeInsets,y=this.height-this._edgeInsets.bottom,x=this.width-this._edgeInsets.right,E=new i.P(g,h),T=new i.P(x,h),A=new i.P(x,y),M=new i.P(g,y),L=this.pointCoordinate(E,t),R=this.pointCoordinate(T,t),F=this.pointCoordinate(A,o),z=this.pointCoordinate(M,o),j=(q,$)=>($.y-q.y)/($.x-q.x);return L.y>1&&R.y>=0?L=new i.ae((1-z.y)/j(z,L)+z.x,1):L.y<0&&R.y<=1&&(L=new i.ae(-z.y/j(z,L)+z.x,0)),R.y>1&&L.y>=0?R=new i.ae((1-F.y)/j(F,R)+F.x,1):R.y<0&&L.y<=1&&(R=new i.ae(-F.y/j(F,R)+F.x,0)),new i.aI().extend(this.coordinateLocation(L)).extend(this.coordinateLocation(R)).extend(this.coordinateLocation(z)).extend(this.coordinateLocation(F))}_getBoundsRectangularTerrain(){let t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);let o=t.visibleDemTiles.reduce((h,g)=>{if(g.dem){let y=g.dem.tree;h.min=Math.min(h.min,y.minimums[0]),h.max=Math.max(h.max,y.maximums[0])}return h},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(o.min*t.exaggeration(),o.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){let o=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,h=this.height/2-o*(1-this._horizonShift);return t?Math.max(0,h):h}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-i.cI,this.maxLat=i.cI,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=i.aF(this.minLng)*this.tileSize,this.worldMaxX=i.aF(this.maxLng)*this.tileSize,this.worldMinY=i.aJ(this.maxLat)*this.tileSize,this.worldMaxY=i.aJ(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,o){return this.projection.createTileMatrix(this,o,t)}calculateDistanceTileData(t){let o=t.key,h=this._distanceTileDataCache;if(h[o])return h[o];let g=t.canonical,y=1/this.height,x=this.cameraWorldSize,E=x/this.zoomScale(g.z),T=(g.x+Math.pow(2,g.z)*t.wrap)*E,A=g.y*E,M=this.point;M.x*=x/this.worldSize,M.y*=x/this.worldSize;let L=this.angle,R=Math.sin(-L),F=-Math.cos(-L);return h[o]={bearing:[R,F],center:[(M.x-T)*y,(M.y-A)*y],scale:E/i.al*y},h[o]}calculateFogTileMatrix(t){let o=t.key,h=this._fogTileMatrixCache;if(h[o])return h[o];let g=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return i.aB(g,this.worldToFogMatrix,g),h[o]=new Float32Array(g),h[o]}calculateProjMatrix(t,o=!1,h=!1){let g=t.key,y;if(y=h?this._expandedProjMatrixCache:o?this._alignedProjMatrixCache:this._projMatrixCache,y[g])return y[g];let x=this.calculatePosMatrix(t,this.worldSize),E;return E=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:h?this.expandedFarZProjMatrix:o?this.alignedProjMatrix:this.projMatrix,i.aB(x,E,x),y[g]=new Float32Array(x),y[g]}calculatePixelsToTileUnitsMatrix(t){let o=t.tileID.key,h=this._pixelsToTileUnitsCache;if(h[o])return h[o];let g=i.cM(t,this);return h[o]=g,h[o]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){let t=1/this.worldSize,o=i.bp([],[t,t,t]);return i.aB(o,o,this.globeMatrix),o}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;let t=this._elevation;this._updateCameraState();let o=i.ce(1,this._center.lat)*this.worldSize,h=this._computeCameraPosition(o),g=this._camera.forward(),y=i.ce(1,this._center.lat);h[2]/=y,g[2]/=y,i.aw(g,g);let x=t.raycast(h,g,t.exaggeration());if(x){let E=i.bG([],h,g,x),T=new i.ae(E[0],E[1],i.ce(E[2],i.a_(E[1]))),A=(T.z+i.ag([T.x-h[0],T.y-h[1],T.z-h[2]*y]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(A),this._centerAltitude=T.toAltitude(),this._center=this.coordinateLocation(T),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;let o=this._elevation,h=i.ce(1,this._center.lat)*this.worldSize,g=this._computeCameraPosition(h),y=o.getAtPointOrZero(new i.ae(...g)),x=this.pixelsPerMeter/this.worldSize*y,E=this._minimumHeightOverTerrain(),T=g[2]-x;if(T<=E)if(T<0||t){let A=this.locationCoordinate(this._center,this._centerAltitude),M=[g[0],g[1],A.z-g[2]],L=i.ag(M);M[2]-=(E-T)/this._pixelsPerMercatorPixel;let R=i.ag(M);if(R===0)return;i.c4(M,M,L/R*this._pixelsPerMercatorPixel),this._camera.position=[g[0],g[1],A.z*this._pixelsPerMercatorPixel-M[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){let R=this.center;return R.lat=i.aA(R.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(R.lng=i.aA(R.lng,this.minLng,this.maxLng)),this.center=R,void(this._constraining=!1)}let o=this._unmodified,{x:h,y:g}=this.point,y=0,x=h,E=g,T=this.width/2,A=this.height/2,M=this.worldMinY*this.scale,L=this.worldMaxY*this.scale;if(g-A<M&&(E=M+A),g+A>L&&(E=L-A),L-M<this.height&&(y=Math.max(y,this.height/(L-M)),E=(L+M)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let R=this.worldMinX*this.scale,F=this.worldMaxX*this.scale,z=this.worldSize/2-(R+F)/2;x=(h+z+this.worldSize)%this.worldSize-z,x-T<R&&(x=R+T),x+T>F&&(x=F-T),F-R<this.width&&(y=Math.max(y,this.width/(F-R)),x=(F+R)/2)}x===h&&E===g||this._allowWorldUnderZoom||(this.center=this.unproject(new i.P(x,E))),y&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(y)),this._constrainCamera(),this._unmodified=o,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;let t=this.centerOffset,o=this.projection.name==="globe",h=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=i.ce(1,this.center.lat)/i.ce(1,i.d1));let g=i.cN(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,g),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let y=this.projection.zAxisUnit==="meters"?h:1,x=this._camera.getWorldToCamera(this.worldSize,y),E,T=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(T[8]=2*-t.x/this.width,T[9]=2*t.y/this.height,this.isOrthographic){let ie=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ue=ie*this.aspect,be=-ue,ye=-ie;ue-=t.x,be-=t.x,ie+=t.y,ye+=t.y,E=this._camera.getCameraToClipOrthographic(be,ue,ye,ie,this._nearZ,this._farZ),((Pe,Se,Be,tt)=>{for(let Ie=0;Ie<16;Ie++)Pe[Ie]=i.ak(Se[Ie],Be[Ie],tt)})(E,E,T,i.c$(this.pitch>=ic?1:this.pitch/ic))}else E=T;let A=i.cO([],T,x),M=i.cO([],E,x);if(this.projection.isReprojectedInTileSpace){let ie=this.locationCoordinate(this.center),ue=i.bz([]);i.bq(ue,ue,[ie.x*this.worldSize,ie.y*this.worldSize,0]),i.aB(ue,ue,i.cP(this)),i.bq(ue,ue,[-ie.x*this.worldSize,-ie.y*this.worldSize,0]),i.aB(M,M,ue),i.aB(A,A,ue),this.inverseAdjustmentMatrix=i.cQ(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=i.cR([],M,[this.worldSize,this.worldSize,this.worldSize/y,1]),this.projMatrix=M,this.invProjMatrix=i.bk(new Float64Array(16),this.projMatrix),o){let ie=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);ie[8]=2*-t.x/this.width,ie[9]=2*t.y/this.height,this.expandedFarZProjMatrix=i.cO([],ie,x)}else this.expandedFarZProjMatrix=this.projMatrix;let L=i.bk([],E);this.frustumCorners=i.cS.fromInvProjectionMatrix(L,this.horizonLineFromTop(),this.height),this.cameraFrustum=i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!o);let R=new Float32Array(16);i.bz(R),i.cR(R,R,[1,-1,1]),i.cT(R,R,this._pitch),i.bA(R,R,this.angle);let F=i.cc(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=i.by(F);let z=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;F[8]=2*-t.x/this.width,F[9]=2*(t.y+z)/this.height,this.skyboxMatrix=i.aB(R,F,R);let j=this.point,q=j.x,$=j.y,Z=this.width%2/2,J=this.height%2/2,Y=Math.cos(this.angle),ae=Math.sin(this.angle),Q=q-Math.round(q)+Y*Z+ae*J,ce=$-Math.round($)+Y*J+ae*Z,se=new Float64Array(M);if(i.bq(se,se,[Q>.5?Q-1:Q,ce>.5?ce-1:ce,0]),this.alignedProjMatrix=se,M=i.bB(),i.cR(M,M,[this.width/2,-this.height/2,1]),i.bq(M,M,[1,-1,0]),this.labelPlaneMatrix=M,M=i.bB(),i.cR(M,M,[1,-1,1]),i.bq(M,M,[-1,-1,0]),i.cR(M,M,[2/this.width,2/this.height,1]),this.glCoordMatrix=M,this.pixelMatrix=i.aB(new Float64Array(16),this.labelPlaneMatrix,A),this._calcFogMatrices(),this._distanceTileDataCache={},M=i.bk(new Float64Array(16),this.pixelMatrix),!M)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=M,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=i.cU(this);let ie=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=i.af(ie,ie,x),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=M;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let t=this.cameraWorldSizeForFog,o=this.cameraPixelsPerMeter,h=this._camera.position,g=1/this.height/this._pixelsPerMercatorPixel,y=[t,t,o];i.c4(y,y,g),i.c4(h,h,-1),i.cV(h,h,y);let x=i.bB();i.bq(x,x,h),i.cR(x,x,y),this.mercatorFogMatrix=x,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,o,g)}_computeCameraPosition(t){let o=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,h=this._camera.forward(),g=this.point,y=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*o-t/this.worldSize*this._centerAltitude;return[g.x/this.worldSize-h[0]*y,g.y/this.worldSize-h[1]*y,t/this.worldSize*this._centerAltitude-h[2]*y]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){let o=this._maxCameraBoundsDistance()*Math.cos(this._pitch),h=this._camera.position[2],g=t[2],y=1;this.projection.wrap&&(this.center=this.center.wrap()),g>0&&(y=Math.min((o-h)/g,1)),this._camera.position=i.bG([],this._camera.position,t,y),this._updateStateFromCamera()}_updateStateFromCamera(){let t=this._camera.position,o=this._camera.forward(),{pitch:h,bearing:g}=this._camera.getPitchBearing(),y=i.ce(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,x=this._mercatorZfromZoom(this._maxZoom)*Math.cos(i.an(this._maxPitch)),E=Math.max((t[2]-y)/Math.cos(h),x),T=this._zoomFromMercatorZ(E);i.bG(t,t,o,E),this._pitch=i.aA(h,i.an(this.minPitch),i.an(this.maxPitch)),this.angle=i.bS(g,-Math.PI,Math.PI),this._setZoom(i.aA(T,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new i.ae(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){let t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let o=0,h=i.cK,g=0,y=1/0;for(;h-o>1e-6&&h>o;){let x=o+.5*(h-o),E=this.tileSize*Math.pow(2,x),T=this.getCameraToCenterDistance(this.projection,x,E),A=this.scaleZoom(T/(Math.max(0,t)*this.tileSize)),M=Math.abs(x-A);M<y&&(y=M,g=x),x<A?o=x:h=x}return g}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(i.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,o){let h=Math.min(t.x,o.x),g=Math.max(t.x,o.x),y=Math.min(t.y,o.y),x=Math.max(t.y,o.y);if(y<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;let E=[new i.P(h,y),new i.P(g,x),new i.P(h,x),new i.P(g,y)],T=this.renderWorldCopies?-3:0,A=this.renderWorldCopies?4:1;for(let M of E){let L=this.pointRayIntersection(M);if(L.t<0)return!0;let R=this.rayIntersectionCoordinate(L);if(R.x<T||R.y<0||R.x>A||R.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+i.cW(this.fovAboveCenter)>88||this.anyCornerOffEdge(new i.P(0,0),new i.P(this.width,this.height))}zoomDeltaToMovement(t,o){let h=i.ag(i.av([],this._camera.position,t)),g=this._zoomFromMercatorZ(h)+o;return h-this._mercatorZfromZoom(g)}getCameraPoint(){if(this.projection.name==="globe"){let t=(function([o,h,g],y){let x=[o,h,g,1];i.aC(x,x,y);let E=x[3]=Math.max(x[3],1e-6);return x[0]/=E,x[1]/=E,x[2]/=E,x})([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new i.P(t[0],t[1])}{let t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new i.P(0,t))}}getCameraToCenterDistance(t,o=this.zoom,h=this.worldSize){let g=i.cN(t,o,this.width,this.height,1024),y=t.pixelSpaceConversion(this.center.lat,h,g),x=.5/Math.tan(.5*this._fov)*this.height*y;return this.isOrthographic&&(x=i.ak(1,x,i.c$(this.pitch>=ic?1:this.pitch/ic))),x}getWorldToCameraMatrix(){let t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&i.aB(t,t,this.globeMatrix),t}getFrustum(t){return i.cA.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}let Fa=(d,t)=>{if(t>0&&d.terrain&&i.w("Cutoff is currently disabled on terrain"),t<=0||d.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let o=d.transform,h=Math.max(Math.abs(o._zoom-(d.minCutoffZoom-1)),1),g=o.isLODDisabled(!1)?i.ah(60,45,o.pitch):i.ah(30,15,o.pitch),y=o._farZ-o._nearZ,x=t*o.height,E=((1-(T=g))*o.cameraToCenterDistance+T*(o._farZ+x))*h;var T;return{shouldRenderCutoff:g<1,uniformValues:{u_cutoff_params:[o._nearZ,o._farZ,(E-o._nearZ)/y,(E-x-o._nearZ)/y]}}},kr={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class D1{constructor(t,o){this.aabb=t,this.lastCascade=o}}class C1{add(t,o){let h=this.receivers[t.key];h!==void 0?(h.aabb.min[0]=Math.min(h.aabb.min[0],o.min[0]),h.aabb.min[1]=Math.min(h.aabb.min[1],o.min[1]),h.aabb.min[2]=Math.min(h.aabb.min[2],o.min[2]),h.aabb.max[0]=Math.max(h.aabb.max[0],o.max[0]),h.aabb.max[1]=Math.max(h.aabb.max[1],o.max[1]),h.aabb.max[2]=Math.max(h.aabb.max[2],o.max[2])):this.receivers[t.key]=new D1(o,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,o,h){let g=i.d8.fromPoints(t.points),y=0;for(let x in this.receivers){let E=this.receivers[x];if(!E||!g.intersectsAabb(E.aabb))continue;E.aabb.min=g.closestPoint(E.aabb.min),E.aabb.max=g.closestPoint(E.aabb.max);let T=E.aabb.getCorners();for(let A=0;A<h.length;A++){let M=!0;for(let L of T){let R=[L[0]*o,L[1]*o,L[2]];if(i.af(R,R,h[A].matrix),R[0]<-1||R[0]>1||R[1]<-1||R[1]>1){M=!1;break}}if(E.lastCascade=A,y=Math.max(y,A),M)break}}return y+1}}class Vd{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new C1,this._depthMode=new Tt(t.context.gl.LEQUAL,Tt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(kr,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(kr,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(kr,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,o){let h=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!o||!o.properties)return;let g=o.properties.get("shadow-intensity");if(!o.shadowsEnabled()||g<=0||(this._shadowLayerCount=h.style.order.reduce((z,j)=>{let q=h.style._mergedLayers[j];return z+(q.hasShadowPass()&&!q.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let y=h.context,x=kr.shadowMapResolution,E=kr.shadowMapResolution;if(this._cascades.length===0||kr.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let z=0;z<kr.cascadeCount;++z){let j=h._shadowMapDebug,q=y.gl,$=y.createFramebuffer(x,E,j,"texture"),Z=new i.T(y,{width:x,height:E,data:null},q.DEPTH_COMPONENT16);if($.depthAttachment.set(Z.texture),j){let J=new i.T(y,{width:x,height:E,data:null},q.RGBA8);$.colorAttachment.set(J.texture)}this._cascades.push({framebuffer:$,texture:Z,matrix:[],far:0,boundingSphereRadius:0,frustum:new i.cA,scale:0})}}this.shadowDirection=Cv(o);let T=0;if(t.elevation){let z=t.elevation,j=[1e4,-1e4];z.visibleDemTiles.filter(q=>q.dem).forEach(q=>{let $=q.dem.tree;j[0]=Math.min(j[0],$.minimums[0]),j[1]=Math.max(j[1],$.maximums[0])}),j[0]!==1e4&&(T=(j[1]-j[0])*z.exaggeration())}let A=1.5*t.cameraToCenterDistance,M=3*A,L=new Float64Array(16);for(let z=0;z<this._cascades.length;++z){let j=this._cascades[z],q=t.height/50,$=1;kr.cascadeCount===1?$=M:z===0?$=A:(q=A,$=M);let[Z,J]=Av(t,this.shadowDirection,q,$,kr.shadowMapResolution,T);j.scale=t.scale,j.matrix=Z,j.boundingSphereRadius=J,i.bk(L,j.matrix),j.frustum=i.cA.fromInvProjectionMatrix(L,1,0,!0),j.far=$}let R=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[R].far,this._cascades[R].far],this._uniformValues.u_shadow_intensity=g,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/kr.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=kr.shadowMapResolution,this._uniformValues.u_shadowmap_0=Fr.ShadowMap0,this._uniformValues.u_shadowmap_1=Fr.ShadowMap0+1,this._groundShadowTiles=h.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let F=h.transform.elevation;for(let z of this._groundShadowTiles){let j={min:0,max:0};if(F){let q=F.getMinMaxForTile(z);q&&(j=q)}this.addShadowReceiver(z.toUnwrapped(),j.min,j.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,o){if(!this.enabled)return;let h=this.painter,g=h.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(h.transform.getFrustum(0),h.transform.worldSize,this._cascades),g.viewport.set([0,0,kr.shadowMapResolution,kr.shadowMapResolution]);for(let y=0;y<this._numCascadesToRender;++y){h.currentShadowCascade=y,g.bindFramebuffer.set(this._cascades[y].framebuffer.framebuffer),g.clear({color:i.ao.white,depth:1});for(let x of t.order){let E=t._mergedLayers[x];if(!E.hasShadowPass()||E.isHidden(h.transform.zoom))continue;let T=t.getLayerSourceCache(E),A=T?o[T.id]:void 0;(E.type==="model"||A&&A.length)&&h.renderLayer(h,T,E,A)}}h.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let t=this.painter,o=t.style,h=t.context,g=h.gl,y=o.directionalLight,x=o.ambientLight;if(!y||!x)return;let E=[],T=Fa(t,t.longestCutoffRange);T.shouldRenderCutoff&&E.push("RENDER_CUTOFF"),E.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&E.push("NORMAL_OFFSET");let A=ws(o,y,x),M=new Tt(g.LEQUAL,Tt.ReadOnly,t.depthRangeFor3D),L=new qt({func:g.EQUAL,mask:255},0,255,g.KEEP,g.KEEP,g.KEEP);for(let R of this._groundShadowTiles){let F=R.toUnwrapped(),z=t.isTileAffectedByFog(R),j=t.getOrCreateProgram("groundShadow",{defines:E,overrideFog:z});this.setupShadows(F,j),t.uploadCommonUniforms(h,j,F,null,T);let q={u_matrix:t.transform.calculateProjMatrix(F),u_ground_shadow_factor:A};j.draw(t,g.TRIANGLES,M,L,rn.multiply,jt.disabled,q,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?rn.unblended:rn.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){let o=this.painter.transform,h=o.calculatePosMatrix(t,o.worldSize);return i.aB(h,this._cascades[this.painter.currentShadowCascade].matrix,h),Float32Array.from(h)}calculateShadowPassMatrixFromMatrix(t){let o=i.by(t);return i.aB(o,this._cascades[this.painter.currentShadowCascade].matrix,t),o}setupShadows(t,o,h){if(!this.enabled)return;let g=this.painter.transform,y=this.painter.context,x=y.gl,E=this._uniformValues,T=new Float64Array(16),A=g.calculatePosMatrix(t,g.worldSize);for(let M=0;M<this._cascades.length;M++)i.aB(T,this._cascades[M].matrix,A),E[M===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(T),y.activeTexture.set(x.TEXTURE0+Fr.ShadowMap0+M),this._cascades[M].texture.bindExtraParam(x.LINEAR,x.LINEAR,x.CLAMP_TO_EDGE,x.CLAMP_TO_EDGE,x.GREATER);if(this.useNormalOffset=!!h,this.useNormalOffset){let M=i.d6(t.canonical),L=2/g.tileSize*i.al/kr.shadowMapResolution,R=L*this._cascades[0].boundingSphereRadius,F=L*this._cascades[this._cascades.length-1].boundingSphereRadius,z=(h==="vector-tile"?1:3)*(function(j,q,$,Z,J){let Y=i.aA((j-22)/-22,0,1);return .125*(1-Y)+4*Y})(g.zoom);E.u_shadow_normal_offset=[M,R*z,F*z],E.u_shadow_bias=[1e-4,.0012,.012]}else E.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(y,E)}setupShadowsFromMatrix(t,o,h=!1){if(!this.enabled)return;let g=this.painter.context,y=g.gl,x=this._uniformValues,E=new Float64Array(16);for(let T=0;T<kr.cascadeCount;T++)i.aB(E,this._cascades[T].matrix,t),x[T===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),g.activeTexture.set(y.TEXTURE0+Fr.ShadowMap0+T),this._cascades[T].texture.bindExtraParam(y.LINEAR,y.LINEAR,y.CLAMP_TO_EDGE,y.CLAMP_TO_EDGE,y.GREATER);if(this.useNormalOffset=h,h){let T=kr.normalOffset;x.u_shadow_normal_offset=[1,T,T],x.u_shadow_bias=[6e-5,.0012,.012]}else x.u_shadow_bias=[36e-5,.0012,.012];o.setShadowUniformValues(g,x)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,o,h,g){if(g[2]>=0)return{};let y=(function(T,A,M){let L=M/(1<<T.canonical.z);return new i.d8([T.canonical.x*L+T.wrap*M,T.canonical.y*L+T.wrap*M,0],[(T.canonical.x+1)*L+T.wrap*M,(T.canonical.y+1)*L+T.wrap*M,A])})(t,o,h).getCorners(),x=o/-g[2];g[0]<0?(i.d7(y[0],y[0],[g[0]*x,0,0]),i.d7(y[3],y[3],[g[0]*x,0,0])):g[0]>0&&(i.d7(y[1],y[1],[g[0]*x,0,0]),i.d7(y[2],y[2],[g[0]*x,0,0])),g[1]<0?(i.d7(y[0],y[0],[0,g[1]*x,0]),i.d7(y[1],y[1],[0,g[1]*x,0])):g[1]>0&&(i.d7(y[2],y[2],[0,g[1]*x,0]),i.d7(y[3],y[3],[0,g[1]*x,0]));let E={};return E.vertices=y,E.planes=[hl(y[1],y[0],y[4]),hl(y[2],y[1],y[5]),hl(y[3],y[2],y[6]),hl(y[0],y[3],y[7])],E}addShadowReceiver(t,o,h){this._receivers.add(t,i.d8.fromTileIdAndHeight(t,o,h))}getMaxCascadeForTile(t){let o=this._receivers.get(t);return o&&o.lastCascade?o.lastCascade:0}}function hl(d,t,o){let h=i.av([],o,t),g=i.av([],d,t),y=i.bH([],h,g),x=i.ag(y);return x===0?[0,0,1,0]:(i.c4(y,y,1/x),[y[0],y[1],y[2],-i.bI(y,t)])}function Cv(d){let t=d.properties.get("direction"),o=i.d3(t.x,t.y,t.z);o[2]=i.aA(o[2],0,75);let h=i.d5([o[0],o[1],o[2]]);return i.d4(h.x,h.y,h.z)}function ws(d,t,o){let h=t.properties.get("color-use-theme")==="none",g=t.properties.get("color"),y=t.properties.get("intensity"),x=t.properties.get("direction"),E=[x.x,x.y,x.z],T=o.properties.get("color-use-theme")==="none",A=o.properties.get("color"),M=o.properties.get("intensity"),L=Math.max(i.bI([0,0,1],E),0),R=[0,0,0];i.c4(R,A.toPremultipliedRenderColor(T?null:d.getLut(t.scope)).toArray01Linear().slice(0,3),M);let F=[0,0,0];return i.c4(F,g.toPremultipliedRenderColor(h?null:d.getLut(o.scope)).toArray01Linear().slice(0,3),L*y),i.da([R[0]>0?R[0]/(R[0]+F[0]):0,R[1]>0?R[1]/(R[1]+F[1]):0,R[2]>0?R[2]/(R[2]+F[2]):0])}function Av(d,t,o,h,g,y){let x=d.zoom,E=d.scale,T=d.worldSize,A=1/T,M=d.aspect,L=Math.sqrt(1+M*M)*Math.tan(.5*d.fovX),R=L*L,F=h-o,z=h+o,j,q;R>F/z?(j=h,q=h*L):(j=.5*z*(1+R),q=.5*Math.sqrt(F*F+2*(h*h+o*o)*R+z*z*R*R));let $=d.projection.pixelsPerMeter(d.center.lat,T),Z=d._camera.getCameraToWorldMercator(),J=[0,0,-j*A];i.af(J,J,Z);let Y=q*A,ae=d._edgeInsets;if(!(ae.left===0&&ae.top===0&&ae.right===0&&ae.bottom===0||ae.left===ae.right&&ae.top===ae.bottom)){let Ge=d._camera.getWorldToCamera(d.worldSize,d.projection.zAxisUnit==="meters"?$:1),ot=d._camera.getCameraToClipPerspective(d._fov,d.width/d.height,o,h);ot[8]=2*-d.centerOffset.x/d.width,ot[9]=2*d.centerOffset.y/d.height;let xt=new Float64Array(16);i.cO(xt,ot,Ge);let Je=new Float64Array(16);i.bk(Je,xt);let it=i.cA.fromInvProjectionMatrix(Je,T,x,!0);for(let wt of it.points){let mt=((Q=wt)[0]/=E,Q[1]/=E,Q[2]=i.ce(Q[2],d._center.lat),Q);Y=Math.max(Y,i.c5(i.d9([],J,mt)))}}var Q;Y*=g/(g-1);let ce=Math.acos(t[2]),se=Math.atan2(-t[0],-t[1]),ie=new _f;ie.position=J,ie.setPitchBearing(ce,se);let ue=ie.getWorldToCamera(T,$),be=Y*T,ye=Math.min(d._mercatorZfromZoom(17)*T*-2,-2*be),Pe=ie.getCameraToClipOrthographic(-be,be,-be,be,ye,(be+y*$)/t[2]),Se=new Float64Array(16);i.aB(Se,Pe,ue);let Be=i.d4(Math.floor(1e6*J[0])/1e6*T,Math.floor(1e6*J[1])/1e6*T,0),tt=.5*g,Ie=[0,0,0];i.af(Ie,Be,Se),i.c4(Ie,Ie,tt);let me=[Math.floor(Ie[0]),Math.floor(Ie[1]),Math.floor(Ie[2])],Ve=[0,0,0];i.av(Ve,Ie,me),i.c4(Ve,Ve,-1/tt);let De=new Float64Array(16);return i.bz(De),i.bq(De,De,Ve),i.aB(Se,De,Se),[Se,be]}class yf extends i.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,o){return i.db(this.requestManager.transformRequest(o,i.R.Model).url).then(h=>{if(!h)return;let g=i.dc(h),y=new i.dd(t,o,void 0,void 0,g);return y.computeBoundsAndApplyParent(),y}).catch(h=>{if(h&&h.status===404)return null;this.fire(new i.y(new Error(`Could not load model ${t} from ${o}: ${h.message}`)))})}load(t,o,h={forceReload:!1}){this.models[o]||(this.models[o]={});let g=Object.keys(t),y=[],x=[];for(let E of g){let T=t[E];this.hasURLBeenRequested(T)&&!h.forceReload||(this.modelByURL[T]={modelId:E,scope:o},y.push(this.loadModel(E,T)),x.push(E)),this.models[o][E]||(this.models[o][E]={model:null,numReferences:1})}this.numModelsLoading[o]=(this.numModelsLoading[o]||0)+x.length,Promise.allSettled(y).then(E=>{for(let T=0;T<E.length;T++){let{status:A}=E[T];if(A==="rejected")continue;let{value:M}=E[T];this.models[o][x[T]]||(this.models[o][x[T]]={model:null,numReferences:1}),this.models[o][x[T]].model=M}this.numModelsLoading[o]-=x.length,this.fire(new i.z("data",{dataType:"style"}))}).catch(E=>{this.fire(new i.y(new Error(`Could not load models: ${E.message}`)))})}isLoaded(){for(let t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,o,h={exactIdMatch:!1}){return!!(h.exactIdMatch?this.getModel(t,o):this.getModelByURL(this.modelUris[o][t]))}getModel(t,o){return this.models[o]||(this.models[o]={}),this.models[o][t]?this.models[o][t].model:void 0}getModelByURL(t){if(!t)return null;let o=this.modelByURL[t];return o?this.models[o.scope][o.modelId].model:null}hasModelBeenAdded(t,o){return this.models[o]&&this.models[o][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,o,h){this.models[h]||(this.models[h]={}),this.modelUris[h]||(this.modelUris[h]={});let g=this.requestManager.normalizeModelURL(o);if((this.hasModel(t,h,{exactIdMatch:!0})||this.hasModelBeenAdded(t,h))&&this.modelUris[h][t]===g)this.models[h][t].numReferences++;else if(this.hasURLBeenRequested(g)){let{scope:y,modelId:x}=this.modelByURL[g];this.models[y][x].numReferences++}else this.modelUris[h][t]=g,this.load({[t]:this.modelUris[h][t]},h)}addModelURLs(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h=this.modelUris[o];for(let g in t)h[g]=this.requestManager.normalizeModelURL(t[g])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,o){this.models[o]||(this.models[o]={}),this.modelUris[o]||(this.modelUris[o]={});let h={};for(let g of t)this.hasModel(g,o,{exactIdMatch:!0})||this.hasURLBeenRequested(g)?this.models[o][g].numReferences++:this.modelUris[o][g]&&!this.hasURLBeenRequested(g)?h[g]=this.modelUris[o][g]:!this.hasURLBeenRequested(g)&&i.de(g,!1)&&(this.modelUris[o][g]=this.requestManager.normalizeModelURL(g),h[g]=this.modelUris[o][g]);this.load(h,o)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,o,h=!1,g=!1){if(this.models[o]&&this.models[o][t]&&(this.models[o][t].numReferences--,this.models[o][t].numReferences===0||g)){let y=this.modelUris[o][t];h||delete this.modelUris[o][t],delete this.modelByURL[y];let x=this.models[o][t].model;if(!x)return;delete this.models[o][t],x.destroy()}}destroy(){for(let t of Object.keys(this.models))for(let o of Object.keys(this.models[t])){let h=this.models[t][o].model;delete this.models[t][o],h&&h.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,o){this.models[o]||(this.models[o]={});for(let h in this.models[o])this.models[o][h].model&&this.models[o][h].model.upload(t.context)}}let jd=i.a6.colorTheme,fl=new i.a9({data:new i.aa(jd.data)});function A1(d){if(!d.metadata||!d.metadata.content_area)return;let t=i.o.devicePixelRatio,{left:o,top:h,width:g,height:y}=d.metadata.content_area,x=o*t,E=h*t;return[x,E,x+g*t,E+y*t]}function Mv(d){if(d)return d.map(([t,o])=>[t*i.o.devicePixelRatio,o*i.o.devicePixelRatio])}class M1{constructor(t,o,h){this.id=t,this.scope=o,this.sourceCache=h,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){let t=new Map;if(!this.sourceCache.loaded())return t;let o=this.sourceCache.getVisibleCoordinates();if(o.length===0)return t;let h=this.sourceCache.getSource();if(!(h instanceof vr))return t;let g=o.map(x=>this.sourceCache.getTile(x)),y=h.getImages(g,Array.from(this.pendingRequests));for(let[x,E]of y)t.set(i.I.from({name:x,iconsetId:this.id}),E),this.pendingRequests.delete(x);for(let x of this.pendingRequests)this.missingRequests.add(x);return this.pendingRequests.clear(),t}}let pl=(d,t)=>H(d,t&&t.filter(o=>o.identifier!=="source.canvas")),R1=i.aH(Pn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setLayerProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),ig=i.aH(Pn,["setCenter","setZoom","setBearing","setPitch"]),vf=new Set(["background","sky","slot","custom"]),rg={version:8,layers:[],sources:{}},og={duration:300,delay:0};class Es extends i.E{constructor(t,o={}){super(),this.map=t,this.scope=o.scope||"",this.globalId=null,this.fragments=[],this.importDepth=o.importDepth||0,this.importsCache=o.importsCache||new Map,this.resolvedImports=o.resolvedImports||new Set,this.transition=Object.assign({},og),this._buildingIndex=new Zm(this),this.crossTileSymbolIndex=new La,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedIndoor={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._hasAppearances=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._importedAsBasemap=!1,this._changes=o.styleChanges||new Go,this.dispatcher=o.dispatcher?o.dispatcher:new i.D(i.dg(),this),o.imageManager?this.imageManager=o.imageManager:(this.imageManager=new aa(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=o.glyphManager?o.glyphManager:new i.dh(t._requestManager,o.localFontFamily?i.di.all:o.localIdeographFontFamily?i.di.ideographs:i.di.none,o.localFontFamily||o.localIdeographFontFamily),o.modelManager?this.modelManager=o.modelManager:(this.modelManager=new yf(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=o.configOptions?o.configOptions:new Map,this._configDependentLayers=o.configDependentLayers?o.configDependentLayers:new Set,this._indoorDependentLayers=o.indoorDependentLayers?o.indoorDependentLayers:new Set,this._config=o.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:o.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=o.initialConfig,this.dispatcher.broadcast("setReferrer",i.dj());let h=this;this._rtlTextPluginCallback=Es.registerForPluginStateChange(g=>{h.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:g.pluginStatus,pluginURL:g.pluginURL},(y,x)=>{if(i.dk(y),x&&x.every(E=>E))for(let E in h._sourceCaches){let T=h._sourceCaches[E],A=T.getSource().type;A!=="vector"&&A!=="geojson"||T.reload()}})}),this.on("data",g=>{if(g.dataType!=="source"||g.sourceDataType!=="metadata")return;let y=this.getOwnSource(g.sourceId);if(y&&y.vectorLayerIds)for(let x in this._layers){let E=this._layers[x];E.source===y.id&&this._validateLayer(E)}})}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(i.h(t))return t;let o=i.dl(t);if(!o.startsWith("http"))try{return new URL(o,location.href).toString()}catch{return o}return o}return`json://${i.dm(JSON.stringify(t))}`}_diffStyle(t,o,h){this.globalId=this._getGlobalId(t);let g=(y,x)=>{try{x(null,this.setState(y,h))}catch(E){x(E,!1)}};if(typeof t=="string"){let y=this.map._requestManager.normalizeStyleURL(t),x=this.map._requestManager.transformRequest(y,i.R.Style);i.m(x,(E,T)=>{E?this.fire(new i.y(E)):T&&g(T,o)})}else typeof t=="object"&&g(t,o)}loadURL(t,o={}){this.fire(new i.z("dataloading",{dataType:"style"}));let h=typeof o.validate=="boolean"?o.validate:!i.h(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,o.accessToken),this.resolvedImports.add(t);let g=this.importsCache.get(t);if(g)return this._load(g,h);let y=this.map._requestManager.transformRequest(t,i.R.Style);this._request=i.m(y,(x,E)=>{if(this._request=null,x)this.fire(new i.y(x));else if(E)return this.importsCache.set(t,E),this._load(E,h)})}loadJSON(t,o={}){this.fire(new i.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=i.o.frame(()=>{this._request=null,this._load(t,o.validate!==!1)})}loadEmpty(){this.fire(new i.z("dataloading",{dataType:"style"})),this._load(rg,!1)}_loadImports(t,o,h){if(this.importDepth>=4)return i.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let g=[];for(let y of t){let x=this._createFragmentStyle(y),E=new Promise(M=>{x.once("style.import.load",M),x.once("error",M)}).then(()=>this.mergeAll());if(g.push(E),this.resolvedImports.has(y.url)){x.loadEmpty();continue}let T=y.data||this.importsCache.get(y.url);T?(x.loadJSON(T,{validate:o}),this._isInternalStyle(T)&&(x.globalId=null)):y.url?x.loadURL(y.url,{validate:o}):x.loadEmpty();let A={style:x,id:y.id,config:y.config};if(h){let M=this.fragments.findIndex(({id:L})=>L===h);this.fragments=this.fragments.slice(0,M).concat(A).concat(this.fragments.slice(M))}else this.fragments.push(A)}return Promise.allSettled(g)}getImportGlobalIds(t=this,o=new Set){for(let h of t.fragments)h.style.globalId&&o.add(h.style.globalId),this.getImportGlobalIds(h.style,o);return[...o.values()]}_createFragmentStyle(t){let o=this.scope?i.B(t.id,this.scope):t.id,h,g=this._initialConfig&&this._initialConfig[o];(t.config||g)&&(h=Object.assign({},t.config,g));let y=new Es(this.map,{scope:o,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:h,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers,indoorDependentLayers:this._indoorDependentLayers});return y.setEventedParent(this.map,{style:y}),y}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this._updateLayers(this._indoorDependentLayers),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,o){if(this._isInternalStyle(t)){let y=Object.assign({},rg,{imports:[{id:"basemap",data:t,url:""}]},t.center?{center:t.center}:{},t.bearing?{bearing:t.bearing}:{},t.pitch?{pitch:t.pitch}:{},t.zoom?{zoom:t.zoom}:{},t.light?{light:t.light}:{});return this._importedAsBasemap=!0,void this._load(y,o)}if(this.updateConfig(this._config,t.schema),o&&pl(this,qo(t)))return;this._loaded=!0,this.stylesheet=i.dn(t);let h=()=>{for(let T in t.sources)this.addSource(T,t.sources[T],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(let T in t.iconsets)this.addIconset(T,t.iconsets[T]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);let y=Zc(this.stylesheet.layers);if(this._order=y.map(T=>T.id),this.stylesheet.light&&i.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){let T=this.stylesheet.lights[0];this.light=new fe(T.properties,T.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new fe(this.stylesheet.light)),this._layers={};for(let T of y){let A=i.dt(T,this.scope,this._styleColorTheme.lut,this.options);A.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(A.fqid),A.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(A.fqid),this._hasAppearances=this._hasAppearances||A.getAppearances().length!==0,A.setEventedParent(this,{layer:{id:A.id}}),this._layers[A.id]=A;let M=this.getOwnLayerSourceCache(A),L=!!this.directionalLight&&this.directionalLight.shadowsEnabled();M&&A.canCastShadows()&&L&&(M.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);let x=this.stylesheet.terrain;x&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(x,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new i.z("data",{dataType:"style"}));let E=this.isRootStyle();t.imports?this._loadImports(t.imports,o).then(()=>{this._reloadImports(),this.fire(new i.z(E?"style.load":"style.import.load"))}).catch(T=>{this.fire(new i.y(new Error("Failed to load imports",T))),this.fire(new i.z(E?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new i.z(E?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let g=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(g){let y=this._evaluateColorThemeData(g);this._loadColorTheme(y).then(()=>{h()}).catch(x=>{i.w(`Couldn't load color theme from the stylesheet: ${x}`),h()})}else this._styleColorTheme.lut=null,h()}isRootStyle(){return this.importDepth===0}hasAppearances(){return this._hasAppearances}mergeAll(){let t,o,h,g,y,x,E,T,A,M,L={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(R=>{if(R.stylesheet){if(R.light!=null&&(t=R.light),R.stylesheet.lights)for(let F of R.stylesheet.lights)F.type==="ambient"&&R.ambientLight!=null&&(o=R.ambientLight),F.type==="directional"&&R.directionalLight!=null&&(h=R.directionalLight);g=this._prioritizeTerrain(g,R.terrain,R.stylesheet.terrain),R.stylesheet.fog&&R.fog!=null&&(y=R.fog),R.stylesheet.snow&&R.snow!=null&&(x=R.snow),R.stylesheet.rain&&R.rain!=null&&(E=R.rain),R.stylesheet.camera!=null&&(M=R.stylesheet.camera),R.stylesheet.projection!=null&&(T=R.stylesheet.projection),R.stylesheet.transition!=null&&(A=R.stylesheet.transition),L[R.scope]=R._styleColorTheme}}),this.light=t,this.ambientLight=o,this.directionalLight=h,this.fog=y,this.snow=x,this.rain=E,this._styleColorThemeForScope=L,g===null?delete this.terrain:this.terrain=g,this.camera=M||{"camera-projection":"perspective"},this.projection=T||{name:"mercator"},this.transition=Object.assign({},og,A),this.mergeSources(),this.mergeLayers(),this.mergeIndoor()}forEachFragmentStyle(t){let o=h=>{for(let g of h.fragments)o(g.style);t(h)};o(this)}_prioritizeTerrain(t,o,h){let g=t&&t.drapeRenderMode===0;return h===null?o&&o.drapeRenderMode===0?o:g?t:null:o!=null&&(!t||g||o&&o.drapeRenderMode===1)?o:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(o=>{t=this._prioritizeTerrain(t,o.terrain,o.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(o=>{o.stylesheet.projection!=null&&(t=o.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){let t={},o={},h={};this.forEachFragmentStyle(g=>{for(let y in g._sourceCaches){let x=i.B(y,g.scope);t[x]=g._sourceCaches[y]}for(let y in g._otherSourceCaches){let x=i.B(y,g.scope);o[x]=g._otherSourceCaches[y]}for(let y in g._symbolSourceCaches){let x=i.B(y,g.scope);h[x]=g._symbolSourceCaches[y]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=o,this._mergedSymbolSourceCaches=h}mergeIndoor(){this.forEachFragmentStyle(t=>{if(t.stylesheet&&t.stylesheet.indoor)for(let o of Object.values(t.stylesheet.indoor)){let h=o,g=i.B(h.sourceId,t.scope);this._mergedIndoor[g]=new Set(h.sourceLayers||[])}})}mergeLayers(){let t={},o=[],h={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(x=>{for(let E of x._order){let T=x._layers[E];if(T.type==="slot"){let A=i.dp(E);if(t[A])continue;t[A]=[]}T.slot&&t[T.slot]?t[T.slot].push(T):o.push(T)}}),this._mergedOrder=[];let g=-1,y=(x=[])=>{for(let E of x)if(E.type==="slot"){let T=i.dp(E.id);t[T]&&y(t[T]),this._mergedSlots.push(T)}else{let T=i.B(E.id,E.scope);this._mergedOrder.push(T),h[T]=E,E.is3D(!!this.terrain)&&(this._has3DLayers=!0,g=this._mergedOrder.length-1),E.type==="circle"&&(this._hasCircleLayers=!0),E.type==="symbol"&&(this._hasSymbolLayers=!0),E.type==="clip"&&(this._clipLayerPresent=!0)}};if(y(o),this._has3DLayers){let x={};for(let E=0;E<this._mergedOrder.length;++E){let T=this._mergedOrder[E];x[T]=E===g?1:E<g?h[T].hasOcclusionOpacityProperties?2:0:4}this._mergedOrder.sort((E,T)=>x[E]-x[T])}this._mergedLayers=h,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Object.assign({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?(function(o,h,g,y){let x=Object.assign({},h);for(let T of Object.keys(jd))x[T]===void 0&&(x[T]=jd[T].default);let E=new i.a8(fl,o,new Map(g));return E.setTransitionOrValue(x,g),E.untransitioned().possiblyEvaluate(new i.ac(0,{worldview:void 0}))})(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let o=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((h,g)=>{let y="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void h();let x=t;x.startsWith(y)||(x=y+x);let E=i.I.from("mapbox-reserved-lut"),T=new Image;T.src=x,T.onerror=()=>{this._styleColorTheme.lutLoading=!1,g(new Error("Failed to load image data"))},T.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==o)return void h();this._styleColorTheme.lutLoading=!1;let{width:A,height:M,data:L}=i.o.getImageData(T);if(M>32)return void g(new Error("The height of the image must be less than or equal to 32 pixels."));if(A!==M*M)return void g(new Error("The width of the image must be equal to the height squared."));this.getImage(E)&&this.removeImage(E),this.addImage(E,{data:new i.q({width:A,height:M},L),pixelRatio:1,sdf:!1,usvg:!1,version:0});let R=this.imageManager.getImage(E,this.scope);R?(this._styleColorTheme.lut={image:R.data,data:t},h()):g(new Error("Missing LUT image."))}})}getLut(t){let o=this._styleColorThemeForScope[t];return o?o.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=(function(o,h,g){let y,x,E,T=i.o.devicePixelRatio>1?"@2x":"",A=i.m(h.transformRequest(h.normalizeSpriteURL(o,T,".json"),i.R.SpriteJSON),(R,F)=>{A=null,E||(E=R,y=F,L())}),M=i.n(h.transformRequest(h.normalizeSpriteURL(o,T,".png"),i.R.SpriteImage),(R,F)=>{M=null,E||(E=R,x=F,L())});function L(){if(E)g(E);else if(y&&x){let R=i.o.getImageData(x),F={};for(let z in y){let{width:j,height:q,x:$,y:Z,sdf:J,pixelRatio:Y,stretchX:ae,stretchY:Q,content:ce}=y[z],se=new i.q({width:j,height:q});i.q.copy(R,se,{x:$,y:Z},{x:0,y:0},{width:j,height:q},null),F[z]={data:se,pixelRatio:Y!==void 0?Y:1,sdf:J!==void 0&&J,stretchX:ae,stretchY:Q,content:ce,usvg:!1,version:0}}g(null,F)}}return{cancel(){A&&(A.cancel(),A=null),M&&(M.cancel(),M=null)}}})(t,this.map._requestManager,(o,h)=>{if(this._spriteRequest=null,o)this.fire(new i.y(o));else if(h){let g=new Map;for(let y in h)g.set(i.I.from(y),h[y]);this.addImages(g)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.z("data",{dataType:"style"}))})}addIconset(t,o){if(o.type==="sprite")return void this._loadSprite(o.url);let h=this.getOwnSourceCache(o.source);if(!h)return void this.fire(new i.y(new Error(`Source "${o.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));let g=h.getSource();if(g.type!=="raster-array")return void this.fire(new i.y(new Error(`Source "${o.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));g.partial=!1;let y=new M1(t,this.scope,h);this.imageManager.addImageProvider(y,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!i.h(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);let o=this.map._spriteFormat==="auto";var h,g;this._spriteRequest=(g=(y,x)=>{if(this._spriteRequest=null,y)o?this._loadSprite(t):this.fire(new i.y(y));else if(x){let E=new Map;for(let T in x)E.set(i.I.from(T),x[T]);this.addImages(E)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new i.z("data",{dataType:"style"}))},i.bt((h=this.map._requestManager).transformRequest(h.normalizeIconsetURL(t),i.R.Iconset),(y,x)=>{if(y)return void g(y);let E={},T=i.df(new i.bs(x));for(let A of T.icons){let M={version:1,pixelRatio:i.o.devicePixelRatio,content:A1(A),stretchX:A.metadata?Mv(A.metadata.stretch_x_areas):void 0,stretchY:A.metadata?Mv(A.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:A};E[A.name]=M}g(null,E)}))}_validateLayer(t){let o=this.getOwnSource(t.source);if(!o)return;let h=t.sourceLayer;h&&(o.type==="geojson"||o.vectorLayerIds&&o.vectorLayerIds.indexOf(h)===-1)&&this.fire(new i.y(new Error(`Source layer "${h}" does not exist on source "${o.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,o)=>{let h=this.fragments[o];return h&&h.style&&(t.data=h.style.serialize()),t})}_serializeSources(){let t={};for(let o in this._sourceCaches){let h=this._sourceCaches[o].getSource();t[h.id]||(t[h.id]=h.serialize())}return t}_serializeLayers(t){let o=[];for(let h of t){let g=this._layers[h];g&&g.type!=="custom"&&o.push(g.serialize())}return o}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(let t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){let o=this.getOwnLayer(t);if(o)return o;this.fire(new i.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){let o=this.getOwnSource(t);if(o)return o;this.fire(new i.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,o){let h=this.map.painter;if(h)for(let g=t.minzoom||0;g<(t.maxzoom||25.5);g++){let y=t.getProgramIds();if(y)for(let x of y){let E=t.getDefaultProgramParams(x,o.zoom,this._styleColorTheme.lut);E&&(h.style=this,this.fog&&(h._fogVisible=!0,E.overrideFog=!0,h.getOrCreateProgram(x,E)),h._fogVisible=!1,E.overrideFog=!1,h.getOrCreateProgram(x,E),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(E.overrideRtt=!0,h.getOrCreateProgram(x,E)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);let o=this.calculateLightsBrightness();t.brightness=o||0,o!==this._brightness&&(this._brightness=o,this.dispatcher.broadcast("setBrightness",o)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));let h=this._changes.isDirty(),g=!1;if(this._changes.isDirty()){let E=this._changes.getLayerUpdatesByScope();for(let T in E){let{updatedIds:A,removedIds:M}=E[T];(A||M)&&(this._updateWorkerLayers(T,A,M),g=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}let y={};for(let E in this._mergedSourceCaches){let T=this._mergedSourceCaches[E];y[E]=T.used,T.used=!1,T.tileCoverLift=0}for(let E of this._mergedOrder){let T=this._mergedLayers[E];if(T.recalculate(t,this._availableImages),!T.isHidden(t.zoom)){let A=this.getLayerSourceCache(T);A&&(A.used=!0,A.tileCoverLift=Math.max(A.tileCoverLift,T.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(T,t)}):this.precompilePrograms(T,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&g&&this.mergeLayers();let x=this.imageManager.getPendingImageProviders();for(let E of x)E.sourceCache.used=!0;for(let E in y){let T=this._mergedSourceCaches[E];y[E]!==T.used&&T.getSource().fire(new i.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:T.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),h&&this.fire(new i.z("data",{dataType:"style"}))}updateImageProviders(){let t=this.imageManager.getPendingImageProviders();for(let o of t){let h=o.resolvePendingRequests(),g=this.getFragmentStyle(o.scope);g&&g.addImages(h)}}_updateTilesForChangedImages(){let t={};for(let o in this._mergedSourceCaches){let h=this._mergedSourceCaches[o].getSource().scope;t[h]=t[h]||this._changes.getUpdatedImages(h),t[h].length!==0&&this._mergedSourceCaches[o].reloadTilesForDependencies(["icons","patterns"],t[h])}for(let o in t)this._changes.resetUpdatedImages(o)}_updateWorkerLayers(t,o,h){let g=this.getFragmentStyle(t);g&&this.dispatcher.broadcast("updateLayers",{layers:o?g._serializeLayers(o):[],scope:t,removedIds:h||[],options:g.options})}setState(t,o){if(this._checkLoaded(),pl(this,qo(t)))return!1;(t=i.dn(t)).layers=Zc(t.layers);let h=(function(x,E){if(!x)return[{command:Pn.setStyle,args:[E]}];let T=[];try{if(!i.bx(x.version,E.version))return[{command:Pn.setStyle,args:[E]}];if(i.bx(x.center,E.center)||T.push({command:Pn.setCenter,args:[E.center]}),i.bx(x.zoom,E.zoom)||T.push({command:Pn.setZoom,args:[E.zoom]}),i.bx(x.bearing,E.bearing)||T.push({command:Pn.setBearing,args:[E.bearing]}),i.bx(x.pitch,E.pitch)||T.push({command:Pn.setPitch,args:[E.pitch]}),i.bx(x.sprite,E.sprite)||T.push({command:Pn.setSprite,args:[E.sprite]}),i.bx(x.glyphs,E.glyphs)||T.push({command:Pn.setGlyphs,args:[E.glyphs]}),i.bx(x.imports,E.imports)||(function(F=[],z=[],j){z=z||[];let q=(F=F||[]).map(Cd),$=z.map(Cd),Z=F.reduce(Ad,{}),J=z.reduce(Ad,{}),Y=q.slice(),ae,Q,ce,se;for(ae=0,Q=0;ae<q.length;ae++)ce=q[ae],J.hasOwnProperty(ce)?Q++:(j.push({command:Pn.removeImport,args:[ce]}),Y.splice(Y.indexOf(ce,Q),1));for(ae=0,Q=0;ae<$.length;ae++)ce=$[$.length-1-ae],Y[Y.length-1-ae]!==ce&&(Z.hasOwnProperty(ce)?(j.push({command:Pn.removeImport,args:[ce]}),Y.splice(Y.lastIndexOf(ce,Y.length-Q),1)):Q++,se=Y[Y.length-ae],j.push({command:Pn.addImport,args:[J[ce],se]}),Y.splice(Y.length-ae,0,ce));for(let ie of z){let ue=Z[ie.id];ue&&(delete ue.data,i.bx(ue,ie)||j.push({command:Pn.updateImport,args:[ie.id,ie]}))}})(x.imports,E.imports,T),i.bx(x.transition,E.transition)||T.push({command:Pn.setTransition,args:[E.transition]}),i.bx(x.light,E.light)||T.push({command:Pn.setLight,args:[E.light]}),i.bx(x.fog,E.fog)||T.push({command:Pn.setFog,args:[E.fog]}),i.bx(x.snow,E.snow)||T.push({command:Pn.setSnow,args:[E.snow]}),i.bx(x.rain,E.rain)||T.push({command:Pn.setRain,args:[E.rain]}),i.bx(x.projection,E.projection)||T.push({command:Pn.setProjection,args:[E.projection]}),i.bx(x.lights,E.lights)||T.push({command:Pn.setLights,args:[E.lights]}),i.bx(x.camera,E.camera)||T.push({command:Pn.setCamera,args:[E.camera]}),i.bx(x.iconsets,E.iconsets)||(function(F,z,j){let q;for(q in z=z||{},F=F||{})F.hasOwnProperty(q)&&(z.hasOwnProperty(q)||j.push({command:Pn.removeIconset,args:[q]}));for(q in z){if(!z.hasOwnProperty(q))continue;let $=z[q];F.hasOwnProperty(q)?i.bx(F[q],$)||(j.push({command:Pn.removeIconset,args:[q]}),j.push({command:Pn.addIconset,args:[q,$]})):j.push({command:Pn.addIconset,args:[q,$]})}})(x.iconsets,E.iconsets,T),!i.bx(x["color-theme"],E["color-theme"]))return[{command:Pn.setStyle,args:[E]}];let A={},M=[];(function(F,z,j,q){let $;for($ in z=z||{},F=F||{})F.hasOwnProperty($)&&(z.hasOwnProperty($)||Id($,j,q));for($ in z){if(!z.hasOwnProperty($))continue;let Z=z[$];F.hasOwnProperty($)?i.bx(F[$],Z)||(F[$].type==="geojson"&&Z.type==="geojson"&&Ym(F,z,$)?j.push({command:Pn.setGeoJSONSourceData,args:[$,Z.data]}):Sd($,z,j,q)):Xm($,z,j)}})(x.sources,E.sources,M,A);let L=[];x.layers&&x.layers.forEach(F=>{F.source&&A[F.source]?T.push({command:Pn.removeLayer,args:[F.id]}):L.push(F)});let R=x.terrain;R&&A[R.source]&&(T.push({command:Pn.setTerrain,args:[void 0]}),R=void 0),T=T.concat(M),i.bx(R,E.terrain)||T.push({command:Pn.setTerrain,args:[E.terrain]}),(function(F,z,j){z=z||[];let q=(F=F||[]).map(Cd),$=z.map(Cd),Z=F.reduce(Ad,{}),J=z.reduce(Ad,{}),Y=q.slice(),ae=Object.create(null),Q,ce,se,ie,ue,be,ye;for(Q=0,ce=0;Q<q.length;Q++)se=q[Q],J.hasOwnProperty(se)?ce++:(j.push({command:Pn.removeLayer,args:[se]}),Y.splice(Y.indexOf(se,ce),1));for(Q=0,ce=0;Q<$.length;Q++)se=$[$.length-1-Q],Y[Y.length-1-Q]!==se&&(Z.hasOwnProperty(se)?(j.push({command:Pn.removeLayer,args:[se]}),Y.splice(Y.lastIndexOf(se,Y.length-ce),1)):ce++,be=Y[Y.length-Q],j.push({command:Pn.addLayer,args:[J[se],be]}),Y.splice(Y.length-Q,0,se),ae[se]=!0);for(Q=0;Q<$.length;Q++)if(se=$[Q],ie=Z[se],ue=J[se],!ae[se]&&!i.bx(ie,ue))if(i.bx(ie.source,ue.source)&&i.bx(ie["source-layer"],ue["source-layer"])&&i.bx(ie.type,ue.type)){for(ye in Dd(ie.layout,ue.layout,j,se,null,Pn.setLayoutProperty),Dd(ie.paint,ue.paint,j,se,null,Pn.setPaintProperty),i.bx(ie.slot,ue.slot)||j.push({command:Pn.setSlot,args:[se,ue.slot]}),i.bx(ie.filter,ue.filter)||j.push({command:Pn.setFilter,args:[se,ue.filter]}),i.bx(ie.minzoom,ue.minzoom)&&i.bx(ie.maxzoom,ue.maxzoom)||j.push({command:Pn.setLayerZoomRange,args:[se,ue.minzoom,ue.maxzoom]}),ie)ie.hasOwnProperty(ye)&&ye!=="layout"&&ye!=="paint"&&ye!=="filter"&&ye!=="metadata"&&ye!=="minzoom"&&ye!=="maxzoom"&&ye!=="slot"&&(ye.indexOf("paint.")===0?Dd(ie[ye],ue[ye],j,se,ye.slice(6),Pn.setPaintProperty):i.bx(ie[ye],ue[ye])||j.push({command:Pn.setLayerProperty,args:[se,ye,ue[ye]]}));for(ye in ue)ue.hasOwnProperty(ye)&&!ie.hasOwnProperty(ye)&&ye!=="layout"&&ye!=="paint"&&ye!=="filter"&&ye!=="metadata"&&ye!=="minzoom"&&ye!=="maxzoom"&&ye!=="slot"&&(ye.indexOf("paint.")===0?Dd(ie[ye],ue[ye],j,se,ye.slice(6),Pn.setPaintProperty):i.bx(ie[ye],ue[ye])||j.push({command:Pn.setLayerProperty,args:[se,ye,ue[ye]]}))}else j.push({command:Pn.removeLayer,args:[se]}),be=Y[Y.lastIndexOf(se)+1],j.push({command:Pn.addLayer,args:[ue,be]})})(L,E.layers,T)}catch(A){console.warn("Unable to compute style diff:",A),T=[{command:Pn.setStyle,args:[E]}]}return T})(this.serialize(),t).filter(x=>!(x.command in ig));if(h.length===0)return!1;let g=h.filter(x=>!(x.command in R1));if(g.length>0)throw new Error(`Unimplemented: ${g.map(x=>x.command).join(", ")}.`);let y=[];return h.forEach(x=>{y.push(this[x.command](...x.args))}),o&&Promise.all(y).then(o).catch(o),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(let[o,h]of t.entries()){if(this.getImage(o))return this.fire(new i.y(new Error(`An image with the name "${o.name}" already exists.`)));this.imageManager.addImage(o,this.scope,h),this._changes.updateImage(o,this.scope)}return this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this}addImage(t,o){return this.getImage(t)?this.fire(new i.y(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,o),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this)}updateImage(t,o,h=!1){this.imageManager.updateImage(t,this.scope,o),h&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new i.z("data",{dataType:"style"})),this):this.fire(new i.y(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new i.z("data",{dataType:"style"})),this}addModel(t,o,h={}){return this._checkLoaded(),this._validate(xd,`models.${t}`,o,null,h)||(this.modelManager.addModel(t,o,this.scope),this.fire(new i.z("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new i.z("data",{dataType:"style"})),this):this.fire(new i.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,o,h={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!o.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(o).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(o.type)>=0&&this._validate(lf,`sources.${t}`,o,null,h))return;this.map&&this.map._collectResourceTiming&&(o.collectResourceTiming=!0);let g=uo(t,o,this.dispatcher,this);g.scope=this.scope,g.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(g.id),source:g.serialize(),sourceId:g.id}));let y=x=>{let E=(x?"symbol:":"other:")+g.id,T=i.B(E,this.scope),A=this._sourceCaches[E]=new vs(T,g,x);(x?this._symbolSourceCaches:this._otherSourceCaches)[g.id]=A,A.onAdd(this.map)};y(!1),o.type!=="vector"&&o.type!=="geojson"||y(!0),g.onAdd&&g.onAdd(this.map),h.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();let o=this.getOwnSource(t);if(!o)throw new Error("There is no source with this ID");for(let g in this._layers)if(this._layers[g].source===t)return this.fire(new i.y(new Error(`Source "${t}" cannot be removed while layer "${g}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new i.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){let g=Object.entries(this.stylesheet.iconsets).find(([y,x])=>x.type==="source"&&x.source===t);if(g)return this.fire(new i.y(new Error(`Source "${t}" cannot be removed while iconset "${g[0]}" is using it.`)))}let h=this.getOwnSourceCaches(t);for(let g of h){let y=i.dp(g.id);delete this._sourceCaches[y],this._changes.discardSourceCacheUpdate(g.id),g.fire(new i.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:g.getSource().id})),g.setEventedParent(null),g.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),o.setEventedParent(null),o.onRemove&&o.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,o){this._checkLoaded(),this.getOwnSource(t).setData(o),this._changes.setDirty()}getOwnSource(t){let o=this.getOwnSourceCache(t);return o&&o.getSource()}getOwnSources(){let t=[];for(let o in this._otherSourceCaches){let h=this.getOwnSourceCache(o);h&&t.push(h.getSource())}return t}areTilesLoaded(){let t=this._mergedSourceCaches;for(let o in t){let h=t[o]._tiles;for(let g in h){let y=h[g];if(y.state!=="loaded"&&y.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;let o=this._getTransitionParameters();for(let y of t){if(this._validate($m,"lights",y))return;switch(y.type){case"ambient":if(this.ambientLight){let x=this.ambientLight;x.set(y),x.updateTransitions(o)}else this.ambientLight=new Hi(y,Wn||(Wn=new i.a9({color:new i.aa(i.a6.properties_light_ambient.color),"color-use-theme":new i.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.aa(i.a6.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let x=this.directionalLight;x.set(y),x.updateTransitions(o)}else this.directionalLight=new Hi(y,Ni||(Ni=new i.a9({direction:new i.ap(i.a6.properties_light_directional.direction),color:new i.aa(i.a6.properties_light_directional.color),"color-use-theme":new i.aa({type:"string",default:"default","property-type":"data-constant"}),intensity:new i.aa(i.a6.properties_light_directional.intensity),"cast-shadows":new i.aa(i.a6.properties_light_directional["cast-shadows"]),"shadow-quality":new i.aa(i.a6.properties_light_directional["shadow-quality"]),"shadow-intensity":new i.aa(i.a6.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let h=Object.assign(o,{worldview:this.map.getWorldview()}),g=new i.ac(this.z||0,h);this.ambientLight&&this.ambientLight.recalculate(g),this.directionalLight&&this.directionalLight.recalculate(g),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let t=this.directionalLight,o=this.ambientLight;if(!t||!o)return;let h=R=>.2126*(R[0]<=.03928?R[0]/12.92:Math.pow((R[0]+.055)/1.055,2.4))+.7152*(R[1]<=.03928?R[1]/12.92:Math.pow((R[1]+.055)/1.055,2.4))+.0722*(R[2]<=.03928?R[2]/12.92:Math.pow((R[2]+.055)/1.055,2.4)),g=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),y=t.properties.get("intensity"),x=t.properties.get("direction"),E=1-i.d3(x.x,x.y,x.z)[2]/90,T=h(g)*y*E,A=o.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),M=o.properties.get("intensity"),L=h(A)*M;return Number(((T+L)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(i.dq(t)){let o=i.dr(t),h=this.fragments.find(({id:y})=>y===o);if(!h)return;let g=i.dp(t);return h.style.getFragmentStyle(g)}{let o=this.fragments.find(({id:h})=>h===t);return o?o.style:void 0}}setFeaturesetSelectors(t){if(!t)return;let o={},h=(g,y="")=>`${g}::${y}`;this._featuresetSelectors={};for(let g in t){let y=this._featuresetSelectors[g]=[];for(let x of t[g].selectors){if(x.featureNamespace){let T=this.getOwnLayer(x.layer);if(!T){i.w(`Layer is undefined for selector: ${x.layer}`);continue}let A=h(T.source,T.sourceLayer);if(A in o&&o[A]!==x.featureNamespace){i.w(`"featureNamespace ${x.featureNamespace} of featureset ${g}'s selector is not associated to the same source, skip this selector`);continue}o[A]=x.featureNamespace}let E;if(x.properties)for(let T in x.properties){let A=i.U(x.properties[T]);A.result==="success"&&(E=E||{},E[T]=A.value)}y.push({layerId:x.layer,namespace:x.featureNamespace,properties:E,uniqueFeatureID:x._uniqueFeatureID})}}}getFeaturesetDescriptors(t){let o=this.getFragmentStyle(t);if(!o||!o.stylesheet.featuresets)return[];let h=[];for(let g in o.stylesheet.featuresets)h.push({featuresetId:g,importId:o.scope?o.scope:void 0});return h}getFeaturesetLayers(t,o){let h=this.getFragmentStyle(o),g=h.stylesheet.featuresets;if(!g||!g[t])return this.fire(new i.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];let y=[];for(let x of g[t].selectors){let E=h.getOwnLayer(x.layer);E&&y.push(E)}return y}getConfigProperty(t,o){let h=this.getFragmentStyle(t);if(!h)return null;let g=i.B(o,h.scope),y=h.options.get(g),x=y?y.value||y.default:null;return x?x.serialize():null}isIndoorEnabled(){return Object.keys(this._mergedIndoor).length>0}getIndoorSourceLayers(t,o){let h=i.B(t,o);return this._mergedIndoor[h]}setIndoorData(t,o){this.map.indoor.setIndoorData(o)}updateIndoorDependentLayers(){this._updateLayers(this._indoorDependentLayers),this.map._styleDirty=!0,this.map.triggerRepaint()}setConfigProperty(t,o,h){let g=this.getFragmentStyle(t);if(!g)return;let y=g.stylesheet.schema;if(!y||!y[o])return;let x=i.U(h);if(x.result!=="success")return void pl(this,x.value);let E=x.value.expression,T=i.B(o,g.scope),A=g.options.get(T);if(!A)return;let M,{minValue:L,maxValue:R,stepValue:F,type:z,values:j}=y[o],q=i.U(y[o].default);q.result==="success"&&(M=q.value.expression),M?(this.options.set(T,Object.assign({},A,{value:E,default:M,minValue:L,maxValue:R,stepValue:F,type:z,values:j})),this.updateConfigDependencies(o)):this.fire(new i.y(new Error(`No schema defined for the config option "${o}" in the "${t}" fragment.`)))}getConfig(t){let o=this.getFragmentStyle(t);if(!o)return null;let h=o.stylesheet.schema;if(!h)return null;let g={};for(let y in h){let x=i.B(y,o.scope),E=o.options.get(x),T=E?E.value||E.default:null;g[y]=T?T.serialize():null}return g}setConfig(t,o){let h=this.getFragmentStyle(t);h&&(h.updateConfig(o,h.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){let o=this.getFragmentStyle(t);return o?o.stylesheet.schema:null}setSchema(t,o){let h=this.getFragmentStyle(t);h&&(h.stylesheet.schema=o,h.updateConfig(h._config,o),this.updateConfigDependencies())}updateConfig(t,o){if(this._config=t,t||o)if(o)for(let h in o){let g,y,x=i.U(o[h].default);if(x.result==="success"&&(g=x.value.expression),t&&t[h]!==void 0){let R=i.U(t[h]);R.result==="success"&&(y=R.value.expression)}let{minValue:E,maxValue:T,stepValue:A,type:M,values:L}=o[h];if(g){let R=i.B(h,this.scope);this.options.set(R,{default:g,value:y,minValue:E,maxValue:T,stepValue:A,type:M,values:L})}else this.fire(new i.y(new Error(`No schema defined for config option "${h}".`)))}else this.fire(new i.y(new Error("Attempting to set config for a style without schema.")))}_updateLayers(t,o=()=>!0){for(let h of t){let g=this.getLayer(h);g&&o(g)&&(g.possiblyEvaluateVisibility(),this._updateLayer(g),this._changes.setDirty())}}updateConfigDependencies(t){this._updateLayers(this._configDependentLayers,o=>!t||o.expressionDependencies.configDependencies.has(t)),this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(o=>{let h=o._styleColorTheme.colorThemeOverride?o._styleColorTheme.colorThemeOverride:o._styleColorTheme.colorTheme;if(h){let g=o._evaluateColorThemeData(h);(!o._styleColorTheme.lut&&g!==""||o._styleColorTheme.lut&&g!==o._styleColorTheme.lut.data)&&o.setColorTheme(h)}}),this._changes.setDirty()}addLayer(t,o,h={}){this._checkLoaded();let g=t.id;if(this._layers[g])return void this.fire(new i.y(new Error(`Layer with id "${g}" already exists on this map`)));let y;if(t.type==="custom"){if(pl(this,i.ds(t)))return;y=i.dt(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(g,t.source),t=i.dn(t),t=Object.assign(t,{source:g})),this._validate(vd,`layers.${g}`,t,{arrayIndex:-1},h))return;y=i.dt(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(y),y.setEventedParent(this,{layer:{id:g}})}let x=i.B(y.source,y.scope);y.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(x),y.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(x);let E=this._order.length;if(o){let L=this._order.indexOf(o);if(L===-1)return void this.fire(new i.y(new Error(`Layer with id "${o}" does not exist on this map.`)));y.slot===this._layers[o].slot?E=L:i.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(E,0,g),this._layerOrderChanged=!0,this._layers[g]=y;let T=this.getOwnLayerSourceCache(y),A=!!this.directionalLight&&this.directionalLight.shadowsEnabled();T&&y.canCastShadows()&&A&&(T.castsShadows=!0);let M=this._changes.getRemovedLayer(y);if(M&&y.source&&T&&y.type!=="custom"){this._changes.discardLayerRemoval(y);let L=i.B(y.source,y.scope);M.type!==y.type?this._changes.updateSourceCache(L,"clear"):(this._changes.updateSourceCache(L,"reload"),T.pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map),y.scope=this.scope,this.mergeLayers()}moveLayer(t,o){this._checkLoaded();let h=this._checkLayer(t);if(!h||t===o)return;let g=this._order.indexOf(t);this._order.splice(g,1);let y=this._order.length;if(o){let x=this._order.indexOf(o);if(x===-1)return void this.fire(new i.y(new Error(`Layer with id "${o}" does not exist on this map.`)));h.slot===this._layers[o].slot?y=x:i.w(`Layer with id "${o}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(y,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();let o=this._checkLayer(t);if(!o)return;o.setEventedParent(null);let h=this._order.indexOf(t);this._order.splice(h,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(o.fqid),this._indoorDependentLayers.delete(o.fqid),this._changes.removeLayer(o);let g=this.getOwnLayerSourceCache(o);if(g&&g.castsShadows){let y=!1;for(let x in this._layers)if(this._layers[x].source===o.source&&this._layers[x].canCastShadows()){y=!0;break}g.castsShadows=y}o.onRemove&&o.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(let o in this._layers)if(this._layers[o].type===t)return!0;return!1}setLayerZoomRange(t,o,h){this._checkLoaded();let g=this._checkLayer(t);g&&(g.minzoom===o&&g.maxzoom===h||(o!=null&&(g.minzoom=o),h!=null&&(g.maxzoom=h),this._updateLayer(g)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,o){this._checkLoaded();let h=this._checkLayer(t);h&&h.slot!==o&&(h.slot=o,this._updateLayer(h))}setFilter(t,o,h={}){this._checkLoaded();let g=this._checkLayer(t);if(g&&!i.bx(g.filter,o))return o==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(gn,`layers.${g.id}.filter`,o,{layerType:g.type},h)||(g.filter=i.dn(o),this._updateLayer(g)))}getFilter(t){let o=this._checkLayer(t);if(o)return i.dn(o.filter)}setLayoutProperty(t,o,h,g={}){this._checkLoaded();let y=this._checkLayer(t);if(y&&!i.bx(y.getLayoutProperty(o),h)){if(h!=null&&(!g||g.validate!==!1)&&pl(y,Gm.call(qo,{key:`layers.${t}.layout.${o}`,layerType:y.type,objectKey:o,value:h,styleSpec:i.a6,style:{glyphs:!0,sprite:!0}})))return;y.setLayoutProperty(o,h),y.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(y.fqid),y.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(y.fqid),this._updateLayer(y)}}setLayerProperty(t,o,h,g={}){this._checkLoaded();let y=this._checkLayer(t);y&&(o==="appearances"?(y.setAppearances(h),this._changes.setDirty()):y.isPaintProperty(o)?this.setPaintProperty(t,o,h,g):this.setLayoutProperty(t,o,h,g))}getLayoutProperty(t,o){let h=this._checkLayer(t);if(h)return h.getLayoutProperty(o)}setPaintProperty(t,o,h,g={}){this._checkLoaded();let y=this._checkLayer(t);if(!y||i.bx(y.getPaintProperty(o),h)||h!=null&&(!g||g.validate!==!1)&&pl(y,eo.call(qo,{key:`layers.${t}.paint.${o}`,layerType:y.type,objectKey:o,value:h,styleSpec:i.a6})))return;let x=y.setPaintProperty(o,h);y.expressionDependencies.configDependencies.size!==0&&this._configDependentLayers.add(y.fqid),y.expressionDependencies.isIndoorDependent&&this._indoorDependentLayers.add(y.fqid),x&&this._updateLayer(y),this._changes.updatePaintProperties(y)}getPaintProperty(t,o){let h=this._checkLayer(t);if(h)return h.getPaintProperty(o)}setFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:A}=t.target,M=this.getFragmentStyle(A),L=M.getFeaturesetLayers(T);for(let{source:R,sourceLayer:F}of L)M.setFeatureState({id:t.id,source:R,sourceLayer:F},o)}else if("layerId"in t.target){let{layerId:T}=t.target,A=this.getLayer(T);this.setFeatureState({id:t.id,source:A.source,sourceLayer:A.sourceLayer},o)}return}let h=t.source,g=t.sourceLayer,y=this._checkSource(h);if(!y)return;let x=y.type;if(x==="geojson"&&g)return void this.fire(new i.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(x==="vector"&&!g)return void this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new i.y(new Error("The feature id parameter must be provided.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.setFeatureState(g,t.id,o)}removeFeatureState(t,o){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){let{featuresetId:T,importId:A}=t.target,M=this.getFragmentStyle(A),L=M.getFeaturesetLayers(T);for(let{source:R,sourceLayer:F}of L)M.removeFeatureState({id:t.id,source:R,sourceLayer:F},o)}else if("layerId"in t.target){let{layerId:T}=t.target,A=this.getLayer(T);this.removeFeatureState({id:t.id,source:A.source,sourceLayer:A.sourceLayer},o)}return}let h=t.source,g=this._checkSource(h);if(!g)return;let y=g.type,x=y==="vector"?t.sourceLayer:void 0;if(y==="vector"&&!x)return void this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(o&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new i.y(new Error("A feature id is required to remove its specific state property.")));let E=this.getOwnSourceCaches(h);for(let T of E)T.removeFeatureState(x,t.id,o)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let y;if("featuresetId"in t.target){let{featuresetId:x,importId:E}=t.target,T=this.getFragmentStyle(E),A=T.getFeaturesetLayers(x);for(let{source:M,sourceLayer:L}of A){let R=T.getFeatureState({id:t.id,source:M,sourceLayer:L});if(R&&!y)y=R;else if(!i.bx(y,R))return void this.fire(new i.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){let{layerId:x}=t.target,E=this.getLayer(x);y=this.getFeatureState({id:t.id,source:E.source,sourceLayer:E.sourceLayer})}return y}let o=t.source,h=t.sourceLayer,g=this._checkSource(o);if(g){if(g.type!=="vector"||h)return t.id===void 0&&this.fire(new i.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(o)[0].getFeatureState(h,t.id);this.fire(new i.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Object.assign({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Object.assign({},this.stylesheet.transition)}serialize(){this._checkLoaded();let t=this.getTerrain(),o=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return i.du({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:o,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},h=>h!==void 0)}_updateFilteredLayers(t){for(let o of Object.values(this._mergedLayers))t(o)&&this._updateLayer(o)}_updateLayer(t){this._changes.updateLayer(t);let o=this.getLayerSourceCache(t),h=i.B(t.source,t.scope),g=this._changes.getUpdatedSourceCaches();t.source&&!g[h]&&o&&o.getSource().type!=="raster"&&(this._changes.updateSourceCache(h,"reload"),o.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){let o=E=>this._mergedLayers[E].is3D(!!this.terrain),h=this.order,g={},y=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T)){g[T]=E;for(let A of t){let M=A[T];if(M)for(let L of M)y.push(L)}}}y.sort((E,T)=>T.intersectionZ-E.intersectionZ);let x=[];for(let E=h.length-1;E>=0;E--){let T=h[E];if(o(T))for(let A=y.length-1;A>=0;A--){let M=y[A].feature;if(M.layer&&g[M.layer.id]<E)break;x.push(M),y.pop()}else for(let A of t){let M=A[T];if(M)for(let L of M)x.push(L.feature)}}return x}queryRasterValue(t,o,h){let g=this.getOwnSource(t);return g?g.type!=="raster-array"?(this.fire(new i.y(new Error('queryRasterValue support only "raster-array" sources.'))),Promise.resolve(null)):g.queryRasterArrayValue(o,h):(this.fire(new i.y(new Error(`Source with id "${t}" does not exist in the style.`))),Promise.resolve(null))}queryRenderedFeatures(t,o,h){let g;o&&!Array.isArray(o)&&o.filter&&(this._validate(gn,"queryRenderedFeatures.filter",o.filter,null,o),g=i.b5(o.filter));let y={},x=M=>{if(vf.has(M.type))return;let L=this.getOwnLayerSourceCache(M),R=y[L.id]=y[L.id]||{sourceCache:L,layers:{},has3DLayers:!1};M.is3D(!!this.terrain)&&(R.has3DLayers=!0),R.layers[M.fqid]=R.layers[M.fqid]||{styleLayer:M,targets:[]},R.layers[M.fqid].targets.push({filter:g})};if(o&&o.layers){if(!Array.isArray(o.layers))return this.fire(new i.y(new Error("parameters.layers must be an Array."))),[];for(let M of o.layers){let L=this._layers[M];if(!L)return this.fire(new i.y(new Error(`The layer '${M}' does not exist in the map's style and cannot be queried for features.`))),[];x(L)}}else for(let M in this._layers)x(this._layers[M]);let E=this._queryRenderedFeatures(t,y,h),T=this._flattenAndSortRenderedFeatures(E),A=[];for(let M of T)i.dv(M.layer.id)===this.scope&&A.push(M);return A}queryRenderedFeatureset(t,o,h){let g;o&&!Array.isArray(o)&&o.filter&&(this._validate(gn,"queryRenderedFeatures.filter",o.filter,null,o),g=i.b5(o.filter));let y="mock",x=[];if(o&&o.target)x.push(Object.assign({},o,{targetId:y,filter:g}));else{let M=this.getFeaturesetDescriptors();for(let L of M)x.push({targetId:y,filter:g,target:L});for(let{style:L}of this.fragments){let R=L.getFeaturesetDescriptors();for(let F of R)x.push({targetId:y,filter:g,target:F})}}let E=this.queryRenderedTargets(t,x,h),T=[],A=new Set;for(let M of E)for(let L of M.variants[y])Oo(L,M,A)||T.push(new i.dw(M,L));return T}queryRenderedTargets(t,o,h){let g={},y=(E,T,A,M)=>{let L=g[T.id]=g[T.id]||{sourceCache:T,layers:{},has3DLayers:!1};if(L.layers[E.fqid]=L.layers[E.fqid]||{styleLayer:E,targets:[]},E.is3D(!!this.terrain)&&(L.has3DLayers=!0),!M)return A.uniqueFeatureID=!1,void L.layers[E.fqid].targets.push(A);L.layers[E.fqid].targets.push(Object.assign({},A,{namespace:M.namespace,properties:M.properties,uniqueFeatureID:M.uniqueFeatureID}))};for(let E of o)if("featuresetId"in E.target){let{featuresetId:T,importId:A}=E.target,M=this.getFragmentStyle(A);if(!M||!M._featuresetSelectors)continue;let L=M._featuresetSelectors[T];if(!L){this.fire(new i.y(new Error(`The featureset '${T}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let R of L){let F=M.getOwnLayer(R.layerId);F&&!vf.has(F.type)&&y(F,M.getOwnLayerSourceCache(F),E,R)}}else if("layerId"in E.target){let{layerId:T}=E.target,A=this.getLayer(T);if(!A||vf.has(A.type))continue;y(A,this.getLayerSourceCache(A),E)}let x=this._queryRenderedFeatures(t,g,h);return this._flattenAndSortRenderedFeatures(x)}_queryRenderedFeatures(t,o,h){let g=[],y=!!this.map._showQueryGeometry,x=Hn.createFromScreenPoints(t,h);for(let E in o){let T=Lo(x,o[E],this._availableImages,h,y);Object.keys(T).length&&g.push(T)}if(this.placement)for(let E in o){if(!o[E].sourceCache._onlySymbols)continue;let T=cf(x.screenGeometry,o[E],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(T).length&&g.push(T)}return g}querySourceFeatures(t,o){let h=o&&o.filter;h&&this._validate(gn,"querySourceFeatures.filter",h,null,o);let g=[],y=this.getOwnSourceCaches(t);for(let x of y)g=g.concat(bd(x,o));return g}addSourceType(t,o,h){return Es.getSourceType(t)?h(new Error(`A source type called "${t}" already exists.`)):(Es.setSourceType(t,o),o.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:o.workerSourceURL},h):h(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,o,h={}){this._checkLoaded();let g=this.light.getLight(),y=!1;for(let E in t)if(!i.bx(t[E],g[E])){y=!0;break}if(!y)return;let x=this._getTransitionParameters();this.light.setLight(t,o,h),this.light.updateTransitions(x)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=i.o.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&i.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,o=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),o===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let h=t,g=t.source==null;if(o===1){if(this.disableElevatedTerrain)return;if(typeof h.source=="object"){let E="terrain-dem-src";this.addSource(E,h.source),h=i.dn(h),h=Object.assign(h,{source:E})}let y=Object.assign({},h),x={};if(this.terrain&&g){y.source=this.terrain.get().source;let E=this.terrain?this.getFragmentStyle(this.terrain.scope):null;E&&(x.style=E.serialize())}if(this._validate(Wc,"terrain",y,x))return}if(!this.terrain||this.terrain.scope!==this.scope&&!g||this.terrain&&o!==this.terrain.drapeRenderMode){if(!h)return;this._createTerrain(h,o),this.fire(new i.z("data",{dataType:"style"}))}else{let y=this.terrain,x=y.get();for(let E of Object.keys(i.a6.terrain))!h.hasOwnProperty(E)&&i.a6.terrain[E].default&&(h[E]=i.a6.terrain[E].default);for(let E in t)if(!i.bx(t[E],x[E])){y.set(t,this.options),this.stylesheet.terrain=t;let T=this._getTransitionParameters({duration:0});y.updateTransitions(T),this.fire(new i.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){let o=this.fog=new Rt(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createSnow(t){let o=this.snow=new ar(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_createRain(t){let o=this.rain=new Zi(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(let t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let o=this.fog;if(!i.bx(o.get(),t)){o.set(t,this.options),this.stylesheet.fog=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let o=this.snow;if(!i.bx(o.get(),t)){o.set(t,this.options),this.stylesheet.snow=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let o=this.rain;if(!i.bx(o.get(),t)){o.set(t,this.options),this.stylesheet.rain=o.get();let h=this._getTransitionParameters({duration:0});o.updateTransitions(h)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let g in this._layers)this._layers[g].lut=this._styleColorTheme.lut;for(let g in this._sourceCaches)this._sourceCaches[g].clearTiles()},o=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!o)return this._styleColorTheme.lut=null,void t();let h=this._evaluateColorThemeData(o);this._loadColorTheme(h).then(()=>{this.fire(new i.z("colorthemeset")),t()}).catch(g=>{i.w(`Couldn't set color theme: ${g}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&i.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,o){let h=this.getFragmentStyle(t);h&&(h._styleColorTheme.colorThemeOverride=o,h._reloadColorTheme())}_getTransitionParameters(t){return{now:i.o.now(),transition:Object.assign(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;let t=[],o=[];for(let h of this._mergedOrder)this.isLayerDraped(this._mergedLayers[h])?t.push(h):o.push(h);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...o)}_createTerrain(t,o){let h=this.terrain=new ve(t,o,this.scope,this.options,this.map.getWorldview());o===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let g=this._getTransitionParameters({duration:0});h.updateTransitions(g)}_force3DLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="fill-extrusion"&&this._updateLayer(o)}}_forceSymbolLayerUpdate(){for(let t in this._layers){let o=this._layers[t];o.type==="symbol"&&this._updateLayer(o)}}_validate(t,o,h,g,y={}){if(y&&y.validate===!1)return!1;let x=Object.assign({},this.serialize());return pl(this,t.call(qo,Object.assign({key:o,style:x,value:h,styleSpec:i.a6},g)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),i.dx.off("pluginStateChange",this._rtlTextPluginCallback);for(let t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){let o=this.getSourceCaches(t);for(let h of o)h.clearTiles()}clearSources(){for(let t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(let t in this._mergedLayers){let o=this._mergedLayers[t];o._clear&&o._clear()}}reloadSource(t){let o=this.getSourceCaches(t);for(let h of o)h.resume(),h.reload()}reloadSources(){for(let t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let o;this.directionalLight&&(o=Cv(this.directionalLight));let h=new Set;for(let g in this._mergedLayers){let y=this._mergedLayers[g];y.hasElevation()&&!h.has(y.source)&&h.add(y.source)}for(let g in this._mergedSourceCaches){let y=this._mergedSourceCaches[g],x=h.has(y._source.id);y.update(t,void 0,void 0,o,x)}}_generateCollisionBoxes(){for(let t in this._sourceCaches){let o=this._sourceCaches[t];o.resume(),o.reload()}}_updatePlacement(t,o,h,g,y,x,E=!1){let T=!1,A=!1,M={},L={};for(let R of this._mergedOrder){let F=this._mergedLayers[R];if(F.type!=="symbol")continue;let z=i.B(F.source,F.scope),j=M[z];if(!j){let $=this.getLayerSourceCache(F);if(!$)continue;let Z=$.getRenderableIds(!0).map(J=>$.getTileByID(J));L[z]=Z.slice(),j=M[z]=Z.sort((J,Y)=>Y.tileID.overscaledZ-J.tileID.overscaledZ||(J.tileID.isLessThan(Y.tileID)?-1:1))}let q=this.crossTileSymbolIndex.addLayer(F,j,o.center.lng,o.projection);T=T||q}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),E=E||this._layerOrderChanged||g===0,this._layerOrderChanged&&this.fire(new i.z("neworder")),(E||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(i.o.now(),o.zoom))&&(this.pauseablePlacement=new Eo(o,this._mergedOrder,E,h,g,y,this.placement,this.fog&&o.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,M,L,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(i.o.now()),A=!0),T&&this.pauseablePlacement.placement.setStale()),A||T){this._buildingIndex.onNewFrame(o.zoom);for(let R=0;R<this._mergedOrder.length;R++){let F=this._mergedLayers[this._mergedOrder[R]];if(F.type!=="symbol")continue;let z=this.isLayerClipped(F);this.placement.updateLayerOpacities(F,M[i.B(F.source,F.scope)],R,z?x:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(i.o.now())}}_releaseSymbolFadeTiles(){for(let t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,o){this._checkLoaded();let h=this.stylesheet.imports=this.stylesheet.imports||[];if(h.findIndex(({id:y})=>y===t.id)!==-1)return void this.fire(new i.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!o)return h.push(t),this._loadImports([t],!0);let g=h.findIndex(({id:y})=>y===o);return g===-1&&this.fire(new i.y(new Error(`Import with id "${o}" does not exist on this map.`))),this.stylesheet.imports=h.slice(0,g).concat(t).concat(h.slice(g)),this._loadImports([t],!0,o)}updateImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);return g===-1?this:typeof o=="string"?(this.setImportUrl(t,o),this):(o.url&&o.url!==h[g].url&&this.setImportUrl(t,o.url),i.bx(o.config,h[g].config)||this.setImportConfig(t,o.config,o.data.schema),i.bx(o.data,h[g].data)||this.setImportData(t,o.data),this)}moveImport(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;let y=this.getImportIndex(o);if(y===-1)return this;let x=h[g],E=this.fragments[g];return h=h.filter(({id:T})=>T!==t),this.fragments=this.fragments.filter(({id:T})=>T!==t),this.stylesheet.imports=h.slice(0,y).concat(x).concat(h.slice(y)),this.fragments=this.fragments.slice(0,y).concat(E).concat(this.fragments.slice(y)),this.mergeLayers(),this}setImportUrl(t,o){this._checkLoaded();let h=this.stylesheet.imports||[],g=this.getImportIndex(t);if(g===-1)return this;h[g].url=o;let y=this.fragments[g];return y.style=this._createFragmentStyle(h[g]),y.style.on("style.import.load",()=>this.mergeAll()),y.style.loadURL(o),this}setImportData(t,o){this._checkLoaded();let h=this.getImportIndex(t),g=this.stylesheet.imports||[];return h===-1?this:o?(this.fragments[h].style.setState(o),this._reloadImports(),this):(delete g[h].data,this.setImportUrl(t,g[h].url))}setImportConfig(t,o,h){this._checkLoaded();let g=this.getImportIndex(t),y=this.stylesheet.imports||[];if(g===-1)return this;o?y[g].config=o:delete y[g].config;let x=this.fragments[g];h&&x.style.stylesheet&&(x.style.stylesheet.schema=h);let E=x.style.stylesheet&&x.style.stylesheet.schema;return x.config=o,x.style.updateConfig(o,E),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();let o=this.stylesheet.imports||[],h=this.getImportIndex(t);h!==-1&&(o.splice(h,1),this.fragments[h].style._remove(),this.fragments.splice(h,1),this._reloadImports())}getImportIndex(t){let o=(this.stylesheet.imports||[]).findIndex(h=>h.id===t);return o===-1&&this.fire(new i.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),o}getLayer(t){return this._mergedLayers[t]}getSources(){let t=[];for(let o in this._mergedOtherSourceCaches){let h=this._mergedOtherSourceCaches[o];h&&t.push(h.getSource())}return t}getSource(t,o){let h=this.getSourceCache(t,o);return h&&h.getSource()}getLayerSource(t){let o=this.getLayerSourceCache(t);return o&&o.getSource()}getSourceCache(t,o){let h=i.B(t,o);return this._mergedOtherSourceCaches[h]}getLayerSourceCache(t){let o=i.B(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[o]:this._mergedOtherSourceCaches[o]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);let o=[];return this._mergedOtherSourceCaches[t]&&o.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&o.push(this._mergedSymbolSourceCaches[t]),o}updateSourceCaches(){let t=this._changes.getUpdatedSourceCaches();for(let o in t){let h=t[o];h==="reload"?this.reloadSource(o):h==="clear"&&this.clearSource(o)}}updateLayers(t){let o=this._changes.getUpdatedPaintProperties();for(let h of o){let g=this.getLayer(h);g&&g.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,o,h){this.imageManager.getImages(o.images,o.scope,h),this._updateTilesForChangedImages();let g=x=>{if(x){let E=o.images.map(T=>i.I.toString(T));x.setDependencies(o.tileID.key,o.type,E)}},y=i.B(o.source,o.scope);g(this._mergedOtherSourceCaches[y]),g(this._mergedSymbolSourceCaches[y]),o.images.some(x=>x.iconsetId)&&this.fire(new i.z("data",{dataType:"style"}))}rasterizeImages(t,o,h){this.imageManager.rasterizeImages(o,h)}getGlyphs(t,o,h){this.glyphManager.getGlyphs(o.stacks,h)}getResource(t,o,h){return i.dy(o,h)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){let o=[];return this._otherSourceCaches[t]&&o.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&o.push(this._symbolSourceCaches[t]),o}_isSourceCacheLoaded(t){let o=this.getOwnSourceCaches(t);return o.length===0?(this.fire(new i.y(new Error(`There is no source with ID '${t}'`))),!1):o.every(h=>h.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,o){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;let h=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),g=t.type==="building";if(t.is3D(!!this.terrain)){if(h||g||o&&o.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}Es.getSourceType=function(d){return ys[d]},Es.setSourceType=function(d,t){ys[d]=t},Es.registerForPluginStateChange=i.dz;class rc extends i.E{constructor(t){super(),this._style=t,this._buildings={},this._activeFloors=new Set,this._activeFloorsVisible=!0,this._indoorState={selectedFloorId:null,lastActiveFloors:null,activeFloorsVisible:!0},i.aX(["_updateUI"],this)}destroy(){this._buildings={},this._activeFloors=new Set,this._indoorState=null}selectFloor(t){t===this._selectedFloorId&&this._activeFloorsVisible||(this._selectedFloorId=t,this._activeFloorsVisible=!0,this._updateActiveFloors())}setActiveFloorsVisibility(t){this._activeFloorsVisible=t,this._updateActiveFloors(),this._updateIndoorSelector()}setIndoorData(t){for(let[o,h]of Object.entries(t.buildings))if(this._buildings[o])for(let g of h.floorIds)this._buildings[o].floors[g]||(this._buildings[o].floors[g]=h.floors[g]);else this._buildings[o]=h;for(let o of t.activeFloors)this._activeFloors.add(o);this._updateIndoorSelector()}getIndoorTileOptions(t,o){let h=this._style.getIndoorSourceLayers(t,o);return h&&this._indoorState?{sourceLayers:h,indoorState:this._indoorState}:null}_updateUI(t,o,h){let g=(function(y,x,E,T){let A=null,M=Number.MAX_SAFE_INTEGER;if(T<16)return null;for(let[L,R]of Object.entries(y)){let F=R.center;if(F){let z=x.distanceTo(i.aS.convert(F));z<M&&E.contains(F)&&(M=z,A=L)}}return A})(this._buildings,o,h,t);g!==this._closestBuildingId&&(this._closestBuildingId=g,this._updateIndoorSelector())}_updateIndoorSelector(){let t=this._buildings,o=this._closestBuildingId,h=o&&t?t[o]:void 0;if(!h)return void this.fire(new i.z("selector-update",{selectedFloorId:null,activeFloorsVisible:this._activeFloorsVisible,floors:[]}));let g=null;for(let x of h.floorIds)if(this._activeFloors&&this._activeFloors.has(x)){g=x;break}let y=Array.from(h.floorIds).map(x=>({id:x,name:h.floors[x].name,zIndex:h.floors[x].zIndex})).sort((x,E)=>E.zIndex-x.zIndex);this.fire(new i.z("selector-update",{selectedFloorId:g,activeFloorsVisible:this._activeFloorsVisible,floors:y}))}_updateActiveFloors(){let t=this._activeFloors;this._activeFloors=new Set,this._indoorState={selectedFloorId:this._selectedFloorId,lastActiveFloors:t,activeFloorsVisible:this._activeFloorsVisible},this._style.updateIndoorDependentLayers()}}var Ud=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,sg=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb*col.a,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,ag=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}
#ifndef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_id) attrib
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_id) attrib
#define DECLARE_MATERIAL_TABLE_INFO
#endif`,tu="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",nu=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;
#ifdef CLIP_ZERO_TO_ONE
coord.z=-1.0+2.0*coord.z; 
#endif
highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,lg=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,xf=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Xo=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,bf=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,rt=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,cg=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;let iu=[];Ts(Ud,iu),Ts(ag,iu),Ts(sg,iu);let ru={"_prelude_fog.vertex.glsl":lg,"_prelude_terrain.vertex.glsl":nu,"_prelude_shadow.vertex.glsl":rt,"_prelude_material_table.vertex.glsl":`#ifdef HAS_SHADER_STORAGE_BLOCK_material_buffer
#define MATERIAL_TABLE_DEBUG 0
uniform int u_material_offset;uniform int u_vertex_offset;layout(std140,binding=0)readonly buffer material_buffer{uvec4 material_data[];};struct MaterialInfo{uint dataOffset;
#if MATERIAL_TABLE_DEBUG
vec4 colorDebug;
#endif
};uint read_buf_no_offset(uint iDword) {return material_data[iDword/4u][iDword % 4u];}uint read_buf(uint iDword) {iDword+=uint(u_material_offset/4);return read_buf_no_offset(iDword);}float read_buf_float(uint iDword){return uintBitsToFloat(read_buf(iDword));}uint read_buf_uint8(uint iDword,uint iUint8){uint dwordOffset=iDword+(iUint8/4u);uint byteOffset=iUint8 & 3u;uint bitOffset=8u*byteOffset;uint mask=0xffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint read_buf_uint16(uint iDword,uint iUint16){uint dwordOffset=iDword+(iUint16 >> 1u);uint bitOffset=(iUint16 & 1u)*16u;uint mask=0xffffu << bitOffset;uint dwordVal=read_buf(dwordOffset);return (dwordVal & mask) >> bitOffset;}uint nrDwordsForVertexIdEntries(uint nrMaterialLookupEntries) {return nrMaterialLookupEntries;}uint nrDwordsForMaterialIdEntries(uint nrMaterialLookupEntries) {return (nrMaterialLookupEntries*2u+3u)/4u;}uint findRangeBinarySearch(uint vertexId,uint numRanges,uint dwordOffset) {uint left=0u;uint right=numRanges-1u;for (uint i=0u; i < 16u; i++) { 
if (left > right) {break;}uint mid=(left+right)/2u;uint start=read_buf(dwordOffset+mid);uint nextStart=(mid+1u < numRanges) ? read_buf(dwordOffset+mid+1u) : 0xffffffffu;if (vertexId >=start && vertexId < nextStart) {return mid;} else if (vertexId < start) {if (mid==0u) {break;}right=mid-1u;} else {left=mid+1u;}}return 0u; 
}uint readVertexId(uint dwordOffset,uint iMaterialLookupEntry) {return read_buf(dwordOffset+iMaterialLookupEntry);}uint findRange(uint vertexId,uint numRanges,uint dwordOffset) {uint iRange;if(numRanges <=64u){uint vertexBegin;for(iRange=0u; iRange < numRanges;++iRange) {vertexBegin=readVertexId(dwordOffset,iRange);if(vertexBegin > vertexId) {break;}}iRange=iRange==0u? 0u : iRange-1u;} else { 
iRange=findRangeBinarySearch(vertexId,numRanges,dwordOffset);}return iRange;}MaterialInfo read_material_info(uint vertex_id) {MaterialInfo info;
#if MATERIAL_TABLE_DEBUG
const vec4 red=vec4(1.0,0.0,0.0,1.0);const vec4 orange=vec4(1.0,0.5,0.0,1.0);const vec4 yellow=vec4(1.0,1.0,0.0,1.0);const vec4 green=vec4(0.0,1.0,0.0,1.0);const vec4 indigo=vec4(0.294,0.0,0.510,1.0);const vec4 blue=vec4(0.0,0.0,1.0,1.0);const vec4 purple=vec4(0.5,0.0,0.5,1.0);const vec4 pink=vec4(1.0,0.0,1.0,1.0);info.colorDebug=green;
#endif
uint offset=0u;
#if MATERIAL_TABLE_DEBUG
bool keepFinding=true;uint magic=read_buf(offset);if(magic !=0xCAFEBABEu) {info.colorDebug=red;keepFinding=false;return info;}
#endif
offset++;
#if MATERIAL_TABLE_DEBUG
uint nrMaterials=read_buf(offset);uint nrVertices=read_buf(offset+1u);if(keepFinding && vertex_id >=nrVertices) {info.colorDebug=red;keepFinding=false;}
#endif
offset+=2u;uint nrMaterialLookupEntries=read_buf(offset++);uint perMaterialEntrySizeDwords=read_buf(offset++);
#if MATERIAL_TABLE_DEBUG
if(keepFinding && perMaterialEntrySizeDwords !=1u) {info.colorDebug=red;keepFinding=false;}
#endif
uint iMaterialLookup=findRange(vertex_id,nrMaterialLookupEntries,offset);
#if MATERIAL_TABLE_DEBUG
if(keepFinding)
{uint vertexBeginCheck=readVertexId(offset,iMaterialLookup);if(vertexBeginCheck > vertex_id) {info.colorDebug=red;keepFinding=false;}if(iMaterialLookup < nrMaterialLookupEntries-1u) {uint vertexEndCheck=readVertexId(offset,iMaterialLookup+1u);if(vertexEndCheck <=vertex_id) {info.colorDebug=red;keepFinding=false;}}}
#endif
offset+=nrDwordsForVertexIdEntries(nrMaterialLookupEntries);uint materialId=iMaterialLookup;
#if MATERIAL_TABLE_DEBUG
if(keepFinding) {if(materialId >=nrMaterialLookupEntries) {info.colorDebug=red;}}
#endif
info.dataOffset=offset+materialId*perMaterialEntrySizeDwords;return info;}uint get_data_location(const MaterialInfo matInfo,uint attribOffsetBytes)
{uint attribFieldOffsetDwords=attribOffsetBytes/4u;return matInfo.dataOffset+attribFieldOffsetDwords;}vec4 read_material_vec4(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec4(read_buf_float(loc),read_buf_float(loc+1u),read_buf_float(loc+2u),read_buf_float(loc+3u));}vec2 read_material_vec2(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return vec2(read_buf_float(loc),read_buf_float(loc+1u));}float read_material_float(const MaterialInfo matInfo,uint attribOffsetBytes){uint loc=get_data_location(matInfo,attribOffsetBytes);return read_buf_float(loc);}
#define GET_ATTRIBUTE_float(attrib,matInfo,attrib_offset) read_material_float(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec4(attrib,matInfo,attrib_offset) read_material_vec4(matInfo,attrib_offset)
#define GET_ATTRIBUTE_vec2(attrib,matInfo,attrib_offset) read_material_vec2(matInfo,attrib_offset)
#define DECLARE_MATERIAL_TABLE_INFO MaterialInfo materialInfo=read_material_info(uint(gl_VertexID));
#define DECLARE_MATERIAL_TABLE_INFO_DEBUG(dbgColor) MaterialInfo materialInfo=read_material_info(uint(gl_VertexID)); dbgColor=materialInfo.colorDebug;
#endif`,"_prelude_fog.fragment.glsl":xf,"_prelude_shadow.fragment.glsl":cg,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":Xo,"_prelude_raster_particle.glsl":bf},Hd={};pn("",nu),pn(xf,lg),pn(cg,rt),pn(Xo,""),pn(bf,"");let $d=pn(sg,ag),fa=Ud;var wf={background:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef FLOOD_LIGHT
in highp float v_flood_radius;in float v_has_flood_light;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;uniform vec3 u_flood_light_color;uniform float u_flood_light_intensity;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=linearTosRGB(color.rgb);
#ifdef FLOOD_LIGHT
float flood_radiance=(1.0-min(v_pos.z/v_flood_radius,1.0))*u_flood_light_intensity*v_has_flood_light;color.rgb=mix(color.rgb,u_flood_light_color,flood_radiance);
#endif
color.rgb=mix(color.rgb,linearTosRGB(base_color.rgb),emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in float a_flood_light_wall_radius_1i16;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
#ifdef FLOOD_LIGHT
out highp float v_flood_radius;out float v_has_flood_light;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;const float FLOOD_LIGHT_MAX_RADIUS_METER=2048.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
#ifdef FLOOD_LIGHT
v_flood_radius=(a_flood_light_wall_radius_1i16/MAX_INT_16*FLOOD_LIGHT_MAX_RADIUS_METER);v_has_flood_light=step(0.0,v_flood_radius);
#endif
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:pn(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:pn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:pn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:pn(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:pn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:pn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:pn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:pn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:pn(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:pn(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#else
#ifdef FEATURE_CUTOUT
apply_feature_cutout(vec4(0.0,0.0,0.0,1.0),gl_FragCoord);
#endif
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:pn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_material_table.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {DECLARE_MATERIAL_TABLE_INFO
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:pn(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:pn(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:pn(`precision highp float;uniform highp sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),1.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:pn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:pn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:pn(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:pn(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef APPLY_LUT_ON_GPU
out_color=applyLUT(u_lutTexture,out_color);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#define APPEARANCE_ICON 1.0
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float a_size_max= floor(a_size[1]*0.5);float a_apperance_icon=a_size[1]-2.0*a_size_max;vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (a_apperance_icon==APPEARANCE_ICON) {size=a_size_max/128.0;} else if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size_max,u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
#ifdef Z_TEST_OCCLUSION
out_fade_opacity*=occlusion_opacity;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:pn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:pn(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,tu),skyboxGradient:pn(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,tu),skyboxCapture:pn(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:pn(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_atmosphere_fog_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_atmosphere_fog_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_atmosphere_fog_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:pn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef FLIP_Y
coord.y=1.0-coord.y;
#endif
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#ifdef CLIP_ZERO_TO_ONE
v_depth=-1.0+2.0*v_depth; 
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:pn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:pn(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:pn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:pn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:pn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:pn("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Ts(d,t){let o=d.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let h of o)if(h=h.trim(),h[0]==="#"&&h.includes("if")&&!h.includes("endif")){h=h.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let g=h.split(" ");for(let y of g)t.includes(y)||t.push(y)}}function pn(d,t){let o=/#include\s+"([^"]+)"/g,h=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,g={},y=[],x=[];if(d=d.replace(o,(T,A)=>(x.push(A),"")),(t=t.replace(o,(T,A)=>(y.push(A),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let E=[...iu];Ts(d,E),Ts(t,E);for(let T of[...y,...x])ru[T]||console.error(`Undefined include: ${T}`),Hd[T]||(Hd[T]=[],Ts(ru[T],Hd[T])),E=[...E,...Hd[T]];return{fragmentSource:d=d.replace(h,(T,A,M,L,R)=>(g[R]=!0,A==="define"?`
#ifndef HAS_UNIFORM_u_${R}
in ${M} ${L} ${R};
#else
uniform ${M} ${L} u_${R};
#endif
`:A==="initialize"?`
#ifdef HAS_UNIFORM_u_${R}
    ${M} ${L} ${R} = u_${R};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    in ${M} ${L} ${R};
#endif
`:A==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(h,(T,A,M,L,R)=>{let F=`MATERIAL_ATTRIBUTE_OFFSET_${R}`,z=L==="float"?"vec2":L,j=`GET_ATTRIBUTE_${z}(a_${R}, materialInfo, ${F})`,q=R.match(/color/)?"color":z;return A==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${R}
in ${M} ${L} a_${R};
#endif
`:g[R]?A==="define"?`
#ifndef HAS_UNIFORM_u_${R}
uniform lowp float u_${R}_t;
    #if !defined(${F})
        in ${M} ${z} a_${R};
    #endif
out ${M} ${L} ${R};
#else
uniform ${M} ${L} u_${R};
#endif
`:A==="initialize"?q==="vec4"?`
#ifndef HAS_UNIFORM_u_${R}
    ${R} = a_${R};
#else
    ${M} ${L} ${R} = u_${R};
#endif
`:`
#if !defined(HAS_UNIFORM_u_${R}) 
    #ifdef ${F}
        ${R} = unpack_mix_${q}(${j}, u_${R}_t);
    #else
        ${R} = unpack_mix_${q}(a_${R}, u_${R}_t);
    #endif
#else
    ${M} ${L} ${R} = u_${R};
#endif
`:A==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    in ${M} ${L} a_${R};
    out ${M} ${L} ${R};
#endif
`:A==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    ${R} = a_${R};
#endif
`:void 0:A==="define"?`
#ifndef HAS_UNIFORM_u_${R}
uniform lowp float u_${R}_t;
    #if !defined(${F})
        in ${M} ${z} a_${R};
    #endif  
#else
uniform ${M} ${L} u_${R};
#endif
`:A==="define-instanced"?q==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${R}0;
in vec4 a_${R}1;
in vec4 a_${R}2;
in vec4 a_${R}3;
#else
uniform ${M} ${L} u_${R};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${M} ${z} a_${R};
#else
uniform ${M} ${L} u_${R};
#endif
`:A==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${R}
    ${M} ${L} ${R} = a_${R};
#endif
`:q==="vec4"?`
#ifndef HAS_UNIFORM_u_${R}
    #ifdef ${F}
        ${M} ${L} ${R} = ${j};
    #else
        ${M} ${L} ${R} = a_${R};
    #endif
#else
    ${M} ${L} ${R} = u_${R};
#endif
`:`
#ifndef HAS_UNIFORM_u_${R}
    #ifdef ${F}
        ${M} ${L} ${R} = unpack_mix_${q}(${j}, u_${R}_t);
    #else
        ${M} ${L} ${R} = unpack_mix_${q}(a_${R}, u_${R}_t);
    #endif
#else
    ${M} ${L} ${R} = u_${R};
#endif
`}),usedDefines:E,vertexIncludes:y,fragmentIncludes:x}}class ou{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,o,h,g,y,x,E,T){this.context=t;let A=this.boundPaintVertexBuffers.length!==g.length;for(let L=0;!A&&L<g.length;L++)this.boundPaintVertexBuffers[L]!==g[L]&&(A=!0);let M=this.boundDynamicVertexBuffers.length!==E.length;for(let L=0;!M&&L<E.length;L++)this.boundDynamicVertexBuffers[L]!==E[L]&&(M=!0);if(!this.vao||this.boundProgram!==o||this.boundLayoutVertexBuffer!==h||A||M||this.boundIndexBuffer!==y||this.boundVertexOffset!==x)this.freshBind(o,h,g,y,x,E,T);else{t.bindVertexArrayOES.set(this.vao);for(let L of E)L&&(L.bind(),T&&L.instanceCount&&L.setVertexAttribDivisor(t.gl,o,T));y&&y.dynamicDraw&&y.bind()}}freshBind(t,o,h,g,y,x,E){let T=this.context,A=T.gl;this.vao&&this.destroy(),this.vao=T.gl.createVertexArray(),T.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=o,this.boundPaintVertexBuffers=h,this.boundIndexBuffer=g,this.boundVertexOffset=y,this.boundDynamicVertexBuffers=x,o.enableAttributes(A,t),o.bind(),o.setVertexAttribPointers(A,t,y);for(let M of h)M.enableAttributes(A,t),M.bind(),M.setVertexAttribPointers(A,t,y);for(let M of x)M&&(M.enableAttributes(A,t),M.bind(),M.setVertexAttribPointers(A,t,y),E&&M.instanceCount&&M.setVertexAttribDivisor(A,t,E));g&&g.bind()}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function P1(d,t){let o=Math.pow(2,t.canonical.z),h=t.canonical.y;return[new i.ae(0,h/o).toLngLat().lat,new i.ae(0,(h+1)/o).toLngLat().lat]}function O1(d,t,o,h,g,y,x){let E=d.context,T=E.gl,A=o.hillshadeFBO;if(!A)return;d.prepareDrawTile();let M=d.isTileAffectedByFog(t),L=d.getOrCreateProgram("hillshade",{overrideFog:M});E.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,A.colorAttachment.get());let R=((q,$,Z,J)=>{let Y=Z.paint.get("hillshade-shadow-color"),ae=Z.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",Q=Z.paint.get("hillshade-highlight-color"),ce=Z.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",se=Z.paint.get("hillshade-accent-color"),ie=Z.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",ue=Z.paint.get("hillshade-emissive-strength"),be=i.an(Z.paint.get("hillshade-illumination-direction"));if(Z.paint.get("hillshade-illumination-anchor")==="viewport")be-=q.transform.angle;else if(q.style&&q.style.enable3dLights()&&q.style.directionalLight){let Pe=q.style.directionalLight.properties.get("direction"),Se=i.d3(Pe.x,Pe.y,Pe.z);be=i.an(Se[1])}let ye=!q.options.moving;return{u_matrix:J||q.transform.calculateProjMatrix($.tileID.toUnwrapped(),ye),u_image:0,u_latrange:P1(0,$.tileID),u_light:[Z.paint.get("hillshade-exaggeration"),be],u_shadow:Y.toPremultipliedRenderColor(ae?null:Z.lut),u_highlight:Q.toPremultipliedRenderColor(ce?null:Z.lut),u_emissive_strength:ue,u_accent:se.toPremultipliedRenderColor(ie?null:Z.lut)}})(d,o,h,d.terrain?t.projMatrix:null);d.uploadCommonUniforms(E,L,t.toUnwrapped());let{tileBoundsBuffer:F,tileBoundsIndexBuffer:z,tileBoundsSegments:j}=d.getTileBoundsBuffers(o);L.draw(d,T.TRIANGLES,g,y,x,jt.disabled,R,h.id,F,z,j)}function Ef(d,t,o){if(!t.needsDEMTextureUpload)return;let h=d.context,g=h.gl;h.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||d.getTileTexture(o.stride);let y=o.getPixels();t.demTexture?t.demTexture.update(y,{premultiply:!1}):t.demTexture=new i.T(h,y,g.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function L1(d,t,o){let h=d.context,g=h.gl;if(!t.dem)return;let y=t.dem;if(h.activeTexture.set(g.TEXTURE1),Ef(d,t,y),!t.demTexture)return;t.demTexture.bind(g.NEAREST,g.CLAMP_TO_EDGE);let x=y.dim;h.activeTexture.set(g.TEXTURE0);let E=t.hillshadeFBO;if(!E){let R=new i.T(h,{width:x,height:x,data:null},g.RGBA8);R.bind(g.LINEAR,g.CLAMP_TO_EDGE),E=t.hillshadeFBO=h.createFramebuffer(x,x,!0,"renderbuffer"),E.colorAttachment.set(R.texture)}h.bindFramebuffer.set(E.framebuffer),h.viewport.set([0,0,x,x]);let{tileBoundsBuffer:T,tileBoundsIndexBuffer:A,tileBoundsSegments:M}=d.getMercatorTileBoundsBuffers(),L=[];d.linearFloatFilteringSupported()&&L.push("TERRAIN_DEM_FLOAT_FORMAT"),d.getOrCreateProgram("hillshadePrepare",{defines:L}).draw(d,g.TRIANGLES,Tt.disabled,qt.disabled,rn.unblended,jt.disabled,((R,F)=>{let z=F.stride,j=i.bB();return i.cd(j,0,i.al,-i.al,0,0,1),i.bq(j,j,[0,-i.al,0]),{u_matrix:j,u_image:1,u_dimension:[z,z],u_zoom:R.overscaledZ}})(t.tileID,y),o.id,T,A,M),t.needsHillshadePrepare=!1}class Di{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Rv extends Di{getDefault(){return i.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class ug extends Di{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class F1 extends Di{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class k1 extends Di{getDefault(){return[!0,!0,!0,!0]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class N1 extends Di{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class z1 extends Di{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class Pv extends Di{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){let o=this.current;(t.func!==o.func||t.ref!==o.ref||t.mask!==o.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class B1 extends Di{getDefault(){let t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Tf extends Di{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),this.current=t,this.dirty=!1}}class V1 extends Di{getDefault(){return[0,1]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Ov extends Di{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.current=t,this.dirty=!1}}class dg extends Di{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class If extends Di{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.BLEND):o.disable(o.BLEND),this.current=t,this.dirty=!1}}class hg extends Di{getDefault(){let t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class oc extends Di{getDefault(){return i.ao.transparent.toNonPremultipliedRenderColor(null)}set(t){let o=this.current;(t.r!==o.r||t.g!==o.g||t.b!==o.b||t.a!==o.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class su extends Di{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Gd extends Di{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;t?o.enable(o.CULL_FACE):o.disable(o.CULL_FACE),this.current=t,this.dirty=!1}}class au extends Di{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Lv extends Di{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let fg=class extends Di{getDefault(){return null}set(d){(d!==this.current||this.dirty)&&(this.gl.useProgram(d),this.current=d,this.dirty=!1)}};class Fv extends Di{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class lu extends Di{getDefault(){let t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){let o=this.current;(t[0]!==o[0]||t[1]!==o[1]||t[2]!==o[2]||t[3]!==o[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Sf extends Di{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindFramebuffer(o.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Df extends Di{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindRenderbuffer(o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class pg extends Di{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindTexture(o.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Cf extends Di{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.bindBuffer(o.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class qd extends Di{getDefault(){return null}set(t){let o=this.gl;o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class kv extends Di{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Nv extends Di{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class zv extends Di{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class cu extends Di{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;let o=this.gl;o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Af extends Di{constructor(t,o){super(t),this.context=t,this.parent=o}getDefault(){return null}}class j1 extends Af{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Bv extends Af{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferRenderbuffer(o.FRAMEBUFFER,this.attachment(),o.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class U1 extends Af{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let o=this.gl;o.framebufferTexture2D(o.FRAMEBUFFER,this.attachment(),o.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class mg extends Bv{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}let gg=(d,t,o)=>({u_matrix:d,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:o}),Mf=(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j)=>({u_proj_matrix:Float32Array.from(d),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(h),u_merc_matrix:o,u_zoom_transition:g,u_merc_center:y,u_image0:0,u_frustum_tl:x,u_frustum_tr:E,u_frustum_br:T,u_frustum_bl:A,u_globe_pos:M,u_globe_radius:L,u_viewport:R,u_grid_matrix:j?Float32Array.from(j):new Float32Array(9),u_skirt_height:F,u_far_z_cutoff:z});function Rf(d,t){return d!=null&&t!=null&&!(!d.hasData()||!t.hasData())&&d.demTexture!=null&&t.demTexture!=null&&d.tileID.key!==t.tileID.key}let sc=new class{constructor(){this.operations={}}newMorphing(d,t,o,h,g){if(d in this.operations){let y=this.operations[d];y.to.tileID.key!==o.tileID.key&&(y.queued=o)}else this.operations[d]={startTime:h,phase:0,duration:g,from:t,to:o,queued:null}}getMorphValuesForProxy(d){if(!(d in this.operations))return null;let t=this.operations[d];return{from:t.from,to:t.to,phase:t.phase}}update(d){for(let t in this.operations){let o=this.operations[t];for(o.phase=(d-o.startTime)/o.duration;o.phase>=1||!this._validOp(o);)if(!this._nextOp(o,d)){delete this.operations[t];break}}}_nextOp(d,t){return!!d.queued&&(d.from=d.to,d.to=d.queued,d.queued=null,d.phase=0,d.startTime=t,!0)}_validOp(d){return d.from.hasData()&&d.to.hasData()}},_g={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Vv(d,t,o){if(t===0)return 0;let h=t<1&&o===514?.25/t:1;return 6*Math.pow(1.5,22-d)*Math.max(t,1)*h}function Wd(d,t){let o=1<<d.z;return!t&&(d.x===0||d.x===o-1)||d.y===0||d.y===o-1}let ac=d=>({u_matrix:d});function Pf(d,t,o,h,g){if(g>0){let y=i.o.now(),x=(y-d.timeAdded)/g,E=t?(y-t.timeAdded)/g:-1,T=o.getSource(),A=h.coveringZoomLevel({tileSize:T.tileSize,roundZoom:T.roundZoom}),M=!t||Math.abs(t.tileID.overscaledZ-A)>Math.abs(d.tileID.overscaledZ-A),L=M&&d.refreshedUponExpiration?1:i.aA(M?x:1-E,0,1);return t?{opacity:1,mix:1-L,isFading:x<1}:{opacity:L,mix:0,isFading:x<1}}return{opacity:1,mix:0,isFading:!1}}class Yo extends vs{constructor(t){let o=uo("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",o,!1),o.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,o){t.state="loaded",o(null)}}class yg extends vs{constructor(t){let o=uo("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",o,!1),o.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,o,h){if(t.freezeTileCoverage)return;this.transform=t;let g=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((y,x)=>{if(y[x.key]="",!this._tiles[x.key]){let E=new ua(x,this._source.tileSize*x.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);E.state="loaded",this._tiles[x.key]=E}return y},{});for(let y in this._tiles)y in g||(this.freeFBO(y),this._tiles[y].unloadVectorData(),delete this._tiles[y])}freeFBO(t){let o=this.proxyCachedFBO[t];if(o!==void 0){let h=Object.values(o);this.renderCachePool.push(...h),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Zd extends i.aP{constructor(t,o,h){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=o,this.projMatrix=h}}class Xd extends i.bU{constructor(t,o){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[h,g,y]=(function(T){let A=new i.bc,M=new i.b0,L=131;A.reserve(17161),M.reserve(33800);let R=i.al/128,F=i.al+R/2,z=F+R;for(let q=-R;q<z;q+=R)for(let $=-R;$<z;$+=R){let Z=$<0||$>F||q<0||q>F?24575:0,J=i.aA(Math.round($),0,i.al),Y=i.aA(Math.round(q),0,i.al);A.emplaceBack(J+Z,Y)}let j=(q,$)=>{let Z=$*L+q;M.emplaceBack(Z+1,Z,Z+L),M.emplaceBack(Z+L,Z+L+1,Z+1)};for(let q=1;q<129;q++)for(let $=1;$<129;$++)j($,q);return[0,129].forEach(q=>{for(let $=0;$<130;$++)j($,q),j(q,$)}),[A,M,32768]})(),x=t.context;this.gridBuffer=x.createVertexBuffer(h,i.be.members),this.gridIndexBuffer=x.createIndexBuffer(g),this.gridSegments=i.bf.simpleSegment(0,0,h.length,g.length),this.gridNoSkirtSegments=i.bf.simpleSegment(0,0,h.length,y),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new yg(o.map),this.orthoMatrix=i.bB(),i.cd(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,i.al,0,i.al,0,1);let E=x.gl;this._overlapStencilMode=new qt({func:E.GEQUAL,mask:255},0,255,E.KEEP,E.KEEP,E.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=o,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Yo(o.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,o,h){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);let g=t.terrain.properties,y=t.terrain.drapeRenderMode===0,x=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=i.o.now();let E=t.terrain&&t.terrain.scope,T=g.get("source"),A=y?this._mockSourceCache:t.getSourceCache(T,E);if(!A)return void i.w(`Couldn't find terrain source "${T}".`);if(this.sourceCache=A,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=x?this.calculateExaggeration(o):g.get("exaggeration"),!o.projection.requiresDraping&&x&&this._exaggeration===0)return void this._disable();this.enabled=!0;let M=()=>{this.sourceCache.used&&i.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let L=this.getScaledDemTileSize();this.sourceCache.update(o,L,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,M(),this._initializing=!0),M(),o.updateElevation(!0,h),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(o),this._emptyDEMTextureDirty=!0,this._previousZoom=o.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);let o=this._previousCameraAltitude,h=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=h;let g=o!=null?h-o:Number.MAX_VALUE;if(Math.abs(g)<2)return this._exaggeration;let y=t.zoom,x=this._style.terrain;if(!this._previousUpdateTimestamp)return x.getExaggeration(y);let E=y-this._previousZoom,T=this._previousUpdateTimestamp,A=y;this._evaluationZoom!=null&&(A=this._evaluationZoom,Math.abs(y-A)>.5&&(E=.5*(y-A+E)),E*g<0&&(A+=E)),this._evaluationZoom=A;let M=x.getExaggeration(A),L=M===x.getExaggeration(Math.max(0,A-.1));if(L&&Math.abs(M-this._exaggeration)<.01)return M;let R=Math.min(.1,.00375*(this._updateTimestamp-T));return(L||M<.1||Math.abs(E)<1e-4)&&(R=Math.min(.2,4*R)),i.ak(this._exaggeration,M,R)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.dataType==="source"&&t.coord?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let o=this.proxySourceCache,h=this.painter.transform;this._initializing&&(this._initializing=h._centerAltitude===0&&this.getAtPointOrZero(i.ae.fromLngLat(h.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);let g=this.proxyCoords=o.getIds().map(T=>{let A=o.getTileByID(T).tileID;return A.projMatrix=h.calculateProjMatrix(A.toUnwrapped()),A});(function(T,A){let M=A.transform.pointCoordinate(A.transform.getCameraPoint()),L=new i.P(M.x,M.y);T.sort((R,F)=>{if(F.overscaledZ-R.overscaledZ)return F.overscaledZ-R.overscaledZ;let z=new i.P(R.canonical.x+(1<<R.canonical.z)*R.wrap,R.canonical.y),j=new i.P(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),q=L.mult(1<<R.canonical.z);return q.x-=.5,q.y-=.5,q.distSqr(z)-q.distSqr(j)})})(g,this.painter);let y=this.proxyToSource||{};this.proxyToSource={},g.forEach(T=>{this.proxyToSource[T.key]={}}),this.terrainTileForTile={};let x=this._style._mergedSourceCaches;for(let T in x){let A=x[T];if(!A.used||(A!==this.sourceCache&&this.resetTileLookupCache(A.id),this._setupProxiedCoordsForOrtho(A,t[T],y),A.usedForTerrain))continue;let M=t[T];A.getSource().reparseOverscaled&&this._assignTerrainTiles(M)}this.proxiedCoords[o.id]=g.map(T=>new Zd(T,T.key,this.orthoMatrix)),this._assignTerrainTiles(g),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(y),this.renderingToTexture=!1;let E={};this._visibleDemTiles=[];for(let T of this.proxyCoords){let A=this.terrainTileForTile[T.key];if(!A)continue;let M=A.tileID.key;M in E||(this._visibleDemTiles.push(A),E[M]=M)}}_assignTerrainTiles(t){this._initializing||t.forEach(o=>{if(this.terrainTileForTile[o.key])return;let h=this._findTileCoveringTileID(o,this.sourceCache);h&&(this.terrainTileForTile[o.key]=h)})}_prepareDEMTextures(){let t=this.painter.context,o=t.gl;for(let h in this.terrainTileForTile){let g=this.terrainTileForTile[h],y=g.dem;!y||g.demTexture&&!g.needsDEMTextureUpload||(t.activeTexture.set(o.TEXTURE1),Ef(this.painter,g,y))}}_prepareDemTileUniforms(t,o,h,g){if(!o||o.demTexture==null)return!1;let y=t.tileID.canonical,x=Math.pow(2,o.tileID.canonical.z-y.z),E=g||"";return h[`u_dem_tl${E}`]=[y.x*x%1,y.y*x%1],h[`u_dem_scale${E}`]=x,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0,o=this._visibleDemTiles.reduce((h,g)=>{if(!g.dem)return h;let y=g.dem.tree.minimums[0];return y>0&&t++,h+y},0);return t?o/t:0}_updateEmptyDEMTexture(){let t=this.painter.context,o=t.gl;t.activeTexture.set(o.TEXTURE2);let h=this._getLoadedAreaMinimum(),g=new i.dK({width:1,height:1},new Float32Array([h]));this._emptyDEMTextureDirty=!1;let y=this._emptyDEMTexture;return y?y.update(g,{premultiply:!1}):y=this._emptyDEMTexture=new i.T(t,g,o.R32F,{premultiply:!1}),y}setupElevationDraw(t,o,h){let g=this.painter.context,y=g.gl,x={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};x.u_exaggeration=this.exaggeration();let E=null,T=null,A=1;if(h&&h.morphing&&this._useVertexMorphing){let F=h.morphing.srcDemTile,z=h.morphing.dstDemTile;A=h.morphing.phase,F&&z&&(this._prepareDemTileUniforms(t,F,x,"_prev")&&(T=F),this._prepareDemTileUniforms(t,z,x)&&(E=z))}let M=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?y.LINEAR:y.NEAREST,L=null;var R;if(this.enabled?T&&E?(L=E.demTexture,g.activeTexture.set(y.TEXTURE4),T.demTexture.bind(M(T),y.CLAMP_TO_EDGE),x.u_dem_lerp=A):(E=this.terrainTileForTile[t.tileID.key],L=this._prepareDemTileUniforms(t,E,x)?E.demTexture:this.emptyDEMTexture):L=this.emptyDEMTexture,g.activeTexture.set(y.TEXTURE2),L&&(x.u_dem_size=(R=L).size[0]===1?1:R.size[0]-2,L.bind(M(E),y.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(h&&h.useDepthForOcclusion,o,x),h&&h.useMeterToDem&&E){let F=(1<<E.tileID.canonical.z)*i.ce(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;x.u_meter_to_dem=F}if(h&&h.labelPlaneMatrixInv&&(x.u_label_plane_matrix_inv=h.labelPlaneMatrixInv),o.setTerrainUniformValues(g,x),this.painter.transform.projection.name==="globe"){let F=this.globeUniformValues(this.painter.transform,t.tileID.canonical,h&&h.useDenormalizedUpVectorScale);o.setGlobeUniformValues(g,F)}}globeUniformValues(t,o,h){let g=t.projection;return{u_tile_tl_up:g.upVector(o,0,0),u_tile_tr_up:g.upVector(o,i.al,0),u_tile_br_up:g.upVector(o,i.al,i.al),u_tile_bl_up:g.upVector(o,0,i.al),u_tile_up_scale:h?i.dL(1):g.upVectorScale(o,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){let o=this.painter,h=this.painter.context;t.length!==0&&(h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),o.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,(function(g,y,x,E,T){if(g.transform.projection.name==="globe")(function(A,M,L,R,F){let z=A.context,j=z.gl,q,$,Z=A.transform,J=i.dD(A,z,Z),Y=(Pe,Se)=>{if($===Se)return;let Be=[_g[Se],"PROJECTION_GLOBE_VIEW"];J&&Be.push("CUSTOM_ANTIALIASING");let tt=A.isTileAffectedByFog(Pe);q=A.getOrCreateProgram("globeRaster",{defines:Be,overrideFog:tt}),$=Se},ae=A.colorModeForRenderPass(),Q=new Tt(j.LEQUAL,Tt.ReadWrite,A.depthRangeFor3D);sc.update(F);let ce=i.dE(Z),se=[i.aF(Z.center.lng),i.aJ(Z.center.lat)],ie=A.globeSharedBuffers,ue=[Z.width*i.o.devicePixelRatio,Z.height*i.o.devicePixelRatio],be=Float32Array.from(Z.globeMatrix),ye={useDenormalizedUpVectorScale:!0};{let Pe=A.transform,Se=Vv(Pe.zoom,M.exaggeration(),M.sourceCache._source.tileSize);$=-1;let Be=j.TRIANGLES;for(let tt of R){let Ie=L.getTile(tt),me=qt.disabled,Ve=M.prevTerrainTileForTile[tt.key],De=M.terrainTileForTile[tt.key];Rf(Ve,De)&&sc.newMorphing(tt.key,Ve,De,F,250),z.activeTexture.set(j.TEXTURE0),Ie.texture&&Ie.texture.bind(j.LINEAR,j.CLAMP_TO_EDGE);let Ge=sc.getMorphValuesForProxy(tt.key),ot=Ge?1:0;Ge&&Object.assign(ye,{morphing:{srcDemTile:Ge.from,dstDemTile:Ge.to,phase:i.dC(Ge.phase)}});let xt=i.dF(tt.canonical),Je=i.dG(xt.getCenter().lat),it=i.dH(tt.canonical,xt,Je,Pe.worldSize/Pe._pixelsPerMercatorPixel),wt=i.bj(i.dI(tt.canonical)),mt=Mf(Pe.expandedFarZProjMatrix,be,ce,wt,i.aj(Pe.zoom),se,Pe.frustumCorners.TL,Pe.frustumCorners.TR,Pe.frustumCorners.BR,Pe.frustumCorners.BL,Pe.globeCenterInViewSpace,Pe.globeRadius,ue,Se,Pe._farZ,it);if(Y(tt,ot),q&&(M.setupElevationDraw(Ie,q,ye),A.uploadCommonUniforms(z,q,tt.toUnwrapped()),ie)){let[ht,gt,Ot]=ie.getGridBuffers(Je,Se!==0);q.draw(A,Be,Q,me,ae,jt.backCCW,mt,"globe_raster",ht,gt,Ot)}}}if(ie&&(A.renderDefaultNorthPole||A.renderDefaultSouthPole)){let Pe=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];J&&Pe.push("CUSTOM_ANTIALIASING"),q=A.getOrCreateProgram("globeRaster",{defines:Pe});for(let Se of R){let{x:Be,y:tt,z:Ie}=Se.canonical,me=tt===0,Ve=tt===(1<<Ie)-1,[De,Ge,ot,xt]=ie.getPoleBuffers(Ie,!1);if(xt&&(me||Ve)){let Je=L.getTile(Se);z.activeTexture.set(j.TEXTURE0),Je.texture&&Je.texture.bind(j.LINEAR,j.CLAMP_TO_EDGE);let it=i.dJ(Ie,Be,Z),wt=i.bj(i.dI(Se.canonical)),mt=(ht,gt)=>ht.draw(A,j.TRIANGLES,Q,qt.disabled,ae,jt.disabled,Mf(Z.expandedFarZProjMatrix,it,it,wt,0,se,Z.frustumCorners.TL,Z.frustumCorners.TR,Z.frustumCorners.BR,Z.frustumCorners.BL,Z.globeCenterInViewSpace,Z.globeRadius,ue,0,Z._farZ),"globe_pole_raster",gt,ot,xt);M.setupElevationDraw(Je,q,ye),A.uploadCommonUniforms(z,q,Se.toUnwrapped()),me&&A.renderDefaultNorthPole&&mt(q,De),Ve&&A.renderDefaultSouthPole&&(it=i.cR(i.bB(),it,[1,-1,1]),mt(q,Ge))}}}})(g,y,x,E,T);else{let A=g.context,M=A.gl,L,R,F=g.shadowRenderer,z=Fa(g,g.longestCutoffRange),j=ae=>{if(R===ae)return;let Q=[];Q.push(_g[ae]),z.shouldRenderCutoff&&Q.push("RENDER_CUTOFF"),F&&(Q.push("RENDER_SHADOWS","DEPTH_TEXTURE"),F.useNormalOffset&&Q.push("NORMAL_OFFSET")),L=g.getOrCreateProgram("terrainRaster",{defines:Q}),R=ae},q=g.colorModeForRenderPass(),$=new Tt(M.LEQUAL,Tt.ReadWrite,g.depthRangeFor3D);sc.update(T);let Z=g.transform,J=Vv(Z.zoom,y.exaggeration(),y.sourceCache._source.tileSize),Y=[0,0,0];if(F){let ae=g.style.directionalLight,Q=g.style.ambientLight;ae&&Q&&(Y=ws(g.style,ae,Q))}{R=-1;let ae=M.TRIANGLES,[Q,ce]=[y.gridIndexBuffer,y.gridSegments];for(let se of E){let ie=x.getTile(se),ue=qt.disabled,be=y.prevTerrainTileForTile[se.key],ye=y.terrainTileForTile[se.key];Rf(be,ye)&&sc.newMorphing(se.key,be,ye,T,250),A.activeTexture.set(M.TEXTURE0),ie.texture&&ie.texture.bind(M.LINEAR,M.CLAMP_TO_EDGE);let Pe=sc.getMorphValuesForProxy(se.key),Se=Pe?1:0,Be;Pe&&(Be={morphing:{srcDemTile:Pe.from,dstDemTile:Pe.to,phase:i.dC(Pe.phase)}});let tt=gg(se.projMatrix,Wd(se.canonical,Z.renderWorldCopies)?J/10:J,Y);if(j(Se),!L)continue;y.setupElevationDraw(ie,L,Be);let Ie=se.toUnwrapped();F&&F.setupShadows(Ie,L),g.uploadCommonUniforms(A,L,Ie,null,z),L.draw(g,ae,$,ue,q,jt.backCCW,tt,"terrain_raster",y.gridBuffer,Q,ce)}}}})(o,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,o.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;let o=this.painter,h=this.painter.context,g=this.proxySourceCache,y=this.proxiedCoords[g.id],x=this._drapedRenderBatches.shift(),E=o.style.order,T=[],A=0;for(let M of y){let L=g.getTileByID(M.proxyTileKey),R=g.proxyCachedFBO[M.key]?g.proxyCachedFBO[M.key][t]:void 0,F=R!==void 0?g.renderCache[R]:this.pool[A++],z=R!==void 0;if(L.texture=F.tex,z&&!F.dirty){T.push(L.tileID);continue}let j;h.bindFramebuffer.set(F.fb.framebuffer),this.renderedToTile=!1,F.dirty&&(h.clear({color:i.ao.transparent,stencil:0}),F.dirty=!1);for(let q=x.start;q<=x.end;++q){let $=o.style._mergedLayers[E[q]];if($.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache($),J=Z?this.proxyToSource[M.key][Z.id]:[M];if(!J)continue;let Y=J;h.viewport.set([0,0,F.fb.width,F.fb.height]),j!==(Z?Z.id:null)&&(this._setupStencil(F,J,$,Z),j=Z?Z.id:null),o.renderLayer(o,Z,$,Y)}if(this._drapedRenderBatches.length===0)for(let q of this._pendingGroundEffectLayers){let $=o.style._mergedLayers[E[q]];if($.isHidden(o.transform.zoom))continue;let Z=o.style.getLayerSourceCache($),J=Z?this.proxyToSource[M.key][Z.id]:[M];if(!J)continue;let Y=J;h.viewport.set([0,0,F.fb.width,F.fb.height]),j!==(Z?Z.id:null)&&(this._setupStencil(F,J,$,Z),j=Z?Z.id:null),o.renderLayer(o,Z,$,Y)}this.renderedToTile?(F.dirty=!0,T.push(L.tileID)):z||--A,A===5&&(A=0,this.renderToBackBuffer(T))}return this.renderToBackBuffer(T),this.renderingToTexture=!1,h.bindFramebuffer.set(null),h.viewport.set([0,0,o.width,o.height]),x.end+1}postRender(){}isLayerOrderingCorrect(t){let o=t.order.length,h=-1,g=o;for(let y=0;y<o;++y)this._style.isLayerDraped(t._mergedLayers[t.order[y]])?h=Math.max(h,y):g=Math.min(g,y);return g>h}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(o=>o.dem).forEach(o=>{t=Math.min(t,o.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,o,h){if(!this._visibleDemTiles)return null;let g=this._visibleDemTiles.filter(y=>y.dem).map(y=>{let x=y.tileID,E=1<<x.overscaledZ,{x:T,y:A}=x.canonical,M=T/E,L=(T+1)/E,R=A/E,F=(A+1)/E;return{minx:M,miny:R,maxx:L,maxy:F,t:y.dem.tree.raycastRoot(M,R,L,F,t,o,h),tile:y}});g.sort((y,x)=>(y.t!==null?y.t:Number.MAX_VALUE)-(x.t!==null?x.t:Number.MAX_VALUE));for(let y of g){if(y.t==null)return null;let x=y.tile.dem.tree.raycast(y.minx,y.miny,y.maxx,y.maxy,t,o,h);if(x!=null)return x}return null}_createFBO(){let t=this.painter.context,o=t.gl,h=this.drapeBufferSize;t.activeTexture.set(o.TEXTURE0);let g=new i.T(t,{width:h[0],height:h[1],data:null},o.RGBA8);g.bind(o.LINEAR,o.CLAMP_TO_EDGE);let y=t.createFramebuffer(h[0],h[1],!0,null);return y.colorAttachment.set(g.texture),y.depthAttachment=new mg(t,y.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,h[0],h[1]),this._stencilRef=0,y.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):y.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&o.texParameterf(o.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:y,tex:g,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{let o=this._style._mergedLayers[t],h=o.isHidden(this.painter.transform.zoom);return o.type==="hillshade"||o.type==="custom"?!h&&o.shouldRedrape():!h&&o.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(let h of this._style.getSources())if(h instanceof to){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let g=this._style._mergedLayers[this._style.order[h]],y=this._style.getLayerSourceCache(g);if(y&&!o[y.id]&&!g.isHidden(this.painter.transform.zoom)&&g.type==="line"&&g.widthExpression()instanceof i.ad){o[y.id]=!0;for(let x of this.proxyCoords){let E=this.proxyToSource[x.key][y.id];if(E)for(let T of E)this._clearRenderCacheForTile(y.id,T)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(let h in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[h]._source instanceof _s){t=!0;break}if(!t)return;let o={};for(let h=0;h<this._style.order.length;++h){let g=this._style._mergedLayers[this._style.order[h]],y=this._style.getLayerSourceCache(g);if(!y||o[y.id]||g.isHidden(this.painter.transform.zoom)||g.type!=="raster")continue;let x=g.paint.get("raster-fade-duration");for(let E of this.proxyCoords){let T=this.proxyToSource[E.key][y.id];if(T)for(let A of T){let M=Pf(y.getTile(A),y.findLoadedParent(A,0),y,this.painter.transform,x);(M.opacity!==1||M.mix!==0)&&this._clearRenderCacheForTile(y.id,A)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let t=this._style.order,o=t.length;if(o===0)return;let h=[];this._pendingGroundEffectLayers=[];let g,y=0,x=this._style._mergedLayers[t[y]];for(;!this._style.isLayerDraped(x)&&x.isHidden(this.painter.transform.zoom)&&++y<o;)x=this._style._mergedLayers[t[y]];for(;y<o;++y){let E=this._style._mergedLayers[t[y]];E.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(E)?g===void 0&&(g=y):(E.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(y),g!==void 0&&(h.push({start:g,end:y-1}),g=void 0)))}if(g!==void 0&&h.push({start:g,end:y-1}),h.length!==0){let E=h[h.length-1];this._pendingGroundEffectLayers.every(T=>T>E.end)||i.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=h}_setupRenderCache(t){let o=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,o.renderCache.length>o.renderCachePool.length){let x=Object.values(o.proxyCachedFBO);o.proxyCachedFBO={};for(let E=0;E<x.length;++E){let T=Object.values(x[E]);o.renderCachePool.push(...T)}}return}this._clearRasterLayersFromRenderCache();let h=this.proxyCoords,g=this._tilesDirty;for(let x=h.length-1;x>=0;x--){let E=h[x];if(o.getTileByID(E.key),o.proxyCachedFBO[E.key]!==void 0){let T=t[E.key],A=this.proxyToSource[E.key],M=0;for(let L in A){let R=A[L],F=T[L];if(!F||F.length!==R.length||R.some((z,j)=>z!==F[j]||g[L]&&g[L].hasOwnProperty(z.key))){M=-1;break}++M}for(let L in o.proxyCachedFBO[E.key])o.renderCache[o.proxyCachedFBO[E.key][L]].dirty=M<0||M!==Object.values(T).length}}let y=[...this._drapedRenderBatches];y.sort((x,E)=>E.end-E.start-(x.end-x.start));for(let x of y)for(let E of h){if(o.proxyCachedFBO[E.key])continue;let T=o.renderCachePool.pop();T===void 0&&o.renderCache.length<50&&(T=o.renderCache.length,o.renderCache.push(this._createFBO())),T!==void 0&&(o.proxyCachedFBO[E.key]={},o.proxyCachedFBO[E.key][x.start]=T,o.renderCache[T].dirty=!0)}this._tilesDirty={}}_setupStencil(t,o,h,g){if(!g||!this._sourceTilesOverlap[g.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let y=this.painter.context,x=y.gl;if(o.length<=1)return void(this._overlapStencilType=!1);let E;if(h.isTileClipped())E=o.length,this._overlapStencilMode.test={func:x.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(o[0].overscaledZ>o[o.length-1].overscaledZ))return void(this._overlapStencilType=!1);E=1,this._overlapStencilMode.test={func:x.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+E>255&&(y.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=E,this._overlapStencilMode.ref=this._stencilRef,h.isTileClipped()&&this._renderTileClippingMasks(o,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):qt.disabled}_renderTileClippingMasks(t,o){let h=this.painter,g=this.painter.context,y=g.gl;h._tileClippingMaskIDs={},g.setColorMode(rn.disabled),g.setDepthMode(Tt.disabled);let x=h.getOrCreateProgram("clippingMask");for(let E of t){let T=h._tileClippingMaskIDs[E.key]=--o;x.draw(h,y.TRIANGLES,Tt.disabled,new qt({func:y.ALWAYS,mask:0},T,255,y.KEEP,y.KEEP,y.REPLACE),rn.disabled,jt.disabled,ac(E.projMatrix),"$clipping",h.tileExtentBuffer,h.quadTriangleIndexBuffer,h.tileExtentSegments)}}pointCoordinate(t){let o=this.painter.transform;if(t.x<0||t.x>o.width||t.y<0||t.y>o.height)return null;let h=[t.x,t.y,1,1];i.aC(h,h,o.pixelMatrixInverse),i.cJ(h,h,1/h[3]),h[0]/=o.worldSize,h[1]/=o.worldSize;let g=o._camera.position,y=i.ce(1,o.center.lat),x=[g[0],g[1],g[2]/y,0],E=i.d9([],h.slice(0,3),x);i.aw(E,E);let T=this.raycast(x,E,this._exaggeration);return T!==null&&T?(i.bG(x,x,E,T),x[3]=x[2],x[2]*=y,x):null}_setupProxiedCoordsForOrtho(t,o,h){if(t.getSource()instanceof i.aT)return this._setupProxiedCoordsForImageSource(t,o,h);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};let g=this.proxiedCoords[t.id]=[],y=this.proxyCoords;for(let T=0;T<y.length;T++){let A=y[T],M=this._findTileCoveringTileID(A,t);if(M){let L=this._createProxiedId(A,M,h[A.key]&&h[A.key][t.id]);g.push(L),this.proxyToSource[A.key][t.id]=[L]}}let x=!1,E=new Set;for(let T=0;T<o.length;T++){let A=t.getTile(o[T]);if(!A||!A.hasData())continue;let M=this._findTileCoveringTileID(A.tileID,this.proxySourceCache);if(M&&M.tileID.canonical.z!==A.tileID.canonical.z){let L=this.proxyToSource[M.tileID.key][t.id],R=this._createProxiedId(M.tileID,A,h[M.tileID.key]&&h[M.tileID.key][t.id]);L?L.splice(L.length-1,0,R):this.proxyToSource[M.tileID.key][t.id]=[R];let F=this.proxyToSource[M.tileID.key][t.id];E.has(F)||E.add(F),g.push(R),x=!0}}if(this._sourceTilesOverlap[t.id]=x,x&&this._debugParams.sortTilesHiZFirst)for(let T of E)T.sort((A,M)=>M.overscaledZ-A.overscaledZ)}_setupProxiedCoordsForImageSource(t,o,h){if(!t.getSource().loaded())return;let g=this.proxiedCoords[t.id]=[],y=this.proxyCoords,x=t.getSource(),E=x.tileID;if(!E)return;let T=new i.P(E.x,E.y)._div(1<<E.z),A=x.coordinates.map(i.ae.fromLngLat).reduce((L,R)=>(L.min.x=Math.min(L.min.x,R.x-T.x),L.min.y=Math.min(L.min.y,R.y-T.y),L.max.x=Math.max(L.max.x,R.x-T.x),L.max.y=Math.max(L.max.y,R.y-T.y),L),{min:new i.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new i.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),M=(L,R)=>{let F=L.wrap+L.canonical.x/(1<<L.canonical.z),z=L.canonical.y/(1<<L.canonical.z),j=i.al/(1<<L.canonical.z),q=R.wrap+R.canonical.x/(1<<R.canonical.z),$=R.canonical.y/(1<<R.canonical.z);return F+j<q+A.min.x||F>q+A.max.x||z+j<$+A.min.y||z>$+A.max.y};for(let L=0;L<y.length;L++){let R=y[L];for(let F=0;F<o.length;F++){let z=t.getTile(o[F]);if(!z||!z.hasData()||M(R,z.tileID))continue;let j=this._createProxiedId(R,z,h[R.key]&&h[R.key][t.id]),q=this.proxyToSource[R.key][t.id];q?q.push(j):this.proxyToSource[R.key][t.id]=[j],g.push(j)}}}_createProxiedId(t,o,h){let g=this.orthoMatrix;if(h){let y=h.find(x=>x.key===o.tileID.key);if(y)return y}if(o.tileID.key!==t.key){let y=t.canonical.z-o.tileID.canonical.z,x,E,T;g=i.bB();let A=o.tileID.wrap-t.wrap<<t.overscaledZ;y>0?(x=i.al>>y,E=x*((o.tileID.canonical.x<<y)-t.canonical.x+A),T=x*((o.tileID.canonical.y<<y)-t.canonical.y)):(x=i.al<<-y,E=i.al*(o.tileID.canonical.x-(t.canonical.x+A<<-y)),T=i.al*(o.tileID.canonical.y-(t.canonical.y<<-y))),i.cd(g,0,x,0,x,0,1),i.bq(g,g,[E,T,0])}return new Zd(o.tileID,t.key,g)}_findTileCoveringTileID(t,o){let h=o.getTile(t);if(h&&h.hasData())return h;let g=this._findCoveringTileCache[o.id],y=g[t.key];if(h=y?o.getTileByID(y):null,h&&h.hasData()||y===null)return h;let x=h?h.tileID:t,E=x.overscaledZ,T=o.getSource().minzoom,A=[];if(!y){let L=o.getSource().maxzoom;if(t.canonical.z>=L){let R=t.canonical.z-L;o.getSource().reparseOverscaled?(E=Math.max(t.canonical.z+2,o.transform.tileZoom),x=new i.aP(E,t.wrap,L,t.canonical.x>>R,t.canonical.y>>R)):R!==0&&(E=L,x=new i.aP(E,t.wrap,L,t.canonical.x>>R,t.canonical.y>>R))}x.key!==t.key&&(A.push(x.key),h=o.getTile(x))}let M=L=>{A.forEach(R=>{g[R]=L}),A.length=0};for(E-=1;E>=T&&(!h||!h.hasData());E--){h&&M(h.tileID.key);let L=x.calculateScaledKey(E);if(h=o.getTileByID(L),h&&h.hasData())break;let R=g[L];if(R===null)break;R===void 0?A.push(L):h=o.getTileByID(R)}return M(h?h.tileID.key:null),h&&h.hasData()?h:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,o){let h=this._tilesDirty[t];h||(h=this._tilesDirty[t]={}),h[o.key]=!0}}function vg(d,t,o){let h=(function(E,T,A){let M=i.bI(T,E),L=i.bI(A,[.2126,.7152,.0722]),R=(z,j,q)=>(1-q)*z+q*j,F=R(1-.3*Math.min(L,1),1,Math.min(M+1,1));return R(.92,1,Math.asin(i.aA(T[2],-1,1))/Math.PI+.5)*F})(d,[0,0,1],t),g=[0,0,0];i.c4(g,o.slice(0,3),h);let y=[0,0,0];i.c4(y,t.slice(0,3),d[2]);let x=[0,0,0];return i.d7(x,g,y),i.da(x)}let xg=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],bg=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Yd{static cacheKey(t,o,h,g){let y=`${o}${g?g.cacheKey:""}`;for(let x of h)t.usedDefines.includes(x)&&(y+=`/${x}`);return y}constructor(t,o,h,g,y,x){let E=t.gl;this.program=E.createProgram(),this.configuration=g,this.name=o,this.fixedDefines=[...x];let T=g?g.defines():[];T=T.concat(x.map(z=>`#define ${z}`));let A=`#version 300 es
`,M=A+T.concat("precision mediump float;",fa,$d.fragmentSource).join(`
`);for(let z of h.fragmentIncludes)M+=`
${ru[z]}`;M+=`
${h.fragmentSource}`;let L=A+T.concat("precision highp float;",fa,$d.vertexSource).join(`
`);for(let z of h.vertexIncludes)L+=`
${ru[z]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&h.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(L+=`
uniform int u_instanceID;
`),L+=`
${h.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(L=L.replaceAll("gl_InstanceID","u_instanceID"));let R=E.createShader(E.FRAGMENT_SHADER);if(E.isContextLost())return void(this.failedToCreate=!0);E.shaderSource(R,M),E.compileShader(R),E.attachShader(this.program,R);let F=E.createShader(E.VERTEX_SHADER);E.isContextLost()?this.failedToCreate=!0:(E.shaderSource(F,L),E.compileShader(F),E.attachShader(this.program,F),this.attributes={},E.linkProgram(this.program),E.deleteShader(F),E.deleteShader(R),this.fixedUniforms=y(t),this.binderUniforms=g?g.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(z=>({u_instanceID:new i.cg(z)}))(t)),(x.includes("TERRAIN")||o.indexOf("symbol")!==-1||o.indexOf("circle")!==-1)&&(this.terrainUniforms=(z=>({u_dem:new i.cg(z),u_dem_prev:new i.cg(z),u_dem_tl:new i.cj(z),u_dem_scale:new i.ci(z),u_dem_tl_prev:new i.cj(z),u_dem_scale_prev:new i.ci(z),u_dem_size:new i.ci(z),u_dem_lerp:new i.ci(z),u_exaggeration:new i.ci(z),u_depth:new i.cg(z),u_depth_size_inv:new i.cj(z),u_depth_range_unpack:new i.cj(z),u_occluder_half_size:new i.ci(z),u_occlusion_depth_offset:new i.ci(z),u_meter_to_dem:new i.ci(z),u_label_plane_matrix_inv:new i.ck(z)}))(t)),x.includes("GLOBE")&&(this.globeUniforms=(z=>({u_tile_tl_up:new i.ch(z),u_tile_tr_up:new i.ch(z),u_tile_br_up:new i.ch(z),u_tile_bl_up:new i.ch(z),u_tile_up_scale:new i.ci(z)}))(t)),x.includes("FOG")&&(this.fogUniforms=(z=>({u_fog_matrix:new i.ck(z),u_fog_range:new i.cj(z),u_fog_color:new i.d2(z),u_fog_horizon_blend:new i.ci(z),u_fog_vertical_limit:new i.cj(z),u_fog_temporal_offset:new i.ci(z),u_frustum_tl:new i.ch(z),u_frustum_tr:new i.ch(z),u_frustum_br:new i.ch(z),u_frustum_bl:new i.ch(z),u_globe_pos:new i.ch(z),u_globe_radius:new i.ci(z),u_globe_transition:new i.ci(z),u_is_globe:new i.cg(z),u_viewport:new i.cj(z)}))(t)),x.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(z=>({u_cutoff_params:new i.d2(z)}))(t)),x.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(z=>({u_lighting_ambient_color:new i.ch(z),u_lighting_directional_dir:new i.ch(z),u_lighting_directional_color:new i.ch(z),u_ground_radiance:new i.ch(z)}))(t)),x.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(z=>({u_light_matrix_0:new i.ck(z),u_light_matrix_1:new i.ck(z),u_fade_range:new i.cj(z),u_shadow_normal_offset:new i.ch(z),u_shadow_intensity:new i.ci(z),u_shadow_texel_size:new i.ci(z),u_shadow_map_resolution:new i.ci(z),u_shadow_direction:new i.ch(z),u_shadow_bias:new i.ch(z),u_shadowmap_0:new i.cg(z),u_shadowmap_1:new i.cg(z)}))(t)))}getAttributeLocation(t,o){let h=this.attributes[o];return h===void 0&&(h=this.attributes[o]=t.getAttribLocation(this.program,o)),h}setTerrainUniformValues(t,o){if(!this.terrainUniforms)return;let h=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g]&&h[g].set(this.program,g,o[g])}}setGlobeUniformValues(t,o){if(!this.globeUniforms)return;let h=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g]&&h[g].set(this.program,g,o[g])}}setFogUniformValues(t,o){if(!this.fogUniforms)return;let h=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setCutoffUniformValues(t,o){if(!this.cutoffUniforms)return;let h=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setLightsUniformValues(t,o){if(!this.lightsUniforms)return;let h=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}}setShadowUniformValues(t,o){if(this.failedToCreate||!this.shadowUniforms)return;let h=this.shadowUniforms;t.program.set(this.program);for(let g in o)h[g].set(this.program,g,o[g])}_drawDebugWireframe(t,o,h,g,y,x,E,T,A,M){let L=t.options.wireframe;if(L.terrain===!1&&L.layers2D===!1&&L.layers3D===!1)return;let R=t.context;if(!(!(!L.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!L.layers2D||t._terrain&&t._terrain.renderingToTexture||!xg.includes(this.name))||!(!L.layers3D||!bg.includes(this.name))))return;let F=R.gl,z=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,y,R);if(!z)return;let j=[...this.fixedDefines];j.push("DEBUG_WIREFRAME");let q=t.getOrCreateProgram(this.name,{config:this.configuration,defines:j});R.program.set(q.program);let $=(Y,ae,Q)=>{if(ae[Y]&&Q[Y])for(let ce in ae[Y])Q[Y][ce]&&Q[Y][ce].set(Q.program,ce,ae[Y][ce].current)};A&&A.setUniforms(q.program,R,q.binderUniforms,E,{zoom:T}),$("fixedUniforms",this,q),$("terrainUniforms",this,q),$("globeUniforms",this,q),$("fogUniforms",this,q),$("lightsUniforms",this,q),$("shadowUniforms",this,q),z.bind(),R.setColorMode(new rn([F.ONE,F.ONE_MINUS_SRC_ALPHA,F.ZERO,F.ONE],i.ao.transparent,[!0,!0,!0,!1])),R.setDepthMode(new Tt(o.func===F.LESS?F.LEQUAL:o.func,Tt.ReadOnly,o.range)),R.setStencilMode(qt.disabled);let Z=3*x.primitiveLength*2,J=3*x.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){let Y=M||1;for(let ae=0;ae<Y;++ae)q.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ae),F.drawElements(F.LINES,Z,F.UNSIGNED_SHORT,J)}else M&&M>1?F.drawElementsInstanced(F.LINES,Z,F.UNSIGNED_SHORT,J,M):F.drawElements(F.LINES,Z,F.UNSIGNED_SHORT,J);y.bind(),R.program.set(this.program),R.setDepthMode(o),R.setStencilMode(h),R.setColorMode(g)}checkUniforms(t,o,h){if(this.fixedDefines.includes(o)){for(let g of Object.keys(h))if(!h[g].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${g} not set but required by ${o} being defined`)}}draw(t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q){let $=t.context,Z=$.gl;if(this.failedToCreate)return;$.program.set(this.program),$.setDepthMode(h),$.setStencilMode(g),$.setColorMode(y),$.setCullFace(x);for(let ae of Object.keys(this.fixedUniforms))this.fixedUniforms[ae].set(this.program,ae,E[ae]);z&&z.setUniforms(this.program,$,this.binderUniforms,R,{zoom:F});let J={[Z.POINTS]:1,[Z.LINES]:2,[Z.TRIANGLES]:3,[Z.LINE_STRIP]:1}[o];this.checkUniforms(T,"RENDER_SHADOWS",this.shadowUniforms);let Y=q&&q>0?1:void 0;for(let ae of L.get()){let Q=ae.vaos||(ae.vaos={});if((Q[T]||(Q[T]=new ou)).bind($,this,A,z?z.getPaintVertexBuffers():[],M,ae.vertexOffset,j||[],Y),this.forceManualRenderingForInstanceIDShaders){let ce=q||1;for(let se=0;se<ce;++se)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",se),M?Z.drawElements(o,ae.primitiveLength*J,Z.UNSIGNED_SHORT,ae.primitiveOffset*J*2):Z.drawArrays(o,ae.vertexOffset,ae.vertexLength)}else q&&q>1?Z.drawElementsInstanced(o,ae.primitiveLength*J,Z.UNSIGNED_SHORT,ae.primitiveOffset*J*2,q):M?Z.drawElements(o,ae.primitiveLength*J,Z.UNSIGNED_SHORT,ae.primitiveOffset*J*2):Z.drawArrays(o,ae.vertexOffset,ae.vertexLength);o===Z.TRIANGLES&&M&&this._drawDebugWireframe(t,h,g,y,M,ae,R,F,z,q)}}}function Of(d,t,o=0){let h=Math.pow(2,t.tileID.overscaledZ),g=t.tileSize*Math.pow(2,d.transform.tileZoom)/h,y=g*(t.tileID.canonical.x+t.tileID.wrap*h),x=g*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/i.ay(t,1,d.transform.tileZoom),u_pixel_coord_upper:[y>>16,x>>16],u_pixel_coord_lower:[65535&y,65535&x],u_pattern_transition:o}}let uu={terrain:0,flat:1},Lf=i.bB(),Ff=(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$)=>{let Z=t.style.light,J=Z.properties.get("position"),Y=[J.x,J.y,J.z],ae=i.dN();Z.properties.get("anchor")==="viewport"&&(i.dO(ae,-t.transform.angle),i.dP(Y,Y,ae));let Q=Z.properties.get("color").toPremultipliedRenderColor(null),ce=t.transform,se={u_matrix:d,u_lightpos:Y,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[Q.r,Q.g,Q.b],u_vertical_gradient:+o,u_opacity:h,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Lf,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:uu[A],u_base_type:uu[M],u_ao:g,u_edge_radius:y,u_width_scale:x,u_flood_light_color:z,u_vertical_scale:j,u_flood_light_intensity:q,u_ground_shadow_factor:$};return ce.projection.name==="globe"&&(se.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],se.u_zoom_transition=L,se.u_inv_rot_matrix=F,se.u_merc_center=R,se.u_up_dir=ce.projection.upVector(new i.cC(0,0,0),R[0]*i.al,R[1]*i.al),se.u_height_lift=T),se},jv=(d,t,o,h,g,y)=>({u_matrix:d,u_edge_radius:t,u_width_scale:o,u_vertical_scale:h,u_height_type:uu[g],u_base_type:uu[y]}),Uv=(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$)=>{let Z=Ff(d,t,o,h,g,y,x,E,A,M,L,R,F,z,j,q,1,[0,0,0]),J={u_height_factor:-Math.pow(2,E.overscaledZ)/T.tileSize/8};return Object.assign(Z,Of(t,T,$),J)},du=(d,t,o,h,g,y,x,E,T,A,M)=>({u_matrix:t,u_opacity:o,u_ao_pass:h?1:0,u_meter_to_tile:g,u_ao:y,u_flood_light_intensity:x,u_flood_light_color:E,u_attenuation:T,u_edge_radius:A,u_fb:0,u_fb_size:M,u_dynamic_offset:1}),Hv=(d,t,o)=>({u_matrix:d,u_emissive_strength:t,u_ground_shadow_factor:o}),$v=(d,t,o,h,g,y=0)=>Object.assign(Hv(d,t,g),Of(o,h,y)),H1=(d,t,o,h)=>({u_matrix:d,u_world:o,u_emissive_strength:t,u_ground_shadow_factor:h}),$1=(d,t,o,h,g,y,x=0)=>Object.assign($v(d,t,o,h,y,x),{u_world:g}),G1=(d,t)=>({u_matrix:d,u_ground_shadow_factor:t}),kf=(d,t,o,h,g)=>({u_matrix:d,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:o,u_height_scale:h,u_reset_depth:g}),wg=(d,t,o,h,g,y,x,E,T)=>({u_matrix:d,u_normal_matrix:t,u_opacity:o,u_faux_facade_ao_intensity:h,u_camera_pos:g,u_tile_to_meter:y,u_facade_emissive_chance:x,u_flood_light_color:E,u_flood_light_intensity:T}),Eg=d=>({u_matrix:d}),Gv=d=>({u_matrix:d}),hu=(d,t,o,h,g,y,x,E)=>{let T=i.al/y.tileSize;return{u_matrix:d,u_inv_rot_matrix:t,u_camera_to_center_distance:o.getCameraToCenterDistance(E),u_extrude_scale:[o.pixelsToGLUnits[0]/T,o.pixelsToGLUnits[1]/T],u_zoom_transition:h,u_tile_id:x,u_merc_center:g}},Tg=(d,t,o=1)=>({u_matrix:d,u_color:t,u_overlay:0,u_overlay_scale:o}),qv=i.bB(),Wv=(d,t,o,h,g,y,x)=>{let E=d.transform,T=E.projection.name==="globe",A=T?i.dQ(E.zoom,t.canonical)*E._pixelsPerMercatorPixel:i.ay(o,1,y),M={u_matrix:t.projMatrix,u_extrude_scale:A,u_intensity:x,u_inv_rot_matrix:qv,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(T){M.u_inv_rot_matrix=h,M.u_merc_center=g,M.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],M.u_zoom_transition=i.aj(E.zoom);let L=g[0]*i.al,R=g[1]*i.al;M.u_up_dir=E.projection.upVector(new i.cC(0,0,0),L,R)}return M};function Nf(d,[t,o,h,g],[y,x]){if(y===x)return[0,0,0,0];let E=255*(d-1)/(d*(x-y));return[t*E,o*E,h*E,g*E]}function ka(d,t,[o,h]){return o===h?0:.5/d+(t-o)*(d-1)/(d*(h-o))}let Kd=(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$,Z,J,Y)=>({u_matrix:d,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:g,u_tl_parent:y,u_scale_parent:A,u_fade_t:M.mix,u_opacity:M.opacity*L.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:L.paint.get("raster-brightness-min"),u_brightness_high:L.paint.get("raster-brightness-max"),u_saturation_factor:i.dS(L.paint.get("raster-saturation")),u_contrast_factor:i.dR(L.paint.get("raster-contrast")),u_spin_weights:zf(L.paint.get("raster-hue-rotate")),u_perspective_transform:R,u_raster_elevation:F,u_zoom_transition:x,u_merc_center:E,u_cutoff_params:T,u_colorization_mix:Nf(i.dT,j,$),u_colorization_offset:ka(i.dT,q,$),u_color_ramp:z,u_texture_offset:[J/(Z+2*J),Z/(Z+2*J)],u_texture_res:[Z+2*J,Z+2*J],u_emissive_strength:Y});function zf(d){d*=Math.PI/180;let t=Math.sin(d),o=Math.cos(d);return[(2*o+1)/3,(-Math.sqrt(3)*t-o+1)/3,(Math.sqrt(3)*t-o+1)/3]}let lc=.05,ml=(d,t,o,h,g,y,x,E,T,A,M,L)=>({u_matrix:d,u_normalize_matrix:t,u_globe_matrix:o,u_merc_matrix:h,u_grid_matrix:g,u_tl_parent:y,u_scale_parent:A,u_fade_t:M.mix,u_opacity:M.opacity,u_image0:0,u_image1:1,u_raster_elevation:L,u_zoom_transition:x,u_merc_center:E,u_cutoff_params:T}),Ig=(d,t,o,h,g,y,x,E,T,A)=>({u_particle_texture:d,u_particle_texture_side_len:t,u_tile_offset:o,u_velocity:h,u_color_ramp:y,u_velocity_res:g,u_max_speed:x,u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:A,u_particle_pos_scale:1.1,u_particle_pos_offset:[lc,lc]}),Bf=(d,t,o,h,g,y,x,E,T,A)=>({u_particle_texture:d,u_particle_texture_side_len:t,u_velocity:o,u_velocity_res:h,u_max_speed:g,u_speed_factor:y,u_reset_rate:x,u_rand_seed:Math.random(),u_uv_offset:E,u_data_scale:[255*T[0],255*T[1]],u_data_offset:A,u_particle_pos_scale:1.1,u_particle_pos_offset:[lc,lc]}),Sg=i.bB(),Dg=(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$,Z,J,Y,ae,Q,ce)=>{let se=g.transform,ie={u_is_size_zoom_constant:+(d==="constant"||d==="source"),u_is_size_feature_constant:+(d==="constant"||d==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:se.getCameraToCenterDistance(Z),u_rotate_symbol:+o,u_aspect_ratio:se.width/se.height,u_fade_change:g.options.fadeDuration?g.symbolFadeChange:1,u_matrix:y,u_label_plane_matrix:x,u_coord_matrix:E,u_is_text:+A,u_elevation_from_sea:T?1:0,u_pitch_with_map:+h,u_texsize:M,u_texsize_icon:L,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Sg,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Sg,u_up_vector:[0,-1,0],u_color_adj_mat:ae,u_icon_transition:Q||0,u_gamma_scale:h?g.transform.getCameraToCenterDistance(Z)*Math.cos(g.terrain?0:g.transform._pitch):1,u_device_pixel_ratio:i.o.devicePixelRatio,u_is_halo:1,u_scale_factor:ce||1,u_ground_shadow_factor:J,u_inv_matrix:i.bk(i.bB(),x),u_normal_scale:Y,u_lutTexture:Fr.LUT};return Z.name==="globe"&&(ie.u_tile_id=[F.canonical.x,F.canonical.y,1<<F.canonical.z],ie.u_zoom_transition=z,ie.u_inv_rot_matrix=q,ie.u_merc_center=j,ie.u_camera_forward=se._camera.forward(),ie.u_ecef_origin=i.dU(se.globeMatrix,F.toUnwrapped()),ie.u_tile_matrix=Float32Array.from(se.globeMatrix),ie.u_up_vector=$),ie},Vf=(d,t,o,h)=>({u_matrix:d,u_emissive_strength:t,u_opacity:o,u_color:h}),jf=(d,t,o,h,g,y,x,E,T)=>Object.assign((function(A,M,L,R,F,z){let{width:j,height:q}=R.imageManager.getPixelSize(M),$=Math.pow(2,z.tileID.overscaledZ),Z=z.tileSize*Math.pow(2,R.transform.tileZoom)/$,J=Z*(z.tileID.canonical.x+z.tileID.wrap*$),Y=Z*z.tileID.canonical.y;return{u_image:0,u_pattern_tl:L.tl,u_pattern_br:L.br,u_texsize:[j,q],u_pattern_size:L.displaySize,u_pattern_units_to_pixels:F?[R.transform.width,-1*R.transform.height]:[1/i.ay(z,1,R.transform.tileZoom),1/i.ay(z,1,R.transform.tileZoom)],u_pixel_coord_upper:[J>>16,Y>>16],u_pixel_coord_lower:[65535&J,65535&Y]}})(0,y,x,h,E,T),{u_matrix:d,u_emissive_strength:t,u_opacity:o}),Cg=new Float32Array(i.bz([])),Uf=(d,t,o,h,g,y,x,E,T,A,M,L,R,F=[0,0,0],z,j,q)=>{let $=g.style.light,Z=$.properties.get("position"),J=[-Z.x,-Z.y,Z.z],Y=i.dN();$.properties.get("anchor")==="viewport"&&(i.dO(Y,-g.transform.angle),i.dP(J,J,Y));let ae=M.alphaMode==="MASK",Q=$.properties.get("color").toNonPremultipliedRenderColor(null),ce=R.paint.get("model-ambient-occlusion-intensity"),se=R.paint.get("model-color").constantOr(i.ao.white).toNonPremultipliedRenderColor(null);return se.a=R.paint.get("model-color-mix-intensity").constantOr(0),q&&(se.r=q[0],se.g=q[1],se.b=q[2],se.a=q[3]),j&&(se.r=j.color.r,se.g=j.color.g,se.b=j.color.b,se.a=j.colorMix,L=j.emissionStrength,y=j.opacity),{u_matrix:d,u_lighting_matrix:t,u_normal_matrix:o,u_node_matrix:h||Cg,u_lightpos:J,u_lightintensity:$.properties.get("intensity"),u_lightcolor:[Q.r,Q.g,Q.b],u_camera_pos:F,u_opacity:y,u_baseTextureIsAlpha:0,u_alphaMask:+ae,u_alphaCutoff:M.alphaCutoff,u_baseColorFactor:x.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:E.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:T,u_roughnessFactor:A,u_baseColorTexture:Fr.BaseColor,u_metallicRoughnessTexture:Fr.MetallicRoughness,u_normalTexture:Fr.Normal,u_occlusionTexture:Fr.Occlusion,u_emissionTexture:Fr.Emission,u_lutTexture:Fr.LUT,u_color_mix:se.toArray01(),u_aoIntensity:ce,u_emissive_strength:L,u_occlusionTextureTransform:z||[0,0,0,0]}},fu=(d,t=Cg,o=Cg)=>({u_matrix:d,u_instance:t,u_node_matrix:o}),q1={fillExtrusion:d=>({u_matrix:new i.ck(d),u_lightpos:new i.ch(d),u_lightintensity:new i.ci(d),u_lightcolor:new i.ch(d),u_vertical_gradient:new i.ci(d),u_opacity:new i.ci(d),u_edge_radius:new i.ci(d),u_width_scale:new i.ci(d),u_ao:new i.cj(d),u_height_type:new i.cg(d),u_base_type:new i.cg(d),u_tile_id:new i.ch(d),u_zoom_transition:new i.ci(d),u_inv_rot_matrix:new i.ck(d),u_merc_center:new i.cj(d),u_up_dir:new i.ch(d),u_height_lift:new i.ci(d),u_flood_light_color:new i.ch(d),u_vertical_scale:new i.ci(d),u_flood_light_intensity:new i.ci(d),u_ground_shadow_factor:new i.ch(d)}),fillExtrusionDepth:d=>({u_matrix:new i.ck(d),u_edge_radius:new i.ci(d),u_width_scale:new i.ci(d),u_vertical_scale:new i.ci(d),u_height_type:new i.cg(d),u_base_type:new i.cg(d)}),fillExtrusionPattern:d=>({u_matrix:new i.ck(d),u_lightpos:new i.ch(d),u_lightintensity:new i.ci(d),u_lightcolor:new i.ch(d),u_vertical_gradient:new i.ci(d),u_height_factor:new i.ci(d),u_edge_radius:new i.ci(d),u_width_scale:new i.ci(d),u_ao:new i.cj(d),u_height_type:new i.cg(d),u_base_type:new i.cg(d),u_tile_id:new i.ch(d),u_zoom_transition:new i.ci(d),u_inv_rot_matrix:new i.ck(d),u_merc_center:new i.cj(d),u_up_dir:new i.ch(d),u_height_lift:new i.ci(d),u_image:new i.cg(d),u_texsize:new i.cj(d),u_pixel_coord_upper:new i.cj(d),u_pixel_coord_lower:new i.cj(d),u_tile_units_to_pixels:new i.ci(d),u_opacity:new i.ci(d),u_pattern_transition:new i.ci(d)}),fillExtrusionGroundEffect:d=>({u_matrix:new i.ck(d),u_opacity:new i.ci(d),u_ao_pass:new i.ci(d),u_meter_to_tile:new i.ci(d),u_ao:new i.cj(d),u_flood_light_intensity:new i.ci(d),u_flood_light_color:new i.ch(d),u_attenuation:new i.ci(d),u_edge_radius:new i.ci(d),u_fb:new i.cg(d),u_fb_size:new i.ci(d),u_dynamic_offset:new i.ci(d)}),fill:d=>({u_matrix:new i.ck(d),u_emissive_strength:new i.ci(d),u_ground_shadow_factor:new i.ch(d)}),fillPattern:d=>({u_matrix:new i.ck(d),u_emissive_strength:new i.ci(d),u_image:new i.cg(d),u_texsize:new i.cj(d),u_pixel_coord_upper:new i.cj(d),u_pixel_coord_lower:new i.cj(d),u_tile_units_to_pixels:new i.ci(d),u_ground_shadow_factor:new i.ch(d),u_pattern_transition:new i.ci(d)}),fillOutline:d=>({u_matrix:new i.ck(d),u_emissive_strength:new i.ci(d),u_world:new i.cj(d),u_ground_shadow_factor:new i.ch(d)}),fillOutlinePattern:d=>({u_matrix:new i.ck(d),u_emissive_strength:new i.ci(d),u_world:new i.cj(d),u_image:new i.cg(d),u_texsize:new i.cj(d),u_pixel_coord_upper:new i.cj(d),u_pixel_coord_lower:new i.cj(d),u_tile_units_to_pixels:new i.ci(d),u_ground_shadow_factor:new i.ch(d),u_pattern_transition:new i.ci(d)}),building:d=>({u_matrix:new i.ck(d),u_normal_matrix:new i.ck(d),u_opacity:new i.ci(d),u_faux_facade_ao_intensity:new i.ci(d),u_camera_pos:new i.ch(d),u_tile_to_meter:new i.ci(d),u_facade_emissive_chance:new i.ci(d),u_flood_light_color:new i.ch(d),u_flood_light_intensity:new i.ci(d)}),buildingBloom:d=>({u_matrix:new i.ck(d)}),buildingDepth:d=>({u_matrix:new i.ck(d)}),elevatedStructuresDepth:d=>({u_matrix:new i.ck(d),u_depth_bias:new i.ci(d)}),elevatedStructures:d=>({u_matrix:new i.ck(d),u_ground_shadow_factor:new i.ch(d)}),elevatedStructuresDepthReconstruct:d=>({u_matrix:new i.ck(d),u_camera_pos:new i.ch(d),u_depth_bias:new i.ci(d),u_height_scale:new i.ci(d),u_reset_depth:new i.ci(d)}),circle:i.dX,collisionBox:d=>({u_matrix:new i.ck(d),u_inv_rot_matrix:new i.ck(d),u_camera_to_center_distance:new i.ci(d),u_extrude_scale:new i.cj(d),u_zoom_transition:new i.ci(d),u_merc_center:new i.cj(d),u_tile_id:new i.ch(d)}),collisionCircle:d=>({u_matrix:new i.ck(d),u_inv_matrix:new i.ck(d),u_camera_to_center_distance:new i.ci(d),u_viewport_size:new i.cj(d)}),debug:d=>({u_color:new i.dA(d),u_matrix:new i.ck(d),u_overlay:new i.cg(d),u_overlay_scale:new i.ci(d)}),clippingMask:d=>({u_matrix:new i.ck(d)}),heatmap:d=>({u_extrude_scale:new i.ci(d),u_intensity:new i.ci(d),u_matrix:new i.ck(d),u_inv_rot_matrix:new i.ck(d),u_merc_center:new i.cj(d),u_tile_id:new i.ch(d),u_zoom_transition:new i.ci(d),u_up_dir:new i.ch(d)}),heatmapTexture:d=>({u_image:new i.cg(d),u_color_ramp:new i.cg(d),u_opacity:new i.ci(d)}),hillshade:d=>({u_matrix:new i.ck(d),u_image:new i.cg(d),u_latrange:new i.cj(d),u_light:new i.cj(d),u_shadow:new i.dA(d),u_highlight:new i.dA(d),u_emissive_strength:new i.ci(d),u_accent:new i.dA(d)}),hillshadePrepare:d=>({u_matrix:new i.ck(d),u_image:new i.cg(d),u_dimension:new i.cj(d),u_zoom:new i.ci(d)}),line:i.dW,linePattern:i.dV,raster:d=>({u_matrix:new i.ck(d),u_normalize_matrix:new i.ck(d),u_globe_matrix:new i.ck(d),u_merc_matrix:new i.ck(d),u_grid_matrix:new i.dB(d),u_tl_parent:new i.cj(d),u_scale_parent:new i.ci(d),u_fade_t:new i.ci(d),u_opacity:new i.ci(d),u_image0:new i.cg(d),u_image1:new i.cg(d),u_brightness_low:new i.ci(d),u_brightness_high:new i.ci(d),u_saturation_factor:new i.ci(d),u_contrast_factor:new i.ci(d),u_spin_weights:new i.ch(d),u_perspective_transform:new i.cj(d),u_raster_elevation:new i.ci(d),u_zoom_transition:new i.ci(d),u_merc_center:new i.cj(d),u_cutoff_params:new i.d2(d),u_colorization_mix:new i.d2(d),u_colorization_offset:new i.ci(d),u_color_ramp:new i.cg(d),u_texture_offset:new i.cj(d),u_texture_res:new i.cj(d),u_emissive_strength:new i.ci(d)}),rasterParticle:d=>({u_matrix:new i.ck(d),u_normalize_matrix:new i.ck(d),u_globe_matrix:new i.ck(d),u_merc_matrix:new i.ck(d),u_grid_matrix:new i.dB(d),u_tl_parent:new i.cj(d),u_scale_parent:new i.ci(d),u_fade_t:new i.ci(d),u_opacity:new i.ci(d),u_image0:new i.cg(d),u_image1:new i.cg(d),u_raster_elevation:new i.ci(d),u_zoom_transition:new i.ci(d),u_merc_center:new i.cj(d),u_cutoff_params:new i.d2(d)}),rasterParticleTexture:d=>({u_texture:new i.cg(d),u_opacity:new i.ci(d)}),rasterParticleDraw:d=>({u_particle_texture:new i.cg(d),u_particle_texture_side_len:new i.ci(d),u_tile_offset:new i.cj(d),u_velocity:new i.cg(d),u_color_ramp:new i.cg(d),u_velocity_res:new i.cj(d),u_max_speed:new i.ci(d),u_uv_offset:new i.cj(d),u_data_scale:new i.cj(d),u_data_offset:new i.ci(d),u_particle_pos_scale:new i.ci(d),u_particle_pos_offset:new i.cj(d)}),rasterParticleUpdate:d=>({u_particle_texture:new i.cg(d),u_particle_texture_side_len:new i.ci(d),u_velocity:new i.cg(d),u_velocity_res:new i.cj(d),u_max_speed:new i.ci(d),u_speed_factor:new i.ci(d),u_reset_rate:new i.ci(d),u_rand_seed:new i.ci(d),u_uv_offset:new i.cj(d),u_data_scale:new i.cj(d),u_data_offset:new i.ci(d),u_particle_pos_scale:new i.ci(d),u_particle_pos_offset:new i.cj(d)}),symbol:d=>({u_is_size_zoom_constant:new i.cg(d),u_is_size_feature_constant:new i.cg(d),u_size_t:new i.ci(d),u_size:new i.ci(d),u_camera_to_center_distance:new i.ci(d),u_rotate_symbol:new i.cg(d),u_aspect_ratio:new i.ci(d),u_fade_change:new i.ci(d),u_matrix:new i.ck(d),u_label_plane_matrix:new i.ck(d),u_coord_matrix:new i.ck(d),u_is_text:new i.cg(d),u_elevation_from_sea:new i.cg(d),u_pitch_with_map:new i.cg(d),u_texsize:new i.cj(d),u_texsize_icon:new i.cj(d),u_texture:new i.cg(d),u_texture_icon:new i.cg(d),u_gamma_scale:new i.ci(d),u_device_pixel_ratio:new i.ci(d),u_tile_id:new i.ch(d),u_zoom_transition:new i.ci(d),u_inv_rot_matrix:new i.ck(d),u_merc_center:new i.cj(d),u_camera_forward:new i.ch(d),u_tile_matrix:new i.ck(d),u_up_vector:new i.ch(d),u_ecef_origin:new i.ch(d),u_is_halo:new i.cg(d),u_icon_transition:new i.ci(d),u_color_adj_mat:new i.ck(d),u_scale_factor:new i.ci(d),u_ground_shadow_factor:new i.ch(d),u_inv_matrix:new i.ck(d),u_normal_scale:new i.ci(d),u_lutTexture:new i.cg(d)}),background:d=>({u_matrix:new i.ck(d),u_emissive_strength:new i.ci(d),u_opacity:new i.ci(d),u_color:new i.dA(d)}),backgroundPattern:d=>({u_matrix:new i.ck(d),u_emissive_strength:new i.ci(d),u_opacity:new i.ci(d),u_image:new i.cg(d),u_pattern_tl:new i.cj(d),u_pattern_br:new i.cj(d),u_texsize:new i.cj(d),u_pattern_size:new i.cj(d),u_pixel_coord_upper:new i.cj(d),u_pixel_coord_lower:new i.cj(d),u_pattern_units_to_pixels:new i.cj(d)}),terrainRaster:d=>({u_matrix:new i.ck(d),u_image0:new i.cg(d),u_skirt_height:new i.ci(d),u_ground_shadow_factor:new i.ch(d)}),skybox:d=>({u_matrix:new i.ck(d),u_sun_direction:new i.ch(d),u_cubemap:new i.cg(d),u_opacity:new i.ci(d),u_temporal_offset:new i.ci(d)}),skyboxGradient:d=>({u_matrix:new i.ck(d),u_color_ramp:new i.cg(d),u_center_direction:new i.ch(d),u_radius:new i.ci(d),u_opacity:new i.ci(d),u_temporal_offset:new i.ci(d)}),skyboxCapture:d=>({u_matrix_3f:new i.dB(d),u_sun_direction:new i.ch(d),u_sun_intensity:new i.ci(d),u_color_tint_r:new i.d2(d),u_color_tint_m:new i.d2(d),u_luminance:new i.ci(d)}),globeRaster:d=>({u_proj_matrix:new i.ck(d),u_globe_matrix:new i.ck(d),u_normalize_matrix:new i.ck(d),u_merc_matrix:new i.ck(d),u_zoom_transition:new i.ci(d),u_merc_center:new i.cj(d),u_image0:new i.cg(d),u_grid_matrix:new i.dB(d),u_skirt_height:new i.ci(d),u_far_z_cutoff:new i.ci(d),u_frustum_tl:new i.ch(d),u_frustum_tr:new i.ch(d),u_frustum_br:new i.ch(d),u_frustum_bl:new i.ch(d),u_globe_pos:new i.ch(d),u_globe_radius:new i.ci(d),u_viewport:new i.cj(d)}),globeAtmosphere:d=>({u_frustum_tl:new i.ch(d),u_frustum_tr:new i.ch(d),u_frustum_br:new i.ch(d),u_frustum_bl:new i.ch(d),u_horizon:new i.ci(d),u_transition:new i.ci(d),u_fadeout_range:new i.ci(d),u_atmosphere_fog_color:new i.d2(d),u_high_color:new i.d2(d),u_space_color:new i.d2(d),u_temporal_offset:new i.ci(d),u_horizon_angle:new i.ci(d)}),model:d=>({u_matrix:new i.ck(d),u_lighting_matrix:new i.ck(d),u_normal_matrix:new i.ck(d),u_node_matrix:new i.ck(d),u_lightpos:new i.ch(d),u_lightintensity:new i.ci(d),u_lightcolor:new i.ch(d),u_camera_pos:new i.ch(d),u_opacity:new i.ci(d),u_baseColorFactor:new i.d2(d),u_emissiveFactor:new i.d2(d),u_metallicFactor:new i.ci(d),u_roughnessFactor:new i.ci(d),u_baseTextureIsAlpha:new i.cg(d),u_alphaMask:new i.cg(d),u_alphaCutoff:new i.ci(d),u_baseColorTexture:new i.cg(d),u_metallicRoughnessTexture:new i.cg(d),u_normalTexture:new i.cg(d),u_occlusionTexture:new i.cg(d),u_emissionTexture:new i.cg(d),u_lutTexture:new i.cg(d),u_color_mix:new i.d2(d),u_aoIntensity:new i.ci(d),u_emissive_strength:new i.ci(d),u_occlusionTextureTransform:new i.d2(d)}),modelDepth:d=>({u_matrix:new i.ck(d),u_instance:new i.ck(d),u_node_matrix:new i.ck(d)}),groundShadow:d=>({u_matrix:new i.ck(d),u_ground_shadow_factor:new i.ch(d)}),stars:d=>({u_matrix:new i.ck(d),u_up:new i.ch(d),u_right:new i.ch(d),u_intensity_multiplier:new i.ci(d)}),snowParticle:d=>({u_modelview:new i.ck(d),u_projection:new i.ck(d),u_time:new i.ci(d),u_cam_pos:new i.ch(d),u_velocityConeAperture:new i.ci(d),u_velocity:new i.ci(d),u_horizontalOscillationRadius:new i.ci(d),u_horizontalOscillationRate:new i.ci(d),u_boxSize:new i.ci(d),u_billboardSize:new i.ci(d),u_simpleShapeParameters:new i.cj(d),u_screenSize:new i.cj(d),u_thinningCenterPos:new i.cj(d),u_thinningShape:new i.ch(d),u_thinningAffectedRatio:new i.ci(d),u_thinningParticleOffset:new i.ci(d),u_particleColor:new i.d2(d),u_direction:new i.ch(d)}),rainParticle:d=>({u_modelview:new i.ck(d),u_projection:new i.ck(d),u_time:new i.ci(d),u_cam_pos:new i.ch(d),u_texScreen:new i.cg(d),u_velocityConeAperture:new i.ci(d),u_velocity:new i.ci(d),u_boxSize:new i.ci(d),u_rainDropletSize:new i.cj(d),u_distortionStrength:new i.ci(d),u_rainDirection:new i.ch(d),u_color:new i.d2(d),u_screenSize:new i.cj(d),u_thinningCenterPos:new i.cj(d),u_thinningShape:new i.ch(d),u_thinningAffectedRatio:new i.ci(d),u_thinningParticleOffset:new i.ci(d),u_shapeDirectionalPower:new i.ci(d),u_shapeNormalPower:new i.ci(d),u_mode:new i.ci(d)}),vignette:d=>({u_vignetteShape:new i.ch(d),u_vignetteColor:new i.d2(d)}),occlusion:d=>({u_matrix:new i.ck(d),u_anchorPos:new i.ch(d),u_screenSizePx:new i.cj(d),u_occluderSizePx:new i.cj(d),u_color:new i.d2(d)})},Zv=(()=>{class d{constructor(o,h,g,y){this.id=d.uniqueIdxCounter,d.uniqueIdxCounter++,this.context=o;let x=o.gl;this.buffer=x.createBuffer(),this.dynamicDraw=!!g,this.context.unbindVAO(),o.bindElementBuffer.set(this.buffer),x.bufferData(x.ELEMENT_ARRAY_BUFFER,h.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||y||h.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(o){this.id=d.uniqueIdxCounter,d.uniqueIdxCounter++;let h=this.context.gl;this.context.unbindVAO(),this.bind(),h.bufferSubData(h.ELEMENT_ARRAY_BUFFER,0,o.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return d.uniqueIdxCounter=0,d})(),Xv={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class W1{constructor(t,o,h,g,y,x){this.length=o.length,this.attributes=h,this.itemSize=o.bytesPerElement,this.dynamicDraw=g,this.instanceCount=x,this.context=t;let E=t.gl;this.buffer=E.createBuffer(),t.bindVertexBuffer.set(this.buffer),E.bufferData(E.ARRAY_BUFFER,o.arrayBuffer,this.dynamicDraw?E.DYNAMIC_DRAW:E.STATIC_DRAW),this.dynamicDraw||y||o.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){let o=this.context.gl;this.bind(),o.bufferSubData(o.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,o){for(let h=0;h<this.attributes.length;h++){let g=o.getAttributeLocation(t,this.attributes[h].name);g!==-1&&t.enableVertexAttribArray(g)}}setVertexAttribPointers(t,o,h){for(let g=0;g<this.attributes.length;g++){let y=this.attributes[g],x=o.getAttributeLocation(t,y.name);x!==-1&&t.vertexAttribPointer(x,y.components,t[Xv[y.type]],!1,this.itemSize,y.offset+this.itemSize*(h||0))}}setVertexAttribDivisor(t,o,h){for(let g=0;g<this.attributes.length;g++){let y=o.getAttributeLocation(t,this.attributes[g].name);y!==-1&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(y,h)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Hf{constructor(t,o,h,g,y){this.context=t,this.width=o,this.height=h;let x=this.framebuffer=t.gl.createFramebuffer();g&&(this.colorAttachment=new j1(t,x)),y&&(this.depthAttachmentType=y,this.depthAttachment=y==="renderbuffer"?new Bv(t,x):new U1(t,x))}destroy(){let t=this.context.gl;if(this.colorAttachment){let o=this.colorAttachment.get();o&&t.deleteTexture(o)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){let o=this.depthAttachment.get();o&&t.deleteRenderbuffer(o)}else{let o=this.depthAttachment.get();o&&t.deleteTexture(o)}t.deleteFramebuffer(this.framebuffer)}}class $f{constructor(t,o){this.gl=t,this.clearColor=new Rv(this),this.clearDepth=new ug(this),this.clearStencil=new F1(this),this.colorMask=new k1(this),this.depthMask=new N1(this),this.stencilMask=new z1(this),this.stencilFunc=new Pv(this),this.stencilOp=new B1(this),this.stencilTest=new Tf(this),this.depthRange=new V1(this),this.depthTest=new Ov(this),this.depthFunc=new dg(this),this.blend=new If(this),this.blendFunc=new hg(this),this.blendColor=new oc(this),this.blendEquation=new su(this),this.cullFace=new Gd(this),this.cullFaceSide=new au(this),this.frontFace=new Lv(this),this.program=new fg(this),this.activeTexture=new Fv(this),this.viewport=new lu(this),this.bindFramebuffer=new Sf(this),this.bindRenderbuffer=new Df(this),this.bindTexture=new pg(this),this.bindVertexBuffer=new Cf(this),this.bindElementBuffer=new qd(this),this.bindVertexArrayOES=new kv(this),this.pixelStoreUnpack=new Nv(this),this.pixelStoreUnpackPremultiplyAlpha=new zv(this),this.pixelStoreUnpackFlipY=new cu(this),this.options=o?Object.assign({},o):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=o&&!!o.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,o,h){return new Zv(this,t,o,h)}createVertexBuffer(t,o,h,g,y){return new W1(this,t,o,h,g,y)}createRenderbuffer(t,o,h){let g=this.gl,y=g.createRenderbuffer();return this.bindRenderbuffer.set(y),g.renderbufferStorage(g.RENDERBUFFER,t,o,h),this.bindRenderbuffer.set(null),y}createFramebuffer(t,o,h,g){return new Hf(this,t,o,h,g)}clear({color:t,depth:o,stencil:h,colorMask:g}){let y=this.gl,x=0;t&&(x|=y.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(g||[!0,!0,!0,!0])),o!==void 0&&(x|=y.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(o),this.depthMask.set(!0)),h!==void 0&&(x|=y.STENCIL_BUFFER_BIT,this.clearStencil.set(h),this.stencilMask.set(255)),y.clear(x)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){i.bx(t.blendFunction,rn.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let pa;function Jd(d,t,o,h,g,y,x){let E=d.context,T=E.gl,A=d.transform,M=[i.aF(A.center.lng),i.aJ(A.center.lat)],L=o.layout.get("symbol-placement"),R=o.layout.get("text-variable-anchor"),F=o.layout.get("icon-rotation-alignment")==="map",z=o.layout.get("text-rotation-alignment")==="map",j=L!=="point",q=[],$=0,Z=0;for(let ie=0;ie<h.length;ie++){let ue=h[ie],be=t.getTile(ue),ye=be.getBucket(o);if(!ye)continue;let Pe=ye.getProjection().createInversionMatrix(A,ue.canonical),Se=[],Be=Tv(ue,ye,A),tt=!x&&F&&j,Ie=x&&z&&j,me=R&&ye.hasTextData(),Ve=ye.hasIconTextFit()&&me&&ye.hasIconData(),De=tt||Ie||x&&me||Ve,Ge=ye.projection.name==="globe",ot=Ge?i.aj(A.zoom):0;Ge&&(Se.push("PROJECTION_GLOBE_VIEW"),De&&Se.push("PROJECTED_POS_ON_VIEWPORT"));let xt=d.getOrCreateProgram("collisionBox",{defines:Se}),Je=Be;g[0]===0&&g[1]===0||(Je=d.translatePosMatrix(Be,be,g,y));let it=x?ye.textCollisionBox:ye.iconCollisionBox,wt=ye.collisionCircleArray;if(wt.length>0){let ht=i.bB(),gt=Je;i.cO(ht,ye.placementInvProjMatrix,A.glCoordMatrix),i.cO(ht,ht,ye.placementViewportMatrix),q.push({circleArray:wt,circleOffset:Z,transform:gt,invTransform:ht,projection:ye.getProjection()}),$+=wt.length/4,Z=$}if(!it)continue;d.terrain&&d.terrain.setupElevationDraw(be,xt);let mt=Ge?[ue.canonical.x,ue.canonical.y,1<<ue.canonical.z]:[0,0,0];xt.draw(d,T.LINES,Tt.disabled,qt.disabled,d.colorModeForRenderPass(),jt.disabled,hu(Je,Pe,A,ot,M,be,mt,ye.getProjection()),o.id,it.layoutVertexBuffer,it.indexBuffer,it.segments,null,A.zoom,null,[it.collisionVertexBuffer,it.collisionVertexBufferExt])}if(!x||!q.length)return;let J=d.getOrCreateProgram("collisionCircle"),Y=new i.dY;Y.resize(4*$),Y._trim();let ae=0;for(let ie of q)for(let ue=0;ue<ie.circleArray.length/4;ue++){let be=4*ue,ye=ie.circleArray[be+0],Pe=ie.circleArray[be+1],Se=ie.circleArray[be+2],Be=ie.circleArray[be+3];Y.emplace(ae++,ye,Pe,Se,Be,0),Y.emplace(ae++,ye,Pe,Se,Be,1),Y.emplace(ae++,ye,Pe,Se,Be,2),Y.emplace(ae++,ye,Pe,Se,Be,3)}(!pa||pa.length<2*$)&&(pa=(function(ie){let ue=2*ie,be=new i.b0;be.resize(ue),be._trim();for(let ye=0;ye<ue;ye++){let Pe=6*ye;be.uint16[Pe+0]=4*ye+0,be.uint16[Pe+1]=4*ye+1,be.uint16[Pe+2]=4*ye+2,be.uint16[Pe+3]=4*ye+2,be.uint16[Pe+4]=4*ye+3,be.uint16[Pe+5]=4*ye+0}return be})($));let Q=E.createIndexBuffer(pa,!0),ce=E.createVertexBuffer(Y,i.dZ.members,!0);for(let ie of q){let ue={u_matrix:ie.transform,u_inv_matrix:ie.invTransform,u_camera_to_center_distance:(se=A).getCameraToCenterDistance(ie.projection),u_viewport_size:[se.width,se.height]};J.draw(d,T.TRIANGLES,Tt.disabled,qt.disabled,d.colorModeForRenderPass(),jt.disabled,ue,o.id,ce,Q,i.bf.simpleSegment(0,2*ie.circleOffset,ie.circleArray.length,ie.circleArray.length/2),null,A.zoom)}var se;ce.destroy(),Q.destroy()}let gl=i.bB();function Ag(d){let t=d._camera.getWorldToCamera(d.worldSize,1),o=i.aB([],t,d.globeMatrix);i.bk(o,o);let h=[0,0,0],g=[0,1,0,0];return i.aC(g,g,o),h[0]=g[0],h[1]=g[1],h[2]=g[2],i.aw(h,h),h}function Gf({width:d,height:t,anchor:o,textOffset:h,textScale:g},y){let{horizontalAlign:x,verticalAlign:E}=i.c0(o),T=-(x-.5)*d,A=-(E-.5)*t,M=i.c1(o,h);return new i.P((T/g+M[0])*y,(A/g+M[1])*y)}function qf(d,t,o,h,g,y,x,E,T,A){let M=d.text.placedSymbolArray,L=d.text.dynamicLayoutVertexArray,R=d.icon.dynamicLayoutVertexArray,F={},z=d.getProjection(),j=hf(x,z,g),q=g.elevation,$=z.upVectorScale(x.canonical,g.center.lat,g.worldSize).metersToTile;L.clear();for(let Z=0;Z<M.length;Z++){let J=M.get(Z),{tileAnchorX:Y,tileAnchorY:ae,numGlyphs:Q}=J,ce=J.hidden||!J.crossTileID||d.allowVerticalPlacement&&!J.placedOrientation?null:h[J.crossTileID];if(ce){let se=0,ie=0,ue=0,be=d.elevationType==="road";if(q||be){let De=be?d.getElevationFeatureForText(Z):null,Ge=i.bU.getAtTileOffset(x,new i.P(Y,ae),q,De),[ot,xt,Je]=z.upVector(x.canonical,Y,ae);se=Ge*ot*$,ie=Ge*xt*$,ue=Ge*Je*$}let[ye,Pe,Se,Be]=gr(J.projectedAnchorX+se,J.projectedAnchorY+ie,J.projectedAnchorZ+ue,o?j:y),tt=Km(g.getCameraToCenterDistance(z),Be),Ie=i.bL(d.textSizeData,T,J)*tt/i.bX;o&&(Ie*=d.tilePixelRatio/E);let me=Gf(ce,Ie);o?({x:ye,y:Pe,z:Se}=z.projectTilePoint(Y+me.x,ae+me.y,x.canonical),[ye,Pe,Se]=gr(ye+se,Pe+ie,Se+ue,y)):(t&&me._rotate(-g.angle),ye+=me.x,Pe+=me.y,Se=0);let Ve=d.allowVerticalPlacement&&J.placedOrientation===i.bK.vertical?Math.PI/2:0;for(let De=0;De<Q;De++)i.bN(L,ye,Pe,Se,Ve);A&&J.associatedIconIndex>=0&&(F[J.associatedIconIndex]={x:ye,y:Pe,z:Se,angle:Ve})}else Pa(Q,L)}if(A){R.clear();let Z=d.icon.placedSymbolArray;for(let J=0;J<Z.length;J++){let Y=Z.get(J),{numGlyphs:ae}=Y,Q=F[J];if(Y.hidden||!Q)Pa(ae,R);else{let{x:ce,y:se,z:ie,angle:ue}=Q;for(let be=0;be<ae;be++)i.bN(R,ce,se,ie,ue)}}d.icon.dynamicLayoutVertexBuffer.updateData(R)}d.text.dynamicLayoutVertexBuffer.updateData(L)}function Qd(d,t,o,h,g,y,x={}){let E=o.paint.get("icon-translate"),T=o.paint.get("text-translate"),A=o.paint.get("icon-translate-anchor"),M=o.paint.get("text-translate-anchor"),L=o.layout.get("icon-rotation-alignment"),R=o.layout.get("text-rotation-alignment"),F=o.layout.get("icon-pitch-alignment"),z=o.layout.get("text-pitch-alignment"),j=o.layout.get("icon-keep-upright"),q=o.layout.get("text-keep-upright"),$=o.paint.get("icon-color-saturation"),Z=o.paint.get("icon-color-contrast"),J=o.paint.get("icon-color-brightness-min"),Y=o.paint.get("icon-color-brightness-max"),ae=o.layout.get("symbol-elevation-reference")==="sea",Q=o.layout.get("icon-image-use-theme")==="none",ce=d.context,se=ce.gl,ie=d.transform,ue=L==="map",be=R==="map",ye=F==="map",Pe=z==="map",Se=o.layout.get("symbol-sort-key").constantOr(1)!==void 0,Be=!1,tt=d.depthModeForSublayer(0,Tt.ReadOnly),Ie=new Tt(d.context.gl.LEQUAL,Tt.ReadOnly,d.depthRangeFor3D),me=[i.aF(ie.center.lng),i.aJ(ie.center.lat)],Ve=o.layout.get("text-variable-anchor"),De=ie.projection.name==="globe",Ge=[],ot=[0,-1,0];for(let xt of h){let Je=t.getTile(xt),it=Je.getBucket(o);if(!it||it.projection.name==="mercator"&&De||it.fullyClipped)continue;let wt=it.projection.name==="globe",mt=wt?i.aj(ie.zoom):0,ht=hf(xt,it.getProjection(),ie),gt=ie.calculatePixelsToTileUnitsMatrix(Je),Ot=Ve&&it.hasTextData(),fn=it.hasIconTextFit()&&Ot&&it.hasIconData(),vn=it.getProjection().createInversionMatrix(ie,xt.canonical),Zn=(1<<Je.tileID.canonical.z)*i.al/d.transform.worldSize,Ut=kn=>{let $t=[0,0,0];if(kn){let wn=d.style.directionalLight,Ti=d.style.ambientLight;wn&&Ti&&($t=ws(d.style,wn,Ti))}return $t},yn=kn=>{ie.depthOcclusionForSymbolsAndCircles&&(o.hasOcclusionOpacityProperties||d.terrain)&&(kn.push("DEPTH_D24"),kn.push("DEPTH_OCCLUSION"))},en=kn=>{o.lut&&!Q&&(o.lut.texture||(o.lut.texture=new i.d_(d.context,o.lut.image,[o.lut.image.height,o.lut.image.height,o.lut.image.height],ce.gl.RGBA8)),ce.activeTexture.set(ce.gl.TEXTURE0+Fr.LUT),o.lut.texture&&o.lut.texture.bind(ce.gl.LINEAR,ce.gl.CLAMP_TO_EDGE),kn.push("APPLY_LUT_ON_GPU"))},jn=()=>{let kn=ue&&o.layout.get("symbol-placement")!=="point",$t=[];yn($t),en($t);let wn=kn||fn,Ti=it.elevationType==="road",$i=d.shadowRenderer,Ai=Ti&&ye&&!!$i&&$i.enabled,Bi=Ut(Ai),So=Ti&&ye&&!d.terrain?Ie:tt,po=o.paint.get("icon-image-cross-fade");d.terrainRenderModeElevated()&&ye&&$t.push("PITCH_WITH_MAP_TERRAIN"),wt&&($t.push("PROJECTION_GLOBE_VIEW"),wn&&$t.push("PROJECTED_POS_ON_VIEWPORT")),po>0&&it.hasAnySecondaryIcon&&$t.push("ICON_TRANSITION"),!it.icon.zOffsetVertexBuffer||Ti&&d.terrain||$t.push("Z_OFFSET"),$===0&&Z===0&&J===0&&Y===1||$t.push("COLOR_ADJUSTMENT"),it.sdfIcons&&$t.push("RENDER_SDF"),Ai&&$t.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Ti&&ye&&!d.terrain&&it.icon.orientationVertexBuffer&&$t.push("ELEVATED_ROADS");let Ur=it.icon.programConfigurations.get(o.id),Xr=d.getOrCreateProgram("symbol",{config:Ur,defines:$t}),Qo=Je.imageAtlasTexture?Je.imageAtlasTexture.size:[0,0],Hr=it.iconSizeData,es=i.bJ(Hr,ie.zoom),Cs=ye||!ie.isOrthographic,Cr=Xc(ht,Je.tileID.canonical,ye,ue,ie,it.getProjection(),gt),Oi=Ra(ht,Je.tileID.canonical,ye,ue,ie,it.getProjection(),gt),Gi=d.translatePosMatrix(Oi,Je,E,A,!0),ni=d.translatePosMatrix(ht,Je,E,A),Yi=wn?gl:Cr,Ar=ue&&!ye&&!kn,Li=ot;!De&&!ie.mercatorFromTransition||ue||(Li=Ag(ie));let ts=wt?Li:ot,Cu=o.getColorAdjustmentMatrix($,Z,J,Y),Ua=Dg(Hr.kind,es,Ar,ye,d,ni,Yi,Gi,ae,!1,Qo,[0,0],0,xt,mt,me,vn,ts,it.getProjection(),Bi,Zn,Cu,po,null),Au=Je.imageAtlasTexture?Je.imageAtlasTexture:null,Mu=o.layout.get("icon-size").constantOr(0)!==1||it.iconsNeedLinear,ns=it.sdfIcons||d.options.rotating||d.options.zooming||Mu||Cs?se.LINEAR:se.NEAREST,ga=it.sdfIcons&&o.paint.get("icon-halo-width").constantOr(1)!==0,br=d.terrain&&ye&&kn?i.bk(i.bB(),Cr):gl;if(kn&&it.icon){let is=i.bU.getAtTileOffsetFunc(xt,ie.center.lat,ie.worldSize,it.getProjection()),mc=Pd(ht,Je.tileID.canonical,ye,ue,ie,it.getProjection(),gt),v0=o.layout.get("icon-size-scale-range"),fp=i.aA(d.scaleFactor,v0[0],v0[1]);Qm(it,ht,d,!1,mc,Oi,ye,j,is,xt,fp)}return{program:Xr,buffers:it.icon,uniformValues:Ua,atlasTexture:Au,atlasTextureIcon:null,atlasInterpolation:ns,atlasInterpolationIcon:null,isSDF:it.sdfIcons,hasHalo:ga,depthMode:So,tile:Je,renderWithShadows:Ai,labelPlaneMatrixInv:br}},xn=()=>{let kn=be&&o.layout.get("symbol-placement")!=="point",$t=[],wn=kn||Ve||fn,Ti=it.elevationType==="road",$i=d.shadowRenderer,Ai=Ti&&Pe&&!!$i&&$i.enabled,Bi=Ut(Ai),So=Ti&&Pe&&!d.terrain?Ie:tt;d.terrainRenderModeElevated()&&Pe&&$t.push("PITCH_WITH_MAP_TERRAIN"),wt&&($t.push("PROJECTION_GLOBE_VIEW"),wn&&$t.push("PROJECTED_POS_ON_VIEWPORT")),!it.text.zOffsetVertexBuffer||Ti&&d.terrain||$t.push("Z_OFFSET"),it.iconsInText&&$t.push("RENDER_TEXT_AND_SYMBOL"),$t.push("RENDER_SDF"),Ai&&$t.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Ti&&Pe&&!d.terrain&&it.text.orientationVertexBuffer&&$t.push("ELEVATED_ROADS"),yn($t);let po=it.text.programConfigurations.get(o.id),Ur=d.getOrCreateProgram("symbol",{config:po,defines:$t}),Xr,Qo=[0,0],Hr=null,es=it.textSizeData;it.iconsInText&&(Qo=Je.imageAtlasTexture?Je.imageAtlasTexture.size:[0,0],Hr=Je.imageAtlasTexture?Je.imageAtlasTexture:null,Xr=Pe||!ie.isOrthographic||d.options.rotating||d.options.zooming||es.kind==="composite"||es.kind==="camera"?se.LINEAR:se.NEAREST);let Cs=Je.glyphAtlasTexture?Je.glyphAtlasTexture.size:[0,0],Cr=o.layout.get("text-size-scale-range"),Oi=i.aA(d.scaleFactor,Cr[0],Cr[1]),Gi=i.bJ(es,ie.zoom,Oi),ni=Xc(ht,Je.tileID.canonical,Pe,be,ie,it.getProjection(),gt),Yi=Ra(ht,Je.tileID.canonical,Pe,be,ie,it.getProjection(),gt),Ar=d.translatePosMatrix(Yi,Je,T,M,!0),Li=d.translatePosMatrix(ht,Je,T,M),ts=wn?gl:ni,Cu=be&&!Pe&&!kn,Ua=ot;!De&&!ie.mercatorFromTransition||be||(Ua=Ag(ie));let Au=Dg(es.kind,Gi,Cu,Pe,d,Li,ts,Ar,ae,!0,Cs,Qo,0,xt,mt,me,vn,wt?Ua:ot,it.getProjection(),Bi,Zn,null,null,Oi),Mu=Je.glyphAtlasTexture?Je.glyphAtlasTexture:null,ns=se.LINEAR,ga=o.paint.get("text-halo-width").constantOr(1)!==0,br=d.terrain&&Pe&&kn?i.bk(i.bB(),ni):gl;if(kn&&it.text){let is=i.bU.getAtTileOffsetFunc(xt,ie.center.lat,ie.worldSize,it.getProjection()),mc=Pd(ht,Je.tileID.canonical,Pe,be,ie,it.getProjection(),gt);Qm(it,ht,d,!0,mc,Yi,Pe,q,is,xt,Oi)}return{program:Ur,buffers:it.text,uniformValues:Au,atlasTexture:Mu,atlasTextureIcon:Hr,atlasInterpolation:ns,atlasInterpolationIcon:Xr,isSDF:!0,hasHalo:ga,depthMode:So,tile:Je,renderWithShadows:Ai,labelPlaneMatrixInv:br}},oi=it.icon.segments.get().length,Sn=it.text.segments.get().length,nn=oi&&!x.onlyText?jn():null,On=Sn&&!x.onlyIcons?xn():null,on=o.paint.get("icon-opacity").constantOr(1),ui=o.paint.get("text-opacity").constantOr(1);if(Se&&it.canOverlap){Be=!0;let kn=on&&!x.onlyText?it.icon.segments.get():[],$t=ui&&!x.onlyIcons?it.text.segments.get():[];for(let wn of kn)Ge.push({segments:new i.bf([wn]),sortKey:wn.sortKey,state:nn});for(let wn of $t)Ge.push({segments:new i.bf([wn]),sortKey:wn.sortKey,state:On})}else x.onlyText||Ge.push({segments:on?it.icon.segments:new i.bf([]),sortKey:0,state:nn}),x.onlyIcons||Ge.push({segments:ui?it.text.segments:new i.bf([]),sortKey:0,state:On})}Be&&Ge.sort((xt,Je)=>xt.sortKey-Je.sortKey);for(let xt of Ge){let Je=xt.state;if(Je)if(d.terrain?d.terrain.setupElevationDraw(Je.tile,Je.program,{useDepthForOcclusion:ie.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Je.labelPlaneMatrixInv}):d.setupDepthForOcclusion(ie.depthOcclusionForSymbolsAndCircles,Je.program),ce.activeTexture.set(se.TEXTURE0),Je.atlasTexture&&Je.atlasTexture.bind(Je.atlasInterpolation,se.CLAMP_TO_EDGE,!0),Je.atlasTextureIcon&&(ce.activeTexture.set(se.TEXTURE1),Je.atlasTextureIcon&&Je.atlasTextureIcon.bind(Je.atlasInterpolationIcon,se.CLAMP_TO_EDGE,!0)),Je.renderWithShadows&&d.shadowRenderer.setupShadows(Je.tile.tileID.toUnwrapped(),Je.program,"vector-tile"),d.uploadCommonLightUniforms(d.context,Je.program),Je.hasHalo){let it=Je.uniformValues;it.u_is_halo=1,Wf(Je.buffers,xt.segments,o,d,Je.program,Je.depthMode,g,y,it,2),it.u_is_halo=0}else{if(Je.isSDF){let it=Je.uniformValues;Je.hasHalo&&(it.u_is_halo=1,Wf(Je.buffers,xt.segments,o,d,Je.program,Je.depthMode,g,y,it,1)),it.u_is_halo=0}Wf(Je.buffers,xt.segments,o,d,Je.program,Je.depthMode,g,y,Je.uniformValues,1)}}}function Wf(d,t,o,h,g,y,x,E,T,A){let M=[d.dynamicLayoutVertexBuffer,d.opacityVertexBuffer,d.iconTransitioningVertexBuffer,d.globeExtVertexBuffer,d.zOffsetVertexBuffer,d.orientationVertexBuffer];g.draw(h,h.context.gl.TRIANGLES,y,x,E,jt.disabled,T,o.id,d.layoutVertexBuffer,d.indexBuffer,t,o.paint,h.transform.zoom,d.programConfigurations.get(o.id),M,A)}function Yv(d,t){let o=1<<d.canonical.z,h=(t.x*o-d.canonical.x-d.wrap*o)*i.al,g=(t.y*o-d.canonical.y)*i.al,y=i.e7(t.z,t.y);return i.d4(h,g,y)}function cc(d,t,o,h,g){if(!o.layout||o.layout.get("fill-elevation-reference")==="none"||o.paint.get("fill-opacity").constantOr(1)===0)return;let y=d.context.gl,x=new Tt(d.context.gl.LEQUAL,Tt.ReadWrite,d.depthRangeFor3D),E=new Tt(d.context.gl.GREATER,Tt.ReadWrite,d.depthRangeFor3D),T=(function(F){let z=.01;return F.isOrthographic&&(z=i.ak(1e-4,z,i.c$(F.pitch>=ic?1:F.pitch/ic))),2*z})(d.transform),A=d.transform.getFreeCameraOptions().position,M="elevatedStructuresDepthReconstruct",L=d.getOrCreateProgram(M,{defines:["DEPTH_RECONSTRUCTION"]}),R=d.getOrCreateProgram(M);for(let F of h){let z=t.getTile(F),j=z.getBucket(o);if(!j)continue;let q=j.elevatedStructures;if(!q)continue;let $=j.elevationBufferData.heightRange,Z=Yv(F.toUnwrapped(),A),J=d.translatePosMatrix(F.projMatrix,z,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),Y,ae,Q,ce;if(g==="initialize"){if(!$||$.min>=1||q.depthSegments.segments[0].primitiveLength===0)continue;Y=kf(J,Z,T,1,0),ae=x,Q=q.depthSegments,ce=L}else if(g==="reset"){if(!$||$.min>=0||q.maskSegments.segments[0].primitiveLength===0)continue;Y=kf(J,Z,0,0,1),ae=E,Q=q.maskSegments,ce=L}else if(g==="geometry"){if(q.depthSegments.segments[0].primitiveLength===0)continue;Y=kf(J,Z,T,1,0),ae=x,Q=q.depthSegments,ce=R}ce.draw(d,y.TRIANGLES,ae,qt.disabled,rn.disabled,jt.disabled,Y,o.id,q.vertexBuffer,q.indexBuffer,Q,o.paint,d.transform.zoom)}}function pu(d,t,o){let{painter:h,sourceCache:g,layer:y,coords:x,colorMode:E,elevationType:T,terrainEnabled:A,pass:M}=d,L=h.context.gl,R=y.paint.get("fill-pattern"),F=y.paint.get("fill-pattern-cross-fade"),z=R.constantOr(null),j=T;T!=="road"||t&&!A||(j="none");let q=j==="road",$=d.painter.shadowRenderer,Z=q&&!!$&&$.enabled,J=new Tt(h.context.gl.LEQUAL,Tt.ReadOnly,h.depthRangeFor3D),Y=[0,0,0];if(Z){let ce=h.style.directionalLight,se=h.style.ambientLight;ce&&se&&(Y=ws(h.style,ce,se))}let ae=R&&R.constantOr(1),Q=(ce,se)=>{let ie,ue,be,ye,Pe;se?(ie=ae&&!y.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",be=L.LINES):(ie=ae?"fillPattern":"fill",be=L.TRIANGLES);for(let Se of x){let Be=g.getTile(Se);if(ae&&!Be.patternsLoaded())continue;let tt=Be.getBucket(y);if(!tt)continue;let Ie=t?tt.elevationBufferData:tt.bufferData;if(Ie.isEmpty())continue;h.prepareDrawTile();let me=Ie.programConfigurations.get(y.id),Ve=h.isTileAffectedByFog(Se),De=[],Ge=[];q&&(De.push("ELEVATED_ROADS"),Ge.push(Ie.elevatedLayoutVertexBuffer)),Z&&De.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),ae&&(h.context.activeTexture.set(L.TEXTURE0),Be.imageAtlasTexture&&Be.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),me.updatePaintBuffers());let ot=!1;if(z&&Be.imageAtlas){let mt=Be.imageAtlas,ht=i.e2.from(z),gt=ht.getPrimary().scaleSelf(i.o.devicePixelRatio).toString(),Ot=ht.getSecondary(),fn=mt.patternPositions.get(gt),vn=Ot?mt.patternPositions.get(Ot.scaleSelf(i.o.devicePixelRatio).toString()):null;ot=!!fn&&!!vn,fn&&me.setConstantPatternPositions(fn,vn)}F>0&&(ot||me.getPatternTransitionVertexBuffer("fill-pattern"))&&De.push("FILL_PATTERN_TRANSITION");let xt=h.getOrCreateProgram(ie,{config:me,overrideFog:Ve,defines:De}),Je=h.translatePosMatrix(Se.projMatrix,Be,y.paint.get("fill-translate"),y.paint.get("fill-translate-anchor"));Z&&$.setupShadows(Be.tileID.toUnwrapped(),xt,"vector-tile");let it=y.paint.get("fill-emissive-strength");if(se){ye=Ie.lineIndexBuffer,Pe=Ie.lineSegments;let mt=h.terrain&&h.terrain.renderingToTexture?h.terrain.drapeBufferSize:[L.drawingBufferWidth,L.drawingBufferHeight];ue=ie==="fillOutlinePattern"&&ae?$1(Je,it,h,Be,mt,Y,F):H1(Je,it,mt,Y)}else ye=Ie.indexBuffer,Pe=Ie.triangleSegments,ue=ae?$v(Je,it,h,Be,Y,F):Hv(Je,it,Y);h.uploadCommonUniforms(h.context,xt,Se.toUnwrapped());let wt=ce;(T==="road"&&!A||T==="offset")&&(wt=J),xt.draw(h,be,wt,o||h.stencilModeForClipping(Se),E,jt.disabled,ue,y.id,Ie.layoutVertexBuffer,ye,Pe,y.paint,h.transform.zoom,me,Ge)}};h.renderPass===M&&Q(h.depthModeForSublayer(1,h.renderPass==="opaque"?Tt.ReadWrite:Tt.ReadOnly),!1),j==="none"&&h.renderPass==="translucent"&&y.paint.get("fill-antialias")&&Q(h.depthModeForSublayer(y.getPaintProperty("fill-outline-color")?2:0,Tt.ReadOnly),!0)}function vt(d,t,o,h,g,y,x,E){o.resetLayerRenderingStats(d);let T=d.context,A=T.gl,M=d.transform,L=o.paint.get("fill-extrusion-pattern"),R=o.paint.get("fill-extrusion-pattern-cross-fade"),F=L.constantOr(null),z=L.constantOr(1),j=o.paint.get("fill-extrusion-opacity"),q=d.style.enable3dLights(),$=o.paint.get(q&&!z?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Z=[o.paint.get("fill-extrusion-ambient-occlusion-intensity"),$],J=o.layout.get("fill-extrusion-edge-radius"),Y=J>0&&!o.paint.get("fill-extrusion-rounded-roof"),ae=Y?0:J,Q=M.projection.name==="globe"?i.ea():0,ce=M.projection.name==="globe",se=ce?i.aj(M.zoom):0,ie=[i.aF(M.center.lng),i.aJ(M.center.lat)],ue=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",be=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ue?null:o.lut).toArray01().slice(0,3),ye=o.paint.get("fill-extrusion-flood-light-intensity"),Pe=o.paint.get("fill-extrusion-vertical-scale"),Se=o.paint.get("fill-extrusion-line-width").constantOr(1)!==0,Be=o.paint.get("fill-extrusion-height-alignment"),tt=o.paint.get("fill-extrusion-base-alignment"),Ie=Fa(d,o.paint.get("fill-extrusion-cutoff-fade-range")),me=[],Ve;ce&&me.push("PROJECTION_GLOBE_VIEW"),Z[0]>0&&me.push("FAUX_AO"),Y&&me.push("ZERO_ROOF_RADIUS"),E&&me.push("HAS_CENTROID"),ye>0&&me.push("FLOOD_LIGHT"),Ie.shouldRenderCutoff&&me.push("RENDER_CUTOFF"),Se&&me.push("RENDER_WALL_MODE");let De=d.renderPass==="shadow",Ge=d.shadowRenderer,ot=De&&!!Ge,xt=De?jt.disabled:jt.backCCW;d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!0);let Je=[0,0,0];if(Ge){let mt=d.style.directionalLight,ht=d.style.ambientLight;mt&&ht&&(Je=ws(d.style,mt,ht)),De||(me.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Ge.useNormalOffset&&me.push("NORMAL_OFFSET")),Ve=me.concat(["SHADOWS_SINGLE_CASCADE"])}let it=ot?"fillExtrusionDepth":z?"fillExtrusionPattern":"fillExtrusion",wt=o.getLayerRenderingStats();for(let mt of h){let ht=t.getTile(mt),gt=ht.getBucket(o);if(!gt||gt.projection.name!==M.projection.name)continue;let Ot=!1;Ge&&(Ot=Ge.getMaxCascadeForTile(mt.toUnwrapped())===0);let fn=d.isTileAffectedByFog(mt),vn=gt.programConfigurations.get(o.id),Zn=!1;if(F&&ht.imageAtlas){let Sn=ht.imageAtlas,nn=i.e2.from(F),On=nn.getPrimary().scaleSelf(i.o.devicePixelRatio).toString(),on=nn.getSecondary(),ui=Sn.patternPositions.get(On),kn=on?Sn.patternPositions.get(on.scaleSelf(i.o.devicePixelRatio).toString()):null;Zn=!!ui&&!!kn,ui&&vn.setConstantPatternPositions(ui,kn)}R>0&&(Zn||vn.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&me.push("FILL_EXTRUSION_PATTERN_TRANSITION");let Ut=d.getOrCreateProgram(it,{config:vn,defines:Ot?Ve:me,overrideFog:fn});if(d.terrain&&d.terrain.setupElevationDraw(ht,Ut,{useMeterToDem:!0}),!gt.centroidVertexBuffer){let Sn=Ut.getAttributeLocation(A,"a_centroid_pos");Sn!==-1&&A.vertexAttrib2f(Sn,0,0)}!De&&Ge&&Ge.setupShadows(ht.tileID.toUnwrapped(),Ut,"vector-tile"),z&&(d.context.activeTexture.set(A.TEXTURE0),ht.imageAtlasTexture&&ht.imageAtlasTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),vn.updatePaintBuffers());let yn=o.paint.get("fill-extrusion-vertical-gradient"),en=1/gt.tileToMeter,jn;if(De&&Ge){if(Kv(ht.tileID,gt.maxHeight,d))continue;let Sn=Ge.calculateShadowPassMatrixFromTile(ht.tileID.toUnwrapped());jn=jv(Sn,ae,en,Pe,Be,tt)}else{let Sn=d.translatePosMatrix(mt.expandedProjMatrix,ht,o.paint.get("fill-extrusion-translate"),o.paint.get("fill-extrusion-translate-anchor")),nn=M.projection.createInversionMatrix(M,mt.canonical);jn=z?Uv(Sn,d,yn,j,Z,ae,en,mt,ht,Q,Be,tt,se,ie,nn,be,Pe,R):Ff(Sn,d,yn,j,Z,ae,en,mt,Q,Be,tt,se,ie,nn,be,Pe,ye,Je)}d.uploadCommonUniforms(T,Ut,mt.toUnwrapped(),null,Ie);let xn=gt.segments;if(M.projection.name==="mercator"&&!De&&(xn=gt.getVisibleSegments(ht.tileID,d.terrain,d.transform.getFrustum(0)),!xn.get().length))continue;if(wt)if(De)for(let Sn of xn.get())wt.numRenderedVerticesInShadowPass+=Sn.primitiveLength;else for(let Sn of xn.get())wt.numRenderedVerticesInTransparentPass+=Sn.primitiveLength;let oi=[];(d.terrain||E)&&oi.push(gt.centroidVertexBuffer),ce&&oi.push(gt.layoutVertexExtBuffer),Se&&oi.push(gt.wallVertexBuffer),Ut.draw(d,T.gl.TRIANGLES,g,y,x,xt,jn,o.id,gt.layoutVertexBuffer,gt.indexBuffer,xn,o.paint,d.transform.zoom,vn,oi)}d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!1)}class Mg{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function Na(d,t,o,h,g,y,x,E,T,A,M,L,R,F,z,j,q,$,Z,J){let Y=t.context,ae=Y.gl,Q=t.transform,ce=t.transform.zoom,se=[],ie=d.translate,ue=d.translateAnchor,be=d.edgeRadius,ye=Fa(t,d.cutoffFadeRange);M==="clear"?(se.push("CLEAR_SUBPASS"),J&&(se.push("CLEAR_FROM_TEXTURE"),Y.activeTexture.set(ae.TEXTURE0),J.bind(ae.LINEAR,ae.CLAMP_TO_EDGE))):M==="sdf"&&se.push("SDF_SUBPASS"),$&&se.push("HAS_CENTROID"),ye.shouldRenderCutoff&&se.push("RENDER_CUTOFF");let Pe=(Se,Be,tt,Ie,me)=>{let Ve=se;Be.groundRadiusBuffer!=null&&(Ve=se.concat("HAS_ATTRIBUTE_a_flood_light_ground_radius"));let De=Be.programConfigurations.get(h.id),Ge=t.isTileAffectedByFog(Se),ot=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:De,defines:Ve,overrideFog:Ge}),xt=du(t,Ie,L,A,me,[R,F*me],z,j,q,ce>=17?0:be*me,J?J.size[0]:0),Je=[];$&&Je.push(Be.hiddenByLandmarkVertexBuffer),Be.groundRadiusBuffer!=null&&Je.push(Be.groundRadiusBuffer),t.uploadCommonUniforms(Y,ot,Se.toUnwrapped(),null,ye),ot.draw(t,Y.gl.TRIANGLES,y,x,E,T,xt,h.id,Be.vertexBuffer,Be.indexBuffer,tt,h.paint,ce,De,Je)};for(let Se of g){let Be=o.getTile(Se),tt=Be.getBucket(h);if(!tt||tt.projection.name!==Q.projection.name||!tt.groundEffect||tt.groundEffect&&!tt.groundEffect.hasData())continue;let Ie=tt.groundEffect,me=1/tt.tileToMeter;{let Ve=t.translatePosMatrix(Se.projMatrix,Be,ie,ue),De=Ie.getDefaultSegment();Pe(Se,Ie,De,Ve,me)}if(Z)for(let Ve=0;Ve<4;Ve++){let De=i.e8[Ve](Se),Ge=o.getTile(De);if(!Ge)continue;let ot=Ge.getBucket(h);if(!ot||ot.projection.name!==Q.projection.name||!ot.groundEffect||ot.groundEffect&&!ot.groundEffect.hasData())continue;let xt=ot.groundEffect,Je,it;Ve===0?(Je=[-i.al,0,0],it=1):Ve===1?(Je=[i.al,0,0],it=0):Ve===2?(Je=[0,-i.al,0],it=3):(Je=[0,i.al,0],it=2);let wt=xt.regionSegments[it];if(!wt)continue;let mt=new Float32Array(16);i.bq(mt,Se.projMatrix,Je),Pe(Se,xt,wt,t.translatePosMatrix(mt,Be,ie,ue),me)}}}function _l(d,t,o,h,g,y,x){h.centroidVertexArray.length===0&&h.createCentroidsBuffer();let E=y?y.findDEMTileFor(o):null;if(!(E&&E.dem||x))return;y&&E&&E.dem&&h.selfDEMTileTimestamp!==E.dem._timestamp&&(h.borderDoneWithNeighborZ=[-1,-1,-1,-1],h.selfDEMTileTimestamp=E.dem._timestamp);let T=$=>new i.P(Math.ceil(($+i.ec)*i.ed),0),A=$=>{let Z=t.getSource().minzoom,J=ae=>{let Q=t.getTileByID(ae);if(Q&&Q.hasData())return Q.getBucket(g)},Y=[0,-1,1];for(let ae of Y){if($.overscaledZ+ae<Z)continue;let Q=J($.calculateScaledKey($.overscaledZ+ae));if(Q)return Q}},M=[0,0,0],L=($,Z)=>(M[0]=Math.min($.min.y,Z.min.y),M[1]=Math.max($.max.y,Z.max.y),M[2]=i.al-Z.min.x>$.max.x?Z.min.x-i.al:$.max.x,M),R=($,Z)=>(M[0]=Math.min($.min.x,Z.min.x),M[1]=Math.max($.max.x,Z.max.x),M[2]=i.al-Z.min.y>$.max.y?Z.min.y-i.al:$.max.y,M),F=[($,Z)=>L($,Z),($,Z)=>L(Z,$),($,Z)=>R($,Z),($,Z)=>R(Z,$)],z=($,Z,J,Y,ae,Q,ce)=>{if(!y)return 0;let se=[[Q?J:$,Q?$:J,0],[Q?J:Z,Q?Z:J,0]],ie=ce<0?i.al+ce:ce,ue=[Q?ie:($+Z)/2,Q?($+Z)/2:ie,0];return J===0&&ce<0||J!==0&&ce>0?y.getForTilePoints(ae,[ue],!0,Y):se.push(ue),y.getForTilePoints(o,se,!0,E),Math.max(se[0][2],se[1][2],ue[2])/y.exaggeration()};for(let $=0;$<4;$++){let Z=h.borderFeatureIndices[$];if(Z.length===0)continue;let J=i.e8[$](o),Y=A(J);if(!(Y&&Y instanceof i.e9))continue;let ae=y?y.findDEMTileFor(J):null;if(!(ae&&ae.dem||x)||(y&&ae&&ae.dem&&h.borderDEMTileTimestamp[$]!==ae.dem._timestamp&&(h.borderDoneWithNeighborZ[$]=-1,h.borderDEMTileTimestamp[$]=ae.dem._timestamp),h.borderDoneWithNeighborZ[$]===Y.canonical.z))continue;Y.centroidVertexArray.length===0&&Y.createCentroidsBuffer();let Q=($<2?1:5)-$,ce=Y.borderDoneWithNeighborZ[Q]!==h.canonical.z,se=Y.borderFeatureIndices[Q],ie=0;if(h.canonical.z!==Y.canonical.z){for(let ue of Z)h.showCentroid(h.featuresOnBorder[ue]);if(ce)for(let ue of se)Y.showCentroid(Y.featuresOnBorder[ue]);h.borderDoneWithNeighborZ[$]=Y.canonical.z,Y.borderDoneWithNeighborZ[Q]=h.canonical.z}for(let ue of Z){let be=h.featuresOnBorder[ue],ye=h.centroidData[be.centroidDataIndex],Pe=be.borders[$],Se;for(;ie<se.length;){Se=Y.featuresOnBorder[se[ie]];let Be=Se.borders[Q];if(Be[1]>Pe[0]+3||Be[0]>Pe[0]-3)break;Y.showCentroid(Se),ie++}if(Se&&ie<se.length){let Be=ie,tt=0;for(;!(Se.borders[Q][0]>Pe[1]-3)&&(tt++,++ie!==se.length);)Se=Y.featuresOnBorder[se[ie]];Se=Y.featuresOnBorder[se[Be]];let Ie=!1;if(tt>=1){let De=Se.borders[Q];Math.abs(Pe[0]-De[0])<3&&Math.abs(Pe[1]-De[1])<3&&(tt=1,Ie=!0,ie=Be+1)}else if(tt===0){h.showCentroid(be);continue}let me=Y.centroidData[Se.centroidDataIndex];x&&Ie&&(((j=ye).flags|(q=me).flags)&i.eb?(j.flags|=i.eb,q.flags|=i.eb):(j.flags&=~i.eb,q.flags&=~i.eb));let Ve=be.intersectsCount()>1||Se.intersectsCount()>1;if(tt>1)ie=Be,ye.centroidXY=me.centroidXY=new i.P(0,0);else if(ae&&ae.dem&&!Ve){let De=F[$](ye,me),Ge=$%2?i.al-1:0,ot=z(De[0],Math.min(i.al-1,De[1]),Ge,ae,J,$<2,De[2]);ye.centroidXY=me.centroidXY=T(ot)}else Ve?ye.centroidXY=me.centroidXY=new i.P(0,0):(ye.centroidXY=h.encodeBorderCentroid(be),me.centroidXY=Y.encodeBorderCentroid(Se));h.writeCentroidToBuffer(ye),Y.writeCentroidToBuffer(me)}else h.showCentroid(be)}h.borderDoneWithNeighborZ[$]=Y.canonical.z,Y.borderDoneWithNeighborZ[Q]=h.canonical.z}var j,q;(h.needsCentroidUpdate||!h.centroidVertexBuffer&&h.centroidVertexArray.length!==0)&&h.uploadCentroid(d)}let yl=[1,0,0],Pt=[0,1,0],Rg=[0,0,1];function Kv(d,t,o){let h=o.transform,g=o.shadowRenderer;if(!g)return!0;let y=d.toUnwrapped(),x=h.tileSize*g._cascades[o.currentShadowCascade].scale,E=t;if(h.elevation){let j=h.elevation.getMinMaxForTile(d);j&&(E+=j.max)}let T=[...g.shadowDirection];T[2]=-T[2];let A=g.computeSimplifiedTileShadowVolume(y,E,x,T);if(!A)return!1;let M=[yl,Pt,Rg,T,[T[0],0,T[2]],[0,T[1],T[2]]],L=h.projection.name==="globe",R=h.scaleZoom(x),F=i.cA.fromInvProjectionMatrix(h.invProjMatrix,h.worldSize,R,!L),z=g.getCurrentCascadeFrustum();return F.intersectsPrecise(A.vertices,A.planes,M)===0||z.intersectsPrecise(A.vertices,A.planes,M)===0}function Zf(d){let{painter:t,source:o,layer:h,coords:g}=d,y=d.defines,x=t.context,E=t.renderPass==="shadow",T=t.renderPass==="light-beam",A=t.shadowRenderer,M=i.ee(t.transform.center.lat,t.transform.zoom),L=Fa(t,h.paint.get("building-cutoff-fade-range"));L.shouldRenderCutoff&&(y=y.concat("RENDER_CUTOFF")),d.floodLightIntensity>0&&(y=y.concat("FLOOD_LIGHT"));for(let R of g){let F=o.getTile(R),z=F.getBucket(h);if(!z)continue;A&&A.getMaxCascadeForTile(R.toUnwrapped())===0&&(y=y.concat("SHADOWS_SINGLE_CASCADE"));let j=z.programConfigurations.get(h.id),q,$,Z,J=t.translatePosMatrix(R.expandedProjMatrix,F,[0,0],"map");if(J=i.cR(i.bB(),J,[1,1,d.verticalScale]),E&&A){if(Kv(F.tileID,z.maxHeight*M,t))continue;let ae=A.calculateShadowPassMatrixFromTile(F.tileID.toUnwrapped());ae=i.cR(i.bB(),ae,[1,1,d.verticalScale]),Z=Gv(ae),q=$=t.getOrCreateProgram("buildingDepth",{config:j,defines:y,overrideFog:!1})}else if(T)q=$=t.getOrCreateProgram("buildingBloom",{config:j,defines:y,overrideFog:!1}),Z=Eg(J);else{let ae=t.transform.calculatePosMatrix(R.toUnwrapped(),t.transform.worldSize);i.cR(ae,ae,[1,1,d.verticalScale]);let Q=i.bB();i.cR(Q,ae,[1,-1,1/M]),i.bk(Q,Q),i.ef(Q,Q);let ce=t.transform.getFreeCameraOptions().position,se=1<<R.canonical.z;if(Z=wg(J,Q,d.opacity,d.facadeAOIntensity,[((ce.x-R.wrap)*se-R.canonical.x)*i.al,(ce.y*se-R.canonical.y)*i.al,ce.z*se*i.al],z.tileToMeter,d.facadeEmissiveChance,d.floodLightColor,d.floodLightIntensity),$=t.getOrCreateProgram("building",{config:j,defines:y,overrideFog:!1}),d.depthOnly===!0)q=$;else{let ie=y.concat(["BUILDING_FAUX_FACADE","HAS_ATTRIBUTE_a_faux_facade_color_emissive"]);q=t.getOrCreateProgram("building",{config:j,defines:ie,overrideFog:!1})}A&&(A.setupShadowsFromMatrix(ae,$,!0),q!==$&&A.setupShadowsFromMatrix(ae,q,!0))}let Y=(ae,Q)=>{if(T){let ce=ae.entranceBloom;Q.draw(t,x.gl.TRIANGLES,d.depthMode,qt.disabled,d.blendMode,jt.disabled,Z,h.id,ce.layoutVertexBuffer,ce.indexBuffer,ce.segmentsBucket,h.paint,t.transform.zoom,j,[ce.layoutAttenuationBuffer,ce.layoutColorBuffer])}else{let ce=ae.segmentsBucket,se=[ae.layoutNormalBuffer,ae.layoutCentroidBuffer,ae.layoutColorBuffer,ae.layoutFloodLightDataBuffer];ae.layoutFacadePaintBuffer&&(se=se.concat([ae.layoutFacadeDataBuffer,ae.layoutFacadeVerticalRangeBuffer,ae.layoutFacadePaintBuffer])),Q.draw(t,x.gl.TRIANGLES,d.depthMode,qt.disabled,d.blendMode,E?jt.disabled:jt.backCW,Z,h.id,ae.layoutVertexBuffer,ae.indexBuffer,ce,h.paint,t.transform.zoom,j,se)}};t.uploadCommonUniforms(x,$,R.toUnwrapped(),null,L),z.buildingWithoutFacade&&Y(z.buildingWithoutFacade,$),z.buildingWithFacade&&(q!==$&&t.uploadCommonUniforms(x,q,R.toUnwrapped(),null,L),Y(z.buildingWithFacade,q))}}function Xf(d,t,o,h,g,y,x,E,T,A,M,L,R){let F=d.context.gl,z=d.depthModeForSublayer(1,Tt.ReadOnly,F.LEQUAL,!0),j=.1*(1-(q=M))+3*q;var q;let $=d._showOverdrawInspector,Z=L,J=new Mg;$||Na(J,d,t,o,h,z,new qt({func:F.ALWAYS,mask:255},255,255,F.KEEP,F.KEEP,F.REPLACE),new rn([F.ONE,F.ONE,F.ONE,F.ONE],i.ao.transparent,[!1,!1,!1,!0],F.MIN),jt.disabled,g,"sdf",y,x,E,T,A,j,Z,!1);{let Y=$?qt.disabled:new qt({func:F.EQUAL,mask:255},255,255,F.KEEP,F.DECR,F.DECR),ae=$?d.colorModeForRenderPass():new rn([F.ONE_MINUS_DST_ALPHA,F.DST_ALPHA,F.ONE,F.ONE],i.ao.transparent,[!0,!0,!0,!0]);Na(J,d,t,o,h,z,Y,ae,jt.disabled,g,"color",y,x,E,T,A,j,Z,!1)}}function Pg(d){return[d[0]*i.eg,d[1]*i.eg,d[2]*i.eg,0]}function Og(d,t,o,h,g,y,x,E,T){let A=h.getSource(),M=o.globeSharedBuffers;if(!M)return;let L,R,F;if(t&&(L=h.getTile(t)),A instanceof i.aT?(R=A.texture,F=i.dJ(0,0,o.transform)):L&&t&&(R=L.texture,F=i.dJ(t.canonical.z,t.canonical.x,o.transform)),!R||!F)return;d||(F=i.cR(i.bB(),F,[1,-1,1]));let z=o.context,j=z.gl,q=g.paint.get("raster-resampling")==="nearest"?j.NEAREST:j.LINEAR,$=o.colorModeForDrapableLayerRenderPass(y),Z=x.defines;Z.push("GLOBE_POLES");let J=new Tt(j.LEQUAL,Tt.ReadWrite,o.depthRangeFor3D),Y=Float32Array.from(o.transform.expandedFarZProjMatrix),ae=Float32Array.from(i.bj(i.dI(new i.cC(0,0,0))));o.terrain&&o.terrain.prepareDrawTile(),z.activeTexture.set(j.TEXTURE0),R.bind(q,j.CLAMP_TO_EDGE),z.activeTexture.set(j.TEXTURE1),R.bind(q,j.CLAMP_TO_EDGE),"useMipmap"in R&&z.extTextureFilterAnisotropic&&o.transform.pitch>20&&j.texParameterf(j.TEXTURE_2D,z.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,z.extTextureFilterAnisotropicMax);let[Q,ce,se,ie]=t?M.getPoleBuffers(t.canonical.z,!1):M.getPoleBuffers(0,!0),ue=g.paint.get("raster-elevation"),be;d?(be=Q,o.renderDefaultNorthPole=ue!==0):(be=ce,o.renderDefaultSouthPole=ue!==0);let ye=Pg(x.mix),Pe=((Be,tt,Ie,me,Ve,De,Ge,ot,xt,Je,it,wt,mt)=>Kd(Be,tt,Ie,new Float32Array(16),new Float32Array(9),[0,0],me,[0,0],[0,0,0,0],1,{opacity:1,mix:0},De,[0,0],ot,2,Je,it,wt,1,0,mt))(Y,ae,F,i.aj(o.transform.zoom),0,g,0,ue,0,ye,x.offset,x.range,y),Se=o.getOrCreateProgram("raster",{defines:Z});o.uploadCommonUniforms(z,Se,null),Se.draw(o,j.TRIANGLES,J,T,$,E,Pe,g.id,be,se,ie)}function Jv(d){let t=d._nearZ,o=d.projection.farthestPixelDistance(d),h=o-t,g=.2*d.height,y=t+g;return[t,o,(y-g-t)/h,(y-t)/h]}function Z1(d,t,o,h){if(d)return t instanceof vr&&d instanceof dl?t.getTextureDescriptor(d,o,!0):{texture:d.texture,mix:Pg(h.mix),offset:h.offset,buffer:0,tileSize:1}}var X1=i.eh([{name:"a_index",type:"Int16",components:1}]);class ko{constructor(t,o,h,g){let y={width:h[0],height:h[1],data:null},x=t.gl;this.targetColorTexture=new i.T(t,y,x.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new i.T(t,y,x.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(o,g),this.lastInvalidatedAt=0}updateParticleTexture(t,o){if(this.particleTextureDimension===o.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let h=this.context.gl,g=o.width*o.height;this.particleTexture0=new i.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new i.T(this.context,o,h.RGBA8,{premultiply:!1,useMipmap:!1});let y=new i.ei;y.reserve(g);for(let x=0;x<g;x++)y.emplaceBack(x);this.particleIndexBuffer=this.context.createVertexBuffer(y,X1.members,!0),this.particleSegment=i.bf.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=o.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=i.o.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function Lg(d,t,o){if(!d)return null;let h=t.getTextureDescriptor(d,o,!0);if(!h)return null;let{texture:g,mix:y,offset:x,tileSize:E,buffer:T,format:A}=h;if(!g||!A)return null;let M=!1;return A==="uint32"&&(M=!0,y[3]=0,y=Nf(i.ej,y,[0,o.paint.get("raster-particle-max-speed")]),x=ka(i.ej,x,[0,o.paint.get("raster-particle-max-speed")])),{texture:g,textureOffset:[T/(E+2*T),E/(E+2*T)],tileSize:E,scalarData:M,scale:y,offset:x,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[A]]}}function fo(d){let t=d._nearZ,o=d.projection.farthestPixelDistance(d),h=o-t,g=.2*d.height,y=t+g;return[t,o,(y-g-t)/h,(y-t)/h]}let vl=new i.ao(1,0,0,1),Qv=new i.ao(0,1,0,1),Fg=new i.ao(0,0,1,1),kg=new i.ao(1,0,1,1),Ng=new i.ao(0,1,1,1);function zg(d,t,o,h,g,y){for(let x=0;x<o.length;x++)if(g){let A=new i.ao(h.r*.8,h.g*.8,h.b*.8,1);No(d,t,o[x],h,-1,-1,y),No(d,t,o[x],h,-1,1,y),No(d,t,o[x],h,1,1,y),No(d,t,o[x],h,1,-1,y),No(d,t,o[x],A,0,0,y)}else No(d,t,o[x],h,0,0,y)}function No(d,t,o,h,g,y,x){let E=d.context,T=d.transform,A=E.gl,M=T.projection.name==="globe",L=M?["PROJECTION_GLOBE_VIEW"]:[],R=i.by(o.projMatrix);if(M&&i.aj(T.zoom)>0){let ye=i.bi(o.canonical,T),Pe=i.ek(ye);R=i.aB(new Float32Array(16),T.globeMatrix,Pe),i.aB(R,T.projMatrix,R)}let F=i.bB();F[12]+=2*g/(i.o.devicePixelRatio*T.width),F[13]+=2*y/(i.o.devicePixelRatio*T.height),i.aB(R,F,R);let z=d.getOrCreateProgram("debug",{defines:L}),j=t.getTileByID(o.key);d.terrain&&d.terrain.setupElevationDraw(j,z);let q=Tt.disabled,$=qt.disabled,Z=d.colorModeForRenderPass(),J="$debug";E.activeTexture.set(A.TEXTURE0),d.emptyTexture.bind(A.LINEAR,A.CLAMP_TO_EDGE),M?j._makeGlobeTileDebugBuffers(d.context,T):j._makeDebugTileBoundsBuffers(d.context,T.projection);let Y=j._tileDebugBuffer||d.debugBuffer,ae=j._tileDebugIndexBuffer||d.debugIndexBuffer,Q=j._tileDebugSegments||d.debugSegments;if(z.draw(d,A.LINE_STRIP,q,$,Z,jt.disabled,Tg(R,h.toPremultipliedRenderColor(null)),J,Y,ae,Q,null,null,null,[j._globeTileDebugBorderBuffer]),x){let ye=j.latestRawTileData,Pe=Math.floor((ye&&ye.byteLength||0)/1024),Se=o.canonical.toString();o.overscaledZ!==o.canonical.z&&(Se+=` => ${o.overscaledZ}`),Se+=` ${j.state}`,Se+=` ${Pe}kb`,(function(Be,tt){Be.initDebugOverlayCanvas();let Ie=Be.debugOverlayCanvas,me=Be.context.gl,Ve=Be.debugOverlayCanvas.getContext("2d");Ve.clearRect(0,0,Ie.width,Ie.height),Ve.shadowColor="white",Ve.shadowBlur=2,Ve.lineWidth=1.5,Ve.strokeStyle="white",Ve.textBaseline="top",Ve.font="bold 36px Open Sans, sans-serif",Ve.fillText(tt,5,5),Ve.strokeText(tt,5,5),Be.debugOverlayTexture.update(Ie),Be.debugOverlayTexture.bind(me.LINEAR,me.CLAMP_TO_EDGE)})(d,Se)}let ce=t.getTile(o).tileSize,se=512/Math.min(ce,512)*(o.overscaledZ/T.zoom)*.5,ie=j._tileDebugTextBuffer||d.debugBuffer,ue=j._tileDebugTextIndexBuffer||d.quadTriangleIndexBuffer,be=j._tileDebugTextSegments||d.debugSegments;z.draw(d,A.TRIANGLES,q,$,rn.alphaBlended,jt.disabled,Tg(R,i.ao.transparent.toPremultipliedRenderColor(null),se),J,ie,ue,be,null,null,null,[j._globeTileDebugTextBuffer])}function ci(d,t,o,h){mu(d,0,t+o/2,d.transform.width,o,h)}function eh(d,t,o,h){mu(d,t-o/2,0,o,d.transform.height,h)}function mu(d,t,o,h,g,y){let x=d.context,E=x.gl;E.enable(E.SCISSOR_TEST),E.scissor(t*i.o.devicePixelRatio,o*i.o.devicePixelRatio,h*i.o.devicePixelRatio,g*i.o.devicePixelRatio),x.clear({color:y}),E.disable(E.SCISSOR_TEST)}let e0=i.eh([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:t0}=e0;function za(d,t,o,h){d.emplaceBack(t,o,h)}class Bg{constructor(t){this.vertexArray=new i.el,this.indices=new i.b0,za(this.vertexArray,-1,-1,1),za(this.vertexArray,1,-1,1),za(this.vertexArray,-1,1,1),za(this.vertexArray,1,1,1),za(this.vertexArray,-1,-1,-1),za(this.vertexArray,1,-1,-1),za(this.vertexArray,-1,1,-1),za(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,t0),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=i.bf.simpleSegment(0,0,36,12)}}function Is(d,t,o,h,g,y){let x=d.context.gl,E=t.paint.get("sky-atmosphere-color"),T=t.paint.get("sky-atmosphere-halo-color"),A=t.paint.get("sky-atmosphere-sun-intensity"),M=((L,R,F,z,j)=>({u_matrix_3f:L,u_sun_direction:R,u_sun_intensity:F,u_color_tint_r:[z.r,z.g,z.b,z.a],u_color_tint_m:[j.r,j.g,j.b,j.a],u_luminance:5e-5}))(i.en(i.dN(),h),g,A,E.toPremultipliedRenderColor(null),T.toPremultipliedRenderColor(null));x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_CUBE_MAP_POSITIVE_X+y,t.skyboxTexture,0),o.draw(d,x.TRIANGLES,Tt.disabled,qt.disabled,rn.unblended,jt.frontCW,M,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}let uc=i.eh([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class Ke{constructor(t){let o=new i.eo;o.emplaceBack(-1,1,1,0,0),o.emplaceBack(1,1,1,1,0),o.emplaceBack(1,-1,1,1,1),o.emplaceBack(-1,-1,1,0,1);let h=new i.b0;h.emplaceBack(0,1,2),h.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(o,uc.members),this.indexBuffer=t.createIndexBuffer(h),this.segments=i.bf.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}let dt=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class gu{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class zi{constructor(t){this.colorModeAlphaBlendedWriteRGB=new rn([1,Xi,1,Xi],i.ao.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new rn([1,0,1,0],i.ao.transparent,[!1,!1,!1,!0]),this.params=new gu,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){let o=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new Ke(o);let h=this.params.sizeRange,g=this.params.intensityRange,y=(function(M){let L=i.eq(30),R=[];for(let F=0;F<M;++F){let z=2*Math.PI*L(),j=Math.acos(1-2*L())-.5*Math.PI;R.push(i.d4(Math.cos(j)*Math.cos(z),Math.cos(j)*Math.sin(z),Math.sin(j)))}return R})(this.params.starsCount),x=i.eq(300),E=new i.ep,T=new i.b0,A=0;for(let M=0;M<y.length;++M){let L=i.c4([],y[M],200),R=Math.max(0,1+.01*h*(1*x()-.5)),F=Math.max(0,1+.01*g*(1*x()-.5));E.emplaceBack(L[0],L[1],L[2],-1,-1,R,F),E.emplaceBack(L[0],L[1],L[2],1,-1,R,F),E.emplaceBack(L[0],L[1],L[2],1,1,R,F),E.emplaceBack(L[0],L[1],L[2],-1,1,R,F),T.emplaceBack(A+0,A+1,A+2),T.emplaceBack(A+0,A+2,A+3),A+=4}this.starsVx=o.createVertexBuffer(E,dt.members),this.starsIdx=o.createIndexBuffer(T),this.starsSegments=i.bf.simpleSegment(0,0,E.length,T.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,o){let h=t.context,g=h.gl,y=t.transform,x=new Tt(g.LEQUAL,Tt.ReadOnly,[0,1]),E=i.aj(y.zoom),T=t.style.getLut(o.scope),A=o.properties.get("color-use-theme")==="none",M=o.properties.get("color").toNonPremultipliedRenderColor(A?null:T),L=o.properties.get("high-color-use-theme")==="none",R=o.properties.get("high-color").toNonPremultipliedRenderColor(L?null:T),F=o.properties.get("space-color-use-theme")==="none",z=o.properties.get("space-color").toNonPremultipliedRenderColor(F?null:T),j=5e-4,q=i.er(o.properties.get("horizon-blend"),0,1,j,.25),$=i.dD(t,h,y)&&q===j?y.worldSize/(2*Math.PI*1.025)-1:y.globeRadius,Z=t.frameCounter/1e3%1,J=i.ag(y.globeCenterInViewSpace),Y=Math.sqrt(Math.pow(J,2)-Math.pow($,2)),ae=Math.acos(Y/J),Q=ce=>{let se=y.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];ce&&se.push("ALPHA_PASS");let ie=t.getOrCreateProgram("globeAtmosphere",{defines:se}),ue=((ye,Pe,Se,Be,tt,Ie,me,Ve,De,Ge,ot,xt)=>({u_frustum_tl:ye,u_frustum_tr:Pe,u_frustum_br:Se,u_frustum_bl:Be,u_horizon:tt,u_transition:Ie,u_fadeout_range:me,u_atmosphere_fog_color:Ve.toArray01(),u_high_color:De.toArray01(),u_space_color:Ge.toArray01(),u_temporal_offset:ot,u_horizon_angle:xt}))(y.frustumCorners.TL,y.frustumCorners.TR,y.frustumCorners.BR,y.frustumCorners.BL,y.frustumCorners.horizon,E,q,M,R,z,Z,ae);t.uploadCommonUniforms(h,ie);let be=this.atmosphereBuffer;be&&ie.draw(t,g.TRIANGLES,x,qt.disabled,ce?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,jt.backCW,ue,ce?"atmosphere_glow_alpha":"atmosphere_glow",be.vertexBuffer,be.indexBuffer,be.segments)};Q(!1),Q(!0)}drawStars(t,o){let h=i.aA(o.properties.get("star-intensity"),0,1);if(h===0)return;let g=t.context,y=g.gl,x=t.transform,E=t.getOrCreateProgram("stars"),T=i.c6([]);i.c8(T,T,-x._pitch),i.c7(T,T,-x.angle),i.c8(T,T,i.an(x._center.lat)),i.es(T,T,-i.an(x._center.lng));let A=i.cb(new Float32Array(16),T),M=i.aB([],x.starsProjMatrix,A),L=i.en([],A),R=i.et([],L),F=[0,1,0];i.dP(F,F,R),i.c4(F,F,this.params.sizeMultiplier);let z=[1,0,0];i.dP(z,z,R),i.c4(z,z,this.params.sizeMultiplier);let j=(q=F,$=z,Z=h,{u_matrix:Float32Array.from(M),u_up:q,u_right:$,u_intensity_multiplier:Z});var q,$,Z;t.uploadCommonUniforms(g,E),this.starsVx&&this.starsIdx&&E.draw(t,y.TRIANGLES,Tt.disabled,qt.disabled,this.colorModeAlphaBlendedWriteRGB,jt.disabled,j,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Ee{constructor(){this.visibleTiles=[]}updateBorders(t,o){let h=[],g=[],y=t._getRenderableCoordinates(!1,!0);for(let T of y){let A=t.getTile(T);if(!A.hasData())continue;let M=A.getBucket(o);M&&(M.isEmpty()||(h.push(T.key),g.push({bucket:M,tileID:T.canonical})))}let x=h.length!==this.visibleTiles.length;if(!x){h.sort();for(let T=0;T<h.length;T++)if(h[T]!==this.visibleTiles[T]){x=!0;break}}if(!x)return;let E=new Set;this.visibleTiles=h,g.sort((T,A)=>T.tileID.z-A.tileID.z||T.tileID.x-A.tileID.x||T.tileID.y-A.tileID.y);for(let T of g){let A=new Array,M=new Array,L=T.bucket;for(let R of L.featuresOnBorder)E.has(R.featureId)?M.push(R.footprintIndex):(E.add(R.featureId),A.push(R.footprintIndex));L.updateFootprintHiddenFlags(A,i.eu,!1),L.updateFootprintHiddenFlags(M,i.eu,!0)}}}function Vg(d,t){let o=[...d],h=t.cameraWorldSizeForFog/t.worldSize,g=i.bz([]);return i.cR(g,g,[h,h,1]),i.aB(o,g,o),i.aB(o,t.worldToFogMatrix,o),o}function _u(d,t,o,h,g){let y=o.material,x=h.context,{baseColorTexture:E,metallicRoughnessTexture:T}=y.pbrMetallicRoughness,{normalTexture:A,occlusionTexture:M,emissionTexture:L}=y;function R(z,j,q){if(z&&(d.push(j),x.activeTexture.set(x.gl.TEXTURE0+q),z.gfxTexture)){let{minFilter:$,magFilter:Z,wrapS:J,wrapT:Y}=z.sampler;z.gfxTexture.bindExtraParam($,Z,J,Y)}}R(E,"HAS_TEXTURE_u_baseColorTexture",Fr.BaseColor),R(T,"HAS_TEXTURE_u_metallicRoughnessTexture",Fr.MetallicRoughness),R(A,"HAS_TEXTURE_u_normalTexture",Fr.Normal),R(M,"HAS_TEXTURE_u_occlusionTexture",Fr.Occlusion),R(L,"HAS_TEXTURE_u_emissionTexture",Fr.Emission),g&&(g.texture||(g.texture=new i.d_(h.context,g.image,[g.image.height,g.image.height,g.image.height],x.gl.RGBA8)),x.activeTexture.set(x.gl.TEXTURE0+Fr.LUT),g.texture&&g.texture.bind(x.gl.LINEAR,x.gl.CLAMP_TO_EDGE),d.push("APPLY_LUT_ON_GPU")),o.texcoordBuffer&&(d.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(o.texcoordBuffer)),o.colorBuffer&&(d.push(o.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(o.colorBuffer)),o.normalBuffer&&(d.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(o.normalBuffer)),o.pbrBuffer&&(d.push("HAS_ATTRIBUTE_a_pbr"),d.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(o.pbrBuffer)),y.alphaMode!=="OPAQUE"&&y.alphaMode!=="MASK"||d.push("UNPREMULT_TEXTURE_IN_SHADER"),y.defined||d.push("DIFFUSE_SHADED");let F=h.shadowRenderer;F&&(d.push("RENDER_SHADOWS","DEPTH_TEXTURE"),F.useNormalOffset&&d.push("NORMAL_OFFSET"))}function yu(d,t,o,h,g,y){let x=o.paint.get("model-opacity").constantOr(1),E=t.context,T=new Tt(t.context.gl.LEQUAL,d.isLightMesh?Tt.ReadOnly:Tt.ReadWrite,t.depthRangeFor3D),A=t.transform,M=d.mesh,L=M.material,R=L.pbrMetallicRoughness,F=t.style.fog,z;z=t.transform.projection.zAxisUnit==="pixels"?[...d.nodeModelMatrix]:i.aB([],h.zScaleMatrix,d.nodeModelMatrix),i.aB(z,h.negCameraPosMatrix,z);let j=i.bk([],z);i.ef(j,j);let q=o.paint.get("model-color-use-theme").constantOr("default")==="none",$=o.paint.get("model-emissive-strength").constantOr(0),Z=Uf(new Float32Array(d.worldViewProjection),new Float32Array(z),new Float32Array(j),null,t,x,R.baseColorFactor,L.emissiveFactor,R.metallicFactor,R.roughnessFactor,L,$,o,void 0,void 0,d.materialOverride,d.modelColor),J={defines:[]},Y=[],ae=t.shadowRenderer;ae&&(ae.useNormalOffset=!1),_u(J.defines,Y,M,t,q?null:o.lut);let Q=null;if(F){let ie=Vg(d.nodeModelMatrix,t.transform);if(Q=new Float32Array(ie),A.projection.name!=="globe"){let ue=M.aabb.min,be=M.aabb.max,[ye,Pe]=F.getOpacityForBounds(ie,ue[0],ue[1],be[0],be[1]);J.overrideFog=ye>=Ce||Pe>=Ce}}let ce=Fa(t,o.paint.get("model-cutoff-fade-range"));ce.shouldRenderCutoff&&J.defines.push("RENDER_CUTOFF");let se=t.getOrCreateProgram("model",J);t.uploadCommonUniforms(E,se,null,Q,ce),t.renderPass!=="shadow"&&ae&&ae.setupShadowsFromMatrix(d.nodeModelMatrix,se),se.draw(t,E.gl.TRIANGLES,T,g,y,M.material.doubleSided?jt.disabled:jt.backCCW,Z,o.id,M.vertexBuffer,M.indexBuffer,M.segments,o.paint,t.transform.zoom,void 0,Y)}function Yf(d,t,o){return d.type==="vector"?t.scope:o?"basemap":""}function Kf(d,t,o,h,g,y,x,E,T){let A=d.transform,M=!!t.isGeometryBloom&&t.isGeometryBloom;if(M&&d.renderPass==="shadow")return;let L=A.projection.name==="globe"?i.eC(o,A):[...o];i.aB(L,L,t.globalMatrix);let R=i.aB([],h,L);if(t.meshes)for(let F of t.meshes){let z=E.get(F.material.name);if(z&&z.opacity<=0)continue;if(F.material.alphaMode!=="BLEND"){x.push({mesh:F,depth:0,modelIndex:g,worldViewProjection:R,nodeModelMatrix:L,isLightMesh:M,materialOverride:z,modelColor:T});continue}let j=i.af([],F.centroid,R);!A.isOrthographic&&j[2]<=0||y.push({mesh:F,depth:j[2],modelIndex:g,worldViewProjection:R,nodeModelMatrix:L,isLightMesh:M,materialOverride:z,modelColor:T})}if(t.children)for(let F of t.children)Kf(d,F,o,h,g,y,x,E,T)}function vu(d,t,o,h){let g=o.shadowRenderer;if(!g)return;let y=g.getShadowPassDepthMode(),x=g.getShadowPassColorMode(),E=g.calculateShadowPassMatrixFromMatrix(t),T=fu(E);o.getOrCreateProgram("modelDepth",{defines:o._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(o,o.context.gl.TRIANGLES,y,qt.disabled,x,jt.disabled,T,h.id,d.vertexBuffer,d.indexBuffer,d.segments,h.paint,o.transform.zoom,void 0,void 0)}function xu(d,t,o,h,g,y){for(let x of g){let E=Object.assign({},h);E.part=x;let T={type:"Unknown",id:t,properties:E},A={orientation:d.paint.get("model-rotation").evaluate(T,o)};y.set(x,A)}}function Y1(d,t,o,h,g,y){for(let x of g){let E=Object.assign({},h);E.part=x;let T={type:"Unknown",id:t,properties:E},A={color:d.paint.get("model-color").evaluate(T,o),colorMix:d.paint.get("model-color-mix-intensity").evaluate(T,o),opacity:d.paint.get("model-opacity").evaluate(T,o),emissionStrength:d.paint.get("model-emissive-strength").evaluate(T,o)};y.set(x,A)}}function n0(d,t,o,h,g,y){if(o===1)for(let E of g)yu(E,d,t,y[E.modelIndex],qt.disabled,d.colorModeForRenderPass());else{for(let E of g)yu(E,d,t,y[E.modelIndex],qt.disabled,rn.disabled);for(let E of g)yu(E,d,t,y[E.modelIndex],d.stencilModeFor3D(),d.colorModeForRenderPass());d.resetStencilClippingMasks()}let x=rn.additive;for(let E of h)yu(E,d,t,y[E.modelIndex],qt.disabled,E.isLightMesh?x:d.colorModeForRenderPass())}function i0(d,t,o){let h=t.updateZoomBasedPaintProperties(),g=(function(y,x,E){let T,A,M,L=y.terrain?y.terrain.exaggeration():0;if(y.terrain&&L>0){let R=y.terrain,F=R.findDEMTileFor(E);F&&F.dem?T=i.eE.create(R,E,F):L=0}if(L===0&&(x.terrainElevationMin=0,x.terrainElevationMax=0),L===x.validForExaggeration&&(L===0||T&&T._demTile&&T._demTile.tileID===x.validForDEMTile.id&&T._dem._timestamp===x.validForDEMTile.timestamp))return!1;for(let R in x.instancesPerModel){let F=x.instancesPerModel[R];for(let z=0;z<F.instancedDataArray.length;++z){let j=(T?L*T.getElevationAt(0|F.instancedDataArray.float32[16*z],0|F.instancedDataArray.float32[16*z+1],!0,!0):0)+F.instancesEvaluatedElevation[z];F.instancedDataArray.float32[16*z+6]=j,A=A?Math.min(x.terrainElevationMin,j):j,M=M?Math.max(x.terrainElevationMax,j):j}}return x.terrainElevationMin=A||0,x.terrainElevationMax=M||0,x.validForExaggeration=L,x.validForDEMTile=T&&T._demTile?{id:T._demTile.tileID,timestamp:T._dem._timestamp}:{id:void 0,timestamp:0},!0})(d,t,o);(h||g)&&(t.uploaded=!1,t.upload(d.context))}let Ko={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new i.d8([0,0,0],[i.al,i.al,0])};function jg(d,t){let o=1<<d.canonical.z,h=t.getFreeCameraOptions().position,g=t.elevation,y=d.canonical.x/o,x=(d.canonical.x+1)/o,E=d.canonical.y/o,T=(d.canonical.y+1)/o,A=t._centerAltitude;if(g){let F=g.getMinMaxForTile(d);F&&F.max>A&&(A=F.max)}let M=i.aA(h.x,y,x)-h.x,L=i.aA(h.y,E,T)-h.y,R=i.ce(A,t.center.lat)-h.z;return t._zoomFromMercatorZ(Math.sqrt(M*M+L*L+R*R))}function Ug(d,t,o,h,g,y,x){let E=d.context,T=d.renderPass==="shadow",A=d.shadowRenderer,M=T&&A?A.getShadowPassDepthMode():new Tt(E.gl.LEQUAL,Tt.ReadWrite,d.depthRangeFor3D),L=d.isTileAffectedByFog(y),R=d.transform.projection.name==="globe";if(o.meshes)for(let F of o.meshes){let z=R?[]:["MODEL_POSITION_ON_GPU"],j=[],q,$,Z,J=!R&&h.instancedDataArray.length>20;J&&z.push("INSTANCED_ARRAYS");let Y=Fa(d,t.paint.get("model-cutoff-fade-range"));if(Y.shouldRenderCutoff&&z.push("RENDER_CUTOFF"),T&&A)q=d.getOrCreateProgram("modelDepth",{defines:z}),$=fu(x.shadowTileMatrix,x.shadowTileMatrix,Float32Array.from(o.globalMatrix)),Z=A.getShadowPassColorMode();else{_u(z,j,F,d,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),q=d.getOrCreateProgram("model",{defines:z,overrideFog:L});let Q=F.material,ce=Q.pbrMetallicRoughness,se=t.paint.get("model-opacity").constantOr(1),ie=t.paint.get("model-emissive-strength").constantOr(0);$=Uf(y.expandedProjMatrix,Float32Array.from(o.globalMatrix),new Float32Array(16),null,d,se,ce.baseColorFactor,Q.emissiveFactor,ce.metallicFactor,ce.roughnessFactor,Q,ie,t,g),A&&(x.shadowUniformsInitialized?q.setShadowUniformValues(E,A.getShadowUniformValues()):(A.setupShadows(y.toUnwrapped(),q,"model-tile"),x.shadowUniformsInitialized=!0)),Z=Y.shouldRenderCutoff||se<1||Q.alphaMode!=="OPAQUE"?rn.alphaBlended:rn.unblended}d.uploadCommonUniforms(E,q,y.toUnwrapped(),null,Y);let ae=F.material.doubleSided?jt.disabled:jt.backCCW;if(J)j.push(h.instancedDataBuffer),q.draw(d,E.gl.TRIANGLES,M,qt.disabled,Z,ae,$,t.id,F.vertexBuffer,F.indexBuffer,F.segments,t.paint,d.transform.zoom,void 0,j,h.instancedDataArray.length);else{let Q=T?"u_instance":"u_normal_matrix";for(let ce=0;ce<h.instancedDataArray.length;++ce)$[Q]=new Float32Array(h.instancedDataArray.arrayBuffer,64*ce,16),q.draw(d,E.gl.TRIANGLES,M,qt.disabled,Z,ae,$,t.id,F.vertexBuffer,F.indexBuffer,F.segments,t.paint,d.transform.zoom,void 0,j)}}if(o.children)for(let F of o.children)Ug(d,t,F,h,g,y,x)}let r0=[1,-1,1];function Jf(d,t,o,h){if(!o.modelManager)return!0;let g=o.modelManager;if(!o.shadowRenderer)return!0;let y=o.shadowRenderer,x=t.aabb,E=!0,T=d.maxHeight;if(T===0){let M=0;for(let L in d.instancesPerModel){let R=g.getModel(L,h);R?M=Math.max(M,Math.max(Math.max(R.aabb.max[0],R.aabb.max[1]),R.aabb.max[2])):E=!1}T=d.maxScale*M*1.41+d.maxVerticalOffset,E&&(d.maxHeight=T)}x.max[2]=T,x.min[2]+=d.terrainElevationMin,x.max[2]+=d.terrainElevationMax,i.af(x.min,x.min,t.tileMatrix),i.af(x.max,x.max,t.tileMatrix);let A=x.intersects(y.getCurrentCascadeFrustum());return o.currentShadowCascade===0&&(d.isInsideFirstShadowMapFrustum=A===2),A===0}function th(d,t){let o=d.uniformValues.u_cutoff_params[0],h=d.uniformValues.u_cutoff_params[1],g=d.uniformValues.u_cutoff_params[2],y=d.uniformValues.u_cutoff_params[3];return h===o||y===g?1:i.aA(((t-o)/(h-o)-g)/(y-g),0,1)}function dc(d,t,o,h){if(t.pitch<20)return 1;let g=t.getWorldToCameraMatrix();i.aB(g,g,d);let y=i.bT(o.min[0],o.min[1],o.min[2],1),x=i.aC(i.eF(),y,g),E=x,T=x;y[1]=o.max[1],x=i.aC(i.eF(),y,g),E=x[1]<E[1]?x:E,T=x[1]>T[1]?x:T,y[0]=o.max[0],x=i.aC(i.eF(),y,g),E=x[1]<E[1]?x:E,T=x[1]>T[1]?x:T,y[1]=o.min[1],x=i.aC(i.eF(),y,g),E=x[1]<E[1]?x:E,T=x[1]>T[1]?x:T;let A=i.aA(h[0],0,1),M=100*t.pixelsPerMeter*i.aA(h[1],0,1),L=i.aA(h[2],0,1),R=i.eG(i.eF(),E,T,A),F=Math.tan(.5*t.fovX),z=-R[2]*F;if(M===0)return R[1]<-Math.abs(z)?L:1;let j=(-Math.abs(z)-R[1])/M,q=(Z,J,Y)=>(1-Y)*Z+Y*J,$=i.aA(q(1,L,j),L,1);return q(1,$,i.aA((t.pitch-20)/20,0,1))}class o0{}class s0{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,o,h){{let L=this._storage.get(o.id);if(L)return L.lastUsedFrameIdx=t,L.buf}let g=h.gl,y=g.getBufferParameter(g.ELEMENT_ARRAY_BUFFER,g.BUFFER_SIZE),x=new ArrayBuffer(y),E=new Int16Array(x);g.getBufferSubData(g.ELEMENT_ARRAY_BUFFER,0,new Int16Array(x));let T=new i.eI;for(let L=0;L<y/2;L+=3){let R=E[L],F=E[L+1],z=E[L+2];T.emplaceBack(R,F),T.emplaceBack(F,z),T.emplaceBack(z,R)}let A=h.bindVertexArrayOES.current,M=new o0;return M.buf=new Zv(h,T),M.lastUsedFrameIdx=t,this._storage.set(o.id,M),h.bindVertexArrayOES.set(A),M.buf}update(t){for(let[o,h]of this._storage)t-h.lastUsedFrameIdx>30&&(h.buf.destroy(),this._storage.delete(o))}destroy(){for(let[t,o]of this._storage)o.buf.destroy(),this._storage.delete(t)}}class K1{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}let a0=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class J1{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class io{constructor(t,o){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...o,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...o,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}let Q1=i.eh([{type:"Float32",name:"a_pos_2f",components:2}]);class nh{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,o){let h=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let x=new i.eJ,E=new i.b0;x.emplaceBack(-1,-1),x.emplaceBack(1,-1),x.emplaceBack(1,1),x.emplaceBack(-1,1),E.emplaceBack(0,1,2),E.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(x,Q1.members),this.vignetteIdx=t.context.createIndexBuffer(E)}let g=i.bf.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,h);let x={u_vignetteShape:(y={vignetteShape:[o.start,o.range,Math.pow(10,o.fadePower)],vignetteColor:[o.color.r,o.color.g,o.color.b,o.color.a*o.strength]}).vignetteShape,u_vignetteColor:y.vignetteColor};h.draw(t,t.context.gl.TRIANGLES,Tt.disabled,qt.disabled,rn.alphaBlended,jt.disabled,x,"vignette",this.vignetteVx,this.vignetteIdx,g)}var y}}class mi{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,o){let h=t.getFreeCameraOptions().position,g=h.toAltitude(),y=h.toLngLat(),x=i.an(y.lng),E=i.an(y.lat),T=t.pixelsPerMeter/o,A=x*i.eL,M=i.eL*Math.log(Math.tan(Math.PI/4+E/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let L=-this._offsetYPrev+M,R=-this._elevationPrev+g;this._accumulatedOffsetX+=(-this._offsetXPrev+A)*T,this._accumulatedOffsetY+=L*T,this._accumulatedElevation+=R*T,this._offsetXPrev=A,this._offsetYPrev=M,this._elevationPrev=g}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function hn(d,t){return[-(d[0]-Math.floor(d[0]/t)*t),-(d[1]-Math.floor(d[1]/t)*t),-(d[2]-Math.floor(d[2]/t)*t)]}function Hg(d){let t=i.eq(1323123451230),o=[];for(let h=0;h<d;++h){let g=2*t()-1,y=2*t()-1,x=2*t()-1;o.push(i.d4(g,y,x))}return o}function To(d,t,o,h,g){let y=i.aA((g-o)/(h-o),0,1);return(1-y)*d+y*t}class hc{constructor(t){this._movement=new mi,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new nh,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,o){let h=t.transform;this._movement.update(h,this._ppmScaleFactor);let g=h.starsProjMatrix,y=i.c6([]);i.c8(y,y,i.an(90)-h._pitch),i.c7(y,y,-h.angle);let x=i.cb(new Float32Array(16),y),E=i.eK(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),T=i.ef([],E),A=i.aB([],T,x),M=Date.now()/1e3;return this._accumulatedTimeFromStart+=(M-this._prevTime)*o,this._prevTime=M,{projectionMatrix:g,modelviewMatrix:A}}}class bu extends hc{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new io(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=Hg(this.particlesCount),g=new i.eM,y=new i.b0,x=0,E=i.eq(1323123451230);for(let T=0;T<h.length;++T){let A=h[T],M=[2*E()-1,E(),E(),E()];g.emplaceBack(A[0],A[1],A[2],-1,-1,...M),g.emplaceBack(A[0],A[1],A[2],1,-1,...M),g.emplaceBack(A[0],A[1],A[2],1,1,...M),g.emplaceBack(A[0],A[1],A[2],-1,1,...M),y.emplaceBack(x+0,x+1,x+2),y.emplaceBack(x+0,x+2,x+3),x+=4}this.particlesVx=o.createVertexBuffer(g,a0.members),this.particlesIdx=o.createIndexBuffer(y)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;let o=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},h=t.transform.zoom;if(o.revealStart>h)return;let g=To(0,1,o.revealStart,o.revealStart+o.revealRange,h);if(!this.particlesVx||!this.particlesIdx)return;let y=structuredClone(this._params),x=[-y.direction.x,y.direction.y,-100];i.aw(x,x);let E=structuredClone(this._vignetteParams);E.strength*=g,y.overrideStyleParameters||(y.intensity=t.style.rain.state.density,y.timeFactor=t.style.rain.state.intensity,y.color=structuredClone(t.style.rain.state.color),x=structuredClone(t.style.rain.state.direction),y.screenThinning.intensity=t.style.rain.state.centerThinning,y.dropletSizeX=t.style.rain.state.dropletSize[0],y.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],y.distortionStrength=100*t.style.rain.state.distortionStrength,E.strength=1,E.color=structuredClone(t.style.rain.state.vignetteColor));let T=this.updateOnRender(t,y.timeFactor),A=t.context,M=A.gl,L=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new i.T(A,{width:t.width,height:t.height,data:null},M.RGBA8)),y.distortionStrength>0&&(A.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),M.copyTexSubImage2D(M.TEXTURE_2D,0,0,0,0,0,t.width,t.height));let R=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(A,R),A.activeTexture.set(M.TEXTURE0),this.screenTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE);let F=[y.color.r,y.color.g,y.color.b,y.color.a],z=(j,q)=>{let $=hn(this._movement.getPosition(),j),Z=y.dropletSizeX,J=y.dropletSizeX*y.dropletSizeYScale,Y=t.width/2,ae=t.height/2,Q=To(0,y.screenThinning.start,0,1,y.screenThinning.intensity),ce=To(.001,y.screenThinning.range,0,1,y.screenThinning.intensity),se=To(0,y.screenThinning.particleOffset,0,1,y.screenThinning.intensity),ie=(ue={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:$,velocityConeAperture:y.velocityConeAperture,velocity:y.velocity,boxSize:j,rainDropletSize:[Z,J],distortionStrength:y.distortionStrength,rainDirection:x,color:F,screenSize:[L.width,L.height],thinningCenterPos:[Y,ae],thinningShape:[Q,ce,Math.pow(10,y.screenThinning.fadePower)],thinningAffectedRatio:y.screenThinning.affectedRatio,thinningParticleOffset:se,shapeDirectionalPower:y.shapeDirPower,shapeNormalPower:y.shapeNormalPower,mode:q?0:1},{u_modelview:Float32Array.from(ue.modelview),u_projection:Float32Array.from(ue.projection),u_time:ue.time,u_cam_pos:ue.camPos,u_texScreen:0,u_velocityConeAperture:ue.velocityConeAperture,u_velocity:ue.velocity,u_boxSize:ue.boxSize,u_rainDropletSize:ue.rainDropletSize,u_distortionStrength:ue.distortionStrength,u_rainDirection:ue.rainDirection,u_color:ue.color,u_screenSize:ue.screenSize,u_thinningCenterPos:ue.thinningCenterPos,u_thinningShape:ue.thinningShape,u_thinningAffectedRatio:ue.thinningAffectedRatio,u_thinningParticleOffset:ue.thinningParticleOffset,u_shapeDirectionalPower:ue.shapeDirectionalPower,u_shapeNormalPower:ue.shapeNormalPower,u_mode:ue.mode});var ue;let be=Math.round(y.intensity*this.particlesCount),ye=i.bf.simpleSegment(0,0,4*be,2*be);R.draw(t,M.TRIANGLES,Tt.disabled,qt.disabled,rn.alphaBlended,jt.disabled,ie,"rain_particles",this.particlesVx,this.particlesIdx,ye)};y.distortionStrength>0&&z(y.boxSize,!0),z(y.boxSize,!1),this._vignette.draw(t,E)}}let Ba=i.eh([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class $g extends hc{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new io(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){let o=t.context;if(!this.particlesVx){let h=Hg(this.particlesCount),g=new i.eN,y=new i.b0,x=0,E=i.eq(1323123451230);for(let T=0;T<h.length;++T){let A=h[T],M=E(),L=E(),R=E(),F=[T/h.length,M,L,R],z=[E(),E()];g.emplaceBack(A[0],A[1],A[2],-1,-1,...F,...z),g.emplaceBack(A[0],A[1],A[2],1,-1,...F,...z),g.emplaceBack(A[0],A[1],A[2],1,1,...F,...z),g.emplaceBack(A[0],A[1],A[2],-1,1,...F,...z),y.emplaceBack(x+0,x+1,x+2),y.emplaceBack(x+0,x+2,x+3),x+=4}this.particlesVx=o.createVertexBuffer(g,Ba.members),this.particlesIdx=o.createIndexBuffer(y)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;let o=structuredClone(this._params),h=[-o.direction.x,o.direction.y,-100];i.aw(h,h);let g=structuredClone(this._vignetteParams),y=o.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},x=t.transform.zoom;if(y.revealStart>x)return;let E=To(0,1,y.revealStart,y.revealStart+y.revealRange,x);g.strength*=E,o.overrideStyleParameters||(o.intensity=t.style.snow.state.density,o.timeFactor=t.style.snow.state.intensity,o.color=structuredClone(t.style.snow.state.color),h=structuredClone(t.style.snow.state.direction),o.screenThinning.intensity=t.style.snow.state.centerThinning,o.billboardSize=2.79*t.style.snow.state.flakeSize,g.strength=1,g.color=structuredClone(t.style.snow.state.vignetteColor));let T=this.updateOnRender(t,o.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let A=t.context,M=A.gl,L=t.transform,R=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(A,R),((F,z,j)=>{let q=hn(this._movement.getPosition(),F),$=L.width/2,Z=L.height/2,J=To(0,j.screenThinning.start,0,1,j.screenThinning.intensity),Y=To(.001,j.screenThinning.range,0,1,j.screenThinning.intensity),ae=To(0,j.screenThinning.particleOffset,0,1,j.screenThinning.intensity),Q=(ce={modelview:T.modelviewMatrix,projection:T.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:q,velocityConeAperture:j.velocityConeAperture,velocity:j.velocity,horizontalOscillationRadius:j.horizontalOscillationRadius,horizontalOscillationRate:j.horizontalOscillationRate,boxSize:F,billboardSize:1*j.billboardSize,simpleShapeParameters:[j.shapeFadeStart,j.shapeFadePower],screenSize:[L.width,L.height],thinningCenterPos:[$,Z],thinningShape:[J,Y,Math.pow(10,j.screenThinning.fadePower)],thinningAffectedRatio:j.screenThinning.affectedRatio,thinningParticleOffset:ae,color:[j.color.r,j.color.g,j.color.b,j.color.a],direction:h},{u_modelview:Float32Array.from(ce.modelview),u_projection:Float32Array.from(ce.projection),u_time:ce.time,u_cam_pos:ce.camPos,u_velocityConeAperture:ce.velocityConeAperture,u_velocity:ce.velocity,u_horizontalOscillationRadius:ce.horizontalOscillationRadius,u_horizontalOscillationRate:ce.horizontalOscillationRate,u_boxSize:ce.boxSize,u_billboardSize:ce.billboardSize,u_simpleShapeParameters:ce.simpleShapeParameters,u_screenSize:ce.screenSize,u_thinningCenterPos:ce.thinningCenterPos,u_thinningShape:ce.thinningShape,u_thinningAffectedRatio:ce.thinningAffectedRatio,u_thinningParticleOffset:ce.thinningParticleOffset,u_particleColor:ce.color,u_direction:ce.direction});var ce;let se=Math.round(j.intensity*this.particlesCount),ie=i.bf.simpleSegment(0,0,4*se,2*se);this.particlesVx&&this.particlesIdx&&R.draw(t,M.TRIANGLES,Tt.disabled,qt.disabled,rn.alphaBlended,jt.disabled,Q,"snow_particles",this.particlesVx,this.particlesIdx,ie)})(o.boxSize,0,o),this._vignette.draw(t,g)}}let Gg={symbol:function(d,t,o,h,g){if(d.renderPass!=="translucent")return;let y=qt.disabled,x=d.colorModeForRenderPass(),E=o.layout.get("text-variable-anchor"),T=o.layout.get("text-size-scale-range"),A=i.aA(d.scaleFactor,T[0],T[1]);E&&(function(R,F,z,j,q,$,Z,J){let Y=F.transform,ae=q==="map",Q=$==="map";for(let ce of R){let se=j.getTile(ce),ie=se.getBucket(z);if(!ie||!ie.text||!ie.text.segments.get().length)continue;let ue=i.bJ(ie.textSizeData,Y.zoom,J),be=hf(ce,ie.getProjection(),Y),ye=Y.calculatePixelsToTileUnitsMatrix(se),Pe=Xc(be,se.tileID.canonical,Q,ae,Y,ie.getProjection(),ye),Se=ie.hasIconTextFit()&&ie.hasIconData();ue&&qf(ie,ae,Q,Z,Y,Pe,ce,Math.pow(2,Y.zoom-se.tileID.overscaledZ),ue,Se)}})(h,d,o,t,o.layout.get("text-rotation-alignment"),o.layout.get("text-pitch-alignment"),g,A);let M=o.paint.get("icon-opacity").constantOr(1)!==0,L=o.paint.get("text-opacity").constantOr(1)!==0;o.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(M||L)?Qd(d,t,o,h,y,x):(M&&Qd(d,t,o,h,y,x,{onlyIcons:!0}),L&&Qd(d,t,o,h,y,x,{onlyText:!0})),t.map.showCollisionBoxes&&(Jd(d,t,o,h,o.paint.get("text-translate"),o.paint.get("text-translate-anchor"),!0),Jd(d,t,o,h,o.paint.get("icon-translate"),o.paint.get("icon-translate-anchor"),!1))},circle:function(d,t,o,h){if(d.renderPass!=="translucent")return;let g=o.paint.get("circle-opacity"),y=o.paint.get("circle-stroke-width"),x=o.paint.get("circle-stroke-opacity"),E=o.layout.get("circle-sort-key").constantOr(1)!==void 0,T=o.paint.get("circle-emissive-strength");if(g.constantOr(1)===0&&(y.constantOr(1)===0||x.constantOr(1)===0))return;let A=d.context,M=A.gl,L=d.transform,R=!(!d.terrain||!d.terrain.enabled),F=o.layout.get("circle-elevation-reference"),z=d.depthModeForSublayer(0,Tt.ReadOnly),j=new Tt(d.context.gl.LEQUAL,Tt.ReadOnly,d.depthRangeFor3D),q=F==="none"||R?z:j,$=qt.disabled,Z=d.colorModeForDrapableLayerRenderPass(T),J=L.projection.name==="globe",Y=[i.aF(L.center.lng),i.aJ(L.center.lat)],ae=[];for(let ce=0;ce<h.length;ce++){let se=h[ce],ie=t.getTile(se),ue=ie.getBucket(o);if(!ue||ue.projection.name!==L.projection.name)continue;let be=ue.programConfigurations.get(o.id),ye=ue.layoutVertexBuffer,Pe=ue.globeExtVertexBuffer,Se=ue.indexBuffer,Be=i.d$(o),tt=[Pe],Ie=d.isTileAffectedByFog(se);J&&Be.push("PROJECTION_GLOBE_VIEW"),Be.push("DEPTH_D24"),d.terrain&&L.depthOcclusionForSymbolsAndCircles&&Be.push("DEPTH_OCCLUSION"),ue.hasElevation&&!d.terrain&&(Be.push("ELEVATED_ROADS"),tt.push(ue.elevatedLayoutVertexBuffer));let me=d.getOrCreateProgram("circle",{config:be,defines:Be,overrideFog:Ie}),Ve=L.projection.createInversionMatrix(L,se.canonical),De={programConfiguration:be,program:me,layoutVertexBuffer:ye,dynamicBuffers:tt,indexBuffer:Se,uniformValues:i.e0(d,se,ie,Ve,Y,o),tile:ie};if(E){let Ge=ue.segments.get();for(let ot of Ge)ae.push({segments:new i.bf([ot]),sortKey:ot.sortKey,state:De})}else ae.push({segments:ue.segments,sortKey:0,state:De})}E&&ae.sort((ce,se)=>ce.sortKey-se.sortKey);let Q={useDepthForOcclusion:L.depthOcclusionForSymbolsAndCircles};for(let ce of ae){let{programConfiguration:se,program:ie,layoutVertexBuffer:ue,dynamicBuffers:be,indexBuffer:ye,uniformValues:Pe,tile:Se}=ce.state,Be=ce.segments;d.terrain&&d.terrain.setupElevationDraw(Se,ie,Q),d.uploadCommonUniforms(A,ie,Se.tileID.toUnwrapped()),ie.draw(d,M.TRIANGLES,q,$,Z,jt.disabled,Pe,o.id,ue,ye,Be,o.paint,L.zoom,se,be)}},heatmap:function(d,t,o,h){if(o.paint.get("heatmap-opacity")!==0)if(d.renderPass==="offscreen"){let g=d.context,y=g.gl,x=qt.disabled,E=new rn([y.ONE,y.ONE,y.ONE,y.ONE],i.ao.transparent,[!0,!0,!0,!0]);(function(F,z,j,q){let $=F.gl,Z=z.width*q,J=z.height*q;F.activeTexture.set($.TEXTURE1),F.viewport.set([0,0,Z,J]);let Y=j.heatmapFbo;if(!Y||Y&&(Y.width!==Z||Y.height!==J)){Y&&Y.destroy();let ae=$.createTexture();$.bindTexture($.TEXTURE_2D,ae),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MIN_FILTER,$.LINEAR),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MAG_FILTER,$.LINEAR),Y=j.heatmapFbo=F.createFramebuffer(Z,J,!0,null),(function(Q,ce,se,ie,ue,be){let ye=Q.gl;ye.texImage2D(ye.TEXTURE_2D,0,Q.extRenderToTextureHalfFloat?ye.RGBA16F:ye.RGBA,ue,be,0,ye.RGBA,Q.extRenderToTextureHalfFloat?ye.HALF_FLOAT:ye.UNSIGNED_BYTE,null),ie.colorAttachment.set(se)})(F,0,ae,Y,Z,J)}else $.bindTexture($.TEXTURE_2D,Y.colorAttachment.get()),F.bindFramebuffer.set(Y.framebuffer)})(g,d,o,d.transform.projection.name==="globe"?.5:.25),g.clear({color:i.ao.transparent});let T=d.transform,A=T.projection.name==="globe",M=A?["PROJECTION_GLOBE_VIEW"]:[],L=A?jt.frontCCW:jt.disabled,R=[i.aF(T.center.lng),i.aJ(T.center.lat)];for(let F=0;F<h.length;F++){let z=h[F];if(t.hasRenderableParent(z))continue;let j=t.getTile(z),q=j.getBucket(o);if(!q||q.projection.name!==T.projection.name)continue;let $=d.isTileAffectedByFog(z),Z=q.programConfigurations.get(o.id),J=d.getOrCreateProgram("heatmap",{config:Z,defines:M,overrideFog:$}),{zoom:Y}=d.transform;d.terrain&&d.terrain.setupElevationDraw(j,J),d.uploadCommonUniforms(g,J,z.toUnwrapped());let ae=T.projection.createInversionMatrix(T,z.canonical);J.draw(d,y.TRIANGLES,Tt.disabled,x,E,L,Wv(d,z,j,ae,R,Y,o.paint.get("heatmap-intensity")),o.id,q.layoutVertexBuffer,q.indexBuffer,q.segments,o.paint,d.transform.zoom,Z,A?[q.globeExtVertexBuffer]:null)}g.viewport.set([0,0,d.width,d.height])}else d.renderPass==="translucent"&&(d.context.setColorMode(d.colorModeForRenderPass()),(function(g,y){let x=g.context,E=x.gl,T=y.heatmapFbo;if(!T)return;x.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,T.colorAttachment.get()),x.activeTexture.set(E.TEXTURE1);let A=y.colorRampTexture;A||(A=y.colorRampTexture=new i.T(x,y.colorRamp,E.RGBA8)),A.bind(E.LINEAR,E.CLAMP_TO_EDGE),g.getOrCreateProgram("heatmapTexture").draw(g,E.TRIANGLES,Tt.disabled,qt.disabled,g.colorModeForRenderPass(),jt.disabled,((M,L,R,F)=>({u_image:0,u_color_ramp:1,u_opacity:L.paint.get("heatmap-opacity")}))(0,y),y.id,g.viewportBuffer,g.quadTriangleIndexBuffer,g.viewportSegments,y.paint,g.transform.zoom)})(d,o))},line:function(d,t,o,h){if(d.renderPass!=="translucent")return;let g=o.paint.get("line-opacity"),y=o.paint.get("line-width");if(g.constantOr(1)===0||y.constantOr(1)===0)return;let x=o.paint.get("line-emissive-strength"),E=o.paint.get("line-occlusion-opacity"),T=o.layout.get("line-elevation-reference"),A=o.layout.get("line-width-unit")==="meters",M=T==="sea",L=!(!d.terrain||!d.terrain.enabled),R=d.context,F=R.gl;if(o.hasElevatedBuckets&&d.transform.projection.name==="globe")return;let z=o.layout.get("line-cross-slope"),j=z!==void 0,q=z<1,$=d.colorModeForDrapableLayerRenderPass(x),Z=d.terrain&&d.terrain.renderingToTexture,J=Z?1:i.o.devicePixelRatio,Y=o.paint.get("line-dasharray"),ae=Y.constantOr(1),Q=o.layout.get("line-cap"),ce=Y.constantOr(null),se=Q.constantOr(null),ie=o.paint.get("line-pattern"),ue=ie.constantOr(1),be=o.paint.get("line-pattern-cross-fade"),ye=ie.constantOr(null),Pe=o.paint.get("line-opacity").constantOr(1),Se=!ue&&Pe!==1||d.depthOcclusion&&E>0&&E<1,Be=o.paint.get("line-gradient"),tt=ue?"linePattern":"line",Ie=i.e1(o),me;if(Z&&d.terrain&&d.terrain.clipOrMaskOverlapStencilType()&&(Se=!1),E!==0&&d.depthOcclusion){let ot=o.paint._values["line-opacity"];ot&&ot.value&&ot.value.kind==="constant"?me=ot.value:i.w(`Occlusion opacity for layer ${o.id} is supported only when line-opacity isn't data-driven.`)}y.value.kind!=="constant"&&y.value.isLineProgressConstant===!1&&Ie.push("VARIABLE_LINE_WIDTH");let Ve=(ot,xt,Je,it,wt,mt)=>{for(let ht of ot){let gt=t.getTile(ht);if(ue&&!gt.patternsLoaded())continue;let Ot=gt.getBucket(o);if(!Ot||Ot.elevationType!=="none"&&!wt||Ot.elevationType==="none"&&wt)continue;d.prepareDrawTile();let fn=[...xt],vn=d.shadowRenderer,Zn=Ot.elevationType==="road"&&!!vn&&vn.enabled,Ut=[0,0,0];if(Zn){let $t=d.style.directionalLight,wn=d.style.ambientLight;$t&&wn&&(Ut=ws(d.style,$t,wn)),fn.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}let yn=Ot.programConfigurations.get(o.id),en=!1;if(ye&&gt.imageAtlas){let $t=i.e2.from(ye),wn=$t.getPrimary().scaleSelf(J).toString(),Ti=gt.imageAtlas.patternPositions.get(wn),$i=$t.getSecondary(),Ai=$i?gt.imageAtlas.patternPositions.get($i.scaleSelf(J).toString()):null;en=!!Ti&&!!Ai,Ti&&yn.setConstantPatternPositions(Ti,Ai)}be>0&&(en||yn.getPatternTransitionVertexBuffer("line-pattern"))&&fn.push("LINE_PATTERN_TRANSITION");let jn=d.isTileAffectedByFog(ht),xn=d.getOrCreateProgram(tt,{config:yn,defines:fn,overrideFog:jn});if(!ue&&ce&&se&&gt.lineAtlas){let $t=gt.lineAtlas.getDash(ce,se);$t&&yn.setConstantPatternPositions($t)}Zn&&vn.setupShadows(gt.tileID.toUnwrapped(),xn,"vector-tile");let[oi,Sn]=o.paint.get("line-trim-offset");(se==="round"||se==="square")&&oi!==Sn&&(oi===0&&(oi-=1),Sn===1&&(Sn+=1));let nn=Z?ht.projMatrix:null,On=A?1/Ot.tileToMeter/i.ay(gt,1,d.transform.zoom):1,on=A?1/Ot.tileToMeter/i.ay(gt,1,Math.floor(d.transform.zoom)):1,ui=ue?i.e3(d,gt,o,nn,J,On,on,[oi,Sn],Ut,be):i.e4(d,gt,o,nn,Ot.lineClipsArray.length,J,On,on,[oi,Sn],Ut);if(Be){let $t=Ot.gradients[o.id],wn=$t.texture;if(o.gradientVersion!==$t.version){let Ti=256;if(o.stepInterpolant){let $i=t.getSource().maxzoom,Ai=ht.canonical.z===$i?Math.ceil(1<<d.transform.maxZoom-ht.canonical.z):1;Ti=i.aA(i.e5(Ot.maxLineLength/i.al*1024*Ai),256,R.maxTextureSize)}$t.gradient=i.e6({expression:o.gradientExpression(),evaluationKey:"lineProgress",resolution:Ti,image:$t.gradient||void 0,clips:Ot.lineClipsArray}),$t.texture?$t.texture.update($t.gradient):$t.texture=new i.T(R,$t.gradient,F.RGBA8),$t.version=o.gradientVersion,wn=$t.texture}R.activeTexture.set(F.TEXTURE1),wn.bind(o.stepInterpolant?F.NEAREST:F.LINEAR,F.CLAMP_TO_EDGE)}ae&&(R.activeTexture.set(F.TEXTURE0),gt.lineAtlasTexture&&gt.lineAtlasTexture.bind(F.LINEAR,F.REPEAT),yn.updatePaintBuffers()),ue&&(R.activeTexture.set(F.TEXTURE0),gt.imageAtlasTexture&&gt.imageAtlasTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),yn.updatePaintBuffers()),wt&&!M&&d.terrain.setupElevationDraw(gt,xn),d.uploadCommonUniforms(R,xn,ht.toUnwrapped());let kn=$t=>{me!=null&&(me.value=Pe*E),xn.draw(d,F.TRIANGLES,Je,$t,$,jt.disabled,ui,o.id,Ot.layoutVertexBuffer,Ot.indexBuffer,Ot.segments,o.paint,d.transform.zoom,yn,[Ot.layoutVertexBuffer2,Ot.patternVertexBuffer,Ot.zOffsetVertexBuffer]),me!=null&&(me.value=Pe)};if(Se&&!wt){let $t=d.stencilModeForClipping(ht).ref;$t===0&&Z&&R.clear({stencil:0});let wn={func:F.EQUAL,mask:255};ui.u_alpha_discard_threshold=.8,kn(new qt(wn,$t,255,F.KEEP,F.KEEP,F.INVERT)),ui.u_alpha_discard_threshold=0,kn(new qt(wn,$t,255,F.KEEP,F.KEEP,F.KEEP))}else ui.u_alpha_discard_threshold=Se&&wt&&mt?.8:0,kn(wt?it:d.stencilModeForClipping(ht))}},De=d.depthModeForSublayer(0,Tt.ReadOnly),Ge=new Tt(d.depthOcclusion?F.GREATER:F.LEQUAL,Tt.ReadOnly,d.depthRangeFor3D);if(o.hasNonElevatedBuckets){let ot=!Z&&d.terrain;E!==0&&ot?i.w(`Occlusion opacity for layer ${o.id} is supported on terrain only if the layer has line-z-offset enabled.`):ot?i.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${o.id}.`):Ve(h,Ie,De,qt.disabled,!1,!0)}if(o.hasElevatedBuckets){T==="hd-road-markup"?L||(De=Ge,Ie.push("ELEVATED_ROADS")):(Ie.push("ELEVATED"),De=Ge,j&&Ie.push(q?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),M&&Ie.push("ELEVATION_REFERENCE_SEA"));let ot=Se?d.stencilModeFor3D():qt.disabled;d.forceTerrainMode=!0,Ve(h,Ie,De,ot,!0,!0),Se&&Ve(h,Ie,De,ot,!0,!1),d.forceTerrainMode=!1}Se&&(d.resetStencilClippingMasks(),Z&&R.clear({stencil:0})),E===0||d.depthOcclusion||Z||d.layersWithOcclusionOpacity.push(d.currentLayer)},fill:function(d,t,o,h){let g=o.paint.get("fill-color"),y=o.paint.get("fill-opacity");if(y.constantOr(1)===0)return;let x=o.paint.get("fill-emissive-strength"),E=d.colorModeForDrapableLayerRenderPass(x),T=o.paint.get("fill-pattern"),A=d.opaquePassEnabledForLayer()&&!T.constantOr(1)&&g.constantOr(i.ao.transparent).a===1&&y.constantOr(0)===1?"opaque":"translucent",M="none";o.layout.get("fill-elevation-reference")!=="none"?M="road":o.paint.get("fill-z-offset").constantOr(1)!==0&&(M="offset");let L=!(!d.terrain||!d.terrain.enabled),R={painter:d,sourceCache:t,layer:o,coords:h,colorMode:E,elevationType:M,terrainEnabled:L,pass:A};if(d.renderPass!=="shadow")if(M!=="offset"){if(pu(R,!1),M==="road"){let F=!L&&d.renderPass==="translucent";F&&cc(d,t,o,h,"geometry"),pu(R,!0,qt.disabled),F&&(function(z){let{painter:j,sourceCache:q,layer:$,coords:Z,colorMode:J}=z,Y=j.context.gl,ae=z.painter.shadowRenderer,Q=!!ae&&ae.enabled,ce=new Tt(j.context.gl.LEQUAL,Tt.ReadOnly,j.depthRangeFor3D),se=[0,0,0];if(Q){let ue=j.style.directionalLight,be=j.style.ambientLight;ue&&be&&(se=ws(j.style,ue,be))}let ie=ue=>{for(let be of Z){let ye=q.getTile(be),Pe=ye.getBucket($);if(!Pe)continue;let Se=Pe.elevatedStructures;if(!Se)continue;let Be,tt;if(ue?(Be=Se.renderableBridgeSegments,tt=Se.bridgeProgramConfigurations.get($.id)):(Be=Se.renderableTunnelSegments,tt=Se.tunnelProgramConfigurations.get($.id)),!Be||Be.segments[0].primitiveLength===0)continue;tt.updatePaintBuffers(),j.prepareDrawTile();let Ie=j.isTileAffectedByFog(be),me=[];Q&&me.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");let Ve=j.getOrCreateProgram("elevatedStructures",{config:tt,overrideFog:Ie,defines:me}),De=j.translatePosMatrix(be.projMatrix,ye,$.paint.get("fill-translate"),$.paint.get("fill-translate-anchor"));Q&&ae.setupShadows(ye.tileID.toUnwrapped(),Ve,"vector-tile");let Ge=G1(De,se);j.uploadCommonUniforms(j.context,Ve,be.toUnwrapped()),Ve.draw(j,Y.TRIANGLES,ce,qt.disabled,J,jt.backCCW,Ge,$.id,Se.vertexBuffer,Se.indexBuffer,Be,$.paint,j.transform.zoom,tt,[Se.vertexBufferNormal])}};ie(!0),ie(!1)})(R)}}else pu(R,!1,d.stencilModeFor3D());else d.shadowRenderer&&M==="road"&&!L&&(function(F){let{painter:z,sourceCache:j,layer:q,coords:$}=F,Z=z.context.gl,J=F.painter.shadowRenderer;for(let Y of $){let ae=j.getTile(Y),Q=ae.getBucket(q);if(!Q)continue;let ce=Q.elevatedStructures;if(!ce||!ce.shadowCasterSegments||ce.shadowCasterSegments.segments[0].primitiveLength===0)continue;z.prepareDrawTile();let se=Q.bufferData.programConfigurations.get(q.id),ie=z.isTileAffectedByFog(Y),ue=z.getOrCreateProgram("elevatedStructuresDepth",{config:se,overrideFog:ie}),be=J.calculateShadowPassMatrixFromTile(ae.tileID.toUnwrapped());z.uploadCommonUniforms(z.context,ue,Y.toUnwrapped());let ye={u_matrix:be,u_depth_bias:0};ue.draw(z,Z.TRIANGLES,J.getShadowPassDepthMode(),qt.disabled,J.getShadowPassColorMode(),jt.disabled,ye,q.id,ce.vertexBuffer,ce.indexBuffer,ce.shadowCasterSegments,q.paint,z.transform.zoom,se)}})(R)},"fill-extrusion":function(d,t,o,h){let g=o.paint.get("fill-extrusion-opacity"),y=d.context,x=y.gl,E=d.terrain,T=E&&E.renderingToTexture;if(g===0)return;let A=d.conflationActive&&d.style.isLayerClipped(o,t.getSource()),M=d.style.order.indexOf(o.fqid);if(A&&(function(L,R,F,z,j){for(let q of z){let $=R.getTile(q).getBucket(F);$&&($.updateReplacement(q,L.replacementSource,j),$.uploadCentroid(L.context))}})(d,t,o,h,M),E||A)for(let L of h){let R=t.getTile(L).getBucket(o);R&&_l(d.context,t,L,R,o,E,A)}if(d.renderPass==="shadow"&&d.shadowRenderer){let L=d.shadowRenderer;if(E&&g<.65&&o._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof i.ad)return;let R=L.getShadowPassDepthMode(),F=L.getShadowPassColorMode();vt(d,t,o,h,R,qt.disabled,F,A)}else if(d.renderPass==="translucent"){let L=!o.paint.get("fill-extrusion-pattern").constantOr(1),R=o.paint.get("fill-extrusion-color").constantOr(i.ao.white);if(!T&&R.a!==0){let F=new Tt(d.context.gl.LEQUAL,Tt.ReadWrite,d.depthRangeFor3D);g===1&&L?vt(d,t,o,h,F,qt.disabled,rn.unblended,A):(vt(d,t,o,h,F,qt.disabled,rn.disabled,A),vt(d,t,o,h,F,d.stencilModeFor3D(),d.colorModeForRenderPass(),A),d.resetStencilClippingMasks())}if(d.style.enable3dLights()&&L&&(!E&&d.transform.projection.name!=="globe"||T)){let F=o.paint.get("fill-extrusion-opacity"),z=o.paint.get("fill-extrusion-ambient-occlusion-intensity"),j=o.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),q=o.paint.get("fill-extrusion-flood-light-intensity"),$=o.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Z=o.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor($?null:o.lut).toArray01().slice(0,3),J=z>0&&j>0,Y=q>0,ae=(se,ie,ue)=>(1-ue)*se+ue*ie,Q=new Mg;Q.translate=o.paint.get("fill-extrusion-translate"),Q.translateAnchor=o.paint.get("fill-extrusion-translate-anchor"),Q.edgeRadius=o.layout.get("fill-extrusion-edge-radius"),Q.cutoffFadeRange=o.paint.get("fill-extrusion-cutoff-fade-range");let ce=se=>{let ie=d.depthModeForSublayer(1,Tt.ReadOnly,x.LEQUAL,!0),ue=o.paint.get(se?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),be=ae(.1,3,ue),ye=d._showOverdrawInspector;if(!ye){let Pe=new qt({func:x.ALWAYS,mask:255},255,255,x.KEEP,x.KEEP,x.REPLACE),Se=new rn([x.ONE,x.ONE,x.ONE,x.ONE],i.ao.transparent,[!1,!1,!1,!0],x.MIN);Na(Q,d,t,o,h,ie,Pe,Se,jt.disabled,se,"sdf",F,z,j,q,Z,be,A,!1)}{let Pe=ye?qt.disabled:new qt({func:x.EQUAL,mask:255},255,255,x.KEEP,x.DECR,x.DECR),Se=ye?d.colorModeForRenderPass():new rn([x.ONE_MINUS_DST_ALPHA,x.DST_ALPHA,x.ONE,x.ONE],i.ao.transparent,[!0,!0,!0,!0]);Na(Q,d,t,o,h,ie,Pe,Se,jt.disabled,se,"color",F,z,j,q,Z,be,A,!1)}};if(T){let se=(ie,ue,be)=>{let ye=d.depthModeForSublayer(1,Tt.ReadOnly,x.LEQUAL,!1),Pe=o.paint.get(ie?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Se=ae(.1,3,Pe);{let Be=new rn([x.ONE,x.ONE,x.ONE,x.ONE],i.ao.transparent,[!1,!1,!1,!0]);Na(Q,d,t,o,h,ye,qt.disabled,Be,jt.disabled,ie,"clear",F,z,j,q,Z,Se,A,ue)}{let Be=new qt({func:x.ALWAYS,mask:255},255,255,x.KEEP,x.KEEP,x.REPLACE),tt=new rn([x.ONE,x.ONE,x.ONE,x.ONE],i.ao.transparent,[!1,!1,!1,!0],x.MIN);Na(Q,d,t,o,h,ye,Be,tt,jt.disabled,ie,"sdf",F,z,j,q,Z,Se,A,ue)}{let Be=ie?x.ZERO:x.ONE_MINUS_DST_ALPHA,tt=new qt({func:x.EQUAL,mask:255},255,255,x.KEEP,x.DECR,x.DECR),Ie=new rn([Be,x.DST_ALPHA,x.ONE_MINUS_DST_ALPHA,x.ZERO],i.ao.transparent,[!0,!0,!0,!0]);Na(Q,d,t,o,h,ye,tt,Ie,jt.disabled,ie,"color",F,z,j,q,Z,Se,A,ue)}{let Be=new rn([x.ONE,x.ONE,x.ONE,ie?x.ZERO:x.ONE],i.ao.transparent,[!1,!1,!1,!0],ie?x.FUNC_ADD:x.MAX);Na(Q,d,t,o,h,ye,qt.disabled,Be,jt.disabled,ie,"clear",F,z,j,q,Z,Se,A,ue,be)}};if(J||Y){let ie;if(d.prepareDrawTile(),E){let ue=E.drapeBufferSize[0],be=E.drapeBufferSize[1];ie=E.framebufferCopyTexture,ie&&(!ie||ie.size[0]===ue&&ie.size[1]===be)||(ie&&ie.destroy(),ie=E.framebufferCopyTexture=new i.T(y,new i.q({width:ue,height:be}),x.RGBA8)),ie.bind(x.LINEAR,x.CLAMP_TO_EDGE),x.copyTexSubImage2D(x.TEXTURE_2D,0,0,0,0,0,ue,be)}J&&se(!0,!1,ie),Y&&se(!1,!0,ie)}}else J&&ce(!0),Y&&ce(!1),(J||Y)&&d.resetStencilClippingMasks()}}},building:function(d,t,o,h){d.currentLayer<d.firstLightBeamLayer&&(d.firstLightBeamLayer=d.currentLayer);let g=o.paint.get("building-ambient-occlusion-ground-intensity"),y=o.paint.get("building-ambient-occlusion-ground-radius"),x=o.paint.get("building-ambient-occlusion-ground-attenuation"),E=o.paint.get("building-opacity");if(E<=0)return;let T=g>0&&y>0,A=!0,M=o.paint.get("building-vertical-scale");if(M<=0)return;(!d.shadowRenderer||M<1)&&(A=!1);let L=d.conflationActive&&d.style.isLayerClipped(o,t.getSource()),R=d.style.order.indexOf(o.fqid);if((function(F,z,j,q,$,Z){for(let J of Z){let Y=z.getTile(J).getBucket(j);Y&&($&&Y.updateReplacement(J,F.replacementSource,q),Y.uploadUpdatedIndexBuffer(F.context))}})(d,t,o,R,L,h),(function(F,z,j,q){for(let $ of q){let Z=z.getTile($).getBucket(j);Z&&Z.needsEvaluation()&&Z.uploadUpdatedColorBuffer(F.context)}})(d,t,o,h),o.resetLayerRenderingStats(d),d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!0),d.renderPass==="shadow"&&d.shadowRenderer){let F=d.shadowRenderer,z=[],j=F.getShadowPassDepthMode();Zf({painter:d,source:t,layer:o,coords:h,defines:z,blendMode:F.getShadowPassColorMode(),depthMode:j,opacity:E,verticalScale:M,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}else if(d.renderPass==="translucent"){let F=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];A&&(F=F.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),d.shadowRenderer&&d.shadowRenderer.useNormalOffset&&(F=F.concat("NORMAL_OFFSET"));let z=o.paint.get("building-facade-emissive-chance"),j=o.paint.get("building-ambient-occlusion-intensity"),q=o.paint.get("building-flood-light-intensity"),$=o.paint.get("building-flood-light-color-use-theme").constantOr("default")==="none",Z=o.paint.get("building-flood-light-color").toNonPremultipliedRenderColor($?null:o.lut).toArray01().slice(0,3),J=o.paint.get("building-flood-light-ground-attenuation"),Y=q>0,ae=new Tt(d.context.gl.LEQUAL,Tt.ReadWrite,d.depthRangeFor3D);E<1&&Zf({painter:d,source:t,layer:o,coords:h,defines:F,blendMode:rn.disabled,depthMode:ae,opacity:E,verticalScale:M,facadeEmissiveChance:z,facadeAOIntensity:j,floodLightIntensity:q,floodLightColor:Z,depthOnly:!0});let Q=d.colorModeForRenderPass();Zf({painter:d,source:t,layer:o,coords:h,defines:F,blendMode:Q,depthMode:ae,opacity:E,verticalScale:M,facadeEmissiveChance:z,facadeAOIntensity:j,floodLightIntensity:q,floodLightColor:Z}),T&&Xf(d,t,o,h,!0,E,g,y,q,Z,x,L),Y&&Xf(d,t,o,h,!1,E,g,y,q,Z,J,L)}else if(d.renderPass==="light-beam"){let F=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],z=new Tt(d.context.gl.LEQUAL,Tt.ReadOnly,d.depthRangeFor3D);Zf({painter:d,source:t,layer:o,coords:h,defines:F,blendMode:rn.alphaBlended,depthMode:z,opacity:E,verticalScale:M,facadeEmissiveChance:0,facadeAOIntensity:0,floodLightIntensity:0,floodLightColor:[0,0,0]})}d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!1),d.resetStencilClippingMasks()},hillshade:function(d,t,o,h){if(d.renderPass!=="offscreen"&&d.renderPass!=="translucent"||d.style.disableElevatedTerrain)return;let g=d.context,y=d.terrain&&d.terrain.renderingToTexture,[x,E]=d.renderPass!=="translucent"||y?[{},h]:d.stencilConfigForOverlap(h);for(let T of E){let A=t.getTile(T);if(A.needsHillshadePrepare&&d.renderPass==="offscreen")L1(d,A,o);else if(d.renderPass==="translucent"){let M=d.depthModeForSublayer(0,Tt.ReadOnly),L=o.paint.get("hillshade-emissive-strength"),R=d.colorModeForDrapableLayerRenderPass(L),F=y&&d.terrain?d.terrain.stencilModeForRTTOverlap(T):x[T.overscaledZ];O1(d,T,A,o,M,F,R)}}g.viewport.set([0,0,d.width,d.height]),d.resetStencilClippingMasks()},raster:function(d,t,o,h,g,y){if(d.renderPass!=="translucent"||o.paint.get("raster-opacity")===0)return;let x=d.transform.projection.name==="globe",E=o.paint.get("raster-elevation")!==0,T=E&&x;if(d.renderElevatedRasterBackface&&!T)return;let A=d.context,M=A.gl,L=t.getSource(),R=(function(Q,ce,se,ie){let ue=ce.paint.get("raster-color"),be=Q.type==="raster-array",ye=[],Pe=ce.paint.get("raster-resampling"),Se=ce.paint.get("raster-color-mix"),Be=ce.paint.get("raster-color-range"),tt=[Se[0],Se[1],Se[2],0],Ie=Se[3],me=Pe==="nearest"?ie.NEAREST:ie.LINEAR;if(be&&(ye.push("RASTER_ARRAY"),ue||ye.push("RASTER_COLOR"),Pe==="linear"&&ye.push("RASTER_ARRAY_LINEAR"),me=ie.NEAREST,!Be&&Q.rasterLayers)){let Ve=Q.rasterLayers.find(({id:De})=>De===ce.sourceLayer);Ve&&Ve.fields&&Ve.fields.range&&(Be=Ve.fields.range)}if(Be=Be||[0,1],ue){ye.push("RASTER_COLOR"),se.activeTexture.set(ie.TEXTURE2),ce.updateColorRamp(Be);let Ve=ce.colorRampTexture;Ve||(Ve=ce.colorRampTexture=new i.T(se,ce.colorRamp,ie.RGBA8)),Ve.bind(ie.LINEAR,ie.CLAMP_TO_EDGE)}return{mix:tt,range:Be,offset:Ie,defines:ye,resampling:me}})(L,o,A,M);if(L instanceof i.aT&&!h.length&&!x)return;let F=o.paint.get("raster-emissive-strength"),z=d.colorModeForDrapableLayerRenderPass(F),j=d.terrain&&d.terrain.renderingToTexture,q=!d.options.moving,$=o.paint.get("raster-resampling")==="nearest"?M.NEAREST:M.LINEAR;if(L instanceof i.aT&&!h.length&&(L.onNorthPole||L.onSouthPole)){let Q=E?d.stencilModeFor3D():qt.disabled;return void Og(!!L.onNorthPole,null,d,t,o,F,R,jt.disabled,Q)}if(!h.length)return;let[Z,J]=L instanceof i.aT||j?[{},h]:d.stencilConfigForOverlap(h),Y=J[J.length-1].overscaledZ;T&&R.defines.push("PROJECTION_GLOBE_VIEW"),E&&R.defines.push("RENDER_CUTOFF");let ae=(Q,ce,se)=>{for(let ie of Q){let ue=ie.toUnwrapped(),be=t.getTile(ie);if(j&&(!be||!be.hasData()))continue;A.activeTexture.set(M.TEXTURE0);let ye=Z1(be,L,o,R);if(!ye||!ye.texture)continue;let{texture:Pe,mix:Se,offset:Be,tileSize:tt,buffer:Ie}=ye,me,Ve;j?(me=Tt.disabled,Ve=ie.projMatrix):E?(me=new Tt(M.LEQUAL,Tt.ReadWrite,d.depthRangeFor3D),Ve=x?Float32Array.from(d.transform.expandedFarZProjMatrix):d.transform.calculateProjMatrix(ue,q)):(me=d.depthModeForSublayer(ie.overscaledZ-Y,o.paint.get("raster-opacity")===1?Tt.ReadWrite:Tt.ReadOnly,M.LESS),Ve=d.transform.calculateProjMatrix(ue,q));let De=d.terrain&&j?d.terrain.stencilModeForRTTOverlap(ie):Z[ie.overscaledZ],Ge=y?0:o.paint.get("raster-fade-duration");be.registerFadeDuration(Ge);let ot=t.findLoadedParent(ie,0),xt=Pf(be,ot,t,d.transform,Ge),Je,it;!xt.isFading&&be.refreshedUponExpiration&&(be.refreshedUponExpiration=!1),d.terrain&&d.terrain.prepareDrawTile(),A.activeTexture.set(M.TEXTURE0),Pe.bind($,M.CLAMP_TO_EDGE),A.activeTexture.set(M.TEXTURE1),ot?(ot.texture&&ot.texture.bind($,M.CLAMP_TO_EDGE),Je=Math.pow(2,ot.tileID.overscaledZ-be.tileID.overscaledZ),it=[be.tileID.canonical.x*Je%1,be.tileID.canonical.y*Je%1]):Pe.bind($,M.CLAMP_TO_EDGE),"useMipmap"in Pe&&A.extTextureFilterAnisotropic&&d.transform.pitch>20&&M.texParameterf(M.TEXTURE_2D,A.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,A.extTextureFilterAnisotropicMax);let wt=d.transform,mt,ht=E?Jv(wt):[0,0,0,0],gt,Ot,fn,vn,Zn,Ut=0;if(T&&L instanceof i.aT&&L.coordinates.length>3)gt=Float32Array.from(i.bj(i.dI(new i.cC(0,0,0)))),Ot=Float32Array.from(wt.globeMatrix),fn=Float32Array.from(i.dE(wt)),vn=[i.aF(wt.center.lng),i.aJ(wt.center.lat)],mt=L.elevatedGlobePerspectiveTransform,Zn=L.elevatedGlobeGridMatrix||new Float32Array(9);else if(T){let xn=i.dF(ie.canonical);Ut=i.dG(xn.getCenter().lat),gt=Float32Array.from(i.bj(i.dI(ie.canonical))),Ot=Float32Array.from(wt.globeMatrix),fn=Float32Array.from(i.dE(wt)),vn=[i.aF(wt.center.lng),i.aJ(wt.center.lat)],mt=[0,0],Zn=Float32Array.from(i.dH(ie.canonical,xn,Ut,wt.worldSize/wt._pixelsPerMercatorPixel))}else mt=L instanceof i.aT?L.perspectiveTransform:[0,0],gt=new Float32Array(16),Ot=new Float32Array(9),fn=new Float32Array(16),vn=[0,0],Zn=new Float32Array(9);let yn=Kd(Ve,gt,Ot,fn,Zn,it||[0,0],i.aj(d.transform.zoom),vn,ht,Je||1,xt,o,mt,E?o.paint.get("raster-elevation"):0,2,Se,Be,R.range,tt,Ie,F),en=d.isTileAffectedByFog(ie),jn=d.getOrCreateProgram("raster",{defines:R.defines,overrideFog:en});if(d.uploadCommonUniforms(A,jn,ue),L instanceof i.aT){let xn=L.elevatedGlobeVertexBuffer,oi=L.elevatedGlobeIndexBuffer;if(j||!x)L.boundsBuffer&&L.boundsSegments&&jn.draw(d,M.TRIANGLES,me,qt.disabled,z,jt.disabled,yn,o.id,L.boundsBuffer,d.quadTriangleIndexBuffer,L.boundsSegments);else if(xn&&oi){let Sn=wt.zoom<=i.cZ?L.elevatedGlobeSegments:L.getSegmentsForLongitude(wt.center.lng);Sn&&jn.draw(d,M.TRIANGLES,me,qt.disabled,z,ce,yn,o.id,xn,oi,Sn)}}else if(T){me=new Tt(M.LEQUAL,Tt.ReadOnly,d.depthRangeFor3D);let xn=d.globeSharedBuffers;if(xn){let[oi,Sn,nn]=xn.getGridBuffers(Ut,!1);jn.draw(d,M.TRIANGLES,me,se||De,d.colorModeForRenderPass(),ce,yn,o.id,oi,Sn,nn)}}else{let{tileBoundsBuffer:xn,tileBoundsIndexBuffer:oi,tileBoundsSegments:Sn}=d.getTileBoundsBuffers(be);jn.draw(d,M.TRIANGLES,me,De,z,jt.disabled,yn,o.id,xn,oi,Sn)}}if(!(L instanceof i.aT)&&T)for(let ie of Q){let ue=ie.canonical.y===(1<<ie.canonical.z)-1;ie.canonical.y===0&&Og(!0,ie,d,t,o,F,R,ce,se||qt.disabled),ue&&Og(!1,ie,d,t,o,F,R,ce===jt.frontCW?jt.backCW:jt.frontCW,se||qt.disabled)}};T?ae(J,d.renderElevatedRasterBackface?jt.backCW:jt.frontCW,d.stencilModeFor3D()):ae(J,jt.disabled,void 0),d.resetStencilClippingMasks()},"raster-particle":function(d,t,o,h,g,y){d.renderPass==="offscreen"&&(function(x,E,T,A){if(!A.length)return;let M=x.context,L=M.gl,R=E.getSource();if(!(R instanceof vr))return;let F=Math.ceil(Math.sqrt(T.paint.get("raster-particle-count"))),z=T.particlePositionRGBAImage;if(!z||z.width!==F){let J=(function(Y){let ae=Y*Y,Q=new Uint8Array(4*ae),ce=function(ie){return ie|=0,ie=Math.imul(2747636419^ie,2654435769),ie=Math.imul(ie^ie>>>16,2654435769),((ie=Math.imul(ie^ie>>>16,2654435769))>>>0)/4294967296},se=1/1.1;for(let ie=0;ie<ae;ie++){let ue=se*(ce(2*ie+0)+lc),be=se*(ce(2*ie+1)+lc),ye=255*ue%1,Pe=255*be%1,Se=ye,Be=be-Pe/255,tt=Pe;Q[4*ie+0]=255*(ue-ye/255),Q[4*ie+1]=255*Se,Q[4*ie+2]=255*Be,Q[4*ie+3]=255*tt}return Q})(F);z=T.particlePositionRGBAImage=new i.q({width:F,height:F},J)}let j=T.particleFramebuffer;j?j.width!==F&&(j.destroy(),j=T.particleFramebuffer=M.createFramebuffer(F,F,!0,null)):j=T.particleFramebuffer=M.createFramebuffer(F,F,!0,null);let q=[];for(let J of A){let Y=E.getTile(J);if(!(Y instanceof dl))continue;let ae=Lg(Y,R,T);if(!ae)continue;let Q=[Y.tileSize,Y.tileSize],ce=T.tileFramebuffer;ce||(ce=T.tileFramebuffer=M.createFramebuffer(Q[0],Q[1],!0,null));let se=Y.rasterParticleState;se||(se=Y.rasterParticleState=new ko(M,J,Q,z));let ie=se.update(T.lastInvalidatedAt);se.particleTextureDimension!==F&&se.updateParticleTexture(J,z);let ue=se.targetColorTexture;se.targetColorTexture=se.backgroundColorTexture,se.backgroundColorTexture=ue;let be=se.particleTexture0;se.particleTexture0=se.particleTexture1,se.particleTexture1=be,q.push([J,ae,se,ie])}if(q.length===0)return;let $=i.o.now(),Z=T.previousDrawTimestamp?.001*($-T.previousDrawTimestamp):.0167;if(T.previousDrawTimestamp=$,T.hasColorMap()){M.activeTexture.set(L.TEXTURE0+2);let J=T.colorRampTexture;J||(J=T.colorRampTexture=new i.T(M,T.colorRamp,L.RGBA8)),J.bind(L.LINEAR,L.CLAMP_TO_EDGE)}M.bindFramebuffer.set(T.tileFramebuffer.framebuffer),(function(J,Y,ae){let Q=J.context,ce=Q.gl,se=Y.tileFramebuffer;Q.activeTexture.set(ce.TEXTURE0);let ie={u_texture:0,u_opacity:1.05*(be=Y.paint.get("raster-particle-fade-opacity-factor"))/(be+.05)},ue=J.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var be;for(let ye of ae){let[,,Pe,Se]=ye;se.colorAttachment.set(Pe.targetColorTexture.texture),Q.viewport.set([0,0,se.width,se.height]),Q.clear({color:i.ao.transparent}),Se&&(Pe.backgroundColorTexture.bind(ce.NEAREST,ce.CLAMP_TO_EDGE),ue.draw(J,ce.TRIANGLES,Tt.disabled,qt.disabled,rn.alphaBlended,jt.disabled,ie,Y.id,J.viewportBuffer,J.quadTriangleIndexBuffer,J.viewportSegments))}})(x,T,q),(function(J,Y,ae,Q){let ce=J.context,se=ce.gl,ie=ae.tileFramebuffer,ue=J.transform.projection.name==="globe",be=ae.paint.get("raster-particle-max-speed");for(let ye of Q){let[Pe,Se,Be]=ye;ce.activeTexture.set(se.TEXTURE0+0),Se.texture.bind(se.LINEAR,se.CLAMP_TO_EDGE),ie.colorAttachment.set(Be.targetColorTexture.texture);let tt=J.getOrCreateProgram("rasterParticleDraw",{defines:Se.defines,overrideFog:!1});ce.activeTexture.set(se.TEXTURE0+1);let Ie=Se.scalarData?[]:[0,1,2,3].map(De=>i.e8[De](Pe));Ie.push(Pe);let me=Pe.canonical.x,Ve=Pe.canonical.y;for(let De of Ie){let Ge=Y.getTile(ue?De.wrapped():De);if(!Ge)continue;let ot=Ge.rasterParticleState;if(!ot)continue;let xt=De.canonical.x+(1<<De.canonical.z)*(De.wrap-Pe.wrap),Je=De.canonical.y;ot.particleTexture0.bind(se.NEAREST,se.CLAMP_TO_EDGE);let it=Ig(1,ot.particleTexture0.size[0],[xt-me,Je-Ve],0,Se.texture.size,2,be,Se.textureOffset,Se.scale,Se.offset);tt.draw(J,se.POINTS,Tt.disabled,qt.disabled,rn.alphaBlended,jt.disabled,it,ae.id,ot.particleIndexBuffer,void 0,ot.particleSegment)}}})(x,E,T,q),M.bindFramebuffer.set(T.particleFramebuffer.framebuffer),(function(J,Y,ae,Q){let ce=J.context,se=ce.gl,ie=Y.paint.get("raster-particle-max-speed"),ue=Q*Y.paint.get("raster-particle-speed-factor")*.15,be=(function(Pe){return Math.pow(Pe,6)})(.01+1*Y.paint.get("raster-particle-reset-rate-factor")),ye=Y.particleFramebuffer;ce.viewport.set([0,0,ye.width,ye.height]);for(let Pe of ae){let[,Se,Be]=Pe;ce.activeTexture.set(se.TEXTURE0+0),Se.texture.bind(se.LINEAR,se.CLAMP_TO_EDGE),ce.activeTexture.set(se.TEXTURE0+1);let tt=Be.particleTexture0;tt.bind(se.NEAREST,se.CLAMP_TO_EDGE);let Ie=Bf(1,tt.size[0],0,Se.texture.size,ie,ue,be,Se.textureOffset,Se.scale,Se.offset);ye.colorAttachment.set(Be.particleTexture1.texture),ce.clear({color:i.ao.transparent}),J.getOrCreateProgram("rasterParticleUpdate",{defines:Se.defines}).draw(J,se.TRIANGLES,Tt.disabled,qt.disabled,rn.unblended,jt.disabled,Ie,Y.id,J.viewportBuffer,J.quadTriangleIndexBuffer,J.viewportSegments)}})(x,T,q,Z)})(d,t,o,h),d.renderPass==="translucent"&&((function(x,E,T,A,M){let L=x.context,R=L.gl,F=E.getSource().tileSize,z=5*(1-i.ah(i.cK,i.cK+1,x.transform.zoom))*F+T.paint.get("raster-particle-elevation"),j=!x.options.moving,q=x.transform.projection.name==="globe";if(!A.length)return;let[$,Z]=x.stencilConfigForOverlap(A),J=[];q&&J.push("PROJECTION_GLOBE_VIEW");let Y=x.stencilModeFor3D();for(let ae of Z){let Q=ae.toUnwrapped(),ce=E.getTile(ae);if(!ce.rasterParticleState)continue;let se=ce.rasterParticleState,ie=100;ce.registerFadeDuration(ie);let ue=E.findLoadedParent(ae,0),be=Pf(ce,ue,E,x.transform,ie),ye,Pe;x.terrain&&x.terrain.prepareDrawTile(),L.activeTexture.set(R.TEXTURE0),se.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),L.activeTexture.set(R.TEXTURE1),ue&&ue.rasterParticleState?(ue.rasterParticleState.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),ye=Math.pow(2,ue.tileID.overscaledZ-ce.tileID.overscaledZ),Pe=[ce.tileID.canonical.x*ye%1,ce.tileID.canonical.y*ye%1]):se.targetColorTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE);let Se=q?Float32Array.from(x.transform.expandedFarZProjMatrix):x.transform.calculateProjMatrix(Q,j),Be=x.transform,tt=fo(Be),Ie=i.dF(ae.canonical),me=i.dG(Ie.getCenter().lat),Ve,De,Ge,ot,xt;q?(Ve=Float32Array.from(i.bj(i.dI(ae.canonical))),De=Float32Array.from(Be.globeMatrix),Ge=Float32Array.from(i.dE(Be)),ot=[i.aF(Be.center.lng),i.aJ(Be.center.lat)],xt=Float32Array.from(i.dH(ae.canonical,Ie,me,Be.worldSize/Be._pixelsPerMercatorPixel))):(Ve=new Float32Array(16),De=new Float32Array(9),Ge=new Float32Array(16),ot=[0,0],xt=new Float32Array(9));let Je=ml(Se,Ve,De,Ge,xt,Pe||[0,0],i.aj(x.transform.zoom),ot,tt,ye||1,be,z),it=x.isTileAffectedByFog(ae),wt=x.getOrCreateProgram("rasterParticle",{defines:J,overrideFog:it});if(x.uploadCommonUniforms(L,wt,Q),q){let mt=new Tt(R.LEQUAL,Tt.ReadOnly,x.depthRangeFor3D),ht=0,gt=x.globeSharedBuffers;if(gt){let[Ot,fn,vn]=gt.getGridBuffers(me,ht!==0);wt.draw(x,R.TRIANGLES,mt,Y,rn.alphaBlended,x.renderElevatedRasterBackface?jt.frontCCW:jt.backCCW,Je,T.id,Ot,fn,vn)}}else{let mt=x.depthModeForSublayer(0,Tt.ReadOnly),ht=$[ae.overscaledZ],{tileBoundsBuffer:gt,tileBoundsIndexBuffer:Ot,tileBoundsSegments:fn}=x.getTileBoundsBuffers(ce);wt.draw(x,R.TRIANGLES,mt,ht,rn.alphaBlended,jt.disabled,Je,T.id,gt,Ot,fn)}}x.resetStencilClippingMasks()})(d,t,o,h),d.style.map.triggerRepaint())},background:function(d,t,o,h){let g=o.paint.get("background-color"),y=o.paint.get("background-color-use-theme").constantOr("default")==="none",x=o.paint.get("background-opacity"),E=o.paint.get("background-emissive-strength"),T=o.paint.get("background-pitch-alignment")==="viewport";if(x===0)return;let A=d.context,M=A.gl,L=d.transform,R=L.tileSize,F=o.paint.get("background-pattern"),z;if(F!==void 0&&(F===null||(z=d.imageManager.getPattern(i.I.from(F.toString()),o.scope,d.style.getLut(o.scope)),!z)))return;let j=!F&&g.a===1&&x===1&&d.opaquePassEnabledForLayer()?"opaque":"translucent";if(d.renderPass!==j)return;let q=qt.disabled,$=d.depthModeForSublayer(0,j==="opaque"?Tt.ReadWrite:Tt.ReadOnly),Z=d.colorModeForDrapableLayerRenderPass(E),J=F?"backgroundPattern":"background",Y,ae=h;if(ae||(Y=d.getBackgroundTiles(),ae=Object.values(Y).map(Q=>Q.tileID)),F&&(A.activeTexture.set(M.TEXTURE0),d.imageManager.bind(d.context,o.scope)),T){let Q=d.getOrCreateProgram(J,{overrideFog:!1,overrideRtt:!0}),ce=new Float32Array(i.bz([])),se=new i.aP(0,0,0,0,0),ie=F?jf(ce,E,x,d,0,o.scope,z,T,{tileID:se,tileSize:R}):Vf(ce,E,x,g.toPremultipliedRenderColor(y?null:o.lut));Q.draw(d,M.TRIANGLES,$,q,Z,jt.disabled,ie,o.id,d.viewportBuffer,d.quadTriangleIndexBuffer,d.viewportSegments)}else for(let Q of ae){let ce=d.isTileAffectedByFog(Q),se=d.getOrCreateProgram(J,{overrideFog:ce}),ie=Q.toUnwrapped(),ue=h?Q.projMatrix:d.transform.calculateProjMatrix(ie);d.prepareDrawTile();let be=t?t.getTile(Q):Y?Y[Q.key]:new ua(Q,R,L.zoom,d),ye=F?jf(ue,E,x,d,0,o.scope,z,T,{tileID:Q,tileSize:R}):Vf(ue,E,x,g.toPremultipliedRenderColor(y?null:o.lut));d.uploadCommonUniforms(A,se,ie);let{tileBoundsBuffer:Pe,tileBoundsIndexBuffer:Se,tileBoundsSegments:Be}=d.getTileBoundsBuffers(be);se.draw(d,M.TRIANGLES,$,q,Z,jt.disabled,ye,o.id,Pe,Se,Be)}},sky:function(d,t,o){let h=d._atmosphere?i.aj(d.transform.zoom):1,g=o.paint.get("sky-opacity")*h;if(g===0)return;let y=d.context,x=o.paint.get("sky-type"),E=new Tt(y.gl.LEQUAL,Tt.ReadOnly,[0,1]),T=d.frameCounter/1e3%1;x==="atmosphere"?d.renderPass==="offscreen"?o.needsSkyboxCapture(d)&&((function(A,M,L,R){let F=A.context,z=F.gl,j=M.skyboxFbo;if(!j){j=M.skyboxFbo=F.createFramebuffer(32,32,!0,null),M.skyboxGeometry=new Bg(F),M.skyboxTexture=F.gl.createTexture(),z.bindTexture(z.TEXTURE_CUBE_MAP,M.skyboxTexture),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_MIN_FILTER,z.LINEAR),z.texParameteri(z.TEXTURE_CUBE_MAP,z.TEXTURE_MAG_FILTER,z.LINEAR);for(let J=0;J<6;++J)z.texImage2D(z.TEXTURE_CUBE_MAP_POSITIVE_X+J,0,z.RGBA,32,32,0,z.RGBA,z.UNSIGNED_BYTE,null)}F.bindFramebuffer.set(j.framebuffer),F.viewport.set([0,0,32,32]);let q=M.getCenter(A,!0),$=A.getOrCreateProgram("skyboxCapture"),Z=new Float64Array(16);i.bz(Z),i.em(Z,Z,.5*-Math.PI),Is(A,M,$,Z,q,0),i.bz(Z),i.em(Z,Z,.5*Math.PI),Is(A,M,$,Z,q,1),i.bz(Z),i.cT(Z,Z,.5*-Math.PI),Is(A,M,$,Z,q,2),i.bz(Z),i.cT(Z,Z,.5*Math.PI),Is(A,M,$,Z,q,3),i.bz(Z),Is(A,M,$,Z,q,4),i.bz(Z),i.em(Z,Z,Math.PI),Is(A,M,$,Z,q,5),F.viewport.set([0,0,A.width,A.height])})(d,o),o.markSkyboxValid(d)):d.renderPass==="sky"&&(function(A,M,L,R,F){let z=A.context,j=z.gl,q=A.transform,$=A.getOrCreateProgram("skybox");z.activeTexture.set(j.TEXTURE0),j.bindTexture(j.TEXTURE_CUBE_MAP,M.skyboxTexture);let Z=((J,Y,ae,Q,ce)=>({u_matrix:J,u_sun_direction:Y,u_cubemap:0,u_opacity:Q,u_temporal_offset:ce}))(q.skyboxMatrix,M.getCenter(A,!1),0,R,F);A.uploadCommonUniforms(z,$),$.draw(A,j.TRIANGLES,L,qt.disabled,A.colorModeForRenderPass(),jt.backCW,Z,"skybox",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)})(d,o,E,g,T):x==="gradient"&&d.renderPass==="sky"&&(function(A,M,L,R,F){let z=A.context,j=z.gl,q=A.transform,$=A.getOrCreateProgram("skyboxGradient");M.skyboxGeometry||(M.skyboxGeometry=new Bg(z)),z.activeTexture.set(j.TEXTURE0);let Z=M.colorRampTexture;Z||(Z=M.colorRampTexture=new i.T(z,M.colorRamp,j.RGBA8)),Z.bind(j.LINEAR,j.CLAMP_TO_EDGE);let J=((Y,ae,Q,ce,se)=>({u_matrix:Y,u_color_ramp:0,u_center_direction:ae,u_radius:i.an(Q),u_opacity:ce,u_temporal_offset:se}))(q.skyboxMatrix,M.getCenter(A,!1),M.paint.get("sky-gradient-radius"),R,F);A.uploadCommonUniforms(z,$),$.draw(A,j.TRIANGLES,L,qt.disabled,A.colorModeForRenderPass(),jt.backCW,J,"skyboxGradient",M.skyboxGeometry.vertexBuffer,M.skyboxGeometry.indexBuffer,M.skyboxGeometry.segment)})(d,o,E,g,T)},custom:function(d,t,o,h){let g=d.context,y=o.implementation;if(!d.transform.projection.unsupportedLayers||!d.transform.projection.unsupportedLayers.includes("custom")||d.terrain&&(d.terrain.renderingToTexture||d.renderPass==="offscreen")&&o.isDraped(t)){if(d.renderPass==="offscreen"){let x=y.prerender;if(x){if(d.setCustomLayerDefaults(),g.setColorMode(d.colorModeForRenderPass()),d.transform.projection.name==="globe"){let E=d.transform.pointMerc;x.call(y,g.gl,d.transform.customLayerMatrix(),d.transform.getProjection(),d.transform.globeToMercatorMatrix(),i.aj(d.transform.zoom),[E.x,E.y],d.transform.pixelsPerMeterRatio)}else x.call(y,g.gl,d.transform.customLayerMatrix());g.setDirty(),d.setBaseState()}}else if(d.renderPass==="translucent"){if(d.terrain&&d.terrain.renderingToTexture){let E=y.renderToTile;if(E){let T=h[0].canonical,A={x:T.x+h[0].wrap*(y.wrapTileId?0:1<<T.z),y:T.y,z:T.z};g.setDepthMode(Tt.disabled),g.setStencilMode(qt.disabled),g.setColorMode(d.colorModeForRenderPass()),d.setCustomLayerDefaults(),E.call(y,g.gl,A),g.setDirty(),d.setBaseState()}return}d.setCustomLayerDefaults(),g.setColorMode(d.colorModeForRenderPass()),g.setStencilMode(qt.disabled);let x=y.renderingMode==="3d"?new Tt(d.context.gl.LEQUAL,Tt.ReadWrite,d.depthRangeFor3D):d.depthModeForSublayer(0,Tt.ReadOnly);if(g.setDepthMode(x),d.transform.projection.name==="globe"){let E=d.transform.pointMerc;y.render(g.gl,d.transform.customLayerMatrix(),d.transform.getProjection(),d.transform.globeToMercatorMatrix(),i.aj(d.transform.zoom),[E.x,E.y],d.transform.pixelsPerMeterRatio)}else y.render(g.gl,d.transform.customLayerMatrix());g.setDirty(),d.setBaseState(),g.bindFramebuffer.set(null)}}else i.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(d,t,o,h){if(d.renderPass==="opaque")return;let g=o.paint.get("model-opacity").constantOr(1),y=o.paint.get("model-elevation-reference"),x=y==="ground",E=y==="ground";if(g===0)return;let T=o.paint.get("model-cast-shadows");if(d.renderPass==="shadow"&&(!T||d.terrain&&g<.65&&o._transitionablePaint._values["model-opacity"].value.expression instanceof i.ad))return;let A=d.shadowRenderer,M=o.paint.get("model-receive-shadows");A&&(A.useNormalOffset=!0,M||(A.enabled=!1));let L=()=>{A&&(A.useNormalOffset=!0,M||(A.enabled=!0))},R=t.getSource();if(d.renderPass==="light-beam"&&R.type!=="batched-model")return;if(R.type==="vector"||R.type==="geojson")return(function(Y,ae,Q,ce,se){let ie=Y.transform,ue=ie.projection.name==="globe",be=ie.getFreeCameraOptions().position;if(!Y.modelManager)return;let ye=Y.modelManager;Q.modelManager=ye;let Pe=Y.shadowRenderer;if(!Q._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let Se=Q._unevaluatedLayout._values["model-id"],Be=Object.assign({},Q.layout.get("model-id").parameters),tt=Y.style.order.indexOf(Q.fqid);for(let Ie of ce){let me=ae.getTile(Ie).getBucket(Q);if(!me||me.projection.name!==ie.projection.name)continue;let Ve=me.getModelUris();if(Ve&&!me.modelsRequested&&(ye.addModelsFromBucket(Ve,se),me.modelsRequested=!0),ue)Be.zoom=Ie.overscaledZ;else{let mt=jg(Ie,ie);Be.zoom=mt}let De=Se.possiblyEvaluate(Be);if(i0(Y,me,Ie),Ko.shadowUniformsInitialized=!1,Ko.useSingleShadowCascade=!!Pe&&Pe.getMaxCascadeForTile(Ie.toUnwrapped())===0,Y.renderPass==="shadow"&&Pe){if(Y.currentShadowCascade===1&&me.isInsideFirstShadowMapFrustum)continue;let mt=ie.calculatePosMatrix(Ie.toUnwrapped(),ie.worldSize);if(Ko.tileMatrix.set(mt),Ko.shadowTileMatrix=Float32Array.from(Pe.calculateShadowPassMatrixFromMatrix(mt)),Ko.aabb.min=[0,0,0],Ko.aabb.max[0]=Ko.aabb.max[1]=i.al,Ko.aabb.max[2]=0,Jf(me,Ko,Y,Q.scope))continue}let Ge=1<<Ie.canonical.z,ot=[((be.x-Ie.wrap)*Ge-Ie.canonical.x)*i.al,(be.y*Ge-Ie.canonical.y)*i.al,be.z*Ge*i.al];Y.conflationActive&&Object.keys(me.instancesPerModel).length>0&&Y.style.isLayerClipped(Q,ae.getSource())&&me.updateReplacement(Ie,Y.replacementSource,tt,se)&&(me.uploaded=!1,me.upload(Y.context));let xt=0,Je=new Array,it=new Array,wt=new Array;for(let mt in me.instancesPerModel){let ht=me.instancesPerModel[mt];ht.features.length>0&&!ue&&(mt=De.evaluate(ht.features[0].feature,{}));let gt=ye.getModel(mt,se);if(gt||ye.hasURLBeenRequested(mt)||me.modelUris.includes(mt)||(me.modelUris.push(mt),me.modelsRequested=!1),gt&&gt.uploaded)if(ue){let Ot=i.c4([],[be.x,be.y,be.z],Y.transform.worldSize);i.ev(Ot,Ot);for(let fn=0;fn<ht.instancedDataArray.length;++fn){let vn=[0,0,0],Zn=[1,1,1],Ut=i.ew(),yn=ht.tileCoordinatesForInstance(fn),en=ht.transformForInstance(fn);i.ex(Zn,en),i.ey(Ut,en),i.ez(vn,Ut);let jn=ht.translationForInstance(fn),xn=new i.aS(0,0);i.eA(me.canonical,xn,yn.x,yn.y);let oi=i.bB();i.eB(oi,gt,Y.transform,xn,vn,Zn,jn,!0,!1,!1);let Sn=ht.colorForInstance(fn),nn=i.bz([]),On=i.ee(xn.lat,Y.transform.zoom),on=i.bp([],[1,1,1/On]);i.bq(nn,nn,Ot),wt.push({zScaleMatrix:on,negCameraPosMatrix:nn});for(let ui of gt.nodes)Kf(Y,ui,oi,Y.transform.expandedFarZProjMatrix,xt,Je,it,gt.materialOverrides,Sn);++xt}}else for(let Ot of gt.nodes)Ug(Y,Q,Ot,ht,ot,Ie,Ko)}if(ue)if(Y.renderPass==="shadow"){for(let mt of it)vu(mt.mesh,mt.nodeModelMatrix,Y,Q);for(let mt of Je)vu(mt.mesh,mt.nodeModelMatrix,Y,Q)}else n0(Y,Q,1,Je,it,wt)}})(d,t,o,h,Yf(R,o,d.style._importedAsBasemap)),void L();if(!R.loaded())return;if(R.type==="batched-model")return(function(Y,ae,Q,ce){Q.resetLayerRenderingStats(Y);let se=Y.context,ie=Y.transform,ue=Y.style.fog,be=Y.shadowRenderer;if(ie.projection.name!=="mercator")return void i.w(`Drawing 3D landmark models for ${ie.projection.name} projection is not yet implemented`);let ye=Y.transform.getFreeCameraOptions().position,Pe=i.c4([],[ye.x,ye.y,ye.z],Y.transform.worldSize),Se=i.ev([],Pe),Be=i.bz([]),tt=i.ee(ie.center.lat,ie.zoom),Ie=i.bp([],[1,1,1/tt]);i.bq(Be,Be,Se);let me=Q.paint.get("model-opacity").constantOr(1),Ve=new Tt(se.gl.LEQUAL,Tt.ReadWrite,Y.depthRangeFor3D),De=new Tt(se.gl.LEQUAL,Tt.ReadOnly,Y.depthRangeFor3D),Ge=new i.d8([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),ot=Y.renderPass==="shadow",xt=ot&&be?be.getCurrentCascadeFrustum():ie.getFrustum(ie.scaleZoom(ie.worldSize)),Je=Q.paint.get("model-front-cutoff"),it=Je[2]<1,wt=Fa(Y,Q.paint.get("model-cutoff-fade-range")),mt=Q.getLayerRenderingStats();(function(ht,gt,Ot,fn){let vn=ht.terrain?ht.terrain.exaggeration():0,Zn=ht.transform.zoom;for(let Ut of fn){let yn=gt.getTile(Ut).getBucket(Ot);yn&&(yn.setFilter(Ot.filter),ht.conflationActive&&yn.updateReplacement(Ut,ht.replacementSource),yn.evaluateTransform(ht,Ot),ht.terrain&&vn>0&&yn.elevationUpdate(ht.terrain,vn,Ut,Ot.source),yn.needsReEvaluation(ht,Zn,Ot)&&yn.evaluate(Ot))}})(Y,ae,Q,ce),(function(){let ht,gt,Ot;it?(ht=ce.length-1,gt=-1,Ot=-1):(ht=0,gt=ce.length,Ot=1);let fn=new Float64Array(16),vn=i.cz(),Zn=new i.P(0,0);for(let Ut=ht;Ut!==gt;Ut+=Ot){let yn=ce[Ut],en=ae.getTile(yn).getBucket(Q);if(!en||!en.uploaded)continue;let jn=!1;be&&(jn=be.getMaxCascadeForTile(yn.toUnwrapped())===0);let xn=ie.calculatePosMatrix(yn.toUnwrapped(),ie.worldSize),oi=en.modelTraits;!ot&&it&&(i.bk(fn,xn),i.af(vn,Pe,fn),Zn.x=vn[0],Zn.y=vn[1]);let Sn=[];en.setFilter(Q.filter);for(let nn of en.getNodesInfo()){if(nn.hiddenByReplacement||!nn.node.meshes)continue;let On=nn.node,on=0;Y.terrain&&On.elevation&&(on=On.elevation*Y.terrain.exaggeration());let ui=(()=>{let Xr=nn.aabb;return Ge.min=[...Xr.min],Ge.max=[...Xr.max],Ge.min[2]+=on,Ge.max[2]+=on,i.af(Ge.min,Ge.min,xn),i.af(Ge.max,Ge.max,xn),Ge})(),kn=nn.evaluatedScale;if(kn[0]<=1&&kn[1]<=1&&kn[2]<=1&&ui.intersects(xt)===0)continue;if(!ot&&it){let Xr=.16666666666666666;nn.cameraCollisionOpacity=Pe[0]>ui.min[0]&&Pe[0]<ui.max[0]&&Pe[1]>ui.min[1]&&Pe[1]<ui.max[1]&&Pe[2]*tt<ui.max[2]&&On.footprint&&i.b$(Zn,On.footprint)?Math.max(nn.cameraCollisionOpacity-Xr,0):Math.min(1,nn.cameraCollisionOpacity+Xr)}let $t=[...xn],wn=1/i.d6(yn.canonical),Ti=On.anchor?On.anchor[0]:0,$i=On.anchor?On.anchor[1]:0;i.bq($t,$t,[Ti*(kn[0]-1)+nn.evaluatedTranslation[0]*wn,$i*(kn[1]-1)+nn.evaluatedTranslation[1]*wn,on+nn.evaluatedTranslation[2]]),i.cp(kn,i.eD)||i.cR($t,$t,kn);let Ai=i.aB([],$t,On.globalMatrix),Bi=i.aB([],ie.expandedFarZProjMatrix,Ai),So=i.aB([],ie.expandedFarZProjMatrix,$t),po=i.aC([],[Ti,$i,on,1],Bi)[2];On.hidden=!1;let Ur=me;ot||(it&&(Ur*=nn.cameraCollisionOpacity,Ur*=dc($t,ie,nn.aabb,Je)),Ur*=th(wt,po)),Ur!==0?Sn.push({nodeInfo:nn,depth:po,opacity:Ur,wvpForNode:Bi,wvpForTile:So,nodeModelMatrix:Ai,tileModelMatrix:$t}):On.hidden=!0}ot||Sn.sort((nn,On)=>!it||nn.opacity===1&&On.opacity===1?nn.depth<On.depth?-1:1:nn.opacity===1?-1:On.opacity===1?1:nn.depth>On.depth?-1:1);for(let nn of Sn){let On=nn.nodeInfo,on=On.node,ui=i.aB([],Ie,nn.tileModelMatrix);i.aB(ui,Be,ui);let kn=i.bk([],ui);i.ef(kn,kn),i.cR(kn,kn,r0),ui=i.aB(ui,ui,on.globalMatrix);let $t=Y.renderPass==="light-beam",wn=Q.paint.get("model-color-use-theme").constantOr("default")==="none",Ti=oi&i.eH.HasMapboxMeshFeatures,$i=Ti?0:On.evaluatedRMEA[0][2];for(let Ai=0;Ai<on.meshes.length;++Ai){let Bi=on.meshes[Ai],So=Ai===on.lightMeshIndex,po=nn.wvpForNode;if(So){if(!$t&&!Y.terrain&&Y.shadowRenderer){Y.currentLayer<Y.firstLightBeamLayer&&(Y.firstLightBeamLayer=Y.currentLayer);continue}po=nn.wvpForTile}else if($t)continue;let Ur={defines:[]},Xr=[];if(!ot&&be&&(be.useNormalOffset=!!Bi.normalBuffer),_u(Ur.defines,Xr,Bi,Y,wn?null:Q.lut),Ti||Ur.defines.push("DIFFUSE_SHADED"),jn&&Ur.defines.push("SHADOWS_SINGLE_CASCADE"),mt&&(ot?mt.numRenderedVerticesInShadowPass+=Bi.vertexArray.length:mt.numRenderedVerticesInTransparentPass+=Bi.vertexArray.length),ot){vu(Bi,nn.nodeModelMatrix,Y,Q);continue}let Qo=null;if(ue){let Gi=Vg(nn.nodeModelMatrix,Y.transform);if(Qo=new Float32Array(Gi),ie.projection.name!=="globe"){let ni=Bi.aabb.min,Yi=Bi.aabb.max,[Ar,Li]=ue.getOpacityForBounds(Gi,ni[0],ni[1],Yi[0],Yi[1]);Ur.overrideFog=Ar>=Ce||Li>=Ce}}let Hr=Bi.material,es;Hr.occlusionTexture&&Hr.occlusionTexture.offsetScale&&(es=Hr.occlusionTexture.offsetScale,Ur.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let Cs=Y.getOrCreateProgram("model",Ur);!ot&&be&&be.setupShadowsFromMatrix(nn.tileModelMatrix,Cs,be.useNormalOffset),Y.uploadCommonUniforms(se,Cs,null,Qo);let Cr=Hr.pbrMetallicRoughness;Cr.metallicFactor=.9,Cr.roughnessFactor=.5;let Oi=Uf(new Float32Array(po),new Float32Array(ui),new Float32Array(kn),new Float32Array(on.globalMatrix),Y,nn.opacity,Cr.baseColorFactor,Hr.emissiveFactor,Cr.metallicFactor,Cr.roughnessFactor,Hr,$i,Q,[0,0,0],es);!So&&(On.hasTranslucentParts||nn.opacity<1)&&Cs.draw(Y,se.gl.TRIANGLES,Ve,qt.disabled,rn.disabled,jt.backCCW,Oi,Q.id,Bi.vertexBuffer,Bi.indexBuffer,Bi.segments,Q.paint,Y.transform.zoom,void 0,Xr),Cs.draw(Y,se.gl.TRIANGLES,So?De:Ve,qt.disabled,So||nn.opacity<1||On.hasTranslucentParts?rn.alphaBlended:rn.unblended,jt.backCCW,Oi,Q.id,Bi.vertexBuffer,Bi.indexBuffer,Bi.segments,Q.paint,Y.transform.zoom,void 0,Xr)}}}})()})(d,t,o,h),void L();if(R.type!=="model")return;let F=R.getModels(),z=[],j=d.transform.getFreeCameraOptions().position,q=i.c4([],[j.x,j.y,j.z],d.transform.worldSize);i.ev(q,q);let $=[],Z=[],J=0;for(let Y of F){let ae=t.getFeatureState("",Y.id),Q={type:"Unknown",id:Y.id,properties:Y.featureProperties},ce=o.paint.get("model-rotation").evaluate(Q,ae),se=o.paint.get("model-scale").evaluate(Q,ae),ie=o.paint.get("model-translation").evaluate(Q,ae);xu(o,Y.id,ae,Y.featureProperties,Y.nodeOverrideNames,Y.nodeOverrides),Y1(o,Y.id,ae,Y.featureProperties,Y.materialOverrideNames,Y.materialOverrides),Y.nodeOverrides.size>0&&Y.computeBoundsAndApplyParent(),Y.computeModelMatrix(d,ce,se,ie,E,x,!1);let ue=i.bz([]),be=i.ee(Y.position.lat,d.transform.zoom),ye=i.bp([],[1,1,1/be]);i.bq(ue,ue,q),z.push({zScaleMatrix:ye,negCameraPosMatrix:ue});for(let Pe of Y.nodes)Kf(d,Pe,Y.matrix,d.transform.expandedFarZProjMatrix,J,$,Z,Y.materialOverrides);J++}if($.sort((Y,ae)=>ae.depth-Y.depth),d.renderPass!=="shadow")n0(d,o,g,$,Z,z),L();else{for(let Y of Z)vu(Y.mesh,Y.nodeModelMatrix,d,o);for(let Y of $)vu(Y.mesh,Y.nodeModelMatrix,d,o);L()}}},Qf={line:function(d,t,o){if(d.hasElevatedBuckets=!1,d.hasNonElevatedBuckets=!1,d._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||d._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){let h=t.getVisibleCoordinates();for(let g of h){let y=t.getTile(g).getBucket(d);if(y&&(y.elevationType!=="none"?d.hasElevatedBuckets=!0:d.hasNonElevatedBuckets=!0,d.hasElevatedBuckets&&d.hasNonElevatedBuckets))break}}}else d.hasNonElevatedBuckets=!0},model:function(d,t,o){let h=t.getSource();if(!h.loaded())return;if(h.type==="vector"||h.type==="geojson"){let y=Yf(h,d,o.style._importedAsBasemap);return void(o.modelManager&&o.modelManager.upload(o,y))}if(h.type==="batched-model"||h.type!=="model")return;let g=h.getModels();for(let y of g)y.upload(o.context)},raster:function(d,t,o){let h=t.getSource();if(!(h instanceof vr&&h.loaded()))return;let g=d.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!g)return;let y=d.paint.get("raster-array-band")||h.getInitialBand(g);if(y==null)return;let x=t.getIds().map(E=>t.getTileByID(E));for(let E of x)E.updateNeeded(d.id,y)&&h.prepareTile(E,g,d.id,y)},"raster-particle":function(d,t,o){let h=t.getSource();if(!(h instanceof vr&&h.loaded()))return;let g=d.sourceLayer||h.rasterLayerIds&&h.rasterLayerIds[0];if(!g)return;let y=d.paint.get("raster-particle-array-band")||h.getInitialBand(g);if(y==null)return;let x=t.getIds().map(E=>t.getTileByID(E));for(let E of x)E.updateNeeded(d.id,y)&&h.prepareTile(E,g,d.id,y)}},ep={fill:cc},Jo={fill:function(d,t,o,h){if(!o.layout||o.layout.get("fill-elevation-reference")==="none"||o.paint.get("fill-opacity").constantOr(1)===0)return;let g=d.context.gl,y=new Tt(g.LEQUAL,Tt.ReadOnly,d.depthRangeFor3D),x=new qt({func:g.ALWAYS,mask:255},255,255,g.KEEP,g.KEEP,g.REPLACE),E=d.transform.getFreeCameraOptions().position,T=d.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(let A of h){let M=t.getTile(A),L=M.getBucket(o);if(!L)continue;let R=L.elevatedStructures;if(!R||R.depthSegments.segments[0].primitiveLength===0)continue;let F=Yv(A.toUnwrapped(),E),z=d.translatePosMatrix(A.projMatrix,M,o.paint.get("fill-translate"),o.paint.get("fill-translate-anchor")),j=kf(z,F,0,1,0);T.draw(d,g.TRIANGLES,y,x,rn.disabled,jt.disabled,j,o.id,R.vertexBuffer,R.indexBuffer,R.depthSegments,o.paint,d.transform.zoom)}}};class xl{constructor(t,o,h,g,y,x){this.context=new $f(t,o),this.transform=h,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=y,this._timeStamp=i.o.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let E=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(let A of E)this._debugParams.enabledLayers[A]=!0;y.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),y.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),y.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),y.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),y.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),y.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(let A of E)y.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],A);this.occlusionParams=new K1(y),this.setup(),this.numSublayers=vs.maxUnderzooming+vs.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new i.eO,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Vd(this),this._wireframeDebugCache=new s0,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let T=new i.q({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new i.T(this.context,T,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=g,this.worldview=x}updateTerrain(t,o){let h=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(h||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Xd(this,t));let g=this._terrain;this.transform.elevation=h?g:null,g.update(t,this.transform,o),this.transform.elevation&&!g.enabled&&(this.transform.elevation=null)}_updateFog(t){let o=t.fog;if(!o||this.transform.projection.name==="globe"||o.getOpacity(this.transform.pitch)<1||o.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);let[h,g]=o.getFovAdjustedRange(this.transform._fov);if(h>g)return void(this.transform.fogCullDistSq=null);let y=h+.78*(g-h);this.transform.fogCullDistSq=y*y}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Xd(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,o){if(this.width=t*i.o.devicePixelRatio,this.height=o*i.o.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let h of this.style.order)this.style._mergedLayers[h].resize()}setup(){let t=this.context,o=new i.bc;o.emplaceBack(0,0),o.emplaceBack(i.al,0),o.emplaceBack(0,i.al),o.emplaceBack(i.al,i.al),this.tileExtentBuffer=t.createVertexBuffer(o,i.be.members),this.tileExtentSegments=i.bf.simpleSegment(0,0,4,2);let h=new i.bc;h.emplaceBack(0,0),h.emplaceBack(i.al,0),h.emplaceBack(0,i.al),h.emplaceBack(i.al,i.al),this.debugBuffer=t.createVertexBuffer(h,i.be.members),this.debugSegments=i.bf.simpleSegment(0,0,4,5);let g=new i.bc;g.emplaceBack(-1,-1),g.emplaceBack(1,-1),g.emplaceBack(-1,1),g.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(g,i.be.members),this.viewportSegments=i.bf.simpleSegment(0,0,4,2);let y=new i.a$;y.emplaceBack(0,0,0,0),y.emplaceBack(i.al,0,i.al,0),y.emplaceBack(0,i.al,0,i.al),y.emplaceBack(i.al,i.al,i.al,i.al),this.mercatorBoundsBuffer=t.createVertexBuffer(y,i.bh.members),this.mercatorBoundsSegments=i.bf.simpleSegment(0,0,4,2);let x=new i.b0;x.emplaceBack(0,1,2),x.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(x);let E=new i.bd;for(let A of[0,1,3,2,0])E.emplaceBack(A);this.debugIndexBuffer=t.createIndexBuffer(E),this.emptyTexture=new i.T(t,new i.q({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=i.bB();let T=this.context.gl;this.stencilClearMode=new qt({func:T.ALWAYS,mask:0},0,255,T.ZERO,T.ZERO,T.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Tt.disabled,this.stencilClearMode,rn.disabled,jt.disabled,ac(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,o,h){if(!o||this.currentStencilSource===o.id||!t.isTileClipped()||!h||h.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let E=!1;for(let T of h)if(this._tileClippingMaskIDs[T.key]===void 0){E=!0;break}if(!E)return}this.currentStencilSource=o.id;let g=this.context,y=g.gl;this.nextStencilID+h.length>256&&this.clearStencil(),g.setColorMode(rn.disabled),g.setDepthMode(Tt.disabled);let x=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(let E of h){let T=o.getTile(E),A=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,{tileBoundsBuffer:M,tileBoundsIndexBuffer:L,tileBoundsSegments:R}=this.getTileBoundsBuffers(T);x.draw(this,y.TRIANGLES,Tt.disabled,new qt({func:y.ALWAYS,mask:0},A,255,y.KEEP,y.KEEP,y.REPLACE),rn.disabled,jt.disabled,ac(E.projMatrix),"$clipping",M,L,R)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let t=this.nextStencilID++,o=this.context.gl;return new qt({func:o.NOTEQUAL,mask:255},t,255,o.KEEP,o.KEEP,o.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);let o=this.context.gl;return new qt({func:o.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,o.KEEP,o.KEEP,o.REPLACE)}stencilConfigForOverlap(t){let o=this.context.gl,h=t.sort((x,E)=>E.overscaledZ-x.overscaledZ),g=h[h.length-1].overscaledZ,y=h[0].overscaledZ-g+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();let x={};for(let E=0;E<y;E++)x[E+g]=new qt({func:o.GEQUAL,mask:255},E+this.nextStencilID,255,o.KEEP,o.KEEP,o.REPLACE);return this.nextStencilID+=y,[x,h]}return[{[g]:qt.disabled},h]}colorModeForRenderPass(){let t=this.context.gl;return this._showOverdrawInspector?new rn([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new i.ao(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?rn.unblended:rn.alphaBlended}colorModeForDrapableLayerRenderPass(t){let o=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new rn([o.ONE,o.ONE_MINUS_SRC_ALPHA,o.CONSTANT_ALPHA,o.ONE_MINUS_SRC_ALPHA],new i.ao(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,o,h,g=!1){if(this.depthOcclusion)return new Tt(this.context.gl.GREATER,Tt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!g)return Tt.disabled;let y=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Tt(h||this.context.gl.LEQUAL,o,[y,y])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let t=this.context.gl,o=Math.ceil(this.width),h=Math.ceil(this.height),g=this.context.bindFramebuffer.get(),y=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===o&&this.depthFBO.height===h||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),o!==0&&h!==0&&(this.depthFBO=new Hf(this.context,o,h,!1,"texture"),this.depthTexture=new i.T(this.context,{width:o,height:h,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(g),t.bindTexture(t.TEXTURE_2D,y),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,o,h,0,0,o,h,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,o)=>t+o/this._fpsHistory.length,0))}render(t,o){let h=i.o.now();this._dt=h-this._timeStamp,this._timeStamp=h,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=o;let g=this.style._mergedLayers,y=!(!this.terrain||!this.terrain.enabled),x=()=>this.style._getOrder(y).filter(Ie=>{let me=g[Ie];return!(me.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[me.type]}),E=x(),T=!1,A=!1,M=null;for(let Ie of E){let me=g[Ie];me.type==="circle"?T=!0:me.type==="building"?M=me:me.type==="symbol"&&(me.hasOcclusionOpacityProperties?A=!0:T=!0)}let L=E.map(Ie=>g[Ie]),R=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(i.o.now()),this.imageManager.beginFrame();let F=0,z=!1;for(let Ie in R){let me=R[Ie];me.used&&(me.prepare(this.context),me.getSource().usedInConflation&&++F)}let j=!1;for(let Ie of L)Ie.isHidden(this.transform.zoom)||(Ie.type==="clip"&&(j=!0),this.prepareLayer(Ie));let q={},$={},Z={},J={},Y={};for(let Ie in R){let me=R[Ie];q[Ie]=me.getVisibleCoordinates(),$[Ie]=q[Ie].slice().reverse(),Z[Ie]=me.getVisibleCoordinates(!0).reverse(),J[Ie]=me.getShadowCasterCoordinates(),Y[Ie]=me.sortCoordinatesByDistance(q[Ie])}let ae=Ie=>{let me=this.style.getLayerSourceCache(Ie);return me&&me.used?me.getSource():null};if(F||j||this._clippingActiveLastFrame){let Ie=[],me=[],Ve=0;for(let De of L)this.isSourceForClippingOrConflation(De,ae(De))&&(Ie.push(De),me.push(Ve)),Ve++;if(Ie&&(j||Ie.length>1)||this._clippingActiveLastFrame){j=!1;let De=[];for(let Ge=0;Ge<Ie.length;Ge++){let ot=Ie[Ge],xt=me[Ge],Je=this.style.getLayerSourceCache(ot);if(!Je||!Je.used||!Je.getSource().usedInConflation&&ot.type!=="clip"&&ot.type!=="building")continue;let it=i.eP,wt=i.bZ.None,mt=[],ht=!0;if(ot.type==="building")it=i.eR;else if(ot.type==="clip"){it=xt;for(let gt of ot.layout.get("clip-layer-types"))wt|=gt==="model"?i.bZ.Model:gt==="symbol"?i.bZ.Symbol:i.bZ.FillExtrusion;for(let gt of ot.layout.get("clip-layer-scope"))mt.push(gt);ot.isHidden(this.transform.zoom)?ht=!1:j=!0}ht&&De.push({layer:ot.fqid,cache:Je,order:it,clipMask:wt,clipScope:mt})}this.replacementSource.setSources(De),z=!0}}this._clippingActiveLastFrame=j,z||this.replacementSource.clear(),this.conflationActive=z,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Ie=0;Ie<L.length;Ie++){let me=L[Ie],Ve=me.cutoffRange();if(this.longestCutoffRange=Math.max(Ve,this.longestCutoffRange),Ve>0){let De=ae(me);De&&(this.minCutoffZoom=Math.max(De.minzoom,this.minCutoffZoom)),me.minzoom&&(this.minCutoffZoom=Math.max(me.minzoom,this.minCutoffZoom))}me.is3D(y)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Ie),this._lastOcclusionLayer=Ie)}let Q=this.style&&this.style.fog;Q?(this._fogVisible=Q.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=Q.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(Z),this.opaquePassCutoff=0,E=x(),L=E.map(Ie=>g[Ie]));let ce=this._shadowRenderer;if(ce){ce.updateShadowParameters(this.transform,this.style.directionalLight);for(let Ie in R)for(let me of q[Ie]){let Ve={min:0,max:0};this.terrain&&(Ve=this.terrain.getMinMaxForTile(me)||Ve),ce.addShadowReceiver(me.toUnwrapped(),Ve.min,Ve.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new i.eQ(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new zi(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let se=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),ie=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(se&&!this._snow&&(this._snow=new $g(this)),!se&&this._snow&&(this._snow.destroy(),delete this._snow),ie&&!this._rain&&(this._rain=new bu(this)),!ie&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),M){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Ee);let Ie=this.style.getLayerSourceCache(M);this.buildingTileBorderManager.updateBorders(Ie,M)}if(!ki.has(this.context.gl))return;this.renderPass="offscreen";for(let Ie of L){let me=t.getLayerSourceCache(Ie);if(!Ie.hasOffscreenPass()||Ie.isHidden(this.transform.zoom))continue;let Ve=me?$[me.id]:void 0;(Ie.type==="custom"||Ie.type==="raster"||Ie.type==="raster-particle"||Ie.isSky()||Ve&&Ve.length)&&this.renderLayer(this,me,Ie,Ve)}this.depthRangeFor3D=[0,1-(L.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,J)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let ue=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),be=(()=>{if(o.showOverdrawInspector)return i.ao.black;let Ie=this.style.fog;if(Ie&&this.transform.projection.supportsFog){let me=this.style.getLut(Ie.scope);if(!ue){let Ve=Ie.properties.get("color-use-theme")==="none",De=Ie.properties.get("color").toNonPremultipliedRenderColor(Ve?null:me).toArray01();return new i.ao(...De)}if(ue){let Ve=Ie.properties.get("space-color-use-theme")==="none",De=Ie.properties.get("space-color").toNonPremultipliedRenderColor(Ve?null:me).toArray01();return new i.ao(...De)}}return i.ao.transparent})();if(this.context.clear({color:be,depth:1}),this.clearStencil(),this._showOverdrawInspector=o.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ue&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=E.length-1;this.currentLayer>=0;this.currentLayer--){let Ie=L[this.currentLayer],me=t.getLayerSourceCache(Ie);if(Ie.isSky())continue;let Ve=me?(Ie.is3D(y)?Y:$)[me.id]:void 0;this._renderTileClippingMasks(Ie,me,Ve),this.renderLayer(this,me,Ie,Ve)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ue&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||i.aj(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<E.length;this.currentLayer++){let Ie=L[this.currentLayer],me=t.getLayerSourceCache(Ie);Ie.isSky()&&this.renderLayer(this,me,Ie,me?$[me.id]:void 0)}function ye(Ie,me){let Ve;return me&&(Ve=(Ie.type==="symbol"?Z:Ie.is3D(y)?Y:$)[me.id]),Ve}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<E.length;){let Ie=L[this.currentLayer];if(Ie.type==="raster"||Ie.type==="raster-particle"){let me=t.getLayerSourceCache(Ie);this.renderLayer(this,me,Ie,ye(Ie,me))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Pe=0;ce&&(Pe=ce.getShadowCastingLayerCount());let Se=!1,Be=-1;for(let Ie=0;Ie<E.length;++Ie){let me=L[Ie];me.isHidden(this.transform.zoom)||me.is3D(y)&&(Be=Ie)}A&&Be===-1&&(T=!0);let tt=!1;for(;this.currentLayer<E.length;){let Ie=L[this.currentLayer],me=t.getLayerSourceCache(Ie);if(Ie.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Ie)){if(Ie.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!tt&&Ie.is3D(y)&&!y){let Ve=this.currentLayer,De=Ge=>{for(this.currentLayer=0;this.currentLayer<L.length;this.currentLayer++){let ot=L[this.currentLayer];if(ep[ot.type]){let xt=this.style.getLayerSourceCache(ot);ep[ot.type](this,xt,ot,ye(ot,xt),Ge)}}};De("initialize"),De("reset"),this.currentLayer=Ve,tt=!0}if(T&&!Se&&this.terrain&&!this.transform.isOrthographic&&(Se=!0,this.blitDepth()),A&&Be!==-1&&this.currentLayer===Be+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(Ie,me,me?q[me.id]:void 0),this.renderLayer(this,me,Ie,ye(Ie,me)),!this.terrain&&ce&&Pe>0&&Ie.hasShadowPass()&&--Pe==0){{this.clearStencil(),this.resetStencilClippingMasks();let Ve=this.currentLayer;for(this.currentLayer=0;this.currentLayer<L.length;this.currentLayer++){let De=L[this.currentLayer];if(Jo[De.type]){let Ge=this.style.getLayerSourceCache(De);Jo[De.type](this,Ge,De,ye(De,Ge))}}this.currentLayer=Ve}if(ce.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){let Ve=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ve;this.currentLayer++){let De=L[this.currentLayer];if(!De.hasLightBeamPass())continue;let Ge=t.getLayerSourceCache(De);this.renderLayer(this,Ge,De,Ge?$[Ge.id]:void 0)}this.currentLayer=Ve,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let Ve=this.currentLayer;this.depthOcclusion=!0;for(let De of this.layersWithOcclusionOpacity){this.currentLayer=De;let Ge=L[this.currentLayer],ot=t.getLayerSourceCache(Ge),xt=ot?$[ot.id]:void 0;this.terrain||this._renderTileClippingMasks(Ge,ot,ot?q[ot.id]:void 0),this.renderLayer(this,ot,Ge,xt)}this.depthOcclusion=!1,this.currentLayer=Ve,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Ie=null;L.forEach(me=>{let Ve=t.getLayerSourceCache(me);Ve&&!me.isHidden(this.transform.zoom)&&Ve.getVisibleCoordinates().length&&(!Ie||Ie.getSource().maxzoom<Ve.getSource().maxzoom)&&(Ie=Ve)}),Ie&&this.options.showTileBoundaries&&zg(this,Ie,Ie.getVisibleCoordinates(),i.ao.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&zg(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new i.ao(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&(function(Ie){let me=Ie.transform.padding;ci(Ie,Ie.transform.height-(me.top||0),3,vl),ci(Ie,me.bottom||0,3,Qv),eh(Ie,me.left||0,3,Fg),eh(Ie,Ie.transform.width-(me.right||0),3,kg);let Ve=Ie.transform.centerPoint;(function(De,Ge,ot,xt){mu(De,Ge-1,ot-10,2,20,xt),mu(De,Ge-10,ot-1,20,2,xt)})(Ie,Ve.x,Ie.transform.height-Ve.y,Ng)})(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),z||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);let{unsupportedLayers:o}=this.transform.projection,h=!o||!o.includes(t.type);if(Qf[t.type]&&(h||this.terrain&&t.type==="custom")){let g=this.style.getLayerSourceCache(t);Qf[t.type](t,g,this)}this.gpuTimingEnd()}renderLayer(t,o,h,g){h.isHidden(this.transform.zoom)||(h.type==="background"||h.type==="sky"||h.type==="custom"||h.type==="model"||h.type==="raster"||h.type==="raster-particle"||g&&g.length)&&(this.id=h.id,this.gpuTimingStart(h),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(h.type)&&(!t.terrain||h.type!=="custom")||h.type==="clip"||Gg[h.type](t,o,h,g,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;let o=this.context.extTimerQuery,h=this.context.gl,g=this.gpuTimers[t.id];g||(g=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:h.createQuery()}),g.calls++,h.beginQuery(o.TIME_ELAPSED_EXT,g.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let t=this.context.extTimerQuery,o=this.context.gl,h=o.createQuery();this.deferredRenderGpuTimeQueries.push(h),o.beginQuery(t.TIME_ELAPSED_EXT,h)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){let t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){let o={};for(let h in t){let g=t[h],y=this.context.extTimerQuery,x=y.getQueryParameter(g.query,this.context.gl.QUERY_RESULT)/1e6;y.deleteQueryEXT(g.query),o[h]=x}return o}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;let o=this.context.gl,h=0;for(let g of t)h+=o.getQueryParameter(g,o.QUERY_RESULT)/1e6,o.deleteQuery(g);return h}translatePosMatrix(t,o,h,g,y){if(!h[0]&&!h[1])return t;let x=y?g==="map"?this.transform.angle:0:g==="viewport"?-this.transform.angle:0;if(x){let A=Math.sin(x),M=Math.cos(x);h=[h[0]*M-h[1]*A,h[0]*A+h[1]*M]}let E=[y?h[0]:i.ay(o,h[0],this.transform.zoom),y?h[1]:i.ay(o,h[1],this.transform.zoom),0],T=new Float32Array(16);return i.bq(T,t,E),T}saveTileTexture(t){if(t.context!==this.context)return;let o=t.size[0],h=this._tileTextures[o];h?h.push(t):this._tileTextures[o]=[t]}getTileTexture(t){let o=this._tileTextures[t];return o&&o.length>0?o.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,o,h){let g=h===void 0?this.terrain&&this.terrain.renderingToTexture:h,y=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(y.push("LIGHTING_3D_MODE"),y.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):g||y.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||y.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(y.push("TERRAIN"),this.linearFloatFilteringSupported()&&y.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&y.push("GLOBE"),!this._fogVisible||g||o!==void 0&&!o||y.push("FOG","FOG_DITHERING"),g&&y.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&y.push("OVERDRAW_INSPECTOR"),y}getOrCreateProgram(t,o){this.cache=this.cache||{};let h=o&&o.defines||[],g=o&&o.config,y=this.currentGlobalDefines(t,o&&o.overrideFog,o&&o.overrideRtt).concat(h),x=Yd.cacheKey(wf[t],t,y,g);return this.cache[x]||(this.cache[x]=new Yd(this.context,t,wf[t],g,q1[t],y)),this.cache[x]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new i.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,o){if(this.style.enable3dLights()){let h=this.style.directionalLight,g=this.style.ambientLight;if(h&&g){let y=((x,E,T)=>{let A=x.properties.get("direction"),M=x.properties.get("color-use-theme")==="none",L=x.properties.get("color").toNonPremultipliedRenderColor(M?null:T.getLut(x.scope)).toArray01(),R=x.properties.get("intensity"),F=E.properties.get("color-use-theme")==="none",z=E.properties.get("color").toNonPremultipliedRenderColor(F?null:T.getLut(E.scope)).toArray01(),j=E.properties.get("intensity"),q=[A.x,A.y,A.z],$=i.dM(z,j),Z=i.dM(L,R);return{u_lighting_ambient_color:$,u_lighting_directional_dir:q,u_lighting_directional_color:Z,u_ground_radiance:vg(q,Z,$)}})(h,g,this.style);o.setLightsUniformValues(t,y)}}}uploadCommonUniforms(t,o,h,g,y){if(this.uploadCommonLightUniforms(t,o),this.terrain&&this.terrain.renderingToTexture)return;let x=this.style.fog;if(x){let E=x.getOpacity(this.transform.pitch),T=((A,M,L,R,F,z,j,q,$,Z,J,Y)=>{let ae=A.transform,Q=M.properties.get("color-use-theme")==="none",ce=M.properties.get("color").toNonPremultipliedRenderColor(Q?null:A.style.getLut(M.scope)).toArray01();ce[3]=R;let se=A.frameCounter/1e3%1,[ie,ue]=M.properties.get("vertical-range");return{u_fog_matrix:L?ae.calculateFogTileMatrix(L):Y||A.identityMat,u_fog_range:M.getFovAdjustedRange(ae._fov),u_fog_color:ce,u_fog_horizon_blend:M.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(ie,ue),ue],u_fog_temporal_offset:se,u_frustum_tl:F,u_frustum_tr:z,u_frustum_br:j,u_frustum_bl:q,u_globe_pos:$,u_globe_radius:Z,u_viewport:J,u_globe_transition:i.aj(ae.zoom),u_is_globe:+(ae.projection.name==="globe")}})(this,x,h,E,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*i.o.devicePixelRatio,this.transform.height*i.o.devicePixelRatio],g);o.setFogUniformValues(t,T)}y&&o.setCutoffUniformValues(t,y.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){let t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){let t=this.context.gl,o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),o}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){let t=this._backgroundTiles,o=this._backgroundTiles={},h=this.transform.coveringTiles({tileSize:512});for(let g of h)o[g.key]=t[g.key]||new ua(g,512,this.transform.tileZoom,this,void 0,this.worldview);return o}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,o){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!o||o.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let o=this._cachedTileFogOpacities[t.key];return o||(this._cachedTileFogOpacities[t.key]=o=this.style.fog.getOpacityForTile(t)),o[0]>=Ce||o[1]>=Ce}setupDepthForOcclusion(t,o,h){let g=this.context,y=g.gl,x=!!h;var E;h||(h={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),g.activeTexture.set(y.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE),h.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],h.u_depth_range_unpack=[2/((E=this.depthRangeFor3D)[1]-E[0]),-1-2*E[0]/(E[1]-E[0])],h.u_occluder_half_size=.5*this.occlusionParams.occluderSize,h.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE),g.activeTexture.set(y.TEXTURE0),x||o.setTerrainUniformValues(g,h)}}function fc(d,t){let o=!1,h=null,g=()=>{h=null,o&&(d(),h=setTimeout(g,t),o=!1)};return()=>(o=!0,h||g(),h)}class tp{constructor(t){this._hashName=t&&encodeURIComponent(t),i.aX(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=fc(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){let t=this._map;if(!t)return"";let o=np(t);if(this._hashName){let h=this._hashName,g=!1,y=location.hash.slice(1).split("&").map(x=>{let E=x.split("=")[0];return E===h?(g=!0,`${E}=${o}`):x}).filter(x=>x);return g||y.push(`${h}=${o}`),`#${y.join("&")}`}return`#${o}`}_getCurrentHash(){let t=location.hash.replace("#","");if(this._hashName){let o;return t.split("&").map(h=>h.split("=")).forEach(h=>{h[0]===this._hashName&&(o=h)}),(o&&o[1]||"").split("/")}return t.split("/")}_onHashChange(){let t=this._map;if(!t)return!1;let o=this._getCurrentHash();if(o.length>=3&&!o.some(h=>isNaN(Number(h)))){let h=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(o[3]||0):t.getBearing();return t.jumpTo({center:[+o[2],+o[1]],zoom:+o[0],bearing:h,pitch:+(o[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function np(d,t){let o=d.getCenter(),h=Math.round(100*d.getZoom())/100,g=Math.ceil((h*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,g),x=Math.round(o.lng*y)/y,E=Math.round(o.lat*y)/y,T=d.getBearing(),A=d.getPitch(),M=t?`/${x}/${E}/${h}`:`${h}/${E}/${x}`;return(T||A)&&(M+="/"+Math.round(10*T)/10),A&&(M+=`/${Math.round(A)}`),M}let wu={linearity:.3,easing:i.eS(0,0,.3,1)},bl=Object.assign({deceleration:2500,maxSpeed:1400},wu),qg=Object.assign({deceleration:20,maxSpeed:1400},wu),Ss=Object.assign({deceleration:1e3,maxSpeed:360},wu),Wg=Object.assign({deceleration:1e3,maxSpeed:90},wu);class ip{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:i.o.now(),settings:t})}_drainInertiaBuffer(){let t=this._inertiaBuffer,o=i.o.now();for(;t.length>0&&o-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let o={zoom:0,bearing:0,pitch:0,pan:new i.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:y}of this._inertiaBuffer)o.zoom+=y.zoomDelta||0,o.bearing+=y.bearingDelta||0,o.pitch+=y.pitchDelta||0,y.panDelta&&o.pan._add(y.panDelta),y.around&&(o.around=y.around),y.pinchAround&&(o.pinchAround=y.pinchAround);let h=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(o.pan.mag()){let y=Tu(o.pan.mag(),h,Object.assign({},bl,t||{}));g.offset=o.pan.mult(y.amount/o.pan.mag()),g.center=this._map.transform.center,Eu(g,y)}if(o.zoom){let y=Tu(o.zoom,h,qg);g.zoom=this._map.transform.zoom+y.amount,Eu(g,y)}if(o.bearing){let y=Tu(o.bearing,h,Ss);g.bearing=this._map.transform.bearing+i.aA(y.amount,-179,179),Eu(g,y)}if(o.pitch){let y=Tu(o.pitch,h,Wg);g.pitch=this._map.transform.pitch+y.amount,Eu(g,y)}if(g.zoom||g.bearing){let y=o.pinchAround===void 0?o.around:o.pinchAround;g.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),g.noMoveStart=!0,g}}function Eu(d,t){(!d.duration||d.duration<t.duration)&&(d.duration=t.duration,d.easing=t.easing)}function Tu(d,t,o){let{maxSpeed:h,linearity:g,deceleration:y}=o,x=i.aA(d*g/(t/1e3),-h,h),E=Math.abs(x)/(y*g);return{easing:o.easing,duration:1e3*E,amount:x*(E/2)}}class wi extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h,g={}){let y=lo(o.getCanvasContainer(),h),x=o.unproject(y);super(t,Object.assign({point:y,lngLat:x,originalEvent:h},g)),this._defaultPrevented=!1,this.target=o}}class Iu extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o,h){let g=t==="touchend"?h.changedTouches:h.touches,y=Sa(o.getCanvasContainer(),g),x=y.map(T=>o.unproject(T)),E=y.reduce((T,A,M,L)=>T.add(A.div(L.length)),new i.P(0,0));super(t,{points:y,point:E,lngLats:x,lngLat:o.unproject(E),originalEvent:h}),this._defaultPrevented=!1}}class Zg extends i.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,o){super("wheel",{originalEvent:o}),this._defaultPrevented=!1}}class Xg{constructor(t,o){this._map=t,this._clickTolerance=o.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new Zg(this._map,t))}mousedown(t,o){return this._mousedownPos=o,this._firePreventable(new wi(t.type,this._map,t))}mouseup(t){this._map.fire(new wi(t.type,this._map,t))}preclick(t){let o=new MouseEvent("preclick",t);this._map.fire(new wi(o.type,this._map,o))}click(t,o){this._mousedownPos&&this._mousedownPos.dist(o)>=this._clickTolerance||(this.preclick(t),this._map.fire(new wi(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new wi(t.type,this._map,t))}mouseover(t){this._map.fire(new wi(t.type,this._map,t))}mouseout(t){this._map.fire(new wi(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Iu(t.type,this._map,t))}touchmove(t){this._map.fire(new Iu(t.type,this._map,t))}touchend(t){this._map.fire(new Iu(t.type,this._map,t))}touchcancel(t){this._map.fire(new Iu(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class pc{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new wi(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new wi("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new wi(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Yg{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=o.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,o){this.isEnabled()&&t.shiftKey&&t.button===0&&(qn(),this._startPos=this._lastPos=o,this._active=!0)}mousemoveWindow(t,o){if(!this._active)return;let h=o,g=this._startPos,y=this._lastPos;if(!g||!y||y.equals(h)||!this._box&&h.dist(g)<this._clickTolerance)return;this._lastPos=h,this._box||(this._box=Fe("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));let x=Math.min(g.x,h.x),E=Math.max(g.x,h.x),T=Math.min(g.y,h.y),A=Math.max(g.y,h.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${x}px,${T}px)`,this._box.style.width=E-x+"px",this._box.style.height=A-T+"px")})}mouseupWindow(t,o){if(!this._active)return;let h=this._startPos,g=o;if(h&&t.button===0){if(this.reset(),jr(),h.x!==g.x||h.y!==g.y)return this._map.fire(new i.z("boxzoomend",{originalEvent:t})),{cameraAnimation:y=>y.fitScreenCoordinates(h,g,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Sr(),delete this._startPos,delete this._lastPos}_fireEvent(t,o){return this._map.fire(new i.z(t,{originalEvent:o}))}}function ih(d,t){let o={};for(let h=0;h<d.length;h++)o[d[h].identifier]=t[h];return o}class Kg{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,o,h){(this.centroid||h.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),h.length===this.numTouches&&(this.centroid=(function(g){let y=new i.P(0,0);for(let x of g)y._add(x);return y.div(g.length)})(o),this.touches=ih(h,o)))}touchmove(t,o,h){if(this.aborted||!this.centroid)return;let g=ih(h,o);for(let y in this.touches){let x=g[y];(!x||x.dist(this.touches[y])>30)&&(this.aborted=!0)}}touchend(t,o,h){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),h.length===0){let g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class wl{constructor(t){this.singleTap=new Kg(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,o,h){this.singleTap.touchstart(t,o,h)}touchmove(t,o,h){this.singleTap.touchmove(t,o,h)}touchend(t,o,h){let g=this.singleTap.touchend(t,o,h);if(g){let y=t.timeStamp-this.lastTime<500,x=!this.lastTap||this.lastTap.dist(g)<30;if(y&&x||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class Jg{constructor(){this._zoomIn=new wl({numTouches:1,numTaps:2}),this._zoomOut=new wl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,o,h){this._zoomIn.touchstart(t,o,h),this._zoomOut.touchstart(t,o,h)}touchmove(t,o,h){this._zoomIn.touchmove(t,o,h),this._zoomOut.touchmove(t,o,h)}touchend(t,o,h){let g=this._zoomIn.touchend(t,o,h),y=this._zoomOut.touchend(t,o,h);return g?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:x=>x.easeTo({duration:300,zoom:x.getZoom()+1,around:x.unproject(g)},{originalEvent:t})}):y?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:x=>x.easeTo({duration:300,zoom:x.getZoom()-1,around:x.unproject(y)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}let rp={0:1,2:2},op={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Su{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,o){return!1}_move(t,o){return{}}mousedown(t,o){if(this._lastPoint)return;let h=ud(t);this._correctButton(t,h)&&(this._lastPoint=o,this._eventButton=h)}mousemoveWindow(t,o){let h=this._lastPoint;if(h){if(t.preventDefault(),this._eventButton!=null&&(function(g,y){let x=rp[y];return g.buttons===void 0||(g.buttons&x)!==x})(t,this._eventButton))this.reset();else if(this._moved||!(o.dist(h)<this._clickTolerance))return this._moved=!0,this._lastPoint=o,this._move(h,o)}}mouseupWindow(t){this._lastPoint&&ud(t)===this._eventButton&&(this._moved&&jr(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Qg extends Su{mousedown(t,o){super.mousedown(t,o),this._lastPoint&&(this._active=!0)}_correctButton(t,o){return o===0&&!t.ctrlKey}_move(t,o){return{around:o,panDelta:o.sub(t)}}}class sp extends Su{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?op[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=.8*(o.x-t.x);if(h)return this._active=!0,{bearingDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class e_ extends Su{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?op[t.pitchRotateKey]:void 0}_correctButton(t,o){return this._pitchRotateKey?o===0&&t[this._pitchRotateKey]:o===0&&t.ctrlKey||o===2}_move(t,o){let h=-.5*(o.y-t.y);if(h)return this._active=!0,{pitchDelta:h}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class l0{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=o.clickTolerance||1,this.reset(),i.aX(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new i.P(0,0)}touchstart(t,o,h){return this._calculateTransform(t,o,h)}touchmove(t,o,h){if(this._active&&!(h.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(h.length===1&&!i.eT())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,o,h)}}touchend(t,o,h){this._calculateTransform(t,o,h),this._active&&h.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,o,h){h.length>0&&(this._active=!0);let g=ih(h,o),y=new i.P(0,0),x=new i.P(0,0),E=0;for(let A in g){let M=g[A],L=this._touches[A];L&&(y._add(M),x._add(M.sub(L)),E++,g[A]=M)}if(this._touches=g,E<this._minTouches||!x.mag())return;let T=x.div(E);return this._sum._add(T),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(E),panDelta:T}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Fe("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class ap{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,o,h){return{}}touchstart(t,o,h){this._firstTwoTouches||h.length<2||(this._firstTwoTouches=[h[0].identifier,h[1].identifier],this._start([o[0],o[1]]))}touchmove(t,o,h){let g=this._firstTwoTouches;if(!g)return;t.preventDefault();let[y,x]=g,E=rh(h,o,y),T=rh(h,o,x);if(!E||!T)return;let A=this._aroundCenter?null:E.add(T).div(2);return this._move([E,T],A,t)}touchend(t,o,h){if(!this._firstTwoTouches)return;let[g,y]=this._firstTwoTouches,x=rh(h,o,g),E=rh(h,o,y);x&&E||(this._active&&jr(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function rh(d,t,o){for(let h=0;h<d.length;h++)if(d[h].identifier===o)return t[h]}function t_(d,t){return Math.log2(d/t)}class c0 extends ap{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,o){let h=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(t_(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:t_(this._distance,h),pinchAround:o}}}function n_(d,t){return 180*d.angleWith(t)/Math.PI}class u0 extends ap{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,o){let h=this._vector;if(this._vector=t[0].sub(t[1]),h&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:n_(this._vector,h),pinchAround:o}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());let o=25/(Math.PI*this._minDiameter)*360,h=this._startVector;if(!h)return!1;let g=n_(t,h);return Math.abs(g)<o}}function lp(d){return Math.abs(d.y)>Math.abs(d.x)}class d0 extends ap{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,lp(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,o,h){let g=this._lastPoints;if(!g)return;let y=t[0].sub(g[0]),x=t[1].sub(g[1]);return this._map._cooperativeGestures&&!i.eT()&&h.touches.length<3||(this._valid=this.gestureBeginsVertically(y,x,h.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(y.y+x.y)/2*-.5})}gestureBeginsVertically(t,o,h){if(this._valid!==void 0)return this._valid;let g=t.mag()>=2,y=o.mag()>=2;if(!g&&!y)return;if(!g||!y)return this._firstMove==null&&(this._firstMove=h),h-this._firstMove<100&&void 0;let x=t.y>0==o.y>0;return lp(t)&&lp(o)&&x}}let h0={panStep:100,bearingStep:15,pitchStep:10};class f0{constructor(){let t=h0;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let o=0,h=0,g=0,y=0,x=0;switch(t.keyCode){case 61:case 107:case 171:case 187:o=1;break;case 189:case 109:case 173:o=-1;break;case 37:t.shiftKey?h=-1:(t.preventDefault(),y=-1);break;case 39:t.shiftKey?h=1:(t.preventDefault(),y=1);break;case 38:t.shiftKey?g=1:(t.preventDefault(),x=-1);break;case 40:t.shiftKey?g=-1:(t.preventDefault(),x=1);break;default:return}return this._rotationDisabled&&(h=0,g=0),{cameraAnimation:E=>{let T=E.getZoom();E.easeTo({duration:300,easeId:"keyboardHandler",easing:p0,zoom:o?Math.round(T)+o*(t.shiftKey?2:1):T,bearing:E.getBearing()+h*this._bearingStep,pitch:E.getPitch()+g*this._pitchStep,offset:[-y*this._panStep,-x*this._panStep],center:E.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function p0(d){return d*(2-d)}let m0=4.000244140625,eE=1/450;class tE{constructor(t,o){this._map=t,this._el=t.getCanvasContainer(),this._handler=o,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=eE,i.aX(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||i.eT()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let o=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY,h=i.o.now(),g=h-(this._lastWheelEventTime||0);this._lastWheelEventTime=h,o!==0&&o%m0==0?this._type="wheel":o!==0&&Math.abs(o)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=o,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(g*o)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,o+=this._lastValue)),t.shiftKey&&o&&(o/=4),this._type&&(this._lastWheelEvent=t,this._delta-=o,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let o=lo(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:o,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let o=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){let A=this._type==="wheel"&&Math.abs(this._delta)>m0?this._wheelZoomRate:this._defaultZoomRate,M=2/(1+Math.exp(-Math.abs(this._delta*A)));this._delta<0&&M!==0&&(M=1/M);let L=o(),R=Math.pow(2,L),F=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):R;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(F*M))),this._type==="wheel"&&(this._startZoom=L,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let h=typeof this._targetZoom=="number"?this._targetZoom:o(),g=this._startZoom,y=this._easing,x,E=!1;if(this._type==="wheel"&&g&&y){let A=Math.min((i.o.now()-this._lastWheelEventTime)/200,1),M=y(A);x=i.ak(g,h,M),A<1?this._frameId||(this._frameId=!0):E=!0}else x=h,E=!0;this._active=!0,E&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let T=x-o();return T*this._lastDelta<0&&(T=0),{noInertia:!0,needsRenderFrame:!E,zoomDelta:T,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let o=i.eU;if(this._prevEase){let h=this._prevEase,g=(i.o.now()-h.start)/h.duration,y=h.easing(g+.01)-h.easing(g),x=.27/Math.sqrt(y*y+1e-4)*.01,E=Math.sqrt(.0729-x*x);o=i.eS(x,E,.25,1)}return this._prevEase={start:i.o.now(),duration:t,easing:o},o}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Fe("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Ci{constructor(t,o){this._clickZoom=t,this._tapZoom=o}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class g0{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,o){return t.preventDefault(),{cameraAnimation:h=>{h.easeTo({duration:300,zoom:h.getZoom()+(t.shiftKey?-1:1),around:h.unproject(o)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class nE{constructor(){this._tap=new wl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,o,h){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?h.length>0&&(this._swipePoint=o[0],this._swipeTouch=h[0].identifier):this._tap.touchstart(t,o,h))}touchmove(t,o,h){if(this._tapTime){if(this._swipePoint){if(h[0].identifier!==this._swipeTouch)return;let g=o[0],y=g.y-this._swipePoint.y;return this._swipePoint=g,t.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(t,o,h)}touchend(t,o,h){this._tapTime?this._swipePoint&&h.length===0&&this.reset():this._tap.touchend(t,o,h)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class iE{constructor(t,o,h){this._el=t,this._mousePan=o,this._touchPan=h}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class rE{constructor(t,o,h){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=o,this._mousePitch=h}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class oh{constructor(t,o,h,g){this._el=t,this._touchZoom=o,this._touchRotate=h,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}let sh=d=>d.zoom||d.drag||d.pitch||d.rotate;class i_ extends i.z{}class cp{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,o){let h=i.av([],o,t);this.radius=i.ag(h[2]<0?i.eW([],h,this.constants):[h[0],h[1],0])}projectRay(t){i.eW(t,t,this.constants),i.aw(t,t),i.eX(t,t,this.constants);let o=i.c4([],t,this.radius);if(o[2]>0){let h=i.c4([],[0,0,1],i.bI(o,[0,0,1])),g=i.c4([],i.aw([],[o[0],o[1],0]),this.radius),y=i.d7([],o,i.c4([],i.av([],i.d7([],g,h),o),2));o[0]=y[0],o[1]=y[1]}return o}}function Ds(d){return d.panDelta&&d.panDelta.mag()||d.zoomDelta||d.bearingDelta||d.pitchDelta}class up{constructor(t,o){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ip(t),this._bearingSnap=o.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new cp,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(o),i.aX(["handleEvent","handleWindowEvent"],this);let h=this._el;this._listeners=[[h,"touchstart",{passive:!0}],[h,"touchmove",{passive:!1}],[h,"touchend",void 0],[h,"touchcancel",void 0],[h,"mousedown",void 0],[h,"mousemove",void 0],[h,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[h,"mouseover",void 0],[h,"mouseout",void 0],[h,"dblclick",void 0],[h,"click",void 0],[h,"keydown",{capture:!1}],[h,"keyup",void 0],[h,"wheel",{passive:!1}],[h,"contextmenu",void 0],[window,"blur",void 0]];for(let[g,y,x]of this._listeners){let E=g===document?this.handleWindowEvent:this.handleEvent;g.addEventListener(y,E,x)}}destroy(){for(let[t,o,h]of this._listeners){let g=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(o,g,h)}}_addDefaultHandlers(t){let o=this._map,h=o.getCanvasContainer();this._add("mapEvent",new Xg(o,t));let g=o.boxZoom=new Yg(o,t);this._add("boxZoom",g);let y=new Jg,x=new g0;o.doubleClickZoom=new Ci(x,y),this._add("tapZoom",y),this._add("clickZoom",x);let E=new nE;this._add("tapDragZoom",E);let T=o.touchPitch=new d0(o);this._add("touchPitch",T);let A=new sp(t),M=new e_(t);o.dragRotate=new rE(t,A,M),this._add("mouseRotate",A,["mousePitch"]),this._add("mousePitch",M,["mouseRotate"]);let L=new Qg(t),R=new l0(o,t);o.dragPan=new iE(h,L,R),this._add("mousePan",L),this._add("touchPan",R,["touchZoom","touchRotate"]);let F=new u0,z=new c0;o.touchZoomRotate=new oh(h,z,F,E),this._add("touchRotate",F,["touchPan","touchZoom"]),this._add("touchZoom",z,["touchPan","touchRotate"]),this._add("blockableMapEvent",new pc(o));let j=o.scrollZoom=new tE(o,this);this._add("scrollZoom",j,["mousePan"]);let q=o.keyboard=new f0;this._add("keyboard",q);for(let $ of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[$]&&o[$].enable(t[$])}_add(t,o,h){this._handlers.push({handlerName:t,handler:o,allowed:h}),this._handlersById[t]=o}stop(t){if(!this._updatingCamera){for(let{handler:o}of this._handlers)o.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!sh(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,o,h){for(let g in t)if(g!==h&&(!o||o.indexOf(g)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){let o=[];for(let h of t)this._el.contains(h.target)&&o.push(h);return o}handleEvent(t,o){this._updatingCamera=!0;let h=t.type==="renderFrame",g=h?void 0:t,y={needsRenderFrame:!1},x={},E={},T=t.touches?this._getMapTouches(t.touches):void 0,A=T?Sa(this._el,T):h?void 0:lo(this._el,t);for(let{handlerName:R,handler:F,allowed:z}of this._handlers){if(!F.isEnabled())continue;let j;this._blockedByActive(E,z,R)?F.reset():F[o||t.type]&&(j=F[o||t.type](t,A,T),this.mergeHandlerResult(y,x,j,R,g),j&&j.needsRenderFrame&&this._triggerRenderFrame()),(j||F.isActive())&&(E[R]=F)}let M={};for(let R in this._previousActiveHandlers)E[R]||(M[R]=g);this._previousActiveHandlers=E,(Object.keys(M).length||Ds(y))&&(this._changes.push([y,x,M]),this._triggerRenderFrame()),(Object.keys(E).length||Ds(y))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:L}=y;L&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],L(this._map))}mergeHandlerResult(t,o,h,g,y){if(!h)return;Object.assign(t,h);let x={handlerName:g,originalEvent:h.originalEvent||y};h.zoomDelta!==void 0&&(o.zoom=x),h.panDelta!==void 0&&(o.drag=x),h.pitchDelta!==void 0&&(o.pitch=x),h.bearingDelta!==void 0&&(o.rotate=x)}_applyChanges(){let t={},o={},h={};for(let[g,y,x]of this._changes)g.panDelta&&(t.panDelta=(t.panDelta||new i.P(0,0))._add(g.panDelta)),g.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+g.pitchDelta),g.around!==void 0&&(t.around=g.around),g.aroundCoord!==void 0&&(t.aroundCoord=g.aroundCoord),g.pinchAround!==void 0&&(t.pinchAround=g.pinchAround),g.noInertia&&(t.noInertia=g.noInertia),Object.assign(o,y),Object.assign(h,x);this._updateMapTransform(t,o,h),this._changes=[]}_updateMapTransform(t,o,h){let g=this._map,y=g.transform,x=Z=>[Z.x,Z.y,Z.z];if((Z=>{let J=this._eventsInProgress.drag;return J&&!this._handlersById[J.handlerName].isActive()})()&&!Ds(t)){let Z=y.zoom;y.cameraElevationReference="sea",this._originalZoom!=null&&y._orthographicProjectionAtLowPitch&&y.projection.name!=="globe"&&y.pitch===0?(y.cameraElevationReference="ground",y.zoom=this._originalZoom):(y.recenterOnTerrain(),y.cameraElevationReference="ground"),Z!==y.zoom&&this._map._update(!0)}if(y._isCameraConstrained&&g._stop(!0),!Ds(t))return void this._fireEvents(o,h,!0);let{panDelta:E,zoomDelta:T,bearingDelta:A,pitchDelta:M,around:L,aroundCoord:R,pinchAround:F}=t;y._isCameraConstrained&&(T>0&&(T=0),y._isCameraConstrained=!1),F!==void 0&&(L=F),(T||(Z=>o[Z]&&!this._eventsInProgress[Z])("drag"))&&L&&(this._dragOrigin=x(y.pointCoordinate3D(L)),this._originalZoom=y.zoom,this._trackingEllipsoid.setup(y._camera.position,this._dragOrigin)),y.cameraElevationReference="sea",g._stop(!0),L=L||g.transform.centerPoint,A&&(y.bearing+=A),M&&(y.pitch+=M),y._updateCameraState();let z=[0,0,0];if(E)if(y.projection.name==="mercator"){let Z=this._trackingEllipsoid.projectRay(y.screenPointToMercatorRay(L).dir),J=this._trackingEllipsoid.projectRay(y.screenPointToMercatorRay(L.sub(E)).dir);z[0]=J[0]-Z[0],z[1]=J[1]-Z[1]}else{let Z=y.pointCoordinate(L);if(y.projection.name==="globe"){E=E.rotate(-y.angle);let J=y._pixelsPerMercatorPixel/y.worldSize;z[0]=-E.x*i.eV(i.a_(Z.y))*J,z[1]=-E.y*i.eV(y.center.lat)*J}else{let J=y.pointCoordinate(L.sub(E));Z&&J&&(z[0]=J.x-Z.x,z[1]=J.y-Z.y)}}let j=y.zoom,q=[0,0,0];if(T){let Z=x(R||y.pointCoordinate3D(L)),J={dir:i.aw([],i.av([],Z,y._camera.position))};if(J.dir[2]<0){let Y=y.zoomDeltaToMovement(Z,T);i.c4(q,J.dir,Y)}}let $=i.d7(z,z,q);y._translateCameraConstrained($),T&&Math.abs(y.zoom-j)>1e-4&&y.recenterOnTerrain(),y.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(o,h,!0)}_fireEvents(t,o,h){let g=sh(this._eventsInProgress),y=sh(t),x={};for(let M in t){let{originalEvent:L}=t[M];this._eventsInProgress[M]||(x[`${M}start`]=L),this._eventsInProgress[M]=t[M]}!g&&y&&this._fireEvent("movestart",y.originalEvent);for(let M in x)this._fireEvent(M,x[M]);y&&this._fireEvent("move",y.originalEvent);for(let M in t){let{originalEvent:L}=t[M];this._fireEvent(M,L)}let E={},T;for(let M in this._eventsInProgress){let{handlerName:L,originalEvent:R}=this._eventsInProgress[M];this._handlersById[L].isActive()||(delete this._eventsInProgress[M],T=o[L]||R,E[`${M}end`]=T)}for(let M in E)this._fireEvent(M,E[M]);let A=sh(this._eventsInProgress);if(h&&(g||y)&&!A){this._updatingCamera=!0;let M=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),L=R=>R!==0&&-this._bearingSnap<R&&R<this._bearingSnap;M?(L(M.bearing||this._map.getBearing())&&(M.bearing=0),this._map.easeTo(M,{originalEvent:T})):(this._map.fire(new i.z("moveend",{originalEvent:T})),L(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,o){this._map.fire(new i.z(t,o?{originalEvent:o}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new i_("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}let nr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class ma extends i.E{constructor(t,o){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=o.bearingSnap,this._respectPrefersReducedMotion=o.respectPrefersReducedMotion!==!1,i.aX(["_renderFrameCallback"],this)}getCenter(){return new i.aS(this.transform.center.lng,this.transform.center.lat)}setCenter(t,o){return this.jumpTo({center:t},o)}panBy(t,o,h){return t=i.P.convert(t).mult(-1),this.panTo(this.transform.center,Object.assign({offset:t},o),h)}panTo(t,o,h){return this.easeTo(Object.assign({center:t},o),h)}getZoom(){return this.transform.zoom}setZoom(t,o){return this.jumpTo({zoom:t},o),this}zoomTo(t,o,h){return this.easeTo(Object.assign({zoom:t},o),h)}zoomIn(t,o){return this.zoomTo(this.getZoom()+1,t,o),this}zoomOut(t,o){return this.zoomTo(this.getZoom()-1,t,o),this}getBearing(){return this.transform.bearing}setBearing(t,o){return this.jumpTo({bearing:t},o),this}getPadding(){return this.transform.padding}setPadding(t,o){return this.jumpTo({padding:t},o),this}rotateTo(t,o,h){return this.easeTo(Object.assign({bearing:t},o),h)}resetNorth(t,o){return this.rotateTo(0,Object.assign({duration:1e3},t),o),this}resetNorthPitch(t,o){return this.easeTo(Object.assign({bearing:0,pitch:0,duration:1e3},t),o),this}snapToNorth(t,o){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,o):this}getPitch(){return this.transform.pitch}setPitch(t,o){return this.jumpTo({pitch:t},o),this}cameraForBounds(t,o){t=i.aI.convert(t);let h=o&&o.bearing||0,g=o&&o.pitch||0,y=t.getNorthWest(),x=t.getSouthEast();return this._cameraForBounds(this.transform,y,x,h,g,o)}_extendPadding(t){let o={top:0,right:0,bottom:0,left:0};return t==null?Object.assign({},o,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:Object.assign({},o,t)}_extendCameraOptions(t){return(t=Object.assign({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,o){let h=o.max[0]-o.min[0],g=o.max[1]-o.min[1];return h/g>t.aspect?h/(2*Math.tan(.5*t.fovX)*t.aspect):g/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,o,h,g,y,x){let E=t.clone(),T=this._extendCameraOptions(x);E.bearing=g,E.pitch=y;let A=i.aS.convert(o),M=i.aS.convert(h),L=.5*(A.lat+M.lat),R=.5*(A.lng+M.lng),F=i.eY(L,R),z=i.aw([],F),j=i.aw([],i.bH([],z,[0,1,0])),q=i.bH([],j,z),$=[j[0],j[1],j[2],0,q[0],q[1],q[2],0,z[0],z[1],z[2],0,0,0,0,1],Z=[F,i.eY(A.lat,A.lng),i.eY(M.lat,A.lng),i.eY(M.lat,M.lng),i.eY(A.lat,M.lng),i.eY(L,A.lng),i.eY(L,M.lng),i.eY(A.lat,R),i.eY(M.lat,R)],J=i.d8.fromPoints(Z.map(De=>[i.bI(j,De),i.bI(q,De),i.bI(z,De)])),Y=i.af([],J.center,$);i.eZ(Y)===0&&i.e_(Y,0,0,1),i.aw(Y,Y),i.c4(Y,Y,i.aD),E.center=i.e$(Y);let ae=E.getWorldToCameraMatrix(),Q=i.bk(new Float64Array(16),ae);J=i.d8.applyTransform(J,i.aB([],ae,$));let ce=this._extendAABB(J,E,T,g);if(!ce)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");J=ce,i.af(Y,Y,ae);let se=.5*(J.max[2]-J.min[2]),ie=this._minimumAABBFrustumDistance(E,J),ue=i.c4([],[0,0,1],se),be=i.d7(ue,Y,ue),ye=ie+(E.pitch===0?0:i.bF(Y,be)),Pe=E.globeCenterInViewSpace,Se=i.av([],Y,[Pe[0],Pe[1],Pe[2]]);i.aw(Se,Se),i.c4(Se,Se,ye);let Be=i.d7([],Y,Se);i.af(Be,Be,Q);let tt=i.eL/i.aD,Ie=i.ag(Be),me=i.ce(Math.max(Ie*tt-i.eL,Number.EPSILON),0),Ve=Math.min(E.zoomFromMercatorZAdjusted(me),T.maxZoom);return Ve>.5*(i.cZ+i.cK)?(E.setProjection({name:"mercator"}),E.zoom=Ve,this._cameraForBounds(E,o,h,g,y,x)):{center:E.center,zoom:Ve,bearing:g,pitch:y}}_extendAABB(t,o,h,g){let y=.5*((h.padding.left||0)+(h.padding.right||0)),x=.5*((h.padding.top||0)+(h.padding.bottom||0)),E=x,T=y,A=y,M=x,L=o.width-(T+A),R=o.height-(E+M),F=i.av([],t.max,t.min),z=Math.min(L/F[0],R/F[1]),j=Math.min(o.scaleZoom(o.scale*z),h.maxZoom);if(isNaN(j))return null;let q=o.scale/o.zoomScale(j),$=new i.d8([t.min[0]-T*q,t.min[1]-M*q,t.min[2]],[t.max[0]+A*q,t.max[1]+E*q,t.max[2]]),Z=(typeof h.offset.x=="number"&&typeof h.offset.y=="number"?new i.P(h.offset.x,h.offset.y):i.P.convert(h.offset)).rotate(-i.an(g));return $.center[0]-=Z.x*q,$.center[1]+=Z.y*q,$}queryTerrainElevation(t,o){let h=this.transform.elevation;return h?(o=Object.assign({},{exaggerated:!0},o),h.getAtPoint(i.ae.fromLngLat(t),null,o.exaggerated)):null}_cameraForBounds(t,o,h,g,y,x){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,o,h,g,y,x);let E=t.clone(),T=this._extendCameraOptions(x);E.bearing=g,E.pitch=y;let A=i.aS.convert(o),M=i.aS.convert(h),L=new i.aS(A.lng,M.lat),R=new i.aS(M.lng,A.lat),F=E.project(A),z=E.project(M),j=this.queryTerrainElevation(A),q=this.queryTerrainElevation(M),$=this.queryTerrainElevation(L),Z=this.queryTerrainElevation(R),J=[[F.x,F.y,Math.min(j||0,q||0,$||0,Z||0)],[z.x,z.y,Math.max(j||0,q||0,$||0,Z||0)]],Y=i.d8.fromPoints(J),ae=E.getWorldToCameraMatrix(),Q=i.bk(new Float64Array(16),ae);Y=i.d8.applyTransform(Y,ae);let ce=this._extendAABB(Y,E,T,g);if(!ce)return void i.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Y=ce;let se=.5*i.av([],Y.max,Y.min)[2],ie=this._minimumAABBFrustumDistance(E,Y),ue=[0,0,1,0];i.aC(ue,ue,ae),i.f0(ue,ue);let be=i.c4([],ue,ie+se),ye=i.d7([],Y.center,be);i.af(Y.center,Y.center,Q),i.af(ye,ye,Q);let Pe=E.unproject(new i.P(Y.center[0],Y.center[1])),Se=i.f1(E.projection,Pe),Be=Math.pow(2,Se),tt=Math.min(E._zoomFromMercatorZ(ye[2]*E.pixelsPerMeter*Be/E.worldSize),T.maxZoom);return E.mercatorFromTransition&&tt<.5*(i.cZ+i.cK)?(E.setProjection({name:"globe"}),E.zoom=tt,this._cameraForBounds(E,o,h,g,y,x)):{center:Pe,zoom:tt,bearing:g,pitch:y}}fitBounds(t,o,h){let g=this.cameraForBounds(t,o);return this._fitInternal(g,o,h)}fitScreenCoordinates(t,o,h,g,y){let x=i.P.convert(t),E=i.P.convert(o),T=new i.P(Math.min(x.x,E.x),Math.min(x.y,E.y)),A=new i.P(Math.max(x.x,E.x),Math.max(x.y,E.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(x,E))return this;let M=this.transform.pointLocation3D(T),L=this.transform.pointLocation3D(A),R=this.transform.pointLocation3D(new i.P(T.x,A.y)),F=this.transform.pointLocation3D(new i.P(A.x,T.y)),z=[Math.min(M.lng,L.lng,R.lng,F.lng),Math.min(M.lat,L.lat,R.lat,F.lat)],j=[Math.max(M.lng,L.lng,R.lng,F.lng),Math.max(M.lat,L.lat,R.lat,F.lat)],q=g&&g.pitch?g.pitch:this.getPitch(),$=this._cameraForBounds(this.transform,z,j,h,q,g);return this._fitInternal($,g,y)}_fitInternal(t,o,h){return t?(o=Object.assign(t,o)).linear?this.easeTo(o,h):this.flyTo(o,h):this}jumpTo(t,o){this.stop();let h=t.preloadOnly?this.transform.clone():this.transform,g=!1,y=!1,x=!1;"zoom"in t&&h.zoom!==+t.zoom&&(g=!0,h.zoom=+t.zoom),t.center!==void 0&&(h.center=i.aS.convert(t.center)),"bearing"in t&&h.bearing!==+t.bearing&&(y=!0,h.bearing=+t.bearing),"pitch"in t&&h.pitch!==+t.pitch&&(x=!0,h.pitch=+t.pitch);let E=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!h.isPaddingEqual(E))if(t.retainPadding===!1){let T=h.clone();T.padding=E,h.setLocationAtPoint(h.center,T.centerPoint)}else h.padding=E;return t.preloadOnly?(this._preloadTiles(h),this):(this.fire(new i.z("movestart",o)).fire(new i.z("move",o)),g&&this.fire(new i.z("zoomstart",o)).fire(new i.z("zoom",o)).fire(new i.z("zoomend",o)),y&&this.fire(new i.z("rotatestart",o)).fire(new i.z("rotate",o)).fire(new i.z("rotateend",o)),x&&this.fire(new i.z("pitchstart",o)).fire(new i.z("pitch",o)).fire(new i.z("pitchend",o)),this.fire(new i.z("moveend",o)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||i.w(nr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,o){let h=this.transform;if(!h.projection.supportsFreeCamera)return i.w(nr),this;this.stop();let g=h.zoom,y=h.pitch,x=h.bearing;h.setFreeCameraOptions(t);let E=g!==h.zoom,T=y!==h.pitch,A=x!==h.bearing;return this.fire(new i.z("movestart",o)).fire(new i.z("move",o)),E&&this.fire(new i.z("zoomstart",o)).fire(new i.z("zoom",o)).fire(new i.z("zoomend",o)),A&&this.fire(new i.z("rotatestart",o)).fire(new i.z("rotate",o)).fire(new i.z("rotateend",o)),T&&this.fire(new i.z("pitchstart",o)).fire(new i.z("pitch",o)).fire(new i.z("pitchend",o)),this.fire(new i.z("moveend",o)),this}easeTo(t,o){this._stop(!1,t.easeId),((t=Object.assign({offset:[0,0],duration:500,easing:i.eU},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);let h=this.transform,g=this.getZoom(),y=this.getBearing(),x=this.getPitch(),E=this.getPadding(),T="zoom"in t?+t.zoom:g,A="bearing"in t?this._normalizeBearing(t.bearing,y):y,M="pitch"in t?+t.pitch:x,L=this._extendPadding(t.padding),R=i.P.convert(t.offset),F,z,j;if(h.projection.name==="globe"){let ue=i.ae.fromLngLat(h.center),be=R.rotate(-h.angle);ue.x+=be.x/h.worldSize,ue.y+=be.y/h.worldSize;let ye=ue.toLngLat(),Pe=i.aS.convert(t.center||ye);this._normalizeCenter(Pe),F=h.centerPoint.add(be),z=new i.P(ue.x,ue.y).mult(h.worldSize),j=new i.P(i.aF(Pe.lng),i.aJ(Pe.lat)).mult(h.worldSize).sub(z)}else{F=h.centerPoint.add(R);let ue=h.pointLocation(F),be=i.aS.convert(t.center||ue);this._normalizeCenter(be),z=h.project(ue),j=h.project(be).sub(z)}let q=h.zoomScale(T-g),$,Z;t.around&&($=i.aS.convert(t.around),Z=h.locationPoint($));let J=this._zooming||T!==g,Y=this._rotating||y!==A,ae=this._pitching||M!==x,Q=!h.isPaddingEqual(L),ce=t.retainPadding===!1?h.clone():h,se=ue=>be=>{if(J&&(ue.zoom=i.ak(g,T,be)),Y&&(ue.bearing=i.ak(y,A,be)),ae&&(ue.pitch=i.ak(x,M,be)),Q&&(ce.interpolatePadding(E,L,be),F=ce.centerPoint.add(R)),$)ue.setLocationAtPoint($,Z);else{let ye=ue.zoomScale(ue.zoom-g),Pe=T>g?Math.min(2,q):Math.max(.5,q),Se=Math.pow(Pe,1-be),Be=ue.unproject(z.add(j.mult(be*Se)).mult(ye));ue.setLocationAtPoint(ue.renderWorldCopies?Be.wrap():Be,F)}return t.preloadOnly||this._fireMoveEvents(o),ue};if(t.preloadOnly){let ue=this._emulate(se,t.duration,h);return this._preloadTiles(ue),this}let ie={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=J,this._rotating=Y,this._pitching=ae,this._padding=Q,this._easeId=t.easeId,this._prepareEase(o,t.noMoveStart,ie),this._ease(se(h),ue=>{h.cameraElevationReference==="sea"&&h.recenterOnTerrain(),this._afterEase(o,ue)},t),this}_prepareEase(t,o,h={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),o||h.moving||this.fire(new i.z("movestart",t)),this._zooming&&!h.zooming&&this.fire(new i.z("zoomstart",t)),this._rotating&&!h.rotating&&this.fire(new i.z("rotatestart",t)),this._pitching&&!h.pitching&&this.fire(new i.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new i.z("move",t)),this._zooming&&this.fire(new i.z("zoom",t)),this._rotating&&this.fire(new i.z("rotate",t)),this._pitching&&this.fire(new i.z("pitch",t))}_afterEase(t,o){if(this._easeId&&o&&this._easeId===o)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let h=this._zooming,g=this._rotating,y=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,h&&this.fire(new i.z("zoomend",t)),g&&this.fire(new i.z("rotateend",t)),y&&this.fire(new i.z("pitchend",t)),this.fire(new i.z("moveend",t))}flyTo(t,o){if(this._prefersReducedMotion(t)){let De=i.aH(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(De,o)}this.stop(),t=Object.assign({offset:[0,0],speed:1.2,curve:1.42,easing:i.eU},t);let h=this.transform,g=this.getZoom(),y=this.getBearing(),x=this.getPitch(),E=this.getPadding(),T="zoom"in t?i.aA(+t.zoom,h.minZoom,h.maxZoom):g,A="bearing"in t?this._normalizeBearing(t.bearing,y):y,M="pitch"in t?+t.pitch:x,L=this._extendPadding(t.padding),R=h.zoomScale(T-g),F=i.P.convert(t.offset),z=h.centerPoint.add(F),j=h.pointLocation(z),q=i.aS.convert(t.center||j);this._normalizeCenter(q);let $=h.project(j),Z=h.project(q).sub($),J=t.curve,Y=Math.max(h.width,h.height),ae=Y/R,Q=Z.mag();if("minZoom"in t){let De=i.aA(Math.min(t.minZoom,g,T),h.minZoom,h.maxZoom),Ge=Y/h.zoomScale(De-g);J=Math.sqrt(Ge/Q*2)}let ce=J*J;function se(De){let Ge=(ae*ae-Y*Y+(De?-1:1)*ce*ce*Q*Q)/(2*(De?ae:Y)*ce*Q);return Math.log(Math.sqrt(Ge*Ge+1)-Ge)}function ie(De){return(Math.exp(De)-Math.exp(-De))/2}function ue(De){return(Math.exp(De)+Math.exp(-De))/2}let be=se(0),ye=function(De){return ue(be)/ue(be+J*De)},Pe=function(De){return Y*((ue(be)*(ie(Ge=be+J*De)/ue(Ge))-ie(be))/ce)/Q;var Ge},Se=(se(1)-be)/J;if(Math.abs(Q)<1e-6||!isFinite(Se)){if(Math.abs(Y-ae)<1e-6)return this.easeTo(t,o);let De=ae<Y?-1:1;Se=Math.abs(Math.log(ae/Y))/J,Pe=function(){return 0},ye=function(Ge){return Math.exp(De*J*Ge)}}t.duration="duration"in t?+t.duration:1e3*Se/("screenSpeed"in t?+t.screenSpeed/J:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);let Be=y!==A,tt=M!==x,Ie=!h.isPaddingEqual(L),me=t.retainPadding===!1?h.clone():h,Ve=De=>Ge=>{let ot=Ge*Se,xt=1/ye(ot);De.zoom=Ge===1?T:g+De.scaleZoom(xt),Be&&(De.bearing=i.ak(y,A,Ge)),tt&&(De.pitch=i.ak(x,M,Ge)),Ie&&(me.interpolatePadding(E,L,Ge),z=me.centerPoint.add(F));let Je=Ge===1?q:De.unproject($.add(Z.mult(Pe(ot))).mult(xt));return De.setLocationAtPoint(De.renderWorldCopies?Je.wrap():Je,z),De._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(o),De};if(t.preloadOnly){let De=this._emulate(Ve,t.duration,h);return this._preloadTiles(De),this}return this._zooming=!0,this._rotating=Be,this._pitching=tt,this._padding=Ie,this._prepareEase(o,!1),this._ease(Ve(h),()=>this._afterEase(o),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,o){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let h=this._onEaseEnd;this._onEaseEnd=void 0,h.call(this,o)}if(!t){let h=this.handlers;h&&h.stop(!1)}return this}_ease(t,o,h){h.animate===!1||h.duration===0?(t(1),o()):(this._easeStart=i.o.now(),this._easeOptions=h,this._onEaseFrame=t,this._onEaseEnd=o,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let t=Math.min((i.o.now()-this._easeStart)/this._easeOptions.duration,1),o=this._onEaseFrame;o&&o(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,o){t=i.bS(t,-180,180);let h=Math.abs(t-o);return Math.abs(t-360-o)<h&&(t-=360),Math.abs(t+360-o)<h&&(t+=360),t}_normalizeCenter(t){let o=this.transform;if(o.maxBounds||o.projection.name!=="globe"&&!o.renderWorldCopies)return;let h=t.lng-o.center.lng;t.lng+=h>180?-360:h<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&i.o.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,o,h){let g=Math.ceil(15*o/1e3),y=[],x=t(h.clone());for(let E=0;E<=g;E++){let T=x(E/g);y.push(T.clone())}return y}_preloadTiles(t,o){}}class Du{constructor(t={}){this.options=t,i.aX(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){let o=this.options&&this.options.compact,h=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Fe("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",h);let g=Fe("span","mapboxgl-ctrl-icon",this._compactButton);return g.setAttribute("aria-hidden","true"),g.setAttribute("title",h),this._innerContainer=Fe("div","mapboxgl-ctrl-attrib-inner",this._container),o&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),o===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));let o=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||i.e.ACCESS_TOKEN}];if(t){let h=o.reduce((g,y,x)=>(y.value&&(g+=`${y.key}=${y.value}${x<o.length-1?"&":""}`),g),"?");t.href=`${i.e.FEEDBACK_URL}/${h}#${np(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||(t.dataType!=="source"||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility")&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){let g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}let o=this._map.style._mergedSourceCaches;for(let g in o){let y=o[g];if(y.used){let x=y.getSource();x.attribution&&t.indexOf(x.attribution)<0&&t.push(x.attribution)}}t.sort((g,y)=>g.length-y.length),t=t.filter((g,y)=>{for(let x=y+1;x<t.length;x++)if(t[x].indexOf(g)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));let h=t.join(" | ");h!==this._attribHTML&&(this._attribHTML=h,t.length?(this._innerContainer.innerHTML=h,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class ah{constructor(){i.aX(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=Fe("div","mapboxgl-ctrl");let o=Fe("a","mapboxgl-ctrl-logo");return o.target="_blank",o.rel="noopener nofollow",o.href="https://www.mapbox.com/",o.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),o.setAttribute("rel","noopener nofollow"),this._container.appendChild(o),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(let o in t){let h=t[o].getSource();if(h.hasOwnProperty("mapbox_logo")&&!h.mapbox_logo)return!1}return!0}_updateCompact(){let t=this._container.children;if(t.length){let o=t[0];this._map.getCanvasContainer().offsetWidth<250?o.classList.add("mapboxgl-compact"):o.classList.remove("mapboxgl-compact")}}}class r_{constructor(){i.aX(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("selector-update",o=>this._onIndoorUpdate(o)),this._container}_createButton(t,o){let h=Fe("button",t,this._container);return h.type="button",h.addEventListener("click",o),h}_createSeparator(){return Fe("div","mapboxgl-ctrl-separator",this._container)}_setButtonTitle(t,o){this._map&&(t.setAttribute("aria-label",o),t.textContent=o)}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("selector-update",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return this._model=t,void(this._container.style.display="none");let o=this._model;this._model=t,this._container.style.display="inline-block",this._container.style.borderRadius="8px",o&&Array.from(this._container.children).forEach(h=>h.remove()),t.floors.length>0&&(this.addBuildingsToggleButton(),this.addCurrentFloors(t.floors,t.activeFloorsVisible),this._updateBuildingsButtonState())}addBuildingsToggleButton(){let t=this._createButton("mapboxgl-ctrl-buildings-toggle",()=>{let o=this._map;this._model&&o&&o._setIndoorActiveFloorsVisibility(!this._model.activeFloorsVisible)});Fe("span","mapboxgl-ctrl-icon",t).setAttribute("aria-hidden","true"),t.classList.add("mapboxgl-ctrl-level-button","mapboxgl-ctrl-buildings-toggle"),this._model&&!this._model.activeFloorsVisible&&t.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(t),this._createSeparator()}_updateBuildingsButtonState(){let t=this._container.querySelector(".mapboxgl-ctrl-buildings-toggle");t&&this._model&&(this._model.activeFloorsVisible?t.classList.remove("mapboxgl-ctrl-level-button-selected"):t.classList.add("mapboxgl-ctrl-level-button-selected"))}addCurrentFloors(t,o){for(let h=0;h<t.length;h++){let g=t[h],y=this._createButton("mapboxgl-ctrl-level-button",()=>{this._map._selectIndoorFloor(g.id)});this._setButtonTitle(y,g.zIndex.toString()),this._model&&g.id===this._model.selectedFloorId&&o&&y.classList.add("mapboxgl-ctrl-level-button-selected"),this._container.append(y),h<t.length-1&&this._createSeparator()}}}class _0{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){let o=++this._id;return this._queue.push({callback:t,id:o,cancelled:!1}),o}remove(t){let o=this._currentlyRunning,h=o?this._queue.concat(o):this._queue;for(let g of h)if(g.id===t)return void(g.cancelled=!0)}run(t=0){let o=this._currentlyRunning=this._queue;this._queue=[];for(let h of o)if(!h.cancelled&&(h.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class lh{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;let o=i.dC((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-o)+this._end*o}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,o,h){this._start=this.getValue(o),this._end=t,this._startTime=o,this._endTime=o+h}}let oE={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class y0 extends i.z{constructor(t,o,h,g){let{point:y,lngLat:x,originalEvent:E,target:T}=t;super(t.type,{point:y,lngLat:x,originalEvent:E,target:T}),this.preventDefault=()=>{t.preventDefault()},this.id=o,this.interaction=h,this.feature=g}}class o_{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,o){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);let h=o.filter,g=o.type;h&&this.filters.set(t,i.b5(h)),g==="mouseover"&&(g="mouseenter"),g==="mouseout"&&(g="mouseleave");let y=this.interactionsByType.get(g)||new Map;g==="mouseenter"||g==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,o)):y.size===0&&this.map.on(g,this.handleType),y.size===0&&this.interactionsByType.set(g,y),y.set(t,o),this.typeById.set(t,g)}get(t){let o=this.typeById.get(t);if(!o)return;let h=this.interactionsByType.get(o);return h?h.get(t):void 0}remove(t){let o=this.typeById.get(t);if(!o)return;this.typeById.delete(t),this.filters.delete(t);let h=this.interactionsByType.get(o);h&&(h.delete(t),o==="mouseenter"||o==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):h.size===0&&this.map.off(o,this.handleType))}queryTargets(t,o){let h=[];for(let[g,y]of o)y.target&&h.push({targetId:g,target:y.target,filter:this.filters.get(g)});return this.map.style.queryRenderedTargets(t,h,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let o=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());o.length&&(t.type="mouseenter",this.handleType(t,o));let h=new Map;for(let[g,{feature:y}]of this.prevHoveredFeatures)this.hoveredFeatures.has(g)||h.set(y.id,y);h.size&&(t.type="mouseleave",this.handleType(t,Array.from(h.values())))}handleOut(t){let o=Array.from(this.hoveredFeatures.values()).map(({feature:h})=>h);o.length&&(t.type="mouseleave",this.handleType(t,o)),this.hoveredFeatures.clear()}handleType(t,o){let h=t.type==="mouseenter";if(h&&!this.interactionsByType.has(t.type))return void i.w("mouseenter interaction required for mouseleave to work.");let g=Array.from(this.interactionsByType.get(t.type)).reverse(),y=!!o;o=o||this.queryTargets(t.point,g);let x=!1,E=new Set;for(let T of o){for(let[A,M]of g){if(!M.target)continue;let L=T.variants?T.variants[A]:null;if(L){for(let R of L){if(Oo(R,T,E,A))continue;let F=new i.dw(T,R),z=Us(R,T,A);y&&F.id!==void 0&&(F.state=this.map.getFeatureState(F));let j=h?this.prevHoveredFeatures.get(z):null,q=new y0(t,A,M,F),$=j?j.stop:M.handler(q);if(h&&this.hoveredFeatures.set(z,{feature:T,stop:$}),$!==!1){x=!0;break}}if(x)break}}if(x)break}if(!x)for(let[T,A]of g){let{handler:M,target:L}=A;if(!L&&M(new y0(t,T,A,null))!==!1)break}}}function s_(d,t){if(Array.isArray(d)&&Array.isArray(t)){let o=new Set(d),h=new Set(t);return o.size===h.size&&d.every(g=>h.has(g))}return i.bx(d,t)}let dp={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},hp={showCompass:!0,showZoom:!0,visualizePitch:!1};class ch{constructor(t,o,h=!1){this._clickTolerance=10,this.element=o,this.mouseRotate=new sp({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,h&&(this.mousePitch=new e_({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),i.aX(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),o.addEventListener("mousedown",this.mousedown),o.addEventListener("touchstart",this.touchstart,{passive:!1}),o.addEventListener("touchmove",this.touchmove),o.addEventListener("touchend",this.touchend),o.addEventListener("touchcancel",this.reset)}down(t,o){this.mouseRotate.mousedown(t,o),this.mousePitch&&this.mousePitch.mousedown(t,o),qn()}move(t,o){let h=this.map,g=this.mouseRotate.mousemoveWindow(t,o),y=g&&g.bearingDelta;if(y&&h.setBearing(h.getBearing()+y),this.mousePitch){let x=this.mousePitch.mousemoveWindow(t,o),E=x&&x.pitchDelta;E&&h.setPitch(h.getPitch()+E)}}off(){let t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Sr(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Object.assign({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),lo(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,lo(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Sa(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=Sa(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function Va(d,t,o){if(d=new i.aS(d.lng,d.lat),t){let h=new i.aS(d.lng-360,d.lat),g=new i.aS(d.lng+360,d.lat),y=360*Math.ceil(Math.abs(d.lng-o.center.lng)/360),x=o.locationPoint3D(d).distSqr(t),E=t.x<0||t.y<0||t.x>o.width||t.y>o.height;o.locationPoint3D(h).distSqr(t)<x&&(E||Math.abs(h.lng-o.center.lng)<y)?d=h:o.locationPoint3D(g).distSqr(t)<x&&(E||Math.abs(g.lng-o.center.lng)<y)&&(d=g)}for(;Math.abs(d.lng-o.center.lng)>180;){let h=o.locationPoint3D(d);if(h.x>=0&&h.y>=0&&h.x<=o.width&&h.y<=o.height)break;d.lng>o.center.lng?d.lng-=360:d.lng+=360}return d}let $s={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Zr={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class ja extends i.E{constructor(t,o){super(),(t instanceof HTMLElement||o)&&(t=Object.assign({element:t},o)),i.aX(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);let{anchor:h="center",color:g="#3FB1CE",scale:y=1,draggable:x=!1,clickTolerance:E=0,rotation:T=Zr.rotation,rotationAlignment:A=Zr.rotationAlignment,pitchAlignment:M=Zr.pitchAlignment,occludedOpacity:L=Zr.occludedOpacity,altitude:R=Zr.altitude}=t||{};this._anchor=h,this._color=g,this._scale=y,this._draggable=x,this._clickTolerance=E,this._rotation=T,this._rotationAlignment=A,this._pitchAlignment=M,this._occludedOpacity=L,this._altitude=R,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=i.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=i.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",j=>{j.preventDefault()}),this._element.addEventListener("mousedown",j=>{j.preventDefault()});let F=this._element.classList;for(let j in $s)F.remove(`mapboxgl-marker-anchor-${j}`);F.add(`mapboxgl-marker-anchor-${this._anchor}`);let z=t&&t.className?t.className.trim().split(/\s+/):[];F.add(...z),this._popup=null}_createDefaultMarker(){let t=Fe("div"),o=yt("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){let h=yt("radialGradient",{id:"shadowGradient"},yt("defs",{},o));yt("stop",{offset:"10%","stop-opacity":.4},h),yt("stop",{offset:"100%","stop-opacity":.05},h),yt("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},o)}return yt("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},o),yt("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},o),yt("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},o),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){let t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=i.aS.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||Zr.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){let g=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){let o=t.code,h=t.charCode||t.keyCode;o!=="Space"&&o!=="Enter"&&h!==32&&h!==13||this.togglePopup()}_onMapClick(t){let o=t.originalEvent.target,h=this._element;this._popup&&(o===h||h.contains(o))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){let t=this._map,o=this._pos;if(!t||!o)return!1;let h=t.unproject(o,this._altitude),g=t.getFreeCameraOptions();if(!g.position)return!1;let y=g.position.toLngLat();return y.distanceTo(h)<.9*y.distanceTo(this._lngLat)}_evaluateOpacity(){let t=this._map;if(!t)return;let o=this._pos;if(!o||o.x<0||o.x>t.transform.width||o.y<0||o.y>t.transform.height)return void this._clearFadeTimer();let h=t.unproject(o,this._altitude),g;t._showingGlobe()&&i.f4(t.transform,this._lngLat)?g=0:(g=1-t._queryFogOpacity(h),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(g*=this._occludedOpacity)),this._element.style.opacity=`${g}`,this._element.style.pointerEvents=g>0?"auto":"none",this._popup&&this._popup._setOpacity(g),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let t=this._pos;if(!t||!this._map)return;let o=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${$s[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${o.x}px,${o.y}px)
        `}_calculateXYTransform(){let t=this._pos,o=this._map,h=this.getPitchAlignment();if(!o||!t||h!=="map")return"";if(!o._showingGlobe()){let T=o.getPitch();return T?`rotateX(${T}deg)`:""}let g=i.cW(i.f5(o.transform,this._lngLat)),y=t.sub(i.f6(o.transform)),x=Math.abs(y.x)+Math.abs(y.y);if(x===0)return"";let E=g/x;return`rotateX(${-y.y*E}deg) rotateY(${y.x*E}deg)`}_calculateZTransform(){let t=this._pos,o=this._map;if(!o||!t)return"";let h=0,g=this.getRotationAlignment();if(g==="map")if(o._showingGlobe()){let y=o.project(new i.aS(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),x=o.project(new i.aS(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(y);h=i.cW(Math.atan2(x.y,x.x))-90}else h=-o.getBearing();else if(g==="horizon"){let y=i.ah(4,6,o.getZoom()),x=i.f6(o.transform);x.y+=y*o.transform.height;let E=t.sub(x),T=i.cW(Math.atan2(E.y,E.x));h=(T>90?T-270:T+90)*(1-y)}return h+=this._rotation,h?`rotateZ(${h}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);let o=this._map;o&&(o.transform.renderWorldCopies&&(this._lngLat=Va(this._lngLat,this._pos,o.transform)),this._pos=o.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),o._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(o._showingGlobe()||o.getTerrain()||o.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=i.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){let o=this._map;if(!o)return;let h=this._pointerdownPos,g=this._positionDelta;if(h&&g){if(!this._isDragging){let y=this._clickTolerance||o._clickTolerance;if(t.point.dist(h)<y)return;this._isDragging=!0}this._pos=t.point.sub(g),this._lngLat=o.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new i.z("dragstart"))),this.fire(new i.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new i.z("dragend")),this._state="inactive"}_addDragHandler(t){let o=this._map,h=this._pos;o&&h&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(h),this._pointerdownPos=t.point,this._state="pending",o.on("mousemove",this._onMove),o.on("touchmove",this._onMove),o.once("mouseup",this._onUp),o.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;let o=this._map;return o&&(t?(o.on("mousedown",this._addDragHandler),o.on("touchstart",this._addDragHandler)):(o.off("mousedown",this._addDragHandler),o.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||Zr.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||Zr.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||Zr.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||Zr.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}let Gs={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},sE={maxWidth:100,unit:"metric"},aE={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},lE={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},cE=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function a_(d=new i.P(0,0),t="bottom"){if(typeof d=="number"){let o=Math.round(Math.sqrt(.5*Math.pow(d,2)));switch(t){case"top":return new i.P(0,d);case"top-left":return new i.P(o,o);case"top-right":return new i.P(-o,o);case"bottom":return new i.P(0,-d);case"bottom-left":return new i.P(o,-o);case"bottom-right":return new i.P(-o,-o);case"left":return new i.P(d,0);case"right":return new i.P(-d,0)}return new i.P(0,0)}return d instanceof i.P||Array.isArray(d)?i.P.convert(d):i.P.convert(d[t]||[0,0])}return{version:C,supported:ct.supported,setRTLTextPlugin:i.fa,getRTLTextPluginStatus:i.f9,Map:class extends ma{constructor(d){B.mark(k.create);let t=d;if((d=Object.assign({},dp,d)).minZoom!=null&&d.maxZoom!=null&&d.minZoom>d.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(d.minPitch!=null&&d.maxPitch!=null&&d.minPitch>d.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(d.minPitch!=null&&d.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(d.maxPitch!=null&&d.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(d.antialias&&i.f2(window)&&(d.antialias=!1,i.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new eu(d.minZoom,d.maxZoom,d.minPitch,d.maxPitch,d.renderWorldCopies,null,null),d),this._repaint=!!d.repaint,this._interactive=d.interactive,this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._failIfMajorPerformanceCaveat=d.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=d.preserveDrawingBuffer,this._antialias=d.antialias,this._trackResize=d.trackResize,this._bearingSnap=d.bearingSnap,this._refreshExpiredTiles=d.refreshExpiredTiles,this._fadeDuration=d.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=d.crossSourceCollisions,this._collectResourceTiming=d.collectResourceTiming,this._language=this._parseLanguage(d.language),this._worldview=d.worldview,this._renderTaskQueue=new _0,this._domRenderTaskQueue=new _0,this._controls=[],this._markers=[],this._popups=[],this._mapId=i.b1(),this._locale=Object.assign({},oE,d.locale),this._clickTolerance=d.clickTolerance,this._cooperativeGestures=d.cooperativeGestures,this._performanceMetricsCollection=d.performanceMetricsCollection,this._tessellationStep=d.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=d.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new lh(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=d.scaleFactor,this._requestManager=new sf(d.transformRequest,d.accessToken,d.testMode),this._silenceAuthErrors=!!d.testMode,this._contextCreateOptions=d.contextCreateOptions?Object.assign({},d.contextCreateOptions):{},typeof d.container=="string"){let o=document.getElementById(d.container);if(!o)throw new Error(`Container '${d.container.toString()}' not found.`);this._container=o}else{if(!(d.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=d.container}if(this._container.childNodes.length>0&&i.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),d.maxBounds&&this.setMaxBounds(d.maxBounds),this._spriteFormat=d.spriteFormat,i.aX(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new J1),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new up(this,d),this._localFontFamily=d.localFontFamily,this._localIdeographFontFamily=d.localIdeographFontFamily,(d.style||!d.testMode)&&this.setStyle(d.style||i.e.DEFAULT_STYLE,{config:d.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),d.projection&&this.setProjection(d.projection),d.hash&&(this._hash=new tp(typeof d.hash=="string"&&d.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:d.center,zoom:d.zoom,bearing:d.bearing,pitch:d.pitch});let o=d.bounds;o&&(this.resize(),this.fitBounds(o,Object.assign({},d.fitBoundsOptions,{duration:0})))}this.resize(),d.attributionControl&&this.addControl(new Du({customAttribution:d.customAttribution})),this._logoControl=new ah,this.addControl(this._logoControl,d.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent(),this._postStyleWithAppearanceEvent(),this._setupIndoor()}),this.on("data",o=>{this._update(o.dataType==="style"),this.fire(new i.z(`${o.dataType}data`,o))}),this.on("dataloading",o=>{this.fire(new i.z(`${o.dataType}dataloading`,o))}),this._interactions=new o_(this)}_getMapId(){return this._mapId}addControl(d,t){if(t===void 0&&(t=d.getDefaultPosition?d.getDefaultPosition():"top-right"),!d||!d.onAdd)return this.fire(new i.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let o=d.onAdd(this);this._controls.push(d);let h=this._controlPositions[t];return t.indexOf("bottom")!==-1?h.insertBefore(o,h.firstChild):h.appendChild(o),this}removeControl(d){if(!d||!d.onRemove)return this.fire(new i.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let t=this._controls.indexOf(d);return t>-1&&this._controls.splice(t,1),d.onRemove(this),this}hasControl(d){return this._controls.indexOf(d)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(d){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let t=!this._moving;return t&&this.fire(new i.z("movestart",d)).fire(new i.z("move",d)),this.fire(new i.z("resize",d)),t&&this.fire(new i.z("moveend",d)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(d){return this.transform.setMaxBounds(i.aI.convert(d)),this._update()}setMinZoom(d){if((d=d??-2)>=-2&&d<=this.transform.maxZoom)return this.transform.minZoom=d,this._update(),this.getZoom()<d?this.setZoom(d):this.fire(new i.z("zoomstart")).fire(new i.z("zoom")).fire(new i.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(d){if((d=d??22)>=this.transform.minZoom)return this.transform.maxZoom=d,this._update(),this.getZoom()>d?this.setZoom(d):this.fire(new i.z("zoomstart")).fire(new i.z("zoom")).fire(new i.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(d){if((d=d??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(d>=0&&d<=this.transform.maxPitch)return this.transform.minPitch=d,this._update(),this.getPitch()<d?this.setPitch(d):this.fire(new i.z("pitchstart")).fire(new i.z("pitch")).fire(new i.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(d){if((d=d??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(d>=this.transform.minPitch)return this.transform.maxPitch=d,this._update(),this.getPitch()>d?this.setPitch(d):this.fire(new i.z("pitchstart")).fire(new i.z("pitch")).fire(new i.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(d){return this._scaleFactor=d,this.painter.scaleFactor=d,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>t.type==="symbol"),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(d){return this.transform.renderWorldCopies=d,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(d){return d==="auto"?navigator.language:Array.isArray(d)?d.length===0?void 0:d.map(t=>t==="auto"?navigator.language:t):d}setLanguage(d){let t=this._parseLanguage(d);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(let o of this._controls)o._setLanguage&&o._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(d){return this.style&&d!==this._worldview?(this._worldview=d,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(d){return this._lazyInitEmptyStyle(),d?typeof d=="string"&&(d={name:d}):d=null,this._useExplicitProjection=!!d,this._prioritizeAndUpdateProjection(d,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;let d=this.transform,t=d.projection.name,o;t==="globe"&&d.zoom>=i.cK?(d.setMercatorFromTransition(),o=!0):t==="mercator"&&d.zoom<i.cK&&(d.setProjection({name:"globe"}),o=!0),o&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(d,t){return this._updateProjection(d||t||{name:"mercator"})}_updateProjection(d){let t,o=this.transform.mercatorFromTransition;t=d.name==="globe"&&this.transform.zoom>=i.cK?this.transform.setMercatorFromTransition():this.transform.setProjection(d),this.style.applyProjectionUpdate();let h=this.transform.getProjection().name==="mercator"&&o!==this.transform.mercatorFromTransition;return(t||h)&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(d,t){return this.transform.locationPoint3D(i.aS.convert(d),t)}unproject(d,t){return this.transform.pointLocation3D(i.P.convert(d),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(d,t,o){let h=g=>{let y=[];if(Array.isArray(t)){let x=t.filter(E=>this.getLayer(E));y=x.length?this.queryRenderedFeatures(g,{layers:x}):[]}else y=this.queryRenderedFeatures(g,{target:t});return y};if(d==="mouseenter"||d==="mouseover"){let g=!1;return{listener:o,targets:t,delegates:{mousemove:x=>{let E=h(x.point);E.length?g||(g=!0,o.call(this,new wi(d,this,x.originalEvent,{features:E}))):g=!1},mouseout:()=>{g=!1}}}}if(d==="mouseleave"||d==="mouseout"){let g=!1;return{listener:o,targets:t,delegates:{mousemove:E=>{h(E.point).length?g=!0:g&&(g=!1,o.call(this,new wi(d,this,E.originalEvent)))},mouseout:E=>{g&&(g=!1,o.call(this,new wi(d,this,E.originalEvent)))}}}}{let g=y=>{let x=h(y.point);x.length&&(y.features=x,o.call(this,y),delete y.features)};return{listener:o,targets:t,delegates:{[d]:g}}}}on(d,t,o){if(typeof t=="function"||o===void 0)return super.on(d,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(d,t,o);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[d]=this._delegatedListeners[d]||[],this._delegatedListeners[d].push(h);for(let g in h.delegates)this.on(g,h.delegates[g]);return this}once(d,t,o){if(typeof t=="function"||o===void 0)return super.once(d,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._createDelegatedListener(d,t,o);for(let g in h.delegates)this.once(g,h.delegates[g]);return this}off(d,t,o){if(typeof t=="function"||o===void 0)return super.off(d,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;let h=this._delegatedListeners?this._delegatedListeners[d]:void 0;return h&&(g=>{for(let y=0;y<g.length;y++){let x=g[y];if(x.listener===o&&s_(x.targets,t)){for(let E in x.delegates)this.off(E,x.delegates[E]);return g.splice(y,1),this}}})(h),this}queryRenderedFeatures(d,t){if(!this.style)return[];if(d===void 0||d instanceof i.P||Array.isArray(d)||t!==void 0||(t=d,d=void 0),d=d||[[0,0],[this.transform.width,this.transform.height]],!t){let y=this.style.queryRenderedFeatures(d,void 0,this.transform),x=this.style.queryRenderedFeatureset(d,void 0,this.transform);return y.concat(x)}let o=!0;if(t.target&&(o=this._isTargetValid(t.target),o&&!t.layers))return this.style.queryRenderedFeatureset(d,t,this.transform);let h=!0;if(t.layers&&Array.isArray(t.layers)){for(let y of t.layers)if(!this._isValidId(y)){h=!1;break}if(h&&!t.target)return this.style.queryRenderedFeatures(d,t,this.transform)}let g=[];return h&&(g=g.concat(this.style.queryRenderedFeatures(d,t,this.transform))),o&&(g=g.concat(this.style.queryRenderedFeatureset(d,t,this.transform))),g}querySourceFeatures(d,t){return!d||typeof d=="string"&&!this._isValidId(d)?[]:this.style.querySourceFeatures(d,t)}queryRasterValue(d,t,o){return this._isValidId(d)?this.style.queryRasterValue(d,t,o):Promise.resolve(null)}isPointOnSurface(d){let{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&i.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(i.P.convert(d))}addInteraction(d,t){return this._interactions.add(d,t),this}removeInteraction(d){return this._interactions.remove(d),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(d){return this._cooperativeGestures=d,this}setStyle(d,t){return t=Object.assign({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&d&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(d,(o,h)=>{if(o){let g=typeof o=="string"?o:o instanceof Error?o.message:o.error;i.w(`Unable to perform style diff: ${g}. Rebuilding the style from scratch.`),this._updateStyle(d,t)}else h&&this._update(!0)},()=>this._postStyleLoadEvent()),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(d,t))}_getUIString(d){let t=this._locale[d];if(t==null)throw new Error(`Missing UI string '${d}'`);return t}_updateStyle(d,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),d){let o=Object.assign({},t);t&&t.config&&(o.initialConfig=t.config,delete o.config),this.style=new Es(this,o).load(d),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new Es(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(i.w("There is no style added to the map."),!1)}_isValidId(d){return d==null?(this.fire(new i.y(new Error("IDs can't be empty."))),!1):!i.dq(d)||(this.fire(new i.y(new Error(`IDs can't contain special symbols: "${d}".`))),!1)}_isTargetValid(d){return"featuresetId"in d?this._isValidId("importId"in d?d.importId:d.featuresetId):"layerId"in d&&this._isValidId(d.layerId)}_areTargetsValid(d){if(Array.isArray(d)){for(let t of d)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(d)}addSource(d,t){return this._isValidId(d)?(this._lazyInitEmptyStyle(),this.style.addSource(d,t),this._update(!0)):this}isSourceLoaded(d){return!!this._isValidId(d)&&!!this.style&&this.style._isSourceCacheLoaded(d)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(d,t,o){this._lazyInitEmptyStyle(),this.style.addSourceType(d,t,o)}removeSource(d){return this._isValidId(d)?(this.style.removeSource(d),this._updateTerrain(),this._update(!0)):this}getSource(d){return this._isValidId(d)?this.style.getOwnSource(d):null}addImage(d,t,{pixelRatio:o=1,sdf:h=!1,stretchX:g,stretchY:y,content:x}={}){this._lazyInitEmptyStyle();let E=i.I.from(d);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){let{width:T,height:A,data:M}=i.o.getImageData(t);this.style.addImage(E,{data:new i.q({width:T,height:A},M),pixelRatio:o,stretchX:g,stretchY:y,content:x,sdf:h,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new i.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:T,height:A}=t,M=t;this.style.addImage(E,{data:new i.q({width:T,height:A},new Uint8Array(M.data)),pixelRatio:o,stretchX:g,stretchY:y,content:x,sdf:h,usvg:!1,version:0,userImage:M}),M.onAdd&&M.onAdd(this,d)}}updateImage(d,t){this._lazyInitEmptyStyle();let o=i.I.from(d),h=this.style.getImage(o);if(!h)return void this.fire(new i.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let g=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?i.o.getImageData(t):t,{width:y,height:x,data:E}=g;if(y===void 0||x===void 0)return void this.fire(new i.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(y!==(h.usvg?h.icon.usvg_tree.width:h.data.width)||x!==(h.usvg?h.icon.usvg_tree.height:h.data.height))return void this.fire(new i.y(new Error(`The width and height of the updated image (${y}, ${x})
                must be that same as the previous version of the image
                (${h.data.width}, ${h.data.height})`)));let T=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap),A=!1;h.usvg?(h.data=new i.q({width:y,height:x},new Uint8Array(E)),h.usvg=!1,h.icon=void 0,A=!0):h.data.replace(E,T),this.style.updateImage(o,h,A)}hasImage(d){return d?!!this.style&&!!this.style.getImage(i.I.from(d)):(this.fire(new i.y(new Error("Missing required image id"))),!1)}removeImage(d){this.style.removeImage(i.I.from(d))}loadImage(d,t){i.n(this._requestManager.transformRequest(d,i.R.Image),(o,h)=>{t(o,h instanceof HTMLImageElement?i.o.getImageData(h):h)})}listImages(){return this.style.listImages().map(d=>d.name)}addModel(d,t){this._lazyInitEmptyStyle(),this.style.addModel(d,t)}hasModel(d){return d?this.style.hasModel(d):(this.fire(new i.y(new Error("Missing required model id"))),!1)}removeModel(d){this.style.removeModel(d)}listModels(){return this.style.listModels()}addLayer(d,t){return this._isValidId(d.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(d,t),this._update(!0)):this}getSlot(d){let t=this.getLayer(d);return t&&t.slot||null}setSlot(d,t){return this.style.setSlot(d,t),this.style.mergeLayers(),this._update(!0)}addImport(d,t){return this.style.addImport(d,t).catch(o=>this.fire(new i.y(new Error("Failed to add import",o)))),this}updateImport(d,t){return typeof t!="string"&&t.id!==d?(this.removeImport(d),this.addImport(t)):(this.style.updateImport(d,t),this._update(!0))}removeImport(d){return this.style.removeImport(d),this}moveImport(d,t){return this.style.moveImport(d,t),this._update(!0)}moveLayer(d,t){return this._isValidId(d)?(this.style.moveLayer(d,t),this._update(!0)):this}removeLayer(d){return this._isValidId(d)?(this.style.removeLayer(d),this._update(!0)):this}getLayer(d){if(!this._isValidId(d))return null;let t=this.style.getOwnLayer(d);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(d,t,o){return this._isValidId(d)?(this.style.setLayerZoomRange(d,t,o),this._update(!0)):this}setFilter(d,t,o={}){return this._isValidId(d)?(this.style.setFilter(d,t,o),this._update(!0)):this}getFilter(d){return this._isValidId(d)?this.style.getFilter(d):null}setPaintProperty(d,t,o,h={}){return this._isValidId(d)?(this.style.setPaintProperty(d,t,o,h),this._update(!0)):this}getPaintProperty(d,t){return this._isValidId(d)?this.style.getPaintProperty(d,t):null}setLayoutProperty(d,t,o,h={}){return this._isValidId(d)?(this.style.setLayoutProperty(d,t,o,h),this._update(!0)):this}getLayoutProperty(d,t){return this._isValidId(d)?this.style.getLayoutProperty(d,t):null}setLayerProperty(d,t,o,h={}){return this._isValidId(d)?(this.style.setLayerProperty(d,t,o,h),this._update(!0)):this}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(d){return this.style.setGlyphsUrl(d),this._update(!0)}getSchema(d){return this.style.getSchema(d)}setSchema(d,t){return this.style.setSchema(d,t),this._update(!0)}getConfig(d){return this.style.getConfig(d)}setConfig(d,t){return this.style.setConfig(d,t),this._update(!0)}getConfigProperty(d,t){return this.style.getConfigProperty(d,t)}setConfigProperty(d,t,o){return this.style.setConfigProperty(d,t,o),this._update(!0)}getFeaturesetDescriptors(d){return this.style.getFeaturesetDescriptors(d)}setLights(d){if(this._lazyInitEmptyStyle(),d&&d.length===1&&d[0].type==="flat"){let t=d[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(d),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let d=this.style.getLights()||[];return d.length===0&&d.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),d}setLight(d,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:d}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(d){return this._lazyInitEmptyStyle(),!d&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(d),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(d){return this._lazyInitEmptyStyle(),this.style.setFog(d),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(d){return this._lazyInitEmptyStyle(),this.style.setSnow(d),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(d){return this._lazyInitEmptyStyle(),this.style.setRain(d),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(d){return this._lazyInitEmptyStyle(),this.style.setColorTheme(d),this._update(!0)}setImportColorTheme(d,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(d,t),this._update(!0)}setCamera(d){return this.style.setCamera(d),this._triggerCameraUpdate(d)}_triggerCameraUpdate(d){return this._update(this.transform.setOrthographicProjectionAtLowPitch(d["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(d){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(i.aS.convert(d),this.transform):0}setFeatureState(d,t){return d.source&&!this._isValidId(d.source)?this:(this.style.setFeatureState(d,t),this._update())}removeFeatureState(d,t){return d.source&&!this._isValidId(d.source)?this:(this.style.removeFeatureState(d,t),this._update())}getFeatureState(d){return d.source&&!this._isValidId(d.source)?null:this.style.getFeatureState(d)}_selectIndoorFloor(d){this.indoor.selectFloor(d)}_setIndoorActiveFloorsVisibility(d){this.indoor.setActiveFloorsVisibility(d)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new r_),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;let d=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300,o,h,g,y=this._container;for(;y&&(!h||!g);){let x=window.getComputedStyle(y).transform;x&&x!=="none"&&(o=x.match(/matrix.*\((.+)\)/)[1].split(", "),o[0]&&o[0]!=="0"&&o[0]!=="1"&&(h=o[0]),o[3]&&o[3]!=="0"&&o[3]!=="1"&&(g=o[3])),y=y.parentElement}this._containerWidth=h?Math.abs(d/h):d,this._containerHeight=g?Math.abs(t/g):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&i.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupIndoor(){this.style.isIndoorEnabled()&&(this.indoor=new rc(this.style),this.on("load",()=>{this._addIndoorControl(),this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds()),this.on("move",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())}),this.on("idle",()=>{this.indoor._updateUI(this.transform.zoom,this.transform.center,this.transform.getBounds())})}))}_setupContainer(){let d=this._container;d.classList.add("mapboxgl-map"),(this._missingCSSCanary=Fe("div","mapboxgl-canary",d)).style.visibility="hidden",this._detectMissingCSS();let t=this._canvasContainer=Fe("div","mapboxgl-canvas-container",d);this._canvas=Fe("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let o=this._controlContainer=Fe("div","mapboxgl-control-container",d),h=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(g=>{h[g]=Fe("div",`mapboxgl-ctrl-${g}`,o)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(d,t){let o=i.o.devicePixelRatio||1;this._canvas.width=o*Math.ceil(d),this._canvas.height=o*Math.ceil(t),this._canvas.style.width=`${d}px`,this._canvas.style.height=`${t}px`}_addMarker(d){this._markers.push(d)}_removeMarker(d){let t=this._markers.indexOf(d);t!==-1&&this._markers.splice(t,1)}_addPopup(d){this._popups.push(d)}_removePopup(d){let t=this._popups.indexOf(d);t!==-1&&this._popups.splice(t,1)}_setupPainter(){let d=Object.assign({},ct.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",d);t?(al(t,!0),this.painter=new xl(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",o=>{o.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),i.k.testSupport(t)):this.fire(new i.y(new Error("Failed to initialize WebGL")))}_contextLost(d){d.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new i.z("webglcontextlost",{originalEvent:d}))}_contextRestored(d){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new i.z("webglcontextrestored",{originalEvent:d}))}_onMapScroll(d){if(d.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(d){return this.style?(this._styleDirty=this._styleDirty||d,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(d){return this._update(),this._renderTaskQueue.add(d)}_cancelRenderFrame(d){this._renderTaskQueue.remove(d)}_requestDomTask(d){!this.loaded()||this.loaded()&&!this.isMoving()?d():this._domRenderTaskQueue.add(d)}_render(d){let t;this.fire(new i.z("renderstart")),++this._frameId;let o=this.painter.context.extTimerQuery,h=i.o.now(),g=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=g.createQuery(),g.beginQuery(o.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(d),this._domRenderTaskQueue.run(d),this._removed)return;this._updateProjectionTransition();let y=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let A=this.transform.zoom,M=this.transform.pitch,L=i.o.now(),R=new i.ac(A,{now:L,fadeDuration:y,pitch:M,transition:this.style.transition,worldview:this._worldview});this.style.update(R)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let x=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),x=this._updateAverageElevation(h),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):x=this._updateAverageElevation(h);let E=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,y,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),E&&(this._placementDirty=E.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:y,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new i.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,B.mark(k.load),this.fire(new i.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){let A=i.o.now()-h;g.endQuery(o.TIME_ELAPSED_EXT),setTimeout(()=>{let M=g.getQueryParameter(t,g.QUERY_RESULT)/1e6;g.deleteQuery(t),this.fire(new i.z("gpu-timing-frame",{cpuTime:A,gpuTime:M}))},50)}if(this.listens("gpu-timing-layer")){let A=this.painter.collectGpuTimers();setTimeout(()=>{let M=this.painter.queryGpuTimers(A);this.fire(new i.z("gpu-timing-layer",{layerTimes:M}))},50)}if(this.listens("gpu-timing-deferred-render")){let A=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let M=this.painter.queryGpuTimeDeferredRender(A);this.fire(new i.z("gpu-timing-deferred-render",{gpuTime:M}))},50)}let T=this._sourcesDirty||this._styleDirty||this._placementDirty||x;if(T||this._repaint)this.triggerRepaint();else{let A=this.idle();if(A&&(x=this._updateAverageElevation(h,!0)),x)this.triggerRepaint();else if(this._triggerFrame(!1),A&&(this.fire(new i.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let M=this._calculateSpeedIndex();this.fire(new i.z("speedindexcompleted",{speedIndex:M})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||T||(this._fullyLoaded=!0,B.mark(k.fullLoad),this._performanceMetricsCollection&&sr(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(d){for(let t of this._markers)d&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(let t of this._popups)!d||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(d,t=!1){let o=g=>(this.transform.averageElevation=g,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&o(0);let h=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(h||(t||d-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(d)){let g=this.transform.averageElevation,y=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(y)?y=0:this._averageElevationLastSampledAt=d;let x=Math.abs(g-y);if(x>1){if(this._isInitialLoad||h)return this._averageElevation.jumpTo(y),o(y);this._averageElevation.easeTo(y,d,300)}else if(x>1e-4)return this._averageElevation.jumpTo(y),o(y)}return!!this._averageElevation.isEasing(d)&&o(this._averageElevation.getValue(d))}_authenticate(){Hc(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,d=>{if(d&&(d.message===Un||d.status===401)){let t=this.painter.context.gl;al(t,!1),this._logoControl instanceof ah&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new i.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),Bs(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&af(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_postStyleWithAppearanceEvent(){this.style.globalId&&this.style.hasAppearances()&&sa(this._requestManager._customAccessToken)}_updateTerrain(){let d=this._isDragging();this.painter.updateTerrain(this.style,d)}_calculateSpeedIndex(){let d=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());let o=this.painter.context.gl,h=o.createFramebuffer();function g(y){o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,y,0);let x=new Uint8Array(o.drawingBufferWidth*o.drawingBufferHeight*4);return o.readPixels(0,0,o.drawingBufferWidth,o.drawingBufferHeight,o.RGBA,o.UNSIGNED_BYTE,x),x}return o.bindFramebuffer(o.FRAMEBUFFER,h),this._canvasPixelComparison(g(d),t.canvasCopies.map(g),t.timeStamps)}_canvasPixelComparison(d,t,o){let h=o[1]-o[0],g=d.length/4;for(let y=0;y<t.length;y++){let x=t[y],E=0;for(let T=0;T<x.length;T+=4)x[T]===d[T]&&x[T+1]===d[T+1]&&x[T+2]===d[T+2]&&x[T+3]===d[T+3]&&(E+=1);h+=(o[y+2]-o[y+1])*(1-E/g)}return h}remove(){this._hash&&this._hash.remove();for(let t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor&&this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let d=this.painter.context.gl.getExtension("WEBGL_lose_context");d&&d.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ki.delete(this.painter.context.gl),Or.remove(),Mi.remove(),this._removed=!0,this.fire(new i.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(d){this._renderNextFrame=this._renderNextFrame||d,this.style&&!this._frame&&(this._frame=i.o.frame(t=>{let o=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,o&&this._render(t)}))}_preloadTiles(d){let t=this.style?this.style.getSourceCaches():[];return i.bv(t,(o,h)=>o._preloadTiles(d,h),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(d){this._trackResize&&this.resize({originalEvent:d})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(d){this._showTileBoundaries!==d&&(this._showTileBoundaries=d,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(d){this._showParseStatus!==d&&(this._showParseStatus=d,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(d){this._showTerrainWireframe!==d&&(this._showTerrainWireframe=d,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(d){this._showLayers2DWireframe!==d&&(this._showLayers2DWireframe=d,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(d){this._showLayers3DWireframe!==d&&(this._showLayers3DWireframe=d,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(d){this._speedIndexTiming!==d&&(this._speedIndexTiming=d,this._update())}get showPadding(){return!!this._showPadding}set showPadding(d){this._showPadding!==d&&(this._showPadding=d,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(d){this._showCollisionBoxes!==d&&(this._showCollisionBoxes=d,this._tp.refreshUI(),d?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(d){this._showOverdrawInspector!==d&&(this._showOverdrawInspector=d,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(d){this._repaint!==d&&(this._repaint=d,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(d){this._vertices=d,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(d){this._showTileAABBs!==d&&(this._showTileAABBs=d,this._tp.refreshUI(),d&&this._update())}_setCacheLimits(d,t){i.f3(d,t)}get version(){return C}},NavigationControl:class{constructor(d={}){this.options=Object.assign({},hp,d),this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(i.aX(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),Fe("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),Fe("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(i.aX(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{let o=this._map;o&&(this.options.visualizePitch?o.resetNorthPitch({},{originalEvent:t}):o.resetNorth({},{originalEvent:t}))}),this._compassIcon=Fe("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let d=this._map;if(!d)return;let t=d.getZoom(),o=t===d.getMaxZoom(),h=t===d.getMinZoom();this._zoomInButton.disabled=o,this._zoomOutButton.disabled=h,this._zoomInButton.setAttribute("aria-disabled",o.toString()),this._zoomOutButton.setAttribute("aria-disabled",h.toString())}_rotateCompassArrow(){let d=this._map;if(!d)return;let t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(d.transform.pitch*(Math.PI/180)),.5)}) rotateX(${d.transform.pitch}deg) rotateZ(${d.transform.angle*(180/Math.PI)}deg)`:`rotate(${d.transform.angle*(180/Math.PI)}deg)`;d._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(d){return this._map=d,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),d.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&d.on("pitch",this._rotateCompassArrow),d.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new ch(d,this._compass,this.options.visualizePitch)),this._container}onRemove(){let d=this._map;d&&(this._container.remove(),this.options.showZoom&&d.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&d.off("pitch",this._rotateCompassArrow),d.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(d,t){let o=Fe("button",d,this._container);return o.type="button",o.addEventListener("click",t),o}_setButtonTitle(d,t){if(!this._map)return;let o=this._map._getUIString(`NavigationControl.${t}`);d.setAttribute("aria-label",o),d.firstElementChild&&d.firstElementChild.setAttribute("title",o)}},GeolocateControl:class extends i.E{constructor(d={}){super();let t=navigator.geolocation;this.options=Object.assign({geolocation:t},Gs,d),i.aX(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=fc(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(d){return this._map=d,this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(d){let t=(o=!!this.options.geolocation)=>{this._supportsGeolocation=o,d(o)};this._supportsGeolocation!==void 0?d(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(o=>t(o.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(d){let t=this._map.getMaxBounds(),o=d.coords;return!!t&&(o.longitude<t.getWest()||o.longitude>t.getEast()||o.latitude<t.getSouth()||o.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(d){if(this._map){if(this._isOutOfMapMaxBounds(d))return this._setErrorState(),this.fire(new i.z("outofmaxbounds",d)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=d,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(d),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(d),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.z("geolocate",Object.assign({coords:d.coords,timestamp:d.timestamp},d.toJSON?{toJSON:d.toJSON.bind(d)}:{}))),this._finish()}}_updateCamera(d){let t=new i.aS(d.coords.longitude,d.coords.latitude),o=d.coords.accuracy,h=this._map.getBearing(),g=Object.assign({bearing:h},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(o),g,{geolocateSource:!0})}_updateMarker(d){if(d){let t=new i.aS(d.coords.longitude,d.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=d.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let d=this._map.transform,t=i.ce(1,d._center.lat)*d.worldSize,o=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${o}px`,this._circleElement.style.height=`${o}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(d){if(this._map){if(this.options.trackUserLocation)if(d.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(d.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new i.z("error",d)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(d){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=Fe("button","mapboxgl-ctrl-geolocate",this._container),Fe("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",d===!1){i.w("Geolocation support is not available so the GeolocateControl will be disabled.");let t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{let t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Fe("div","mapboxgl-user-location"),this._dotElement.appendChild(Fe("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Fe("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ja({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Fe("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ja({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new i.z("trackuserlocationend")))})}}_onDeviceOrientation(d){this._userLocationDotMarker&&(d.webkitCompassHeading?this._heading=d.webkitCompassHeading:d.absolute===!0&&(this._heading=-1*d.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return i.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new i.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new i.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new i.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let d;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(d={maximumAge:6e5,timeout:0},this._noTimeout=!0):(d=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,d),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let d=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&d()}).catch(console.error):d()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Du,ScaleControl:class{constructor(d={}){this.options=Object.assign({},sE,d),this._isNumberFormatSupported=(function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}})(),i.aX(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let d=this.options.maxWidth||100,t=this._map,o=t._containerHeight/2,h=t._containerWidth/2-d/2,g=t.unproject([h,o]),y=t.unproject([h+d,o]),x=g.distanceTo(y);if(this.options.unit==="imperial"){let E=3.2808*x;E>5280?this._setScale(d,E/5280,"mile"):this._setScale(d,E,"foot")}else this.options.unit==="nautical"?this._setScale(d,x/1852,"nautical-mile"):x>=1e3?this._setScale(d,x/1e3,"kilometer"):this._setScale(d,x,"meter")}_setScale(d,t,o){this._map._requestDomTask(()=>{let h=(function(y){let x=Math.pow(10,`${Math.floor(y)}`.length-1),E=y/x;return E=E>=10?10:E>=5?5:E>=3?3:E>=2?2:E>=1?1:(function(T){let A=Math.pow(10,Math.ceil(-Math.log(T)/Math.LN10));return Math.round(T*A)/A})(E),x*E})(t),g=h/t;this._container.innerHTML=this._isNumberFormatSupported&&o!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:o}).format(h):`${h}&nbsp;${aE[o]}`,this._container.style.width=d*g+"px"})}onAdd(d){return this._map=d,this._language=d.getLanguage(),this._container=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-scale",d.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(d){this._language=d,this._update()}setUnit(d){this.options.unit=d,this._update()}},FullscreenControl:class{constructor(d={}){this._fullscreen=!1,d&&d.container&&(d.container instanceof HTMLElement?this._container=d.container:i.w("Full screen control 'container' must be a DOM element.")),i.aX(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(d){return this._map=d,this._container||(this._container=this._map.getContainer()),this._controlContainer=Fe("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",i.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let d=this._fullscreenButton=Fe("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Fe("span","mapboxgl-ctrl-icon",d).setAttribute("aria-hidden","true"),d.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let d=this._getTitle();this._fullscreenButton.setAttribute("aria-label",d),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",d)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:r_,Popup:class extends i.E{constructor(d){super(),this.options=Object.assign(Object.create(lE),d),this._altitude=this.options.altitude,i.aX(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(d&&d.className?d.className.trim().split(/\s+/):[])}addTo(d){return this._map&&this.remove(),this._map=d,this.options.closeOnClick&&d.on("preclick",this._onClose),this.options.closeOnMove&&d.on("move",this._onClose),d.on("remove",this.remove),this._update(),d._addPopup(this),this._focusFirstElement(),this._trackPointer?(d.on("mousemove",this._onMouseEvent),d.on("mouseup",this._onMouseEvent),d._canvasContainer.classList.add("mapboxgl-track-pointer")):d.on("move",this._update),this.fire(new i.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let d=this._map;return d&&(d.off("move",this._update),d.off("move",this._onClose),d.off("preclick",this._onClose),d.off("click",this._onClose),d.off("remove",this.remove),d.off("mousemove",this._onMouseEvent),d.off("mouseup",this._onMouseEvent),d.off("drag",this._onMouseEvent),d._canvasContainer&&d._canvasContainer.classList.remove("mapboxgl-track-pointer"),d._removePopup(this),this._map=void 0),this.fire(new i.z("close")),this}getLngLat(){return this._lngLat}setLngLat(d){this._lngLat=i.aS.convert(d),this._pos=null,this._trackPointer=!1,this._update();let t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(d){return this._altitude=d,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let d=this._map;return d&&(d.off("move",this._update),d.on("mousemove",this._onMouseEvent),d.on("drag",this._onMouseEvent),d._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(d){return this.setDOMContent(document.createTextNode(d))}setHTML(d){let t=document.createDocumentFragment(),o=document.createElement("body"),h;for(o.innerHTML=d;h=o.firstChild,h;)t.appendChild(h);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(d){return this.options.maxWidth=d,this._update(),this}setDOMContent(d){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=Fe("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(d),this.options.closeButton){let o=this._closeButton=Fe("button","mapboxgl-popup-close-button",t);o.type="button",o.setAttribute("aria-label","Close popup"),o.innerHTML='<span aria-hidden="true">&#215;</span>',o.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(d){return this._classList.add(d),this._updateClassList(),this}removeClassName(d){return this._classList.delete(d),this._updateClassList(),this}setOffset(d){return this.options.offset=d,this._update(),this}toggleClassName(d){let t;return this._classList.delete(d)?t=!1:(this._classList.add(d),t=!0),this._updateClassList(),t}_onMouseEvent(d){this._update(d.point)}_getAnchor(d){if(this.options.anchor)return this.options.anchor;let t=this._map,o=this._container,h=this._pos;if(!t||!o||!h)return"bottom";let g=o.offsetWidth,y=o.offsetHeight,x=h.x<g/2,E=h.x>t.transform.width-g/2;if(h.y+d<y)return x?"top-left":E?"top-right":"top";if(h.y>t.transform.height-y){if(x)return"bottom-left";if(E)return"bottom-right"}return x?"left":E?"right":"bottom"}_updateClassList(){let d=this._container;if(!d)return;let t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),d.className=t.join(" ")}_update(d){let t=this._map,o=this._content;if(!t||!this._lngLat&&!this._trackPointer||!o)return;let h=this._container;if(h||(h=this._container=Fe("div","mapboxgl-popup",t.getContainer()),this._tip=Fe("div","mapboxgl-popup-tip",h),h.appendChild(o)),this.options.maxWidth&&h.style.maxWidth!==this.options.maxWidth&&(h.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Va(this._lngLat,this._pos,t.transform)),!this._trackPointer||d){let g=this._pos=this._trackPointer&&d instanceof i.P?d:t.project(this._lngLat,this._altitude),y=a_(this.options.offset),x=this._anchor=this._getAnchor(y.y),E=a_(this.options.offset,x),T=g.add(E).round();t._requestDomTask(()=>{this._container&&x&&(this._container.style.transform=`${$s[x]} translate(${T.x}px,${T.y}px)`)})}if(!this._marker&&t._showingGlobe()){let g=i.f4(t.transform,this._lngLat)?0:1;this._setOpacity(g)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let d=this._container.querySelector(cE);d&&d.focus()}_onClose(){this.remove()}_setOpacity(d){this._container&&(this._container.style.opacity=`${d}`),this._content&&(this._content.style.pointerEvents=d?"auto":"none")}},Marker:ja,Style:Es,LngLat:i.aS,LngLatBounds:i.aI,Point:i.P,MercatorCoordinate:i.ae,FreeCameraOptions:ha,Evented:i.E,config:i.e,prewarm:i.f8,clearPrewarmedResources:i.f7,get accessToken(){return i.e.ACCESS_TOKEN},set accessToken(d){i.e.ACCESS_TOKEN=d},get baseApiUrl(){return i.e.API_URL},set baseApiUrl(d){i.e.API_URL=d},get workerCount(){return i.fh.workerCount},set workerCount(d){i.fh.workerCount=d},get maxParallelImageRequests(){return i.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(d){i.e.MAX_PARALLEL_IMAGE_REQUESTS=d},clearStorage(d){i.fg(d)},get workerUrl(){return i.ff.workerUrl},set workerUrl(d){i.ff.workerUrl=d},get workerClass(){return i.ff.workerClass},set workerClass(d){i.ff.workerClass=d},get workerParams(){return i.ff.workerParams},set workerParams(d){i.ff.workerParams=d},get dracoUrl(){return i.fe()},set dracoUrl(d){i.fd(d)},get meshoptUrl(){return i.fc()},set meshoptUrl(d){i.fb(d)},setNow:i.o.setNow,restoreNow:i.o.restoreNow}});var v=l;return v})});var MT;function yx(){return MT}function Cl(s){let c=MT;return MT=s,c}var e2=Symbol("NotFound");function kp(s){return s===e2||s?.name==="\u0275NotFound"}var Vo=null,vx=!1,RT=1,fj=null,cs=Symbol("SIGNAL");function Xn(s){let c=Vo;return Vo=s,c}function Ex(){return Vo}var Np={version:0,lastCleanEpoch:0,dirty:!1,producers:void 0,producersTail:void 0,consumers:void 0,consumersTail:void 0,recomputing:!1,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function zp(s){if(vx)throw new Error("");if(Vo===null)return;Vo.consumerOnSignalRead(s);let c=Vo.producersTail;if(c!==void 0&&c.producer===s)return;let l,f=Vo.recomputing;if(f&&(l=c!==void 0?c.nextProducer:Vo.producers,l!==void 0&&l.producer===s)){Vo.producersTail=l,l.lastReadVersion=s.version;return}let v=s.consumersTail;if(v!==void 0&&v.consumer===Vo&&(!f||mj(v,Vo)))return;let i=Vp(Vo),C={producer:s,consumer:Vo,nextProducer:l,prevConsumer:v,lastReadVersion:s.version,nextConsumer:void 0};Vo.producersTail=C,c!==void 0?c.nextProducer=C:Vo.producers=C,i&&r2(s,C)}function t2(){RT++}function Tx(s){if(!(Vp(s)&&!s.dirty)&&!(!s.dirty&&s.lastCleanEpoch===RT)){if(!s.producerMustRecompute(s)&&!Y_(s)){wx(s);return}s.producerRecomputeValue(s),wx(s)}}function PT(s){if(s.consumers===void 0)return;let c=vx;vx=!0;try{for(let l=s.consumers;l!==void 0;l=l.nextConsumer){let f=l.consumer;f.dirty||pj(f)}}finally{vx=c}}function OT(){return Vo?.consumerAllowSignalWrites!==!1}function pj(s){s.dirty=!0,PT(s),s.consumerMarkedDirty?.(s)}function wx(s){s.dirty=!1,s.lastCleanEpoch=RT}function Bp(s){return s&&n2(s),Xn(s)}function n2(s){s.producersTail=void 0,s.recomputing=!0}function X_(s,c){Xn(c),s&&i2(s)}function i2(s){s.recomputing=!1;let c=s.producersTail,l=c!==void 0?c.nextProducer:s.producers;if(l!==void 0){if(Vp(s))do l=LT(l);while(l!==void 0);c!==void 0?c.nextProducer=void 0:s.producers=void 0}}function Y_(s){for(let c=s.producers;c!==void 0;c=c.nextProducer){let l=c.producer,f=c.lastReadVersion;if(f!==l.version||(Tx(l),f!==l.version))return!0}return!1}function K_(s){if(Vp(s)){let c=s.producers;for(;c!==void 0;)c=LT(c)}s.producers=void 0,s.producersTail=void 0,s.consumers=void 0,s.consumersTail=void 0}function r2(s,c){let l=s.consumersTail,f=Vp(s);if(l!==void 0?(c.nextConsumer=l.nextConsumer,l.nextConsumer=c):(c.nextConsumer=void 0,s.consumers=c),c.prevConsumer=l,s.consumersTail=c,!f)for(let v=s.producers;v!==void 0;v=v.nextProducer)r2(v.producer,v)}function LT(s){let c=s.producer,l=s.nextProducer,f=s.nextConsumer,v=s.prevConsumer;if(s.nextConsumer=void 0,s.prevConsumer=void 0,f!==void 0?f.prevConsumer=v:c.consumersTail=v,v!==void 0)v.nextConsumer=f;else if(c.consumers=f,!Vp(c)){let i=c.producers;for(;i!==void 0;)i=LT(i)}return l}function Vp(s){return s.consumerIsAlwaysLive||s.consumers!==void 0}function Ix(s){fj?.(s)}function mj(s,c){let l=c.producersTail;if(l!==void 0){let f=c.producers;do{if(f===s)return!0;if(f===l)break;f=f.nextProducer}while(f!==void 0)}return!1}function Sx(s,c){return Object.is(s,c)}function Dx(s,c){let l=Object.create(gj);l.computation=s,c!==void 0&&(l.equal=c);let f=()=>{if(Tx(l),zp(l),l.value===Z_)throw l.error;return l.value};return f[cs]=l,Ix(l),f}var xx=Symbol("UNSET"),bx=Symbol("COMPUTING"),Z_=Symbol("ERRORED"),gj=di(Bt({},Np),{value:xx,dirty:!0,error:null,equal:Sx,kind:"computed",producerMustRecompute(s){return s.value===xx||s.value===bx},producerRecomputeValue(s){if(s.value===bx)throw new Error("");let c=s.value;s.value=bx;let l=Bp(s),f,v=!1;try{f=s.computation(),Xn(null),v=c!==xx&&c!==Z_&&f!==Z_&&s.equal(c,f)}catch(i){f=Z_,s.error=i}finally{X_(s,l)}if(v){s.value=c;return}s.value=f,s.version++}});function _j(){throw new Error}var o2=_j;function s2(s){o2(s)}function FT(s){o2=s}var yj=null;function kT(s,c){let l=Object.create(Cx);l.value=s,c!==void 0&&(l.equal=c);let f=()=>a2(l);return f[cs]=l,Ix(l),[f,C=>jp(l,C),C=>NT(l,C)]}function a2(s){return zp(s),s.value}function jp(s,c){OT()||s2(s),s.equal(s.value,c)||(s.value=c,vj(s))}function NT(s,c){OT()||s2(s),jp(s,c(s.value))}var Cx=di(Bt({},Np),{equal:Sx,value:void 0,kind:"signal"});function vj(s){s.version++,t2(),PT(s),yj?.(s)}function ii(s){return typeof s=="function"}function Up(s){let l=s(f=>{Error.call(f),f.stack=new Error().stack});return l.prototype=Object.create(Error.prototype),l.prototype.constructor=l,l}var Ax=Up(s=>function(l){s(this),this.message=l?`${l.length} errors occurred during unsubscription:
${l.map((f,v)=>`${v+1}) ${f.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=l});function yh(s,c){if(s){let l=s.indexOf(c);0<=l&&s.splice(l,1)}}var wr=class s{constructor(c){this.initialTeardown=c,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let c;if(!this.closed){this.closed=!0;let{_parentage:l}=this;if(l)if(this._parentage=null,Array.isArray(l))for(let i of l)i.remove(this);else l.remove(this);let{initialTeardown:f}=this;if(ii(f))try{f()}catch(i){c=i instanceof Ax?i.errors:[i]}let{_finalizers:v}=this;if(v){this._finalizers=null;for(let i of v)try{l2(i)}catch(C){c=c??[],C instanceof Ax?c=[...c,...C.errors]:c.push(C)}}if(c)throw new Ax(c)}}add(c){var l;if(c&&c!==this)if(this.closed)l2(c);else{if(c instanceof s){if(c.closed||c._hasParent(this))return;c._addParent(this)}(this._finalizers=(l=this._finalizers)!==null&&l!==void 0?l:[]).push(c)}}_hasParent(c){let{_parentage:l}=this;return l===c||Array.isArray(l)&&l.includes(c)}_addParent(c){let{_parentage:l}=this;this._parentage=Array.isArray(l)?(l.push(c),l):l?[l,c]:c}_removeParent(c){let{_parentage:l}=this;l===c?this._parentage=null:Array.isArray(l)&&yh(l,c)}remove(c){let{_finalizers:l}=this;l&&yh(l,c),c instanceof s&&c._removeParent(this)}};wr.EMPTY=(()=>{let s=new wr;return s.closed=!0,s})();var zT=wr.EMPTY;function Mx(s){return s instanceof wr||s&&"closed"in s&&ii(s.remove)&&ii(s.add)&&ii(s.unsubscribe)}function l2(s){ii(s)?s():s.unsubscribe()}var Za={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var Hp={setTimeout(s,c,...l){let{delegate:f}=Hp;return f?.setTimeout?f.setTimeout(s,c,...l):setTimeout(s,c,...l)},clearTimeout(s){let{delegate:c}=Hp;return(c?.clearTimeout||clearTimeout)(s)},delegate:void 0};function Rx(s){Hp.setTimeout(()=>{let{onUnhandledError:c}=Za;if(c)c(s);else throw s})}function J_(){}var c2=BT("C",void 0,void 0);function u2(s){return BT("E",void 0,s)}function d2(s){return BT("N",s,void 0)}function BT(s,c,l){return{kind:s,value:c,error:l}}var vh=null;function $p(s){if(Za.useDeprecatedSynchronousErrorHandling){let c=!vh;if(c&&(vh={errorThrown:!1,error:null}),s(),c){let{errorThrown:l,error:f}=vh;if(vh=null,l)throw f}}else s()}function h2(s){Za.useDeprecatedSynchronousErrorHandling&&vh&&(vh.errorThrown=!0,vh.error=s)}var xh=class extends wr{constructor(c){super(),this.isStopped=!1,c?(this.destination=c,Mx(c)&&c.add(this)):this.destination=wj}static create(c,l,f){return new xc(c,l,f)}next(c){this.isStopped?jT(d2(c),this):this._next(c)}error(c){this.isStopped?jT(u2(c),this):(this.isStopped=!0,this._error(c))}complete(){this.isStopped?jT(c2,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(c){this.destination.next(c)}_error(c){try{this.destination.error(c)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},xj=Function.prototype.bind;function VT(s,c){return xj.call(s,c)}var UT=class{constructor(c){this.partialObserver=c}next(c){let{partialObserver:l}=this;if(l.next)try{l.next(c)}catch(f){Px(f)}}error(c){let{partialObserver:l}=this;if(l.error)try{l.error(c)}catch(f){Px(f)}else Px(c)}complete(){let{partialObserver:c}=this;if(c.complete)try{c.complete()}catch(l){Px(l)}}},xc=class extends xh{constructor(c,l,f){super();let v;if(ii(c)||!c)v={next:c??void 0,error:l??void 0,complete:f??void 0};else{let i;this&&Za.useDeprecatedNextContext?(i=Object.create(c),i.unsubscribe=()=>this.unsubscribe(),v={next:c.next&&VT(c.next,i),error:c.error&&VT(c.error,i),complete:c.complete&&VT(c.complete,i)}):v=c}this.destination=new UT(v)}};function Px(s){Za.useDeprecatedSynchronousErrorHandling?h2(s):Rx(s)}function bj(s){throw s}function jT(s,c){let{onStoppedNotification:l}=Za;l&&Hp.setTimeout(()=>l(s,c))}var wj={closed:!0,next:J_,error:bj,complete:J_};var Gp=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Ys(s){return s}function HT(...s){return $T(s)}function $T(s){return s.length===0?Ys:s.length===1?s[0]:function(l){return s.reduce((f,v)=>v(f),l)}}var hi=(()=>{class s{constructor(l){l&&(this._subscribe=l)}lift(l){let f=new s;return f.source=this,f.operator=l,f}subscribe(l,f,v){let i=Tj(l)?l:new xc(l,f,v);return $p(()=>{let{operator:C,source:k}=this;i.add(C?C.call(i,k):k?this._subscribe(i):this._trySubscribe(i))}),i}_trySubscribe(l){try{return this._subscribe(l)}catch(f){l.error(f)}}forEach(l,f){return f=f2(f),new f((v,i)=>{let C=new xc({next:k=>{try{l(k)}catch(B){i(B),C.unsubscribe()}},error:i,complete:v});this.subscribe(C)})}_subscribe(l){var f;return(f=this.source)===null||f===void 0?void 0:f.subscribe(l)}[Gp](){return this}pipe(...l){return $T(l)(this)}toPromise(l){return l=f2(l),new l((f,v)=>{let i;this.subscribe(C=>i=C,C=>v(C),()=>f(i))})}}return s.create=c=>new s(c),s})();function f2(s){var c;return(c=s??Za.Promise)!==null&&c!==void 0?c:Promise}function Ej(s){return s&&ii(s.next)&&ii(s.error)&&ii(s.complete)}function Tj(s){return s&&s instanceof xh||Ej(s)&&Mx(s)}function GT(s){return ii(s?.lift)}function vi(s){return c=>{if(GT(c))return c.lift(function(l){try{return s(l,this)}catch(f){this.error(f)}});throw new TypeError("Unable to lift unknown Observable type")}}function xi(s,c,l,f,v){return new qT(s,c,l,f,v)}var qT=class extends xh{constructor(c,l,f,v,i,C){super(c),this.onFinalize=i,this.shouldUnsubscribe=C,this._next=l?function(k){try{l(k)}catch(B){c.error(B)}}:super._next,this._error=v?function(k){try{v(k)}catch(B){c.error(B)}finally{this.unsubscribe()}}:super._error,this._complete=f?function(){try{f()}catch(k){c.error(k)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var c;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:l}=this;super.unsubscribe(),!l&&((c=this.onFinalize)===null||c===void 0||c.call(this))}}};function qp(){return vi((s,c)=>{let l=null;s._refCount++;let f=xi(c,void 0,void 0,void 0,()=>{if(!s||s._refCount<=0||0<--s._refCount){l=null;return}let v=s._connection,i=l;l=null,v&&(!i||v===i)&&v.unsubscribe(),c.unsubscribe()});s.subscribe(f),f.closed||(l=s.connect())})}var Wp=class extends hi{constructor(c,l){super(),this.source=c,this.subjectFactory=l,this._subject=null,this._refCount=0,this._connection=null,GT(c)&&(this.lift=c.lift)}_subscribe(c){return this.getSubject().subscribe(c)}getSubject(){let c=this._subject;return(!c||c.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;let{_connection:c}=this;this._subject=this._connection=null,c?.unsubscribe()}connect(){let c=this._connection;if(!c){c=this._connection=new wr;let l=this.getSubject();c.add(this.source.subscribe(xi(l,void 0,()=>{this._teardown(),l.complete()},f=>{this._teardown(),l.error(f)},()=>this._teardown()))),c.closed&&(this._connection=null,c=wr.EMPTY)}return c}refCount(){return qp()(this)}};var p2=Up(s=>function(){s(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Er=(()=>{class s extends hi{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(l){let f=new Ox(this,this);return f.operator=l,f}_throwIfClosed(){if(this.closed)throw new p2}next(l){$p(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let f of this.currentObservers)f.next(l)}})}error(l){$p(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=l;let{observers:f}=this;for(;f.length;)f.shift().error(l)}})}complete(){$p(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:l}=this;for(;l.length;)l.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var l;return((l=this.observers)===null||l===void 0?void 0:l.length)>0}_trySubscribe(l){return this._throwIfClosed(),super._trySubscribe(l)}_subscribe(l){return this._throwIfClosed(),this._checkFinalizedStatuses(l),this._innerSubscribe(l)}_innerSubscribe(l){let{hasError:f,isStopped:v,observers:i}=this;return f||v?zT:(this.currentObservers=null,i.push(l),new wr(()=>{this.currentObservers=null,yh(i,l)}))}_checkFinalizedStatuses(l){let{hasError:f,thrownError:v,isStopped:i}=this;f?l.error(v):i&&l.complete()}asObservable(){let l=new hi;return l.source=this,l}}return s.create=(c,l)=>new Ox(c,l),s})(),Ox=class extends Er{constructor(c,l){super(),this.destination=c,this.source=l}next(c){var l,f;(f=(l=this.destination)===null||l===void 0?void 0:l.next)===null||f===void 0||f.call(l,c)}error(c){var l,f;(f=(l=this.destination)===null||l===void 0?void 0:l.error)===null||f===void 0||f.call(l,c)}complete(){var c,l;(l=(c=this.destination)===null||c===void 0?void 0:c.complete)===null||l===void 0||l.call(c)}_subscribe(c){var l,f;return(f=(l=this.source)===null||l===void 0?void 0:l.subscribe(c))!==null&&f!==void 0?f:zT}};var Do=class extends Er{constructor(c){super(),this._value=c}get value(){return this.getValue()}_subscribe(c){let l=super._subscribe(c);return!l.closed&&c.next(this._value),l}getValue(){let{hasError:c,thrownError:l,_value:f}=this;if(c)throw l;return this._throwIfClosed(),f}next(c){super.next(this._value=c)}};var WT={now(){return(WT.delegate||Date).now()},delegate:void 0};var Lx=class extends wr{constructor(c,l){super()}schedule(c,l=0){return this}};var Q_={setInterval(s,c,...l){let{delegate:f}=Q_;return f?.setInterval?f.setInterval(s,c,...l):setInterval(s,c,...l)},clearInterval(s){let{delegate:c}=Q_;return(c?.clearInterval||clearInterval)(s)},delegate:void 0};var Fx=class extends Lx{constructor(c,l){super(c,l),this.scheduler=c,this.work=l,this.pending=!1}schedule(c,l=0){var f;if(this.closed)return this;this.state=c;let v=this.id,i=this.scheduler;return v!=null&&(this.id=this.recycleAsyncId(i,v,l)),this.pending=!0,this.delay=l,this.id=(f=this.id)!==null&&f!==void 0?f:this.requestAsyncId(i,this.id,l),this}requestAsyncId(c,l,f=0){return Q_.setInterval(c.flush.bind(c,this),f)}recycleAsyncId(c,l,f=0){if(f!=null&&this.delay===f&&this.pending===!1)return l;l!=null&&Q_.clearInterval(l)}execute(c,l){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;let f=this._execute(c,l);if(f)return f;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(c,l){let f=!1,v;try{this.work(c)}catch(i){f=!0,v=i||new Error("Scheduled action threw falsy error")}if(f)return this.unsubscribe(),v}unsubscribe(){if(!this.closed){let{id:c,scheduler:l}=this,{actions:f}=l;this.work=this.state=this.scheduler=null,this.pending=!1,yh(f,this),c!=null&&(this.id=this.recycleAsyncId(l,c,null)),this.delay=null,super.unsubscribe()}}};var Zp=class s{constructor(c,l=s.now){this.schedulerActionCtor=c,this.now=l}schedule(c,l=0,f){return new this.schedulerActionCtor(this,c).schedule(f,l)}};Zp.now=WT.now;var kx=class extends Zp{constructor(c,l=Zp.now){super(c,l),this.actions=[],this._active=!1}flush(c){let{actions:l}=this;if(this._active){l.push(c);return}let f;this._active=!0;do if(f=c.execute(c.state,c.delay))break;while(c=l.shift());if(this._active=!1,f){for(;c=l.shift();)c.unsubscribe();throw f}}};var m2=new kx(Fx);var As=new hi(s=>s.complete());function g2(s){return s&&ii(s.schedule)}function _2(s){return s[s.length-1]}function Nx(s){return ii(_2(s))?s.pop():void 0}function Bu(s){return g2(_2(s))?s.pop():void 0}function v2(s,c,l,f){function v(i){return i instanceof l?i:new l(function(C){C(i)})}return new(l||(l=Promise))(function(i,C){function k(_e){try{ee(f.next(_e))}catch(Oe){C(Oe)}}function B(_e){try{ee(f.throw(_e))}catch(Oe){C(Oe)}}function ee(_e){_e.done?i(_e.value):v(_e.value).then(k,B)}ee((f=f.apply(s,c||[])).next())})}function y2(s){var c=typeof Symbol=="function"&&Symbol.iterator,l=c&&s[c],f=0;if(l)return l.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&f>=s.length&&(s=void 0),{value:s&&s[f++],done:!s}}};throw new TypeError(c?"Object is not iterable.":"Symbol.iterator is not defined.")}function bh(s){return this instanceof bh?(this.v=s,this):new bh(s)}function x2(s,c,l){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var f=l.apply(s,c||[]),v,i=[];return v=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),k("next"),k("throw"),k("return",C),v[Symbol.asyncIterator]=function(){return this},v;function C(Fe){return function(yt){return Promise.resolve(yt).then(Fe,Oe)}}function k(Fe,yt){f[Fe]&&(v[Fe]=function(Xt){return new Promise(function(At,Lt){i.push([Fe,Xt,At,Lt])>1||B(Fe,Xt)})},yt&&(v[Fe]=yt(v[Fe])))}function B(Fe,yt){try{ee(f[Fe](yt))}catch(Xt){ct(i[0][3],Xt)}}function ee(Fe){Fe.value instanceof bh?Promise.resolve(Fe.value.v).then(_e,Oe):ct(i[0][2],Fe)}function _e(Fe){B("next",Fe)}function Oe(Fe){B("throw",Fe)}function ct(Fe,yt){Fe(yt),i.shift(),i.length&&B(i[0][0],i[0][1])}}function b2(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var c=s[Symbol.asyncIterator],l;return c?c.call(s):(s=typeof y2=="function"?y2(s):s[Symbol.iterator](),l={},f("next"),f("throw"),f("return"),l[Symbol.asyncIterator]=function(){return this},l);function f(i){l[i]=s[i]&&function(C){return new Promise(function(k,B){C=s[i](C),v(k,B,C.done,C.value)})}}function v(i,C,k,B){Promise.resolve(B).then(function(ee){i({value:ee,done:k})},C)}}var zx=s=>s&&typeof s.length=="number"&&typeof s!="function";function Bx(s){return ii(s?.then)}function Vx(s){return ii(s[Gp])}function jx(s){return Symbol.asyncIterator&&ii(s?.[Symbol.asyncIterator])}function Ux(s){return new TypeError(`You provided ${s!==null&&typeof s=="object"?"an invalid object":`'${s}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function Ij(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Hx=Ij();function $x(s){return ii(s?.[Hx])}function Gx(s){return x2(this,arguments,function*(){let l=s.getReader();try{for(;;){let{value:f,done:v}=yield bh(l.read());if(v)return yield bh(void 0);yield yield bh(f)}}finally{l.releaseLock()}})}function qx(s){return ii(s?.getReader)}function Rr(s){if(s instanceof hi)return s;if(s!=null){if(Vx(s))return Sj(s);if(zx(s))return Dj(s);if(Bx(s))return Cj(s);if(jx(s))return w2(s);if($x(s))return Aj(s);if(qx(s))return Mj(s)}throw Ux(s)}function Sj(s){return new hi(c=>{let l=s[Gp]();if(ii(l.subscribe))return l.subscribe(c);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Dj(s){return new hi(c=>{for(let l=0;l<s.length&&!c.closed;l++)c.next(s[l]);c.complete()})}function Cj(s){return new hi(c=>{s.then(l=>{c.closed||(c.next(l),c.complete())},l=>c.error(l)).then(null,Rx)})}function Aj(s){return new hi(c=>{for(let l of s)if(c.next(l),c.closed)return;c.complete()})}function w2(s){return new hi(c=>{Rj(s,c).catch(l=>c.error(l))})}function Mj(s){return w2(Gx(s))}function Rj(s,c){var l,f,v,i;return v2(this,void 0,void 0,function*(){try{for(l=b2(s);f=yield l.next(),!f.done;){let C=f.value;if(c.next(C),c.closed)return}}catch(C){v={error:C}}finally{try{f&&!f.done&&(i=l.return)&&(yield i.call(l))}finally{if(v)throw v.error}}c.complete()})}function Ms(s,c,l,f=0,v=!1){let i=c.schedule(function(){l(),v?s.add(this.schedule(null,f)):this.unsubscribe()},f);if(s.add(i),!v)return i}function Wx(s,c=0){return vi((l,f)=>{l.subscribe(xi(f,v=>Ms(f,s,()=>f.next(v),c),()=>Ms(f,s,()=>f.complete(),c),v=>Ms(f,s,()=>f.error(v),c)))})}function Zx(s,c=0){return vi((l,f)=>{f.add(s.schedule(()=>l.subscribe(f),c))})}function E2(s,c){return Rr(s).pipe(Zx(c),Wx(c))}function T2(s,c){return Rr(s).pipe(Zx(c),Wx(c))}function I2(s,c){return new hi(l=>{let f=0;return c.schedule(function(){f===s.length?l.complete():(l.next(s[f++]),l.closed||this.schedule())})})}function S2(s,c){return new hi(l=>{let f;return Ms(l,c,()=>{f=s[Hx](),Ms(l,c,()=>{let v,i;try{({value:v,done:i}=f.next())}catch(C){l.error(C);return}i?l.complete():l.next(v)},0,!0)}),()=>ii(f?.return)&&f.return()})}function Xx(s,c){if(!s)throw new Error("Iterable cannot be null");return new hi(l=>{Ms(l,c,()=>{let f=s[Symbol.asyncIterator]();Ms(l,c,()=>{f.next().then(v=>{v.done?l.complete():l.next(v.value)})},0,!0)})})}function D2(s,c){return Xx(Gx(s),c)}function C2(s,c){if(s!=null){if(Vx(s))return E2(s,c);if(zx(s))return I2(s,c);if(Bx(s))return T2(s,c);if(jx(s))return Xx(s,c);if($x(s))return S2(s,c);if(qx(s))return D2(s,c)}throw Ux(s)}function Tr(s,c){return c?C2(s,c):Rr(s)}function mn(...s){let c=Bu(s);return Tr(s,c)}function Xa(s,c){let l=ii(s)?s:()=>s,f=v=>v.error(l());return new hi(c?v=>c.schedule(f,0,v):f)}function ZT(s){return!!s&&(s instanceof hi||ii(s.lift)&&ii(s.subscribe))}var bc=Up(s=>function(){s(this),this.name="EmptyError",this.message="no elements in sequence"});function Ln(s,c){return vi((l,f)=>{let v=0;l.subscribe(xi(f,i=>{f.next(s.call(c,i,v++))}))})}var{isArray:Pj}=Array;function Oj(s,c){return Pj(c)?s(...c):s(c)}function Yx(s){return Ln(c=>Oj(s,c))}var{isArray:Lj}=Array,{getPrototypeOf:Fj,prototype:kj,keys:Nj}=Object;function Kx(s){if(s.length===1){let c=s[0];if(Lj(c))return{args:c,keys:null};if(zj(c)){let l=Nj(c);return{args:l.map(f=>c[f]),keys:l}}}return{args:s,keys:null}}function zj(s){return s&&typeof s=="object"&&Fj(s)===kj}function Jx(s,c){return s.reduce((l,f,v)=>(l[f]=c[v],l),{})}function wh(...s){let c=Bu(s),l=Nx(s),{args:f,keys:v}=Kx(s);if(f.length===0)return Tr([],c);let i=new hi(Bj(f,c,v?C=>Jx(v,C):Ys));return l?i.pipe(Yx(l)):i}function Bj(s,c,l=Ys){return f=>{A2(c,()=>{let{length:v}=s,i=new Array(v),C=v,k=v;for(let B=0;B<v;B++)A2(c,()=>{let ee=Tr(s[B],c),_e=!1;ee.subscribe(xi(f,Oe=>{i[B]=Oe,_e||(_e=!0,k--),k||f.next(l(i.slice()))},()=>{--C||f.complete()}))},f)},f)}}function A2(s,c,l){s?Ms(l,s,c):c()}function M2(s,c,l,f,v,i,C,k){let B=[],ee=0,_e=0,Oe=!1,ct=()=>{Oe&&!B.length&&!ee&&c.complete()},Fe=Xt=>ee<f?yt(Xt):B.push(Xt),yt=Xt=>{i&&c.next(Xt),ee++;let At=!1;Rr(l(Xt,_e++)).subscribe(xi(c,Lt=>{v?.(Lt),i?Fe(Lt):c.next(Lt)},()=>{At=!0},void 0,()=>{if(At)try{for(ee--;B.length&&ee<f;){let Lt=B.shift();C?Ms(c,C,()=>yt(Lt)):yt(Lt)}ct()}catch(Lt){c.error(Lt)}}))};return s.subscribe(xi(c,Fe,()=>{Oe=!0,ct()})),()=>{k?.()}}function $r(s,c,l=1/0){return ii(c)?$r((f,v)=>Ln((i,C)=>c(f,i,v,C))(Rr(s(f,v))),l):(typeof c=="number"&&(l=c),vi((f,v)=>M2(f,v,s,l)))}function Xp(s=1/0){return $r(Ys,s)}function R2(){return Xp(1)}function Vu(...s){return R2()(Tr(s,Bu(s)))}function ey(s){return new hi(c=>{Rr(s()).subscribe(c)})}function ty(...s){let c=Nx(s),{args:l,keys:f}=Kx(s),v=new hi(i=>{let{length:C}=l;if(!C){i.complete();return}let k=new Array(C),B=C,ee=C;for(let _e=0;_e<C;_e++){let Oe=!1;Rr(l[_e]).subscribe(xi(i,ct=>{Oe||(Oe=!0,ee--),k[_e]=ct},()=>B--,void 0,()=>{(!B||!Oe)&&(ee||i.next(f?Jx(f,k):k),i.complete())}))}});return c?v.pipe(Yx(c)):v}function go(s,c){return vi((l,f)=>{let v=0;l.subscribe(xi(f,i=>s.call(c,i,v++)&&f.next(i)))})}function Ks(s){return vi((c,l)=>{let f=null,v=!1,i;f=c.subscribe(xi(l,void 0,void 0,C=>{i=Rr(s(C,Ks(s)(c))),f?(f.unsubscribe(),f=null,i.subscribe(l)):v=!0})),v&&(f.unsubscribe(),f=null,i.subscribe(l))})}function P2(s,c,l,f,v){return(i,C)=>{let k=l,B=c,ee=0;i.subscribe(xi(C,_e=>{let Oe=ee++;B=k?s(B,_e,Oe):(k=!0,_e),f&&C.next(B)},v&&(()=>{k&&C.next(B),C.complete()})))}}function Al(s,c){return ii(c)?$r(s,c,1):$r(s,1)}function XT(s,c=m2){return vi((l,f)=>{let v=null,i=null,C=null,k=()=>{if(v){v.unsubscribe(),v=null;let ee=i;i=null,f.next(ee)}};function B(){let ee=C+s,_e=c.now();if(_e<ee){v=this.schedule(void 0,ee-_e),f.add(v);return}k()}l.subscribe(xi(f,ee=>{i=ee,C=c.now(),v||(v=c.schedule(B,s),f.add(v))},()=>{k(),f.complete()},void 0,()=>{i=v=null}))})}function ju(s){return vi((c,l)=>{let f=!1;c.subscribe(xi(l,v=>{f=!0,l.next(v)},()=>{f||l.next(s),l.complete()}))})}function Js(s){return s<=0?()=>As:vi((c,l)=>{let f=0;c.subscribe(xi(l,v=>{++f<=s&&(l.next(v),s<=f&&l.complete())}))})}function Qx(s=Vj){return vi((c,l)=>{let f=!1;c.subscribe(xi(l,v=>{f=!0,l.next(v)},()=>f?l.complete():l.error(s())))})}function Vj(){return new bc}function wc(s){return vi((c,l)=>{try{c.subscribe(l)}finally{l.add(s)}})}function Ec(s,c){let l=arguments.length>=2;return f=>f.pipe(s?go((v,i)=>s(v,i,f)):Ys,Js(1),l?ju(c):Qx(()=>new bc))}function Yp(s){return s<=0?()=>As:vi((c,l)=>{let f=[];c.subscribe(xi(l,v=>{f.push(v),s<f.length&&f.shift()},()=>{for(let v of f)l.next(v);l.complete()},void 0,()=>{f=null}))})}function YT(s,c){let l=arguments.length>=2;return f=>f.pipe(s?go((v,i)=>s(v,i,f)):Ys,Yp(1),l?ju(c):Qx(()=>new bc))}function KT(s,c){return vi(P2(s,c,arguments.length>=2,!0))}function QT(s={}){let{connector:c=()=>new Er,resetOnError:l=!0,resetOnComplete:f=!0,resetOnRefCountZero:v=!0}=s;return i=>{let C,k,B,ee=0,_e=!1,Oe=!1,ct=()=>{k?.unsubscribe(),k=void 0},Fe=()=>{ct(),C=B=void 0,_e=Oe=!1},yt=()=>{let Xt=C;Fe(),Xt?.unsubscribe()};return vi((Xt,At)=>{ee++,!Oe&&!_e&&ct();let Lt=B=B??c();At.add(()=>{ee--,ee===0&&!Oe&&!_e&&(k=JT(yt,v))}),Lt.subscribe(At),!C&&ee>0&&(C=new xc({next:qn=>Lt.next(qn),error:qn=>{Oe=!0,ct(),k=JT(Fe,l,qn),Lt.error(qn)},complete:()=>{_e=!0,ct(),k=JT(Fe,f),Lt.complete()}}),Rr(Xt).subscribe(C))})(i)}}function JT(s,c,...l){if(c===!0){s();return}if(c===!1)return;let f=new xc({next:()=>{f.unsubscribe(),s()}});return Rr(c(...l)).subscribe(f)}function eI(s){return go((c,l)=>s<=l)}function ny(...s){let c=Bu(s);return vi((l,f)=>{(c?Vu(s,l,c):Vu(s,l)).subscribe(f)})}function Co(s,c){return vi((l,f)=>{let v=null,i=0,C=!1,k=()=>C&&!v&&f.complete();l.subscribe(xi(f,B=>{v?.unsubscribe();let ee=0,_e=i++;Rr(s(B,_e)).subscribe(v=xi(f,Oe=>f.next(c?c(B,Oe,_e,ee++):Oe),()=>{v=null,k()}))},()=>{C=!0,k()}))})}function Kp(s){return vi((c,l)=>{Rr(s).subscribe(xi(l,()=>l.complete(),J_)),!l.closed&&c.subscribe(l)})}function Br(s,c,l){let f=ii(s)||c||l?{next:s,error:c,complete:l}:s;return f?vi((v,i)=>{var C;(C=f.subscribe)===null||C===void 0||C.call(f);let k=!0;v.subscribe(xi(i,B=>{var ee;(ee=f.next)===null||ee===void 0||ee.call(f,B),i.next(B)},()=>{var B;k=!1,(B=f.complete)===null||B===void 0||B.call(f),i.complete()},B=>{var ee;k=!1,(ee=f.error)===null||ee===void 0||ee.call(f,B),i.error(B)},()=>{var B,ee;k&&((B=f.unsubscribe)===null||B===void 0||B.call(f)),(ee=f.finalize)===null||ee===void 0||ee.call(f)}))}):Ys}function O2(s){let c=Xn(null);try{return s()}finally{Xn(c)}}var ib="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",tn=class extends Error{code;constructor(c,l){super(Dc(c,l)),this.code=c}};function jj(s){return`NG0${Math.abs(s)}`}function Dc(s,c){return`${jj(s)}${c?": "+c:""}`}var Hu=globalThis;function Ji(s){for(let c in s)if(s[c]===Ji)return c;throw Error("")}function k2(s,c){for(let l in c)c.hasOwnProperty(l)&&!s.hasOwnProperty(l)&&(s[l]=c[l])}function Ic(s){if(typeof s=="string")return s;if(Array.isArray(s))return`[${s.map(Ic).join(", ")}]`;if(s==null)return""+s;let c=s.overriddenName||s.name;if(c)return`${c}`;let l=s.toString();if(l==null)return""+l;let f=l.indexOf(`
`);return f>=0?l.slice(0,f):l}function rb(s,c){return s?c?`${s} ${c}`:s:c||""}var Uj=Ji({__forward_ref__:Ji});function Ch(s){return s.__forward_ref__=Ch,s.toString=function(){return Ic(this())},s}function Ao(s){return hI(s)?s():s}function hI(s){return typeof s=="function"&&s.hasOwnProperty(Uj)&&s.__forward_ref__===Ch}function Wt(s){return{token:s.token,providedIn:s.providedIn||null,factory:s.factory,value:void 0}}function yo(s){return{providers:s.providers||[],imports:s.imports||[]}}function sy(s){return Hj(s,ob)}function fI(s){return sy(s)!==null}function Hj(s,c){return s.hasOwnProperty(c)&&s[c]||null}function $j(s){let c=s?.[ob]??null;return c||null}function nI(s){return s&&s.hasOwnProperty(tb)?s[tb]:null}var ob=Ji({\u0275prov:Ji}),tb=Ji({\u0275inj:Ji}),Kt=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(c,l){this._desc=c,this.\u0275prov=void 0,typeof l=="number"?this.__NG_ELEMENT_ID__=l:l!==void 0&&(this.\u0275prov=Wt({token:this,providedIn:l.providedIn||"root",factory:l.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function pI(s){return s&&!!s.\u0275providers}var mI=Ji({\u0275cmp:Ji}),gI=Ji({\u0275dir:Ji}),_I=Ji({\u0275pipe:Ji}),yI=Ji({\u0275mod:Ji}),ry=Ji({\u0275fac:Ji}),Ah=Ji({__NG_ELEMENT_ID__:Ji}),L2=Ji({__NG_ENV_ID__:Ji});function Qp(s){return typeof s=="string"?s:s==null?"":String(s)}function N2(s){return typeof s=="function"?s.name||s.toString():typeof s=="object"&&s!=null&&typeof s.type=="function"?s.type.name||s.type.toString():Qp(s)}var z2=Ji({ngErrorCode:Ji}),Gj=Ji({ngErrorMessage:Ji}),qj=Ji({ngTokenPath:Ji});function vI(s,c){return B2("",-200,c)}function sb(s,c){throw new tn(-201,!1)}function B2(s,c,l){let f=new tn(c,s);return f[z2]=c,f[Gj]=s,l&&(f[qj]=l),f}function Wj(s){return s[z2]}var iI;function V2(){return iI}function Qs(s){let c=iI;return iI=s,c}function xI(s,c,l){let f=sy(s);if(f&&f.providedIn=="root")return f.value===void 0?f.value=f.factory():f.value;if(l&8)return null;if(c!==void 0)return c;sb(s,"Injector")}var Zj={},Eh=Zj,Xj="__NG_DI_FLAG__",rI=class{injector;constructor(c){this.injector=c}retrieve(c,l){let f=Th(l)||0;try{return this.injector.get(c,f&8?null:Eh,f)}catch(v){if(kp(v))return v;throw v}}};function Yj(s,c=0){let l=yx();if(l===void 0)throw new tn(-203,!1);if(l===null)return xI(s,void 0,c);{let f=Kj(c),v=l.retrieve(s,f);if(kp(v)){if(f.optional)return null;throw v}return v}}function ln(s,c=0){return(V2()||Yj)(Ao(s),c)}function pt(s,c){return ln(s,Th(c))}function Th(s){return typeof s>"u"||typeof s=="number"?s:0|(s.optional&&8)|(s.host&&1)|(s.self&&2)|(s.skipSelf&&4)}function Kj(s){return{optional:!!(s&8),host:!!(s&1),self:!!(s&2),skipSelf:!!(s&4)}}function oI(s){let c=[];for(let l=0;l<s.length;l++){let f=Ao(s[l]);if(Array.isArray(f)){if(f.length===0)throw new tn(900,!1);let v,i=0;for(let C=0;C<f.length;C++){let k=f[C],B=Jj(k);typeof B=="number"?B===-1?v=k.token:i|=B:v=k}c.push(ln(v,i))}else c.push(ln(f))}return c}function Jj(s){return s[Xj]}function Ih(s,c){let l=s.hasOwnProperty(ry);return l?s[ry]:null}function ab(s,c){s.forEach(l=>Array.isArray(l)?ab(l,c):c(l))}function bI(s,c,l){c>=s.length?s.push(l):s.splice(c,0,l)}function ay(s,c){return c>=s.length-1?s.pop():s.splice(c,1)[0]}function j2(s,c){let l=[];for(let f=0;f<s;f++)l.push(c);return l}function U2(s,c,l,f){let v=s.length;if(v==c)s.push(l,f);else if(v===1)s.push(f,s[0]),s[0]=l;else{for(v--,s.push(s[v-1],s[v]);v>c;){let i=v-2;s[v]=s[i],v--}s[c]=l,s[c+1]=f}}function lb(s,c,l){let f=em(s,c);return f>=0?s[f|1]=l:(f=~f,U2(s,f,c,l)),f}function cb(s,c){let l=em(s,c);if(l>=0)return s[l|1]}function em(s,c){return Qj(s,c,1)}function Qj(s,c,l){let f=0,v=s.length>>l;for(;v!==f;){let i=f+(v-f>>1),C=s[i<<l];if(c===C)return i<<l;C>c?v=i:f=i+1}return~(v<<l)}var $u={},us=[],Ml=new Kt(""),wI=new Kt("",-1),EI=new Kt(""),oy=class{get(c,l=Eh){if(l===Eh){let v=B2("",-201);throw v.name="\u0275NotFound",v}return l}};function TI(s){return s[yI]||null}function Cc(s){return s[mI]||null}function II(s){return s[gI]||null}function H2(s){return s[_I]||null}function Ya(s){return{\u0275providers:s}}function $2(s){return Ya([{provide:Ml,multi:!0,useValue:s}])}function G2(...s){return{\u0275providers:SI(!0,s),\u0275fromNgModule:!0}}function SI(s,...c){let l=[],f=new Set,v,i=C=>{l.push(C)};return ab(c,C=>{let k=C;nb(k,i,[],f)&&(v||=[],v.push(k))}),v!==void 0&&q2(v,i),l}function q2(s,c){for(let l=0;l<s.length;l++){let{ngModule:f,providers:v}=s[l];DI(v,i=>{c(i,f)})}}function nb(s,c,l,f){if(s=Ao(s),!s)return!1;let v=null,i=nI(s),C=!i&&Cc(s);if(!i&&!C){let B=s.ngModule;if(i=nI(B),i)v=B;else return!1}else{if(C&&!C.standalone)return!1;v=s}let k=f.has(v);if(C){if(k)return!1;if(f.add(v),C.dependencies){let B=typeof C.dependencies=="function"?C.dependencies():C.dependencies;for(let ee of B)nb(ee,c,l,f)}}else if(i){if(i.imports!=null&&!k){f.add(v);let ee;try{ab(i.imports,_e=>{nb(_e,c,l,f)&&(ee||=[],ee.push(_e))})}finally{}ee!==void 0&&q2(ee,c)}if(!k){let ee=Ih(v)||(()=>new v);c({provide:v,useFactory:ee,deps:us},v),c({provide:EI,useValue:v,multi:!0},v),c({provide:Ml,useValue:()=>ln(v),multi:!0},v)}let B=i.providers;if(B!=null&&!k){let ee=s;DI(B,_e=>{c(_e,ee)})}}else return!1;return v!==s&&s.providers!==void 0}function DI(s,c){for(let l of s)pI(l)&&(l=l.\u0275providers),Array.isArray(l)?DI(l,c):c(l)}var eU=Ji({provide:String,useValue:Ji});function W2(s){return s!==null&&typeof s=="object"&&eU in s}function tU(s){return!!(s&&s.useExisting)}function nU(s){return!!(s&&s.useFactory)}function Sh(s){return typeof s=="function"}function Z2(s){return!!s.useClass}var ly=new Kt(""),eb={},F2={},tI;function cy(){return tI===void 0&&(tI=new oy),tI}var Gr=class{},Dh=class extends Gr{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(c,l,f,v){super(),this.parent=l,this.source=f,this.scopes=v,aI(c,C=>this.processProvider(C)),this.records.set(wI,Jp(void 0,this)),v.has("environment")&&this.records.set(Gr,Jp(void 0,this));let i=this.records.get(ly);i!=null&&typeof i.value=="string"&&this.scopes.add(i.value),this.injectorDefTypes=new Set(this.get(EI,us,{self:!0}))}retrieve(c,l){let f=Th(l)||0;try{return this.get(c,Eh,f)}catch(v){if(kp(v))return v;throw v}}destroy(){iy(this),this._destroyed=!0;let c=Xn(null);try{for(let f of this._ngOnDestroyHooks)f.ngOnDestroy();let l=this._onDestroyHooks;this._onDestroyHooks=[];for(let f of l)f()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),Xn(c)}}onDestroy(c){return iy(this),this._onDestroyHooks.push(c),()=>this.removeOnDestroy(c)}runInContext(c){iy(this);let l=Cl(this),f=Qs(void 0),v;try{return c()}finally{Cl(l),Qs(f)}}get(c,l=Eh,f){if(iy(this),c.hasOwnProperty(L2))return c[L2](this);let v=Th(f),i,C=Cl(this),k=Qs(void 0);try{if(!(v&4)){let ee=this.records.get(c);if(ee===void 0){let _e=aU(c)&&sy(c);_e&&this.injectableDefInScope(_e)?ee=Jp(sI(c),eb):ee=null,this.records.set(c,ee)}if(ee!=null)return this.hydrate(c,ee,v)}let B=v&2?cy():this.parent;return l=v&8&&l===Eh?null:l,B.get(c,l)}catch(B){let ee=Wj(B);throw ee===-200||ee===-201?new tn(ee,null):B}finally{Qs(k),Cl(C)}}resolveInjectorInitializers(){let c=Xn(null),l=Cl(this),f=Qs(void 0),v;try{let i=this.get(Ml,us,{self:!0});for(let C of i)C()}finally{Cl(l),Qs(f),Xn(c)}}toString(){let c=[],l=this.records;for(let f of l.keys())c.push(Ic(f));return`R3Injector[${c.join(", ")}]`}processProvider(c){c=Ao(c);let l=Sh(c)?c:Ao(c&&c.provide),f=rU(c);if(!Sh(c)&&c.multi===!0){let v=this.records.get(l);v||(v=Jp(void 0,eb,!0),v.factory=()=>oI(v.multi),this.records.set(l,v)),l=c,v.multi.push(c)}this.records.set(l,f)}hydrate(c,l,f){let v=Xn(null);try{if(l.value===F2)throw vI(Ic(c));return l.value===eb&&(l.value=F2,l.value=l.factory(void 0,f)),typeof l.value=="object"&&l.value&&sU(l.value)&&this._ngOnDestroyHooks.add(l.value),l.value}finally{Xn(v)}}injectableDefInScope(c){if(!c.providedIn)return!1;let l=Ao(c.providedIn);return typeof l=="string"?l==="any"||this.scopes.has(l):this.injectorDefTypes.has(l)}removeOnDestroy(c){let l=this._onDestroyHooks.indexOf(c);l!==-1&&this._onDestroyHooks.splice(l,1)}};function sI(s){let c=sy(s),l=c!==null?c.factory:Ih(s);if(l!==null)return l;if(s instanceof Kt)throw new tn(204,!1);if(s instanceof Function)return iU(s);throw new tn(204,!1)}function iU(s){if(s.length>0)throw new tn(204,!1);let l=$j(s);return l!==null?()=>l.factory(s):()=>new s}function rU(s){if(W2(s))return Jp(void 0,s.useValue);{let c=CI(s);return Jp(c,eb)}}function CI(s,c,l){let f;if(Sh(s)){let v=Ao(s);return Ih(v)||sI(v)}else if(W2(s))f=()=>Ao(s.useValue);else if(nU(s))f=()=>s.useFactory(...oI(s.deps||[]));else if(tU(s))f=(v,i)=>ln(Ao(s.useExisting),i!==void 0&&i&8?8:void 0);else{let v=Ao(s&&(s.useClass||s.provide));if(oU(s))f=()=>new v(...oI(s.deps));else return Ih(v)||sI(v)}return f}function iy(s){if(s.destroyed)throw new tn(205,!1)}function Jp(s,c,l=!1){return{factory:s,value:c,multi:l?[]:void 0}}function oU(s){return!!s.deps}function sU(s){return s!==null&&typeof s=="object"&&typeof s.ngOnDestroy=="function"}function aU(s){return typeof s=="function"||typeof s=="object"&&s.ngMetadataName==="InjectionToken"}function aI(s,c){for(let l of s)Array.isArray(l)?aI(l,c):l&&pI(l)?aI(l.\u0275providers,c):c(l)}function vo(s,c){let l;s instanceof Dh?(iy(s),l=s):l=new rI(s);let f,v=Cl(l),i=Qs(void 0);try{return c()}finally{Cl(v),Qs(i)}}function X2(){return V2()!==void 0||yx()!=null}var Ka=0,Gn=1,Qn=2,_o=3,ya=4,ds=5,Mh=6,tm=7,qr=8,Gu=9,Rl=10,Ir=11,nm=12,AI=13,Rh=14,hs=15,Ph=16,Oh=17,Lh=18,uy=19,MI=20,Tc=21,ub=22,dy=23,ea=24,Fh=25,kh=26,ro=27,Y2=1,RI=6,qu=7,hy=8,fy=9,oo=10;function Pl(s){return Array.isArray(s)&&typeof s[Y2]=="object"}function Ja(s){return Array.isArray(s)&&s[Y2]===!0}function PI(s){return(s.flags&4)!==0}function Wu(s){return s.componentOffset>-1}function db(s){return(s.flags&1)===1}function Ol(s){return!!s.template}function im(s){return(s[Qn]&512)!==0}function Nh(s){return(s[Qn]&256)===256}var K2="svg",J2="math";function va(s){for(;Array.isArray(s);)s=s[Ka];return s}function OI(s,c){return va(c[s])}function Qa(s,c){return va(c[s.index])}function py(s,c){return s.data[c]}function xa(s,c){let l=c[s];return Pl(l)?l:l[Ka]}function hb(s){return(s[Qn]&128)===128}function Q2(s){return Ja(s[_o])}function Ll(s,c){return c==null?null:s[c]}function LI(s){s[Oh]=0}function FI(s){s[Qn]&1024||(s[Qn]|=1024,hb(s)&&rm(s))}function eO(s,c){for(;s>0;)c=c[Rh],s--;return c}function my(s){return!!(s[Qn]&9216||s[ea]?.dirty)}function fb(s){s[Rl].changeDetectionScheduler?.notify(8),s[Qn]&64&&(s[Qn]|=1024),my(s)&&rm(s)}function rm(s){s[Rl].changeDetectionScheduler?.notify(0);let c=Uu(s);for(;c!==null&&!(c[Qn]&8192||(c[Qn]|=8192,!hb(c)));)c=Uu(c)}function kI(s,c){if(Nh(s))throw new tn(911,!1);s[Tc]===null&&(s[Tc]=[]),s[Tc].push(c)}function tO(s,c){if(s[Tc]===null)return;let l=s[Tc].indexOf(c);l!==-1&&s[Tc].splice(l,1)}function Uu(s){let c=s[_o];return Ja(c)?c[_o]:c}function nO(s){return s[tm]??=[]}function iO(s){return s.cleanup??=[]}var Ei={lFrame:mO(null),bindingsEnabled:!0,skipHydrationRootTNode:null};var lI=!1;function rO(){return Ei.lFrame.elementDepthCount}function oO(){Ei.lFrame.elementDepthCount++}function NI(){Ei.lFrame.elementDepthCount--}function sO(){return Ei.bindingsEnabled}function zI(){return Ei.skipHydrationRootTNode!==null}function BI(s){return Ei.skipHydrationRootTNode===s}function VI(){Ei.skipHydrationRootTNode=null}function Si(){return Ei.lFrame.lView}function Ho(){return Ei.lFrame.tView}function Rs(s){return Ei.lFrame.contextLView=s,s[qr]}function Ps(s){return Ei.lFrame.contextLView=null,s}function fs(){let s=jI();for(;s!==null&&s.type===64;)s=s.parent;return s}function jI(){return Ei.lFrame.currentTNode}function aO(){let s=Ei.lFrame,c=s.currentTNode;return s.isParent?c:c.parent}function om(s,c){let l=Ei.lFrame;l.currentTNode=s,l.isParent=c}function UI(){return Ei.lFrame.isParent}function HI(){Ei.lFrame.isParent=!1}function $I(){return lI}function GI(s){let c=lI;return lI=s,c}function lO(){let s=Ei.lFrame,c=s.bindingRootIndex;return c===-1&&(c=s.bindingRootIndex=s.tView.bindingStartIndex),c}function cO(s){return Ei.lFrame.bindingIndex=s}function Zu(){return Ei.lFrame.bindingIndex++}function qI(s){let c=Ei.lFrame,l=c.bindingIndex;return c.bindingIndex=c.bindingIndex+s,l}function uO(){return Ei.lFrame.inI18n}function dO(s,c){let l=Ei.lFrame;l.bindingIndex=l.bindingRootIndex=s,pb(c)}function hO(){return Ei.lFrame.currentDirectiveIndex}function pb(s){Ei.lFrame.currentDirectiveIndex=s}function fO(s){let c=Ei.lFrame.currentDirectiveIndex;return c===-1?null:s[c]}function WI(s){Ei.lFrame.currentQueryIndex=s}function lU(s){let c=s[Gn];return c.type===2?c.declTNode:c.type===1?s[ds]:null}function ZI(s,c,l){if(l&4){let v=c,i=s;for(;v=v.parent,v===null&&!(l&1);)if(v=lU(i),v===null||(i=i[Rh],v.type&10))break;if(v===null)return!1;c=v,s=i}let f=Ei.lFrame=pO();return f.currentTNode=c,f.lView=s,!0}function mb(s){let c=pO(),l=s[Gn];Ei.lFrame=c,c.currentTNode=l.firstChild,c.lView=s,c.tView=l,c.contextLView=s,c.bindingIndex=l.bindingStartIndex,c.inI18n=!1}function pO(){let s=Ei.lFrame,c=s===null?null:s.child;return c===null?mO(s):c}function mO(s){let c={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:s,child:null,inI18n:!1};return s!==null&&(s.child=c),c}function gO(){let s=Ei.lFrame;return Ei.lFrame=s.parent,s.currentTNode=null,s.lView=null,s}var XI=gO;function gb(){let s=gO();s.isParent=!0,s.tView=null,s.selectedIndex=-1,s.contextLView=null,s.elementDepthCount=0,s.currentDirectiveIndex=-1,s.currentNamespace=null,s.bindingRootIndex=-1,s.bindingIndex=-1,s.currentQueryIndex=0}function _O(s){return(Ei.lFrame.contextLView=eO(s,Ei.lFrame.contextLView))[qr]}function Ac(){return Ei.lFrame.selectedIndex}function Xu(s){Ei.lFrame.selectedIndex=s}function _b(){let s=Ei.lFrame;return py(s.tView,s.selectedIndex)}function yO(){return Ei.lFrame.currentNamespace}var vO=!0;function yb(){return vO}function vb(s){vO=s}function cI(s,c=null,l=null,f){let v=YI(s,c,l,f);return v.resolveInjectorInitializers(),v}function YI(s,c=null,l=null,f,v=new Set){let i=[l||us,G2(s)];return f=f||(typeof s=="object"?void 0:Ic(s)),new Dh(i,c||cy(),f||null,v)}var jo=class s{static THROW_IF_NOT_FOUND=Eh;static NULL=new oy;static create(c,l){if(Array.isArray(c))return cI({name:""},l,c,"");{let f=c.name??"";return cI({name:f},c.parent,c.providers,f)}}static \u0275prov=Wt({token:s,providedIn:"any",factory:()=>ln(wI)});static __NG_ELEMENT_ID__=-1},Qi=new Kt(""),Fl=(()=>{class s{static __NG_ELEMENT_ID__=cU;static __NG_ENV_ID__=l=>l}return s})(),uI=class extends Fl{_lView;constructor(c){super(),this._lView=c}get destroyed(){return Nh(this._lView)}onDestroy(c){let l=this._lView;return kI(l,c),()=>tO(l,c)}};function cU(){return new uI(Si())}var Uo=class{_console=console;handleError(c){this._console.error("ERROR",c)}},Os=new Kt("",{providedIn:"root",factory:()=>{let s=pt(Gr),c;return l=>{s.destroyed&&!c?setTimeout(()=>{throw l}):(c??=s.get(Uo),c.handleError(l))}}}),xO={provide:Ml,useValue:()=>void pt(Uo),multi:!0},uU=new Kt("",{providedIn:"root",factory:()=>{let s=pt(Qi).defaultView;if(!s)return;let c=pt(Os),l=i=>{c(i.reason),i.preventDefault()},f=i=>{i.error?c(i.error):c(new Error(i.message,{cause:i})),i.preventDefault()},v=()=>{s.addEventListener("unhandledrejection",l),s.addEventListener("error",f)};typeof Zone<"u"?Zone.root.run(v):v(),pt(Fl).onDestroy(()=>{s.removeEventListener("error",f),s.removeEventListener("unhandledrejection",l)})}});function KI(){return Ya([$2(()=>void pt(uU))])}function ba(s,c){let[l,f,v]=kT(s,c?.equal),i=l,C=i[cs];return i.set=f,i.update=v,i.asReadonly=bO.bind(i),i}function bO(){let s=this[cs];if(s.readonlyFn===void 0){let c=()=>this();c[cs]=s,s.readonlyFn=c}return s.readonlyFn}var xb=(()=>{class s{view;node;constructor(l,f){this.view=l,this.node=f}static __NG_ELEMENT_ID__=dU}return s})();function dU(){return new xb(Si(),fs())}var Sc=class{},sm=new Kt("",{providedIn:"root",factory:()=>!1});var JI=new Kt(""),QI=new Kt(""),kl=(()=>{class s{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new Do(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new hi(l=>{l.next(!1),l.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let l=this.taskId++;return this.pendingTasks.add(l),l}has(l){return this.pendingTasks.has(l)}remove(l){this.pendingTasks.delete(l),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>new s})}return s})(),bb=(()=>{class s{internalPendingTasks=pt(kl);scheduler=pt(Sc);errorHandler=pt(Os);add(){let l=this.internalPendingTasks.add();return()=>{this.internalPendingTasks.has(l)&&(this.scheduler.notify(11),this.internalPendingTasks.remove(l))}}run(l){let f=this.add();l().catch(this.errorHandler).finally(f)}static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>new s})}return s})();function gy(...s){}var eS=(()=>{class s{static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>new dI})}return s})(),dI=class{dirtyEffectCount=0;queues=new Map;add(c){this.enqueue(c),this.schedule(c)}schedule(c){c.dirty&&this.dirtyEffectCount++}remove(c){let l=c.zone,f=this.queues.get(l);f.has(c)&&(f.delete(c),c.dirty&&this.dirtyEffectCount--)}enqueue(c){let l=c.zone;this.queues.has(l)||this.queues.set(l,new Set);let f=this.queues.get(l);f.has(c)||f.add(c)}flush(){for(;this.dirtyEffectCount>0;){let c=!1;for(let[l,f]of this.queues)l===null?c||=this.flushQueue(f):c||=l.run(()=>this.flushQueue(f));c||(this.dirtyEffectCount=0)}}flushQueue(c){let l=!1;for(let f of c)f.dirty&&(this.dirtyEffectCount--,l=!0,f.run());return l}};function Ty(s){return{toString:s}.toString()}function bU(s){return typeof s=="function"}var Ab=class{previousValue;currentValue;firstChange;constructor(c,l,f){this.previousValue=c,this.currentValue=l,this.firstChange=f}isFirstChange(){return this.firstChange}};function nL(s,c,l,f){c!==null?c.applyValueToInputSignal(c,f):s[l]=f}var Oc=(()=>{let s=()=>iL;return s.ngInherit=!0,s})();function iL(s){return s.type.prototype.ngOnChanges&&(s.setInput=EU),wU}function wU(){let s=oL(this),c=s?.current;if(c){let l=s.previous;if(l===$u)s.previous=c;else for(let f in c)l[f]=c[f];s.current=null,this.ngOnChanges(c)}}function EU(s,c,l,f,v){let i=this.declaredInputs[f],C=oL(s)||TU(s,{previous:$u,current:null}),k=C.current||(C.current={}),B=C.previous,ee=B[i];k[i]=new Ab(ee&&ee.currentValue,l,B===$u),nL(s,c,v,l)}var rL="__ngSimpleChanges__";function oL(s){return s[rL]||null}function TU(s,c){return s[rL]=c}var wO=[];var ir=function(s,c=null,l){for(let f=0;f<wO.length;f++){let v=wO[f];v(s,c,l)}};function IU(s,c,l){let{ngOnChanges:f,ngOnInit:v,ngDoCheck:i}=c.type.prototype;if(f){let C=iL(c);(l.preOrderHooks??=[]).push(s,C),(l.preOrderCheckHooks??=[]).push(s,C)}v&&(l.preOrderHooks??=[]).push(0-s,v),i&&((l.preOrderHooks??=[]).push(s,i),(l.preOrderCheckHooks??=[]).push(s,i))}function SU(s,c){for(let l=c.directiveStart,f=c.directiveEnd;l<f;l++){let i=s.data[l].type.prototype,{ngAfterContentInit:C,ngAfterContentChecked:k,ngAfterViewInit:B,ngAfterViewChecked:ee,ngOnDestroy:_e}=i;C&&(s.contentHooks??=[]).push(-l,C),k&&((s.contentHooks??=[]).push(l,k),(s.contentCheckHooks??=[]).push(l,k)),B&&(s.viewHooks??=[]).push(-l,B),ee&&((s.viewHooks??=[]).push(l,ee),(s.viewCheckHooks??=[]).push(l,ee)),_e!=null&&(s.destroyHooks??=[]).push(l,_e)}}function Sb(s,c,l){sL(s,c,3,l)}function Db(s,c,l,f){(s[Qn]&3)===l&&sL(s,c,l,f)}function tS(s,c){let l=s[Qn];(l&3)===c&&(l&=16383,l+=1,s[Qn]=l)}function sL(s,c,l,f){let v=f!==void 0?s[Oh]&65535:0,i=f??-1,C=c.length-1,k=0;for(let B=v;B<C;B++)if(typeof c[B+1]=="number"){if(k=c[B],f!=null&&k>=f)break}else c[B]<0&&(s[Oh]+=65536),(k<i||i==-1)&&(DU(s,l,c,B),s[Oh]=(s[Oh]&4294901760)+B+2),B++}function EO(s,c){ir(4,s,c);let l=Xn(null);try{c.call(s)}finally{Xn(l),ir(5,s,c)}}function DU(s,c,l,f){let v=l[f]<0,i=l[f+1],C=v?-l[f]:l[f],k=s[C];v?s[Qn]>>14<s[Oh]>>16&&(s[Qn]&3)===c&&(s[Qn]+=16384,EO(k,i)):EO(k,i)}var lm=-1,Bh=class{factory;name;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(c,l,f,v){this.factory=c,this.name=v,this.canSeeViewProviders=l,this.injectImpl=f}};function CU(s){return(s.flags&8)!==0}function AU(s){return(s.flags&16)!==0}function MU(s,c,l){let f=0;for(;f<l.length;){let v=l[f];if(typeof v=="number"){if(v!==0)break;f++;let i=l[f++],C=l[f++],k=l[f++];s.setAttribute(c,C,k,i)}else{let i=v,C=l[++f];RU(i)?s.setProperty(c,i,C):s.setAttribute(c,i,C),f++}}return f}function aL(s){return s===3||s===4||s===6}function RU(s){return s.charCodeAt(0)===64}function cm(s,c){if(!(c===null||c.length===0))if(s===null||s.length===0)s=c.slice();else{let l=-1;for(let f=0;f<c.length;f++){let v=c[f];typeof v=="number"?l=v:l===0||(l===-1||l===2?TO(s,l,v,null,c[++f]):TO(s,l,v,null,null))}}return s}function TO(s,c,l,f,v){let i=0,C=s.length;if(c===-1)C=-1;else for(;i<s.length;){let k=s[i++];if(typeof k=="number"){if(k===c){C=-1;break}else if(k>c){C=i-1;break}}}for(;i<s.length;){let k=s[i];if(typeof k=="number")break;if(k===l){v!==null&&(s[i+1]=v);return}i++,v!==null&&i++}C!==-1&&(s.splice(C,0,c),i=C+1),s.splice(i++,0,l),v!==null&&s.splice(i++,0,v)}function lL(s){return s!==lm}function Mb(s){return s&32767}function PU(s){return s>>16}function Rb(s,c){let l=PU(s),f=c;for(;l>0;)f=f[Rh],l--;return f}var hS=!0;function IO(s){let c=hS;return hS=s,c}var OU=256,cL=OU-1,uL=5,LU=0,Nl={};function FU(s,c,l){let f;typeof l=="string"?f=l.charCodeAt(0)||0:l.hasOwnProperty(Ah)&&(f=l[Ah]),f==null&&(f=l[Ah]=LU++);let v=f&cL,i=1<<v;c.data[s+(v>>uL)]|=i}function Pb(s,c){let l=dL(s,c);if(l!==-1)return l;let f=c[Gn];f.firstCreatePass&&(s.injectorIndex=c.length,nS(f.data,s),nS(c,null),nS(f.blueprint,null));let v=GS(s,c),i=s.injectorIndex;if(lL(v)){let C=Mb(v),k=Rb(v,c),B=k[Gn].data;for(let ee=0;ee<8;ee++)c[i+ee]=k[C+ee]|B[C+ee]}return c[i+8]=v,i}function nS(s,c){s.push(0,0,0,0,0,0,0,0,c)}function dL(s,c){return s.injectorIndex===-1||s.parent&&s.parent.injectorIndex===s.injectorIndex||c[s.injectorIndex+8]===null?-1:s.injectorIndex}function GS(s,c){if(s.parent&&s.parent.injectorIndex!==-1)return s.parent.injectorIndex;let l=0,f=null,v=c;for(;v!==null;){if(f=gL(v),f===null)return lm;if(l++,v=v[Rh],f.injectorIndex!==-1)return f.injectorIndex|l<<16}return lm}function fS(s,c,l){FU(s,c,l)}function kU(s,c){if(c==="class")return s.classes;if(c==="style")return s.styles;let l=s.attrs;if(l){let f=l.length,v=0;for(;v<f;){let i=l[v];if(aL(i))break;if(i===0)v=v+2;else if(typeof i=="number")for(v++;v<f&&typeof l[v]=="string";)v++;else{if(i===c)return l[v+1];v=v+2}}}return null}function hL(s,c,l){if(l&8||s!==void 0)return s;sb(c,"NodeInjector")}function fL(s,c,l,f){if(l&8&&f===void 0&&(f=null),(l&3)===0){let v=s[Gu],i=Qs(void 0);try{return v?v.get(c,f,l&8):xI(c,f,l&8)}finally{Qs(i)}}return hL(f,c,l)}function pL(s,c,l,f=0,v){if(s!==null){if(c[Qn]&2048&&!(f&2)){let C=jU(s,c,l,f,Nl);if(C!==Nl)return C}let i=mL(s,c,l,f,Nl);if(i!==Nl)return i}return fL(c,l,f,v)}function mL(s,c,l,f,v){let i=BU(l);if(typeof i=="function"){if(!ZI(c,s,f))return f&1?hL(v,l,f):fL(c,l,f,v);try{let C;if(C=i(f),C==null&&!(f&8))sb(l);else return C}finally{XI()}}else if(typeof i=="number"){let C=null,k=dL(s,c),B=lm,ee=f&1?c[hs][ds]:null;for((k===-1||f&4)&&(B=k===-1?GS(s,c):c[k+8],B===lm||!DO(f,!1)?k=-1:(C=c[Gn],k=Mb(B),c=Rb(B,c)));k!==-1;){let _e=c[Gn];if(SO(i,k,_e.data)){let Oe=NU(k,c,l,C,f,ee);if(Oe!==Nl)return Oe}B=c[k+8],B!==lm&&DO(f,c[Gn].data[k+8]===ee)&&SO(i,k,c)?(C=_e,k=Mb(B),c=Rb(B,c)):k=-1}}return v}function NU(s,c,l,f,v,i){let C=c[Gn],k=C.data[s+8],B=f==null?Wu(k)&&hS:f!=C&&(k.type&3)!==0,ee=v&1&&i===k,_e=zU(k,C,l,B,ee);return _e!==null?Ob(c,C,_e,k,v):Nl}function zU(s,c,l,f,v){let i=s.providerIndexes,C=c.data,k=i&1048575,B=s.directiveStart,ee=s.directiveEnd,_e=i>>20,Oe=f?k:k+_e,ct=v?k+_e:ee;for(let Fe=Oe;Fe<ct;Fe++){let yt=C[Fe];if(Fe<B&&l===yt||Fe>=B&&yt.type===l)return Fe}if(v){let Fe=C[B];if(Fe&&Ol(Fe)&&Fe.type===l)return B}return null}function Ob(s,c,l,f,v){let i=s[l],C=c.data;if(i instanceof Bh){let k=i;if(k.resolving){let Fe=N2(C[l]);throw vI(Fe)}let B=IO(k.canSeeViewProviders);k.resolving=!0;let ee=C[l].type||C[l],_e,Oe=k.injectImpl?Qs(k.injectImpl):null,ct=ZI(s,f,0);try{i=s[l]=k.factory(void 0,v,C,s,f),c.firstCreatePass&&l>=f.directiveStart&&IU(l,C[l],c)}finally{Oe!==null&&Qs(Oe),IO(B),k.resolving=!1,XI()}}return i}function BU(s){if(typeof s=="string")return s.charCodeAt(0)||0;let c=s.hasOwnProperty(Ah)?s[Ah]:void 0;return typeof c=="number"?c>=0?c&cL:VU:c}function SO(s,c,l){let f=1<<s;return!!(l[c+(s>>uL)]&f)}function DO(s,c){return!(s&2)&&!(s&1&&c)}var zh=class{_tNode;_lView;constructor(c,l){this._tNode=c,this._lView=l}get(c,l,f){return pL(this._tNode,this._lView,c,Th(f),l)}};function VU(){return new zh(fs(),Si())}function mm(s){return Ty(()=>{let c=s.prototype.constructor,l=c[ry]||pS(c),f=Object.prototype,v=Object.getPrototypeOf(s.prototype).constructor;for(;v&&v!==f;){let i=v[ry]||pS(v);if(i&&i!==l)return i;v=Object.getPrototypeOf(v)}return i=>new i})}function pS(s){return hI(s)?()=>{let c=pS(Ao(s));return c&&c()}:Ih(s)}function jU(s,c,l,f,v){let i=s,C=c;for(;i!==null&&C!==null&&C[Qn]&2048&&!im(C);){let k=mL(i,C,l,f|2,Nl);if(k!==Nl)return k;let B=i.parent;if(!B){let ee=C[MI];if(ee){let _e=ee.get(l,Nl,f);if(_e!==Nl)return _e}B=gL(C),C=C[Rh]}i=B}return v}function gL(s){let c=s[Gn],l=c.type;return l===2?c.declTNode:l===1?s[ds]:null}function Iy(s){return kU(fs(),s)}function UU(){return qS(fs(),Si())}function qS(s,c){return new wa(Qa(s,c))}var wa=(()=>{class s{nativeElement;constructor(l){this.nativeElement=l}static __NG_ELEMENT_ID__=UU}return s})();function _L(s){return(s.flags&128)===128}var WS=(function(s){return s[s.OnPush=0]="OnPush",s[s.Default=1]="Default",s})(WS||{}),yL=new Map,HU=0;function $U(){return HU++}function GU(s){yL.set(s[uy],s)}function mS(s){yL.delete(s[uy])}var CO="__ngContext__";function um(s,c){Pl(c)?(s[CO]=c[uy],GU(c)):s[CO]=c}function vL(s){return bL(s[nm])}function xL(s){return bL(s[ya])}function bL(s){for(;s!==null&&!Ja(s);)s=s[ya];return s}var gS;function ZS(s){gS=s}function wL(){if(gS!==void 0)return gS;if(typeof document<"u")return document;throw new tn(210,!1)}var Zb=new Kt("",{providedIn:"root",factory:()=>qU}),qU="ng",Xb=new Kt(""),Yu=new Kt("",{providedIn:"platform",factory:()=>"unknown"});var gm=new Kt("",{providedIn:"root",factory:()=>wL().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var WU="h",ZU="b";var EL="r";var TL="di";var IL=!1,SL=new Kt("",{providedIn:"root",factory:()=>IL});var Yb=new Kt("");var XU=(s,c,l,f)=>{};function YU(s,c,l,f){XU(s,c,l,f)}function Kb(s){return(s.flags&32)===32}var KU=()=>null;function DL(s,c,l=!1){return KU(s,c,l)}function CL(s,c){let l=s.contentQueries;if(l!==null){let f=Xn(null);try{for(let v=0;v<l.length;v+=2){let i=l[v],C=l[v+1];if(C!==-1){let k=s.data[C];WI(i),k.contentQueries(2,c[C],C)}}}finally{Xn(f)}}}function _S(s,c,l){WI(0);let f=Xn(null);try{c(s,l)}finally{Xn(f)}}function AL(s,c,l){if(PI(c)){let f=Xn(null);try{let v=c.directiveStart,i=c.directiveEnd;for(let C=v;C<i;C++){let k=s.data[C];if(k.contentQueries){let B=l[C];k.contentQueries(1,B,C)}}}finally{Xn(f)}}}var Mc=(function(s){return s[s.Emulated=0]="Emulated",s[s.None=2]="None",s[s.ShadowDom=3]="ShadowDom",s})(Mc||{}),wb;function JU(){if(wb===void 0&&(wb=null,Hu.trustedTypes))try{wb=Hu.trustedTypes.createPolicy("angular",{createHTML:s=>s,createScript:s=>s,createScriptURL:s=>s})}catch{}return wb}function Jb(s){return JU()?.createHTML(s)||s}var Eb;function QU(){if(Eb===void 0&&(Eb=null,Hu.trustedTypes))try{Eb=Hu.trustedTypes.createPolicy("angular#unsafe-bypass",{createHTML:s=>s,createScript:s=>s,createScriptURL:s=>s})}catch{}return Eb}function AO(s){return QU()?.createScriptURL(s)||s}var Rc=class{changingThisBreaksApplicationSecurity;constructor(c){this.changingThisBreaksApplicationSecurity=c}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${ib})`}},yS=class extends Rc{getTypeName(){return"HTML"}},vS=class extends Rc{getTypeName(){return"Style"}},xS=class extends Rc{getTypeName(){return"Script"}},bS=class extends Rc{getTypeName(){return"URL"}},wS=class extends Rc{getTypeName(){return"ResourceURL"}};function Ea(s){return s instanceof Rc?s.changingThisBreaksApplicationSecurity:s}function Lc(s,c){let l=ML(s);if(l!=null&&l!==c){if(l==="ResourceURL"&&c==="URL")return!0;throw new Error(`Required a safe ${c}, got a ${l} (see ${ib})`)}return l===c}function ML(s){return s instanceof Rc&&s.getTypeName()||null}function XS(s){return new yS(s)}function YS(s){return new vS(s)}function KS(s){return new xS(s)}function JS(s){return new bS(s)}function QS(s){return new wS(s)}function e4(s){let c=new TS(s);return t4()?new ES(c):c}var ES=class{inertDocumentHelper;constructor(c){this.inertDocumentHelper=c}getInertBodyElement(c){c="<body><remove></remove>"+c;try{let l=new window.DOMParser().parseFromString(Jb(c),"text/html").body;return l===null?this.inertDocumentHelper.getInertBodyElement(c):(l.firstChild?.remove(),l)}catch{return null}}},TS=class{defaultDoc;inertDocument;constructor(c){this.defaultDoc=c,this.inertDocument=this.defaultDoc.implementation.createHTMLDocument("sanitization-inert")}getInertBodyElement(c){let l=this.inertDocument.createElement("template");return l.innerHTML=Jb(c),l}};function t4(){try{return!!new window.DOMParser().parseFromString(Jb(""),"text/html")}catch{return!1}}var n4=/^(?!javascript:)(?:[a-z0-9+.-]+:|[^&:\/?#]*(?:[\/?#]|$))/i;function Sy(s){return s=String(s),s.match(n4)?s:"unsafe:"+s}function Fc(s){let c={};for(let l of s.split(","))c[l]=!0;return c}function Dy(...s){let c={};for(let l of s)for(let f in l)l.hasOwnProperty(f)&&(c[f]=!0);return c}var RL=Fc("area,br,col,hr,img,wbr"),PL=Fc("colgroup,dd,dt,li,p,tbody,td,tfoot,th,thead,tr"),OL=Fc("rp,rt"),i4=Dy(OL,PL),r4=Dy(PL,Fc("address,article,aside,blockquote,caption,center,del,details,dialog,dir,div,dl,figure,figcaption,footer,h1,h2,h3,h4,h5,h6,header,hgroup,hr,ins,main,map,menu,nav,ol,pre,section,summary,table,ul")),o4=Dy(OL,Fc("a,abbr,acronym,audio,b,bdi,bdo,big,br,cite,code,del,dfn,em,font,i,img,ins,kbd,label,map,mark,picture,q,ruby,rp,rt,s,samp,small,source,span,strike,strong,sub,sup,time,track,tt,u,var,video")),MO=Dy(RL,r4,o4,i4),LL=Fc("background,cite,href,itemtype,longdesc,poster,src,xlink:href"),s4=Fc("abbr,accesskey,align,alt,autoplay,axis,bgcolor,border,cellpadding,cellspacing,class,clear,color,cols,colspan,compact,controls,coords,datetime,default,dir,download,face,headers,height,hidden,hreflang,hspace,ismap,itemscope,itemprop,kind,label,lang,language,loop,media,muted,nohref,nowrap,open,preload,rel,rev,role,rows,rowspan,rules,scope,scrolling,shape,size,sizes,span,srclang,srcset,start,summary,tabindex,target,title,translate,type,usemap,valign,value,vspace,width"),a4=Fc("aria-activedescendant,aria-atomic,aria-autocomplete,aria-busy,aria-checked,aria-colcount,aria-colindex,aria-colspan,aria-controls,aria-current,aria-describedby,aria-details,aria-disabled,aria-dropeffect,aria-errormessage,aria-expanded,aria-flowto,aria-grabbed,aria-haspopup,aria-hidden,aria-invalid,aria-keyshortcuts,aria-label,aria-labelledby,aria-level,aria-live,aria-modal,aria-multiline,aria-multiselectable,aria-orientation,aria-owns,aria-placeholder,aria-posinset,aria-pressed,aria-readonly,aria-relevant,aria-required,aria-roledescription,aria-rowcount,aria-rowindex,aria-rowspan,aria-selected,aria-setsize,aria-sort,aria-valuemax,aria-valuemin,aria-valuenow,aria-valuetext"),l4=Dy(LL,s4,a4),c4=Fc("script,style,template"),IS=class{sanitizedSomething=!1;buf=[];sanitizeChildren(c){let l=c.firstChild,f=!0,v=[];for(;l;){if(l.nodeType===Node.ELEMENT_NODE?f=this.startElement(l):l.nodeType===Node.TEXT_NODE?this.chars(l.nodeValue):this.sanitizedSomething=!0,f&&l.firstChild){v.push(l),l=h4(l);continue}for(;l;){l.nodeType===Node.ELEMENT_NODE&&this.endElement(l);let i=d4(l);if(i){l=i;break}l=v.pop()}}return this.buf.join("")}startElement(c){let l=RO(c).toLowerCase();if(!MO.hasOwnProperty(l))return this.sanitizedSomething=!0,!c4.hasOwnProperty(l);this.buf.push("<"),this.buf.push(l);let f=c.attributes;for(let v=0;v<f.length;v++){let i=f.item(v),C=i.name,k=C.toLowerCase();if(!l4.hasOwnProperty(k)){this.sanitizedSomething=!0;continue}let B=i.value;LL[k]&&(B=Sy(B)),this.buf.push(" ",C,'="',PO(B),'"')}return this.buf.push(">"),!0}endElement(c){let l=RO(c).toLowerCase();MO.hasOwnProperty(l)&&!RL.hasOwnProperty(l)&&(this.buf.push("</"),this.buf.push(l),this.buf.push(">"))}chars(c){this.buf.push(PO(c))}};function u4(s,c){return(s.compareDocumentPosition(c)&Node.DOCUMENT_POSITION_CONTAINED_BY)!==Node.DOCUMENT_POSITION_CONTAINED_BY}function d4(s){let c=s.nextSibling;if(c&&s!==c.previousSibling)throw FL(c);return c}function h4(s){let c=s.firstChild;if(c&&u4(s,c))throw FL(c);return c}function RO(s){let c=s.nodeName;return typeof c=="string"?c:"FORM"}function FL(s){return new Error(`Failed to sanitize html because the element is clobbered: ${s.outerHTML}`)}var f4=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,p4=/([^\#-~ |!])/g;function PO(s){return s.replace(/&/g,"&amp;").replace(f4,function(c){let l=c.charCodeAt(0),f=c.charCodeAt(1);return"&#"+((l-55296)*1024+(f-56320)+65536)+";"}).replace(p4,function(c){return"&#"+c.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}var Tb;function eD(s,c){let l=null;try{Tb=Tb||e4(s);let f=c?String(c):"";l=Tb.getInertBodyElement(f);let v=5,i=f;do{if(v===0)throw new Error("Failed to sanitize html because the input is unstable");v--,f=i,i=l.innerHTML,l=Tb.getInertBodyElement(f)}while(f!==i);let k=new IS().sanitizeChildren(OO(l)||l);return Jb(k)}finally{if(l){let f=OO(l)||l;for(;f.firstChild;)f.firstChild.remove()}}}function OO(s){return"content"in s&&m4(s)?s.content:null}function m4(s){return s.nodeType===Node.ELEMENT_NODE&&s.nodeName==="TEMPLATE"}var Mo=(function(s){return s[s.NONE=0]="NONE",s[s.HTML=1]="HTML",s[s.STYLE=2]="STYLE",s[s.SCRIPT=3]="SCRIPT",s[s.URL=4]="URL",s[s.RESOURCE_URL=5]="RESOURCE_URL",s})(Mo||{});function Qb(s){let c=NL();return c?c.sanitize(Mo.URL,s)||"":Lc(s,"URL")?Ea(s):Sy(Qp(s))}function kL(s){let c=NL();if(c)return AO(c.sanitize(Mo.RESOURCE_URL,s)||"");if(Lc(s,"ResourceURL"))return AO(Ea(s));throw new tn(904,!1)}function g4(s,c){return c==="src"&&(s==="embed"||s==="frame"||s==="iframe"||s==="media"||s==="script")||c==="href"&&(s==="base"||s==="link")?kL:Qb}function tD(s,c,l){return g4(c,l)(s)}function NL(){let s=Si();return s&&s[Rl].sanitizer}function zL(s){return s instanceof Function?s():s}function _4(s,c,l){let f=s.length;for(;;){let v=s.indexOf(c,l);if(v===-1)return v;if(v===0||s.charCodeAt(v-1)<=32){let i=c.length;if(v+i===f||s.charCodeAt(v+i)<=32)return v}l=v+1}}var BL="ng-template";function y4(s,c,l,f){let v=0;if(f){for(;v<c.length&&typeof c[v]=="string";v+=2)if(c[v]==="class"&&_4(c[v+1].toLowerCase(),l,0)!==-1)return!0}else if(nD(s))return!1;if(v=c.indexOf(1,v),v>-1){let i;for(;++v<c.length&&typeof(i=c[v])=="string";)if(i.toLowerCase()===l)return!0}return!1}function nD(s){return s.type===4&&s.value!==BL}function v4(s,c,l){let f=s.type===4&&!l?BL:s.value;return c===f}function x4(s,c,l){let f=4,v=s.attrs,i=v!==null?E4(v):0,C=!1;for(let k=0;k<c.length;k++){let B=c[k];if(typeof B=="number"){if(!C&&!el(f)&&!el(B))return!1;if(C&&el(B))continue;C=!1,f=B|f&1;continue}if(!C)if(f&4){if(f=2|f&1,B!==""&&!v4(s,B,l)||B===""&&c.length===1){if(el(f))return!1;C=!0}}else if(f&8){if(v===null||!y4(s,v,B,l)){if(el(f))return!1;C=!0}}else{let ee=c[++k],_e=b4(B,v,nD(s),l);if(_e===-1){if(el(f))return!1;C=!0;continue}if(ee!==""){let Oe;if(_e>i?Oe="":Oe=v[_e+1].toLowerCase(),f&2&&ee!==Oe){if(el(f))return!1;C=!0}}}}return el(f)||C}function el(s){return(s&1)===0}function b4(s,c,l,f){if(c===null)return-1;let v=0;if(f||!l){let i=!1;for(;v<c.length;){let C=c[v];if(C===s)return v;if(C===3||C===6)i=!0;else if(C===1||C===2){let k=c[++v];for(;typeof k=="string";)k=c[++v];continue}else{if(C===4)break;if(C===0){v+=4;continue}}v+=i?1:2}return-1}else return T4(c,s)}function VL(s,c,l=!1){for(let f=0;f<c.length;f++)if(x4(s,c[f],l))return!0;return!1}function w4(s){let c=s.attrs;if(c!=null){let l=c.indexOf(5);if((l&1)===0)return c[l+1]}return null}function E4(s){for(let c=0;c<s.length;c++){let l=s[c];if(aL(l))return c}return s.length}function T4(s,c){let l=s.indexOf(4);if(l>-1)for(l++;l<s.length;){let f=s[l];if(typeof f=="number")return-1;if(f===c)return l;l++}return-1}function I4(s,c){e:for(let l=0;l<c.length;l++){let f=c[l];if(s.length===f.length){for(let v=0;v<s.length;v++)if(s[v]!==f[v])continue e;return!0}}return!1}function LO(s,c){return s?":not("+c.trim()+")":c}function S4(s){let c=s[0],l=1,f=2,v="",i=!1;for(;l<s.length;){let C=s[l];if(typeof C=="string")if(f&2){let k=s[++l];v+="["+C+(k.length>0?'="'+k+'"':"")+"]"}else f&8?v+="."+C:f&4&&(v+=" "+C);else v!==""&&!el(C)&&(c+=LO(i,v),v=""),f=C,i=i||!el(f);l++}return v!==""&&(c+=LO(i,v)),c}function D4(s){return s.map(S4).join(",")}function C4(s){let c=[],l=[],f=1,v=2;for(;f<s.length;){let i=s[f];if(typeof i=="string")v===2?i!==""&&c.push(i,s[++f]):v===8&&l.push(i);else{if(!el(v))break;v=i}f++}return l.length&&c.push(1,...l),c}var ta={};function A4(s,c){return s.createText(c)}function M4(s,c,l){s.setValue(c,l)}function jL(s,c,l){return s.createElement(c,l)}function Lb(s,c,l,f,v){s.insertBefore(c,l,f,v)}function UL(s,c,l){s.appendChild(c,l)}function FO(s,c,l,f,v){f!==null?Lb(s,c,l,f,v):UL(s,c,l)}function HL(s,c,l,f){s.removeChild(null,c,l,f)}function R4(s,c,l){s.setAttribute(c,"style",l)}function P4(s,c,l){l===""?s.removeAttribute(c,"class"):s.setAttribute(c,"class",l)}function $L(s,c,l){let{mergedAttrs:f,classes:v,styles:i}=l;f!==null&&MU(s,c,f),v!==null&&P4(s,c,v),i!==null&&R4(s,c,i)}function iD(s,c,l,f,v,i,C,k,B,ee,_e){let Oe=ro+f,ct=Oe+v,Fe=O4(Oe,ct),yt=typeof ee=="function"?ee():ee;return Fe[Gn]={type:s,blueprint:Fe,template:l,queries:null,viewQuery:k,declTNode:c,data:Fe.slice().fill(null,Oe),bindingStartIndex:Oe,expandoStartIndex:ct,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof i=="function"?i():i,pipeRegistry:typeof C=="function"?C():C,firstChild:null,schemas:B,consts:yt,incompleteFirstPass:!1,ssrId:_e}}function O4(s,c){let l=[];for(let f=0;f<c;f++)l.push(f<s?null:ta);return l}function L4(s){let c=s.tView;return c===null||c.incompleteFirstPass?s.tView=iD(1,null,s.template,s.decls,s.vars,s.directiveDefs,s.pipeDefs,s.viewQuery,s.schemas,s.consts,s.id):c}function rD(s,c,l,f,v,i,C,k,B,ee,_e){let Oe=c.blueprint.slice();return Oe[Ka]=v,Oe[Qn]=f|4|128|8|64|1024,(ee!==null||s&&s[Qn]&2048)&&(Oe[Qn]|=2048),LI(Oe),Oe[_o]=Oe[Rh]=s,Oe[qr]=l,Oe[Rl]=C||s&&s[Rl],Oe[Ir]=k||s&&s[Ir],Oe[Gu]=B||s&&s[Gu]||null,Oe[ds]=i,Oe[uy]=$U(),Oe[Mh]=_e,Oe[MI]=ee,Oe[hs]=c.type==2?s[hs]:Oe,Oe}function F4(s,c,l){let f=Qa(c,s),v=L4(l),i=s[Rl].rendererFactory,C=oD(s,rD(s,v,null,GL(l),f,c,null,i.createRenderer(f,l),null,null,null));return s[c.index]=C}function GL(s){let c=16;return s.signals?c=4096:s.onPush&&(c=64),c}function qL(s,c,l,f){if(l===0)return-1;let v=c.length;for(let i=0;i<l;i++)c.push(f),s.blueprint.push(f),s.data.push(null);return v}function oD(s,c){return s[nm]?s[AI][ya]=c:s[nm]=c,s[AI]=c,c}function ei(s=1){WL(Ho(),Si(),Ac()+s,!1)}function WL(s,c,l,f){if(!f)if((c[Qn]&3)===3){let i=s.preOrderCheckHooks;i!==null&&Sb(c,i,l)}else{let i=s.preOrderHooks;i!==null&&Db(c,i,0,l)}Xu(l)}var ew=(function(s){return s[s.None=0]="None",s[s.SignalBased=1]="SignalBased",s[s.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",s})(ew||{});function SS(s,c,l,f){let v=Xn(null);try{let[i,C,k]=s.inputs[l],B=null;(C&ew.SignalBased)!==0&&(B=c[i][cs]),B!==null&&B.transformFn!==void 0?f=B.transformFn(f):k!==null&&(f=k.call(c,f)),s.setInput!==null?s.setInput(c,B,f,l,i):nL(c,B,i,f)}finally{Xn(v)}}var Pc=(function(s){return s[s.Important=1]="Important",s[s.DashCase=2]="DashCase",s})(Pc||{}),k4;function sD(s,c){return k4(s,c)}var dm=new Set,tw=(function(s){return s[s.CHANGE_DETECTION=0]="CHANGE_DETECTION",s[s.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",s})(tw||{}),$h=new Kt(""),kO=new Set;function nl(s){kO.has(s)||(kO.add(s),performance?.mark?.("mark_feature_usage",{detail:{feature:s}}))}var ZL=!1,DS=class extends Er{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(c=!1){super(),this.__isAsync=c,X2()&&(this.destroyRef=pt(Fl,{optional:!0})??void 0,this.pendingTasks=pt(kl,{optional:!0})??void 0)}emit(c){let l=Xn(null);try{super.next(c)}finally{Xn(l)}}subscribe(c,l,f){let v=c,i=l||(()=>null),C=f;if(c&&typeof c=="object"){let B=c;v=B.next?.bind(B),i=B.error?.bind(B),C=B.complete?.bind(B)}this.__isAsync&&(i=this.wrapInTimeout(i),v&&(v=this.wrapInTimeout(v)),C&&(C=this.wrapInTimeout(C)));let k=super.subscribe({next:v,error:i,complete:C});return c instanceof wr&&c.add(k),k}wrapInTimeout(c){return l=>{let f=this.pendingTasks?.add();setTimeout(()=>{try{c(l)}finally{f!==void 0&&this.pendingTasks?.remove(f)}})}}},qi=DS;function XL(s){let c,l;function f(){s=gy;try{l!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(l),c!==void 0&&clearTimeout(c)}catch{}}return c=setTimeout(()=>{s(),f()}),typeof requestAnimationFrame=="function"&&(l=requestAnimationFrame(()=>{s(),f()})),()=>f()}function NO(s){return queueMicrotask(()=>s()),()=>{s=gy}}var aD="isAngularZone",Fb=aD+"_ID",N4=0,pr=class s{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new qi(!1);onMicrotaskEmpty=new qi(!1);onStable=new qi(!1);onError=new qi(!1);constructor(c){let{enableLongStackTrace:l=!1,shouldCoalesceEventChangeDetection:f=!1,shouldCoalesceRunChangeDetection:v=!1,scheduleInRootZone:i=ZL}=c;if(typeof Zone>"u")throw new tn(908,!1);Zone.assertZonePatched();let C=this;C._nesting=0,C._outer=C._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(C._inner=C._inner.fork(new Zone.TaskTrackingZoneSpec)),l&&Zone.longStackTraceZoneSpec&&(C._inner=C._inner.fork(Zone.longStackTraceZoneSpec)),C.shouldCoalesceEventChangeDetection=!v&&f,C.shouldCoalesceRunChangeDetection=v,C.callbackScheduled=!1,C.scheduleInRootZone=i,V4(C)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(aD)===!0}static assertInAngularZone(){if(!s.isInAngularZone())throw new tn(909,!1)}static assertNotInAngularZone(){if(s.isInAngularZone())throw new tn(909,!1)}run(c,l,f){return this._inner.run(c,l,f)}runTask(c,l,f,v){let i=this._inner,C=i.scheduleEventTask("NgZoneEvent: "+v,c,z4,gy,gy);try{return i.runTask(C,l,f)}finally{i.cancelTask(C)}}runGuarded(c,l,f){return this._inner.runGuarded(c,l,f)}runOutsideAngular(c){return this._outer.run(c)}},z4={};function lD(s){if(s._nesting==0&&!s.hasPendingMicrotasks&&!s.isStable)try{s._nesting++,s.onMicrotaskEmpty.emit(null)}finally{if(s._nesting--,!s.hasPendingMicrotasks)try{s.runOutsideAngular(()=>s.onStable.emit(null))}finally{s.isStable=!0}}}function B4(s){if(s.isCheckStableRunning||s.callbackScheduled)return;s.callbackScheduled=!0;function c(){XL(()=>{s.callbackScheduled=!1,CS(s),s.isCheckStableRunning=!0,lD(s),s.isCheckStableRunning=!1})}s.scheduleInRootZone?Zone.root.run(()=>{c()}):s._outer.run(()=>{c()}),CS(s)}function V4(s){let c=()=>{B4(s)},l=N4++;s._inner=s._inner.fork({name:"angular",properties:{[aD]:!0,[Fb]:l,[Fb+l]:!0},onInvokeTask:(f,v,i,C,k,B)=>{if(j4(B))return f.invokeTask(i,C,k,B);try{return zO(s),f.invokeTask(i,C,k,B)}finally{(s.shouldCoalesceEventChangeDetection&&C.type==="eventTask"||s.shouldCoalesceRunChangeDetection)&&c(),BO(s)}},onInvoke:(f,v,i,C,k,B,ee)=>{try{return zO(s),f.invoke(i,C,k,B,ee)}finally{s.shouldCoalesceRunChangeDetection&&!s.callbackScheduled&&!U4(B)&&c(),BO(s)}},onHasTask:(f,v,i,C)=>{f.hasTask(i,C),v===i&&(C.change=="microTask"?(s._hasPendingMicrotasks=C.microTask,CS(s),lD(s)):C.change=="macroTask"&&(s.hasPendingMacrotasks=C.macroTask))},onHandleError:(f,v,i,C)=>(f.handleError(i,C),s.runOutsideAngular(()=>s.onError.emit(C)),!1)})}function CS(s){s._hasPendingMicrotasks||(s.shouldCoalesceEventChangeDetection||s.shouldCoalesceRunChangeDetection)&&s.callbackScheduled===!0?s.hasPendingMicrotasks=!0:s.hasPendingMicrotasks=!1}function zO(s){s._nesting++,s.isStable&&(s.isStable=!1,s.onUnstable.emit(null))}function BO(s){s._nesting--,lD(s)}var kb=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new qi;onMicrotaskEmpty=new qi;onStable=new qi;onError=new qi;run(c,l,f){return c.apply(l,f)}runGuarded(c,l,f){return c.apply(l,f)}runOutsideAngular(c){return c()}runTask(c,l,f,v){return c.apply(l,f)}};function j4(s){return YL(s,"__ignore_ng_zone__")}function U4(s){return YL(s,"__scheduler_tick__")}function YL(s,c){return!Array.isArray(s)||s.length!==1?!1:s[0]?.data?.[c]===!0}var cD=(()=>{class s{impl=null;execute(){this.impl?.execute()}static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>new s})}return s})(),KL=[0,1,2,3],JL=(()=>{class s{ngZone=pt(pr);scheduler=pt(Sc);errorHandler=pt(Uo,{optional:!0});sequences=new Set;deferredRegistrations=new Set;executing=!1;constructor(){pt($h,{optional:!0})}execute(){let l=this.sequences.size>0;l&&ir(16),this.executing=!0;for(let f of KL)for(let v of this.sequences)if(!(v.erroredOrDestroyed||!v.hooks[f]))try{v.pipelinedValue=this.ngZone.runOutsideAngular(()=>this.maybeTrace(()=>{let i=v.hooks[f];return i(v.pipelinedValue)},v.snapshot))}catch(i){v.erroredOrDestroyed=!0,this.errorHandler?.handleError(i)}this.executing=!1;for(let f of this.sequences)f.afterRun(),f.once&&(this.sequences.delete(f),f.destroy());for(let f of this.deferredRegistrations)this.sequences.add(f);this.deferredRegistrations.size>0&&this.scheduler.notify(7),this.deferredRegistrations.clear(),l&&ir(17)}register(l){let{view:f}=l;f!==void 0?((f[Fh]??=[]).push(l),rm(f),f[Qn]|=8192):this.executing?this.deferredRegistrations.add(l):this.addSequence(l)}addSequence(l){this.sequences.add(l),this.scheduler.notify(7)}unregister(l){this.executing&&this.sequences.has(l)?(l.erroredOrDestroyed=!0,l.pipelinedValue=void 0,l.once=!0):(this.sequences.delete(l),this.deferredRegistrations.delete(l))}maybeTrace(l,f){return f?f.run(tw.AFTER_NEXT_RENDER,l):l()}static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>new s})}return s})(),Nb=class{impl;hooks;view;once;snapshot;erroredOrDestroyed=!1;pipelinedValue=void 0;unregisterOnDestroy;constructor(c,l,f,v,i,C=null){this.impl=c,this.hooks=l,this.view=f,this.once=v,this.snapshot=C,this.unregisterOnDestroy=i?.onDestroy(()=>this.destroy())}afterRun(){this.erroredOrDestroyed=!1,this.pipelinedValue=void 0,this.snapshot?.dispose(),this.snapshot=null}destroy(){this.impl.unregister(this),this.unregisterOnDestroy?.();let c=this.view?.[Fh];c&&(this.view[Fh]=c.filter(l=>l!==this))}};function Cy(s,c){let l=c?.injector??pt(jo);return nl("NgAfterNextRender"),$4(s,l,c,!0)}function H4(s){return s instanceof Function?[void 0,void 0,s,void 0]:[s.earlyRead,s.write,s.mixedReadWrite,s.read]}function $4(s,c,l,f){let v=c.get(cD);v.impl??=c.get(JL);let i=c.get($h,null,{optional:!0}),C=l?.manualCleanup!==!0?c.get(Fl):null,k=c.get(xb,null,{optional:!0}),B=new Nb(v.impl,H4(s),k?.view,f,C,i?.snapshot(null));return v.impl.register(B),B}var G4=new Kt("",{providedIn:"root",factory:()=>({queue:new Set,isScheduled:!1,scheduler:null})});function QL(s,c){let l=s.get(G4);if(Array.isArray(c))for(let f of c)l.queue.add(f);else l.queue.add(c);l.scheduler&&l.scheduler(s)}function q4(s,c){for(let[l,f]of c)QL(s,f.animateFns)}function VO(s,c,l,f){let v=s?.[kh]?.enter;c!==null&&v&&v.has(l.index)&&q4(f,v)}function am(s,c,l,f,v,i,C,k){if(v!=null){let B,ee=!1;Ja(v)?B=v:Pl(v)&&(ee=!0,v=v[Ka]);let _e=va(v);s===0&&f!==null?(VO(k,f,i,l),C==null?UL(c,f,_e):Lb(c,f,_e,C||null,!0)):s===1&&f!==null?(VO(k,f,i,l),Lb(c,f,_e,C||null,!0)):s===2?jO(k,i,l,Oe=>{HL(c,_e,ee,Oe)}):s===3&&jO(k,i,l,()=>{c.destroyNode(_e)}),B!=null&&i5(c,s,l,B,i,f,C)}}function W4(s,c){eF(s,c),c[Ka]=null,c[ds]=null}function Z4(s,c,l,f,v,i){f[Ka]=v,f[ds]=c,iw(s,f,l,1,v,i)}function eF(s,c){c[Rl].changeDetectionScheduler?.notify(9),iw(s,c,c[Ir],2,null,null)}function X4(s){let c=s[nm];if(!c)return iS(s[Gn],s);for(;c;){let l=null;if(Pl(c))l=c[nm];else{let f=c[oo];f&&(l=f)}if(!l){for(;c&&!c[ya]&&c!==s;)Pl(c)&&iS(c[Gn],c),c=c[_o];c===null&&(c=s),Pl(c)&&iS(c[Gn],c),l=c&&c[ya]}c=l}}function uD(s,c){let l=s[fy],f=l.indexOf(c);l.splice(f,1)}function nw(s,c){if(Nh(c))return;let l=c[Ir];l.destroyNode&&iw(s,c,l,3,null,null),X4(c)}function iS(s,c){if(Nh(c))return;let l=Xn(null);try{c[Qn]&=-129,c[Qn]|=256,c[ea]&&K_(c[ea]),J4(s,c),K4(s,c),c[Gn].type===1&&c[Ir].destroy();let f=c[Ph];if(f!==null&&Ja(c[_o])){f!==c[_o]&&uD(f,c);let v=c[Lh];v!==null&&v.detachView(s)}mS(c)}finally{Xn(l)}}function jO(s,c,l,f){let v=s?.[kh];if(v==null||v.leave==null||!v.leave.has(c.index))return f(!1);if(v.skipLeaveAnimations)return v.skipLeaveAnimations=!1,f(!1);s&&dm.add(s),QL(l,()=>{if(v.leave&&v.leave.has(c.index)){let C=v.leave.get(c.index),k=[];if(C)for(let B=0;B<C.animateFns.length;B++){let ee=C.animateFns[B],{promise:_e}=ee();k.push(_e)}v.running=Promise.allSettled(k),Y4(s,f)}else s&&dm.delete(s),f(!1)})}function Y4(s,c){let l=s[kh]?.running;if(l){l.then(()=>{s[kh].running=void 0,dm.delete(s),c(!0)});return}c(!1)}function K4(s,c){let l=s.cleanup,f=c[tm];if(l!==null)for(let C=0;C<l.length-1;C+=2)if(typeof l[C]=="string"){let k=l[C+3];k>=0?f[k]():f[-k].unsubscribe(),C+=2}else{let k=f[l[C+1]];l[C].call(k)}f!==null&&(c[tm]=null);let v=c[Tc];if(v!==null){c[Tc]=null;for(let C=0;C<v.length;C++){let k=v[C];k()}}let i=c[dy];if(i!==null){c[dy]=null;for(let C of i)C.destroy()}}function J4(s,c){let l;if(s!=null&&(l=s.destroyHooks)!=null)for(let f=0;f<l.length;f+=2){let v=c[l[f]];if(!(v instanceof Bh)){let i=l[f+1];if(Array.isArray(i))for(let C=0;C<i.length;C+=2){let k=v[i[C]],B=i[C+1];ir(4,k,B);try{B.call(k)}finally{ir(5,k,B)}}else{ir(4,v,i);try{i.call(v)}finally{ir(5,v,i)}}}}}function tF(s,c,l){return Q4(s,c.parent,l)}function Q4(s,c,l){let f=c;for(;f!==null&&f.type&168;)c=f,f=c.parent;if(f===null)return l[Ka];if(Wu(f)){let{encapsulation:v}=s.data[f.directiveStart+f.componentOffset];if(v===Mc.None||v===Mc.Emulated)return null}return Qa(f,l)}function nF(s,c,l){return t5(s,c,l)}function e5(s,c,l){return s.type&40?Qa(s,l):null}var t5=e5,UO;function dD(s,c,l,f){let v=tF(s,f,c),i=c[Ir],C=f.parent||c[ds],k=nF(C,f,c);if(v!=null)if(Array.isArray(l))for(let B=0;B<l.length;B++)FO(i,v,l[B],k,!1);else FO(i,v,l,k,!1);UO!==void 0&&UO(i,f,c,l,v)}function _y(s,c){if(c!==null){let l=c.type;if(l&3)return Qa(c,s);if(l&4)return AS(-1,s[c.index]);if(l&8){let f=c.child;if(f!==null)return _y(s,f);{let v=s[c.index];return Ja(v)?AS(-1,v):va(v)}}else{if(l&128)return _y(s,c.next);if(l&32)return sD(c,s)()||va(s[c.index]);{let f=iF(s,c);if(f!==null){if(Array.isArray(f))return f[0];let v=Uu(s[hs]);return _y(v,f)}else return _y(s,c.next)}}}return null}function iF(s,c){if(c!==null){let f=s[hs][ds],v=c.projection;return f.projection[v]}return null}function AS(s,c){let l=oo+s+1;if(l<c.length){let f=c[l],v=f[Gn].firstChild;if(v!==null)return _y(f,v)}return c[qu]}function hD(s,c,l,f,v,i,C){for(;l!=null;){let k=f[Gu];if(l.type===128){l=l.next;continue}let B=f[l.index],ee=l.type;if(C&&c===0&&(B&&um(va(B),f),l.flags|=2),!Kb(l))if(ee&8)hD(s,c,l.child,f,v,i,!1),am(c,s,k,v,B,l,i,f);else if(ee&32){let _e=sD(l,f),Oe;for(;Oe=_e();)am(c,s,k,v,Oe,l,i,f);am(c,s,k,v,B,l,i,f)}else ee&16?rF(s,c,f,l,v,i):am(c,s,k,v,B,l,i,f);l=C?l.projectionNext:l.next}}function iw(s,c,l,f,v,i){hD(l,f,s.firstChild,c,v,i,!1)}function n5(s,c,l){let f=c[Ir],v=tF(s,l,c),i=l.parent||c[ds],C=nF(i,l,c);rF(f,0,c,l,v,C)}function rF(s,c,l,f,v,i){let C=l[hs],B=C[ds].projection[f.projection];if(Array.isArray(B))for(let ee=0;ee<B.length;ee++){let _e=B[ee];am(c,s,l[Gu],v,_e,f,i,l)}else{let ee=B,_e=C[_o];_L(f)&&(ee.flags|=128),hD(s,c,ee,_e,v,i,!0)}}function i5(s,c,l,f,v,i,C){let k=f[qu],B=va(f);k!==B&&am(c,s,l,i,k,v,C);for(let ee=oo;ee<f.length;ee++){let _e=f[ee];iw(_e[Gn],_e,s,c,i,k)}}function r5(s,c,l,f,v){if(c)v?s.addClass(l,f):s.removeClass(l,f);else{let i=f.indexOf("-")===-1?void 0:Pc.DashCase;v==null?s.removeStyle(l,f,i):(typeof v=="string"&&v.endsWith("!important")&&(v=v.slice(0,-10),i|=Pc.Important),s.setStyle(l,f,v,i))}}function oF(s,c,l,f,v){let i=Ac(),C=f&2;try{Xu(-1),C&&c.length>ro&&WL(s,c,ro,!1),ir(C?2:0,v,l),l(f,v)}finally{Xu(i),ir(C?3:1,v,l)}}function sF(s,c,l){d5(s,c,l),(l.flags&64)===64&&h5(s,c,l)}function fD(s,c,l=Qa){let f=c.localNames;if(f!==null){let v=c.index+1;for(let i=0;i<f.length;i+=2){let C=f[i+1],k=C===-1?l(c,s):s[C];s[v++]=k}}}function o5(s,c,l,f){let i=f.get(SL,IL)||l===Mc.ShadowDom,C=s.selectRootElement(c,i);return s5(C),C}function s5(s){a5(s)}var a5=()=>null;function l5(s){return s==="class"?"className":s==="for"?"htmlFor":s==="formaction"?"formAction":s==="innerHtml"?"innerHTML":s==="readonly"?"readOnly":s==="tabindex"?"tabIndex":s}function c5(s,c,l,f,v,i){let C=c[Gn];if(pD(s,C,c,l,f)){Wu(s)&&u5(c,s.index);return}s.type&3&&(l=l5(l)),aF(s,c,l,f,v,i)}function aF(s,c,l,f,v,i){if(s.type&3){let C=Qa(s,c);f=i!=null?i(f,s.value||"",l):f,v.setProperty(C,l,f)}else s.type&12}function u5(s,c){let l=xa(c,s);l[Qn]&16||(l[Qn]|=64)}function d5(s,c,l){let f=l.directiveStart,v=l.directiveEnd;Wu(l)&&F4(c,l,s.data[f+l.componentOffset]),s.firstCreatePass||Pb(l,c);let i=l.initialInputs;for(let C=f;C<v;C++){let k=s.data[C],B=Ob(c,s,C,l);if(um(B,c),i!==null&&_5(c,C-f,B,k,l,i),Ol(k)){let ee=xa(l.index,c);ee[qr]=Ob(c,s,C,l)}}}function h5(s,c,l){let f=l.directiveStart,v=l.directiveEnd,i=l.index,C=hO();try{Xu(i);for(let k=f;k<v;k++){let B=s.data[k],ee=c[k];pb(k),(B.hostBindings!==null||B.hostVars!==0||B.hostAttrs!==null)&&f5(B,ee)}}finally{Xu(-1),pb(C)}}function f5(s,c){s.hostBindings!==null&&s.hostBindings(1,c)}function p5(s,c){let l=s.directiveRegistry,f=null;if(l)for(let v=0;v<l.length;v++){let i=l[v];VL(c,i.selectors,!1)&&(f??=[],Ol(i)?f.unshift(i):f.push(i))}return f}function m5(s,c,l,f,v,i){let C=Qa(s,c);g5(c[Ir],C,i,s.value,l,f,v)}function g5(s,c,l,f,v,i,C){if(i==null)s.removeAttribute(c,v,l);else{let k=C==null?Qp(i):C(i,f||"",v);s.setAttribute(c,v,k,l)}}function _5(s,c,l,f,v,i){let C=i[c];if(C!==null)for(let k=0;k<C.length;k+=2){let B=C[k],ee=C[k+1];SS(f,l,B,ee)}}function lF(s,c,l,f,v){let i=ro+l,C=c[Gn],k=v(C,c,s,f,l);c[i]=k,om(s,!0);let B=s.type===2;return B?($L(c[Ir],k,s),(rO()===0||db(s))&&um(k,c),oO()):um(k,c),yb()&&(!B||!Kb(s))&&dD(C,c,k,s),s}function cF(s){let c=s;return UI()?HI():(c=c.parent,om(c,!1)),c}function y5(s,c){let l=s[Gu];if(!l)return;let f;try{f=l.get(Os,null)}catch{f=null}f?.(c)}function pD(s,c,l,f,v){let i=s.inputs?.[f],C=s.hostDirectiveInputs?.[f],k=!1;if(C)for(let B=0;B<C.length;B+=2){let ee=C[B],_e=C[B+1],Oe=c.data[ee];SS(Oe,l[ee],_e,v),k=!0}if(i)for(let B of i){let ee=l[B],_e=c.data[B];SS(_e,ee,f,v),k=!0}return k}function v5(s,c){let l=xa(c,s),f=l[Gn];x5(f,l);let v=l[Ka];v!==null&&l[Mh]===null&&(l[Mh]=DL(v,l[Gu])),ir(18),mD(f,l,l[qr]),ir(19,l[qr])}function x5(s,c){for(let l=c.length;l<s.blueprint.length;l++)c.push(s.blueprint[l])}function mD(s,c,l){mb(c);try{let f=s.viewQuery;f!==null&&_S(1,f,l);let v=s.template;v!==null&&oF(s,c,v,1,l),s.firstCreatePass&&(s.firstCreatePass=!1),c[Lh]?.finishViewCreation(s),s.staticContentQueries&&CL(s,c),s.staticViewQueries&&_S(2,s.viewQuery,l);let i=s.components;i!==null&&b5(c,i)}catch(f){throw s.firstCreatePass&&(s.incompleteFirstPass=!0,s.firstCreatePass=!1),f}finally{c[Qn]&=-5,gb()}}function b5(s,c){for(let l=0;l<c.length;l++)v5(s,c[l])}function rw(s,c,l,f){let v=Xn(null);try{let i=c.tView,k=s[Qn]&4096?4096:16,B=rD(s,i,l,k,null,c,null,null,f?.injector??null,f?.embeddedViewInjector??null,f?.dehydratedView??null),ee=s[c.index];B[Ph]=ee;let _e=s[Lh];return _e!==null&&(B[Lh]=_e.createEmbeddedView(i)),mD(i,B,l),B}finally{Xn(v)}}function hm(s,c){return!c||c.firstChild===null||_L(s)}function vy(s,c,l,f,v=!1){for(;l!==null;){if(l.type===128){l=v?l.projectionNext:l.next;continue}let i=c[l.index];i!==null&&f.push(va(i)),Ja(i)&&uF(i,f);let C=l.type;if(C&8)vy(s,c,l.child,f);else if(C&32){let k=sD(l,c),B;for(;B=k();)f.push(B)}else if(C&16){let k=iF(c,l);if(Array.isArray(k))f.push(...k);else{let B=Uu(c[hs]);vy(B[Gn],B,k,f,!0)}}l=v?l.projectionNext:l.next}return f}function uF(s,c){for(let l=oo;l<s.length;l++){let f=s[l],v=f[Gn].firstChild;v!==null&&vy(f[Gn],f,v,c)}s[qu]!==s[Ka]&&c.push(s[qu])}function dF(s){if(s[Fh]!==null){for(let c of s[Fh])c.impl.addSequence(c);s[Fh].length=0}}var hF=[];function w5(s){return s[ea]??E5(s)}function E5(s){let c=hF.pop()??Object.create(I5);return c.lView=s,c}function T5(s){s.lView[ea]!==s&&(s.lView=null,hF.push(s))}var I5=di(Bt({},Np),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:s=>{rm(s.lView)},consumerOnSignalRead(){this.lView[ea]=this}});function S5(s){let c=s[ea]??Object.create(D5);return c.lView=s,c}var D5=di(Bt({},Np),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:s=>{let c=Uu(s.lView);for(;c&&!fF(c[Gn]);)c=Uu(c);c&&FI(c)},consumerOnSignalRead(){this.lView[ea]=this}});function fF(s){return s.type!==2}function pF(s){if(s[dy]===null)return;let c=!0;for(;c;){let l=!1;for(let f of s[dy])f.dirty&&(l=!0,f.zone===null||Zone.current===f.zone?f.run():f.zone.run(()=>f.run()));c=l&&!!(s[Qn]&8192)}}var C5=100;function mF(s,c=0){let f=s[Rl].rendererFactory,v=!1;v||f.begin?.();try{A5(s,c)}finally{v||f.end?.()}}function A5(s,c){let l=$I();try{GI(!0),MS(s,c);let f=0;for(;my(s);){if(f===C5)throw new tn(103,!1);f++,MS(s,1)}}finally{GI(l)}}function M5(s,c,l,f){if(Nh(c))return;let v=c[Qn],i=!1,C=!1;mb(c);let k=!0,B=null,ee=null;i||(fF(s)?(ee=w5(c),B=Bp(ee)):Ex()===null?(k=!1,ee=S5(c),B=Bp(ee)):c[ea]&&(K_(c[ea]),c[ea]=null));try{LI(c),cO(s.bindingStartIndex),l!==null&&oF(s,c,l,2,f);let _e=(v&3)===3;if(!i)if(_e){let Fe=s.preOrderCheckHooks;Fe!==null&&Sb(c,Fe,null)}else{let Fe=s.preOrderHooks;Fe!==null&&Db(c,Fe,0,null),tS(c,0)}if(C||R5(c),pF(c),gF(c,0),s.contentQueries!==null&&CL(s,c),!i)if(_e){let Fe=s.contentCheckHooks;Fe!==null&&Sb(c,Fe)}else{let Fe=s.contentHooks;Fe!==null&&Db(c,Fe,1),tS(c,1)}O5(s,c);let Oe=s.components;Oe!==null&&yF(c,Oe,0);let ct=s.viewQuery;if(ct!==null&&_S(2,ct,f),!i)if(_e){let Fe=s.viewCheckHooks;Fe!==null&&Sb(c,Fe)}else{let Fe=s.viewHooks;Fe!==null&&Db(c,Fe,2),tS(c,2)}if(s.firstUpdatePass===!0&&(s.firstUpdatePass=!1),c[ub]){for(let Fe of c[ub])Fe();c[ub]=null}i||(dF(c),c[Qn]&=-73)}catch(_e){throw i||rm(c),_e}finally{ee!==null&&(X_(ee,B),k&&T5(ee)),gb()}}function gF(s,c){for(let l=vL(s);l!==null;l=xL(l))for(let f=oo;f<l.length;f++){let v=l[f];_F(v,c)}}function R5(s){for(let c=vL(s);c!==null;c=xL(c)){if(!(c[Qn]&2))continue;let l=c[fy];for(let f=0;f<l.length;f++){let v=l[f];FI(v)}}}function P5(s,c,l){ir(18);let f=xa(c,s);_F(f,l),ir(19,f[qr])}function _F(s,c){hb(s)&&MS(s,c)}function MS(s,c){let f=s[Gn],v=s[Qn],i=s[ea],C=!!(c===0&&v&16);if(C||=!!(v&64&&c===0),C||=!!(v&1024),C||=!!(i?.dirty&&Y_(i)),C||=!1,i&&(i.dirty=!1),s[Qn]&=-9217,C)M5(f,s,f.template,s[qr]);else if(v&8192){let k=Xn(null);try{pF(s),gF(s,1);let B=f.components;B!==null&&yF(s,B,1),dF(s)}finally{Xn(k)}}}function yF(s,c,l){for(let f=0;f<c.length;f++)P5(s,c[f],l)}function O5(s,c){let l=s.hostBindingOpCodes;if(l!==null)try{for(let f=0;f<l.length;f++){let v=l[f];if(v<0)Xu(~v);else{let i=v,C=l[++f],k=l[++f];dO(C,i);let B=c[i];ir(24,B),k(2,B),ir(25,B)}}}finally{Xu(-1)}}function gD(s,c){let l=$I()?64:1088;for(s[Rl].changeDetectionScheduler?.notify(c);s;){s[Qn]|=l;let f=Uu(s);if(im(s)&&!f)return s;s=f}return null}function vF(s,c,l,f){return[s,!0,0,c,null,f,null,l,null,null]}function xF(s,c){let l=oo+c;if(l<s.length)return s[l]}function Ay(s,c,l,f=!0){let v=c[Gn];if(L5(v,c,s,l),f){let C=AS(l,s),k=c[Ir],B=k.parentNode(s[qu]);B!==null&&Z4(v,s[ds],k,c,B,C)}let i=c[Mh];i!==null&&i.firstChild!==null&&(i.firstChild=null)}function bF(s,c){let l=xy(s,c);return l!==void 0&&nw(l[Gn],l),l}function xy(s,c){if(s.length<=oo)return;let l=oo+c,f=s[l];if(f){let v=f[Ph];v!==null&&v!==s&&uD(v,f),c>0&&(s[l-1][ya]=f[ya]);let i=ay(s,oo+c);W4(f[Gn],f);let C=i[Lh];C!==null&&C.detachView(i[Gn]),f[_o]=null,f[ya]=null,f[Qn]&=-129}return f}function L5(s,c,l,f){let v=oo+f,i=l.length;f>0&&(l[v-1][ya]=c),f<i-oo?(c[ya]=l[v],bI(l,oo+f,c)):(l.push(c),c[ya]=null),c[_o]=l;let C=c[Ph];C!==null&&l!==C&&wF(C,c);let k=c[Lh];k!==null&&k.insertView(s),fb(c),c[Qn]|=128}function wF(s,c){let l=s[fy],f=c[_o];if(Pl(f))s[Qn]|=2;else{let v=f[_o][hs];c[hs]!==v&&(s[Qn]|=2)}l===null?s[fy]=[c]:l.push(c)}var Vh=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let c=this._lView,l=c[Gn];return vy(l,c,l.firstChild,[])}constructor(c,l){this._lView=c,this._cdRefInjectingView=l}get context(){return this._lView[qr]}set context(c){this._lView[qr]=c}get destroyed(){return Nh(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let c=this._lView[_o];if(Ja(c)){let l=c[hy],f=l?l.indexOf(this):-1;f>-1&&(xy(c,f),ay(l,f))}this._attachedToViewContainer=!1}nw(this._lView[Gn],this._lView)}onDestroy(c){kI(this._lView,c)}markForCheck(){gD(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[Qn]&=-129}reattach(){fb(this._lView),this._lView[Qn]|=128}detectChanges(){this._lView[Qn]|=1024,mF(this._lView)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new tn(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let c=im(this._lView),l=this._lView[Ph];l!==null&&!c&&uD(l,this._lView),eF(this._lView[Gn],this._lView)}attachToAppRef(c){if(this._attachedToViewContainer)throw new tn(902,!1);this._appRef=c;let l=im(this._lView),f=this._lView[Ph];f!==null&&!l&&wF(f,this._lView),fb(this._lView)}};function My(s,c,l,f,v){let i=s.data[c];if(i===null)i=F5(s,c,l,f,v),uO()&&(i.flags|=32);else if(i.type&64){i.type=l,i.value=f,i.attrs=v;let C=aO();i.injectorIndex=C===null?-1:C.injectorIndex}return om(i,!0),i}function F5(s,c,l,f,v){let i=jI(),C=UI(),k=C?i:i&&i.parent,B=s.data[c]=N5(s,k,l,c,f,v);return k5(s,B,i,C),B}function k5(s,c,l,f){s.firstChild===null&&(s.firstChild=c),l!==null&&(f?l.child==null&&c.parent!==null&&(l.child=c):l.next===null&&(l.next=c,c.prev=l))}function N5(s,c,l,f,v,i){let C=c?c.injectorIndex:-1,k=0;return zI()&&(k|=128),{type:l,index:f,insertBeforeIndex:null,injectorIndex:C,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:k,providerIndexes:0,value:v,attrs:i,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:c,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}var xJ=new RegExp(`^(\\d+)*(${ZU}|${WU})*(.*)`);function z5(s){let c=s[RI]??[],f=s[_o][Ir],v=[];for(let i of c)i.data[TL]!==void 0?v.push(i):B5(i,f);s[RI]=v}function B5(s,c){let l=0,f=s.firstChild;if(f){let v=s.data[EL];for(;l<v;){let i=f.nextSibling;HL(c,f,!1),f=i,l++}}}var V5=()=>null,j5=()=>null;function zb(s,c){return V5(s,c)}function EF(s,c,l){return j5(s,c,l)}var TF=class{},ow=class{},RS=class{resolveComponentFactory(c){throw new tn(917,!1)}},Ry=class{static NULL=new RS},jh=class{},Ku=(()=>{class s{destroyNode=null;static __NG_ELEMENT_ID__=()=>U5()}return s})();function U5(){let s=Si(),c=fs(),l=xa(c.index,s);return(Pl(l)?l:s)[Ir]}var IF=(()=>{class s{static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>null})}return s})();var Cb={},PS=class{injector;parentInjector;constructor(c,l){this.injector=c,this.parentInjector=l}get(c,l,f){let v=this.injector.get(c,Cb,f);return v!==Cb||l===Cb?v:this.parentInjector.get(c,l,f)}};function Bb(s,c,l){let f=l?s.styles:null,v=l?s.classes:null,i=0;if(c!==null)for(let C=0;C<c.length;C++){let k=c[C];if(typeof k=="number")i=k;else if(i==1)v=rb(v,k);else if(i==2){let B=k,ee=c[++C];f=rb(f,B+": "+ee+";")}}l?s.styles=f:s.stylesWithoutHost=f,l?s.classes=v:s.classesWithoutHost=v}function ri(s,c=0){let l=Si();if(l===null)return ln(s,c);let f=fs();return pL(f,l,Ao(s),c)}function _D(){let s="invalid";throw new Error(s)}function H5(s,c,l,f,v){let i=f===null?null:{"":-1},C=v(s,l);if(C!==null){let k=C,B=null,ee=null;for(let _e of C)if(_e.resolveHostDirectives!==null){[k,B,ee]=_e.resolveHostDirectives(C);break}q5(s,c,l,k,i,B,ee)}i!==null&&f!==null&&$5(l,f,i)}function $5(s,c,l){let f=s.localNames=[];for(let v=0;v<c.length;v+=2){let i=l[c[v+1]];if(i==null)throw new tn(-301,!1);f.push(c[v],i)}}function G5(s,c,l){c.componentOffset=l,(s.components??=[]).push(c.index)}function q5(s,c,l,f,v,i,C){let k=f.length,B=!1;for(let ct=0;ct<k;ct++){let Fe=f[ct];!B&&Ol(Fe)&&(B=!0,G5(s,l,ct)),fS(Pb(l,c),s,Fe.type)}J5(l,s.data.length,k);for(let ct=0;ct<k;ct++){let Fe=f[ct];Fe.providersResolver&&Fe.providersResolver(Fe)}let ee=!1,_e=!1,Oe=qL(s,c,k,null);k>0&&(l.directiveToIndex=new Map);for(let ct=0;ct<k;ct++){let Fe=f[ct];if(l.mergedAttrs=cm(l.mergedAttrs,Fe.hostAttrs),Z5(s,l,c,Oe,Fe),K5(Oe,Fe,v),C!==null&&C.has(Fe)){let[Xt,At]=C.get(Fe);l.directiveToIndex.set(Fe.type,[Oe,Xt+l.directiveStart,At+l.directiveStart])}else(i===null||!i.has(Fe))&&l.directiveToIndex.set(Fe.type,Oe);Fe.contentQueries!==null&&(l.flags|=4),(Fe.hostBindings!==null||Fe.hostAttrs!==null||Fe.hostVars!==0)&&(l.flags|=64);let yt=Fe.type.prototype;!ee&&(yt.ngOnChanges||yt.ngOnInit||yt.ngDoCheck)&&((s.preOrderHooks??=[]).push(l.index),ee=!0),!_e&&(yt.ngOnChanges||yt.ngDoCheck)&&((s.preOrderCheckHooks??=[]).push(l.index),_e=!0),Oe++}W5(s,l,i)}function W5(s,c,l){for(let f=c.directiveStart;f<c.directiveEnd;f++){let v=s.data[f];if(l===null||!l.has(v))HO(0,c,v,f),HO(1,c,v,f),GO(c,f,!1);else{let i=l.get(v);$O(0,c,i,f),$O(1,c,i,f),GO(c,f,!0)}}}function HO(s,c,l,f){let v=s===0?l.inputs:l.outputs;for(let i in v)if(v.hasOwnProperty(i)){let C;s===0?C=c.inputs??={}:C=c.outputs??={},C[i]??=[],C[i].push(f),SF(c,i)}}function $O(s,c,l,f){let v=s===0?l.inputs:l.outputs;for(let i in v)if(v.hasOwnProperty(i)){let C=v[i],k;s===0?k=c.hostDirectiveInputs??={}:k=c.hostDirectiveOutputs??={},k[C]??=[],k[C].push(f,i),SF(c,C)}}function SF(s,c){c==="class"?s.flags|=8:c==="style"&&(s.flags|=16)}function GO(s,c,l){let{attrs:f,inputs:v,hostDirectiveInputs:i}=s;if(f===null||!l&&v===null||l&&i===null||nD(s)){s.initialInputs??=[],s.initialInputs.push(null);return}let C=null,k=0;for(;k<f.length;){let B=f[k];if(B===0){k+=4;continue}else if(B===5){k+=2;continue}else if(typeof B=="number")break;if(!l&&v.hasOwnProperty(B)){let ee=v[B];for(let _e of ee)if(_e===c){C??=[],C.push(B,f[k+1]);break}}else if(l&&i.hasOwnProperty(B)){let ee=i[B];for(let _e=0;_e<ee.length;_e+=2)if(ee[_e]===c){C??=[],C.push(ee[_e+1],f[k+1]);break}}k+=2}s.initialInputs??=[],s.initialInputs.push(C)}function Z5(s,c,l,f,v){s.data[f]=v;let i=v.factory||(v.factory=Ih(v.type,!0)),C=new Bh(i,Ol(v),ri,null);s.blueprint[f]=C,l[f]=C,X5(s,c,f,qL(s,l,v.hostVars,ta),v)}function X5(s,c,l,f,v){let i=v.hostBindings;if(i){let C=s.hostBindingOpCodes;C===null&&(C=s.hostBindingOpCodes=[]);let k=~c.index;Y5(C)!=k&&C.push(k),C.push(l,f,i)}}function Y5(s){let c=s.length;for(;c>0;){let l=s[--c];if(typeof l=="number"&&l<0)return l}return 0}function K5(s,c,l){if(l){if(c.exportAs)for(let f=0;f<c.exportAs.length;f++)l[c.exportAs[f]]=s;Ol(c)&&(l[""]=s)}}function J5(s,c,l){s.flags|=1,s.directiveStart=c,s.directiveEnd=c+l,s.providerIndexes=c}function DF(s,c,l,f,v,i,C,k){let B=c[Gn],ee=B.consts,_e=Ll(ee,C),Oe=My(B,s,l,f,_e);return i&&H5(B,c,Oe,Ll(ee,k),v),Oe.mergedAttrs=cm(Oe.mergedAttrs,Oe.attrs),Oe.attrs!==null&&Bb(Oe,Oe.attrs,!1),Oe.mergedAttrs!==null&&Bb(Oe,Oe.mergedAttrs,!0),B.queries!==null&&B.queries.elementStart(B,Oe),Oe}function CF(s,c){SU(s,c),PI(c)&&s.queries.elementEnd(c)}function Q5(s,c,l,f,v,i){let C=c.consts,k=Ll(C,v),B=My(c,s,l,f,k);if(B.mergedAttrs=cm(B.mergedAttrs,B.attrs),i!=null){let ee=Ll(C,i);B.localNames=[];for(let _e=0;_e<ee.length;_e+=2)B.localNames.push(ee[_e],-1)}return B.attrs!==null&&Bb(B,B.attrs,!1),B.mergedAttrs!==null&&Bb(B,B.mergedAttrs,!0),c.queries!==null&&c.queries.elementStart(c,B),B}function eH(s,c,l){return s[c]=l}function tH(s,c){return s[c]}function kc(s,c,l){if(l===ta)return!1;let f=s[c];return Object.is(f,l)?!1:(s[c]=l,!0)}function rS(s,c,l){return function f(v){let i=Wu(s)?xa(s.index,c):c;gD(i,5);let C=c[qr],k=qO(c,C,l,v),B=f.__ngNextListenerFn__;for(;B;)k=qO(c,C,B,v)&&k,B=B.__ngNextListenerFn__;return k}}function qO(s,c,l,f){let v=Xn(null);try{return ir(6,c,l),l(f)!==!1}catch(i){return y5(s,i),!1}finally{ir(7,c,l),Xn(v)}}function nH(s,c,l,f,v,i,C,k){let B=db(s),ee=!1,_e=null;if(!f&&B&&(_e=rH(c,l,i,s.index)),_e!==null){let Oe=_e.__ngLastListenerFn__||_e;Oe.__ngNextListenerFn__=C,_e.__ngLastListenerFn__=C,ee=!0}else{let Oe=Qa(s,l),ct=f?f(Oe):Oe;YU(l,ct,i,k);let Fe=v.listen(ct,i,k);if(!iH(i)){let yt=f?Xt=>f(va(Xt[s.index])):s.index;AF(yt,c,l,i,k,Fe,!1)}}return ee}function iH(s){return s.startsWith("animation")||s.startsWith("transition")}function rH(s,c,l,f){let v=s.cleanup;if(v!=null)for(let i=0;i<v.length-1;i+=2){let C=v[i];if(C===l&&v[i+1]===f){let k=c[tm],B=v[i+2];return k&&k.length>B?k[B]:null}typeof C=="string"&&(i+=2)}return null}function AF(s,c,l,f,v,i,C){let k=c.firstCreatePass?iO(c):null,B=nO(l),ee=B.length;B.push(v,i),k&&k.push(f,s,ee,(ee+1)*(C?-1:1))}function WO(s,c,l,f,v,i){let C=c[l],k=c[Gn],ee=k.data[l].outputs[f],Oe=C[ee].subscribe(i);AF(s.index,k,c,v,i,Oe,!0)}var OS=Symbol("BINDING");var Vb=class extends Ry{ngModule;constructor(c){super(),this.ngModule=c}resolveComponentFactory(c){let l=Cc(c);return new Uh(l,this.ngModule)}};function oH(s){return Object.keys(s).map(c=>{let[l,f,v]=s[c],i={propName:l,templateName:c,isSignal:(f&ew.SignalBased)!==0};return v&&(i.transform=v),i})}function sH(s){return Object.keys(s).map(c=>({propName:s[c],templateName:c}))}function aH(s,c,l){let f=c instanceof Gr?c:c?.injector;return f&&s.getStandaloneInjector!==null&&(f=s.getStandaloneInjector(f)||f),f?new PS(l,f):l}function lH(s){let c=s.get(jh,null);if(c===null)throw new tn(407,!1);let l=s.get(IF,null),f=s.get(Sc,null);return{rendererFactory:c,sanitizer:l,changeDetectionScheduler:f,ngReflect:!1}}function cH(s,c){let l=MF(s);return jL(c,l,l==="svg"?K2:l==="math"?J2:null)}function MF(s){return(s.selectors[0][0]||"div").toLowerCase()}var Uh=class extends ow{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=oH(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=sH(this.componentDef.outputs),this.cachedOutputs}constructor(c,l){super(),this.componentDef=c,this.ngModule=l,this.componentType=c.type,this.selector=D4(c.selectors),this.ngContentSelectors=c.ngContentSelectors??[],this.isBoundToModule=!!l}create(c,l,f,v,i,C){ir(22);let k=Xn(null);try{let B=this.componentDef,ee=uH(f,B,C,i),_e=aH(B,v||this.ngModule,c),Oe=lH(_e),ct=Oe.rendererFactory.createRenderer(null,B),Fe=f?o5(ct,f,B.encapsulation,_e):cH(B,ct),yt=C?.some(ZO)||i?.some(Lt=>typeof Lt!="function"&&Lt.bindings.some(ZO)),Xt=rD(null,ee,null,512|GL(B),null,null,Oe,ct,_e,null,DL(Fe,_e,!0));Xt[ro]=Fe,mb(Xt);let At=null;try{let Lt=DF(ro,Xt,2,"#host",()=>ee.directiveRegistry,!0,0);$L(ct,Fe,Lt),um(Fe,Xt),sF(ee,Xt,Lt),AL(ee,Lt,Xt),CF(ee,Lt),l!==void 0&&hH(Lt,this.ngContentSelectors,l),At=xa(Lt.index,Xt),Xt[qr]=At[qr],mD(ee,Xt,null)}catch(Lt){throw At!==null&&mS(At),mS(Xt),Lt}finally{ir(23),gb()}return new jb(this.componentType,Xt,!!yt)}finally{Xn(k)}}};function uH(s,c,l,f){let v=s?["ng-version","20.3.10"]:C4(c.selectors[0]),i=null,C=null,k=0;if(l)for(let _e of l)k+=_e[OS].requiredVars,_e.create&&(_e.targetIdx=0,(i??=[]).push(_e)),_e.update&&(_e.targetIdx=0,(C??=[]).push(_e));if(f)for(let _e=0;_e<f.length;_e++){let Oe=f[_e];if(typeof Oe!="function")for(let ct of Oe.bindings){k+=ct[OS].requiredVars;let Fe=_e+1;ct.create&&(ct.targetIdx=Fe,(i??=[]).push(ct)),ct.update&&(ct.targetIdx=Fe,(C??=[]).push(ct))}}let B=[c];if(f)for(let _e of f){let Oe=typeof _e=="function"?_e:_e.type,ct=II(Oe);B.push(ct)}return iD(0,null,dH(i,C),1,k,B,null,null,null,[v],null)}function dH(s,c){return!s&&!c?null:l=>{if(l&1&&s)for(let f of s)f.create();if(l&2&&c)for(let f of c)f.update()}}function ZO(s){let c=s[OS].kind;return c==="input"||c==="twoWay"}var jb=class extends TF{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(c,l,f){super(),this._rootLView=l,this._hasInputBindings=f,this._tNode=py(l[Gn],ro),this.location=qS(this._tNode,l),this.instance=xa(this._tNode.index,l)[qr],this.hostView=this.changeDetectorRef=new Vh(l,void 0),this.componentType=c}setInput(c,l){this._hasInputBindings;let f=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(c)&&Object.is(this.previousInputValues.get(c),l))return;let v=this._rootLView,i=pD(f,v[Gn],v,c,l);this.previousInputValues.set(c,l);let C=xa(f.index,v);gD(C,1)}get injector(){return new zh(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(c){this.hostView.onDestroy(c)}};function hH(s,c,l){let f=s.projection=[];for(let v=0;v<c.length;v++){let i=l[v];f.push(i!=null&&i.length?Array.from(i):null)}}var Py=(()=>{class s{static __NG_ELEMENT_ID__=fH}return s})();function fH(){let s=fs();return mH(s,Si())}var pH=Py,RF=class extends pH{_lContainer;_hostTNode;_hostLView;constructor(c,l,f){super(),this._lContainer=c,this._hostTNode=l,this._hostLView=f}get element(){return qS(this._hostTNode,this._hostLView)}get injector(){return new zh(this._hostTNode,this._hostLView)}get parentInjector(){let c=GS(this._hostTNode,this._hostLView);if(lL(c)){let l=Rb(c,this._hostLView),f=Mb(c),v=l[Gn].data[f+8];return new zh(v,l)}else return new zh(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(c){let l=XO(this._lContainer);return l!==null&&l[c]||null}get length(){return this._lContainer.length-oo}createEmbeddedView(c,l,f){let v,i;typeof f=="number"?v=f:f!=null&&(v=f.index,i=f.injector);let C=zb(this._lContainer,c.ssrId),k=c.createEmbeddedViewImpl(l||{},i,C);return this.insertImpl(k,v,hm(this._hostTNode,C)),k}createComponent(c,l,f,v,i,C,k){let B=c&&!bU(c),ee;if(B)ee=l;else{let At=l||{};ee=At.index,f=At.injector,v=At.projectableNodes,i=At.environmentInjector||At.ngModuleRef,C=At.directives,k=At.bindings}let _e=B?c:new Uh(Cc(c)),Oe=f||this.parentInjector;if(!i&&_e.ngModule==null){let Lt=(B?Oe:this.parentInjector).get(Gr,null);Lt&&(i=Lt)}let ct=Cc(_e.componentType??{}),Fe=zb(this._lContainer,ct?.id??null),yt=Fe?.firstChild??null,Xt=_e.create(Oe,v,yt,i,C,k);return this.insertImpl(Xt.hostView,ee,hm(this._hostTNode,Fe)),Xt}insert(c,l){return this.insertImpl(c,l,!0)}insertImpl(c,l,f){let v=c._lView;if(Q2(v)){let k=this.indexOf(c);if(k!==-1)this.detach(k);else{let B=v[_o],ee=new RF(B,B[ds],B[_o]);ee.detach(ee.indexOf(c))}}let i=this._adjustIndex(l),C=this._lContainer;return Ay(C,v,i,f),c.attachToViewContainerRef(),bI(oS(C),i,c),c}move(c,l){return this.insert(c,l)}indexOf(c){let l=XO(this._lContainer);return l!==null?l.indexOf(c):-1}remove(c){let l=this._adjustIndex(c,-1),f=xy(this._lContainer,l);f&&(ay(oS(this._lContainer),l),nw(f[Gn],f))}detach(c){let l=this._adjustIndex(c,-1),f=xy(this._lContainer,l);return f&&ay(oS(this._lContainer),l)!=null?new Vh(f):null}_adjustIndex(c,l=0){return c??this.length+l}};function XO(s){return s[hy]}function oS(s){return s[hy]||(s[hy]=[])}function mH(s,c){let l,f=c[s.index];return Ja(f)?l=f:(l=vF(f,c,null,s),c[s.index]=l,oD(c,l)),_H(l,c,s,f),new RF(l,s,c)}function gH(s,c){let l=s[Ir],f=l.createComment(""),v=Qa(c,s),i=l.parentNode(v);return Lb(l,i,f,l.nextSibling(v),!1),f}var _H=xH,yH=()=>!1;function vH(s,c,l){return yH(s,c,l)}function xH(s,c,l,f){if(s[qu])return;let v;l.type&8?v=va(f):v=gH(c,l),s[qu]=v}var fm=class{},sw=class{};var Ub=class extends fm{ngModuleType;_parent;_bootstrapComponents=[];_r3Injector;instance;destroyCbs=[];componentFactoryResolver=new Vb(this);constructor(c,l,f,v=!0){super(),this.ngModuleType=c,this._parent=l;let i=TI(c);this._bootstrapComponents=zL(i.bootstrap),this._r3Injector=YI(c,l,[{provide:fm,useValue:this},{provide:Ry,useValue:this.componentFactoryResolver},...f],Ic(c),new Set(["environment"])),v&&this.resolveInjectorInitializers()}resolveInjectorInitializers(){this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(this.ngModuleType)}get injector(){return this._r3Injector}destroy(){let c=this._r3Injector;!c.destroyed&&c.destroy(),this.destroyCbs.forEach(l=>l()),this.destroyCbs=null}onDestroy(c){this.destroyCbs.push(c)}},Hb=class extends sw{moduleType;constructor(c){super(),this.moduleType=c}create(c){return new Ub(this.moduleType,c,[])}};var by=class extends fm{injector;componentFactoryResolver=new Vb(this);instance=null;constructor(c){super();let l=new Dh([...c.providers,{provide:fm,useValue:this},{provide:Ry,useValue:this.componentFactoryResolver}],c.parent||cy(),c.debugName,new Set(["environment"]));this.injector=l,c.runEnvironmentInitializers&&l.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(c){this.injector.onDestroy(c)}};function _m(s,c,l=null){return new by({providers:s,parent:c,debugName:l,runEnvironmentInitializers:!0}).injector}var bH=(()=>{class s{_injector;cachedInjectors=new Map;constructor(l){this._injector=l}getOrCreateStandaloneInjector(l){if(!l.standalone)return null;if(!this.cachedInjectors.has(l)){let f=SI(!1,l.type),v=f.length>0?_m([f],this._injector,`Standalone[${l.type.name}]`):null;this.cachedInjectors.set(l,v)}return this.cachedInjectors.get(l)}ngOnDestroy(){try{for(let l of this.cachedInjectors.values())l!==null&&l.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Wt({token:s,providedIn:"environment",factory:()=>new s(ln(Gr))})}return s})();function ur(s){return Ty(()=>{let c=PF(s),l=di(Bt({},c),{decls:s.decls,vars:s.vars,template:s.template,consts:s.consts||null,ngContentSelectors:s.ngContentSelectors,onPush:s.changeDetection===WS.OnPush,directiveDefs:null,pipeDefs:null,dependencies:c.standalone&&s.dependencies||null,getStandaloneInjector:c.standalone?v=>v.get(bH).getOrCreateStandaloneInjector(l):null,getExternalStyles:null,signals:s.signals??!1,data:s.data||{},encapsulation:s.encapsulation||Mc.Emulated,styles:s.styles||us,_:null,schemas:s.schemas||null,tView:null,id:""});c.standalone&&nl("NgStandalone"),OF(l);let f=s.dependencies;return l.directiveDefs=YO(f,wH),l.pipeDefs=YO(f,H2),l.id=IH(l),l})}function wH(s){return Cc(s)||II(s)}function Ro(s){return Ty(()=>({type:s.type,bootstrap:s.bootstrap||us,declarations:s.declarations||us,imports:s.imports||us,exports:s.exports||us,transitiveCompileScopes:null,schemas:s.schemas||null,id:s.id||null}))}function EH(s,c){if(s==null)return $u;let l={};for(let f in s)if(s.hasOwnProperty(f)){let v=s[f],i,C,k,B;Array.isArray(v)?(k=v[0],i=v[1],C=v[2]??i,B=v[3]||null):(i=v,C=v,k=ew.None,B=null),l[i]=[f,k,B],c[i]=C}return l}function TH(s){if(s==null)return $u;let c={};for(let l in s)s.hasOwnProperty(l)&&(c[s[l]]=l);return c}function Ls(s){return Ty(()=>{let c=PF(s);return OF(c),c})}function PF(s){let c={};return{type:s.type,providersResolver:null,factory:null,hostBindings:s.hostBindings||null,hostVars:s.hostVars||0,hostAttrs:s.hostAttrs||null,contentQueries:s.contentQueries||null,declaredInputs:c,inputConfig:s.inputs||$u,exportAs:s.exportAs||null,standalone:s.standalone??!0,signals:s.signals===!0,selectors:s.selectors||us,viewQuery:s.viewQuery||null,features:s.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:EH(s.inputs,c),outputs:TH(s.outputs),debugInfo:null}}function OF(s){s.features?.forEach(c=>c(s))}function YO(s,c){return s?()=>{let l=typeof s=="function"?s():s,f=[];for(let v of l){let i=c(v);i!==null&&f.push(i)}return f}:null}function IH(s){let c=0,l=typeof s.consts=="function"?"":s.consts,f=[s.selectors,s.ngContentSelectors,s.hostVars,s.hostAttrs,l,s.vars,s.decls,s.encapsulation,s.standalone,s.signals,s.exportAs,JSON.stringify(s.inputs),JSON.stringify(s.outputs),Object.getOwnPropertyNames(s.type.prototype),!!s.contentQueries,!!s.viewQuery];for(let i of f.join("|"))c=Math.imul(31,c)+i.charCodeAt(0)<<0;return c+=2147483648,"c"+c}function SH(s){return Object.getPrototypeOf(s.prototype).constructor}function Gh(s){let c=SH(s.type),l=!0,f=[s];for(;c;){let v;if(Ol(s))v=c.\u0275cmp||c.\u0275dir;else{if(c.\u0275cmp)throw new tn(903,!1);v=c.\u0275dir}if(v){if(l){f.push(v);let C=s;C.inputs=sS(s.inputs),C.declaredInputs=sS(s.declaredInputs),C.outputs=sS(s.outputs);let k=v.hostBindings;k&&RH(s,k);let B=v.viewQuery,ee=v.contentQueries;if(B&&AH(s,B),ee&&MH(s,ee),DH(s,v),k2(s.outputs,v.outputs),Ol(v)&&v.data.animation){let _e=s.data;_e.animation=(_e.animation||[]).concat(v.data.animation)}}let i=v.features;if(i)for(let C=0;C<i.length;C++){let k=i[C];k&&k.ngInherit&&k(s),k===Gh&&(l=!1)}}c=Object.getPrototypeOf(c)}CH(f)}function DH(s,c){for(let l in c.inputs){if(!c.inputs.hasOwnProperty(l)||s.inputs.hasOwnProperty(l))continue;let f=c.inputs[l];f!==void 0&&(s.inputs[l]=f,s.declaredInputs[l]=c.declaredInputs[l])}}function CH(s){let c=0,l=null;for(let f=s.length-1;f>=0;f--){let v=s[f];v.hostVars=c+=v.hostVars,v.hostAttrs=cm(v.hostAttrs,l=cm(l,v.hostAttrs))}}function sS(s){return s===$u?{}:s===us?[]:s}function AH(s,c){let l=s.viewQuery;l?s.viewQuery=(f,v)=>{c(f,v),l(f,v)}:s.viewQuery=c}function MH(s,c){let l=s.contentQueries;l?s.contentQueries=(f,v,i)=>{c(f,v,i),l(f,v,i)}:s.contentQueries=c}function RH(s,c){let l=s.hostBindings;l?s.hostBindings=(f,v)=>{c(f,v),l(f,v)}:s.hostBindings=c}function PH(s,c,l,f,v,i,C,k){if(l.firstCreatePass){s.mergedAttrs=cm(s.mergedAttrs,s.attrs);let _e=s.tView=iD(2,s,v,i,C,l.directiveRegistry,l.pipeRegistry,null,l.schemas,l.consts,null);l.queries!==null&&(l.queries.template(l,s),_e.queries=l.queries.embeddedTView(s))}k&&(s.flags|=k),om(s,!1);let B=OH(l,c,s,f);yb()&&dD(l,c,B,s),um(B,c);let ee=vF(B,c,B,s);c[f+ro]=ee,oD(c,ee),vH(ee,s,c)}function wy(s,c,l,f,v,i,C,k,B,ee,_e){let Oe=l+ro,ct;if(c.firstCreatePass){if(ct=My(c,Oe,4,C||null,k||null),ee!=null){let Fe=Ll(c.consts,ee);ct.localNames=[];for(let yt=0;yt<Fe.length;yt+=2)ct.localNames.push(Fe[yt],-1)}}else ct=c.data[Oe];return PH(ct,s,c,l,f,v,i,B),ee!=null&&fD(s,ct,_e),ct}var OH=LH;function LH(s,c,l,f){return vb(!0),c[Ir].createComment("")}var aw=(()=>{class s{log(l){console.log(l)}warn(l){console.warn(l)}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"platform"})}return s})();var yD=new Kt("");function qh(s){return!!s&&typeof s.then=="function"}function LF(s){return!!s&&typeof s.subscribe=="function"}var vD=new Kt("");function lw(s){return Ya([{provide:vD,multi:!0,useValue:s}])}var xD=(()=>{class s{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((l,f)=>{this.resolve=l,this.reject=f});appInits=pt(vD,{optional:!0})??[];injector=pt(jo);constructor(){}runInitializers(){if(this.initialized)return;let l=[];for(let v of this.appInits){let i=vo(this.injector,v);if(qh(i))l.push(i);else if(LF(i)){let C=new Promise((k,B)=>{i.subscribe({complete:k,error:B})});l.push(C)}}let f=()=>{this.done=!0,this.resolve()};Promise.all(l).then(()=>{f()}).catch(v=>{this.reject(v)}),l.length===0&&f(),this.initialized=!0}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),Oy=new Kt("");function FF(){FT(()=>{let s="";throw new tn(600,s)})}function kF(s){return s.isBoundToModule}var FH=10;var Nc=(()=>{class s{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=pt(Os);afterRenderManager=pt(cD);zonelessEnabled=pt(sm);rootEffectScheduler=pt(eS);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new Er;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=pt(kl);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(Ln(l=>!l))}constructor(){pt($h,{optional:!0})}whenStable(){let l;return new Promise(f=>{l=this.isStable.subscribe({next:v=>{v&&f()}})}).finally(()=>{l.unsubscribe()})}_injector=pt(Gr);_rendererFactory=null;get injector(){return this._injector}bootstrap(l,f){return this.bootstrapImpl(l,f)}bootstrapImpl(l,f,v=jo.NULL){return this._injector.get(pr).run(()=>{ir(10);let C=l instanceof ow;if(!this._injector.get(xD).done){let yt="";throw new tn(405,yt)}let B;C?B=l:B=this._injector.get(Ry).resolveComponentFactory(l),this.componentTypes.push(B.componentType);let ee=kF(B)?void 0:this._injector.get(fm),_e=f||B.selector,Oe=B.create(v,[],_e,ee),ct=Oe.location.nativeElement,Fe=Oe.injector.get(yD,null);return Fe?.registerApplication(ct),Oe.onDestroy(()=>{this.detachView(Oe.hostView),yy(this.components,Oe),Fe?.unregisterApplication(ct)}),this._loadComponent(Oe),ir(11,Oe),Oe})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){ir(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(tw.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new tn(101,!1);let l=Xn(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,Xn(l),this.afterTick.next(),ir(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(jh,null,{optional:!0}));let l=0;for(;this.dirtyFlags!==0&&l++<FH;)ir(14),this.synchronizeOnce(),ir(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let l=!1;if(this.dirtyFlags&7){let f=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:v}of this.allViews){if(!f&&!my(v))continue;let i=f&&!this.zonelessEnabled?0:1;mF(v,i),l=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}l||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:l})=>my(l))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(l){let f=l;this._views.push(f),f.attachToAppRef(this)}detachView(l){let f=l;yy(this._views,f),f.detachFromAppRef()}_loadComponent(l){this.attachView(l.hostView);try{this.tick()}catch(v){this.internalErrorHandler(v)}this.components.push(l),this._injector.get(Oy,[]).forEach(v=>v(l))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(l=>l()),this._views.slice().forEach(l=>l.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(l){return this._destroyListeners.push(l),()=>yy(this._destroyListeners,l)}destroy(){if(this._destroyed)throw new tn(406,!1);let l=this._injector;l.destroy&&!l.destroyed&&l.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function yy(s,c){let l=s.indexOf(c);l>-1&&s.splice(l,1)}function Ju(s,c,l,f){let v=Si(),i=Zu();if(kc(v,i,c)){let C=Ho(),k=_b();m5(k,v,s,c,l,f)}return Ju}var DJ=typeof document<"u"&&typeof document?.documentElement?.getAnimations=="function";var LS=class{destroy(c){}updateValue(c,l){}swap(c,l){let f=Math.min(c,l),v=Math.max(c,l),i=this.detach(v);if(v-f>1){let C=this.detach(f);this.attach(f,i),this.attach(v,C)}else this.attach(f,i)}move(c,l){this.attach(l,this.detach(c,!0))}};function aS(s,c,l,f,v){return s===l&&Object.is(c,f)?1:Object.is(v(s,c),v(l,f))?-1:0}function kH(s,c,l){let f,v,i=0,C=s.length-1,k=void 0;if(Array.isArray(c)){let B=c.length-1;for(;i<=C&&i<=B;){let ee=s.at(i),_e=c[i],Oe=aS(i,ee,i,_e,l);if(Oe!==0){Oe<0&&s.updateValue(i,_e),i++;continue}let ct=s.at(C),Fe=c[B],yt=aS(C,ct,B,Fe,l);if(yt!==0){yt<0&&s.updateValue(C,Fe),C--,B--;continue}let Xt=l(i,ee),At=l(C,ct),Lt=l(i,_e);if(Object.is(Lt,At)){let qn=l(B,Fe);Object.is(qn,Xt)?(s.swap(i,C),s.updateValue(C,Fe),B--,C--):s.move(C,i),s.updateValue(i,_e),i++;continue}if(f??=new $b,v??=JO(s,i,C,l),FS(s,f,i,Lt))s.updateValue(i,_e),i++,C++;else if(v.has(Lt))f.set(Xt,s.detach(i)),C--;else{let qn=s.create(i,c[i]);s.attach(i,qn),i++,C++}}for(;i<=B;)KO(s,f,l,i,c[i]),i++}else if(c!=null){let B=c[Symbol.iterator](),ee=B.next();for(;!ee.done&&i<=C;){let _e=s.at(i),Oe=ee.value,ct=aS(i,_e,i,Oe,l);if(ct!==0)ct<0&&s.updateValue(i,Oe),i++,ee=B.next();else{f??=new $b,v??=JO(s,i,C,l);let Fe=l(i,Oe);if(FS(s,f,i,Fe))s.updateValue(i,Oe),i++,C++,ee=B.next();else if(!v.has(Fe))s.attach(i,s.create(i,Oe)),i++,C++,ee=B.next();else{let yt=l(i,_e);f.set(yt,s.detach(i)),C--}}}for(;!ee.done;)KO(s,f,l,s.length,ee.value),ee=B.next()}for(;i<=C;)s.destroy(s.detach(C--));f?.forEach(B=>{s.destroy(B)})}function FS(s,c,l,f){return c!==void 0&&c.has(f)?(s.attach(l,c.get(f)),c.delete(f),!0):!1}function KO(s,c,l,f,v){if(FS(s,c,f,l(f,v)))s.updateValue(f,v);else{let i=s.create(f,v);s.attach(f,i)}}function JO(s,c,l,f){let v=new Set;for(let i=c;i<=l;i++)v.add(f(i,s.at(i)));return v}var $b=class{kvMap=new Map;_vMap=void 0;has(c){return this.kvMap.has(c)}delete(c){if(!this.has(c))return!1;let l=this.kvMap.get(c);return this._vMap!==void 0&&this._vMap.has(l)?(this.kvMap.set(c,this._vMap.get(l)),this._vMap.delete(l)):this.kvMap.delete(c),!0}get(c){return this.kvMap.get(c)}set(c,l){if(this.kvMap.has(c)){let f=this.kvMap.get(c);this._vMap===void 0&&(this._vMap=new Map);let v=this._vMap;for(;v.has(f);)f=v.get(f);v.set(f,l)}else this.kvMap.set(c,l)}forEach(c){for(let[l,f]of this.kvMap)if(c(f,l),this._vMap!==void 0){let v=this._vMap;for(;v.has(f);)f=v.get(f),c(f,l)}}};function Fs(s,c,l,f,v,i,C,k){nl("NgControlFlow");let B=Si(),ee=Ho(),_e=Ll(ee.consts,i);return wy(B,ee,s,c,l,f,v,_e,256,C,k),bD}function bD(s,c,l,f,v,i,C,k){nl("NgControlFlow");let B=Si(),ee=Ho(),_e=Ll(ee.consts,i);return wy(B,ee,s,c,l,f,v,_e,512,C,k),bD}function ks(s,c){nl("NgControlFlow");let l=Si(),f=Zu(),v=l[f]!==ta?l[f]:-1,i=v!==-1?Gb(l,ro+v):void 0,C=0;if(kc(l,f,s)){let k=Xn(null);try{if(i!==void 0&&bF(i,C),s!==-1){let B=ro+s,ee=Gb(l,B),_e=BS(l[Gn],B),Oe=EF(ee,_e,l),ct=rw(l,_e,c,{dehydratedView:Oe});Ay(ee,ct,C,hm(_e,Oe))}}finally{Xn(k)}}else if(i!==void 0){let k=xF(i,C);k!==void 0&&(k[qr]=c)}}var kS=class{lContainer;$implicit;$index;constructor(c,l,f){this.lContainer=c,this.$implicit=l,this.$index=f}get $count(){return this.lContainer.length-oo}};function wD(s){return s}var NS=class{hasEmptyBlock;trackByFn;liveCollection;constructor(c,l,f){this.hasEmptyBlock=c,this.trackByFn=l,this.liveCollection=f}};function ED(s,c,l,f,v,i,C,k,B,ee,_e,Oe,ct){nl("NgControlFlow");let Fe=Si(),yt=Ho(),Xt=B!==void 0,At=Si(),Lt=k?C.bind(At[hs][qr]):C,qn=new NS(Xt,Lt);At[ro+s]=qn,wy(Fe,yt,s+1,c,l,f,v,Ll(yt.consts,i),256),Xt&&wy(Fe,yt,s+2,B,ee,_e,Oe,Ll(yt.consts,ct),512)}var zS=class extends LS{lContainer;hostLView;templateTNode;operationsCounter=void 0;needsIndexUpdate=!1;constructor(c,l,f){super(),this.lContainer=c,this.hostLView=l,this.templateTNode=f}get length(){return this.lContainer.length-oo}at(c){return this.getLView(c)[qr].$implicit}attach(c,l){let f=l[Mh];this.needsIndexUpdate||=c!==this.length,Ay(this.lContainer,l,c,hm(this.templateTNode,f))}detach(c,l){return this.needsIndexUpdate||=c!==this.length-1,l&&NH(this.lContainer,c),zH(this.lContainer,c)}create(c,l){let f=zb(this.lContainer,this.templateTNode.tView.ssrId),v=rw(this.hostLView,this.templateTNode,new kS(this.lContainer,l,c),{dehydratedView:f});return this.operationsCounter?.recordCreate(),v}destroy(c){nw(c[Gn],c),this.operationsCounter?.recordDestroy()}updateValue(c,l){this.getLView(c)[qr].$implicit=l}reset(){this.needsIndexUpdate=!1,this.operationsCounter?.reset()}updateIndexes(){if(this.needsIndexUpdate)for(let c=0;c<this.length;c++)this.getLView(c)[qr].$index=c}getLView(c){return BH(this.lContainer,c)}};function TD(s){let c=Xn(null),l=Ac();try{let f=Si(),v=f[Gn],i=f[l],C=l+1,k=Gb(f,C);if(i.liveCollection===void 0){let ee=BS(v,C);i.liveCollection=new zS(k,f,ee)}else i.liveCollection.reset();let B=i.liveCollection;if(kH(B,s,i.trackByFn),B.updateIndexes(),i.hasEmptyBlock){let ee=Zu(),_e=B.length===0;if(kc(f,ee,_e)){let Oe=l+2,ct=Gb(f,Oe);if(_e){let Fe=BS(v,Oe),yt=EF(ct,Fe,f),Xt=rw(f,Fe,void 0,{dehydratedView:yt});Ay(ct,Xt,0,hm(Fe,yt))}else v.firstUpdatePass&&z5(ct),bF(ct,0)}}}finally{Xn(c)}}function Gb(s,c){return s[c]}function NH(s,c){if(s.length<=oo)return;let l=oo+c,f=s[l];f&&f[kh]&&(f[kh].skipLeaveAnimations=!0)}function zH(s,c){return xy(s,c)}function BH(s,c){return xF(s,c)}function BS(s,c){return py(s,c)}function Vr(s,c,l){let f=Si(),v=Zu();if(kc(f,v,c)){let i=Ho(),C=_b();c5(C,f,s,c,f[Ir],l)}return Vr}function VS(s,c,l,f,v){pD(c,s,l,v?"class":"style",f)}function cn(s,c,l,f){let v=Si(),i=v[Gn],C=s+ro,k=i.firstCreatePass?DF(C,v,2,c,p5,sO(),l,f):i.data[C];if(lF(k,v,s,c,NF),db(k)){let B=v[Gn];sF(B,v,k),AL(B,k,v)}return f!=null&&fD(v,k),cn}function un(){let s=Ho(),c=fs(),l=cF(c);return s.firstCreatePass&&CF(s,l),BI(l)&&VI(),NI(),l.classesWithoutHost!=null&&CU(l)&&VS(s,l,Si(),l.classesWithoutHost,!0),l.stylesWithoutHost!=null&&AU(l)&&VS(s,l,Si(),l.stylesWithoutHost,!1),un}function Pr(s,c,l,f){return cn(s,c,l,f),un(),Pr}function Ly(s,c,l,f){let v=Si(),i=v[Gn],C=s+ro,k=i.firstCreatePass?Q5(C,i,2,c,l,f):i.data[C];return lF(k,v,s,c,NF),f!=null&&fD(v,k),Ly}function Fy(){let s=fs(),c=cF(s);return BI(c)&&VI(),NI(),Fy}function cw(s,c,l,f){return Ly(s,c,l,f),Fy(),cw}var NF=(s,c,l,f,v)=>(vb(!0),jL(c[Ir],f,yO()));function Wh(){return Si()}function uw(s,c,l){let f=Si(),v=Zu();if(kc(f,v,c)){let i=Ho(),C=_b();aF(C,f,s,c,f[Ir],l)}return uw}var ky="en-US";var VH=ky;function zF(s){typeof s=="string"&&(VH=s.toLowerCase().replace(/_/g,"-"))}function rr(s,c,l){let f=Si(),v=Ho(),i=fs();return jH(v,f,f[Ir],i,s,c,l),rr}function jH(s,c,l,f,v,i,C){let k=!0,B=null;if((f.type&3||C)&&(B??=rS(f,c,i),nH(f,s,c,C,l,v,i,B)&&(k=!1)),k){let ee=f.outputs?.[v],_e=f.hostDirectiveOutputs?.[v];if(_e&&_e.length)for(let Oe=0;Oe<_e.length;Oe+=2){let ct=_e[Oe],Fe=_e[Oe+1];B??=rS(f,c,i),WO(f,c,ct,Fe,v,B)}if(ee&&ee.length)for(let Oe of ee)B??=rS(f,c,i),WO(f,c,Oe,v,v,B)}}function yr(s=1){return _O(s)}function UH(s,c){let l=null,f=w4(s);for(let v=0;v<c.length;v++){let i=c[v];if(i==="*"){l=v;continue}if(f===null?VL(s,i,!0):I4(f,i))return v}return l}function ID(s){let c=Si()[hs][ds];if(!c.projection){let l=s?s.length:1,f=c.projection=j2(l,null),v=f.slice(),i=c.child;for(;i!==null;){if(i.type!==128){let C=s?UH(i,s):0;C!==null&&(v[C]?v[C].projectionNext=i:f[C]=i,v[C]=i)}i=i.next}}}function SD(s,c=0,l,f,v,i){let C=Si(),k=Ho(),B=f?s+1:null;B!==null&&wy(C,k,B,f,v,i,null,l);let ee=My(k,ro+s,16,null,l||null);ee.projection===null&&(ee.projection=c),HI();let Oe=!C[Mh]||zI();C[hs][ds].projection[ee.projection]===null&&B!==null?HH(C,k,B):Oe&&!Kb(ee)&&n5(k,C,ee)}function HH(s,c,l){let f=ro+l,v=c.data[f],i=s[f],C=zb(i,v.tView.ssrId),k=rw(s,v,void 0,{dehydratedView:C});Ay(i,k,0,hm(v,C))}function Ib(s,c){return s<<17|c<<2}function Hh(s){return s>>17&32767}function $H(s){return(s&2)==2}function GH(s,c){return s&131071|c<<17}function jS(s){return s|2}function pm(s){return(s&131068)>>2}function lS(s,c){return s&-131069|c<<2}function qH(s){return(s&1)===1}function US(s){return s|1}function WH(s,c,l,f,v,i){let C=i?c.classBindings:c.styleBindings,k=Hh(C),B=pm(C);s[f]=l;let ee=!1,_e;if(Array.isArray(l)){let Oe=l;_e=Oe[1],(_e===null||em(Oe,_e)>0)&&(ee=!0)}else _e=l;if(v)if(B!==0){let ct=Hh(s[k+1]);s[f+1]=Ib(ct,k),ct!==0&&(s[ct+1]=lS(s[ct+1],f)),s[k+1]=GH(s[k+1],f)}else s[f+1]=Ib(k,0),k!==0&&(s[k+1]=lS(s[k+1],f)),k=f;else s[f+1]=Ib(B,0),k===0?k=f:s[B+1]=lS(s[B+1],f),B=f;ee&&(s[f+1]=jS(s[f+1])),QO(s,_e,f,!0),QO(s,_e,f,!1),ZH(c,_e,s,f,i),C=Ib(k,B),i?c.classBindings=C:c.styleBindings=C}function ZH(s,c,l,f,v){let i=v?s.residualClasses:s.residualStyles;i!=null&&typeof c=="string"&&em(i,c)>=0&&(l[f+1]=US(l[f+1]))}function QO(s,c,l,f){let v=s[l+1],i=c===null,C=f?Hh(v):pm(v),k=!1;for(;C!==0&&(k===!1||i);){let B=s[C],ee=s[C+1];XH(B,c)&&(k=!0,s[C+1]=f?US(ee):jS(ee)),C=f?Hh(ee):pm(ee)}k&&(s[l+1]=f?jS(v):US(v))}function XH(s,c){return s===null||c==null||(Array.isArray(s)?s[1]:s)===c?!0:Array.isArray(s)&&typeof c=="string"?em(s,c)>=0:!1}var tl={textEnd:0,key:0,keyEnd:0,value:0,valueEnd:0};function YH(s){return s.substring(tl.key,tl.keyEnd)}function KH(s){return JH(s),BF(s,VF(s,0,tl.textEnd))}function BF(s,c){let l=tl.textEnd;return l===c?-1:(c=tl.keyEnd=QH(s,tl.key=c,l),VF(s,c,l))}function JH(s){tl.key=0,tl.keyEnd=0,tl.value=0,tl.valueEnd=0,tl.textEnd=s.length}function VF(s,c,l){for(;c<l&&s.charCodeAt(c)<=32;)c++;return c}function QH(s,c,l){for(;c<l&&s.charCodeAt(c)>32;)c++;return c}function so(s,c){return t6(s,c,null,!0),so}function DD(s){n6(l6,e6,s,!0)}function e6(s,c){for(let l=KH(c);l>=0;l=BF(c,l))lb(s,YH(c),!0)}function t6(s,c,l,f){let v=Si(),i=Ho(),C=qI(2);if(i.firstUpdatePass&&UF(i,s,C,f),c!==ta&&kc(v,C,c)){let k=i.data[Ac()];HF(i,k,v,v[Ir],s,v[C+1]=u6(c,l),f,C)}}function n6(s,c,l,f){let v=Ho(),i=qI(2);v.firstUpdatePass&&UF(v,null,i,f);let C=Si();if(l!==ta&&kc(C,i,l)){let k=v.data[Ac()];if($F(k,f)&&!jF(v,i)){let B=f?k.classesWithoutHost:k.stylesWithoutHost;B!==null&&(l=rb(B,l||"")),VS(v,k,C,l,f)}else c6(v,k,C,C[Ir],C[i+1],C[i+1]=a6(s,c,l),f,i)}}function jF(s,c){return c>=s.expandoStartIndex}function UF(s,c,l,f){let v=s.data;if(v[l+1]===null){let i=v[Ac()],C=jF(s,l);$F(i,f)&&c===null&&!C&&(c=!1),c=i6(v,i,c,f),WH(v,i,c,l,C,f)}}function i6(s,c,l,f){let v=fO(s),i=f?c.residualClasses:c.residualStyles;if(v===null)(f?c.classBindings:c.styleBindings)===0&&(l=cS(null,s,c,l,f),l=Ey(l,c.attrs,f),i=null);else{let C=c.directiveStylingLast;if(C===-1||s[C]!==v)if(l=cS(v,s,c,l,f),i===null){let B=r6(s,c,f);B!==void 0&&Array.isArray(B)&&(B=cS(null,s,c,B[1],f),B=Ey(B,c.attrs,f),o6(s,c,f,B))}else i=s6(s,c,f)}return i!==void 0&&(f?c.residualClasses=i:c.residualStyles=i),l}function r6(s,c,l){let f=l?c.classBindings:c.styleBindings;if(pm(f)!==0)return s[Hh(f)]}function o6(s,c,l,f){let v=l?c.classBindings:c.styleBindings;s[Hh(v)]=f}function s6(s,c,l){let f,v=c.directiveEnd;for(let i=1+c.directiveStylingLast;i<v;i++){let C=s[i].hostAttrs;f=Ey(f,C,l)}return Ey(f,c.attrs,l)}function cS(s,c,l,f,v){let i=null,C=l.directiveEnd,k=l.directiveStylingLast;for(k===-1?k=l.directiveStart:k++;k<C&&(i=c[k],f=Ey(f,i.hostAttrs,v),i!==s);)k++;return s!==null&&(l.directiveStylingLast=k),f}function Ey(s,c,l){let f=l?1:2,v=-1;if(c!==null)for(let i=0;i<c.length;i++){let C=c[i];typeof C=="number"?v=C:v===f&&(Array.isArray(s)||(s=s===void 0?[]:["",s]),lb(s,C,l?!0:c[++i]))}return s===void 0?null:s}function a6(s,c,l){if(l==null||l==="")return us;let f=[],v=Ea(l);if(Array.isArray(v))for(let i=0;i<v.length;i++)s(f,v[i],!0);else if(typeof v=="object")for(let i in v)v.hasOwnProperty(i)&&s(f,i,v[i]);else typeof v=="string"&&c(f,v);return f}function l6(s,c,l){let f=String(c);f!==""&&!f.includes(" ")&&lb(s,f,l)}function c6(s,c,l,f,v,i,C,k){v===ta&&(v=us);let B=0,ee=0,_e=0<v.length?v[0]:null,Oe=0<i.length?i[0]:null;for(;_e!==null||Oe!==null;){let ct=B<v.length?v[B+1]:void 0,Fe=ee<i.length?i[ee+1]:void 0,yt=null,Xt;_e===Oe?(B+=2,ee+=2,ct!==Fe&&(yt=Oe,Xt=Fe)):Oe===null||_e!==null&&_e<Oe?(B+=2,yt=_e):(ee+=2,yt=Oe,Xt=Fe),yt!==null&&HF(s,c,l,f,yt,Xt,C,k),_e=B<v.length?v[B]:null,Oe=ee<i.length?i[ee]:null}}function HF(s,c,l,f,v,i,C,k){if(!(c.type&3))return;let B=s.data,ee=B[k+1],_e=qH(ee)?eL(B,c,l,v,pm(ee),C):void 0;if(!qb(_e)){qb(i)||$H(ee)&&(i=eL(B,null,l,v,k,C));let Oe=OI(Ac(),l);r5(f,C,Oe,v,i)}}function eL(s,c,l,f,v,i){let C=c===null,k;for(;v>0;){let B=s[v],ee=Array.isArray(B),_e=ee?B[1]:B,Oe=_e===null,ct=l[v+1];ct===ta&&(ct=Oe?us:void 0);let Fe=Oe?cb(ct,f):_e===f?ct:void 0;if(ee&&!qb(Fe)&&(Fe=cb(B,f)),qb(Fe)&&(k=Fe,C))return k;let yt=s[v+1];v=C?Hh(yt):pm(yt)}if(c!==null){let B=i?c.residualClasses:c.residualStyles;B!=null&&(k=cb(B,f))}return k}function qb(s){return s!==void 0}function u6(s,c){return s==null||s===""||(typeof c=="string"?s=s+c:typeof s=="object"&&(s=Ic(Ea(s)))),s}function $F(s,c){return(s.flags&(c?8:16))!==0}function Bn(s,c=""){let l=Si(),f=Ho(),v=s+ro,i=f.firstCreatePass?My(f,v,1,c,null):f.data[v],C=d6(f,l,i,c,s);l[v]=C,yb()&&dD(f,l,C,i),om(i,!1)}var d6=(s,c,l,f,v)=>(vb(!0),A4(c[Ir],f));function h6(s,c,l,f=""){return kc(s,Zu(),l)?c+Qp(l)+f:ta}function xo(s){return Ny("",s),xo}function Ny(s,c,l){let f=Si(),v=h6(f,s,c,l);return v!==ta&&f6(f,Ac(),v),Ny}function f6(s,c,l){let f=OI(c,s);M4(s[Ir],f,l)}function dw(s){return kc(Si(),Zu(),s)?Qp(s):ta}function p6(s,c,l){let f=Ho();if(f.firstCreatePass){let v=Ol(s);HS(l,f.data,f.blueprint,v,!0),HS(c,f.data,f.blueprint,v,!1)}}function HS(s,c,l,f,v){if(s=Ao(s),Array.isArray(s))for(let i=0;i<s.length;i++)HS(s[i],c,l,f,v);else{let i=Ho(),C=Si(),k=fs(),B=Sh(s)?s:Ao(s.provide),ee=CI(s),_e=k.providerIndexes&1048575,Oe=k.directiveStart,ct=k.providerIndexes>>20;if(Sh(s)||!s.multi){let Fe=new Bh(ee,v,ri,null),yt=dS(B,c,v?_e:_e+ct,Oe);yt===-1?(fS(Pb(k,C),i,B),uS(i,s,c.length),c.push(B),k.directiveStart++,k.directiveEnd++,v&&(k.providerIndexes+=1048576),l.push(Fe),C.push(Fe)):(l[yt]=Fe,C[yt]=Fe)}else{let Fe=dS(B,c,_e+ct,Oe),yt=dS(B,c,_e,_e+ct),Xt=Fe>=0&&l[Fe],At=yt>=0&&l[yt];if(v&&!At||!v&&!Xt){fS(Pb(k,C),i,B);let Lt=_6(v?g6:m6,l.length,v,f,ee,s);!v&&At&&(l[yt].providerFactory=Lt),uS(i,s,c.length,0),c.push(B),k.directiveStart++,k.directiveEnd++,v&&(k.providerIndexes+=1048576),l.push(Lt),C.push(Lt)}else{let Lt=GF(l[v?yt:Fe],ee,!v&&f);uS(i,s,Fe>-1?Fe:yt,Lt)}!v&&f&&At&&l[yt].componentProviders++}}}function uS(s,c,l,f){let v=Sh(c),i=Z2(c);if(v||i){let B=(i?Ao(c.useClass):c).prototype.ngOnDestroy;if(B){let ee=s.destroyHooks||(s.destroyHooks=[]);if(!v&&c.multi){let _e=ee.indexOf(l);_e===-1?ee.push(l,[f,B]):ee[_e+1].push(f,B)}else ee.push(l,B)}}}function GF(s,c,l){return l&&s.componentProviders++,s.multi.push(c)-1}function dS(s,c,l,f){for(let v=l;v<f;v++)if(c[v]===s)return v;return-1}function m6(s,c,l,f,v){return $S(this.multi,[])}function g6(s,c,l,f,v){let i=this.multi,C;if(this.providerFactory){let k=this.providerFactory.componentProviders,B=Ob(f,f[Gn],this.providerFactory.index,v);C=B.slice(0,k),$S(i,C);for(let ee=k;ee<B.length;ee++)C.push(B[ee])}else C=[],$S(i,C);return C}function $S(s,c){for(let l=0;l<s.length;l++){let f=s[l];c.push(f())}return c}function _6(s,c,l,f,v,i){let C=new Bh(s,l,ri,null);return C.multi=[],C.index=c,C.componentProviders=0,GF(C,v,f&&!l),C}function zy(s,c=[]){return l=>{l.providersResolver=(f,v)=>p6(f,v?v(s):s,c)}}function CD(s,c,l){let f=lO()+s,v=Si();return v[f]===ta?eH(v,f,l?c.call(l):c()):tH(v,f)}var Wb=class{ngModuleFactory;componentFactories;constructor(c,l){this.ngModuleFactory=c,this.componentFactories=l}},AD=(()=>{class s{compileModuleSync(l){return new Hb(l)}compileModuleAsync(l){return Promise.resolve(this.compileModuleSync(l))}compileModuleAndAllComponentsSync(l){let f=this.compileModuleSync(l),v=TI(l),i=zL(v.declarations).reduce((C,k)=>{let B=Cc(k);return B&&C.push(new Uh(B)),C},[]);return new Wb(f,i)}compileModuleAndAllComponentsAsync(l){return Promise.resolve(this.compileModuleAndAllComponentsSync(l))}clearCache(){}clearCacheFor(l){}getModuleId(l){}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var y6=(()=>{class s{zone=pt(pr);changeDetectionScheduler=pt(Sc);applicationRef=pt(Nc);applicationErrorHandler=pt(Os);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(l){this.applicationErrorHandler(l)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),qF=new Kt("",{factory:()=>!1});function MD({ngZoneFactory:s,ignoreChangesOutsideZone:c,scheduleInRootZone:l}){return s??=()=>new pr(di(Bt({},PD()),{scheduleInRootZone:l})),[{provide:pr,useFactory:s},{provide:Ml,multi:!0,useFactory:()=>{let f=pt(y6,{optional:!0});return()=>f.initialize()}},{provide:Ml,multi:!0,useFactory:()=>{let f=pt(v6);return()=>{f.initialize()}}},c===!0?{provide:JI,useValue:!0}:[],{provide:QI,useValue:l??ZL},{provide:Os,useFactory:()=>{let f=pt(pr),v=pt(Gr),i;return C=>{f.runOutsideAngular(()=>{v.destroyed&&!i?setTimeout(()=>{throw C}):(i??=v.get(Uo),i.handleError(C))})}}}]}function RD(s){let c=s?.ignoreChangesOutsideZone,l=s?.scheduleInRootZone,f=MD({ngZoneFactory:()=>{let v=PD(s);return v.scheduleInRootZone=l,v.shouldCoalesceEventChangeDetection&&nl("NgZone_CoalesceEvent"),new pr(v)},ignoreChangesOutsideZone:c,scheduleInRootZone:l});return Ya([{provide:qF,useValue:!0},{provide:sm,useValue:!1},f])}function PD(s){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:s?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:s?.runCoalescing??!1}}var v6=(()=>{class s{subscription=new wr;initialized=!1;zone=pt(pr);pendingTasks=pt(kl);initialize(){if(this.initialized)return;this.initialized=!0;let l=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(l=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{pr.assertNotInAngularZone(),queueMicrotask(()=>{l!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(l),l=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{pr.assertInAngularZone(),l??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var WF=(()=>{class s{applicationErrorHandler=pt(Os);appRef=pt(Nc);taskService=pt(kl);ngZone=pt(pr);zonelessEnabled=pt(sm);tracing=pt($h,{optional:!0});disableScheduling=pt(JI,{optional:!0})??!1;zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new wr;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(Fb):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(pt(QI,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()})),this.disableScheduling||=!this.zonelessEnabled&&(this.ngZone instanceof kb||!this.zoneIsDefined)}notify(l){if(!this.zonelessEnabled&&l===5)return;let f=!1;switch(l){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2,f=!0;break}case 12:{this.appRef.dirtyFlags|=16,f=!0;break}case 13:{this.appRef.dirtyFlags|=2,f=!0;break}case 11:{f=!0;break}case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick(f))return;let v=this.useMicrotaskScheduler?NO:XL;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>v(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>v(()=>this.tick()))}shouldScheduleTick(l){return!(this.disableScheduling&&!l||this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(Fb+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let l=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(f){this.taskService.remove(l),this.applicationErrorHandler(f)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,NO(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(l)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let l=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(l)}}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function x6(){return typeof $localize<"u"&&$localize.locale||ky}var OD=new Kt("",{providedIn:"root",factory:()=>pt(OD,{optional:!0,skipSelf:!0})||x6()});function $o(s){return O2(s)}function By(s,c){return Dx(s,c?.equal)}var ZF=class{[cs];constructor(c){this[cs]=c}destroy(){this[cs].destroy()}};var JF=Symbol("InputSignalNode#UNSET"),L6=di(Bt({},Cx),{transformFn:void 0,applyValueToInputSignal(s,c){jp(s,c)}});function QF(s,c){let l=Object.create(L6);l.value=s,l.transformFn=c?.transform;function f(){if(zp(l),l.value===JF){let v=null;throw new tn(-950,v)}return l.value}return f[cs]=l,f}var ym=class{attributeName;constructor(c){this.attributeName=c}__NG_ELEMENT_ID__=()=>Iy(this.attributeName);toString(){return`HostAttributeToken ${this.attributeName}`}},F6=new Kt("");F6.__NG_ELEMENT_ID__=s=>{let c=fs();if(c===null)throw new tn(204,!1);if(c.type&2)return c.value;if(s&8)return null;throw new tn(204,!1)};function XF(s,c){return QF(s,c)}function k6(s){return QF(JF,s)}var zc=(XF.required=k6,XF);var LD=new Kt(""),N6=new Kt("");function Vy(s){return!s.moduleRef}function z6(s){let c=Vy(s)?s.r3Injector:s.moduleRef.injector,l=c.get(pr);return l.run(()=>{Vy(s)?s.r3Injector.resolveInjectorInitializers():s.moduleRef.resolveInjectorInitializers();let f=c.get(Os),v;if(l.runOutsideAngular(()=>{v=l.onError.subscribe({next:f})}),Vy(s)){let i=()=>c.destroy(),C=s.platformInjector.get(LD);C.add(i),c.onDestroy(()=>{v.unsubscribe(),C.delete(i)})}else{let i=()=>s.moduleRef.destroy(),C=s.platformInjector.get(LD);C.add(i),s.moduleRef.onDestroy(()=>{yy(s.allPlatformModules,s.moduleRef),v.unsubscribe(),C.delete(i)})}return V6(f,l,()=>{let i=c.get(kl),C=i.add(),k=c.get(xD);return k.runInitializers(),k.donePromise.then(()=>{let B=c.get(OD,ky);if(zF(B||ky),!c.get(N6,!0))return Vy(s)?c.get(Nc):(s.allPlatformModules.push(s.moduleRef),s.moduleRef);if(Vy(s)){let _e=c.get(Nc);return s.rootComponent!==void 0&&_e.bootstrap(s.rootComponent),_e}else return B6?.(s.moduleRef,s.allPlatformModules),s.moduleRef}).finally(()=>void i.remove(C))})})}var B6;function V6(s,c,l){try{let f=l();return qh(f)?f.catch(v=>{throw c.runOutsideAngular(()=>s(v)),v}):f}catch(f){throw c.runOutsideAngular(()=>s(f)),f}}var hw=null;function j6(s=[],c){return jo.create({name:c,providers:[{provide:ly,useValue:"platform"},{provide:LD,useValue:new Set([()=>hw=null])},...s]})}function U6(s=[]){if(hw)return hw;let c=j6(s);return hw=c,FF(),H6(c),c}function H6(s){let c=s.get(Xb,null);vo(s,()=>{c?.forEach(l=>l())})}var vm=(()=>{class s{static __NG_ELEMENT_ID__=$6}return s})();function $6(s){return G6(fs(),Si(),(s&16)===16)}function G6(s,c,l){if(Wu(s)&&!l){let f=xa(s.index,c);return new Vh(f,f)}else if(s.type&175){let f=c[hs];return new Vh(f,c)}return null}function ek(s){let{rootComponent:c,appProviders:l,platformProviders:f,platformRef:v}=s;ir(8);try{let i=v?.injector??U6(f),C=[MD({}),{provide:Sc,useExisting:WF},xO,...l||[]],k=new by({providers:C,parent:i,debugName:"",runEnvironmentInitializers:!1});return z6({r3Injector:k.injector,platformInjector:i,rootComponent:c})}catch(i){return Promise.reject(i)}finally{ir(9)}}function Bc(s){return typeof s=="boolean"?s:s!=null&&s!=="false"}function tk(s){let c=Cc(s);if(!c)return null;let l=new Uh(c);return{get selector(){return l.selector},get type(){return l.componentType},get inputs(){return l.inputs},get outputs(){return l.outputs},get ngContentSelectors(){return l.ngContentSelectors},get isStandalone(){return c.standalone},get isSignal(){return c.signals}}}var rk=null;function Ta(){return rk}function kD(s){rk??=s}var jy=class{},Uy=(()=>{class s{historyGo(l){throw new Error("")}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>pt(ok),providedIn:"platform"})}return s})(),ND=new Kt(""),ok=(()=>{class s extends Uy{_location;_history;_doc=pt(Qi);constructor(){super(),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return Ta().getBaseHref(this._doc)}onPopState(l){let f=Ta().getGlobalEventTarget(this._doc,"window");return f.addEventListener("popstate",l,!1),()=>f.removeEventListener("popstate",l)}onHashChange(l){let f=Ta().getGlobalEventTarget(this._doc,"window");return f.addEventListener("hashchange",l,!1),()=>f.removeEventListener("hashchange",l)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(l){this._location.pathname=l}pushState(l,f,v){this._history.pushState(l,f,v)}replaceState(l,f,v){this._history.replaceState(l,f,v)}forward(){this._history.forward()}back(){this._history.back()}historyGo(l=0){this._history.go(l)}getState(){return this._history.state}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>new s,providedIn:"platform"})}return s})();function fw(s,c){return s?c?s.endsWith("/")?c.startsWith("/")?s+c.slice(1):s+c:c.startsWith("/")?s+c:`${s}/${c}`:s:c}function nk(s){let c=s.search(/#|\?|$/);return s[c-1]==="/"?s.slice(0,c-1)+s.slice(c):s}function rl(s){return s&&s[0]!=="?"?`?${s}`:s}var ol=(()=>{class s{historyGo(l){throw new Error("")}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>pt(mw),providedIn:"root"})}return s})(),pw=new Kt(""),mw=(()=>{class s extends ol{_platformLocation;_baseHref;_removeListenerFns=[];constructor(l,f){super(),this._platformLocation=l,this._baseHref=f??this._platformLocation.getBaseHrefFromDOM()??pt(Qi).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(l){this._removeListenerFns.push(this._platformLocation.onPopState(l),this._platformLocation.onHashChange(l))}getBaseHref(){return this._baseHref}prepareExternalUrl(l){return fw(this._baseHref,l)}path(l=!1){let f=this._platformLocation.pathname+rl(this._platformLocation.search),v=this._platformLocation.hash;return v&&l?`${f}${v}`:f}pushState(l,f,v,i){let C=this.prepareExternalUrl(v+rl(i));this._platformLocation.pushState(l,f,C)}replaceState(l,f,v,i){let C=this.prepareExternalUrl(v+rl(i));this._platformLocation.replaceState(l,f,C)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(l=0){this._platformLocation.historyGo?.(l)}static \u0275fac=function(f){return new(f||s)(ln(Uy),ln(pw,8))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),Qu=(()=>{class s{_subject=new Er;_basePath;_locationStrategy;_urlChangeListeners=[];_urlChangeSubscription=null;constructor(l){this._locationStrategy=l;let f=this._locationStrategy.getBaseHref();this._basePath=Z6(nk(ik(f))),this._locationStrategy.onPopState(v=>{this._subject.next({url:this.path(!0),pop:!0,state:v.state,type:v.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(l=!1){return this.normalize(this._locationStrategy.path(l))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(l,f=""){return this.path()==this.normalize(l+rl(f))}normalize(l){return s.stripTrailingSlash(W6(this._basePath,ik(l)))}prepareExternalUrl(l){return l&&l[0]!=="/"&&(l="/"+l),this._locationStrategy.prepareExternalUrl(l)}go(l,f="",v=null){this._locationStrategy.pushState(v,"",l,f),this._notifyUrlChangeListeners(this.prepareExternalUrl(l+rl(f)),v)}replaceState(l,f="",v=null){this._locationStrategy.replaceState(v,"",l,f),this._notifyUrlChangeListeners(this.prepareExternalUrl(l+rl(f)),v)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(l=0){this._locationStrategy.historyGo?.(l)}onUrlChange(l){return this._urlChangeListeners.push(l),this._urlChangeSubscription??=this.subscribe(f=>{this._notifyUrlChangeListeners(f.url,f.state)}),()=>{let f=this._urlChangeListeners.indexOf(l);this._urlChangeListeners.splice(f,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(l="",f){this._urlChangeListeners.forEach(v=>v(l,f))}subscribe(l,f,v){return this._subject.subscribe({next:l,error:f??void 0,complete:v??void 0})}static normalizeQueryParams=rl;static joinWithSlash=fw;static stripTrailingSlash=nk;static \u0275fac=function(f){return new(f||s)(ln(ol))};static \u0275prov=Wt({token:s,factory:()=>q6(),providedIn:"root"})}return s})();function q6(){return new Qu(ln(ol))}function W6(s,c){if(!s||!c.startsWith(s))return c;let l=c.substring(s.length);return l===""||["/",";","?","#"].includes(l[0])?l:c}function ik(s){return s.replace(/\/index.html$/,"")}function Z6(s){if(new RegExp("^(https?:)?//").test(s)){let[,l]=s.split(/\/\/[^\/]+/);return l}return s}var zD=(()=>{class s extends ol{_platformLocation;_baseHref="";_removeListenerFns=[];constructor(l,f){super(),this._platformLocation=l,f!=null&&(this._baseHref=f)}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(l){this._removeListenerFns.push(this._platformLocation.onPopState(l),this._platformLocation.onHashChange(l))}getBaseHref(){return this._baseHref}path(l=!1){let f=this._platformLocation.hash??"#";return f.length>0?f.substring(1):f}prepareExternalUrl(l){let f=fw(this._baseHref,l);return f.length>0?"#"+f:f}pushState(l,f,v,i){let C=this.prepareExternalUrl(v+rl(i))||this._platformLocation.pathname;this._platformLocation.pushState(l,f,C)}replaceState(l,f,v,i){let C=this.prepareExternalUrl(v+rl(i))||this._platformLocation.pathname;this._platformLocation.replaceState(l,f,C)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(l=0){this._platformLocation.historyGo?.(l)}static \u0275fac=function(f){return new(f||s)(ln(Uy),ln(pw,8))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})();function Hy(s,c){c=encodeURIComponent(c);for(let l of s.split(";")){let f=l.indexOf("="),[v,i]=f==-1?[l,""]:[l.slice(0,f),l.slice(f+1)];if(v.trim()===c)return decodeURIComponent(i)}return null}var Zh=class{};var VD="browser";function sk(s){return s===VD}var ak=(()=>{class s{static \u0275prov=Wt({token:s,providedIn:"root",factory:()=>new BD(pt(Qi),window)})}return s})(),BD=class{document;window;offset=()=>[0,0];constructor(c,l){this.document=c,this.window=l}setOffset(c){Array.isArray(c)?this.offset=()=>c:this.offset=c}getScrollPosition(){return[this.window.scrollX,this.window.scrollY]}scrollToPosition(c,l){this.window.scrollTo(di(Bt({},l),{left:c[0],top:c[1]}))}scrollToAnchor(c,l){let f=K6(this.document,c);f&&(this.scrollToElement(f,l),f.focus())}setHistoryScrollRestoration(c){try{this.window.history.scrollRestoration=c}catch{console.warn(Dc(2400,!1))}}scrollToElement(c,l){let f=c.getBoundingClientRect(),v=f.left+this.window.pageXOffset,i=f.top+this.window.pageYOffset,C=this.offset();this.window.scrollTo(di(Bt({},l),{left:v-C[0],top:i-C[1]}))}};function K6(s,c){let l=s.getElementById(c)||s.getElementsByName(c)[0];if(l)return l;if(typeof s.createTreeWalker=="function"&&s.body&&typeof s.body.attachShadow=="function"){let f=s.createTreeWalker(s.body,NodeFilter.SHOW_ELEMENT),v=f.currentNode;for(;v;){let i=v.shadowRoot;if(i){let C=i.getElementById(c)||i.querySelector(`[name="${c}"]`);if(C)return C}v=f.nextNode()}}return null}var $y=class{_doc;constructor(c){this._doc=c}manager},gw=(()=>{class s extends $y{constructor(l){super(l)}supports(l){return!0}addEventListener(l,f,v,i){return l.addEventListener(f,v,i),()=>this.removeEventListener(l,f,v,i)}removeEventListener(l,f,v,i){return l.removeEventListener(f,v,i)}static \u0275fac=function(f){return new(f||s)(ln(Qi))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),yw=new Kt(""),GD=(()=>{class s{_zone;_plugins;_eventNameToPlugin=new Map;constructor(l,f){this._zone=f,l.forEach(C=>{C.manager=this});let v=l.filter(C=>!(C instanceof gw));this._plugins=v.slice().reverse();let i=l.find(C=>C instanceof gw);i&&this._plugins.push(i)}addEventListener(l,f,v,i){return this._findPluginFor(f).addEventListener(l,f,v,i)}getZone(){return this._zone}_findPluginFor(l){let f=this._eventNameToPlugin.get(l);if(f)return f;if(f=this._plugins.find(i=>i.supports(l)),!f)throw new tn(5101,!1);return this._eventNameToPlugin.set(l,f),f}static \u0275fac=function(f){return new(f||s)(ln(yw),ln(pr))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),jD="ng-app-id";function lk(s){for(let c of s)c.remove()}function ck(s,c){let l=c.createElement("style");return l.textContent=s,l}function Q6(s,c,l,f){let v=s.head?.querySelectorAll(`style[${jD}="${c}"],link[${jD}="${c}"]`);if(v)for(let i of v)i.removeAttribute(jD),i instanceof HTMLLinkElement?f.set(i.href.slice(i.href.lastIndexOf("/")+1),{usage:0,elements:[i]}):i.textContent&&l.set(i.textContent,{usage:0,elements:[i]})}function HD(s,c){let l=c.createElement("link");return l.setAttribute("rel","stylesheet"),l.setAttribute("href",s),l}var qD=(()=>{class s{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;constructor(l,f,v,i={}){this.doc=l,this.appId=f,this.nonce=v,Q6(l,f,this.inline,this.external),this.hosts.add(l.head)}addStyles(l,f){for(let v of l)this.addUsage(v,this.inline,ck);f?.forEach(v=>this.addUsage(v,this.external,HD))}removeStyles(l,f){for(let v of l)this.removeUsage(v,this.inline);f?.forEach(v=>this.removeUsage(v,this.external))}addUsage(l,f,v){let i=f.get(l);i?i.usage++:f.set(l,{usage:1,elements:[...this.hosts].map(C=>this.addElement(C,v(l,this.doc)))})}removeUsage(l,f){let v=f.get(l);v&&(v.usage--,v.usage<=0&&(lk(v.elements),f.delete(l)))}ngOnDestroy(){for(let[,{elements:l}]of[...this.inline,...this.external])lk(l);this.hosts.clear()}addHost(l){this.hosts.add(l);for(let[f,{elements:v}]of this.inline)v.push(this.addElement(l,ck(f,this.doc)));for(let[f,{elements:v}]of this.external)v.push(this.addElement(l,HD(f,this.doc)))}removeHost(l){this.hosts.delete(l)}addElement(l,f){return this.nonce&&f.setAttribute("nonce",this.nonce),l.appendChild(f)}static \u0275fac=function(f){return new(f||s)(ln(Qi),ln(Zb),ln(gm,8),ln(Yu))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),UD={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},WD=/%COMP%/g;var dk="%COMP%",e$=`_nghost-${dk}`,t$=`_ngcontent-${dk}`,n$=!0,i$=new Kt("",{providedIn:"root",factory:()=>n$});function r$(s){return t$.replace(WD,s)}function o$(s){return e$.replace(WD,s)}function hk(s,c){return c.map(l=>l.replace(WD,s))}var ZD=(()=>{class s{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;platformId;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(l,f,v,i,C,k,B,ee=null,_e=null){this.eventManager=l,this.sharedStylesHost=f,this.appId=v,this.removeStylesOnCompDestroy=i,this.doc=C,this.platformId=k,this.ngZone=B,this.nonce=ee,this.tracingService=_e,this.platformIsServer=!1,this.defaultRenderer=new Gy(l,C,B,this.platformIsServer,this.tracingService)}createRenderer(l,f){if(!l||!f)return this.defaultRenderer;let v=this.getOrCreateRenderer(l,f);return v instanceof _w?v.applyToHost(l):v instanceof qy&&v.applyStyles(),v}getOrCreateRenderer(l,f){let v=this.rendererByCompId,i=v.get(f.id);if(!i){let C=this.doc,k=this.ngZone,B=this.eventManager,ee=this.sharedStylesHost,_e=this.removeStylesOnCompDestroy,Oe=this.platformIsServer,ct=this.tracingService;switch(f.encapsulation){case Mc.Emulated:i=new _w(B,ee,f,this.appId,_e,C,k,Oe,ct);break;case Mc.ShadowDom:return new $D(B,ee,l,f,C,k,this.nonce,Oe,ct);default:i=new qy(B,ee,f,_e,C,k,Oe,ct);break}v.set(f.id,i)}return i}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(l){this.rendererByCompId.delete(l)}static \u0275fac=function(f){return new(f||s)(ln(GD),ln(qD),ln(Zb),ln(i$),ln(Qi),ln(Yu),ln(pr),ln(gm),ln($h,8))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),Gy=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(c,l,f,v,i){this.eventManager=c,this.doc=l,this.ngZone=f,this.platformIsServer=v,this.tracingService=i}destroy(){}destroyNode=null;createElement(c,l){return l?this.doc.createElementNS(UD[l]||l,c):this.doc.createElement(c)}createComment(c){return this.doc.createComment(c)}createText(c){return this.doc.createTextNode(c)}appendChild(c,l){(uk(c)?c.content:c).appendChild(l)}insertBefore(c,l,f){c&&(uk(c)?c.content:c).insertBefore(l,f)}removeChild(c,l){l.remove()}selectRootElement(c,l){let f=typeof c=="string"?this.doc.querySelector(c):c;if(!f)throw new tn(-5104,!1);return l||(f.textContent=""),f}parentNode(c){return c.parentNode}nextSibling(c){return c.nextSibling}setAttribute(c,l,f,v){if(v){l=v+":"+l;let i=UD[v];i?c.setAttributeNS(i,l,f):c.setAttribute(l,f)}else c.setAttribute(l,f)}removeAttribute(c,l,f){if(f){let v=UD[f];v?c.removeAttributeNS(v,l):c.removeAttribute(`${f}:${l}`)}else c.removeAttribute(l)}addClass(c,l){c.classList.add(l)}removeClass(c,l){c.classList.remove(l)}setStyle(c,l,f,v){v&(Pc.DashCase|Pc.Important)?c.style.setProperty(l,f,v&Pc.Important?"important":""):c.style[l]=f}removeStyle(c,l,f){f&Pc.DashCase?c.style.removeProperty(l):c.style[l]=""}setProperty(c,l,f){c!=null&&(c[l]=f)}setValue(c,l){c.nodeValue=l}listen(c,l,f,v){if(typeof c=="string"&&(c=Ta().getGlobalEventTarget(this.doc,c),!c))throw new tn(5102,!1);let i=this.decoratePreventDefault(f);return this.tracingService?.wrapEventListener&&(i=this.tracingService.wrapEventListener(c,l,i)),this.eventManager.addEventListener(c,l,i,v)}decoratePreventDefault(c){return l=>{if(l==="__ngUnwrap__")return c;c(l)===!1&&l.preventDefault()}}};function uk(s){return s.tagName==="TEMPLATE"&&s.content!==void 0}var $D=class extends Gy{sharedStylesHost;hostEl;shadowRoot;constructor(c,l,f,v,i,C,k,B,ee){super(c,i,C,B,ee),this.sharedStylesHost=l,this.hostEl=f,this.shadowRoot=f.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);let _e=v.styles;_e=hk(v.id,_e);for(let ct of _e){let Fe=document.createElement("style");k&&Fe.setAttribute("nonce",k),Fe.textContent=ct,this.shadowRoot.appendChild(Fe)}let Oe=v.getExternalStyles?.();if(Oe)for(let ct of Oe){let Fe=HD(ct,i);k&&Fe.setAttribute("nonce",k),this.shadowRoot.appendChild(Fe)}}nodeOrShadowRoot(c){return c===this.hostEl?this.shadowRoot:c}appendChild(c,l){return super.appendChild(this.nodeOrShadowRoot(c),l)}insertBefore(c,l,f){return super.insertBefore(this.nodeOrShadowRoot(c),l,f)}removeChild(c,l){return super.removeChild(null,l)}parentNode(c){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(c)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}},qy=class extends Gy{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(c,l,f,v,i,C,k,B,ee){super(c,i,C,k,B),this.sharedStylesHost=l,this.removeStylesOnCompDestroy=v;let _e=f.styles;this.styles=ee?hk(ee,_e):_e,this.styleUrls=f.getExternalStyles?.(ee)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&dm.size===0&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},_w=class extends qy{contentAttr;hostAttr;constructor(c,l,f,v,i,C,k,B,ee){let _e=v+"-"+f.id;super(c,l,f,i,C,k,B,ee,_e),this.contentAttr=r$(_e),this.hostAttr=o$(_e)}applyToHost(c){this.applyStyles(),this.setAttribute(c,this.hostAttr,"")}createElement(c,l){let f=super.createElement(c,l);return super.setAttribute(f,this.contentAttr,""),f}};var vw=class s extends jy{supportsDOMEvents=!0;static makeCurrent(){kD(new s)}onAndCancel(c,l,f,v){return c.addEventListener(l,f,v),()=>{c.removeEventListener(l,f,v)}}dispatchEvent(c,l){c.dispatchEvent(l)}remove(c){c.remove()}createElement(c,l){return l=l||this.getDefaultDocument(),l.createElement(c)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(c){return c.nodeType===Node.ELEMENT_NODE}isShadowRoot(c){return c instanceof DocumentFragment}getGlobalEventTarget(c,l){return l==="window"?window:l==="document"?c:l==="body"?c.body:null}getBaseHref(c){let l=s$();return l==null?null:a$(l)}resetBaseElement(){Wy=null}getUserAgent(){return window.navigator.userAgent}getCookie(c){return Hy(document.cookie,c)}},Wy=null;function s$(){return Wy=Wy||document.head.querySelector("base"),Wy?Wy.getAttribute("href"):null}function a$(s){return new URL(s,document.baseURI).pathname}var l$=(()=>{class s{build(){return new XMLHttpRequest}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),fk=["alt","control","meta","shift"],c$={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},u$={alt:s=>s.altKey,control:s=>s.ctrlKey,meta:s=>s.metaKey,shift:s=>s.shiftKey},pk=(()=>{class s extends $y{constructor(l){super(l)}supports(l){return s.parseEventName(l)!=null}addEventListener(l,f,v,i){let C=s.parseEventName(f),k=s.eventCallback(C.fullKey,v,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>Ta().onAndCancel(l,C.domEventName,k,i))}static parseEventName(l){let f=l.toLowerCase().split("."),v=f.shift();if(f.length===0||!(v==="keydown"||v==="keyup"))return null;let i=s._normalizeKey(f.pop()),C="",k=f.indexOf("code");if(k>-1&&(f.splice(k,1),C="code."),fk.forEach(ee=>{let _e=f.indexOf(ee);_e>-1&&(f.splice(_e,1),C+=ee+".")}),C+=i,f.length!=0||i.length===0)return null;let B={};return B.domEventName=v,B.fullKey=C,B}static matchEventFullKeyCode(l,f){let v=c$[l.key]||l.key,i="";return f.indexOf("code.")>-1&&(v=l.code,i="code."),v==null||!v?!1:(v=v.toLowerCase(),v===" "?v="space":v==="."&&(v="dot"),fk.forEach(C=>{if(C!==v){let k=u$[C];k(l)&&(i+=C+".")}}),i+=v,i===f)}static eventCallback(l,f,v){return i=>{s.matchEventFullKeyCode(i,l)&&v.runGuarded(()=>f(i))}}static _normalizeKey(l){return l==="esc"?"escape":l}static \u0275fac=function(f){return new(f||s)(ln(Qi))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})();function XD(s,c,l){let f=Bt({rootComponent:s,platformRef:l?.platformRef},d$(c));return ek(f)}function d$(s){return{appProviders:[...g$,...s?.providers??[]],platformProviders:m$}}function h$(){vw.makeCurrent()}function f$(){return new Uo}function p$(){return ZS(document),document}var m$=[{provide:Yu,useValue:VD},{provide:Xb,useValue:h$,multi:!0},{provide:Qi,useFactory:p$}];var g$=[{provide:ly,useValue:"root"},{provide:Uo,useFactory:f$},{provide:yw,useClass:gw,multi:!0,deps:[Qi]},{provide:yw,useClass:pk,multi:!0,deps:[Qi]},ZD,qD,GD,{provide:jh,useExisting:ZD},{provide:Zh,useClass:l$},[]];var bm=class{},Zy=class{},td=class s{headers;normalizedNames=new Map;lazyInit;lazyUpdate=null;constructor(c){c?typeof c=="string"?this.lazyInit=()=>{this.headers=new Map,c.split(`
`).forEach(l=>{let f=l.indexOf(":");if(f>0){let v=l.slice(0,f),i=l.slice(f+1).trim();this.addHeaderEntry(v,i)}})}:typeof Headers<"u"&&c instanceof Headers?(this.headers=new Map,c.forEach((l,f)=>{this.addHeaderEntry(f,l)})):this.lazyInit=()=>{this.headers=new Map,Object.entries(c).forEach(([l,f])=>{this.setHeaderEntries(l,f)})}:this.headers=new Map}has(c){return this.init(),this.headers.has(c.toLowerCase())}get(c){this.init();let l=this.headers.get(c.toLowerCase());return l&&l.length>0?l[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(c){return this.init(),this.headers.get(c.toLowerCase())||null}append(c,l){return this.clone({name:c,value:l,op:"a"})}set(c,l){return this.clone({name:c,value:l,op:"s"})}delete(c,l){return this.clone({name:c,value:l,op:"d"})}maybeSetNormalizedName(c,l){this.normalizedNames.has(l)||this.normalizedNames.set(l,c)}init(){this.lazyInit&&(this.lazyInit instanceof s?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(c=>this.applyUpdate(c)),this.lazyUpdate=null))}copyFrom(c){c.init(),Array.from(c.headers.keys()).forEach(l=>{this.headers.set(l,c.headers.get(l)),this.normalizedNames.set(l,c.normalizedNames.get(l))})}clone(c){let l=new s;return l.lazyInit=this.lazyInit&&this.lazyInit instanceof s?this.lazyInit:this,l.lazyUpdate=(this.lazyUpdate||[]).concat([c]),l}applyUpdate(c){let l=c.name.toLowerCase();switch(c.op){case"a":case"s":let f=c.value;if(typeof f=="string"&&(f=[f]),f.length===0)return;this.maybeSetNormalizedName(c.name,l);let v=(c.op==="a"?this.headers.get(l):void 0)||[];v.push(...f),this.headers.set(l,v);break;case"d":let i=c.value;if(!i)this.headers.delete(l),this.normalizedNames.delete(l);else{let C=this.headers.get(l);if(!C)return;C=C.filter(k=>i.indexOf(k)===-1),C.length===0?(this.headers.delete(l),this.normalizedNames.delete(l)):this.headers.set(l,C)}break}}addHeaderEntry(c,l){let f=c.toLowerCase();this.maybeSetNormalizedName(c,f),this.headers.has(f)?this.headers.get(f).push(l):this.headers.set(f,[l])}setHeaderEntries(c,l){let f=(Array.isArray(l)?l:[l]).map(i=>i.toString()),v=c.toLowerCase();this.headers.set(v,f),this.maybeSetNormalizedName(c,v)}forEach(c){this.init(),Array.from(this.normalizedNames.keys()).forEach(l=>c(this.normalizedNames.get(l),this.headers.get(l)))}};var bw=class{encodeKey(c){return mk(c)}encodeValue(c){return mk(c)}decodeKey(c){return decodeURIComponent(c)}decodeValue(c){return decodeURIComponent(c)}};function _$(s,c){let l=new Map;return s.length>0&&s.replace(/^\?/,"").split("&").forEach(v=>{let i=v.indexOf("="),[C,k]=i==-1?[c.decodeKey(v),""]:[c.decodeKey(v.slice(0,i)),c.decodeValue(v.slice(i+1))],B=l.get(C)||[];B.push(k),l.set(C,B)}),l}var y$=/%(\d[a-f0-9])/gi,v$={40:"@","3A":":",24:"$","2C":",","3B":";","3D":"=","3F":"?","2F":"/"};function mk(s){return encodeURIComponent(s).replace(y$,(c,l)=>v$[l]??c)}function xw(s){return`${s}`}var Vc=class s{map;encoder;updates=null;cloneFrom=null;constructor(c={}){if(this.encoder=c.encoder||new bw,c.fromString){if(c.fromObject)throw new tn(2805,!1);this.map=_$(c.fromString,this.encoder)}else c.fromObject?(this.map=new Map,Object.keys(c.fromObject).forEach(l=>{let f=c.fromObject[l],v=Array.isArray(f)?f.map(xw):[xw(f)];this.map.set(l,v)})):this.map=null}has(c){return this.init(),this.map.has(c)}get(c){this.init();let l=this.map.get(c);return l?l[0]:null}getAll(c){return this.init(),this.map.get(c)||null}keys(){return this.init(),Array.from(this.map.keys())}append(c,l){return this.clone({param:c,value:l,op:"a"})}appendAll(c){let l=[];return Object.keys(c).forEach(f=>{let v=c[f];Array.isArray(v)?v.forEach(i=>{l.push({param:f,value:i,op:"a"})}):l.push({param:f,value:v,op:"a"})}),this.clone(l)}set(c,l){return this.clone({param:c,value:l,op:"s"})}delete(c,l){return this.clone({param:c,value:l,op:"d"})}toString(){return this.init(),this.keys().map(c=>{let l=this.encoder.encodeKey(c);return this.map.get(c).map(f=>l+"="+this.encoder.encodeValue(f)).join("&")}).filter(c=>c!=="").join("&")}clone(c){let l=new s({encoder:this.encoder});return l.cloneFrom=this.cloneFrom||this,l.updates=(this.updates||[]).concat(c),l}init(){this.map===null&&(this.map=new Map),this.cloneFrom!==null&&(this.cloneFrom.init(),this.cloneFrom.keys().forEach(c=>this.map.set(c,this.cloneFrom.map.get(c))),this.updates.forEach(c=>{switch(c.op){case"a":case"s":let l=(c.op==="a"?this.map.get(c.param):void 0)||[];l.push(xw(c.value)),this.map.set(c.param,l);break;case"d":if(c.value!==void 0){let f=this.map.get(c.param)||[],v=f.indexOf(xw(c.value));v!==-1&&f.splice(v,1),f.length>0?this.map.set(c.param,f):this.map.delete(c.param)}else{this.map.delete(c.param);break}}}),this.cloneFrom=this.updates=null)}};var ww=class{map=new Map;set(c,l){return this.map.set(c,l),this}get(c){return this.map.has(c)||this.map.set(c,c.defaultValue()),this.map.get(c)}delete(c){return this.map.delete(c),this}has(c){return this.map.has(c)}keys(){return this.map.keys()}};function x$(s){switch(s){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"JSONP":return!1;default:return!0}}function gk(s){return typeof ArrayBuffer<"u"&&s instanceof ArrayBuffer}function _k(s){return typeof Blob<"u"&&s instanceof Blob}function yk(s){return typeof FormData<"u"&&s instanceof FormData}function b$(s){return typeof URLSearchParams<"u"&&s instanceof URLSearchParams}var vk="Content-Type",xk="Accept",bk="X-Request-URL",wk="text/plain",Ek="application/json",w$=`${Ek}, ${wk}, */*`,xm=class s{url;body=null;headers;context;reportProgress=!1;withCredentials=!1;credentials;keepalive=!1;cache;priority;mode;redirect;referrer;integrity;responseType="json";method;params;urlWithParams;transferCache;timeout;constructor(c,l,f,v){this.url=l,this.method=c.toUpperCase();let i;if(x$(this.method)||v?(this.body=f!==void 0?f:null,i=v):i=f,i){if(this.reportProgress=!!i.reportProgress,this.withCredentials=!!i.withCredentials,this.keepalive=!!i.keepalive,i.responseType&&(this.responseType=i.responseType),i.headers&&(this.headers=i.headers),i.context&&(this.context=i.context),i.params&&(this.params=i.params),i.priority&&(this.priority=i.priority),i.cache&&(this.cache=i.cache),i.credentials&&(this.credentials=i.credentials),typeof i.timeout=="number"){if(i.timeout<1||!Number.isInteger(i.timeout))throw new tn(2822,"");this.timeout=i.timeout}i.mode&&(this.mode=i.mode),i.redirect&&(this.redirect=i.redirect),i.integrity&&(this.integrity=i.integrity),i.referrer&&(this.referrer=i.referrer),this.transferCache=i.transferCache}if(this.headers??=new td,this.context??=new ww,!this.params)this.params=new Vc,this.urlWithParams=l;else{let C=this.params.toString();if(C.length===0)this.urlWithParams=l;else{let k=l.indexOf("?"),B=k===-1?"?":k<l.length-1?"&":"";this.urlWithParams=l+B+C}}}serializeBody(){return this.body===null?null:typeof this.body=="string"||gk(this.body)||_k(this.body)||yk(this.body)||b$(this.body)?this.body:this.body instanceof Vc?this.body.toString():typeof this.body=="object"||typeof this.body=="boolean"||Array.isArray(this.body)?JSON.stringify(this.body):this.body.toString()}detectContentTypeHeader(){return this.body===null||yk(this.body)?null:_k(this.body)?this.body.type||null:gk(this.body)?null:typeof this.body=="string"?wk:this.body instanceof Vc?"application/x-www-form-urlencoded;charset=UTF-8":typeof this.body=="object"||typeof this.body=="number"||typeof this.body=="boolean"?Ek:null}clone(c={}){let l=c.method||this.method,f=c.url||this.url,v=c.responseType||this.responseType,i=c.keepalive??this.keepalive,C=c.priority||this.priority,k=c.cache||this.cache,B=c.mode||this.mode,ee=c.redirect||this.redirect,_e=c.credentials||this.credentials,Oe=c.referrer||this.referrer,ct=c.integrity||this.integrity,Fe=c.transferCache??this.transferCache,yt=c.timeout??this.timeout,Xt=c.body!==void 0?c.body:this.body,At=c.withCredentials??this.withCredentials,Lt=c.reportProgress??this.reportProgress,qn=c.headers||this.headers,Sr=c.params||this.params,Vi=c.context??this.context;return c.setHeaders!==void 0&&(qn=Object.keys(c.setHeaders).reduce((jr,lo)=>jr.set(lo,c.setHeaders[lo]),qn)),c.setParams&&(Sr=Object.keys(c.setParams).reduce((jr,lo)=>jr.set(lo,c.setParams[lo]),Sr)),new s(l,f,Xt,{params:Sr,headers:qn,context:Vi,reportProgress:Lt,responseType:v,withCredentials:At,transferCache:Fe,keepalive:i,cache:k,priority:C,timeout:yt,mode:B,redirect:ee,credentials:_e,referrer:Oe,integrity:ct})}},Xh=(function(s){return s[s.Sent=0]="Sent",s[s.UploadProgress=1]="UploadProgress",s[s.ResponseHeader=2]="ResponseHeader",s[s.DownloadProgress=3]="DownloadProgress",s[s.Response=4]="Response",s[s.User=5]="User",s})(Xh||{}),wm=class{headers;status;statusText;url;ok;type;redirected;constructor(c,l=200,f="OK"){this.headers=c.headers||new td,this.status=c.status!==void 0?c.status:l,this.statusText=c.statusText||f,this.url=c.url||null,this.redirected=c.redirected,this.ok=this.status>=200&&this.status<300}},Ew=class s extends wm{constructor(c={}){super(c)}type=Xh.ResponseHeader;clone(c={}){return new s({headers:c.headers||this.headers,status:c.status!==void 0?c.status:this.status,statusText:c.statusText||this.statusText,url:c.url||this.url||void 0})}},Xy=class s extends wm{body;constructor(c={}){super(c),this.body=c.body!==void 0?c.body:null}type=Xh.Response;clone(c={}){return new s({body:c.body!==void 0?c.body:this.body,headers:c.headers||this.headers,status:c.status!==void 0?c.status:this.status,statusText:c.statusText||this.statusText,url:c.url||this.url||void 0,redirected:c.redirected??this.redirected})}},ed=class extends wm{name="HttpErrorResponse";message;error;ok=!1;constructor(c){super(c,0,"Unknown Error"),this.status>=200&&this.status<300?this.message=`Http failure during parsing for ${c.url||"(unknown url)"}`:this.message=`Http failure response for ${c.url||"(unknown url)"}: ${c.status} ${c.statusText}`,this.error=c.error||null}},E$=200,T$=204;function YD(s,c){return{body:c,headers:s.headers,context:s.context,observe:s.observe,params:s.params,reportProgress:s.reportProgress,responseType:s.responseType,withCredentials:s.withCredentials,credentials:s.credentials,transferCache:s.transferCache,timeout:s.timeout,keepalive:s.keepalive,priority:s.priority,cache:s.cache,mode:s.mode,redirect:s.redirect,integrity:s.integrity,referrer:s.referrer}}var Em=(()=>{class s{handler;constructor(l){this.handler=l}request(l,f,v={}){let i;if(l instanceof xm)i=l;else{let B;v.headers instanceof td?B=v.headers:B=new td(v.headers);let ee;v.params&&(v.params instanceof Vc?ee=v.params:ee=new Vc({fromObject:v.params})),i=new xm(l,f,v.body!==void 0?v.body:null,{headers:B,context:v.context,params:ee,reportProgress:v.reportProgress,responseType:v.responseType||"json",withCredentials:v.withCredentials,transferCache:v.transferCache,keepalive:v.keepalive,priority:v.priority,cache:v.cache,mode:v.mode,redirect:v.redirect,credentials:v.credentials,referrer:v.referrer,integrity:v.integrity,timeout:v.timeout})}let C=mn(i).pipe(Al(B=>this.handler.handle(B)));if(l instanceof xm||v.observe==="events")return C;let k=C.pipe(go(B=>B instanceof Xy));switch(v.observe||"body"){case"body":switch(i.responseType){case"arraybuffer":return k.pipe(Ln(B=>{if(B.body!==null&&!(B.body instanceof ArrayBuffer))throw new tn(2806,!1);return B.body}));case"blob":return k.pipe(Ln(B=>{if(B.body!==null&&!(B.body instanceof Blob))throw new tn(2807,!1);return B.body}));case"text":return k.pipe(Ln(B=>{if(B.body!==null&&typeof B.body!="string")throw new tn(2808,!1);return B.body}));case"json":default:return k.pipe(Ln(B=>B.body))}case"response":return k;default:throw new tn(2809,!1)}}delete(l,f={}){return this.request("DELETE",l,f)}get(l,f={}){return this.request("GET",l,f)}head(l,f={}){return this.request("HEAD",l,f)}jsonp(l,f){return this.request("JSONP",l,{params:new Vc().append(f,"JSONP_CALLBACK"),observe:"body",responseType:"json"})}options(l,f={}){return this.request("OPTIONS",l,f)}patch(l,f,v={}){return this.request("PATCH",l,YD(v,f))}post(l,f,v={}){return this.request("POST",l,YD(v,f))}put(l,f,v={}){return this.request("PUT",l,YD(v,f))}static \u0275fac=function(f){return new(f||s)(ln(bm))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})();var I$=new Kt("");function S$(s,c){return c(s)}function D$(s,c,l){return(f,v)=>vo(l,()=>c(f,i=>s(i,v)))}var JD=new Kt(""),Tk=new Kt(""),Ik=new Kt("",{providedIn:"root",factory:()=>!0});var Tw=(()=>{class s extends bm{backend;injector;chain=null;pendingTasks=pt(bb);contributeToStability=pt(Ik);constructor(l,f){super(),this.backend=l,this.injector=f}handle(l){if(this.chain===null){let f=Array.from(new Set([...this.injector.get(JD),...this.injector.get(Tk,[])]));this.chain=f.reduceRight((v,i)=>D$(v,i,this.injector),S$)}if(this.contributeToStability){let f=this.pendingTasks.add();return this.chain(l,v=>this.backend.handle(v)).pipe(wc(f))}else return this.chain(l,f=>this.backend.handle(f))}static \u0275fac=function(f){return new(f||s)(ln(Zy),ln(Gr))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})();var C$=/^\)\]\}',?\n/,A$=RegExp(`^${bk}:`,"m");function M$(s){return"responseURL"in s&&s.responseURL?s.responseURL:A$.test(s.getAllResponseHeaders())?s.getResponseHeader(bk):null}var KD=(()=>{class s{xhrFactory;constructor(l){this.xhrFactory=l}handle(l){if(l.method==="JSONP")throw new tn(-2800,!1);let f=this.xhrFactory;return mn(null).pipe(Co(()=>new hi(i=>{let C=f.build();if(C.open(l.method,l.urlWithParams),l.withCredentials&&(C.withCredentials=!0),l.headers.forEach((At,Lt)=>C.setRequestHeader(At,Lt.join(","))),l.headers.has(xk)||C.setRequestHeader(xk,w$),!l.headers.has(vk)){let At=l.detectContentTypeHeader();At!==null&&C.setRequestHeader(vk,At)}if(l.timeout&&(C.timeout=l.timeout),l.responseType){let At=l.responseType.toLowerCase();C.responseType=At!=="json"?At:"text"}let k=l.serializeBody(),B=null,ee=()=>{if(B!==null)return B;let At=C.statusText||"OK",Lt=new td(C.getAllResponseHeaders()),qn=M$(C)||l.url;return B=new Ew({headers:Lt,status:C.status,statusText:At,url:qn}),B},_e=()=>{let{headers:At,status:Lt,statusText:qn,url:Sr}=ee(),Vi=null;Lt!==T$&&(Vi=typeof C.response>"u"?C.responseText:C.response),Lt===0&&(Lt=Vi?E$:0);let jr=Lt>=200&&Lt<300;if(l.responseType==="json"&&typeof Vi=="string"){let lo=Vi;Vi=Vi.replace(C$,"");try{Vi=Vi!==""?JSON.parse(Vi):null}catch(Sa){Vi=lo,jr&&(jr=!1,Vi={error:Sa,text:Vi})}}jr?(i.next(new Xy({body:Vi,headers:At,status:Lt,statusText:qn,url:Sr||void 0})),i.complete()):i.error(new ed({error:Vi,headers:At,status:Lt,statusText:qn,url:Sr||void 0}))},Oe=At=>{let{url:Lt}=ee(),qn=new ed({error:At,status:C.status||0,statusText:C.statusText||"Unknown Error",url:Lt||void 0});i.error(qn)},ct=Oe;l.timeout&&(ct=At=>{let{url:Lt}=ee(),qn=new ed({error:new DOMException("Request timed out","TimeoutError"),status:C.status||0,statusText:C.statusText||"Request timeout",url:Lt||void 0});i.error(qn)});let Fe=!1,yt=At=>{Fe||(i.next(ee()),Fe=!0);let Lt={type:Xh.DownloadProgress,loaded:At.loaded};At.lengthComputable&&(Lt.total=At.total),l.responseType==="text"&&C.responseText&&(Lt.partialText=C.responseText),i.next(Lt)},Xt=At=>{let Lt={type:Xh.UploadProgress,loaded:At.loaded};At.lengthComputable&&(Lt.total=At.total),i.next(Lt)};return C.addEventListener("load",_e),C.addEventListener("error",Oe),C.addEventListener("timeout",ct),C.addEventListener("abort",Oe),l.reportProgress&&(C.addEventListener("progress",yt),k!==null&&C.upload&&C.upload.addEventListener("progress",Xt)),C.send(k),i.next({type:Xh.Sent}),()=>{C.removeEventListener("error",Oe),C.removeEventListener("abort",Oe),C.removeEventListener("load",_e),C.removeEventListener("timeout",ct),l.reportProgress&&(C.removeEventListener("progress",yt),k!==null&&C.upload&&C.upload.removeEventListener("progress",Xt)),C.readyState!==C.DONE&&C.abort()}})))}static \u0275fac=function(f){return new(f||s)(ln(Zh))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),Sk=new Kt(""),R$="XSRF-TOKEN",P$=new Kt("",{providedIn:"root",factory:()=>R$}),O$="X-XSRF-TOKEN",L$=new Kt("",{providedIn:"root",factory:()=>O$}),Yy=class{},F$=(()=>{class s{doc;cookieName;lastCookieString="";lastToken=null;parseCount=0;constructor(l,f){this.doc=l,this.cookieName=f}getToken(){let l=this.doc.cookie||"";return l!==this.lastCookieString&&(this.parseCount++,this.lastToken=Hy(l,this.cookieName),this.lastCookieString=l),this.lastToken}static \u0275fac=function(f){return new(f||s)(ln(Qi),ln(P$))};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})();function k$(s,c){let l=s.url.toLowerCase();if(!pt(Sk)||s.method==="GET"||s.method==="HEAD"||l.startsWith("http://")||l.startsWith("https://"))return c(s);let f=pt(Yy).getToken(),v=pt(L$);return f!=null&&!s.headers.has(v)&&(s=s.clone({headers:s.headers.set(v,f)})),c(s)}var QD=(function(s){return s[s.Interceptors=0]="Interceptors",s[s.LegacyInterceptors=1]="LegacyInterceptors",s[s.CustomXsrfConfiguration=2]="CustomXsrfConfiguration",s[s.NoXsrfProtection=3]="NoXsrfProtection",s[s.JsonpSupport=4]="JsonpSupport",s[s.RequestsMadeViaParent=5]="RequestsMadeViaParent",s[s.Fetch=6]="Fetch",s})(QD||{});function N$(s,c){return{\u0275kind:s,\u0275providers:c}}function eC(...s){let c=[Em,KD,Tw,{provide:bm,useExisting:Tw},{provide:Zy,useFactory:()=>pt(I$,{optional:!0})??pt(KD)},{provide:JD,useValue:k$,multi:!0},{provide:Sk,useValue:!0},{provide:Yy,useClass:F$}];for(let l of s)c.push(...l.\u0275providers);return Ya(c)}function tC(s){return N$(QD.Interceptors,s.map(c=>({provide:JD,useValue:c,multi:!0})))}var Ck=(()=>{class s{_doc;constructor(l){this._doc=l}getTitle(){return this._doc.title}setTitle(l){this._doc.title=l||""}static \u0275fac=function(f){return new(f||s)(ln(Qi))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var nC=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:function(f){let v=null;return f?v=new(f||s):v=ln(z$),v},providedIn:"root"})}return s})(),z$=(()=>{class s extends nC{_doc;constructor(l){super(),this._doc=l}sanitize(l,f){if(f==null)return null;switch(l){case Mo.NONE:return f;case Mo.HTML:return Lc(f,"HTML")?Ea(f):eD(this._doc,String(f)).toString();case Mo.STYLE:return Lc(f,"Style")?Ea(f):f;case Mo.SCRIPT:if(Lc(f,"Script"))return Ea(f);throw new tn(5200,!1);case Mo.URL:return Lc(f,"URL")?Ea(f):Sy(String(f));case Mo.RESOURCE_URL:if(Lc(f,"ResourceURL"))return Ea(f);throw new tn(5201,!1);default:throw new tn(5202,!1)}}bypassSecurityTrustHtml(l){return XS(l)}bypassSecurityTrustStyle(l){return YS(l)}bypassSecurityTrustScript(l){return KS(l)}bypassSecurityTrustUrl(l){return JS(l)}bypassSecurityTrustResourceUrl(l){return QS(l)}static \u0275fac=function(f){return new(f||s)(ln(Qi))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var ti="primary",cv=Symbol("RouteTitle"),aC=class{params;constructor(c){this.params=c||{}}has(c){return Object.prototype.hasOwnProperty.call(this.params,c)}get(c){if(this.has(c)){let l=this.params[c];return Array.isArray(l)?l[0]:l}return null}getAll(c){if(this.has(c)){let l=this.params[c];return Array.isArray(l)?l:[l]}return[]}get keys(){return Object.keys(this.params)}};function Jh(s){return new aC(s)}function Nk(s,c,l){let f=l.path.split("/");if(f.length>s.length||l.pathMatch==="full"&&(c.hasChildren()||f.length<s.length))return null;let v={};for(let i=0;i<f.length;i++){let C=f[i],k=s[i];if(C[0]===":")v[C.substring(1)]=k;else if(C!==k.path)return null}return{consumed:s.slice(0,f.length),posParams:v}}function B$(s,c){if(s.length!==c.length)return!1;for(let l=0;l<s.length;++l)if(!zl(s[l],c[l]))return!1;return!0}function zl(s,c){let l=s?lC(s):void 0,f=c?lC(c):void 0;if(!l||!f||l.length!=f.length)return!1;let v;for(let i=0;i<l.length;i++)if(v=l[i],!zk(s[v],c[v]))return!1;return!0}function lC(s){return[...Object.keys(s),...Object.getOwnPropertySymbols(s)]}function zk(s,c){if(Array.isArray(s)&&Array.isArray(c)){if(s.length!==c.length)return!1;let l=[...s].sort(),f=[...c].sort();return l.every((v,i)=>f[i]===v)}else return s===c}function Bk(s){return s.length>0?s[s.length-1]:null}function jc(s){return ZT(s)?s:qh(s)?Tr(Promise.resolve(s)):mn(s)}var V$={exact:jk,subset:Uk},Vk={exact:j$,subset:U$,ignored:()=>!0};function Mk(s,c,l){return V$[l.paths](s.root,c.root,l.matrixParams)&&Vk[l.queryParams](s.queryParams,c.queryParams)&&!(l.fragment==="exact"&&s.fragment!==c.fragment)}function j$(s,c){return zl(s,c)}function jk(s,c,l){if(!Yh(s.segments,c.segments)||!Dw(s.segments,c.segments,l)||s.numberOfChildren!==c.numberOfChildren)return!1;for(let f in c.children)if(!s.children[f]||!jk(s.children[f],c.children[f],l))return!1;return!0}function U$(s,c){return Object.keys(c).length<=Object.keys(s).length&&Object.keys(c).every(l=>zk(s[l],c[l]))}function Uk(s,c,l){return Hk(s,c,c.segments,l)}function Hk(s,c,l,f){if(s.segments.length>l.length){let v=s.segments.slice(0,l.length);return!(!Yh(v,l)||c.hasChildren()||!Dw(v,l,f))}else if(s.segments.length===l.length){if(!Yh(s.segments,l)||!Dw(s.segments,l,f))return!1;for(let v in c.children)if(!s.children[v]||!Uk(s.children[v],c.children[v],f))return!1;return!0}else{let v=l.slice(0,s.segments.length),i=l.slice(s.segments.length);return!Yh(s.segments,v)||!Dw(s.segments,v,f)||!s.children[ti]?!1:Hk(s.children[ti],c,i,f)}}function Dw(s,c,l){return c.every((f,v)=>Vk[l](s[v].parameters,f.parameters))}var Vl=class{root;queryParams;fragment;_queryParamMap;constructor(c=new Wi([],{}),l={},f=null){this.root=c,this.queryParams=l,this.fragment=f}get queryParamMap(){return this._queryParamMap??=Jh(this.queryParams),this._queryParamMap}toString(){return G$.serialize(this)}},Wi=class{segments;children;parent=null;constructor(c,l){this.segments=c,this.children=l,Object.values(l).forEach(f=>f.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return Cw(this)}},nd=class{path;parameters;_parameterMap;constructor(c,l){this.path=c,this.parameters=l}get parameterMap(){return this._parameterMap??=Jh(this.parameters),this._parameterMap}toString(){return Gk(this)}};function H$(s,c){return Yh(s,c)&&s.every((l,f)=>zl(l.parameters,c[f].parameters))}function Yh(s,c){return s.length!==c.length?!1:s.every((l,f)=>l.path===c[f].path)}function $$(s,c){let l=[];return Object.entries(s.children).forEach(([f,v])=>{f===ti&&(l=l.concat(c(v,f)))}),Object.entries(s.children).forEach(([f,v])=>{f!==ti&&(l=l.concat(c(v,f)))}),l}var Qh=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>new id,providedIn:"root"})}return s})(),id=class{parse(c){let l=new uC(c);return new Vl(l.parseRootSegment(),l.parseQueryParams(),l.parseFragment())}serialize(c){let l=`/${Ky(c.root,!0)}`,f=Z$(c.queryParams),v=typeof c.fragment=="string"?`#${q$(c.fragment)}`:"";return`${l}${f}${v}`}},G$=new id;function Cw(s){return s.segments.map(c=>Gk(c)).join("/")}function Ky(s,c){if(!s.hasChildren())return Cw(s);if(c){let l=s.children[ti]?Ky(s.children[ti],!1):"",f=[];return Object.entries(s.children).forEach(([v,i])=>{v!==ti&&f.push(`${v}:${Ky(i,!1)}`)}),f.length>0?`${l}(${f.join("//")})`:l}else{let l=$$(s,(f,v)=>v===ti?[Ky(s.children[ti],!1)]:[`${v}:${Ky(f,!1)}`]);return Object.keys(s.children).length===1&&s.children[ti]!=null?`${Cw(s)}/${l[0]}`:`${Cw(s)}/(${l.join("//")})`}}function $k(s){return encodeURIComponent(s).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function Iw(s){return $k(s).replace(/%3B/gi,";")}function q$(s){return encodeURI(s)}function cC(s){return $k(s).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function Aw(s){return decodeURIComponent(s)}function Rk(s){return Aw(s.replace(/\+/g,"%20"))}function Gk(s){return`${cC(s.path)}${W$(s.parameters)}`}function W$(s){return Object.entries(s).map(([c,l])=>`;${cC(c)}=${cC(l)}`).join("")}function Z$(s){let c=Object.entries(s).map(([l,f])=>Array.isArray(f)?f.map(v=>`${Iw(l)}=${Iw(v)}`).join("&"):`${Iw(l)}=${Iw(f)}`).filter(l=>l);return c.length?`?${c.join("&")}`:""}var X$=/^[^\/()?;#]+/;function iC(s){let c=s.match(X$);return c?c[0]:""}var Y$=/^[^\/()?;=#]+/;function K$(s){let c=s.match(Y$);return c?c[0]:""}var J$=/^[^=?&#]+/;function Q$(s){let c=s.match(J$);return c?c[0]:""}var eG=/^[^&#]+/;function tG(s){let c=s.match(eG);return c?c[0]:""}var uC=class{url;remaining;constructor(c){this.url=c,this.remaining=c}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new Wi([],{}):new Wi([],this.parseChildren())}parseQueryParams(){let c={};if(this.consumeOptional("?"))do this.parseQueryParam(c);while(this.consumeOptional("&"));return c}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let c=[];for(this.peekStartsWith("(")||c.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),c.push(this.parseSegment());let l={};this.peekStartsWith("/(")&&(this.capture("/"),l=this.parseParens(!0));let f={};return this.peekStartsWith("(")&&(f=this.parseParens(!1)),(c.length>0||Object.keys(l).length>0)&&(f[ti]=new Wi(c,l)),f}parseSegment(){let c=iC(this.remaining);if(c===""&&this.peekStartsWith(";"))throw new tn(4009,!1);return this.capture(c),new nd(Aw(c),this.parseMatrixParams())}parseMatrixParams(){let c={};for(;this.consumeOptional(";");)this.parseParam(c);return c}parseParam(c){let l=K$(this.remaining);if(!l)return;this.capture(l);let f="";if(this.consumeOptional("=")){let v=iC(this.remaining);v&&(f=v,this.capture(f))}c[Aw(l)]=Aw(f)}parseQueryParam(c){let l=Q$(this.remaining);if(!l)return;this.capture(l);let f="";if(this.consumeOptional("=")){let C=tG(this.remaining);C&&(f=C,this.capture(f))}let v=Rk(l),i=Rk(f);if(c.hasOwnProperty(v)){let C=c[v];Array.isArray(C)||(C=[C],c[v]=C),C.push(i)}else c[v]=i}parseParens(c){let l={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let f=iC(this.remaining),v=this.remaining[f.length];if(v!=="/"&&v!==")"&&v!==";")throw new tn(4010,!1);let i;f.indexOf(":")>-1?(i=f.slice(0,f.indexOf(":")),this.capture(i),this.capture(":")):c&&(i=ti);let C=this.parseChildren();l[i??ti]=Object.keys(C).length===1&&C[ti]?C[ti]:new Wi([],C),this.consumeOptional("//")}return l}peekStartsWith(c){return this.remaining.startsWith(c)}consumeOptional(c){return this.peekStartsWith(c)?(this.remaining=this.remaining.substring(c.length),!0):!1}capture(c){if(!this.consumeOptional(c))throw new tn(4011,!1)}};function qk(s){return s.segments.length>0?new Wi([],{[ti]:s}):s}function Wk(s){let c={};for(let[f,v]of Object.entries(s.children)){let i=Wk(v);if(f===ti&&i.segments.length===0&&i.hasChildren())for(let[C,k]of Object.entries(i.children))c[C]=k;else(i.segments.length>0||i.hasChildren())&&(c[f]=i)}let l=new Wi(s.segments,c);return nG(l)}function nG(s){if(s.numberOfChildren===1&&s.children[ti]){let c=s.children[ti];return new Wi(s.segments.concat(c.segments),c.children)}return s}function rd(s){return s instanceof Vl}function Zk(s,c,l=null,f=null){let v=Xk(s);return Yk(v,c,l,f)}function Xk(s){let c;function l(i){let C={};for(let B of i.children){let ee=l(B);C[B.outlet]=ee}let k=new Wi(i.url,C);return i===s&&(c=k),k}let f=l(s.root),v=qk(f);return c??v}function Yk(s,c,l,f){let v=s;for(;v.parent;)v=v.parent;if(c.length===0)return rC(v,v,v,l,f);let i=iG(c);if(i.toRoot())return rC(v,v,new Wi([],{}),l,f);let C=rG(i,v,s),k=C.processChildren?Qy(C.segmentGroup,C.index,i.commands):Jk(C.segmentGroup,C.index,i.commands);return rC(v,C.segmentGroup,k,l,f)}function Mw(s){return typeof s=="object"&&s!=null&&!s.outlets&&!s.segmentPath}function tv(s){return typeof s=="object"&&s!=null&&s.outlets}function rC(s,c,l,f,v){let i={};f&&Object.entries(f).forEach(([B,ee])=>{i[B]=Array.isArray(ee)?ee.map(_e=>`${_e}`):`${ee}`});let C;s===c?C=l:C=Kk(s,c,l);let k=qk(Wk(C));return new Vl(k,i,v)}function Kk(s,c,l){let f={};return Object.entries(s.children).forEach(([v,i])=>{i===c?f[v]=l:f[v]=Kk(i,c,l)}),new Wi(s.segments,f)}var Rw=class{isAbsolute;numberOfDoubleDots;commands;constructor(c,l,f){if(this.isAbsolute=c,this.numberOfDoubleDots=l,this.commands=f,c&&f.length>0&&Mw(f[0]))throw new tn(4003,!1);let v=f.find(tv);if(v&&v!==Bk(f))throw new tn(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function iG(s){if(typeof s[0]=="string"&&s.length===1&&s[0]==="/")return new Rw(!0,0,s);let c=0,l=!1,f=s.reduce((v,i,C)=>{if(typeof i=="object"&&i!=null){if(i.outlets){let k={};return Object.entries(i.outlets).forEach(([B,ee])=>{k[B]=typeof ee=="string"?ee.split("/"):ee}),[...v,{outlets:k}]}if(i.segmentPath)return[...v,i.segmentPath]}return typeof i!="string"?[...v,i]:C===0?(i.split("/").forEach((k,B)=>{B==0&&k==="."||(B==0&&k===""?l=!0:k===".."?c++:k!=""&&v.push(k))}),v):[...v,i]},[]);return new Rw(l,c,f)}var Sm=class{segmentGroup;processChildren;index;constructor(c,l,f){this.segmentGroup=c,this.processChildren=l,this.index=f}};function rG(s,c,l){if(s.isAbsolute)return new Sm(c,!0,0);if(!l)return new Sm(c,!1,NaN);if(l.parent===null)return new Sm(l,!0,0);let f=Mw(s.commands[0])?0:1,v=l.segments.length-1+f;return oG(l,v,s.numberOfDoubleDots)}function oG(s,c,l){let f=s,v=c,i=l;for(;i>v;){if(i-=v,f=f.parent,!f)throw new tn(4005,!1);v=f.segments.length}return new Sm(f,!1,v-i)}function sG(s){return tv(s[0])?s[0].outlets:{[ti]:s}}function Jk(s,c,l){if(s??=new Wi([],{}),s.segments.length===0&&s.hasChildren())return Qy(s,c,l);let f=aG(s,c,l),v=l.slice(f.commandIndex);if(f.match&&f.pathIndex<s.segments.length){let i=new Wi(s.segments.slice(0,f.pathIndex),{});return i.children[ti]=new Wi(s.segments.slice(f.pathIndex),s.children),Qy(i,0,v)}else return f.match&&v.length===0?new Wi(s.segments,{}):f.match&&!s.hasChildren()?dC(s,c,l):f.match?Qy(s,0,v):dC(s,c,l)}function Qy(s,c,l){if(l.length===0)return new Wi(s.segments,{});{let f=sG(l),v={};if(Object.keys(f).some(i=>i!==ti)&&s.children[ti]&&s.numberOfChildren===1&&s.children[ti].segments.length===0){let i=Qy(s.children[ti],c,l);return new Wi(s.segments,i.children)}return Object.entries(f).forEach(([i,C])=>{typeof C=="string"&&(C=[C]),C!==null&&(v[i]=Jk(s.children[i],c,C))}),Object.entries(s.children).forEach(([i,C])=>{f[i]===void 0&&(v[i]=C)}),new Wi(s.segments,v)}}function aG(s,c,l){let f=0,v=c,i={match:!1,pathIndex:0,commandIndex:0};for(;v<s.segments.length;){if(f>=l.length)return i;let C=s.segments[v],k=l[f];if(tv(k))break;let B=`${k}`,ee=f<l.length-1?l[f+1]:null;if(v>0&&B===void 0)break;if(B&&ee&&typeof ee=="object"&&ee.outlets===void 0){if(!Ok(B,ee,C))return i;f+=2}else{if(!Ok(B,{},C))return i;f++}v++}return{match:!0,pathIndex:v,commandIndex:f}}function dC(s,c,l){let f=s.segments.slice(0,c),v=0;for(;v<l.length;){let i=l[v];if(tv(i)){let B=lG(i.outlets);return new Wi(f,B)}if(v===0&&Mw(l[0])){let B=s.segments[c];f.push(new nd(B.path,Pk(l[0]))),v++;continue}let C=tv(i)?i.outlets[ti]:`${i}`,k=v<l.length-1?l[v+1]:null;C&&k&&Mw(k)?(f.push(new nd(C,Pk(k))),v+=2):(f.push(new nd(C,{})),v++)}return new Wi(f,{})}function lG(s){let c={};return Object.entries(s).forEach(([l,f])=>{typeof f=="string"&&(f=[f]),f!==null&&(c[l]=dC(new Wi([],{}),0,f))}),c}function Pk(s){let c={};return Object.entries(s).forEach(([l,f])=>c[l]=`${f}`),c}function Ok(s,c,l){return s==l.path&&zl(c,l.parameters)}var Dm="imperative",ao=(function(s){return s[s.NavigationStart=0]="NavigationStart",s[s.NavigationEnd=1]="NavigationEnd",s[s.NavigationCancel=2]="NavigationCancel",s[s.NavigationError=3]="NavigationError",s[s.RoutesRecognized=4]="RoutesRecognized",s[s.ResolveStart=5]="ResolveStart",s[s.ResolveEnd=6]="ResolveEnd",s[s.GuardsCheckStart=7]="GuardsCheckStart",s[s.GuardsCheckEnd=8]="GuardsCheckEnd",s[s.RouteConfigLoadStart=9]="RouteConfigLoadStart",s[s.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",s[s.ChildActivationStart=11]="ChildActivationStart",s[s.ChildActivationEnd=12]="ChildActivationEnd",s[s.ActivationStart=13]="ActivationStart",s[s.ActivationEnd=14]="ActivationEnd",s[s.Scroll=15]="Scroll",s[s.NavigationSkipped=16]="NavigationSkipped",s})(ao||{}),ia=class{id;url;constructor(c,l){this.id=c,this.url=l}},od=class extends ia{type=ao.NavigationStart;navigationTrigger;restoredState;constructor(c,l,f="imperative",v=null){super(c,l),this.navigationTrigger=f,this.restoredState=v}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},Ia=class extends ia{urlAfterRedirects;type=ao.NavigationEnd;constructor(c,l,f){super(c,l),this.urlAfterRedirects=f}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},ps=(function(s){return s[s.Redirect=0]="Redirect",s[s.SupersededByNewNavigation=1]="SupersededByNewNavigation",s[s.NoDataFromResolver=2]="NoDataFromResolver",s[s.GuardRejected=3]="GuardRejected",s[s.Aborted=4]="Aborted",s})(ps||{}),Am=(function(s){return s[s.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",s[s.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",s})(Am||{}),Bl=class extends ia{reason;code;type=ao.NavigationCancel;constructor(c,l,f,v){super(c,l),this.reason=f,this.code=v}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},jl=class extends ia{reason;code;type=ao.NavigationSkipped;constructor(c,l,f,v){super(c,l),this.reason=f,this.code=v}},Mm=class extends ia{error;target;type=ao.NavigationError;constructor(c,l,f,v){super(c,l),this.error=f,this.target=v}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},nv=class extends ia{urlAfterRedirects;state;type=ao.RoutesRecognized;constructor(c,l,f,v){super(c,l),this.urlAfterRedirects=f,this.state=v}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Pw=class extends ia{urlAfterRedirects;state;type=ao.GuardsCheckStart;constructor(c,l,f,v){super(c,l),this.urlAfterRedirects=f,this.state=v}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Ow=class extends ia{urlAfterRedirects;state;shouldActivate;type=ao.GuardsCheckEnd;constructor(c,l,f,v,i){super(c,l),this.urlAfterRedirects=f,this.state=v,this.shouldActivate=i}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},Lw=class extends ia{urlAfterRedirects;state;type=ao.ResolveStart;constructor(c,l,f,v){super(c,l),this.urlAfterRedirects=f,this.state=v}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Fw=class extends ia{urlAfterRedirects;state;type=ao.ResolveEnd;constructor(c,l,f,v){super(c,l),this.urlAfterRedirects=f,this.state=v}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},kw=class{route;type=ao.RouteConfigLoadStart;constructor(c){this.route=c}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},Nw=class{route;type=ao.RouteConfigLoadEnd;constructor(c){this.route=c}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},zw=class{snapshot;type=ao.ChildActivationStart;constructor(c){this.snapshot=c}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Bw=class{snapshot;type=ao.ChildActivationEnd;constructor(c){this.snapshot=c}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Vw=class{snapshot;type=ao.ActivationStart;constructor(c){this.snapshot=c}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},jw=class{snapshot;type=ao.ActivationEnd;constructor(c){this.snapshot=c}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Rm=class{routerEvent;position;anchor;type=ao.Scroll;constructor(c,l,f){this.routerEvent=c,this.position=l,this.anchor=f}toString(){let c=this.position?`${this.position[0]}, ${this.position[1]}`:null;return`Scroll(anchor: '${this.anchor}', position: '${c}')`}},iv=class{},Pm=class{url;navigationBehaviorOptions;constructor(c,l){this.url=c,this.navigationBehaviorOptions=l}};function cG(s){return!(s instanceof iv)&&!(s instanceof Pm)}function uG(s,c){return s.providers&&!s._injector&&(s._injector=_m(s.providers,c,`Route: ${s.path}`)),s._injector??c}function sl(s){return s.outlet||ti}function dG(s,c){let l=s.filter(f=>sl(f)===c);return l.push(...s.filter(f=>sl(f)!==c)),l}function Fm(s){if(!s)return null;if(s.routeConfig?._injector)return s.routeConfig._injector;for(let c=s.parent;c;c=c.parent){let l=c.routeConfig;if(l?._loadedInjector)return l._loadedInjector;if(l?._injector)return l._injector}return null}var Uw=class{rootInjector;outlet=null;route=null;children;attachRef=null;get injector(){return Fm(this.route?.snapshot)??this.rootInjector}constructor(c){this.rootInjector=c,this.children=new ef(this.rootInjector)}},ef=(()=>{class s{rootInjector;contexts=new Map;constructor(l){this.rootInjector=l}onChildOutletCreated(l,f){let v=this.getOrCreateContext(l);v.outlet=f,this.contexts.set(l,v)}onChildOutletDestroyed(l){let f=this.getContext(l);f&&(f.outlet=null,f.attachRef=null)}onOutletDeactivated(){let l=this.contexts;return this.contexts=new Map,l}onOutletReAttached(l){this.contexts=l}getOrCreateContext(l){let f=this.getContext(l);return f||(f=new Uw(this.rootInjector),this.contexts.set(l,f)),f}getContext(l){return this.contexts.get(l)||null}static \u0275fac=function(f){return new(f||s)(ln(Gr))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),Hw=class{_root;constructor(c){this._root=c}get root(){return this._root.value}parent(c){let l=this.pathFromRoot(c);return l.length>1?l[l.length-2]:null}children(c){let l=hC(c,this._root);return l?l.children.map(f=>f.value):[]}firstChild(c){let l=hC(c,this._root);return l&&l.children.length>0?l.children[0].value:null}siblings(c){let l=fC(c,this._root);return l.length<2?[]:l[l.length-2].children.map(v=>v.value).filter(v=>v!==c)}pathFromRoot(c){return fC(c,this._root).map(l=>l.value)}};function hC(s,c){if(s===c.value)return c;for(let l of c.children){let f=hC(s,l);if(f)return f}return null}function fC(s,c){if(s===c.value)return[c];for(let l of c.children){let f=fC(s,l);if(f.length)return f.unshift(c),f}return[]}var na=class{value;children;constructor(c,l){this.value=c,this.children=l}toString(){return`TreeNode(${this.value})`}};function Im(s){let c={};return s&&s.children.forEach(l=>c[l.value.outlet]=l),c}var rv=class extends Hw{snapshot;constructor(c,l){super(c),this.snapshot=l,bC(this,c)}toString(){return this.snapshot.toString()}};function Qk(s){let c=hG(s),l=new Do([new nd("",{})]),f=new Do({}),v=new Do({}),i=new Do({}),C=new Do(""),k=new Ns(l,f,i,C,v,ti,s,c.root);return k.snapshot=c.root,new rv(new na(k,[]),c)}function hG(s){let c={},l={},f={},i=new Kh([],c,f,"",l,ti,s,null,{});return new ov("",new na(i,[]))}var Ns=class{urlSubject;paramsSubject;queryParamsSubject;fragmentSubject;dataSubject;outlet;component;snapshot;_futureSnapshot;_routerState;_paramMap;_queryParamMap;title;url;params;queryParams;fragment;data;constructor(c,l,f,v,i,C,k,B){this.urlSubject=c,this.paramsSubject=l,this.queryParamsSubject=f,this.fragmentSubject=v,this.dataSubject=i,this.outlet=C,this.component=k,this._futureSnapshot=B,this.title=this.dataSubject?.pipe(Ln(ee=>ee[cv]))??mn(void 0),this.url=c,this.params=l,this.queryParams=f,this.fragment=v,this.data=i}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(Ln(c=>Jh(c))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(Ln(c=>Jh(c))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function $w(s,c,l="emptyOnly"){let f,{routeConfig:v}=s;return c!==null&&(l==="always"||v?.path===""||!c.component&&!c.routeConfig?.loadComponent)?f={params:Bt(Bt({},c.params),s.params),data:Bt(Bt({},c.data),s.data),resolve:Bt(Bt(Bt(Bt({},s.data),c.data),v?.data),s._resolvedData)}:f={params:Bt({},s.params),data:Bt({},s.data),resolve:Bt(Bt({},s.data),s._resolvedData??{})},v&&tN(v)&&(f.resolve[cv]=v.title),f}var Kh=class{url;params;queryParams;fragment;data;outlet;component;routeConfig;_resolve;_resolvedData;_routerState;_paramMap;_queryParamMap;get title(){return this.data?.[cv]}constructor(c,l,f,v,i,C,k,B,ee){this.url=c,this.params=l,this.queryParams=f,this.fragment=v,this.data=i,this.outlet=C,this.component=k,this.routeConfig=B,this._resolve=ee}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=Jh(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=Jh(this.queryParams),this._queryParamMap}toString(){let c=this.url.map(f=>f.toString()).join("/"),l=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${c}', path:'${l}')`}},ov=class extends Hw{url;constructor(c,l){super(l),this.url=c,bC(this,l)}toString(){return eN(this._root)}};function bC(s,c){c.value._routerState=s,c.children.forEach(l=>bC(s,l))}function eN(s){let c=s.children.length>0?` { ${s.children.map(eN).join(", ")} } `:"";return`${s.value}${c}`}function oC(s){if(s.snapshot){let c=s.snapshot,l=s._futureSnapshot;s.snapshot=l,zl(c.queryParams,l.queryParams)||s.queryParamsSubject.next(l.queryParams),c.fragment!==l.fragment&&s.fragmentSubject.next(l.fragment),zl(c.params,l.params)||s.paramsSubject.next(l.params),B$(c.url,l.url)||s.urlSubject.next(l.url),zl(c.data,l.data)||s.dataSubject.next(l.data)}else s.snapshot=s._futureSnapshot,s.dataSubject.next(s._futureSnapshot.data)}function pC(s,c){let l=zl(s.params,c.params)&&H$(s.url,c.url),f=!s.parent!=!c.parent;return l&&!f&&(!s.parent||pC(s.parent,c.parent))}function tN(s){return typeof s.title=="string"||s.title===null}var nN=new Kt(""),uv=(()=>{class s{activated=null;get activatedComponentRef(){return this.activated}_activatedRoute=null;name=ti;activateEvents=new qi;deactivateEvents=new qi;attachEvents=new qi;detachEvents=new qi;routerOutletData=zc();parentContexts=pt(ef);location=pt(Py);changeDetector=pt(vm);inputBinder=pt(dv,{optional:!0});supportsBindingToComponentInputs=!0;ngOnChanges(l){if(l.name){let{firstChange:f,previousValue:v}=l.name;if(f)return;this.isTrackedInParentContexts(v)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(v)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(l){return this.parentContexts.getContext(l)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let l=this.parentContexts.getContext(this.name);l?.route&&(l.attachRef?this.attach(l.attachRef,l.route):this.activateWith(l.route,l.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new tn(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new tn(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new tn(4012,!1);this.location.detach();let l=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(l.instance),l}attach(l,f){this.activated=l,this._activatedRoute=f,this.location.insert(l.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(l.instance)}deactivate(){if(this.activated){let l=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(l)}}activateWith(l,f){if(this.isActivated)throw new tn(4013,!1);this._activatedRoute=l;let v=this.location,C=l.snapshot.component,k=this.parentContexts.getOrCreateContext(this.name).children,B=new mC(l,k,v.injector,this.routerOutletData);this.activated=v.createComponent(C,{index:v.length,injector:B,environmentInjector:f}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}static \u0275fac=function(f){return new(f||s)};static \u0275dir=Ls({type:s,selectors:[["router-outlet"]],inputs:{name:"name",routerOutletData:[1,"routerOutletData"]},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],features:[Oc]})}return s})(),mC=class{route;childContexts;parent;outletData;constructor(c,l,f,v){this.route=c,this.childContexts=l,this.parent=f,this.outletData=v}get(c,l){return c===Ns?this.route:c===ef?this.childContexts:c===nN?this.outletData:this.parent.get(c,l)}},dv=new Kt(""),wC=(()=>{class s{outletDataSubscriptions=new Map;bindActivatedRouteToOutletComponent(l){this.unsubscribeFromRouteData(l),this.subscribeToRouteData(l)}unsubscribeFromRouteData(l){this.outletDataSubscriptions.get(l)?.unsubscribe(),this.outletDataSubscriptions.delete(l)}subscribeToRouteData(l){let{activatedRoute:f}=l,v=wh([f.queryParams,f.params,f.data]).pipe(Co(([i,C,k],B)=>(k=Bt(Bt(Bt({},i),C),k),B===0?mn(k):Promise.resolve(k)))).subscribe(i=>{if(!l.isActivated||!l.activatedComponentRef||l.activatedRoute!==f||f.component===null){this.unsubscribeFromRouteData(l);return}let C=tk(f.component);if(!C){this.unsubscribeFromRouteData(l);return}for(let{templateName:k}of C.inputs)l.activatedComponentRef.setInput(k,i[k])});this.outletDataSubscriptions.set(l,v)}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})(),EC=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275cmp=ur({type:s,selectors:[["ng-component"]],exportAs:["emptyRouterOutlet"],decls:1,vars:0,template:function(f,v){f&1&&Pr(0,"router-outlet")},dependencies:[uv],encapsulation:2})}return s})();function TC(s){let c=s.children&&s.children.map(TC),l=c?di(Bt({},s),{children:c}):Bt({},s);return!l.component&&!l.loadComponent&&(c||l.loadChildren)&&l.outlet&&l.outlet!==ti&&(l.component=EC),l}function fG(s,c,l){let f=sv(s,c._root,l?l._root:void 0);return new rv(f,c)}function sv(s,c,l){if(l&&s.shouldReuseRoute(c.value,l.value.snapshot)){let f=l.value;f._futureSnapshot=c.value;let v=pG(s,c,l);return new na(f,v)}else{if(s.shouldAttach(c.value)){let i=s.retrieve(c.value);if(i!==null){let C=i.route;return C.value._futureSnapshot=c.value,C.children=c.children.map(k=>sv(s,k)),C}}let f=mG(c.value),v=c.children.map(i=>sv(s,i));return new na(f,v)}}function pG(s,c,l){return c.children.map(f=>{for(let v of l.children)if(s.shouldReuseRoute(f.value,v.value.snapshot))return sv(s,f,v);return sv(s,f)})}function mG(s){return new Ns(new Do(s.url),new Do(s.params),new Do(s.queryParams),new Do(s.fragment),new Do(s.data),s.outlet,s.component,s)}var Om=class{redirectTo;navigationBehaviorOptions;constructor(c,l){this.redirectTo=c,this.navigationBehaviorOptions=l}},iN="ngNavigationCancelingError";function Gw(s,c){let{redirectTo:l,navigationBehaviorOptions:f}=rd(c)?{redirectTo:c,navigationBehaviorOptions:void 0}:c,v=rN(!1,ps.Redirect);return v.url=l,v.navigationBehaviorOptions=f,v}function rN(s,c){let l=new Error(`NavigationCancelingError: ${s||""}`);return l[iN]=!0,l.cancellationCode=c,l}function gG(s){return oN(s)&&rd(s.url)}function oN(s){return!!s&&s[iN]}var _G=(s,c,l,f)=>Ln(v=>(new gC(c,v.targetRouterState,v.currentRouterState,l,f).activate(s),v)),gC=class{routeReuseStrategy;futureState;currState;forwardEvent;inputBindingEnabled;constructor(c,l,f,v,i){this.routeReuseStrategy=c,this.futureState=l,this.currState=f,this.forwardEvent=v,this.inputBindingEnabled=i}activate(c){let l=this.futureState._root,f=this.currState?this.currState._root:null;this.deactivateChildRoutes(l,f,c),oC(this.futureState.root),this.activateChildRoutes(l,f,c)}deactivateChildRoutes(c,l,f){let v=Im(l);c.children.forEach(i=>{let C=i.value.outlet;this.deactivateRoutes(i,v[C],f),delete v[C]}),Object.values(v).forEach(i=>{this.deactivateRouteAndItsChildren(i,f)})}deactivateRoutes(c,l,f){let v=c.value,i=l?l.value:null;if(v===i)if(v.component){let C=f.getContext(v.outlet);C&&this.deactivateChildRoutes(c,l,C.children)}else this.deactivateChildRoutes(c,l,f);else i&&this.deactivateRouteAndItsChildren(l,f)}deactivateRouteAndItsChildren(c,l){c.value.component&&this.routeReuseStrategy.shouldDetach(c.value.snapshot)?this.detachAndStoreRouteSubtree(c,l):this.deactivateRouteAndOutlet(c,l)}detachAndStoreRouteSubtree(c,l){let f=l.getContext(c.value.outlet),v=f&&c.value.component?f.children:l,i=Im(c);for(let C of Object.values(i))this.deactivateRouteAndItsChildren(C,v);if(f&&f.outlet){let C=f.outlet.detach(),k=f.children.onOutletDeactivated();this.routeReuseStrategy.store(c.value.snapshot,{componentRef:C,route:c,contexts:k})}}deactivateRouteAndOutlet(c,l){let f=l.getContext(c.value.outlet),v=f&&c.value.component?f.children:l,i=Im(c);for(let C of Object.values(i))this.deactivateRouteAndItsChildren(C,v);f&&(f.outlet&&(f.outlet.deactivate(),f.children.onOutletDeactivated()),f.attachRef=null,f.route=null)}activateChildRoutes(c,l,f){let v=Im(l);c.children.forEach(i=>{this.activateRoutes(i,v[i.value.outlet],f),this.forwardEvent(new jw(i.value.snapshot))}),c.children.length&&this.forwardEvent(new Bw(c.value.snapshot))}activateRoutes(c,l,f){let v=c.value,i=l?l.value:null;if(oC(v),v===i)if(v.component){let C=f.getOrCreateContext(v.outlet);this.activateChildRoutes(c,l,C.children)}else this.activateChildRoutes(c,l,f);else if(v.component){let C=f.getOrCreateContext(v.outlet);if(this.routeReuseStrategy.shouldAttach(v.snapshot)){let k=this.routeReuseStrategy.retrieve(v.snapshot);this.routeReuseStrategy.store(v.snapshot,null),C.children.onOutletReAttached(k.contexts),C.attachRef=k.componentRef,C.route=k.route.value,C.outlet&&C.outlet.attach(k.componentRef,k.route.value),oC(k.route.value),this.activateChildRoutes(c,null,C.children)}else C.attachRef=null,C.route=v,C.outlet&&C.outlet.activateWith(v,C.injector),this.activateChildRoutes(c,null,C.children)}else this.activateChildRoutes(c,null,f)}},qw=class{path;route;constructor(c){this.path=c,this.route=this.path[this.path.length-1]}},Cm=class{component;route;constructor(c,l){this.component=c,this.route=l}};function yG(s,c,l){let f=s._root,v=c?c._root:null;return Jy(f,v,l,[f.value])}function vG(s){let c=s.routeConfig?s.routeConfig.canActivateChild:null;return!c||c.length===0?null:{node:s,guards:c}}function km(s,c){let l=Symbol(),f=c.get(s,l);return f===l?typeof s=="function"&&!fI(s)?s:c.get(s):f}function Jy(s,c,l,f,v={canDeactivateChecks:[],canActivateChecks:[]}){let i=Im(c);return s.children.forEach(C=>{xG(C,i[C.value.outlet],l,f.concat([C.value]),v),delete i[C.value.outlet]}),Object.entries(i).forEach(([C,k])=>ev(k,l.getContext(C),v)),v}function xG(s,c,l,f,v={canDeactivateChecks:[],canActivateChecks:[]}){let i=s.value,C=c?c.value:null,k=l?l.getContext(s.value.outlet):null;if(C&&i.routeConfig===C.routeConfig){let B=bG(C,i,i.routeConfig.runGuardsAndResolvers);B?v.canActivateChecks.push(new qw(f)):(i.data=C.data,i._resolvedData=C._resolvedData),i.component?Jy(s,c,k?k.children:null,f,v):Jy(s,c,l,f,v),B&&k&&k.outlet&&k.outlet.isActivated&&v.canDeactivateChecks.push(new Cm(k.outlet.component,C))}else C&&ev(c,k,v),v.canActivateChecks.push(new qw(f)),i.component?Jy(s,null,k?k.children:null,f,v):Jy(s,null,l,f,v);return v}function bG(s,c,l){if(typeof l=="function")return l(s,c);switch(l){case"pathParamsChange":return!Yh(s.url,c.url);case"pathParamsOrQueryParamsChange":return!Yh(s.url,c.url)||!zl(s.queryParams,c.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!pC(s,c)||!zl(s.queryParams,c.queryParams);case"paramsChange":default:return!pC(s,c)}}function ev(s,c,l){let f=Im(s),v=s.value;Object.entries(f).forEach(([i,C])=>{v.component?c?ev(C,c.children.getContext(i),l):ev(C,null,l):ev(C,c,l)}),v.component?c&&c.outlet&&c.outlet.isActivated?l.canDeactivateChecks.push(new Cm(c.outlet.component,v)):l.canDeactivateChecks.push(new Cm(null,v)):l.canDeactivateChecks.push(new Cm(null,v))}function hv(s){return typeof s=="function"}function wG(s){return typeof s=="boolean"}function EG(s){return s&&hv(s.canLoad)}function TG(s){return s&&hv(s.canActivate)}function IG(s){return s&&hv(s.canActivateChild)}function SG(s){return s&&hv(s.canDeactivate)}function DG(s){return s&&hv(s.canMatch)}function sN(s){return s instanceof bc||s?.name==="EmptyError"}var Sw=Symbol("INITIAL_VALUE");function Lm(){return Co(s=>wh(s.map(c=>c.pipe(Js(1),ny(Sw)))).pipe(Ln(c=>{for(let l of c)if(l!==!0){if(l===Sw)return Sw;if(l===!1||CG(l))return l}return!0}),go(c=>c!==Sw),Js(1)))}function CG(s){return rd(s)||s instanceof Om}function AG(s,c){return $r(l=>{let{targetSnapshot:f,currentSnapshot:v,guards:{canActivateChecks:i,canDeactivateChecks:C}}=l;return C.length===0&&i.length===0?mn(di(Bt({},l),{guardsResult:!0})):MG(C,f,v,s).pipe($r(k=>k&&wG(k)?RG(f,i,s,c):mn(k)),Ln(k=>di(Bt({},l),{guardsResult:k})))})}function MG(s,c,l,f){return Tr(s).pipe($r(v=>kG(v.component,v.route,l,c,f)),Ec(v=>v!==!0,!0))}function RG(s,c,l,f){return Tr(c).pipe(Al(v=>Vu(OG(v.route.parent,f),PG(v.route,f),FG(s,v.path,l),LG(s,v.route,l))),Ec(v=>v!==!0,!0))}function PG(s,c){return s!==null&&c&&c(new Vw(s)),mn(!0)}function OG(s,c){return s!==null&&c&&c(new zw(s)),mn(!0)}function LG(s,c,l){let f=c.routeConfig?c.routeConfig.canActivate:null;if(!f||f.length===0)return mn(!0);let v=f.map(i=>ey(()=>{let C=Fm(c)??l,k=km(i,C),B=TG(k)?k.canActivate(c,s):vo(C,()=>k(c,s));return jc(B).pipe(Ec())}));return mn(v).pipe(Lm())}function FG(s,c,l){let f=c[c.length-1],i=c.slice(0,c.length-1).reverse().map(C=>vG(C)).filter(C=>C!==null).map(C=>ey(()=>{let k=C.guards.map(B=>{let ee=Fm(C.node)??l,_e=km(B,ee),Oe=IG(_e)?_e.canActivateChild(f,s):vo(ee,()=>_e(f,s));return jc(Oe).pipe(Ec())});return mn(k).pipe(Lm())}));return mn(i).pipe(Lm())}function kG(s,c,l,f,v){let i=c&&c.routeConfig?c.routeConfig.canDeactivate:null;if(!i||i.length===0)return mn(!0);let C=i.map(k=>{let B=Fm(c)??v,ee=km(k,B),_e=SG(ee)?ee.canDeactivate(s,c,l,f):vo(B,()=>ee(s,c,l,f));return jc(_e).pipe(Ec())});return mn(C).pipe(Lm())}function NG(s,c,l,f){let v=c.canLoad;if(v===void 0||v.length===0)return mn(!0);let i=v.map(C=>{let k=km(C,s),B=EG(k)?k.canLoad(c,l):vo(s,()=>k(c,l));return jc(B)});return mn(i).pipe(Lm(),aN(f))}function aN(s){return HT(Br(c=>{if(typeof c!="boolean")throw Gw(s,c)}),Ln(c=>c===!0))}function zG(s,c,l,f){let v=c.canMatch;if(!v||v.length===0)return mn(!0);let i=v.map(C=>{let k=km(C,s),B=DG(k)?k.canMatch(c,l):vo(s,()=>k(c,l));return jc(B)});return mn(i).pipe(Lm(),aN(f))}var av=class{segmentGroup;constructor(c){this.segmentGroup=c||null}},lv=class extends Error{urlTree;constructor(c){super(),this.urlTree=c}};function Tm(s){return Xa(new av(s))}function BG(s){return Xa(new tn(4e3,!1))}function VG(s){return Xa(rN(!1,ps.GuardRejected))}var _C=class{urlSerializer;urlTree;constructor(c,l){this.urlSerializer=c,this.urlTree=l}lineralizeSegments(c,l){let f=[],v=l.root;for(;;){if(f=f.concat(v.segments),v.numberOfChildren===0)return mn(f);if(v.numberOfChildren>1||!v.children[ti])return BG(`${c.redirectTo}`);v=v.children[ti]}}applyRedirectCommands(c,l,f,v,i){return jG(l,v,i).pipe(Ln(C=>{if(C instanceof Vl)throw new lv(C);let k=this.applyRedirectCreateUrlTree(C,this.urlSerializer.parse(C),c,f);if(C[0]==="/")throw new lv(k);return k}))}applyRedirectCreateUrlTree(c,l,f,v){let i=this.createSegmentGroup(c,l.root,f,v);return new Vl(i,this.createQueryParams(l.queryParams,this.urlTree.queryParams),l.fragment)}createQueryParams(c,l){let f={};return Object.entries(c).forEach(([v,i])=>{if(typeof i=="string"&&i[0]===":"){let k=i.substring(1);f[v]=l[k]}else f[v]=i}),f}createSegmentGroup(c,l,f,v){let i=this.createSegments(c,l.segments,f,v),C={};return Object.entries(l.children).forEach(([k,B])=>{C[k]=this.createSegmentGroup(c,B,f,v)}),new Wi(i,C)}createSegments(c,l,f,v){return l.map(i=>i.path[0]===":"?this.findPosParam(c,i,v):this.findOrReturn(i,f))}findPosParam(c,l,f){let v=f[l.path.substring(1)];if(!v)throw new tn(4001,!1);return v}findOrReturn(c,l){let f=0;for(let v of l){if(v.path===c.path)return l.splice(f),v;f++}return c}};function jG(s,c,l){if(typeof s=="string")return mn(s);let f=s,{queryParams:v,fragment:i,routeConfig:C,url:k,outlet:B,params:ee,data:_e,title:Oe}=c;return jc(vo(l,()=>f({params:ee,data:_e,queryParams:v,fragment:i,routeConfig:C,url:k,outlet:B,title:Oe})))}var yC={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function UG(s,c,l,f,v){let i=lN(s,c,l);return i.matched?(f=uG(c,f),zG(f,c,l,v).pipe(Ln(C=>C===!0?i:Bt({},yC)))):mn(i)}function lN(s,c,l){if(c.path==="**")return HG(l);if(c.path==="")return c.pathMatch==="full"&&(s.hasChildren()||l.length>0)?Bt({},yC):{matched:!0,consumedSegments:[],remainingSegments:l,parameters:{},positionalParamSegments:{}};let v=(c.matcher||Nk)(l,s,c);if(!v)return Bt({},yC);let i={};Object.entries(v.posParams??{}).forEach(([k,B])=>{i[k]=B.path});let C=v.consumed.length>0?Bt(Bt({},i),v.consumed[v.consumed.length-1].parameters):i;return{matched:!0,consumedSegments:v.consumed,remainingSegments:l.slice(v.consumed.length),parameters:C,positionalParamSegments:v.posParams??{}}}function HG(s){return{matched:!0,parameters:s.length>0?Bk(s).parameters:{},consumedSegments:s,remainingSegments:[],positionalParamSegments:{}}}function Lk(s,c,l,f){return l.length>0&&qG(s,l,f)?{segmentGroup:new Wi(c,GG(f,new Wi(l,s.children))),slicedSegments:[]}:l.length===0&&WG(s,l,f)?{segmentGroup:new Wi(s.segments,$G(s,l,f,s.children)),slicedSegments:l}:{segmentGroup:new Wi(s.segments,s.children),slicedSegments:l}}function $G(s,c,l,f){let v={};for(let i of l)if(Zw(s,c,i)&&!f[sl(i)]){let C=new Wi([],{});v[sl(i)]=C}return Bt(Bt({},f),v)}function GG(s,c){let l={};l[ti]=c;for(let f of s)if(f.path===""&&sl(f)!==ti){let v=new Wi([],{});l[sl(f)]=v}return l}function qG(s,c,l){return l.some(f=>Zw(s,c,f)&&sl(f)!==ti)}function WG(s,c,l){return l.some(f=>Zw(s,c,f))}function Zw(s,c,l){return(s.hasChildren()||c.length>0)&&l.pathMatch==="full"?!1:l.path===""}function ZG(s,c,l){return c.length===0&&!s.children[l]}var vC=class{};function XG(s,c,l,f,v,i,C="emptyOnly"){return new xC(s,c,l,f,v,C,i).recognize()}var YG=31,xC=class{injector;configLoader;rootComponentType;config;urlTree;paramsInheritanceStrategy;urlSerializer;applyRedirects;absoluteRedirectCount=0;allowRedirects=!0;constructor(c,l,f,v,i,C,k){this.injector=c,this.configLoader=l,this.rootComponentType=f,this.config=v,this.urlTree=i,this.paramsInheritanceStrategy=C,this.urlSerializer=k,this.applyRedirects=new _C(this.urlSerializer,this.urlTree)}noMatchError(c){return new tn(4002,`'${c.segmentGroup}'`)}recognize(){let c=Lk(this.urlTree.root,[],[],this.config).segmentGroup;return this.match(c).pipe(Ln(({children:l,rootSnapshot:f})=>{let v=new na(f,l),i=new ov("",v),C=Zk(f,[],this.urlTree.queryParams,this.urlTree.fragment);return C.queryParams=this.urlTree.queryParams,i.url=this.urlSerializer.serialize(C),{state:i,tree:C}}))}match(c){let l=new Kh([],Object.freeze({}),Object.freeze(Bt({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),ti,this.rootComponentType,null,{});return this.processSegmentGroup(this.injector,this.config,c,ti,l).pipe(Ln(f=>({children:f,rootSnapshot:l})),Ks(f=>{if(f instanceof lv)return this.urlTree=f.urlTree,this.match(f.urlTree.root);throw f instanceof av?this.noMatchError(f):f}))}processSegmentGroup(c,l,f,v,i){return f.segments.length===0&&f.hasChildren()?this.processChildren(c,l,f,i):this.processSegment(c,l,f,f.segments,v,!0,i).pipe(Ln(C=>C instanceof na?[C]:[]))}processChildren(c,l,f,v){let i=[];for(let C of Object.keys(f.children))C==="primary"?i.unshift(C):i.push(C);return Tr(i).pipe(Al(C=>{let k=f.children[C],B=dG(l,C);return this.processSegmentGroup(c,B,k,C,v)}),KT((C,k)=>(C.push(...k),C)),ju(null),YT(),$r(C=>{if(C===null)return Tm(f);let k=cN(C);return KG(k),mn(k)}))}processSegment(c,l,f,v,i,C,k){return Tr(l).pipe(Al(B=>this.processSegmentAgainstRoute(B._injector??c,l,B,f,v,i,C,k).pipe(Ks(ee=>{if(ee instanceof av)return mn(null);throw ee}))),Ec(B=>!!B),Ks(B=>{if(sN(B))return ZG(f,v,i)?mn(new vC):Tm(f);throw B}))}processSegmentAgainstRoute(c,l,f,v,i,C,k,B){return sl(f)!==C&&(C===ti||!Zw(v,i,f))?Tm(v):f.redirectTo===void 0?this.matchSegmentAgainstRoute(c,v,f,i,C,B):this.allowRedirects&&k?this.expandSegmentAgainstRouteUsingRedirect(c,v,l,f,i,C,B):Tm(v)}expandSegmentAgainstRouteUsingRedirect(c,l,f,v,i,C,k){let{matched:B,parameters:ee,consumedSegments:_e,positionalParamSegments:Oe,remainingSegments:ct}=lN(l,v,i);if(!B)return Tm(l);typeof v.redirectTo=="string"&&v.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>YG&&(this.allowRedirects=!1));let Fe=new Kh(i,ee,Object.freeze(Bt({},this.urlTree.queryParams)),this.urlTree.fragment,Fk(v),sl(v),v.component??v._loadedComponent??null,v,kk(v)),yt=$w(Fe,k,this.paramsInheritanceStrategy);return Fe.params=Object.freeze(yt.params),Fe.data=Object.freeze(yt.data),this.applyRedirects.applyRedirectCommands(_e,v.redirectTo,Oe,Fe,c).pipe(Co(At=>this.applyRedirects.lineralizeSegments(v,At)),$r(At=>this.processSegment(c,f,l,At.concat(ct),C,!1,k)))}matchSegmentAgainstRoute(c,l,f,v,i,C){let k=UG(l,f,v,c,this.urlSerializer);return f.path==="**"&&(l.children={}),k.pipe(Co(B=>B.matched?(c=f._injector??c,this.getChildConfig(c,f,v).pipe(Co(({routes:ee})=>{let _e=f._loadedInjector??c,{parameters:Oe,consumedSegments:ct,remainingSegments:Fe}=B,yt=new Kh(ct,Oe,Object.freeze(Bt({},this.urlTree.queryParams)),this.urlTree.fragment,Fk(f),sl(f),f.component??f._loadedComponent??null,f,kk(f)),Xt=$w(yt,C,this.paramsInheritanceStrategy);yt.params=Object.freeze(Xt.params),yt.data=Object.freeze(Xt.data);let{segmentGroup:At,slicedSegments:Lt}=Lk(l,ct,Fe,ee);if(Lt.length===0&&At.hasChildren())return this.processChildren(_e,ee,At,yt).pipe(Ln(Sr=>new na(yt,Sr)));if(ee.length===0&&Lt.length===0)return mn(new na(yt,[]));let qn=sl(f)===i;return this.processSegment(_e,ee,At,Lt,qn?ti:i,!0,yt).pipe(Ln(Sr=>new na(yt,Sr instanceof na?[Sr]:[])))}))):Tm(l)))}getChildConfig(c,l,f){return l.children?mn({routes:l.children,injector:c}):l.loadChildren?l._loadedRoutes!==void 0?mn({routes:l._loadedRoutes,injector:l._loadedInjector}):NG(c,l,f,this.urlSerializer).pipe($r(v=>v?this.configLoader.loadChildren(c,l).pipe(Br(i=>{l._loadedRoutes=i.routes,l._loadedInjector=i.injector})):VG(l))):mn({routes:[],injector:c})}};function KG(s){s.sort((c,l)=>c.value.outlet===ti?-1:l.value.outlet===ti?1:c.value.outlet.localeCompare(l.value.outlet))}function JG(s){let c=s.value.routeConfig;return c&&c.path===""}function cN(s){let c=[],l=new Set;for(let f of s){if(!JG(f)){c.push(f);continue}let v=c.find(i=>f.value.routeConfig===i.value.routeConfig);v!==void 0?(v.children.push(...f.children),l.add(v)):c.push(f)}for(let f of l){let v=cN(f.children);c.push(new na(f.value,v))}return c.filter(f=>!l.has(f))}function Fk(s){return s.data||{}}function kk(s){return s.resolve||{}}function QG(s,c,l,f,v,i){return $r(C=>XG(s,c,l,f,C.extractedUrl,v,i).pipe(Ln(({state:k,tree:B})=>di(Bt({},C),{targetSnapshot:k,urlAfterRedirects:B}))))}function e8(s,c){return $r(l=>{let{targetSnapshot:f,guards:{canActivateChecks:v}}=l;if(!v.length)return mn(l);let i=new Set(v.map(B=>B.route)),C=new Set;for(let B of i)if(!C.has(B))for(let ee of uN(B))C.add(ee);let k=0;return Tr(C).pipe(Al(B=>i.has(B)?t8(B,f,s,c):(B.data=$w(B,B.parent,s).resolve,mn(void 0))),Br(()=>k++),Yp(1),$r(B=>k===C.size?mn(l):As))})}function uN(s){let c=s.children.map(l=>uN(l)).flat();return[s,...c]}function t8(s,c,l,f){let v=s.routeConfig,i=s._resolve;return v?.title!==void 0&&!tN(v)&&(i[cv]=v.title),ey(()=>(s.data=$w(s,s.parent,l).resolve,n8(i,s,c,f).pipe(Ln(C=>(s._resolvedData=C,s.data=Bt(Bt({},s.data),C),null)))))}function n8(s,c,l,f){let v=lC(s);if(v.length===0)return mn({});let i={};return Tr(v).pipe($r(C=>i8(s[C],c,l,f).pipe(Ec(),Br(k=>{if(k instanceof Om)throw Gw(new id,k);i[C]=k}))),Yp(1),Ln(()=>i),Ks(C=>sN(C)?As:Xa(C)))}function i8(s,c,l,f){let v=Fm(c)??f,i=km(s,v),C=i.resolve?i.resolve(c,l):vo(v,()=>i(c,l));return jc(C)}function sC(s){return Co(c=>{let l=s(c);return l?Tr(l).pipe(Ln(()=>c)):mn(c)})}var IC=(()=>{class s{buildTitle(l){let f,v=l.root;for(;v!==void 0;)f=this.getResolvedTitleForRoute(v)??f,v=v.children.find(i=>i.outlet===ti);return f}getResolvedTitleForRoute(l){return l.data[cv]}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>pt(dN),providedIn:"root"})}return s})(),dN=(()=>{class s extends IC{title;constructor(l){super(),this.title=l}updateTitle(l){let f=this.buildTitle(l);f!==void 0&&this.title.setTitle(f)}static \u0275fac=function(f){return new(f||s)(ln(Ck))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),sd=new Kt("",{providedIn:"root",factory:()=>({})}),tf=new Kt(""),Xw=(()=>{class s{componentLoaders=new WeakMap;childrenLoaders=new WeakMap;onLoadStartListener;onLoadEndListener;compiler=pt(AD);loadComponent(l,f){if(this.componentLoaders.get(f))return this.componentLoaders.get(f);if(f._loadedComponent)return mn(f._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(f);let v=jc(vo(l,()=>f.loadComponent())).pipe(Ln(fN),Co(pN),Br(C=>{this.onLoadEndListener&&this.onLoadEndListener(f),f._loadedComponent=C}),wc(()=>{this.componentLoaders.delete(f)})),i=new Wp(v,()=>new Er).pipe(qp());return this.componentLoaders.set(f,i),i}loadChildren(l,f){if(this.childrenLoaders.get(f))return this.childrenLoaders.get(f);if(f._loadedRoutes)return mn({routes:f._loadedRoutes,injector:f._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(f);let i=hN(f,this.compiler,l,this.onLoadEndListener).pipe(wc(()=>{this.childrenLoaders.delete(f)})),C=new Wp(i,()=>new Er).pipe(qp());return this.childrenLoaders.set(f,C),C}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function hN(s,c,l,f){return jc(vo(l,()=>s.loadChildren())).pipe(Ln(fN),Co(pN),$r(v=>v instanceof sw||Array.isArray(v)?mn(v):Tr(c.compileModuleAsync(v))),Ln(v=>{f&&f(s);let i,C,k=!1;return Array.isArray(v)?(C=v,k=!0):(i=v.create(l).injector,C=i.get(tf,[],{optional:!0,self:!0}).flat()),{routes:C.map(TC),injector:i}}))}function r8(s){return s&&typeof s=="object"&&"default"in s}function fN(s){return r8(s)?s.default:s}function pN(s){return mn(s)}var Yw=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>pt(o8),providedIn:"root"})}return s})(),o8=(()=>{class s{shouldProcessUrl(l){return!0}extract(l){return l}merge(l,f){return l}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),SC=new Kt(""),DC=new Kt("");function mN(s,c,l){let f=s.get(DC),v=s.get(Qi);if(!v.startViewTransition||f.skipNextTransition)return f.skipNextTransition=!1,new Promise(ee=>setTimeout(ee));let i,C=new Promise(ee=>{i=ee}),k=v.startViewTransition(()=>(i(),s8(s)));k.ready.catch(ee=>{});let{onViewTransitionCreated:B}=f;return B&&vo(s,()=>B({transition:k,from:c,to:l})),C}function s8(s){return new Promise(c=>{Cy({read:()=>setTimeout(c)},{injector:s})})}var CC=new Kt(""),Kw=(()=>{class s{currentNavigation=ba(null,{equal:()=>!1});currentTransition=null;lastSuccessfulNavigation=null;events=new Er;transitionAbortWithErrorSubject=new Er;configLoader=pt(Xw);environmentInjector=pt(Gr);destroyRef=pt(Fl);urlSerializer=pt(Qh);rootContexts=pt(ef);location=pt(Qu);inputBindingEnabled=pt(dv,{optional:!0})!==null;titleStrategy=pt(IC);options=pt(sd,{optional:!0})||{};paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly";urlHandlingStrategy=pt(Yw);createViewTransition=pt(SC,{optional:!0});navigationErrorHandler=pt(CC,{optional:!0});navigationId=0;get hasRequestedNavigation(){return this.navigationId!==0}transitions;afterPreactivation=()=>mn(void 0);rootComponentType=null;destroyed=!1;constructor(){let l=v=>this.events.next(new kw(v)),f=v=>this.events.next(new Nw(v));this.configLoader.onLoadEndListener=f,this.configLoader.onLoadStartListener=l,this.destroyRef.onDestroy(()=>{this.destroyed=!0})}complete(){this.transitions?.complete()}handleNavigationRequest(l){let f=++this.navigationId;$o(()=>{this.transitions?.next(di(Bt({},l),{extractedUrl:this.urlHandlingStrategy.extract(l.rawUrl),targetSnapshot:null,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null,abortController:new AbortController,id:f}))})}setupNavigations(l){return this.transitions=new Do(null),this.transitions.pipe(go(f=>f!==null),Co(f=>{let v=!1;return mn(f).pipe(Co(i=>{if(this.navigationId>f.id)return this.cancelNavigationTransition(f,"",ps.SupersededByNewNavigation),As;this.currentTransition=f,this.currentNavigation.set({id:i.id,initialUrl:i.rawUrl,extractedUrl:i.extractedUrl,targetBrowserUrl:typeof i.extras.browserUrl=="string"?this.urlSerializer.parse(i.extras.browserUrl):i.extras.browserUrl,trigger:i.source,extras:i.extras,previousNavigation:this.lastSuccessfulNavigation?di(Bt({},this.lastSuccessfulNavigation),{previousNavigation:null}):null,abort:()=>i.abortController.abort()});let C=!l.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),k=i.extras.onSameUrlNavigation??l.onSameUrlNavigation;if(!C&&k!=="reload")return this.events.next(new jl(i.id,this.urlSerializer.serialize(i.rawUrl),"",Am.IgnoredSameUrlNavigation)),i.resolve(!1),As;if(this.urlHandlingStrategy.shouldProcessUrl(i.rawUrl))return mn(i).pipe(Co(B=>(this.events.next(new od(B.id,this.urlSerializer.serialize(B.extractedUrl),B.source,B.restoredState)),B.id!==this.navigationId?As:Promise.resolve(B))),QG(this.environmentInjector,this.configLoader,this.rootComponentType,l.config,this.urlSerializer,this.paramsInheritanceStrategy),Br(B=>{f.targetSnapshot=B.targetSnapshot,f.urlAfterRedirects=B.urlAfterRedirects,this.currentNavigation.update(_e=>(_e.finalUrl=B.urlAfterRedirects,_e));let ee=new nv(B.id,this.urlSerializer.serialize(B.extractedUrl),this.urlSerializer.serialize(B.urlAfterRedirects),B.targetSnapshot);this.events.next(ee)}));if(C&&this.urlHandlingStrategy.shouldProcessUrl(i.currentRawUrl)){let{id:B,extractedUrl:ee,source:_e,restoredState:Oe,extras:ct}=i,Fe=new od(B,this.urlSerializer.serialize(ee),_e,Oe);this.events.next(Fe);let yt=Qk(this.rootComponentType).snapshot;return this.currentTransition=f=di(Bt({},i),{targetSnapshot:yt,urlAfterRedirects:ee,extras:di(Bt({},ct),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.update(Xt=>(Xt.finalUrl=ee,Xt)),mn(f)}else return this.events.next(new jl(i.id,this.urlSerializer.serialize(i.extractedUrl),"",Am.IgnoredByUrlHandlingStrategy)),i.resolve(!1),As}),Br(i=>{let C=new Pw(i.id,this.urlSerializer.serialize(i.extractedUrl),this.urlSerializer.serialize(i.urlAfterRedirects),i.targetSnapshot);this.events.next(C)}),Ln(i=>(this.currentTransition=f=di(Bt({},i),{guards:yG(i.targetSnapshot,i.currentSnapshot,this.rootContexts)}),f)),AG(this.environmentInjector,i=>this.events.next(i)),Br(i=>{if(f.guardsResult=i.guardsResult,i.guardsResult&&typeof i.guardsResult!="boolean")throw Gw(this.urlSerializer,i.guardsResult);let C=new Ow(i.id,this.urlSerializer.serialize(i.extractedUrl),this.urlSerializer.serialize(i.urlAfterRedirects),i.targetSnapshot,!!i.guardsResult);this.events.next(C)}),go(i=>i.guardsResult?!0:(this.cancelNavigationTransition(i,"",ps.GuardRejected),!1)),sC(i=>{if(i.guards.canActivateChecks.length!==0)return mn(i).pipe(Br(C=>{let k=new Lw(C.id,this.urlSerializer.serialize(C.extractedUrl),this.urlSerializer.serialize(C.urlAfterRedirects),C.targetSnapshot);this.events.next(k)}),Co(C=>{let k=!1;return mn(C).pipe(e8(this.paramsInheritanceStrategy,this.environmentInjector),Br({next:()=>k=!0,complete:()=>{k||this.cancelNavigationTransition(C,"",ps.NoDataFromResolver)}}))}),Br(C=>{let k=new Fw(C.id,this.urlSerializer.serialize(C.extractedUrl),this.urlSerializer.serialize(C.urlAfterRedirects),C.targetSnapshot);this.events.next(k)}))}),sC(i=>{let C=k=>{let B=[];if(k.routeConfig?.loadComponent){let ee=Fm(k)??this.environmentInjector;B.push(this.configLoader.loadComponent(ee,k.routeConfig).pipe(Br(_e=>{k.component=_e}),Ln(()=>{})))}for(let ee of k.children)B.push(...C(ee));return B};return wh(C(i.targetSnapshot.root)).pipe(ju(null),Js(1))}),sC(()=>this.afterPreactivation()),Co(()=>{let{currentSnapshot:i,targetSnapshot:C}=f,k=this.createViewTransition?.(this.environmentInjector,i.root,C.root);return k?Tr(k).pipe(Ln(()=>f)):mn(f)}),Ln(i=>{let C=fG(l.routeReuseStrategy,i.targetSnapshot,i.currentRouterState);return this.currentTransition=f=di(Bt({},i),{targetRouterState:C}),this.currentNavigation.update(k=>(k.targetRouterState=C,k)),f}),Br(()=>{this.events.next(new iv)}),_G(this.rootContexts,l.routeReuseStrategy,i=>this.events.next(i),this.inputBindingEnabled),Js(1),Kp(new hi(i=>{let C=f.abortController.signal,k=()=>i.next();return C.addEventListener("abort",k),()=>C.removeEventListener("abort",k)}).pipe(go(()=>!v&&!f.targetRouterState),Br(()=>{this.cancelNavigationTransition(f,f.abortController.signal.reason+"",ps.Aborted)}))),Br({next:i=>{v=!0,this.lastSuccessfulNavigation=$o(this.currentNavigation),this.events.next(new Ia(i.id,this.urlSerializer.serialize(i.extractedUrl),this.urlSerializer.serialize(i.urlAfterRedirects))),this.titleStrategy?.updateTitle(i.targetRouterState.snapshot),i.resolve(!0)},complete:()=>{v=!0}}),Kp(this.transitionAbortWithErrorSubject.pipe(Br(i=>{throw i}))),wc(()=>{v||this.cancelNavigationTransition(f,"",ps.SupersededByNewNavigation),this.currentTransition?.id===f.id&&(this.currentNavigation.set(null),this.currentTransition=null)}),Ks(i=>{if(this.destroyed)return f.resolve(!1),As;if(v=!0,oN(i))this.events.next(new Bl(f.id,this.urlSerializer.serialize(f.extractedUrl),i.message,i.cancellationCode)),gG(i)?this.events.next(new Pm(i.url,i.navigationBehaviorOptions)):f.resolve(!1);else{let C=new Mm(f.id,this.urlSerializer.serialize(f.extractedUrl),i,f.targetSnapshot??void 0);try{let k=vo(this.environmentInjector,()=>this.navigationErrorHandler?.(C));if(k instanceof Om){let{message:B,cancellationCode:ee}=Gw(this.urlSerializer,k);this.events.next(new Bl(f.id,this.urlSerializer.serialize(f.extractedUrl),B,ee)),this.events.next(new Pm(k.redirectTo,k.navigationBehaviorOptions))}else throw this.events.next(C),i}catch(k){this.options.resolveNavigationPromiseOnError?f.resolve(!1):f.reject(k)}}return As}))}))}cancelNavigationTransition(l,f,v){let i=new Bl(l.id,this.urlSerializer.serialize(l.extractedUrl),f,v);this.events.next(i),l.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){let l=this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))),f=$o(this.currentNavigation),v=f?.targetBrowserUrl??f?.extractedUrl;return l.toString()!==v?.toString()&&!f?.extras.skipLocationChange}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function a8(s){return s!==Dm}var gN=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>pt(l8),providedIn:"root"})}return s})(),Ww=class{shouldDetach(c){return!1}store(c,l){}shouldAttach(c){return!1}retrieve(c){return null}shouldReuseRoute(c,l){return c.routeConfig===l.routeConfig}},l8=(()=>{class s extends Ww{static \u0275fac=(()=>{let l;return function(v){return(l||(l=mm(s)))(v||s)}})();static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),_N=(()=>{class s{urlSerializer=pt(Qh);options=pt(sd,{optional:!0})||{};canceledNavigationResolution=this.options.canceledNavigationResolution||"replace";location=pt(Qu);urlHandlingStrategy=pt(Yw);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";currentUrlTree=new Vl;getCurrentUrlTree(){return this.currentUrlTree}rawUrlTree=this.currentUrlTree;getRawUrlTree(){return this.rawUrlTree}createBrowserPath({finalUrl:l,initialUrl:f,targetBrowserUrl:v}){let i=l!==void 0?this.urlHandlingStrategy.merge(l,f):f,C=v??i;return C instanceof Vl?this.urlSerializer.serialize(C):C}commitTransition({targetRouterState:l,finalUrl:f,initialUrl:v}){f&&l?(this.currentUrlTree=f,this.rawUrlTree=this.urlHandlingStrategy.merge(f,v),this.routerState=l):this.rawUrlTree=v}routerState=Qk(null);getRouterState(){return this.routerState}stateMemento=this.createStateMemento();updateStateMemento(){this.stateMemento=this.createStateMemento()}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}resetInternalState({finalUrl:l}){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,l??this.rawUrlTree)}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:()=>pt(c8),providedIn:"root"})}return s})(),c8=(()=>{class s extends _N{currentPageId=0;lastSuccessfulId=-1;restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}registerNonRouterCurrentEntryChangeListener(l){return this.location.subscribe(f=>{f.type==="popstate"&&setTimeout(()=>{l(f.url,f.state,"popstate")})})}handleRouterEvent(l,f){l instanceof od?this.updateStateMemento():l instanceof jl?this.commitTransition(f):l instanceof nv?this.urlUpdateStrategy==="eager"&&(f.extras.skipLocationChange||this.setBrowserUrl(this.createBrowserPath(f),f)):l instanceof iv?(this.commitTransition(f),this.urlUpdateStrategy==="deferred"&&!f.extras.skipLocationChange&&this.setBrowserUrl(this.createBrowserPath(f),f)):l instanceof Bl&&l.code!==ps.SupersededByNewNavigation&&l.code!==ps.Redirect?this.restoreHistory(f):l instanceof Mm?this.restoreHistory(f,!0):l instanceof Ia&&(this.lastSuccessfulId=l.id,this.currentPageId=this.browserPageId)}setBrowserUrl(l,{extras:f,id:v}){let{replaceUrl:i,state:C}=f;if(this.location.isCurrentPathEqualTo(l)||i){let k=this.browserPageId,B=Bt(Bt({},C),this.generateNgRouterState(v,k));this.location.replaceState(l,"",B)}else{let k=Bt(Bt({},C),this.generateNgRouterState(v,this.browserPageId+1));this.location.go(l,"",k)}}restoreHistory(l,f=!1){if(this.canceledNavigationResolution==="computed"){let v=this.browserPageId,i=this.currentPageId-v;i!==0?this.location.historyGo(i):this.getCurrentUrlTree()===l.finalUrl&&i===0&&(this.resetInternalState(l),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(f&&this.resetInternalState(l),this.resetUrlToCurrentUrlTree())}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.getRawUrlTree()),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(l,f){return this.canceledNavigationResolution==="computed"?{navigationId:l,\u0275routerPageId:f}:{navigationId:l}}static \u0275fac=(()=>{let l;return function(v){return(l||(l=mm(s)))(v||s)}})();static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function Jw(s,c){s.events.pipe(go(l=>l instanceof Ia||l instanceof Bl||l instanceof Mm||l instanceof jl),Ln(l=>l instanceof Ia||l instanceof jl?0:(l instanceof Bl?l.code===ps.Redirect||l.code===ps.SupersededByNewNavigation:!1)?2:1),go(l=>l!==2),Js(1)).subscribe(()=>{c()})}var u8={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},d8={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},Ul=(()=>{class s{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}disposed=!1;nonRouterCurrentEntryChangeSubscription;console=pt(aw);stateManager=pt(_N);options=pt(sd,{optional:!0})||{};pendingTasks=pt(kl);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";navigationTransitions=pt(Kw);urlSerializer=pt(Qh);location=pt(Qu);urlHandlingStrategy=pt(Yw);injector=pt(Gr);_events=new Er;get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}navigated=!1;routeReuseStrategy=pt(gN);onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore";config=pt(tf,{optional:!0})?.flat()??[];componentInputBindingEnabled=!!pt(dv,{optional:!0});currentNavigation=this.navigationTransitions.currentNavigation.asReadonly();constructor(){this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this).subscribe({error:l=>{this.console.warn(l)}}),this.subscribeToNavigationEvents()}eventsSubscription=new wr;subscribeToNavigationEvents(){let l=this.navigationTransitions.events.subscribe(f=>{try{let v=this.navigationTransitions.currentTransition,i=$o(this.navigationTransitions.currentNavigation);if(v!==null&&i!==null){if(this.stateManager.handleRouterEvent(f,i),f instanceof Bl&&f.code!==ps.Redirect&&f.code!==ps.SupersededByNewNavigation)this.navigated=!0;else if(f instanceof Ia)this.navigated=!0;else if(f instanceof Pm){let C=f.navigationBehaviorOptions,k=this.urlHandlingStrategy.merge(f.url,v.currentRawUrl),B=Bt({browserUrl:v.extras.browserUrl,info:v.extras.info,skipLocationChange:v.extras.skipLocationChange,replaceUrl:v.extras.replaceUrl||this.urlUpdateStrategy==="eager"||a8(v.source)},C);this.scheduleNavigation(k,Dm,null,B,{resolve:v.resolve,reject:v.reject,promise:v.promise})}}cG(f)&&this._events.next(f)}catch(v){this.navigationTransitions.transitionAbortWithErrorSubject.next(v)}});this.eventsSubscription.add(l)}resetRootComponentType(l){this.routerState.root.component=l,this.navigationTransitions.rootComponentType=l}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),Dm,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((l,f,v)=>{this.navigateToSyncWithBrowser(l,v,f)})}navigateToSyncWithBrowser(l,f,v){let i={replaceUrl:!0},C=v?.navigationId?v:null;if(v){let B=Bt({},v);delete B.navigationId,delete B.\u0275routerPageId,Object.keys(B).length!==0&&(i.state=B)}let k=this.parseUrl(l);this.scheduleNavigation(k,f,C,i).catch(B=>{this.disposed||this.injector.get(Os)(B)})}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return $o(this.navigationTransitions.currentNavigation)}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(l){this.config=l.map(TC),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this._events.unsubscribe(),this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(l,f={}){let{relativeTo:v,queryParams:i,fragment:C,queryParamsHandling:k,preserveFragment:B}=f,ee=B?this.currentUrlTree.fragment:C,_e=null;switch(k??this.options.defaultQueryParamsHandling){case"merge":_e=Bt(Bt({},this.currentUrlTree.queryParams),i);break;case"preserve":_e=this.currentUrlTree.queryParams;break;default:_e=i||null}_e!==null&&(_e=this.removeEmptyProps(_e));let Oe;try{let ct=v?v.snapshot:this.routerState.snapshot.root;Oe=Xk(ct)}catch{(typeof l[0]!="string"||l[0][0]!=="/")&&(l=[]),Oe=this.currentUrlTree.root}return Yk(Oe,l,_e,ee??null)}navigateByUrl(l,f={skipLocationChange:!1}){let v=rd(l)?l:this.parseUrl(l),i=this.urlHandlingStrategy.merge(v,this.rawUrlTree);return this.scheduleNavigation(i,Dm,null,f)}navigate(l,f={skipLocationChange:!1}){return h8(l),this.navigateByUrl(this.createUrlTree(l,f),f)}serializeUrl(l){return this.urlSerializer.serialize(l)}parseUrl(l){try{return this.urlSerializer.parse(l)}catch{return this.console.warn(Dc(4018,!1)),this.urlSerializer.parse("/")}}isActive(l,f){let v;if(f===!0?v=Bt({},u8):f===!1?v=Bt({},d8):v=f,rd(l))return Mk(this.currentUrlTree,l,v);let i=this.parseUrl(l);return Mk(this.currentUrlTree,i,v)}removeEmptyProps(l){return Object.entries(l).reduce((f,[v,i])=>(i!=null&&(f[v]=i),f),{})}scheduleNavigation(l,f,v,i,C){if(this.disposed)return Promise.resolve(!1);let k,B,ee;C?(k=C.resolve,B=C.reject,ee=C.promise):ee=new Promise((Oe,ct)=>{k=Oe,B=ct});let _e=this.pendingTasks.add();return Jw(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(_e))}),this.navigationTransitions.handleNavigationRequest({source:f,restoredState:v,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:l,extras:i,resolve:k,reject:B,promise:ee,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),ee.catch(Oe=>Promise.reject(Oe))}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function h8(s){for(let c=0;c<s.length;c++)if(s[c]==null)throw new tn(4008,!1)}var Qw=(()=>{class s{router;route;tabIndexAttribute;renderer;el;locationStrategy;reactiveHref=ba(null);get href(){return $o(this.reactiveHref)}set href(l){this.reactiveHref.set(l)}target;queryParams;fragment;queryParamsHandling;state;info;relativeTo;isAnchorElement;subscription;onChanges=new Er;applicationErrorHandler=pt(Os);options=pt(sd,{optional:!0});constructor(l,f,v,i,C,k){this.router=l,this.route=f,this.tabIndexAttribute=v,this.renderer=i,this.el=C,this.locationStrategy=k,this.reactiveHref.set(pt(new ym("href"),{optional:!0}));let B=C.nativeElement.tagName?.toLowerCase();this.isAnchorElement=B==="a"||B==="area"||!!(typeof customElements=="object"&&customElements.get(B)?.observedAttributes?.includes?.("href")),this.isAnchorElement?this.setTabIndexIfNotOnNativeEl("0"):this.subscribeToNavigationEventsIfNecessary()}subscribeToNavigationEventsIfNecessary(){if(this.subscription!==void 0||!this.isAnchorElement)return;let l=this.preserveFragment,f=v=>v==="merge"||v==="preserve";l||=f(this.queryParamsHandling),l||=!this.queryParamsHandling&&!f(this.options?.defaultQueryParamsHandling),l&&(this.subscription=this.router.events.subscribe(v=>{v instanceof Ia&&this.updateHref()}))}preserveFragment=!1;skipLocationChange=!1;replaceUrl=!1;setTabIndexIfNotOnNativeEl(l){this.tabIndexAttribute!=null||this.isAnchorElement||this.applyAttributeValue("tabindex",l)}ngOnChanges(l){this.isAnchorElement&&(this.updateHref(),this.subscribeToNavigationEventsIfNecessary()),this.onChanges.next(this)}routerLinkInput=null;set routerLink(l){l==null?(this.routerLinkInput=null,this.setTabIndexIfNotOnNativeEl(null)):(rd(l)?this.routerLinkInput=l:this.routerLinkInput=Array.isArray(l)?l:[l],this.setTabIndexIfNotOnNativeEl("0"))}onClick(l,f,v,i,C){let k=this.urlTree;if(k===null||this.isAnchorElement&&(l!==0||f||v||i||C||typeof this.target=="string"&&this.target!="_self"))return!0;let B={skipLocationChange:this.skipLocationChange,replaceUrl:this.replaceUrl,state:this.state,info:this.info};return this.router.navigateByUrl(k,B)?.catch(ee=>{this.applicationErrorHandler(ee)}),!this.isAnchorElement}ngOnDestroy(){this.subscription?.unsubscribe()}updateHref(){let l=this.urlTree;this.reactiveHref.set(l!==null&&this.locationStrategy?this.locationStrategy?.prepareExternalUrl(this.router.serializeUrl(l))??"":null)}applyAttributeValue(l,f){let v=this.renderer,i=this.el.nativeElement;f!==null?v.setAttribute(i,l,f):v.removeAttribute(i,l)}get urlTree(){return this.routerLinkInput===null?null:rd(this.routerLinkInput)?this.routerLinkInput:this.router.createUrlTree(this.routerLinkInput,{relativeTo:this.relativeTo!==void 0?this.relativeTo:this.route,queryParams:this.queryParams,fragment:this.fragment,queryParamsHandling:this.queryParamsHandling,preserveFragment:this.preserveFragment})}static \u0275fac=function(f){return new(f||s)(ri(Ul),ri(Ns),Iy("tabindex"),ri(Ku),ri(wa),ri(ol))};static \u0275dir=Ls({type:s,selectors:[["","routerLink",""]],hostVars:2,hostBindings:function(f,v){f&1&&rr("click",function(C){return v.onClick(C.button,C.ctrlKey,C.shiftKey,C.altKey,C.metaKey)}),f&2&&Ju("href",v.reactiveHref(),tD)("target",v.target)},inputs:{target:"target",queryParams:"queryParams",fragment:"fragment",queryParamsHandling:"queryParamsHandling",state:"state",info:"info",relativeTo:"relativeTo",preserveFragment:[2,"preserveFragment","preserveFragment",Bc],skipLocationChange:[2,"skipLocationChange","skipLocationChange",Bc],replaceUrl:[2,"replaceUrl","replaceUrl",Bc],routerLink:"routerLink"},features:[Oc]})}return s})();var fv=class{};var yN=(()=>{class s{router;injector;preloadingStrategy;loader;subscription;constructor(l,f,v,i){this.router=l,this.injector=f,this.preloadingStrategy=v,this.loader=i}setUpPreloading(){this.subscription=this.router.events.pipe(go(l=>l instanceof Ia),Al(()=>this.preload())).subscribe(()=>{})}preload(){return this.processRoutes(this.injector,this.router.config)}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}processRoutes(l,f){let v=[];for(let i of f){i.providers&&!i._injector&&(i._injector=_m(i.providers,l,`Route: ${i.path}`));let C=i._injector??l,k=i._loadedInjector??C;(i.loadChildren&&!i._loadedRoutes&&i.canLoad===void 0||i.loadComponent&&!i._loadedComponent)&&v.push(this.preloadConfig(C,i)),(i.children||i._loadedRoutes)&&v.push(this.processRoutes(k,i.children??i._loadedRoutes))}return Tr(v).pipe(Xp())}preloadConfig(l,f){return this.preloadingStrategy.preload(f,()=>{let v;f.loadChildren&&f.canLoad===void 0?v=this.loader.loadChildren(l,f):v=mn(null);let i=v.pipe($r(C=>C===null?mn(void 0):(f._loadedRoutes=C.routes,f._loadedInjector=C.injector,this.processRoutes(C.injector??l,C.routes))));if(f.loadComponent&&!f._loadedComponent){let C=this.loader.loadComponent(l,f);return Tr([i,C]).pipe(Xp())}else return i})}static \u0275fac=function(f){return new(f||s)(ln(Ul),ln(Gr),ln(fv),ln(Xw))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})(),vN=new Kt(""),f8=(()=>{class s{urlSerializer;transitions;viewportScroller;zone;options;routerEventsSubscription;scrollEventsSubscription;lastId=0;lastSource=Dm;restoredId=0;store={};constructor(l,f,v,i,C={}){this.urlSerializer=l,this.transitions=f,this.viewportScroller=v,this.zone=i,this.options=C,C.scrollPositionRestoration||="disabled",C.anchorScrolling||="disabled"}init(){this.options.scrollPositionRestoration!=="disabled"&&this.viewportScroller.setHistoryScrollRestoration("manual"),this.routerEventsSubscription=this.createScrollEvents(),this.scrollEventsSubscription=this.consumeScrollEvents()}createScrollEvents(){return this.transitions.events.subscribe(l=>{l instanceof od?(this.store[this.lastId]=this.viewportScroller.getScrollPosition(),this.lastSource=l.navigationTrigger,this.restoredId=l.restoredState?l.restoredState.navigationId:0):l instanceof Ia?(this.lastId=l.id,this.scheduleScrollEvent(l,this.urlSerializer.parse(l.urlAfterRedirects).fragment)):l instanceof jl&&l.code===Am.IgnoredSameUrlNavigation&&(this.lastSource=void 0,this.restoredId=0,this.scheduleScrollEvent(l,this.urlSerializer.parse(l.url).fragment))})}consumeScrollEvents(){return this.transitions.events.subscribe(l=>{if(!(l instanceof Rm))return;let f={behavior:"instant"};l.position?this.options.scrollPositionRestoration==="top"?this.viewportScroller.scrollToPosition([0,0],f):this.options.scrollPositionRestoration==="enabled"&&this.viewportScroller.scrollToPosition(l.position,f):l.anchor&&this.options.anchorScrolling==="enabled"?this.viewportScroller.scrollToAnchor(l.anchor):this.options.scrollPositionRestoration!=="disabled"&&this.viewportScroller.scrollToPosition([0,0])})}scheduleScrollEvent(l,f){this.zone.runOutsideAngular(()=>Xs(this,null,function*(){yield new Promise(v=>{setTimeout(v),typeof requestAnimationFrame<"u"&&requestAnimationFrame(v)}),this.zone.run(()=>{this.transitions.events.next(new Rm(l,this.lastSource==="popstate"?this.store[this.restoredId]:null,f))})}))}ngOnDestroy(){this.routerEventsSubscription?.unsubscribe(),this.scrollEventsSubscription?.unsubscribe()}static \u0275fac=function(f){_D()};static \u0275prov=Wt({token:s,factory:s.\u0275fac})}return s})();function MC(s,...c){return Ya([{provide:tf,multi:!0,useValue:s},[],{provide:Ns,useFactory:xN,deps:[Ul]},{provide:Oy,multi:!0,useFactory:bN},c.map(l=>l.\u0275providers)])}function xN(s){return s.routerState.root}function pv(s,c){return{\u0275kind:s,\u0275providers:c}}function bN(){let s=pt(jo);return c=>{let l=s.get(Nc);if(c!==l.components[0])return;let f=s.get(Ul),v=s.get(wN);s.get(RC)===1&&f.initialNavigation(),s.get(IN,null,{optional:!0})?.setUpPreloading(),s.get(vN,null,{optional:!0})?.init(),f.resetRootComponentType(l.componentTypes[0]),v.closed||(v.next(),v.complete(),v.unsubscribe())}}var wN=new Kt("",{factory:()=>new Er}),RC=new Kt("",{providedIn:"root",factory:()=>1});function EN(){let s=[{provide:Yb,useValue:!0},{provide:RC,useValue:0},lw(()=>{let c=pt(jo);return c.get(ND,Promise.resolve()).then(()=>new Promise(f=>{let v=c.get(Ul),i=c.get(wN);Jw(v,()=>{f(!0)}),c.get(Kw).afterPreactivation=()=>(f(!0),i.closed?mn(void 0):i),v.initialNavigation()}))})];return pv(2,s)}function TN(){let s=[lw(()=>{pt(Ul).setUpLocationChangeListener()}),{provide:RC,useValue:2}];return pv(3,s)}var IN=new Kt("");function SN(s){return pv(0,[{provide:IN,useExisting:yN},{provide:fv,useExisting:s}])}function DN(){return pv(8,[wC,{provide:dv,useExisting:wC}])}function CN(s){nl("NgRouterViewTransitions");let c=[{provide:SC,useValue:mN},{provide:DC,useValue:Bt({skipNextTransition:!!s?.skipInitialTransition},s)}];return pv(9,c)}var AN=[Qu,{provide:Qh,useClass:id},Ul,ef,{provide:Ns,useFactory:xN,deps:[Ul]},Xw,[]],PC=(()=>{class s{constructor(){}static forRoot(l,f){return{ngModule:s,providers:[AN,[],{provide:tf,multi:!0,useValue:l},[],f?.errorHandler?{provide:CC,useValue:f.errorHandler}:[],{provide:sd,useValue:f||{}},f?.useHash?m8():g8(),p8(),f?.preloadingStrategy?SN(f.preloadingStrategy).\u0275providers:[],f?.initialNavigation?_8(f):[],f?.bindToComponentInputs?DN().\u0275providers:[],f?.enableViewTransitions?CN().\u0275providers:[],y8()]}}static forChild(l){return{ngModule:s,providers:[{provide:tf,multi:!0,useValue:l}]}}static \u0275fac=function(f){return new(f||s)};static \u0275mod=Ro({type:s});static \u0275inj=yo({})}return s})();function p8(){return{provide:vN,useFactory:()=>{let s=pt(ak),c=pt(pr),l=pt(sd),f=pt(Kw),v=pt(Qh);return l.scrollOffset&&s.setOffset(l.scrollOffset),new f8(v,f,s,c,l)}}}function m8(){return{provide:ol,useClass:zD}}function g8(){return{provide:ol,useClass:mw}}function _8(s){return[s.initialNavigation==="disabled"?TN().\u0275providers:[],s.initialNavigation==="enabledBlocking"?EN().\u0275providers:[]]}var AC=new Kt("");function y8(){return[{provide:AC,useFactory:bN},{provide:Oy,multi:!0,useExisting:AC}]}var e1=class s{static \u0275fac=function(l){return new(l||s)};static \u0275cmp=ur({type:s,selectors:[["app-root"]],decls:1,vars:0,template:function(l,f){l&1&&Pr(0,"router-outlet")},dependencies:[uv],encapsulation:2})};var ad={mapboxToken:"pk.eyJ1IjoiZm5zYnJsIiwiYSI6ImNtaHhqbGUwbDAxeGcyanNjazVybGJtdHYifQ.YxqJwN9S4EposFmNb7igWA",googleClientId:"177987336410-qse83le4nl3i65oat3g2b32kk5sji7sq.apps.googleusercontent.com",googleRedirectUri:"postmessage"};var c1=hj(PN());var t1;function v8(){if(t1===void 0&&(t1=null,typeof window<"u")){let s=window;s.trustedTypes!==void 0&&(t1=s.trustedTypes.createPolicy("angular#components",{createHTML:c=>c}))}return t1}function mv(s){return v8()?.createHTML(s)||s}function ON(s){return Error(`Unable to find icon with the name "${s}"`)}function x8(){return Error("Could not find HttpClient for use with Angular Material icons. Please add provideHttpClient() to your providers.")}function LN(s){return Error(`The URL provided to MatIconRegistry was not trusted as a resource URL via Angular's DomSanitizer. Attempted URL was "${s}".`)}function FN(s){return Error(`The literal provided to MatIconRegistry was not trusted as safe HTML by Angular's DomSanitizer. Attempted literal was "${s}".`)}var Uc=class{url;svgText;options;svgElement;constructor(c,l,f){this.url=c,this.svgText=l,this.options=f}},NN=(()=>{class s{_httpClient;_sanitizer;_errorHandler;_document;_svgIconConfigs=new Map;_iconSetConfigs=new Map;_cachedIconsByUrl=new Map;_inProgressUrlFetches=new Map;_fontCssClassesByAlias=new Map;_resolvers=[];_defaultFontSetClass=["material-icons","mat-ligature-font"];constructor(l,f,v,i){this._httpClient=l,this._sanitizer=f,this._errorHandler=i,this._document=v}addSvgIcon(l,f,v){return this.addSvgIconInNamespace("",l,f,v)}addSvgIconLiteral(l,f,v){return this.addSvgIconLiteralInNamespace("",l,f,v)}addSvgIconInNamespace(l,f,v,i){return this._addSvgIconConfig(l,f,new Uc(v,null,i))}addSvgIconResolver(l){return this._resolvers.push(l),this}addSvgIconLiteralInNamespace(l,f,v,i){let C=this._sanitizer.sanitize(Mo.HTML,v);if(!C)throw FN(v);let k=mv(C);return this._addSvgIconConfig(l,f,new Uc("",k,i))}addSvgIconSet(l,f){return this.addSvgIconSetInNamespace("",l,f)}addSvgIconSetLiteral(l,f){return this.addSvgIconSetLiteralInNamespace("",l,f)}addSvgIconSetInNamespace(l,f,v){return this._addSvgIconSetConfig(l,new Uc(f,null,v))}addSvgIconSetLiteralInNamespace(l,f,v){let i=this._sanitizer.sanitize(Mo.HTML,f);if(!i)throw FN(f);let C=mv(i);return this._addSvgIconSetConfig(l,new Uc("",C,v))}registerFontClassAlias(l,f=l){return this._fontCssClassesByAlias.set(l,f),this}classNameForFontAlias(l){return this._fontCssClassesByAlias.get(l)||l}setDefaultFontSetClass(...l){return this._defaultFontSetClass=l,this}getDefaultFontSetClass(){return this._defaultFontSetClass}getSvgIconFromUrl(l){let f=this._sanitizer.sanitize(Mo.RESOURCE_URL,l);if(!f)throw LN(l);let v=this._cachedIconsByUrl.get(f);return v?mn(n1(v)):this._loadSvgIconFromConfig(new Uc(l,null)).pipe(Br(i=>this._cachedIconsByUrl.set(f,i)),Ln(i=>n1(i)))}getNamedSvgIcon(l,f=""){let v=kN(f,l),i=this._svgIconConfigs.get(v);if(i)return this._getSvgFromConfig(i);if(i=this._getIconConfigFromResolvers(f,l),i)return this._svgIconConfigs.set(v,i),this._getSvgFromConfig(i);let C=this._iconSetConfigs.get(f);return C?this._getSvgFromIconSetConfigs(l,C):Xa(ON(v))}ngOnDestroy(){this._resolvers=[],this._svgIconConfigs.clear(),this._iconSetConfigs.clear(),this._cachedIconsByUrl.clear()}_getSvgFromConfig(l){return l.svgText?mn(n1(this._svgElementFromConfig(l))):this._loadSvgIconFromConfig(l).pipe(Ln(f=>n1(f)))}_getSvgFromIconSetConfigs(l,f){let v=this._extractIconWithNameFromAnySet(l,f);if(v)return mn(v);let i=f.filter(C=>!C.svgText).map(C=>this._loadSvgIconSetFromConfig(C).pipe(Ks(k=>{let ee=`Loading icon set URL: ${this._sanitizer.sanitize(Mo.RESOURCE_URL,C.url)} failed: ${k.message}`;return this._errorHandler.handleError(new Error(ee)),mn(null)})));return ty(i).pipe(Ln(()=>{let C=this._extractIconWithNameFromAnySet(l,f);if(!C)throw ON(l);return C}))}_extractIconWithNameFromAnySet(l,f){for(let v=f.length-1;v>=0;v--){let i=f[v];if(i.svgText&&i.svgText.toString().indexOf(l)>-1){let C=this._svgElementFromConfig(i),k=this._extractSvgIconFromSet(C,l,i.options);if(k)return k}}return null}_loadSvgIconFromConfig(l){return this._fetchIcon(l).pipe(Br(f=>l.svgText=f),Ln(()=>this._svgElementFromConfig(l)))}_loadSvgIconSetFromConfig(l){return l.svgText?mn(null):this._fetchIcon(l).pipe(Br(f=>l.svgText=f))}_extractSvgIconFromSet(l,f,v){let i=l.querySelector(`[id="${f}"]`);if(!i)return null;let C=i.cloneNode(!0);if(C.removeAttribute("id"),C.nodeName.toLowerCase()==="svg")return this._setSvgAttributes(C,v);if(C.nodeName.toLowerCase()==="symbol")return this._setSvgAttributes(this._toSvgElement(C),v);let k=this._svgElementFromString(mv("<svg></svg>"));return k.appendChild(C),this._setSvgAttributes(k,v)}_svgElementFromString(l){let f=this._document.createElement("DIV");f.innerHTML=l;let v=f.querySelector("svg");if(!v)throw Error("<svg> tag not found");return v}_toSvgElement(l){let f=this._svgElementFromString(mv("<svg></svg>")),v=l.attributes;for(let i=0;i<v.length;i++){let{name:C,value:k}=v[i];C!=="id"&&f.setAttribute(C,k)}for(let i=0;i<l.childNodes.length;i++)l.childNodes[i].nodeType===this._document.ELEMENT_NODE&&f.appendChild(l.childNodes[i].cloneNode(!0));return f}_setSvgAttributes(l,f){return l.setAttribute("fit",""),l.setAttribute("height","100%"),l.setAttribute("width","100%"),l.setAttribute("preserveAspectRatio","xMidYMid meet"),l.setAttribute("focusable","false"),f&&f.viewBox&&l.setAttribute("viewBox",f.viewBox),l}_fetchIcon(l){let{url:f,options:v}=l,i=v?.withCredentials??!1;if(!this._httpClient)throw x8();if(f==null)throw Error(`Cannot fetch icon from URL "${f}".`);let C=this._sanitizer.sanitize(Mo.RESOURCE_URL,f);if(!C)throw LN(f);let k=this._inProgressUrlFetches.get(C);if(k)return k;let B=this._httpClient.get(C,{responseType:"text",withCredentials:i}).pipe(Ln(ee=>mv(ee)),wc(()=>this._inProgressUrlFetches.delete(C)),QT());return this._inProgressUrlFetches.set(C,B),B}_addSvgIconConfig(l,f,v){return this._svgIconConfigs.set(kN(l,f),v),this}_addSvgIconSetConfig(l,f){let v=this._iconSetConfigs.get(l);return v?v.push(f):this._iconSetConfigs.set(l,[f]),this}_svgElementFromConfig(l){if(!l.svgElement){let f=this._svgElementFromString(l.svgText);this._setSvgAttributes(f,l.options),l.svgElement=f}return l.svgElement}_getIconConfigFromResolvers(l,f){for(let v=0;v<this._resolvers.length;v++){let i=this._resolvers[v](f,l);if(i)return b8(i)?new Uc(i.url,null,i.options):new Uc(i,null)}}static \u0275fac=function(f){return new(f||s)(ln(Em,8),ln(nC),ln(Qi,8),ln(Uo))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function n1(s){return s.cloneNode(!0)}function kN(s,c){return s+":"+c}function b8(s){return!!(s.url&&s.options)}var FC;try{FC=typeof Intl<"u"&&Intl.v8BreakIterator}catch{FC=!1}var i1=(()=>{class s{_platformId=pt(Yu);isBrowser=this._platformId?sk(this._platformId):typeof document=="object"&&!!document;EDGE=this.isBrowser&&/(edge)/i.test(navigator.userAgent);TRIDENT=this.isBrowser&&/(msie|trident)/i.test(navigator.userAgent);BLINK=this.isBrowser&&!!(window.chrome||FC)&&typeof CSS<"u"&&!this.EDGE&&!this.TRIDENT;WEBKIT=this.isBrowser&&/AppleWebKit/i.test(navigator.userAgent)&&!this.BLINK&&!this.EDGE&&!this.TRIDENT;IOS=this.isBrowser&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!("MSStream"in window);FIREFOX=this.isBrowser&&/(firefox|minefield)/i.test(navigator.userAgent);ANDROID=this.isBrowser&&/android/i.test(navigator.userAgent)&&!this.TRIDENT;SAFARI=this.isBrowser&&/safari/i.test(navigator.userAgent)&&this.WEBKIT;constructor(){}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function kC(s){return Array.isArray(s)?s:[s]}var zN=new Set,nf,VN=(()=>{class s{_platform=pt(i1);_nonce=pt(gm,{optional:!0});_matchMedia;constructor(){this._matchMedia=this._platform.isBrowser&&window.matchMedia?window.matchMedia.bind(window):E8}matchMedia(l){return(this._platform.WEBKIT||this._platform.BLINK)&&w8(l,this._nonce),this._matchMedia(l)}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function w8(s,c){if(!zN.has(s))try{nf||(nf=document.createElement("style"),c&&nf.setAttribute("nonce",c),nf.setAttribute("type","text/css"),document.head.appendChild(nf)),nf.sheet&&(nf.sheet.insertRule(`@media ${s} {body{ }}`,0),zN.add(s))}catch(l){console.error(l)}}function E8(s){return{matches:s==="all"||s==="",media:s,addListener:()=>{},removeListener:()=>{}}}var gv=(()=>{class s{_mediaMatcher=pt(VN);_zone=pt(pr);_queries=new Map;_destroySubject=new Er;constructor(){}ngOnDestroy(){this._destroySubject.next(),this._destroySubject.complete()}isMatched(l){return BN(kC(l)).some(v=>this._registerQuery(v).mql.matches)}observe(l){let v=BN(kC(l)).map(C=>this._registerQuery(C).observable),i=wh(v);return i=Vu(i.pipe(Js(1)),i.pipe(eI(1),XT(0))),i.pipe(Ln(C=>{let k={matches:!1,breakpoints:{}};return C.forEach(({matches:B,query:ee})=>{k.matches=k.matches||B,k.breakpoints[ee]=B}),k}))}_registerQuery(l){if(this._queries.has(l))return this._queries.get(l);let f=this._mediaMatcher.matchMedia(l),i={observable:new hi(C=>{let k=B=>this._zone.run(()=>C.next(B));return f.addListener(k),()=>{f.removeListener(k)}}).pipe(ny(f),Ln(({matches:C})=>({query:l,matches:C})),Kp(this._destroySubject)),mql:f};return this._queries.set(l,i),i}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();function BN(s){return s.map(c=>c.split(",")).reduce((c,l)=>c.concat(l)).map(c=>c.trim())}var ld=(function(s){return s[s.NONE=0]="NONE",s[s.BLACK_ON_WHITE=1]="BLACK_ON_WHITE",s[s.WHITE_ON_BLACK=2]="WHITE_ON_BLACK",s})(ld||{}),jN="cdk-high-contrast-black-on-white",UN="cdk-high-contrast-white-on-black",NC="cdk-high-contrast-active",zC=(()=>{class s{_platform=pt(i1);_hasCheckedHighContrastMode;_document=pt(Qi);_breakpointSubscription;constructor(){this._breakpointSubscription=pt(gv).observe("(forced-colors: active)").subscribe(()=>{this._hasCheckedHighContrastMode&&(this._hasCheckedHighContrastMode=!1,this._applyBodyHighContrastModeCssClasses())})}getHighContrastMode(){if(!this._platform.isBrowser)return ld.NONE;let l=this._document.createElement("div");l.style.backgroundColor="rgb(1,2,3)",l.style.position="absolute",this._document.body.appendChild(l);let f=this._document.defaultView||window,v=f&&f.getComputedStyle?f.getComputedStyle(l):null,i=(v&&v.backgroundColor||"").replace(/ /g,"");switch(l.remove(),i){case"rgb(0,0,0)":case"rgb(45,50,54)":case"rgb(32,32,32)":return ld.WHITE_ON_BLACK;case"rgb(255,255,255)":case"rgb(255,250,239)":return ld.BLACK_ON_WHITE}return ld.NONE}ngOnDestroy(){this._breakpointSubscription.unsubscribe()}_applyBodyHighContrastModeCssClasses(){if(!this._hasCheckedHighContrastMode&&this._platform.isBrowser&&this._document.body){let l=this._document.body.classList;l.remove(NC,jN,UN),this._hasCheckedHighContrastMode=!0;let f=this.getHighContrastMode();f===ld.BLACK_ON_WHITE?l.add(NC,jN):f===ld.WHITE_ON_BLACK&&l.add(NC,UN)}}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var BC=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275mod=Ro({type:s});static \u0275inj=yo({})}return s})();var VC=(()=>{class s{constructor(){pt(zC)._applyBodyHighContrastModeCssClasses()}static \u0275fac=function(f){return new(f||s)};static \u0275mod=Ro({type:s});static \u0275inj=yo({imports:[BC,BC]})}return s})();var T8=["*"],I8=new Kt("MAT_ICON_DEFAULT_OPTIONS"),S8=new Kt("mat-icon-location",{providedIn:"root",factory:D8});function D8(){let s=pt(Qi),c=s?s.location:null;return{getPathname:()=>c?c.pathname+c.search:""}}var HN=["clip-path","color-profile","src","cursor","fill","filter","marker","marker-start","marker-mid","marker-end","mask","stroke"],C8=HN.map(s=>`[${s}]`).join(", "),A8=/^url\(['"]?#(.*?)['"]?\)$/,r1=(()=>{class s{_elementRef=pt(wa);_iconRegistry=pt(NN);_location=pt(S8);_errorHandler=pt(Uo);_defaultColor;get color(){return this._color||this._defaultColor}set color(l){this._color=l}_color;inline=!1;get svgIcon(){return this._svgIcon}set svgIcon(l){l!==this._svgIcon&&(l?this._updateSvgIcon(l):this._svgIcon&&this._clearSvgElement(),this._svgIcon=l)}_svgIcon;get fontSet(){return this._fontSet}set fontSet(l){let f=this._cleanupFontValue(l);f!==this._fontSet&&(this._fontSet=f,this._updateFontIconClasses())}_fontSet;get fontIcon(){return this._fontIcon}set fontIcon(l){let f=this._cleanupFontValue(l);f!==this._fontIcon&&(this._fontIcon=f,this._updateFontIconClasses())}_fontIcon;_previousFontSetClass=[];_previousFontIconClass;_svgName;_svgNamespace;_previousPath;_elementsWithExternalReferences;_currentIconFetch=wr.EMPTY;constructor(){let l=pt(new ym("aria-hidden"),{optional:!0}),f=pt(I8,{optional:!0});f&&(f.color&&(this.color=this._defaultColor=f.color),f.fontSet&&(this.fontSet=f.fontSet)),l||this._elementRef.nativeElement.setAttribute("aria-hidden","true")}_splitIconName(l){if(!l)return["",""];let f=l.split(":");switch(f.length){case 1:return["",f[0]];case 2:return f;default:throw Error(`Invalid icon name: "${l}"`)}}ngOnInit(){this._updateFontIconClasses()}ngAfterViewChecked(){let l=this._elementsWithExternalReferences;if(l&&l.size){let f=this._location.getPathname();f!==this._previousPath&&(this._previousPath=f,this._prependPathToReferences(f))}}ngOnDestroy(){this._currentIconFetch.unsubscribe(),this._elementsWithExternalReferences&&this._elementsWithExternalReferences.clear()}_usingFontIcon(){return!this.svgIcon}_setSvgElement(l){this._clearSvgElement();let f=this._location.getPathname();this._previousPath=f,this._cacheChildrenWithExternalReferences(l),this._prependPathToReferences(f),this._elementRef.nativeElement.appendChild(l)}_clearSvgElement(){let l=this._elementRef.nativeElement,f=l.childNodes.length;for(this._elementsWithExternalReferences&&this._elementsWithExternalReferences.clear();f--;){let v=l.childNodes[f];(v.nodeType!==1||v.nodeName.toLowerCase()==="svg")&&v.remove()}}_updateFontIconClasses(){if(!this._usingFontIcon())return;let l=this._elementRef.nativeElement,f=(this.fontSet?this._iconRegistry.classNameForFontAlias(this.fontSet).split(/ +/):this._iconRegistry.getDefaultFontSetClass()).filter(v=>v.length>0);this._previousFontSetClass.forEach(v=>l.classList.remove(v)),f.forEach(v=>l.classList.add(v)),this._previousFontSetClass=f,this.fontIcon!==this._previousFontIconClass&&!f.includes("mat-ligature-font")&&(this._previousFontIconClass&&l.classList.remove(this._previousFontIconClass),this.fontIcon&&l.classList.add(this.fontIcon),this._previousFontIconClass=this.fontIcon)}_cleanupFontValue(l){return typeof l=="string"?l.trim().split(" ")[0]:l}_prependPathToReferences(l){let f=this._elementsWithExternalReferences;f&&f.forEach((v,i)=>{v.forEach(C=>{i.setAttribute(C.name,`url('${l}#${C.value}')`)})})}_cacheChildrenWithExternalReferences(l){let f=l.querySelectorAll(C8),v=this._elementsWithExternalReferences=this._elementsWithExternalReferences||new Map;for(let i=0;i<f.length;i++)HN.forEach(C=>{let k=f[i],B=k.getAttribute(C),ee=B?B.match(A8):null;if(ee){let _e=v.get(k);_e||(_e=[],v.set(k,_e)),_e.push({name:C,value:ee[1]})}})}_updateSvgIcon(l){if(this._svgNamespace=null,this._svgName=null,this._currentIconFetch.unsubscribe(),l){let[f,v]=this._splitIconName(l);f&&(this._svgNamespace=f),v&&(this._svgName=v),this._currentIconFetch=this._iconRegistry.getNamedSvgIcon(v,f).pipe(Js(1)).subscribe(i=>this._setSvgElement(i),i=>{let C=`Error retrieving icon ${f}:${v}! ${i.message}`;this._errorHandler.handleError(new Error(C))})}}static \u0275fac=function(f){return new(f||s)};static \u0275cmp=ur({type:s,selectors:[["mat-icon"]],hostAttrs:["role","img",1,"mat-icon","notranslate"],hostVars:10,hostBindings:function(f,v){f&2&&(Ju("data-mat-icon-type",v._usingFontIcon()?"font":"svg")("data-mat-icon-name",v._svgName||v.fontIcon)("data-mat-icon-namespace",v._svgNamespace||v.fontSet)("fontIcon",v._usingFontIcon()?v.fontIcon:null),DD(v.color?"mat-"+v.color:""),so("mat-icon-inline",v.inline)("mat-icon-no-color",v.color!=="primary"&&v.color!=="accent"&&v.color!=="warn"))},inputs:{color:"color",inline:[2,"inline","inline",Bc],svgIcon:"svgIcon",fontSet:"fontSet",fontIcon:"fontIcon"},exportAs:["matIcon"],ngContentSelectors:T8,decls:1,vars:0,template:function(f,v){f&1&&(ID(),SD(0))},styles:[`mat-icon,mat-icon.mat-primary,mat-icon.mat-accent,mat-icon.mat-warn{color:var(--mat-icon-color, inherit)}.mat-icon{-webkit-user-select:none;user-select:none;background-repeat:no-repeat;display:inline-block;fill:currentColor;height:24px;width:24px;overflow:hidden}.mat-icon.mat-icon-inline{font-size:inherit;height:inherit;line-height:inherit;width:inherit}.mat-icon.mat-ligature-font[fontIcon]::before{content:attr(fontIcon)}[dir=rtl] .mat-icon-rtl-mirror{transform:scale(-1, 1)}.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-prefix .mat-icon,.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-suffix .mat-icon{display:block}.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-prefix .mat-icon-button .mat-icon,.mat-form-field:not(.mat-form-field-appearance-legacy) .mat-form-field-suffix .mat-icon-button .mat-icon{margin:auto}
`],encapsulation:2,changeDetection:0})}return s})(),o1=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275mod=Ro({type:s});static \u0275inj=yo({imports:[VC,VC]})}return s})();var s1=class s{title=zc.required();location=zc.required();dateTime=zc.required();static \u0275fac=function(l){return new(l||s)};static \u0275cmp=ur({type:s,selectors:[["app-event-card"]],inputs:{title:[1,"title"],location:[1,"location"],dateTime:[1,"dateTime"]},decls:15,vars:3,consts:[[1,"card-container"],[1,"info-section"],[1,"title"],[1,"location"],[1,"date-time"],[1,"actions-section"],[1,"icon-circle"]],template:function(l,f){l&1&&(cn(0,"div",0)(1,"div",1)(2,"h3",2),Bn(3),un(),cn(4,"p",3),Bn(5),un(),cn(6,"p",4),Bn(7),un()(),cn(8,"div",5)(9,"div",6)(10,"mat-icon"),Bn(11,"place"),un()(),cn(12,"div",6)(13,"mat-icon"),Bn(14,"favorite"),un()()()()),l&2&&(ei(3),xo(f.title()),ei(2),xo(f.location()),ei(2),xo(f.dateTime()))},dependencies:[o1,r1],styles:[".card-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;background-color:#2c2c2c;border-radius:12px;padding:12px 16px;margin-bottom:12px;color:#fff;font-family:Roboto,sans-serif}.info-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.title[_ngcontent-%COMP%]{margin:0;font-size:14px;font-weight:500;color:#fff}.location[_ngcontent-%COMP%]{margin:0;font-size:12px;color:#fbbc04;font-weight:500}.date-time[_ngcontent-%COMP%]{margin:0;font-size:10px;color:#888}.actions-section[_ngcontent-%COMP%]{display:flex;gap:8px}.icon-circle[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:50%;background-color:#444;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:background-color .2s}.icon-circle[_ngcontent-%COMP%]:hover{background-color:#555}.icon-circle[_ngcontent-%COMP%]:active{transform:scale(.9)}.icon-circle[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px;color:#aaa}"]})};function M8(s,c){if(s&1&&Pr(0,"app-event-card",9),s&2){let l=c.$implicit;Vr("title",l.title)("location",l.location)("dateTime",l.dateTime)}}var a1=class s{events=[{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"},{title:"Title",location:"Location",dateTime:"Day / time"}];static \u0275fac=function(l){return new(l||s)};static \u0275cmp=ur({type:s,selectors:[["app-sidebar"]],decls:14,vars:0,consts:[[1,"sidebar-container"],[1,"header"],[1,"logo"],[1,"search-container"],["type","text","placeholder","Search city, events or user",1,"search-input"],[1,"search-icon"],[1,"events-section"],[1,"section-title"],[1,"events-list"],[3,"title","location","dateTime"]],template:function(l,f){l&1&&(cn(0,"div",0)(1,"div",1)(2,"h1",2),Bn(3,"LUMO"),un()(),cn(4,"div",3),Pr(5,"input",4),cn(6,"mat-icon",5),Bn(7,"search"),un()(),cn(8,"div",6)(9,"h2",7),Bn(10,"FOUND EVENTS"),un(),cn(11,"div",8),ED(12,M8,1,3,"app-event-card",9,wD),un()()()),l&2&&(ei(12),TD(f.events))},dependencies:[o1,r1,s1],styles:[".sidebar-container[_ngcontent-%COMP%]{width:320px;height:95vh;background-color:#1a1a1a;padding:24px;display:flex;flex-direction:column;gap:24px;border-radius:16px;box-shadow:4px 0 12px #0000004d;color:#fff;font-family:Roboto,sans-serif;overflow-y:auto;position:absolute;top:2.5vh;left:20px;z-index:1000}.logo[_ngcontent-%COMP%]{color:#fbbc04;font-size:24px;font-weight:900;margin:0;letter-spacing:1px}.search-container[_ngcontent-%COMP%]{position:relative;width:100%}.search-input[_ngcontent-%COMP%]{width:100%;padding:12px 40px 12px 16px;background-color:#2c2c2c;border:none;border-radius:8px;color:#aaa;font-size:14px;outline:none;box-sizing:border-box}.search-input[_ngcontent-%COMP%]::placeholder{color:#666}.search-icon[_ngcontent-%COMP%]{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:#666;font-size:20px;width:20px;height:20px}.section-title[_ngcontent-%COMP%]{color:#fbbc04;font-size:14px;font-weight:700;margin:0 0 16px;text-transform:uppercase;letter-spacing:.5px}.events-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}"]})};var rf=document.createElement("div");rf.style.width="20px";rf.style.height="20px";rf.style.backgroundColor="#4285F4";rf.style.border="3px solid white";rf.style.borderRadius="50%";rf.style.boxShadow="0 0 3px rgba(0,0,0,0.3)";var l1=class s{map;ngAfterViewInit(){this.map=new c1.Map({accessToken:ad.mapboxToken,container:"map",style:"mapbox://styles/fnsbrl/cmhxy97pz004e01qx08c0gc44",center:[12.4964,41.9028],zoom:18,pitch:60,bearing:-20,antialias:!0}),this.map.dragPan.enable(),this.map.touchZoomRotate.enable({around:"center"}),this.map.touchZoomRotate.disableRotation(),this.map.touchZoomRotate.enable(),navigator.geolocation&&navigator.geolocation.getCurrentPosition(c=>{let l=[c.coords.longitude,c.coords.latitude];this.map.setCenter(l),new c1.Marker({element:rf}).setLngLat(l).addTo(this.map)},c=>{console.warn("Geolocation error:",c)},{enableHighAccuracy:!0})}ngOnDestroy(){this.map&&this.map.remove()}static \u0275fac=function(l){return new(l||s)};static \u0275cmp=ur({type:s,selectors:[["MapView"]],decls:2,vars:0,consts:[["id","map",1,"map-container"]],template:function(l,f){l&1&&Pr(0,"app-sidebar")(1,"div",0)},dependencies:[a1],styles:[".map-container[_ngcontent-%COMP%]{width:100%;height:100vh}"]})};var Hl=class s{constructor(c){this.bp=c;this.bp.observe(["(max-width: 979px)","(min-width: 980px) and (max-width: 1399px)","(min-width: 1400px)"]).subscribe(l=>{l.breakpoints["(max-width: 979px)"]?this.screen.set("mobile"):l.breakpoints["(min-width: 980px) and (max-width: 1399px)"]?this.screen.set("tablet"):this.screen.set("desktop")})}screen=ba("desktop");static \u0275fac=function(l){return new(l||s)(ln(gv))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})};var cd=class s{constructor(c){this.responsive=c}path=zc("");iconAlt=zc("icon");static \u0275fac=function(l){return new(l||s)(ri(Hl))};static \u0275cmp=ur({type:s,selectors:[["CircleIcon"]],inputs:{path:[1,"path"],iconAlt:[1,"iconAlt"]},decls:2,vars:8,consts:[[1,"circle-container"],[1,"icon",3,"src","alt"]],template:function(l,f){l&1&&(Ly(0,"div",0),cw(1,"img",1),Fy()),l&2&&(so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet"),ei(),uw("src",dw(f.path()),Qb)("alt",dw(f.iconAlt())))},styles:[".circle-container[_ngcontent-%COMP%]{padding:3px;height:auto;width:auto;-webkit-border-radius:50%;-moz-border-radius:50%;border-radius:50%;display:flex;justify-content:center;align-items:center;background-color:var(--color-light-gray);cursor:pointer}.icon[_ngcontent-%COMP%]{height:20px;width:20px;color:var(--color-accent, #FCC324)}.circle-container.tablet[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%], .circle-container.mobile[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{height:30px;width:30px}"]})};var JN=(()=>{class s{_renderer;_elementRef;onChange=l=>{};onTouched=()=>{};constructor(l,f){this._renderer=l,this._elementRef=f}setProperty(l,f){this._renderer.setProperty(this._elementRef.nativeElement,l,f)}registerOnTouched(l){this.onTouched=l}registerOnChange(l){this.onChange=l}setDisabledState(l){this.setProperty("disabled",l)}static \u0275fac=function(f){return new(f||s)(ri(Ku),ri(wa))};static \u0275dir=Ls({type:s})}return s})(),P8=(()=>{class s extends JN{static \u0275fac=(()=>{let l;return function(v){return(l||(l=mm(s)))(v||s)}})();static \u0275dir=Ls({type:s,features:[Gh]})}return s})(),QN=new Kt("");var O8={provide:QN,useExisting:Ch(()=>g1),multi:!0};function L8(){let s=Ta()?Ta().getUserAgent():"";return/android (\d+)/.test(s.toLowerCase())}var F8=new Kt(""),g1=(()=>{class s extends JN{_compositionMode;_composing=!1;constructor(l,f,v){super(l,f),this._compositionMode=v,this._compositionMode==null&&(this._compositionMode=!L8())}writeValue(l){let f=l??"";this.setProperty("value",f)}_handleInput(l){(!this._compositionMode||this._compositionMode&&!this._composing)&&this.onChange(l)}_compositionStart(){this._composing=!0}_compositionEnd(l){this._composing=!1,this._compositionMode&&this.onChange(l)}static \u0275fac=function(f){return new(f||s)(ri(Ku),ri(wa),ri(F8,8))};static \u0275dir=Ls({type:s,selectors:[["input","formControlName","",3,"type","checkbox"],["textarea","formControlName",""],["input","formControl","",3,"type","checkbox"],["textarea","formControl",""],["input","ngModel","",3,"type","checkbox"],["textarea","ngModel",""],["","ngDefaultControl",""]],hostBindings:function(f,v){f&1&&rr("input",function(C){return v._handleInput(C.target.value)})("blur",function(){return v.onTouched()})("compositionstart",function(){return v._compositionStart()})("compositionend",function(C){return v._compositionEnd(C.target.value)})},standalone:!1,features:[zy([O8]),Gh]})}return s})();var k8=new Kt(""),N8=new Kt("");function ez(s){return s!=null}function tz(s){return qh(s)?Tr(s):s}function nz(s){let c={};return s.forEach(l=>{c=l!=null?Bt(Bt({},c),l):c}),Object.keys(c).length===0?null:c}function iz(s,c){return c.map(l=>l(s))}function z8(s){return!s.validate}function rz(s){return s.map(c=>z8(c)?c:l=>c.validate(l))}function B8(s){if(!s)return null;let c=s.filter(ez);return c.length==0?null:function(l){return nz(iz(l,c))}}function oz(s){return s!=null?B8(rz(s)):null}function V8(s){if(!s)return null;let c=s.filter(ez);return c.length==0?null:function(l){let f=iz(l,c).map(tz);return ty(f).pipe(Ln(nz))}}function sz(s){return s!=null?V8(rz(s)):null}function GN(s,c){return s===null?[c]:Array.isArray(s)?[...s,c]:[s,c]}function az(s){return s._rawValidators}function lz(s){return s._rawAsyncValidators}function UC(s){return s?Array.isArray(s)?s:[s]:[]}function h1(s,c){return Array.isArray(s)?s.includes(c):s===c}function qN(s,c){let l=UC(c);return UC(s).forEach(v=>{h1(l,v)||l.push(v)}),l}function WN(s,c){return UC(c).filter(l=>!h1(s,l))}var HC=class{get value(){return this.control?this.control.value:null}get valid(){return this.control?this.control.valid:null}get invalid(){return this.control?this.control.invalid:null}get pending(){return this.control?this.control.pending:null}get disabled(){return this.control?this.control.disabled:null}get enabled(){return this.control?this.control.enabled:null}get errors(){return this.control?this.control.errors:null}get pristine(){return this.control?this.control.pristine:null}get dirty(){return this.control?this.control.dirty:null}get touched(){return this.control?this.control.touched:null}get status(){return this.control?this.control.status:null}get untouched(){return this.control?this.control.untouched:null}get statusChanges(){return this.control?this.control.statusChanges:null}get valueChanges(){return this.control?this.control.valueChanges:null}get path(){return null}_composedValidatorFn;_composedAsyncValidatorFn;_rawValidators=[];_rawAsyncValidators=[];_setValidators(c){this._rawValidators=c||[],this._composedValidatorFn=oz(this._rawValidators)}_setAsyncValidators(c){this._rawAsyncValidators=c||[],this._composedAsyncValidatorFn=sz(this._rawAsyncValidators)}get validator(){return this._composedValidatorFn||null}get asyncValidator(){return this._composedAsyncValidatorFn||null}_onDestroyCallbacks=[];_registerOnDestroy(c){this._onDestroyCallbacks.push(c)}_invokeOnDestroyCallbacks(){this._onDestroyCallbacks.forEach(c=>c()),this._onDestroyCallbacks=[]}reset(c=void 0){this.control&&this.control.reset(c)}hasError(c,l){return this.control?this.control.hasError(c,l):!1}getError(c,l){return this.control?this.control.getError(c,l):null}};var bv=class extends HC{_parent=null;name=null;valueAccessor=null},$C=class{_cd;constructor(c){this._cd=c}get isTouched(){return this._cd?.control?._touched?.(),!!this._cd?.control?.touched}get isUntouched(){return!!this._cd?.control?.untouched}get isPristine(){return this._cd?.control?._pristine?.(),!!this._cd?.control?.pristine}get isDirty(){return!!this._cd?.control?.dirty}get isValid(){return this._cd?.control?._status?.(),!!this._cd?.control?.valid}get isInvalid(){return!!this._cd?.control?.invalid}get isPending(){return!!this._cd?.control?.pending}get isSubmitted(){return this._cd?._submitted?.(),!!this._cd?.submitted}},j8={"[class.ng-untouched]":"isUntouched","[class.ng-touched]":"isTouched","[class.ng-pristine]":"isPristine","[class.ng-dirty]":"isDirty","[class.ng-valid]":"isValid","[class.ng-invalid]":"isInvalid","[class.ng-pending]":"isPending"},nde=di(Bt({},j8),{"[class.ng-submitted]":"isSubmitted"}),cz=(()=>{class s extends $C{constructor(l){super(l)}static \u0275fac=function(f){return new(f||s)(ri(bv,2))};static \u0275dir=Ls({type:s,selectors:[["","formControlName",""],["","ngModel",""],["","formControl",""]],hostVars:14,hostBindings:function(f,v){f&2&&so("ng-untouched",v.isUntouched)("ng-touched",v.isTouched)("ng-pristine",v.isPristine)("ng-dirty",v.isDirty)("ng-valid",v.isValid)("ng-invalid",v.isInvalid)("ng-pending",v.isPending)},standalone:!1,features:[Gh]})}return s})();var _v="VALID",d1="INVALID",Nm="PENDING",yv="DISABLED",of=class{},f1=class extends of{value;source;constructor(c,l){super(),this.value=c,this.source=l}},vv=class extends of{pristine;source;constructor(c,l){super(),this.pristine=c,this.source=l}},xv=class extends of{touched;source;constructor(c,l){super(),this.touched=c,this.source=l}},zm=class extends of{status;source;constructor(c,l){super(),this.status=c,this.source=l}};var wv=class extends of{source;constructor(c){super(),this.source=c}};function WC(s){return(_1(s)?s.validators:s)||null}function U8(s){return Array.isArray(s)?oz(s):s||null}function ZC(s,c){return(_1(c)?c.asyncValidators:s)||null}function H8(s){return Array.isArray(s)?sz(s):s||null}function _1(s){return s!=null&&!Array.isArray(s)&&typeof s=="object"}function uz(s,c,l){let f=s.controls;if(!(c?Object.keys(f):f).length)throw new tn(1e3,"");if(!f[l])throw new tn(1001,"")}function dz(s,c,l){s._forEachChild((f,v)=>{if(l[v]===void 0)throw new tn(1002,"")})}var Bm=class{_pendingDirty=!1;_hasOwnPendingAsyncValidator=null;_pendingTouched=!1;_onCollectionChange=()=>{};_updateOn;_parent=null;_asyncValidationSubscription;_composedValidatorFn;_composedAsyncValidatorFn;_rawValidators;_rawAsyncValidators;value;constructor(c,l){this._assignValidators(c),this._assignAsyncValidators(l)}get validator(){return this._composedValidatorFn}set validator(c){this._rawValidators=this._composedValidatorFn=c}get asyncValidator(){return this._composedAsyncValidatorFn}set asyncValidator(c){this._rawAsyncValidators=this._composedAsyncValidatorFn=c}get parent(){return this._parent}get status(){return $o(this.statusReactive)}set status(c){$o(()=>this.statusReactive.set(c))}_status=By(()=>this.statusReactive());statusReactive=ba(void 0);get valid(){return this.status===_v}get invalid(){return this.status===d1}get pending(){return this.status==Nm}get disabled(){return this.status===yv}get enabled(){return this.status!==yv}errors;get pristine(){return $o(this.pristineReactive)}set pristine(c){$o(()=>this.pristineReactive.set(c))}_pristine=By(()=>this.pristineReactive());pristineReactive=ba(!0);get dirty(){return!this.pristine}get touched(){return $o(this.touchedReactive)}set touched(c){$o(()=>this.touchedReactive.set(c))}_touched=By(()=>this.touchedReactive());touchedReactive=ba(!1);get untouched(){return!this.touched}_events=new Er;events=this._events.asObservable();valueChanges;statusChanges;get updateOn(){return this._updateOn?this._updateOn:this.parent?this.parent.updateOn:"change"}setValidators(c){this._assignValidators(c)}setAsyncValidators(c){this._assignAsyncValidators(c)}addValidators(c){this.setValidators(qN(c,this._rawValidators))}addAsyncValidators(c){this.setAsyncValidators(qN(c,this._rawAsyncValidators))}removeValidators(c){this.setValidators(WN(c,this._rawValidators))}removeAsyncValidators(c){this.setAsyncValidators(WN(c,this._rawAsyncValidators))}hasValidator(c){return h1(this._rawValidators,c)}hasAsyncValidator(c){return h1(this._rawAsyncValidators,c)}clearValidators(){this.validator=null}clearAsyncValidators(){this.asyncValidator=null}markAsTouched(c={}){let l=this.touched===!1;this.touched=!0;let f=c.sourceControl??this;this._parent&&!c.onlySelf&&this._parent.markAsTouched(di(Bt({},c),{sourceControl:f})),l&&c.emitEvent!==!1&&this._events.next(new xv(!0,f))}markAllAsDirty(c={}){this.markAsDirty({onlySelf:!0,emitEvent:c.emitEvent,sourceControl:this}),this._forEachChild(l=>l.markAllAsDirty(c))}markAllAsTouched(c={}){this.markAsTouched({onlySelf:!0,emitEvent:c.emitEvent,sourceControl:this}),this._forEachChild(l=>l.markAllAsTouched(c))}markAsUntouched(c={}){let l=this.touched===!0;this.touched=!1,this._pendingTouched=!1;let f=c.sourceControl??this;this._forEachChild(v=>{v.markAsUntouched({onlySelf:!0,emitEvent:c.emitEvent,sourceControl:f})}),this._parent&&!c.onlySelf&&this._parent._updateTouched(c,f),l&&c.emitEvent!==!1&&this._events.next(new xv(!1,f))}markAsDirty(c={}){let l=this.pristine===!0;this.pristine=!1;let f=c.sourceControl??this;this._parent&&!c.onlySelf&&this._parent.markAsDirty(di(Bt({},c),{sourceControl:f})),l&&c.emitEvent!==!1&&this._events.next(new vv(!1,f))}markAsPristine(c={}){let l=this.pristine===!1;this.pristine=!0,this._pendingDirty=!1;let f=c.sourceControl??this;this._forEachChild(v=>{v.markAsPristine({onlySelf:!0,emitEvent:c.emitEvent})}),this._parent&&!c.onlySelf&&this._parent._updatePristine(c,f),l&&c.emitEvent!==!1&&this._events.next(new vv(!0,f))}markAsPending(c={}){this.status=Nm;let l=c.sourceControl??this;c.emitEvent!==!1&&(this._events.next(new zm(this.status,l)),this.statusChanges.emit(this.status)),this._parent&&!c.onlySelf&&this._parent.markAsPending(di(Bt({},c),{sourceControl:l}))}disable(c={}){let l=this._parentMarkedDirty(c.onlySelf);this.status=yv,this.errors=null,this._forEachChild(v=>{v.disable(di(Bt({},c),{onlySelf:!0}))}),this._updateValue();let f=c.sourceControl??this;c.emitEvent!==!1&&(this._events.next(new f1(this.value,f)),this._events.next(new zm(this.status,f)),this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._updateAncestors(di(Bt({},c),{skipPristineCheck:l}),this),this._onDisabledChange.forEach(v=>v(!0))}enable(c={}){let l=this._parentMarkedDirty(c.onlySelf);this.status=_v,this._forEachChild(f=>{f.enable(di(Bt({},c),{onlySelf:!0}))}),this.updateValueAndValidity({onlySelf:!0,emitEvent:c.emitEvent}),this._updateAncestors(di(Bt({},c),{skipPristineCheck:l}),this),this._onDisabledChange.forEach(f=>f(!1))}_updateAncestors(c,l){this._parent&&!c.onlySelf&&(this._parent.updateValueAndValidity(c),c.skipPristineCheck||this._parent._updatePristine({},l),this._parent._updateTouched({},l))}setParent(c){this._parent=c}getRawValue(){return this.value}updateValueAndValidity(c={}){if(this._setInitialStatus(),this._updateValue(),this.enabled){let f=this._cancelExistingSubscription();this.errors=this._runValidator(),this.status=this._calculateStatus(),(this.status===_v||this.status===Nm)&&this._runAsyncValidator(f,c.emitEvent)}let l=c.sourceControl??this;c.emitEvent!==!1&&(this._events.next(new f1(this.value,l)),this._events.next(new zm(this.status,l)),this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._parent&&!c.onlySelf&&this._parent.updateValueAndValidity(di(Bt({},c),{sourceControl:l}))}_updateTreeValidity(c={emitEvent:!0}){this._forEachChild(l=>l._updateTreeValidity(c)),this.updateValueAndValidity({onlySelf:!0,emitEvent:c.emitEvent})}_setInitialStatus(){this.status=this._allControlsDisabled()?yv:_v}_runValidator(){return this.validator?this.validator(this):null}_runAsyncValidator(c,l){if(this.asyncValidator){this.status=Nm,this._hasOwnPendingAsyncValidator={emitEvent:l!==!1,shouldHaveEmitted:c!==!1};let f=tz(this.asyncValidator(this));this._asyncValidationSubscription=f.subscribe(v=>{this._hasOwnPendingAsyncValidator=null,this.setErrors(v,{emitEvent:l,shouldHaveEmitted:c})})}}_cancelExistingSubscription(){if(this._asyncValidationSubscription){this._asyncValidationSubscription.unsubscribe();let c=(this._hasOwnPendingAsyncValidator?.emitEvent||this._hasOwnPendingAsyncValidator?.shouldHaveEmitted)??!1;return this._hasOwnPendingAsyncValidator=null,c}return!1}setErrors(c,l={}){this.errors=c,this._updateControlsErrors(l.emitEvent!==!1,this,l.shouldHaveEmitted)}get(c){let l=c;return l==null||(Array.isArray(l)||(l=l.split(".")),l.length===0)?null:l.reduce((f,v)=>f&&f._find(v),this)}getError(c,l){let f=l?this.get(l):this;return f&&f.errors?f.errors[c]:null}hasError(c,l){return!!this.getError(c,l)}get root(){let c=this;for(;c._parent;)c=c._parent;return c}_updateControlsErrors(c,l,f){this.status=this._calculateStatus(),c&&this.statusChanges.emit(this.status),(c||f)&&this._events.next(new zm(this.status,l)),this._parent&&this._parent._updateControlsErrors(c,l,f)}_initObservables(){this.valueChanges=new qi,this.statusChanges=new qi}_calculateStatus(){return this._allControlsDisabled()?yv:this.errors?d1:this._hasOwnPendingAsyncValidator||this._anyControlsHaveStatus(Nm)?Nm:this._anyControlsHaveStatus(d1)?d1:_v}_anyControlsHaveStatus(c){return this._anyControls(l=>l.status===c)}_anyControlsDirty(){return this._anyControls(c=>c.dirty)}_anyControlsTouched(){return this._anyControls(c=>c.touched)}_updatePristine(c,l){let f=!this._anyControlsDirty(),v=this.pristine!==f;this.pristine=f,this._parent&&!c.onlySelf&&this._parent._updatePristine(c,l),v&&this._events.next(new vv(this.pristine,l))}_updateTouched(c={},l){this.touched=this._anyControlsTouched(),this._events.next(new xv(this.touched,l)),this._parent&&!c.onlySelf&&this._parent._updateTouched(c,l)}_onDisabledChange=[];_registerOnCollectionChange(c){this._onCollectionChange=c}_setUpdateStrategy(c){_1(c)&&c.updateOn!=null&&(this._updateOn=c.updateOn)}_parentMarkedDirty(c){let l=this._parent&&this._parent.dirty;return!c&&!!l&&!this._parent._anyControlsDirty()}_find(c){return null}_assignValidators(c){this._rawValidators=Array.isArray(c)?c.slice():c,this._composedValidatorFn=U8(this._rawValidators)}_assignAsyncValidators(c){this._rawAsyncValidators=Array.isArray(c)?c.slice():c,this._composedAsyncValidatorFn=H8(this._rawAsyncValidators)}},p1=class extends Bm{constructor(c,l,f){super(WC(l),ZC(f,l)),this.controls=c,this._initObservables(),this._setUpdateStrategy(l),this._setUpControls(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator})}controls;registerControl(c,l){return this.controls[c]?this.controls[c]:(this.controls[c]=l,l.setParent(this),l._registerOnCollectionChange(this._onCollectionChange),l)}addControl(c,l,f={}){this.registerControl(c,l),this.updateValueAndValidity({emitEvent:f.emitEvent}),this._onCollectionChange()}removeControl(c,l={}){this.controls[c]&&this.controls[c]._registerOnCollectionChange(()=>{}),delete this.controls[c],this.updateValueAndValidity({emitEvent:l.emitEvent}),this._onCollectionChange()}setControl(c,l,f={}){this.controls[c]&&this.controls[c]._registerOnCollectionChange(()=>{}),delete this.controls[c],l&&this.registerControl(c,l),this.updateValueAndValidity({emitEvent:f.emitEvent}),this._onCollectionChange()}contains(c){return this.controls.hasOwnProperty(c)&&this.controls[c].enabled}setValue(c,l={}){dz(this,!0,c),Object.keys(c).forEach(f=>{uz(this,!0,f),this.controls[f].setValue(c[f],{onlySelf:!0,emitEvent:l.emitEvent})}),this.updateValueAndValidity(l)}patchValue(c,l={}){c!=null&&(Object.keys(c).forEach(f=>{let v=this.controls[f];v&&v.patchValue(c[f],{onlySelf:!0,emitEvent:l.emitEvent})}),this.updateValueAndValidity(l))}reset(c={},l={}){this._forEachChild((f,v)=>{f.reset(c?c[v]:null,{onlySelf:!0,emitEvent:l.emitEvent})}),this._updatePristine(l,this),this._updateTouched(l,this),this.updateValueAndValidity(l),l?.emitEvent!==!1&&this._events.next(new wv(this))}getRawValue(){return this._reduceChildren({},(c,l,f)=>(c[f]=l.getRawValue(),c))}_syncPendingControls(){let c=this._reduceChildren(!1,(l,f)=>f._syncPendingControls()?!0:l);return c&&this.updateValueAndValidity({onlySelf:!0}),c}_forEachChild(c){Object.keys(this.controls).forEach(l=>{let f=this.controls[l];f&&c(f,l)})}_setUpControls(){this._forEachChild(c=>{c.setParent(this),c._registerOnCollectionChange(this._onCollectionChange)})}_updateValue(){this.value=this._reduceValue()}_anyControls(c){for(let[l,f]of Object.entries(this.controls))if(this.contains(l)&&c(f))return!0;return!1}_reduceValue(){let c={};return this._reduceChildren(c,(l,f,v)=>((f.enabled||this.disabled)&&(l[v]=f.value),l))}_reduceChildren(c,l){let f=c;return this._forEachChild((v,i)=>{f=l(f,v,i)}),f}_allControlsDisabled(){for(let c of Object.keys(this.controls))if(this.controls[c].enabled)return!1;return Object.keys(this.controls).length>0||this.disabled}_find(c){return this.controls.hasOwnProperty(c)?this.controls[c]:null}};var GC=class extends p1{};var hz=new Kt("",{providedIn:"root",factory:()=>XC}),XC="always";function $8(s,c,l=XC){q8(s,c),c.valueAccessor.writeValue(s.value),(s.disabled||l==="always")&&c.valueAccessor.setDisabledState?.(s.disabled),Z8(s,c),Y8(s,c),X8(s,c),G8(s,c)}function ZN(s,c,l=!0){let f=()=>{};c.valueAccessor&&(c.valueAccessor.registerOnChange(f),c.valueAccessor.registerOnTouched(f)),W8(s,c),s&&(c._invokeOnDestroyCallbacks(),s._registerOnCollectionChange(()=>{}))}function m1(s,c){s.forEach(l=>{l.registerOnValidatorChange&&l.registerOnValidatorChange(c)})}function G8(s,c){if(c.valueAccessor.setDisabledState){let l=f=>{c.valueAccessor.setDisabledState(f)};s.registerOnDisabledChange(l),c._registerOnDestroy(()=>{s._unregisterOnDisabledChange(l)})}}function q8(s,c){let l=az(s);c.validator!==null?s.setValidators(GN(l,c.validator)):typeof l=="function"&&s.setValidators([l]);let f=lz(s);c.asyncValidator!==null?s.setAsyncValidators(GN(f,c.asyncValidator)):typeof f=="function"&&s.setAsyncValidators([f]);let v=()=>s.updateValueAndValidity();m1(c._rawValidators,v),m1(c._rawAsyncValidators,v)}function W8(s,c){let l=!1;if(s!==null){if(c.validator!==null){let v=az(s);if(Array.isArray(v)&&v.length>0){let i=v.filter(C=>C!==c.validator);i.length!==v.length&&(l=!0,s.setValidators(i))}}if(c.asyncValidator!==null){let v=lz(s);if(Array.isArray(v)&&v.length>0){let i=v.filter(C=>C!==c.asyncValidator);i.length!==v.length&&(l=!0,s.setAsyncValidators(i))}}}let f=()=>{};return m1(c._rawValidators,f),m1(c._rawAsyncValidators,f),l}function Z8(s,c){c.valueAccessor.registerOnChange(l=>{s._pendingValue=l,s._pendingChange=!0,s._pendingDirty=!0,s.updateOn==="change"&&fz(s,c)})}function X8(s,c){c.valueAccessor.registerOnTouched(()=>{s._pendingTouched=!0,s.updateOn==="blur"&&s._pendingChange&&fz(s,c),s.updateOn!=="submit"&&s.markAsTouched()})}function fz(s,c){s._pendingDirty&&s.markAsDirty(),s.setValue(s._pendingValue,{emitModelToViewChange:!1}),c.viewToModelUpdate(s._pendingValue),s._pendingChange=!1}function Y8(s,c){let l=(f,v)=>{c.valueAccessor.writeValue(f),v&&c.viewToModelUpdate(f)};s.registerOnChange(l),c._registerOnDestroy(()=>{s._unregisterOnChange(l)})}function K8(s,c){if(!s.hasOwnProperty("model"))return!1;let l=s.model;return l.isFirstChange()?!0:!Object.is(c,l.currentValue)}function J8(s){return Object.getPrototypeOf(s.constructor)===P8}function Q8(s,c){if(!c)return null;Array.isArray(c);let l,f,v;return c.forEach(i=>{i.constructor===g1?l=i:J8(i)?f=i:v=i}),v||f||l||null}function XN(s,c){let l=s.indexOf(c);l>-1&&s.splice(l,1)}function YN(s){return typeof s=="object"&&s!==null&&Object.keys(s).length===2&&"value"in s&&"disabled"in s}var jC=class extends Bm{defaultValue=null;_onChange=[];_pendingValue;_pendingChange=!1;constructor(c=null,l,f){super(WC(l),ZC(f,l)),this._applyFormState(c),this._setUpdateStrategy(l),this._initObservables(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator}),_1(l)&&(l.nonNullable||l.initialValueIsDefault)&&(YN(c)?this.defaultValue=c.value:this.defaultValue=c)}setValue(c,l={}){this.value=this._pendingValue=c,this._onChange.length&&l.emitModelToViewChange!==!1&&this._onChange.forEach(f=>f(this.value,l.emitViewToModelChange!==!1)),this.updateValueAndValidity(l)}patchValue(c,l={}){this.setValue(c,l)}reset(c=this.defaultValue,l={}){this._applyFormState(c),this.markAsPristine(l),this.markAsUntouched(l),this.setValue(this.value,l),this._pendingChange=!1,l?.emitEvent!==!1&&this._events.next(new wv(this))}_updateValue(){}_anyControls(c){return!1}_allControlsDisabled(){return this.disabled}registerOnChange(c){this._onChange.push(c)}_unregisterOnChange(c){XN(this._onChange,c)}registerOnDisabledChange(c){this._onDisabledChange.push(c)}_unregisterOnDisabledChange(c){XN(this._onDisabledChange,c)}_forEachChild(c){}_syncPendingControls(){return this.updateOn==="submit"&&(this._pendingDirty&&this.markAsDirty(),this._pendingTouched&&this.markAsTouched(),this._pendingChange)?(this.setValue(this._pendingValue,{onlySelf:!0,emitModelToViewChange:!1}),!0):!1}_applyFormState(c){YN(c)?(this.value=this._pendingValue=c.value,c.disabled?this.disable({onlySelf:!0,emitEvent:!1}):this.enable({onlySelf:!0,emitEvent:!1})):this.value=this._pendingValue=c}};var pz=new Kt(""),eq={provide:bv,useExisting:Ch(()=>YC)},YC=(()=>{class s extends bv{_ngModelWarningConfig;callSetDisabledState;viewModel;form;set isDisabled(l){}model;update=new qi;static _ngModelWarningSentOnce=!1;_ngModelWarningSent=!1;constructor(l,f,v,i,C){super(),this._ngModelWarningConfig=i,this.callSetDisabledState=C,this._setValidators(l),this._setAsyncValidators(f),this.valueAccessor=Q8(this,v)}ngOnChanges(l){if(this._isControlChanged(l)){let f=l.form.previousValue;f&&ZN(f,this,!1),$8(this.form,this,this.callSetDisabledState),this.form.updateValueAndValidity({emitEvent:!1})}K8(l,this.viewModel)&&(this.form.setValue(this.model),this.viewModel=this.model)}ngOnDestroy(){this.form&&ZN(this.form,this,!1)}get path(){return[]}get control(){return this.form}viewToModelUpdate(l){this.viewModel=l,this.update.emit(l)}_isControlChanged(l){return l.hasOwnProperty("form")}static \u0275fac=function(f){return new(f||s)(ri(k8,10),ri(N8,10),ri(QN,10),ri(pz,8),ri(hz,8))};static \u0275dir=Ls({type:s,selectors:[["","formControl",""]],inputs:{form:[0,"formControl","form"],isDisabled:[0,"disabled","isDisabled"],model:[0,"ngModel","model"]},outputs:{update:"ngModelChange"},exportAs:["ngForm"],standalone:!1,features:[zy([eq]),Gh,Oc]})}return s})();var tq=(()=>{class s{static \u0275fac=function(f){return new(f||s)};static \u0275mod=Ro({type:s});static \u0275inj=yo({})}return s})(),qC=class extends Bm{constructor(c,l,f){super(WC(l),ZC(f,l)),this.controls=c,this._initObservables(),this._setUpdateStrategy(l),this._setUpControls(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator})}controls;at(c){return this.controls[this._adjustIndex(c)]}push(c,l={}){Array.isArray(c)?c.forEach(f=>{this.controls.push(f),this._registerControl(f)}):(this.controls.push(c),this._registerControl(c)),this.updateValueAndValidity({emitEvent:l.emitEvent}),this._onCollectionChange()}insert(c,l,f={}){this.controls.splice(c,0,l),this._registerControl(l),this.updateValueAndValidity({emitEvent:f.emitEvent})}removeAt(c,l={}){let f=this._adjustIndex(c);f<0&&(f=0),this.controls[f]&&this.controls[f]._registerOnCollectionChange(()=>{}),this.controls.splice(f,1),this.updateValueAndValidity({emitEvent:l.emitEvent})}setControl(c,l,f={}){let v=this._adjustIndex(c);v<0&&(v=0),this.controls[v]&&this.controls[v]._registerOnCollectionChange(()=>{}),this.controls.splice(v,1),l&&(this.controls.splice(v,0,l),this._registerControl(l)),this.updateValueAndValidity({emitEvent:f.emitEvent}),this._onCollectionChange()}get length(){return this.controls.length}setValue(c,l={}){dz(this,!1,c),c.forEach((f,v)=>{uz(this,!1,v),this.at(v).setValue(f,{onlySelf:!0,emitEvent:l.emitEvent})}),this.updateValueAndValidity(l)}patchValue(c,l={}){c!=null&&(c.forEach((f,v)=>{this.at(v)&&this.at(v).patchValue(f,{onlySelf:!0,emitEvent:l.emitEvent})}),this.updateValueAndValidity(l))}reset(c=[],l={}){this._forEachChild((f,v)=>{f.reset(c[v],{onlySelf:!0,emitEvent:l.emitEvent})}),this._updatePristine(l,this),this._updateTouched(l,this),this.updateValueAndValidity(l),l?.emitEvent!==!1&&this._events.next(new wv(this))}getRawValue(){return this.controls.map(c=>c.getRawValue())}clear(c={}){this.controls.length<1||(this._forEachChild(l=>l._registerOnCollectionChange(()=>{})),this.controls.splice(0),this.updateValueAndValidity({emitEvent:c.emitEvent}))}_adjustIndex(c){return c<0?c+this.length:c}_syncPendingControls(){let c=this.controls.reduce((l,f)=>f._syncPendingControls()?!0:l,!1);return c&&this.updateValueAndValidity({onlySelf:!0}),c}_forEachChild(c){this.controls.forEach((l,f)=>{c(l,f)})}_updateValue(){this.value=this.controls.filter(c=>c.enabled||this.disabled).map(c=>c.value)}_anyControls(c){return this.controls.some(l=>l.enabled&&c(l))}_setUpControls(){this._forEachChild(c=>this._registerControl(c))}_allControlsDisabled(){for(let c of this.controls)if(c.enabled)return!1;return this.controls.length>0||this.disabled}_registerControl(c){c.setParent(this),c._registerOnCollectionChange(this._onCollectionChange)}_find(c){return this.at(c)??null}};function KN(s){return!!s&&(s.asyncValidators!==void 0||s.validators!==void 0||s.updateOn!==void 0)}var y1=(()=>{class s{useNonNullable=!1;get nonNullable(){let l=new s;return l.useNonNullable=!0,l}group(l,f=null){let v=this._reduceControls(l),i={};return KN(f)?i=f:f!==null&&(i.validators=f.validator,i.asyncValidators=f.asyncValidator),new p1(v,i)}record(l,f=null){let v=this._reduceControls(l);return new GC(v,f)}control(l,f,v){let i={};return this.useNonNullable?(KN(f)?i=f:(i.validators=f,i.asyncValidators=v),new jC(l,di(Bt({},i),{nonNullable:!0}))):new jC(l,f,v)}array(l,f,v){let i=l.map(C=>this._createControl(C));return new qC(i,f,v)}_reduceControls(l){let f={};return Object.keys(l).forEach(v=>{f[v]=this._createControl(l[v])}),f}_createControl(l){if(l instanceof jC)return l;if(l instanceof Bm)return l;if(Array.isArray(l)){let f=l[0],v=l.length>1?l[1]:null,i=l.length>2?l[2]:null;return this.control(f,v,i)}else return this.control(l)}static \u0275fac=function(f){return new(f||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var mz=(()=>{class s{static withConfig(l){return{ngModule:s,providers:[{provide:pz,useValue:l.warnOnNgModelWithFormControl??"always"},{provide:hz,useValue:l.callSetDisabledState??XC}]}}static \u0275fac=function(f){return new(f||s)};static \u0275mod=Ro({type:s});static \u0275inj=yo({imports:[tq]})}return s})();var Vm=class s{placeholder="template";type="text";control;error=!1;static \u0275fac=function(l){return new(l||s)};static \u0275cmp=ur({type:s,selectors:[["FormField"]],inputs:{placeholder:"placeholder",type:"type",control:"control",error:"error"},decls:1,vars:5,consts:[[1,"form-field",3,"type","formControl","placeholder"]],template:function(l,f){l&1&&Pr(0,"input",0),l&2&&(so("error",f.error),Vr("type",f.type)("formControl",f.control)("placeholder",f.placeholder))},dependencies:[mz,g1,cz,YC],styles:[".form-field[_ngcontent-%COMP%]{font:var(--font-stack-headline);display:block;min-width:300px;min-height:50px;max-width:500px;padding:0 16px;border-radius:16px;background-color:var(--color-gray);border:none;color:var(--color-white);font-size:16px}.form-field[_ngcontent-%COMP%]::placeholder{color:var(--color-light-gray);font-weight:var(--font-weight-light)}.form-field[_ngcontent-%COMP%]:focus{outline:none}.error[_ngcontent-%COMP%]{border:1px solid var(--color-error)}input[type=date][_ngcontent-%COMP%]{color:var(--color-light-gray)}"]})};function JC(s){let c=s.value?.trim();return/^[A-Za-z---\s]+$/.test(c)?null:{onlyLetters:!0}}function QC(s){let c=s.value;if(!c)return{adult:!0};let l=new Date(c);return new Date().getFullYear()-l.getFullYear()<18?{adult:!0}:null}function jm(s){let c=s.value?.trim();return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c)?null:{emailInvalid:!0}}function Um(s){let c=s.value;return/^(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(c)?null:{weakPassword:!0}}var $l=class s{constructor(c){this.http=c}baseUrl="http://localhost:8080/api/auth";signUp(c){return console.log("Payload inviato:",c),this.http.post(`${this.baseUrl}/signup`,c)}login(c){return this.http.post(`${this.baseUrl}/login`,c)}loginWithGoogle(c){return this.http.post(`${this.baseUrl}/login/google`,c)}loginWithGoogleCode(c){return this.http.post(`${this.baseUrl}/login/google/code`,c)}verifyEmail(c){return this.http.get(`${this.baseUrl}/verify?token=${c}`)}resendEmail(c){return this.http.post(`${this.baseUrl}/resend-token`,c)}static \u0275fac=function(l){return new(l||s)(ln(Em))};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})};var Hm=class s{scriptLoadingPromise=null;loadScript(){return this.scriptLoadingPromise?this.scriptLoadingPromise:(this.scriptLoadingPromise=new Promise((c,l)=>{if(document.getElementById("google-identity")){c();return}let f=document.createElement("script");f.id="google-identity",f.src="https://accounts.google.com/gsi/client",f.async=!0,f.defer=!0,f.onload=()=>c(),f.onerror=()=>l(new Error("Impossibile caricare Google Identity Services")),document.head.appendChild(f)}),this.scriptLoadingPromise)}getAuthCode(){return Xs(this,null,function*(){if(yield this.loadScript(),!ad.googleClientId)throw new Error("Configura il Google Client ID.");let c=ad.googleRedirectUri||window.location.origin;return new Promise((l,f)=>{google.accounts.oauth2.initCodeClient({client_id:ad.googleClientId,scope:"openid email profile",ux_mode:"popup",redirect_uri:c,state:"signin",callback:i=>{if(i&&i.code)l(i.code);else if(i&&i.error){let C=new Error(i.error_description||i.error||"Accesso Google annullato.");C.code=i.error,f(C)}else f(new Error("Accesso Google annullato."))}}).requestCode()})})}getIdToken(){return Xs(this,null,function*(){if(yield this.loadScript(),!ad.googleClientId)throw new Error("Configura il Google Client ID.");return new Promise((c,l)=>{let f=!1,v=C=>{let k=(C||"").toLowerCase();return k.includes("invalid")?{message:"Configura il Google Client ID.",code:"google_config"}:k.includes("missing")?{message:"Configura il Google Client ID.",code:"google_config"}:k.includes("suppressed")?{message:"Accesso Google annullato: Google ha soppresso il prompt (cookie).",code:"google_cancelled"}:k.includes("user_cancel")?{message:"Accesso Google annullato dall\u2019utente.",code:"google_cancelled"}:{message:"Accesso Google annullato.",code:"google_cancelled"}},i=(C,k)=>{if(!f)if(f=!0,k)c(k);else{let B=typeof C=="string"?C:C?.message,ee=typeof C=="string"?void 0:C?.code,_e=new Error(B||"Accesso Google annullato.");ee&&(_e.code=ee),l(_e)}};google.accounts.id.initialize({client_id:ad.googleClientId,callback:C=>{C&&C.credential?i(void 0,C.credential):i({message:"Accesso Google annullato.",code:"google_cancelled"})},ux_mode:"popup",use_fedcm_for_prompt:!0,itp_support:!0,cancel_on_tap_outside:!0,auto_select:!1}),google.accounts.id.prompt(C=>{let k=C?.isNotDisplayed?.(),B=C?.isSkippedMoment?.();if(k||B){let ee=C?.getNotDisplayedReason?.()||C?.getSkippedReason?.()||"Accesso Google annullato.";i(v(ee))}})})})}static \u0275fac=function(l){return new(l||s)};static \u0275prov=Wt({token:s,factory:s.\u0275fac,providedIn:"root"})};function nq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.generalError)}}function iq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.errors.name)}}function rq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.errors.birthdate)}}function oq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.errors.email)}}function sq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.errors.password)}}function aq(s,c){s&1&&(cn(0,"p"),Bn(1,"start to join events"),un())}var x1=class s{constructor(c,l,f,v){this.fb=c;this.auth=l;this.googleIdentity=f;this.responsive=v;this.form=this.fb.group({name:["",[JC]],birthdate:["",[QC]],email:["",[jm]],password:["",[Um]]})}close=new qi;switchToSignIn=new qi;signUpSuccess=new qi;signInSuccess=new qi;form;errors={};generalError=null;onSubmit(){this.errors={},this.generalError=null;let c=this.form.controls;if(JC(c.name)&&(this.errors.name="Il nome deve contenere solo lettere."),QC(c.birthdate)&&(this.errors.birthdate="Devi essere maggiore di 18 anni."),jm(c.email)&&(this.errors.email="Email non valida."),Um(c.password)&&(this.errors.password="La password deve avere almeno 8 caratteri, una maiuscola, un numero e un simbolo."),Object.keys(this.errors).length>0)return;let C={name:this.form.value.name,birthdate:this.form.value.birthdate,email:this.form.value.email,password:this.form.value.password};this.auth.signUp(C).subscribe({next:k=>{if(this.errors={},this.generalError=null,!k?.success){this.generalError=k?.error||"Registrazione non riuscita.";return}this.signUpSuccess.emit({email:this.form.value.email,token:k?.data?.token||""})},error:k=>{if(this.errors={},this.generalError=null,k&&typeof k=="object"&&"error"in k){let B=k.error;if(B&&typeof B=="object"){if(B.data&&typeof B.data=="object"){this.errors=B.data;return}if(B.error&&typeof B.error=="string"){this.generalError=B.error;return}}if(typeof k.error=="string"){this.generalError=k.error;return}}if(typeof k=="string"){this.generalError=k;return}this.generalError="Errore inatteso.",console.warn("Unhandled error shape",k)}})}hasError(c){return!!this.errors[c]}closePopup(){this.close.emit()}goToSignIn(){this.switchToSignIn.emit()}signUpWithGoogle(){return Xs(this,null,function*(){this.errors={},this.generalError=null;try{let c=yield this.googleIdentity.getAuthCode();this.auth.loginWithGoogleCode({code:c}).subscribe({next:l=>{this.signInSuccess.emit({id:l?.data?.id||"",name:l?.data?.name||"",email:l?.data?.email||""}),this.closePopup()},error:l=>{let f=l?.error;if(f?.data&&typeof f.data=="object"){this.errors=f.data;return}if(typeof f?.error=="string"){this.generalError=f.error;return}this.generalError="Accesso Google non riuscito."}})}catch(c){if(c?.code==="google_cancelled")return;this.generalError=c?.message||"Accesso Google non riuscito."}})}static \u0275fac=function(l){return new(l||s)(ri(y1),ri($l),ri(Hm),ri(Hl))};static \u0275cmp=ur({type:s,selectors:[["SignUpPopup"]],outputs:{close:"close",switchToSignIn:"switchToSignIn",signUpSuccess:"signUpSuccess",signInSuccess:"signInSuccess"},decls:29,vars:26,consts:[[1,"backdrop",3,"click"],[1,"popup-container"],[1,"popup-content"],[1,"close",3,"click","path"],[1,"header"],[1,"error"],[1,"form"],["placeholder","Full name",3,"error","control","type"],["placeholder","Birthday",3,"error","control","type"],["placeholder","Email",3,"error","control","type"],["placeholder","Password",3,"error","control","type"],["type","button",1,"button",3,"click"],[1,"other-sign-up-methods"],[1,"button","generic",3,"click"],["src","assets/img/google-logo.webp","height","20",1,"google-logo"],[1,"click-text",3,"click"]],template:function(l,f){l&1&&(cn(0,"div",0),rr("click",function(){return f.closePopup()}),un(),cn(1,"div",1)(2,"div",2)(3,"CircleIcon",3),rr("click",function(){return f.closePopup()}),un(),cn(4,"div",4)(5,"h1"),Bn(6,"Join LUMO"),un(),Fs(7,nq,2,1,"p",5)(8,iq,2,1,"p",5)(9,rq,2,1,"p",5)(10,oq,2,1,"p",5)(11,sq,2,1,"p",5)(12,aq,2,0,"p"),un(),cn(13,"form",6),Pr(14,"FormField",7)(15,"FormField",8)(16,"FormField",9)(17,"FormField",10),cn(18,"button",11),rr("click",function(){return f.onSubmit()}),Bn(19,"Sign Up"),un()(),cn(20,"div",12)(21,"p"),Bn(22,"___________ or sign up with ___________"),un(),cn(23,"a",13),rr("click",function(){return f.signUpWithGoogle()}),Pr(24,"img",14),un()(),cn(25,"p"),Bn(26," Already have an account? "),cn(27,"span",15),rr("click",function(){return f.goToSignIn()}),Bn(28,"Sign In"),un()()()()),l&2&&(so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet")("desktop",f.responsive.screen()==="desktop"),ei(),so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet")("desktop",f.responsive.screen()==="desktop"),ei(2),Vr("path","assets/icon/close.svg"),ei(4),ks(f.generalError?7:f.errors.name?8:f.errors.birthdate?9:f.errors.email?10:f.errors.password?11:12),ei(7),Vr("error",f.hasError("name"))("control",f.form.get("name"))("type","text"),ei(),Vr("error",f.hasError("birthdate"))("control",f.form.get("birthdate"))("type","date"),ei(),Vr("error",f.hasError("email"))("control",f.form.get("email"))("type","text"),ei(),Vr("error",f.hasError("password"))("control",f.form.get("password"))("type","password"))},dependencies:[cd,Vm],styles:[".backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000073;z-index:900}.popup-container.desktop[_ngcontent-%COMP%]{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:950}.popup-container.desktop[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:relative;align-items:center;width:30%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}.popup-container.tablet[_ngcontent-%COMP%]{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:950}.popup-container.tablet[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:relative;align-items:center;width:40%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}.popup-container.tablet[_ngcontent-%COMP%]   .close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.backdrop.mobile[_ngcontent-%COMP%]{display:none}.popup-container.mobile[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;width:100vw;height:100vh}.popup-container.mobile[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:fixed;background-color:var(--color-black);display:flex;justify-content:center;align-items:center;flex-direction:column;padding:1.5rem;height:100%;width:100%;border-radius:0;overflow-y:auto;gap:24px}.popup-container.mobile[_ngcontent-%COMP%]   .close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.form[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:24px}.form[_ngcontent-%COMP%]   *[_ngcontent-%COMP%]{width:100%}.close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.header[_ngcontent-%COMP%]{text-align:center}.google-logo[_ngcontent-%COMP%]{height:20px}.other-sign-up-methods[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:24px}.other-sign-up-methods[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column;align-items:center;gap:24px}.form-field.error[_ngcontent-%COMP%]{border:2px solid var(--color-error)}.error[_ngcontent-%COMP%]{color:var(--color-error)}"]})};function lq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.generalError)}}function cq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.errors.email)}}function uq(s,c){if(s&1&&(cn(0,"p",5),Bn(1),un()),s&2){let l=yr();ei(),xo(l.errors.password)}}function dq(s,c){s&1&&(cn(0,"p"),Bn(1,"Sign in in LUMO"),un())}var b1=class s{constructor(c,l,f,v){this.fb=c;this.auth=l;this.googleIdentity=f;this.responsive=v;this.form=this.fb.group({email:["",[jm]],password:["",[Um]]})}close=new qi;switchToSignUp=new qi;signInSuccess=new qi;form;errors={};generalError=null;closePopup(){this.close.emit()}goToSignUp(){this.switchToSignUp.emit()}onSubmit(){this.errors={},this.generalError=null;let c=this.form.controls;if(jm(c.email)&&(this.errors.email="Email non valida."),Um(c.password)&&(this.errors.password="La password deve avere almeno 8 caratteri, una maiuscola, un numero e un simbolo."),Object.keys(this.errors).length>0)return;let v={email:this.form.value.email,password:this.form.value.password};this.auth.login(v).subscribe({next:i=>{this.errors={},this.generalError=null,this.signInSuccess.emit({id:i?.data?.id||"",name:i?.data?.name||"",email:i?.data?.email||v.email}),this.closePopup()},error:i=>{if(this.errors={},this.generalError=null,i&&typeof i=="object"&&"error"in i){let C=i.error;if(C&&typeof C=="object"){if(C.data&&typeof C.data=="object"){this.errors=C.data;return}if(C.error&&typeof C.error=="string"){this.generalError=C.error;return}}if(typeof i.error=="string"){this.generalError=i.error;return}}if(typeof i=="string"){this.generalError=i;return}this.generalError="Errore inatteso.",console.warn("Unhandled error shape",i)}})}signInWithGoogle(){return Xs(this,null,function*(){this.errors={},this.generalError=null;try{let c=yield this.googleIdentity.getIdToken();this.auth.loginWithGoogle({idToken:c}).subscribe({next:l=>{this.signInSuccess.emit({id:l?.data?.id||"",name:l?.data?.name||"",email:l?.data?.email||""}),this.closePopup()},error:l=>{let f=l?.error;if(f?.data&&typeof f.data=="object"){this.errors=f.data;return}if(typeof f?.error=="string"){this.generalError=f.error;return}this.generalError="Accesso Google non riuscito."}})}catch(c){if(c?.code==="google_cancelled")return;this.generalError=c?.message||"Accesso Google non riuscito."}})}hasError(c){return!!this.errors[c]}static \u0275fac=function(l){return new(l||s)(ri(y1),ri($l),ri(Hm),ri(Hl))};static \u0275cmp=ur({type:s,selectors:[["SignInPopup"]],outputs:{close:"close",switchToSignUp:"switchToSignUp",signInSuccess:"signInSuccess"},decls:28,vars:22,consts:[[1,"backdrop",3,"click"],[1,"popup-container"],[1,"popup-content"],[1,"close",3,"click","path"],[1,"header"],[1,"error"],[1,"form"],["placeholder","Email",3,"error","control","type","title"],["placeholder","Password",3,"error","control","type","title"],[1,"click-text"],["type","button",1,"button",3,"click"],[1,"other-sign-up-methods"],[1,"button","generic",3,"click"],["src","assets/img/google-logo.webp","height","20",1,"google-logo"],[1,"click-text",3,"click"]],template:function(l,f){l&1&&(cn(0,"div",0),rr("click",function(){return f.closePopup()}),un(),cn(1,"div",1)(2,"div",2)(3,"CircleIcon",3),rr("click",function(){return f.closePopup()}),un(),cn(4,"div",4)(5,"h1"),Bn(6,"Welcome back!"),un(),Fs(7,lq,2,1,"p",5)(8,cq,2,1,"p",5)(9,uq,2,1,"p",5)(10,dq,2,0,"p"),un(),cn(11,"form",6),Pr(12,"FormField",7)(13,"FormField",8),cn(14,"p")(15,"span",9),Bn(16,"Forgot password?"),un()(),cn(17,"button",10),rr("click",function(){return f.onSubmit()}),Bn(18,"Sign In"),un()(),cn(19,"div",11)(20,"p"),Bn(21,"___________ or sign in with ___________"),un(),cn(22,"a",12),rr("click",function(){return f.signInWithGoogle()}),Pr(23,"img",13),un()(),cn(24,"p"),Bn(25," Don\u2019t have an account? "),cn(26,"span",14),rr("click",function(){return f.goToSignUp()}),Bn(27,"Sign Up"),un()()()()),l&2&&(so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet")("desktop",f.responsive.screen()==="desktop"),ei(),so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet")("desktop",f.responsive.screen()==="desktop"),ei(2),Vr("path","assets/icon/close.svg"),ei(4),ks(f.generalError?7:f.errors.email?8:f.errors.password?9:10),ei(5),Vr("error",f.hasError("email"))("control",f.form.get("email"))("type","text")("title","Email"),ei(),Vr("error",f.hasError("password"))("control",f.form.get("password"))("type","password")("title","Password"))},dependencies:[cd,Vm],styles:[".backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000073;z-index:900}.popup-container.desktop[_ngcontent-%COMP%]{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:950}.popup-container.desktop[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:relative;align-items:center;width:30%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}.popup-container.tablet[_ngcontent-%COMP%]{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:950}.popup-container.tablet[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:relative;align-items:center;width:40%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}.popup-container.tablet[_ngcontent-%COMP%]   .close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.backdrop.mobile[_ngcontent-%COMP%]{display:none}.popup-container.mobile[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;width:100vw;height:100vh}.popup-container.mobile[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:fixed;background-color:var(--color-black);display:flex;justify-content:center;align-items:center;flex-direction:column;padding:1.5rem;height:100%;width:100%;border-radius:0;overflow-y:auto;gap:24px}.popup-container.mobile[_ngcontent-%COMP%]   .close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.form[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:24px}.form[_ngcontent-%COMP%]   *[_ngcontent-%COMP%]{text-align:right;width:100%}.close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.header[_ngcontent-%COMP%]{text-align:center}.google-logo[_ngcontent-%COMP%]{height:20px}.other-sign-up-methods[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:24px}.other-sign-up-methods[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{width:100%;display:flex;flex-direction:column;align-items:center;gap:24px}.form-field.error[_ngcontent-%COMP%]{border:2px solid var(--color-error)}.error[_ngcontent-%COMP%]{color:var(--color-error)}"]})};function hq(s,c){s&1&&(cn(0,"p",5),Bn(1,"Sei stato registrato con sucesso"),un())}function fq(s,c){s&1&&(cn(0,"p"),Bn(1,"Check your email and click the button"),un())}var w1=class s{constructor(c){this.responsive=c}email;token;verified=!1;close=new qi;resendVerification=new qi;onClose(){this.close.emit()}resend(){this.resendVerification.emit()}closePopup(){this.close.emit()}static \u0275fac=function(l){return new(l||s)(ri(Hl))};static \u0275cmp=ur({type:s,selectors:[["VerifyEmailPopup"]],inputs:{email:"email",token:"token",verified:"verified"},outputs:{close:"close",resendVerification:"resendVerification"},decls:11,vars:14,consts:[[1,"backdrop"],[1,"popup-container"],[1,"popup-content"],[1,"close",3,"click","path"],[1,"header"],[1,"success"],[1,"button",3,"click"]],template:function(l,f){l&1&&(Pr(0,"div",0),cn(1,"div",1)(2,"div",2)(3,"CircleIcon",3),rr("click",function(){return f.closePopup()}),un(),cn(4,"div",4)(5,"h1"),Bn(6,"Verify your email"),un(),Fs(7,hq,2,0,"p",5)(8,fq,2,0,"p"),un(),cn(9,"a",6),rr("click",function(){return f.resend()}),Bn(10,"Reinvia email di verifica"),un()()()),l&2&&(so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet")("desktop",f.responsive.screen()==="desktop"),ei(),so("mobile",f.responsive.screen()==="mobile")("tablet",f.responsive.screen()==="tablet")("desktop",f.responsive.screen()==="desktop"),ei(2),Vr("path","assets/icon/close.svg"),ei(4),ks(f.verified?7:8))},dependencies:[cd],styles:[".backdrop[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000073;z-index:900}.popup-container.desktop[_ngcontent-%COMP%]{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:950}.popup-container.desktop[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:relative;align-items:center;width:30%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}.popup-container.tablet[_ngcontent-%COMP%]{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:950}.popup-container.tablet[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:relative;align-items:center;width:40%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}.backdrop.mobile[_ngcontent-%COMP%]{display:none}.popup-container.mobile[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;width:100vw;height:100vh}.popup-container.mobile[_ngcontent-%COMP%]   .popup-content[_ngcontent-%COMP%]{position:fixed;background-color:var(--color-black);display:flex;justify-content:center;align-items:center;flex-direction:column;padding:1.5rem;height:100%;width:100%;border-radius:0;overflow-y:auto;gap:24px}.close[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px}.header[_ngcontent-%COMP%]{text-align:center}.error[_ngcontent-%COMP%]{color:var(--color-error)}.success[_ngcontent-%COMP%]{color:#14c972}"]})};function pq(s,c){if(s&1&&(cn(0,"h1",3),Bn(1),un()),s&2){let l=yr();ei(),Ny("Benvenuto, ",l.loggedUser.name||l.loggedUser.email,"!")}}function mq(s,c){if(s&1){let l=Wh();cn(0,"SignUpPopup",5),rr("switchToSignIn",function(){Rs(l);let v=yr();return Ps(v.switchToSignIn())})("close",function(){Rs(l);let v=yr();return Ps(v.closeAll())})("signUpSuccess",function(v){Rs(l);let i=yr();return Ps(i.openVerifyPopup(v.email,v.token))})("signInSuccess",function(v){Rs(l);let i=yr();return Ps(i.onSignInSuccess(v))}),un()}}function gq(s,c){if(s&1){let l=Wh();cn(0,"VerifyEmailPopup",6),rr("close",function(){Rs(l);let v=yr();return Ps(v.closeAll())})("resendVerification",function(){Rs(l);let v=yr();return Ps(v.resendEmail())}),un()}if(s&2){let l=yr();Vr("email",l.recentEmail)("token",l.recentToken)("verified",l.emailVerified)}}function _q(s,c){if(s&1){let l=Wh();cn(0,"SignInPopup",7),rr("switchToSignUp",function(){Rs(l);let v=yr();return Ps(v.switchToSignUp())})("close",function(){Rs(l);let v=yr();return Ps(v.closeAll())})("signInSuccess",function(v){Rs(l);let i=yr();return Ps(i.onSignInSuccess(v))}),un()}}var E1=class s{constructor(c,l){this.route=c;this.authService=l}showSignUp=!1;showSignIn=!1;showVerifyPopup=!1;loggedUser=null;recentEmail="";recentToken="";emailVerified=!1;ngOnInit(){this.route.queryParams.subscribe(c=>{let l=c.token,f=c.email;l&&(this.recentToken=l,this.recentEmail=f||"",this.openVerifyPopup(),this.authService.verifyEmail(l).subscribe({next:()=>this.emailVerified=!0,error:()=>this.emailVerified=!1}))})}openVerifyPopup(c,l){c!==void 0&&(this.recentEmail=c),l!==void 0&&(this.recentToken=l),this.closeAll(),this.showVerifyPopup=!0}resendEmail(){!this.recentToken&&!this.recentEmail||this.authService.resendEmail({oldToken:this.recentToken,email:this.recentEmail}).subscribe({next:c=>{c?.data?.token&&(this.recentToken=c.data.token),this.emailVerified=!1},error:c=>{console.error("Errore nel reinvio della mail di verifica",c)}})}openSignUp(){this.closeAll(),this.showSignUp=!0}openSignIn(){this.closeAll(),this.showSignIn=!0}closeAll(){this.showSignUp=!1,this.showSignIn=!1,this.showVerifyPopup=!1}switchToSignUp(){this.openSignUp()}switchToSignIn(){this.openSignIn()}onSignInSuccess(c){this.loggedUser={id:c?.id||"",name:c?.name||c?.email||"Utente",email:c?.email||""},this.closeAll()}static \u0275fac=function(l){return new(l||s)(ri(Ns),ri($l))};static \u0275cmp=ur({type:s,selectors:[["Home"]],decls:11,vars:4,consts:[[1,"home-container"],[1,"top-bar"],[1,"button",3,"click"],[1,"welcome"],[3,"email","token","verified"],[3,"switchToSignIn","close","signUpSuccess","signInSuccess"],[3,"close","resendVerification","email","token","verified"],[3,"switchToSignUp","close","signInSuccess"]],template:function(l,f){l&1&&(cn(0,"div",0)(1,"div",1)(2,"a",2),rr("click",function(){return f.openSignUp()}),Bn(3,"Sign Up"),un(),cn(4,"a",2),rr("click",function(){return f.openSignIn()}),Bn(5,"Sign In"),un()(),Fs(6,pq,2,1,"h1",3),Fs(7,mq,1,0,"SignUpPopup"),Fs(8,gq,1,3,"VerifyEmailPopup",4),Fs(9,_q,1,0,"SignInPopup"),Pr(10,"MapView"),un()),l&2&&(ei(6),ks(f.loggedUser?6:-1),ei(),ks(f.showSignUp?7:-1),ei(),ks(f.showVerifyPopup?8:-1),ei(),ks(f.showSignIn?9:-1))},dependencies:[l1,x1,b1,w1],styles:[".top-bar[_ngcontent-%COMP%]{flex-direction:row;position:absolute;top:20px;right:20px;display:flex;gap:10px;z-index:10}"]})};var yq=()=>["/"];function vq(s,c){if(s&1){let l=Wh();cn(0,"a",5),rr("click",function(){Rs(l);let v=yr();return Ps(v.verifyEmail())}),Bn(1,"Verifica Email"),un()}}function xq(s,c){s&1&&(cn(0,"a",4),Bn(1," Torna alla Home"),un()),s&2&&Vr("routerLink",CD(1,yq))}var T1=class s{constructor(c,l){this.route=c;this.authService=l}token="";verified=!1;message="Clicca il pulsante per verificare la tua email.";ngOnInit(){this.route.queryParams.subscribe(c=>{this.token=c.token||""})}verifyEmail(){this.token&&this.authService.verifyEmail(this.token).subscribe({next:()=>{this.verified=!0,this.message="Ti sei registrato con successo!"},error:c=>{this.verified=!1,this.message=c.error?.error||"Token non valido o scaduto."}})}static \u0275fac=function(l){return new(l||s)(ri(Ns),ri($l))};static \u0275cmp=ur({type:s,selectors:[["VerifyEmailPage"]],decls:9,vars:2,consts:[[1,"container"],[1,"verify-container"],[1,"header"],[1,"button"],[1,"button",3,"routerLink"],[1,"button",3,"click"]],template:function(l,f){l&1&&(cn(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1"),Bn(4,"Email Verification"),un(),cn(5,"p"),Bn(6),un()(),Fs(7,vq,2,0,"a",3)(8,xq,2,2,"a",4),un()()),l&2&&(ei(6),xo(f.message),ei(),ks(f.verified?8:7))},dependencies:[PC,Qw],styles:[".container[_ngcontent-%COMP%]{background-color:var(--color-gray);width:100%;height:100vh;display:flex;justify-content:center;align-items:center}.container[_ngcontent-%COMP%]   .verify-container[_ngcontent-%COMP%]{text-align:center;position:relative;align-items:center;width:30%;height:auto;background-color:var(--color-black);border-radius:20px;padding:40px;border:2px solid var(--color-gray);display:flex;flex-direction:column;gap:24px}"]})};var _z=[{path:"",component:E1},{path:"verify-email",component:T1}];var yz=(s,c)=>c(s).pipe(Ks(l=>(console.error("HTTP ERROR intercepted",l),l instanceof ed?Xa(()=>l):Xa(()=>l||"Errore sconosciuto"))));var vz={providers:[eC(tC([yz])),MC(_z),KI(),RD({eventCoalescing:!0})]};XD(e1,vz).catch(s=>console.error(s));
